{% extends "layout.html" %}
{% set active_page = 'executions' %}

{% block title %}Executions - AIOps Platform{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-primary">Executions</h1>
            <p class="text-secondary mt-1">Monitor runbook execution history and status</p>
        </div>
        <button onclick="loadExecutions()" class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-sync-alt"></i>
            <span>Refresh</span>
        </button>
    </div>

    <!-- Filters -->
    <div class="card p-4">
        <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
                <input type="text" id="searchInput" placeholder="Search by runbook name..."
                    class="input-field w-full px-3 py-2 rounded" onkeyup="filterExecutions()">
            </div>
            <div class="w-48">
                <select id="statusFilter" class="input-field w-full px-3 py-2 rounded" onchange="filterExecutions()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="running">Running</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="w-48">
                <select id="timeFilter" class="input-field w-full px-3 py-2 rounded" onchange="filterExecutions()">
                    <option value="24h">Last 24 Hours</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                    <option value="all">All Time</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-play-circle text-blue-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Total</p>
                    <p class="text-xl font-bold text-primary" id="totalCount">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-clock text-orange-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Pending</p>
                    <p class="text-xl font-bold text-orange-400" id="pendingCount">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-yellow-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-spinner text-yellow-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Running</p>
                    <p class="text-xl font-bold text-primary" id="runningCount">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-green-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Completed</p>
                    <p class="text-xl font-bold text-primary" id="completedCount">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-red-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-times-circle text-red-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Failed</p>
                    <p class="text-xl font-bold text-primary" id="failedCount">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-purple-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-percentage text-purple-400"></i>
                </div>
                <div>
                    <p class="text-secondary text-sm">Success Rate</p>
                    <p class="text-xl font-bold text-primary" id="successRate">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Executions Table -->
    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-tertiary border-b border-gray-700">
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Execution ID</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Runbook</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Status</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Target</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Mode</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Started</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Duration</th>
                        <th class="text-left px-4 py-3 text-secondary text-sm font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody id="executionsTable">
                    <!-- Executions will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="card p-12 text-center hidden">
        <i class="fas fa-history text-4xl text-secondary mb-4"></i>
        <h3 class="text-lg font-medium text-primary mb-2">No Executions Found</h3>
        <p class="text-secondary mb-4">Execute a runbook to see the execution history here.</p>
        <a href="/runbooks" class="btn-primary px-4 py-2 rounded-lg inline-block">
            <i class="fas fa-book mr-2"></i>View Runbooks
        </a>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex items-center justify-between hidden">
        <p class="text-secondary text-sm">
            Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="showingTotal">0</span>
            executions
        </p>
        <div class="flex gap-2">
            <button id="prevBtn" onclick="prevPage()" class="btn-secondary px-3 py-1 rounded" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <span id="pageInfo" class="text-secondary px-2 py-1">Page 1</span>
            <button id="nextBtn" onclick="nextPage()" class="btn-secondary px-3 py-1 rounded">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Execution Details Modal -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary">Execution Details</h2>
            <button onclick="closeDetailsModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="detailsContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Output Modal -->
<div id="outputModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary">Step Output</h2>
            <button onclick="closeOutputModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <pre id="outputContent"
            class="flex-1 overflow-auto bg-gray-900 p-4 rounded font-mono text-sm text-green-400"></pre>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary" id="confirmTitle">Confirm Action</h2>
            <button onclick="closeConfirmModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-6" id="confirmMessage">Are you sure?</p>
        <div id="confirmInputContainer" class="mb-4 hidden">
            <label class="block text-secondary text-sm mb-1" id="confirmInputLabel">Reason</label>
            <input type="text" id="confirmInput" class="input-field w-full px-3 py-2 rounded"
                placeholder="Enter reason...">
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="closeConfirmModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
            <button id="confirmBtn" class="btn-primary px-4 py-2 rounded-lg">Confirm</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let executions = [];
    let currentPage = 1;
    const pageSize = 20;
    let autoRefreshInterval = null;
    let currentExecutionDetails = null; // Store current execution details for step output

    // Load executions on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadExecutions();
        startAutoRefresh();
    });

    function startAutoRefresh() {
        // Refresh every 10 seconds if there are running executions
        autoRefreshInterval = setInterval(() => {
            const hasRunning = executions.some(e => ['running', 'pending', 'approved', 'queued'].includes(e.status));
            if (hasRunning) {
                loadExecutions(true);
            }
        }, 10000);
    }

    async function loadExecutions(silent = false) {
        console.log("loadExecutions called");
        try {
            const response = await fetch('/api/remediation/executions');
            console.log("Fetch response status:", response.status);

            // Check for valid JSON response to avoid syntax errors if HTML is returned
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") === -1) {
                console.error("Expected JSON response from /api/remediation/executions, got", contentType);
                if (!silent) showToast('Server returned invalid response format', 'error');
                return;
            }

            if (response.ok) {
                executions = await response.json();
                renderExecutions();
                updateStats();
            } else if (!silent) {
                showToast('Failed to load executions', 'error');
            }
        } catch (error) {
            console.error('Error loading executions:', error);
            if (!silent) {
                showToast('Error loading executions', 'error');
            }
        }
    }

    function renderExecutions() {
        const tbody = document.getElementById('executionsTable');
        const emptyState = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const timeFilter = document.getElementById('timeFilter').value;

        // Filter executions
        let filtered = executions.filter(ex => {
            const matchesSearch = (ex.runbook_name || '').toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || ex.status === statusFilter;
            const matchesTime = filterByTime(ex.started_at || ex.queued_at, timeFilter);
            return matchesSearch && matchesStatus && matchesTime;
        });

        if (filtered.length === 0) {
            tbody.innerHTML = '';
            emptyState.classList.remove('hidden');
            pagination.classList.add('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        // Pagination
        const totalPages = Math.ceil(filtered.length / pageSize);
        currentPage = Math.min(currentPage, totalPages);
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filtered.length);
        const paged = filtered.slice(start, end);

        // Update pagination info
        document.getElementById('showingFrom').textContent = start + 1;
        document.getElementById('showingTo').textContent = end;
        document.getElementById('showingTotal').textContent = filtered.length;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        pagination.classList.toggle('hidden', filtered.length <= pageSize);

        tbody.innerHTML = paged.map(ex => `
        <tr class="border-b border-gray-700 hover:bg-tertiary">
            <td class="px-4 py-3">
                <code class="text-sm text-blue-400">#${ex.id}</code>
            </td>
            <td class="px-4 py-3">
                <span class="text-primary font-medium">${escapeHtml(ex.runbook_name || 'Unknown')}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(ex.status)}">
                    ${ex.status === 'running' ? '<i class="fas fa-spinner fa-spin mr-1"></i>' : ''}${formatStatusLabel(ex.status)}
                </span>
            </td>
            <td class="px-4 py-3">
                <span class="text-secondary text-sm">${escapeHtml(ex.server_hostname || 'N/A')}</span>
            </td>
            <td class="px-4 py-3">
                <span class="text-secondary text-sm">
                    ${formatExecutionMode(ex.execution_mode)}
                </span>
            </td>
            <td class="px-4 py-3">
                <span class="text-secondary text-sm">${formatDate(ex.started_at || ex.queued_at)}</span>
            </td>
            <td class="px-4 py-3">
                <span class="text-secondary text-sm">${formatDuration(ex.started_at || ex.queued_at, ex.completed_at)}</span>
            </td>
            <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                    <button onclick="viewDetails('${ex.id}')" class="text-blue-400 hover:text-blue-300" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${ex.status === 'pending' || ex.status === 'queued' ? `
                        <button onclick="approveExecution('${ex.id}')" class="text-green-400 hover:text-green-300" title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectExecution('${ex.id}')" class="text-red-400 hover:text-red-300" title="Reject">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                    ${ex.status === 'running' ? `
                        <button onclick="cancelExecution('${ex.id}')" class="text-red-400 hover:text-red-300" title="Cancel">
                            <i class="fas fa-stop"></i>
                        </button>
                    ` : ''}
                    ${ex.status === 'failed' || ex.status === 'timeout' ? `
                        <button onclick="retryExecution('${ex.id}')" class="text-yellow-400 hover:text-yellow-300" title="Retry">
                            <i class="fas fa-redo"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
    }

    function updateStats(filteredExecutions = null) {
        // Use filtered executions if provided, otherwise apply current filters
        const timeFilter = document.getElementById('timeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        const dataToUse = filteredExecutions || executions.filter(ex => {
            const matchesSearch = (ex.runbook_name || '').toLowerCase().includes(searchTerm);
            const matchesStatus = !statusFilter || ex.status === statusFilter;
            const matchesTime = filterByTime(ex.started_at || ex.queued_at, timeFilter);
            return matchesSearch && matchesStatus && matchesTime;
        });

        const total = dataToUse.length;
        const pending = dataToUse.filter(e => e.status === 'pending' || e.status === 'queued').length;
        const running = dataToUse.filter(e => e.status === 'running' || e.status === 'approved').length;
        const completed = dataToUse.filter(e => e.status === 'success' || e.status === 'completed').length;
        const failed = dataToUse.filter(e => ['failed', 'timeout', 'cancelled', 'rolled_back'].includes(e.status)).length;
        const successRate = total > 0 ? Math.round((completed / total) * 100) : 0;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('runningCount').textContent = running;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('failedCount').textContent = failed;
        document.getElementById('successRate').textContent = successRate + '%';
    }

    function getStatusClass(status) {
        switch (status) {
            case 'completed':
            case 'success':
                return 'bg-green-500 bg-opacity-20 text-green-400';
            case 'running':
            case 'approved':
                return 'bg-blue-500 bg-opacity-20 text-blue-400';
            case 'pending':
            case 'queued':
                return 'bg-yellow-500 bg-opacity-20 text-yellow-400';
            case 'failed':
            case 'timeout':
            case 'rolled_back':
                return 'bg-red-500 bg-opacity-20 text-red-400';
            case 'cancelled':
                return 'bg-gray-500 bg-opacity-20 text-gray-400';
            default: return 'bg-gray-500 bg-opacity-20 text-gray-400';
        }
    }

    function formatStatusLabel(status) {
        if (!status) return 'unknown';
        if (status === 'pending' || status === 'queued') return 'Awaiting Approval';
        if (status === 'approved') return 'Starting...';
        return status.replace(/_/g, ' ');
    }

    function filterByTime(dateStr, filter) {
        if (filter === 'all' || !dateStr) return true;
        const date = new Date(dateStr);
        const now = new Date();
        const diffHours = (now - date) / (1000 * 60 * 60);

        switch (filter) {
            case '24h': return diffHours <= 24;
            case '7d': return diffHours <= 24 * 7;
            case '30d': return diffHours <= 24 * 30;
            default: return true;
        }
    }

    function filterExecutions() {
        currentPage = 1;
        renderExecutions();
        updateStats(); // Update stats based on filtered data
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderExecutions();
        }
    }

    function nextPage() {
        currentPage++;
        renderExecutions();
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;

        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDuration(startStr, endStr) {
        if (!startStr) return 'N/A';
        const start = new Date(startStr);
        const end = endStr ? new Date(endStr) : new Date();
        const diffMs = end - start;

        if (diffMs < 1000) return '<1s';
        if (diffMs < 60000) return `${Math.floor(diffMs / 1000)}s`;
        if (diffMs < 3600000) return `${Math.floor(diffMs / 60000)}m ${Math.floor((diffMs % 60000) / 1000)}s`;
        return `${Math.floor(diffMs / 3600000)}h ${Math.floor((diffMs % 3600000) / 60000)}m`;
    }

    async function viewDetails(id) {
        try {
            const response = await fetch(`/api/remediation/executions/${id}`);
            if (response.ok) {
                const ex = await response.json();
                currentExecutionDetails = ex; // Store for step output access

                document.getElementById('detailsContent').innerHTML = `
                <div class="space-y-6">
                    <!-- Overview -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-3">
                            <p class="text-secondary text-sm">Execution ID</p>
                            <p class="text-primary font-mono">#${ex.id}</p>
                        </div>
                        <div class="card p-3">
                            <p class="text-secondary text-sm">Status</p>
                            <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(ex.status)}">${formatStatusLabel(ex.status)}</span>
                        </div>
                        <div class="card p-3">
                            <p class="text-secondary text-sm">Started</p>
                            <p class="text-primary text-sm">${formatDate(ex.started_at)}</p>
                        </div>
                        <div class="card p-3">
                            <p class="text-secondary text-sm">Duration</p>
                            <p class="text-primary">${formatDuration(ex.started_at, ex.completed_at)}</p>
                        </div>
                    </div>
                    
                    <!-- Runbook Info -->
                    <div class="card p-4">
                        <h4 class="font-medium text-primary mb-2">Runbook</h4>
                        <p class="text-secondary">${escapeHtml(ex.runbook_name || 'Unknown')}</p>
                                                ${ex.server_hostname ? `<p class="text-secondary text-sm mt-1">Target: ${escapeHtml(ex.server_hostname)}</p>` :
                        ex.server_id ? `<p class="text-secondary text-sm mt-1">Server ID: ${escapeHtml(ex.server_id)}</p>` : ''}
                    </div>
                    
                    <!-- Steps Execution -->
                    <div>
                        <h4 class="font-medium text-primary mb-3">Steps Execution</h4>
                        <div class="space-y-2">
                            ${(ex.step_executions || []).map((step, i) => `
                                <div class="card p-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full ${getStepStatusBg(step.status)} flex items-center justify-center text-xs">
                                                ${getStepStatusIcon(step.status)}
                                            </span>
                                            <div>
                                                <p class="text-primary font-medium">${escapeHtml(step.step_name || 'Step ' + (i + 1))}</p>
                                                <p class="text-secondary text-xs">${formatDuration(step.started_at, step.completed_at)}</p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(step.status)}">${formatStatusLabel(step.status)}</span>
                                            ${step.http_status_code ? `
                                                <span class="px-2 py-1 rounded text-xs font-medium ${getHttpStatusClass(step.http_status_code)}">
                                                    HTTP ${step.http_status_code}
                                                </span>
                                            ` : ''}
                                            ${step.output || step.http_response_body ? `
                                                <button onclick="showStepOutput(${i})"
                                                    class="text-blue-400 hover:text-blue-300 text-sm">
                                                    <i class="fas fa-terminal"></i> ${step.http_response_body ? 'Response' : 'Output'}
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>

                                    ${step.http_request_method && step.http_request_url ? `
                                        <div class="mt-2 p-2 bg-blue-900 bg-opacity-20 rounded text-sm">
                                            <p class="text-blue-300 font-mono">
                                                <span class="font-bold">${step.http_request_method}</span> ${escapeHtml(step.http_request_url)}
                                            </p>
                                        </div>
                                    ` : ''}

                                    ${step.extracted_values_json && Object.keys(step.extracted_values_json).length > 0 ? `
                                        <div class="mt-2 p-2 bg-green-900 bg-opacity-20 rounded text-sm">
                                            <p class="text-green-300 mb-1"><i class="fas fa-filter mr-1"></i>Extracted Values:</p>
                                            <div class="font-mono text-xs space-y-1">
                                                ${Object.entries(step.extracted_values_json).map(([key, val]) => `
                                                    <div><span class="text-green-400">${escapeHtml(key)}:</span> <span class="text-primary">${escapeHtml(String(val))}</span></div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${step.error_message ? `
                                        <div class="mt-2 p-2 bg-red-900 bg-opacity-20 rounded text-red-400 text-sm">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>${escapeHtml(step.error_message)}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('') || '<p class="text-secondary">No step executions recorded</p>'}
                        </div>
                    </div>
                    
                    <!-- Error Details -->
                    ${ex.error_message ? `
                        <div class="card p-4 border-red-500">
                            <h4 class="font-medium text-red-400 mb-2"><i class="fas fa-exclamation-circle mr-1"></i>Error</h4>
                            <p class="text-secondary">${escapeHtml(ex.error_message)}</p>
                        </div>
                    ` : ''}
                </div>
            `;

                document.getElementById('detailsModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading execution details:', error);
            showToast('Error loading execution details', 'error');
        }
    }

    function getStepStatusBg(status) {
        switch (status) {
            case 'completed':
            case 'success':
                return 'bg-green-500 bg-opacity-20 text-green-400';
            case 'running':
                return 'bg-blue-500 bg-opacity-20 text-blue-400';
            case 'pending':
                return 'bg-gray-500 bg-opacity-20 text-gray-400';
            case 'failed':
            case 'timeout':
                return 'bg-red-500 bg-opacity-20 text-red-400';
            case 'skipped':
                return 'bg-yellow-500 bg-opacity-20 text-yellow-400';
            default: return 'bg-gray-500 bg-opacity-20 text-gray-400';
        }
    }

    function getStepStatusIcon(status) {
        switch (status) {
            case 'completed':
            case 'success':
                return '<i class="fas fa-check text-green-400"></i>';
            case 'running': return '<i class="fas fa-spinner fa-spin text-blue-400"></i>';
            case 'pending': return '<i class="fas fa-clock text-gray-400"></i>';
            case 'failed':
            case 'timeout':
                return '<i class="fas fa-times text-red-400"></i>';
            case 'skipped': return '<i class="fas fa-forward text-yellow-400"></i>';
            default: return '<i class="fas fa-question text-gray-400"></i>';
        }
    }

    function closeDetailsModal() {
        document.getElementById('detailsModal').classList.add('hidden');
        currentExecutionDetails = null;
    }

    function getHttpStatusClass(statusCode) {
        if (statusCode >= 200 && statusCode < 300) {
            return 'bg-green-500 bg-opacity-20 text-green-400';
        } else if (statusCode >= 300 && statusCode < 400) {
            return 'bg-blue-500 bg-opacity-20 text-blue-400';
        } else if (statusCode >= 400 && statusCode < 500) {
            return 'bg-yellow-500 bg-opacity-20 text-yellow-400';
        } else if (statusCode >= 500) {
            return 'bg-red-500 bg-opacity-20 text-red-400';
        }
        return 'bg-gray-500 bg-opacity-20 text-gray-400';
    }

    function showStepOutput(stepIndex) {
        if (!currentExecutionDetails || !currentExecutionDetails.step_executions) {
            showToast('Step details not available', 'error');
            return;
        }

        const step = currentExecutionDetails.step_executions[stepIndex];
        if (!step) {
            showToast('Step not found', 'error');
            return;
        }

        let output = '';

        // API response
        if (step.http_response_body) {
            output += '=== API RESPONSE ===\n\n';

            if (step.http_request_method && step.http_request_url) {
                output += `Request: ${step.http_request_method} ${step.http_request_url}\n`;
            }
            if (step.http_status_code) {
                output += `Status: ${step.http_status_code}\n\n`;
            }

            // Try to format as JSON
            try {
                const parsed = JSON.parse(step.http_response_body);
                output += 'Response Body (formatted):\n';
                output += JSON.stringify(parsed, null, 2);
            } catch (e) {
                output += 'Response Body:\n';
                output += step.http_response_body;
            }

            // Show response headers if available
            if (step.http_response_headers_json && Object.keys(step.http_response_headers_json).length > 0) {
                output += '\n\n=== RESPONSE HEADERS ===\n';
                for (const [key, value] of Object.entries(step.http_response_headers_json)) {
                    output += `${key}: ${value}\n`;
                }
            }

            // Show extracted values if available
            if (step.extracted_values_json && Object.keys(step.extracted_values_json).length > 0) {
                output += '\n\n=== EXTRACTED VALUES ===\n';
                for (const [key, value] of Object.entries(step.extracted_values_json)) {
                    output += `${key} = ${value}\n`;
                }
            }
        }
        // Command output
        else if (step.output) {
            output = step.output.replace(/\\r/g, '\r').replace(/\\n/g, '\n');
        }
        // Fallback
        else {
            output = 'No output available';
        }

        document.getElementById('outputContent').textContent = output;
        document.getElementById('outputModal').classList.remove('hidden');
    }

    function showOutput(output) {
        const normalized = (output || '')
            .replace(/\\r/g, '\r')
            .replace(/\\n/g, '\n');
        document.getElementById('outputContent').textContent = normalized;
        document.getElementById('outputModal').classList.remove('hidden');
    }

    function closeOutputModal() {
        document.getElementById('outputModal').classList.add('hidden');
    }

    function cancelExecution(id) {
        showConfirmModal(
            'Cancel Execution',
            'Are you sure you want to cancel this execution? This action cannot be undone.',
            'Cancel Execution',
            'bg-red-600 hover:bg-red-700 text-white',
            false,
            null,
            async () => {
                try {
                    const response = await fetch(`/api/remediation/executions/${id}/cancel`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        showToast('Execution cancelled', 'success');
                        loadExecutions();
                    } else {
                        showToast('Failed to cancel execution', 'error');
                    }
                } catch (error) {
                    console.error('Error cancelling execution:', error);
                    showToast('Error cancelling execution', 'error');
                }
            }
        );
    }

    function retryExecution(id) {
        showConfirmModal(
            'Retry Execution',
            'Are you sure you want to retry this execution? A new execution will be created.',
            'Retry',
            'bg-yellow-600 hover:bg-yellow-700 text-white',
            false,
            null,
            async () => {
                try {
                    const response = await fetch(`/api/remediation/executions/${id}/retry`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        showToast('Execution retry started', 'success');
                        loadExecutions();
                    } else {
                        showToast('Failed to retry execution', 'error');
                    }
                } catch (error) {
                    console.error('Error retrying execution:', error);
                    showToast('Error retrying execution', 'error');
                }
            }
        );
    }

    // Custom confirmation modal functions
    let confirmCallback = null;

    function showConfirmModal(title, message, buttonText, buttonClass, showInput, inputLabel, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmBtn').textContent = buttonText;
        document.getElementById('confirmBtn').className = `px-4 py-2 rounded-lg ${buttonClass}`;

        const inputContainer = document.getElementById('confirmInputContainer');
        if (showInput) {
            inputContainer.classList.remove('hidden');
            document.getElementById('confirmInputLabel').textContent = inputLabel || 'Input';
            document.getElementById('confirmInput').value = '';
        } else {
            inputContainer.classList.add('hidden');
        }

        confirmCallback = callback;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmCallback = null;
    }

    document.getElementById('confirmBtn').addEventListener('click', function () {
        if (confirmCallback) {
            const inputValue = document.getElementById('confirmInput').value;
            confirmCallback(inputValue);
        }
        closeConfirmModal();
    });

    function approveExecution(id) {
        showConfirmModal(
            'Approve Execution',
            'Are you sure you want to approve this execution? It will start running immediately.',
            'Approve',
            'bg-green-600 hover:bg-green-700 text-white',
            false,
            null,
            async () => {
                try {
                    const response = await fetch(`/api/remediation/executions/${id}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ approved: true })
                    });

                    if (response.ok) {
                        showToast('Execution approved - starting now', 'success');
                        loadExecutions();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Failed to approve execution', 'error');
                    }
                } catch (error) {
                    console.error('Error approving execution:', error);
                    showToast('Error approving execution', 'error');
                }
            }
        );
    }

    function rejectExecution(id) {
        showConfirmModal(
            'Reject Execution',
            'This will cancel the execution. You can optionally provide a reason.',
            'Reject',
            'bg-red-600 hover:bg-red-700 text-white',
            true,
            'Rejection Reason (optional)',
            async (reason) => {
                try {
                    const response = await fetch(`/api/remediation/executions/${id}/approve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ approved: false, reason: reason || 'Rejected by user' })
                    });

                    if (response.ok) {
                        showToast('Execution rejected', 'success');
                        loadExecutions();
                    } else {
                        const error = await response.json();
                        showToast(error.detail || 'Failed to reject execution', 'error');
                    }
                } catch (error) {
                    console.error('Error rejecting execution:', error);
                    showToast('Error rejecting execution', 'error');
                }
            }
        );
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function encodeForInlineJs(value) {
        if (value === undefined || value === null) {
            return '';
        }
        // Stringify handles backslashes and newlines
        // We need to escape single quotes for the onclick attribute context
        // And backticks because this is used inside a template literal
        return JSON.stringify(String(value))
            .slice(1, -1)
            .replace(/'/g, "\\'")
            .replace(/`/g, "\\`");
    }

    function hasStepOutput(step) {
        if (!step) return false;
        return Boolean(step.stdout || step.stderr || step.command_executed);
    }

    function buildStepOutputPayload(step) {
        if (!step) return '';
        const sections = [];
        if (step.stdout) {
            sections.push(`STDOUT:\n${step.stdout}`);
        }
        if (step.stderr) {
            sections.push(`STDERR:\n${step.stderr}`);
        }
        if (!sections.length && step.command_executed) {
            sections.push(`Command:\n${step.command_executed}`);
        }
        return sections.join('\n\n');
    }

    function formatExecutionMode(mode) {
        switch (mode) {
            case 'auto':
                return '<i class="fas fa-bolt text-yellow-400 mr-1"></i>Auto';
            case 'semi_auto':
                return '<i class="fas fa-robot text-purple-400 mr-1"></i>Semi-Auto';
            case 'manual':
                return '<i class="fas fa-user text-blue-400 mr-1"></i>Manual';
            default:
                return mode ? escapeHtml(mode) : 'Unknown';
        }
    }

    // Only define showToast if not already defined by parent
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
            toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${escapeHtml(message)}</span>
        `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function () {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
</script>
{{ super() }}
{% endblock %}