{% extends "base.html" %}
{% set active_page = 'inquiry' %}

{% block title %}AI Inquiry Analyst - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200 truncate">AI Analyst</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-search text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">AI Inquiry Analyst</span>
{% endblock %}

{% block main_wrapper %}
<main class="inquiry-main">
    <!-- Left Panel: Chat -->
    <div class="inq-chat-panel">
        <!-- Chat Header -->
        <div class="inq-chat-header">
            <div class="inq-chat-header-left">
                <!-- New Session Button -->
                <button class="inq-new-session-btn" onclick="createNewSession()">
                    <i data-feather="zap" style="width: 14px; height: 14px;"></i>
                    <span>New Session</span>
                </button>

                <!-- LLM Model Selector -->
                <div class="inq-llm-selector" id="llmSelector">
                    <div class="inq-llm-selected" onclick="toggleModelDropdown()">
                        <span class="inq-model-dot"></span>
                        <span class="inq-llm-text" id="currentModelName">Select Model</span>
                        <i data-feather="chevron-down" class="inq-dropdown-icon"></i>
                    </div>
                    <div class="inq-llm-options" id="modelListContainer" style="display: none;">
                        <!-- Options injected by populateModelDropdown -->
                    </div>
                    <!-- Hidden dropdown for old logic compatibility -->
                    <div id="modelDropdown" class="hidden"></div>
                </div>
            </div>
            <div class="inq-chat-header-right">
                <button onclick="adjustChatFont(-1)" class="inq-icon-btn" title="Decrease Font">
                    <i data-feather="minus" style="width: 14px; height: 14px;"></i>
                </button>
                <button onclick="adjustChatFont(1)" class="inq-icon-btn" title="Increase Font">
                    <i data-feather="plus" style="width: 14px; height: 14px;"></i>
                </button>
                <button onclick="clearChat()" class="inq-icon-btn" title="Clear Chat" style="color: #ef4444;">
                    <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="inq-chat-messages">
            <!-- Welcome/Empty state handled by JS -->
        </div>

        <!-- Chat Input -->
        <div class="inq-chat-input-container">
            <form id="chatForm" onsubmit="sendMessage(event)" class="flex" style="gap: 8px;">
                <textarea id="chatInput" class="inq-chat-input" placeholder="Ask about logs, metrics, traces, or infrastructure status..."
                    autocomplete="off" title="Type your message here" rows="2"></textarea>
                <button type="submit" title="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Resize Handle -->
    <div class="inq-resize-handle" id="inquiryResizeHandle">
        <div class="inq-resize-line"></div>
    </div>

    <!-- Right Panel: Artifacts -->
    <div class="inq-artifacts-panel">
        <!-- Artifacts Header -->
        <div class="inq-artifacts-header">
            <div style="display: flex; align-items: center;">
                <div class="inq-artifact-tabs">
                    <button onclick="switchArtifactTab('recent')" id="artifactTabRecent"
                        class="inq-artifact-tab active">
                        <i class="fas fa-clock" style="margin-right: 4px; font-size: 11px;"></i>Recent
                    </button>
                    <button onclick="switchArtifactTab('all')" id="artifactTabAll" class="inq-artifact-tab">
                        <i class="fas fa-layer-group" style="margin-right: 4px; font-size: 11px;"></i>All Artifacts
                    </button>
                </div>
                <span id="artifactCount" class="inq-artifact-count">0</span>
            </div>
            <div class="inq-artifact-controls">
                <button onclick="clearArtifacts()" title="Clear All" style="color: #ef4444;">
                    <i class="fas fa-trash-alt" style="margin-right: 4px; font-size: 11px;"></i>Clear
                </button>
                <button onclick="exportAllArtifacts()" title="Export All">
                    <i class="fas fa-file-export" style="margin-right: 4px; font-size: 11px;"></i>Export
                </button>
            </div>
        </div>

        <!-- Artifacts Content -->
        <div id="artifactsContainer" class="inq-artifacts-content">
            <!-- Active/Recent Artifact (Large) -->
            <div id="activeArtifact" class="hidden" style="margin-bottom: 16px;">
                <div class="inq-artifact-card">
                    <div class="inq-artifact-card-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i id="activeArtifactIcon" class="fas fa-table"
                                style="color: #3b82f6; font-size: 14px;"></i>
                            <span id="activeArtifactTitle"
                                style="font-size: 13px; font-weight: 600; color: #1e293b;">Artifact</span>
                            <span id="activeArtifactType"
                                style="padding: 2px 8px; font-size: 10px; background: rgba(59,130,246,0.1); color: #3b82f6; border-radius: 6px;">table</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="copyArtifact()" class="inq-icon-btn" style="width: 28px; height: 28px;"
                                title="Copy">
                                <i class="fas fa-copy" style="font-size: 11px;"></i>
                            </button>
                            <button onclick="exportArtifact()" class="inq-icon-btn" style="width: 28px; height: 28px;"
                                title="Export">
                                <i class="fas fa-download" style="font-size: 11px;"></i>
                            </button>
                            <button onclick="pinArtifact()" id="pinArtifactBtn" class="inq-icon-btn"
                                style="width: 28px; height: 28px;" title="Pin">
                                <i class="fas fa-thumbtack" style="font-size: 11px;"></i>
                            </button>
                            <button onclick="minimizeArtifact()" class="inq-icon-btn" style="width: 28px; height: 28px;"
                                title="Minimize">
                                <i class="fas fa-compress-alt" style="font-size: 11px;"></i>
                            </button>
                        </div>
                    </div>
                    <div id="activeArtifactContent" class="inq-artifact-card-content">
                        <!-- Rendered artifact content -->
                    </div>
                </div>
            </div>

            <!-- Artifact History Grid -->
            <div id="artifactHistory" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <!-- Artifact thumbnails will be added here -->
            </div>

            <!-- Empty State -->
            <div id="artifactsEmpty" class="inq-empty-state">
                <div class="inq-empty-state-icon">
                    <i class="fas fa-cube"></i>
                </div>
                <h3>No Artifacts Yet</h3>
                <p>When you ask questions, structured data like tables, code, and charts will appear here for easy
                    viewing and export.</p>
                <div class="inq-empty-state-tags">
                    <span><i class="fas fa-table" style="margin-right: 4px;"></i>Tables</span>
                    <span><i class="fas fa-code" style="margin-right: 4px;"></i>Code</span>
                    <span><i class="fas fa-chart-bar" style="margin-right: 4px;"></i>Charts</span>
                    <span><i class="fas fa-file-alt" style="margin-right: 4px;"></i>Reports</span>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Session Dropdown -->
<div id="sessionDropdown"
    class="hidden absolute top-0 left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-xl z-50 min-w-[220px]">
    <button onclick="createNewSession()"
        style="width: 100%; text-align: left; padding: 10px 12px; font-size: 12px; color: #3b82f6; border: none; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; cursor: pointer; background: transparent; transition: background 0.2s;"
        onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
        <i class="fas fa-plus" style="margin-right: 8px;"></i>New Session
    </button>
    <div id="sessionListContainer" class="max-h-48 overflow-y-auto">
        <div class="px-3 py-2 text-xs" style="color: #94a3b8;">No sessions yet</div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="/static/js/troubleshoot_chat_base.js?v=2.6"></script>
<script src="/static/js/inquiry_chat.js?v=2.1"></script>
<script>
    // Specific inits
    let currentChatMode = 'general';

    // Utility function for toast notifications
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg text-white text-sm z-50 ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-800'
            }`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    window.showToast = showToast;

    async function apiCall(endpoint, options = {}) {
        const defaults = { headers: { 'Content-Type': 'application/json' } };
        options = { ...defaults, ...options, headers: { ...defaults.headers, ...options.headers } };
        try {
            const res = await fetch(endpoint, options);
            if (res.status === 401) window.location.href = '/login';
            return res;
        } catch (e) {
            console.error("API Call error", e);
            throw e;
        }
    }
    window.apiCall = apiCall;

    // Initialize Feather icons
    document.addEventListener('DOMContentLoaded', function () {
        if (typeof feather !== 'undefined') {
            feather.replace();
        }

        // Initialize resize handle
        initInquiryResize();
    });

    // Inquiry Panel Resize
    function initInquiryResize() {
        const mainContainer = document.querySelector('.inquiry-main');
        const resizeHandle = document.getElementById('inquiryResizeHandle');
        const chatPanel = document.querySelector('.inq-chat-panel');
        const artifactsPanel = document.querySelector('.inq-artifacts-panel');

        if (!mainContainer || !resizeHandle || !chatPanel || !artifactsPanel) {
            return;
        }

        let isResizing = false;
        let startX = 0;
        let startChatWidth = 0;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            startX = e.clientX;
            startChatWidth = chatPanel.getBoundingClientRect().width;
            mainContainer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const delta = e.clientX - startX;
            const newWidth = startChatWidth + delta;
            const minWidth = 320;
            const maxWidth = window.innerWidth - 400;

            if (newWidth >= minWidth && newWidth <= maxWidth) {
                mainContainer.style.gridTemplateColumns = `${newWidth}px auto 1fr`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                mainContainer.classList.remove('resizing');
                document.body.style.cursor = '';
            }
        });
    }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
{% endblock %}