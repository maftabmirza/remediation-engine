{% extends "base.html" %}

{% block title %}Logs - Loki{% endblock %}

{% block content %}
<style>
    .grafana-container {
        position: fixed !important;
        top: 48px !important;
        /* Leave room for top navbar (matches grid-template-rows: 48px) */
        left: 48px !important;
        /* Sidebar collapsed width (matches grid-template-columns: 48px in .collapsed) */
        right: 0 !important;
        width: auto !important;

        height: calc(100vh - 48px) !important;
        /* Subtract navbar height */
        bottom: 0 !important;
        overflow: hidden !important;
        background: #111 !important;
        transition: left 0.3s ease, right 0.3s ease;
        z-index: 10;
    }

    /* Adjust when sidebar is expanded (170px matches grid-template-columns: 170px) */
    .app-container:not(.collapsed) .grafana-container {
        left: 170px !important;
    }

    .grafana-container iframe {
        border: none !important;
        display: block !important;
        width: 100% !important;
        height: 100% !important;
    }

    .grafana-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #aaa;
        font-size: 18px;
        text-align: center;
    }

    .grafana-loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #333;
        border-top-color: #1f77b4;
        border-radius: 50%;
        animation: grafana-spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes grafana-spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="grafana-container">
    <div class="grafana-loading" id="loading">
        <div class="spinner"></div>
        <div>Loading Loki Logs...</div>
    </div>
    <iframe id="grafana-iframe"
        src="/grafana/explore?orgId=1&left=%7B%22datasource%22:%22Loki%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bjob%3D~%5C%22.%2B%5C%22%7D%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D&kiosk">
    </iframe>
</div>

<script>
    // Handle iframe loading errors
    const iframe = document.getElementById('grafana-iframe');
    const loading = document.getElementById('loading');
    const timeoutId = setTimeout(function () {
        if (loading) {
            loading.innerHTML = '<div style="color: #f44;">Grafana did not load in time. Check if the proxy is reachable at <a href="/grafana/" target="_blank" style="color:#7aa2ff; text-decoration:underline;">/grafana/</a>.</div>';
        }
    }, 8000);

    iframe.onload = function () {
        clearTimeout(timeoutId);
        if (loading) {
            loading.style.display = 'none';
        }
    };

    iframe.onerror = function () {
        clearTimeout(timeoutId);
        if (loading) {
            loading.innerHTML = '<div style="color: #f44;">Failed to load Grafana. Please check if the service is running.</div>';
        }
    };

    // Refresh page on visibility change (helps with SSO session)
    document.addEventListener('visibilitychange', function () {
        if (!document.hidden && iframe.src) {
            // Refresh iframe if page becomes visible and has been hidden for a while
            const lastRefresh = sessionStorage.getItem('grafanaLastRefresh');
            const now = Date.now();
            if (!lastRefresh || (now - parseInt(lastRefresh)) > 300000) { // 5 minutes
                sessionStorage.setItem('grafanaLastRefresh', now.toString());
            }
        }
    });
</script>

<!-- RE-VIVE AI Assistant Widget -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="/static/css/revive_widget_grafana.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/revive_widget_grafana.js"></script>
{% endblock %}

{% block ai_agent %}{% endblock %}