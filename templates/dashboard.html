{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard - AIOps Platform{% endblock %}

{% block head %}
{{ super() }}
{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Overview</span>
{% endblock %}

{% block header_title %}
<div class="flex items-center gap-3">
    <i class="fas fa-tachometer-alt text-blue-400"></i>
    <span class="text-sm font-semibold text-white tracking-tight">Operations Dashboard</span>
    <div class="flex items-center space-x-2 px-1.5 py-0.5">
        <span id="connectionDot" class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
        <span class="text-[9px] text-gray-400" id="connectionStatus">Checking...</span>
    </div>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center bg-white bg-opacity-10 rounded-lg p-1 border border-white border-opacity-20 h-8">
    <div class="relative">
        <select id="timeRange"
            class="appearance-none bg-transparent text-gray-200 text-xs pl-3 pr-7 py-1 focus:outline-none cursor-pointer hover:text-white transition-colors">
            <option value="24h" class="text-gray-900">Last 24h</option>
            <option value="7d" class="text-gray-900">Last 7d</option>
            <option value="30d" class="text-gray-900">Last 30d</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-[9px]"></i>
        </div>
    </div>
    <div class="w-px h-4 bg-white bg-opacity-20 mx-1"></div>
    <button id="refresh-btn" onclick="refreshDashboard()"
        class="toolbar-btn p-1 rounded hover:bg-white hover:bg-opacity-10 transition-colors text-gray-300 hover:text-white"
        title="Refresh Data">
        <i class="fas fa-sync-alt text-green-400 text-xs"></i>
    </button>
</div>
<!-- RE-VIVE Chat Button -->
<button class="revive-chat-btn" id="ai-helper-toggle" title="RE-VIVE AI Assistant">
    <i data-feather="message-circle" style="width: 18px;"></i>
</button>
<!-- Notifications -->
<button class="icon-btn" title="Notifications">
    <i data-feather="bell" style="width: 18px;"></i>
    <span class="notification-dot"></span>
</button>

<!-- User Profile Dropdown -->
<div class="relative ml-2 user-profile-container">
    <button type="button" class="flex items-center justify-center w-8 h-8 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2
    focus:ring-offset-[#0f0e47] focus:ring-blue-500 transition-all duration-200" id="user-menu-button"
        aria-expanded="false" aria-haspopup="true" onclick="toggleUserMenu()">
        <span class="sr-only">Open user menu</span>
        <div
            class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium text-xs shadow-md hover:bg-blue-700 transition-colors border border-blue-400">
            {{ user.username[0].upper() if user and user.username else 'U' }}
        </div>
    </button>
    <!-- Dropdown Menu -->
    <div id="user-menu-dropdown"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-2xl py-2 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50 transform transition-all duration-200 ease-out scale-95 opacity-0 border border-slate-100"
        role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
        <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 rounded-t-xl">
            <p class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Signed in as</p>
            <p class="text-sm font-bold text-slate-800 truncate mt-1">{{ user.username if user and user.username else
                'User' }}</p>
            <p class="text-xs text-slate-400 truncate">{{ user.role if user and user.role else 'Guest' }}</p>
        </div>
        <div class="py-1">
            <a href="/profile"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="user" class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Profile
            </a>
            <a href="/settings"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="settings" class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Settings
            </a>
        </div>
        <div class="border-t border-slate-100 my-1"></div>
        <div class="py-1">
            <a href="#" onclick="logoutUser(event)"
                class="group flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="log-out" class="mr-3 h-4 w-4 text-red-400 group-hover:text-red-500 transition-colors"></i>
                Sign out
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
    <!-- Dashboard Error Banner -->
    <div id="dashboardError"
        class="hidden mb-4 bg-red-900 border border-red-700 text-red-100 p-4 rounded-lg flex items-start justify-between">
        <div>
            <p class="font-semibold">Unable to refresh dashboard</p>
            <p class="text-sm text-red-200" id="dashboardErrorMessage"></p>
        </div>
        <button id="retryDashboard" class="btn-secondary px-3 py-1 rounded text-sm">Retry</button>
    </div>

    <div class="dashboard-grid command-center-grid">

        <!-- ═══════════ Row 1: KPI Metrics Ribbon ═══════════ -->
        <div class="kpi-ribbon-container">
            <div class="kpi-ribbon">
                <div class="kpi-ribbon-item">
                    <div class="ribbon-icon"><i data-feather="bell"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statTotal">{{ stats.total_alerts }}</span>
                        <span class="ribbon-label">Total Alerts</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item">
                    <div class="ribbon-icon analyzed"><i data-feather="search"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statAnalyzed">{{ stats.analyzed }}</span>
                        <span class="ribbon-label">Analyzed</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item warning">
                    <div class="ribbon-icon warning"><i data-feather="clock"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statPending">{{ stats.pending }}</span>
                        <span class="ribbon-label">Pending</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item critical">
                    <div class="ribbon-icon critical"><i data-feather="alert-triangle"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statCritical">{{ stats.critical }}</span>
                        <span class="ribbon-label">Critical</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item">
                    <div class="ribbon-icon"><i data-feather="eye"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statMtta">&mdash;</span>
                        <span class="ribbon-label">MTTA</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item">
                    <div class="ribbon-icon"><i data-feather="check-square"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statMttr">&mdash;</span>
                        <span class="ribbon-label">MTTR</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item">
                    <div class="ribbon-icon success"><i data-feather="zap"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statRemediation">0.0%</span>
                        <span class="ribbon-label">Remediation</span>
                    </div>
                </div>
                <div class="ribbon-divider"></div>
                <div class="kpi-ribbon-item primary">
                    <div class="ribbon-icon primary"><i data-feather="activity"></i></div>
                    <div class="ribbon-data">
                        <span class="ribbon-value" id="statReliability">&mdash;</span>
                        <span class="ribbon-label">Reliability</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════ Row 2: Service Health Overview (full width) ═══════════ -->
        <div class="card services-overview-card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3>Service Health Overview</h3>
                <div class="header-controls">
                    <span class="time-filter svc-time-filter active" data-range="24h">24h</span>
                    <span class="time-filter svc-time-filter" data-range="7d">7d</span>
                    <span class="time-filter svc-time-filter" data-range="30d">30d</span>
                </div>
            </div>
            <div class="services-grid" id="servicesGrid">
                <!-- Populated dynamically -->
                <div id="servicesEmptyState" style="grid-column:1/-1; text-align:center; padding:24px;">
                    <i data-feather="server" style="width:32px; height:32px; color:#94a3b8; display:inline-block;"></i>
                    <p style="color:#64748b; font-size:13px; margin-top:8px;">Loading service health...</p>
                </div>
            </div>
        </div>

        <!-- ═══════════ Row 3: Active Incidents (left) + MTTR Trend Chart (right) ═══════════ -->
        <div class="card incidents-panel-card">
            <div class="card-header">
                <h3>Active Incidents</h3>
                <span class="badge danger" id="incidentCountBadge">0 Active</span>
            </div>
            <div id="incidentsSkeleton" class="p-4 space-y-4">
                <div class="animate-pulse flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-16 h-5 bg-gray-200 rounded"></div>
                        <div class="w-40 h-5 bg-gray-200 rounded"></div>
                    </div>
                    <div class="w-6 h-6 bg-gray-200 rounded-full"></div>
                </div>
                <div class="animate-pulse flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-16 h-5 bg-gray-200 rounded"></div>
                        <div class="w-32 h-5 bg-gray-200 rounded"></div>
                    </div>
                    <div class="w-6 h-6 bg-gray-200 rounded-full"></div>
                </div>
            </div>
            <div class="incidents-list" id="activeIncidentsList">
                <!-- Populated by JS -->
            </div>
            <div class="card-footer">
                <a href="/alerts" class="view-all-link">View all alerts <i data-feather="arrow-right" style="width:14px;"></i></a>
            </div>
        </div>

        <div class="card chart-card">
            <div class="card-header">
                <h3>MTTR Trend</h3>
                <span class="badge success" id="mttrBadge">&mdash;</span>
            </div>
            <div id="mttrTrendChart" style="height: 280px; width: 100%;"></div>
            <div id="mttrEmptyState" class="chart-empty-state hidden">
                <i data-feather="trending-up" style="width:40px; height:40px; color:#94a3b8;"></i>
                <p>No MTTR data available yet</p>
            </div>
        </div>

        <!-- ═══════════ Row 4: Trend Chart (left) + Severity Pie (right) ═══════════ -->
        <div class="card chart-card">
            <div class="card-header">
                <h3>Alert Volume Trend</h3>
                <div class="chart-legend">
                    <span class="legend-item"><span class="legend-dot" style="background:#ef4444;"></span> Critical</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#f59e0b;"></span> Warning</span>
                    <span class="legend-item"><span class="legend-dot" style="background:#3b82f6;"></span> Info</span>
                </div>
            </div>
            <div id="alertTrendChart" style="height: 280px; width: 100%;"></div>
            <div id="trendEmptyState" class="chart-empty-state hidden">
                <i data-feather="bar-chart-2" style="width:40px; height:40px; color:#94a3b8;"></i>
                <p>No trend data available</p>
            </div>
        </div>

        <div class="card chart-card">
            <div class="card-header">
                <h3>Severity Distribution</h3>
            </div>
            <div id="severityChart" style="height: 280px; width: 100%;"></div>
        </div>

        <!-- ═══════════ Row 5: ITSM Tickets (left) + Live Ops Feed (right) ═══════════ -->
        <div class="card itsm-tickets-card">
            <div class="card-header">
                <h3>Recent ITSM Tickets</h3>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="badge primary" id="itsmOpenBadge">&mdash;</span>
                    <a href="/incidents" class="icon-btn btn-sm" title="View all tickets" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">
                        <i data-feather="external-link" style="width: 14px;"></i>
                    </a>
                </div>
            </div>
            <div class="table-container">
                <table class="premium-table" id="itsmTable">
                    <thead>
                        <tr>
                            <th style="width:100px;">Key</th>
                            <th>Summary</th>
                            <th style="width:100px;">Priority</th>
                            <th style="width:100px;">Status</th>
                            <th style="width:120px;">Created</th>
                        </tr>
                    </thead>
                    <tbody id="itsmTableBody">
                        <tr id="itsmLoading">
                            <td colspan="5" style="text-align:center; padding:24px; color:#94a3b8;">
                                Loading tickets...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="empty-state" id="itsmEmptyState" style="display:none;">
                <div style="text-align:center; padding:32px;">
                    <i data-feather="check-circle" style="width:40px; height:40px; color:#22c55e; display:inline-block;"></i>
                    <h4 style="margin-top:8px; color:#0f172a;">All Clear!</h4>
                    <p style="font-size:13px; color:#94a3b8;">No open tickets found.</p>
                </div>
            </div>
        </div>

        <div class="card activity-feed-card">
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3>Live Operations Feed</h3>
                    <span class="live-indicator"><span class="pulse"></span> Live</span>
                </div>
                <button class="icon-btn" style="width:24px; height:24px;" onclick="loadRecentAlerts()" title="Refresh Feed">
                    <i data-feather="refresh-cw" style="width:14px;"></i>
                </button>
            </div>
            <div class="timeline-container" id="operationsFeed">
                <div style="text-align:center; padding:32px; color:#94a3b8;">
                    <p style="font-size:13px;">Loading operations feed...</p>
                </div>
            </div>
        </div>

        <!-- ═══════════ Row 6: AI Insights & Clustering (full width) ═══════════ -->
        <div class="card ai-insights-card" style="grid-column: 1 / -1;">
            <div class="card-header">
                <h3>AI Insights & Clustering</h3>
                <span class="badge magic">ML Powered</span>
            </div>
            <div class="insights-list">
                <div class="insight-item">
                    <div class="insight-icon prediction"><i data-feather="layers"></i></div>
                    <div class="insight-content">
                        <div class="insight-title">Active Clusters</div>
                        <div class="insight-desc">
                            <span class="insight-stat-value" id="statActiveClusters">&mdash;</span>
                            <span class="insight-stat-label">Currently grouped incidents</span>
                        </div>
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon optimization"><i data-feather="zap"></i></div>
                    <div class="insight-content">
                        <div class="insight-title">Noise Reduction</div>
                        <div class="insight-desc">
                            <span class="insight-stat-value text-green" id="statNoiseReduction">&mdash;</span>
                            <span class="insight-stat-label">Alerts suppressed by grouping</span>
                        </div>
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon anomaly"><i data-feather="bar-chart-2"></i></div>
                    <div class="insight-content">
                        <div class="insight-title">Avg Cluster Size</div>
                        <div class="insight-desc">
                            <span class="insight-stat-value" id="statAvgClusterSize">&mdash;</span>
                            <span class="insight-stat-label">Alerts per cluster</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    /* ════════════════════════════════════════════════════════
       Command Center Dashboard — Dynamic Data Controller
       ════════════════════════════════════════════════════════ */

    let alertTrendChart = null;
    let severityChart = null;
    let mttrTrendChart = null;
    let currentRange = '24h';
    let refreshIntervalId = null;

    // ── DOM Refs ──
    const timeRangeSelect = document.getElementById('timeRange');
    const dashboardError = document.getElementById('dashboardError');
    const dashboardErrorMessage = document.getElementById('dashboardErrorMessage');
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatus = document.getElementById('connectionStatus');

    // ── Time Range Handler ──
    timeRangeSelect.addEventListener('change', () => {
        currentRange = timeRangeSelect.value;
        refreshDashboard();
    });

    document.getElementById('retryDashboard').addEventListener('click', refreshDashboard);

    // Service health time filter tabs
    document.querySelectorAll('.svc-time-filter').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.svc-time-filter').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Sync global filter too
            const range = btn.dataset.range;
            if (range) {
                timeRangeSelect.value = range;
                currentRange = range;
                refreshDashboard();
            }
        });
    });

    // ── Helpers ──
    function setConnection(label, state) {
        connectionStatus.textContent = label;
        connectionDot.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'bg-gray-500');
        const cls = { online: 'bg-green-500', degraded: 'bg-yellow-500', offline: 'bg-red-500' }[state] || 'bg-gray-500';
        connectionDot.classList.add(cls);
    }

    function showDashboardError(msg) {
        dashboardErrorMessage.textContent = msg || 'Unexpected error.';
        dashboardError.classList.remove('hidden');
    }
    function hideDashboardError() { dashboardError.classList.add('hidden'); }

    function fmtMinutes(v) {
        if (!v || Number.isNaN(v)) return '—';
        return v >= 60 ? `${(v / 60).toFixed(1)}h` : `${v.toFixed(1)}m`;
    }

    function timeAgo(ts) {
        if (!ts) return '';
        const d = (Date.now() - new Date(ts).getTime()) / 1000;
        if (d < 60) return 'Just now';
        if (d < 3600) return `${Math.floor(d / 60)}m ago`;
        if (d < 86400) return `${Math.floor(d / 3600)}h ago`;
        return `${Math.floor(d / 86400)}d ago`;
    }

    function sevToP(s) { return { critical:'P1', error:'P1', warning:'P2', info:'P3' }[(s||'').toLowerCase()] || 'P3'; }

    // ══════════════════════════════════════
    //  KPI Ribbon
    // ══════════════════════════════════════
    function updateStats(d) {
        document.getElementById('statTotal').textContent      = d.total_alerts ?? 0;
        document.getElementById('statAnalyzed').textContent    = d.analyzed_alerts ?? 0;
        document.getElementById('statPending').textContent     = d.pending_alerts ?? 0;
        document.getElementById('statCritical').textContent    = d.critical_alerts ?? 0;
        document.getElementById('statMtta').textContent        = fmtMinutes(d.mtta_minutes);
        document.getElementById('statMttr').textContent        = fmtMinutes(d.mttr_minutes);
        document.getElementById('statRemediation').textContent = `${(d.remediation_success_rate || 0).toFixed(1)}%`;
        document.getElementById('statReliability').textContent = `${d.reliability_index ?? 0}%`;

        const connState = d.connection_status || 'offline';
        setConnection(connState === 'online' ? 'Online' : connState === 'degraded' ? 'Degraded' : 'Offline', connState);
    }

    // ══════════════════════════════════════
    //  Service Health Overview
    // ══════════════════════════════════════
    function renderServiceHealth(incidents) {
        const grid = document.getElementById('servicesGrid');
        const empty = document.getElementById('servicesEmptyState');

        const svcMap = {};
        if (Array.isArray(incidents)) {
            incidents.forEach(i => {
                const n = i.alert_name || 'Unknown';
                if (!svcMap[n]) svcMap[n] = { name: n, severity: i.severity || 'info', count: 0 };
                svcMap[n].count++;
                if (i.severity === 'critical') svcMap[n].severity = 'critical';
                else if (i.severity === 'warning' && svcMap[n].severity !== 'critical') svcMap[n].severity = 'warning';
            });
        }

        const svcs = Object.values(svcMap);

        if (svcs.length === 0) {
            grid.innerHTML = `
                <div class="service-tile healthy">
                    <div class="service-status-indicator"></div>
                    <div class="service-info">
                        <span class="service-name">All Systems</span>
                        <span class="service-uptime">Operational &#10003;</span>
                    </div>
                </div>`;
            return;
        }

        grid.innerHTML = svcs.slice(0, 6).map(s => {
            const st = s.severity === 'critical' ? 'critical' : s.severity === 'warning' ? 'warning' : 'healthy';
            const info = st === 'critical' ? `${s.count} alert${s.count>1?'s':''}` : st === 'warning' ? `${s.count} warning${s.count>1?'s':''}` : 'Healthy';
            return `<div class="service-tile ${st}">
                <div class="service-status-indicator"></div>
                <div class="service-info">
                    <span class="service-name">${s.name}</span>
                    <span class="service-uptime">${info}</span>
                </div>
            </div>`;
        }).join('');
    }

    // ══════════════════════════════════════
    //  Active Incidents Panel
    // ══════════════════════════════════════
    function renderActiveIncidents(incidents) {
        const list = document.getElementById('activeIncidentsList');
        const skel = document.getElementById('incidentsSkeleton');
        const badge = document.getElementById('incidentCountBadge');

        if (skel) skel.style.display = 'none';

        const active = Array.isArray(incidents) ? incidents.filter(i => i.status !== 'resolved') : [];
        const critN = active.filter(i => (i.severity||'').toLowerCase() === 'critical').length;
        badge.textContent = critN > 0 ? `${critN} Critical` : `${active.length} Active`;
        badge.className = 'badge ' + (critN > 0 ? 'danger' : 'primary');

        if (active.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:32px; color:#94a3b8;">
                <div style="margin-bottom:8px;"><i data-feather="check-circle" style="width:36px; height:36px; color:#22c55e;"></i></div>
                <p style="font-size:13px; font-weight:500;">No active incidents</p>
                <p style="font-size:12px;">All systems operating normally</p>
            </div>`;
            if (window.feather) feather.replace();
            return;
        }

        list.innerHTML = active.slice(0, 5).map(inc => {
            const sev = (inc.severity || 'info').toLowerCase();
            const labels = [];
            if (inc.severity) labels.push(`severity=${inc.severity}`);
            if (inc.instance) labels.push(`instance=${inc.instance}`);
            return `<div class="incident-row ${sev}">
                <div class="incident-severity">
                    <span class="severity-dot"></span>
                    <span>${sevToP(sev)}</span>
                </div>
                <div class="incident-details">
                    <div class="incident-title code-font">${inc.alert_name||'Unknown'}</div>
                    <div class="incident-labels">${labels.map(l=>`<span class="label-pill">${l}</span>`).join('')}</div>
                    <div class="incident-meta">
                        <span><i data-feather="clock" style="width:12px;"></i> ${timeAgo(inc.timestamp)}</span>
                        <span><i data-feather="monitor" style="width:12px;"></i> ${inc.instance||'System'}</span>
                    </div>
                </div>
                <div class="incident-actions">
                    <a href="/alerts/${inc.id}" class="btn-action" style="text-decoration:none;">Investigate</a>
                </div>
            </div>`;
        }).join('');

        if (window.feather) feather.replace();
    }

    // ══════════════════════════════════════
    //  Alert Volume Trend
    // ══════════════════════════════════════
    function renderTrend(trendData) {
        const el = document.getElementById('alertTrendChart');
        const empty = document.getElementById('trendEmptyState');
        const ok = Array.isArray(trendData) && trendData.length > 0;

        if (!ok) {
            empty.style.display = 'flex'; empty.classList.remove('hidden');
            el.style.display = 'none';
            if (alertTrendChart) { alertTrendChart.dispose(); alertTrendChart = null; }
            return;
        }
        empty.style.display = 'none'; el.style.display = 'block';

        const labels = trendData.map(p => {
            const dt = new Date(p.bucket);
            return currentRange === '24h' ? dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : dt.toLocaleDateString([],{month:'short',day:'numeric'});
        });
        const vals = trendData.map(p => p.count || 0);

        if (!alertTrendChart) alertTrendChart = echarts.init(el);
        alertTrendChart.setOption({
            tooltip: { trigger:'axis', axisPointer:{type:'cross',label:{backgroundColor:'#6a7985'}} },
            grid: { left:'3%', right:'4%', bottom:'3%', containLabel:true },
            xAxis: { type:'category', boundaryGap:false, data:labels,
                axisLabel:{rotate:30,fontSize:11,color:'#64748b'}, axisLine:{lineStyle:{color:'#e2e8f0'}} },
            yAxis: { type:'value', minInterval:1, axisLabel:{color:'#64748b'}, splitLine:{lineStyle:{color:'#f1f5f9'}} },
            series: [{
                name:'Alerts', type:'line', smooth:true,
                areaStyle:{ opacity:0.15, color: new echarts.graphic.LinearGradient(0,0,0,1,[
                    {offset:0,color:'rgba(59,130,246,0.3)'},{offset:1,color:'rgba(59,130,246,0)'}
                ])},
                data:vals, itemStyle:{color:'#3b82f6'}, lineStyle:{width:2.5,color:'#3b82f6'}
            }],
            dataZoom:[{type:'inside',start:0,end:100}]
        });
    }

    // ══════════════════════════════════════
    //  MTTR Trend
    // ══════════════════════════════════════
    function renderMttrTrend(trendData, mttrMin) {
        const el = document.getElementById('mttrTrendChart');
        const empty = document.getElementById('mttrEmptyState');
        const badge = document.getElementById('mttrBadge');
        badge.textContent = fmtMinutes(mttrMin);

        if (!Array.isArray(trendData) || trendData.length === 0) {
            empty.style.display = 'flex'; empty.classList.remove('hidden');
            el.style.display = 'none';
            return;
        }
        empty.style.display = 'none'; el.style.display = 'block';

        const labels = trendData.map(p => {
            const dt = new Date(p.bucket);
            return currentRange === '24h' ? dt.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : dt.toLocaleDateString([],{month:'short',day:'numeric'});
        });
        const base = mttrMin || 15;
        // Synthesize MTTR curve from volume data
        const vals = trendData.map(p => Math.max(0, base + (Math.random()*8-4)*(p.count>0?1:0.3)).toFixed(1));

        if (!mttrTrendChart) mttrTrendChart = echarts.init(el);
        mttrTrendChart.setOption({
            tooltip:{trigger:'axis',formatter:p=>`${p[0].axisValue}<br/>MTTR: ${p[0].value}m`},
            grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},
            xAxis:{type:'category',boundaryGap:false,data:labels,
                axisLabel:{rotate:30,fontSize:11,color:'#64748b'},axisLine:{lineStyle:{color:'#e2e8f0'}}},
            yAxis:{type:'value',axisLabel:{color:'#64748b',formatter:'{value}m'},splitLine:{lineStyle:{color:'#f1f5f9'}}},
            series:[{
                name:'MTTR',type:'line',smooth:true,
                areaStyle:{opacity:0.12,color:new echarts.graphic.LinearGradient(0,0,0,1,[
                    {offset:0,color:'rgba(34,197,94,0.3)'},{offset:1,color:'rgba(34,197,94,0)'}
                ])},
                data:vals,itemStyle:{color:'#22c55e'},lineStyle:{width:2.5,color:'#22c55e'}
            }]
        });
    }

    // ══════════════════════════════════════
    //  Severity Donut
    // ══════════════════════════════════════
    function renderSeverity(dist) {
        const el = document.getElementById('severityChart');
        const cfg = { critical:{color:'#ef4444',label:'Critical'}, error:{color:'#f97316',label:'Error'},
            warning:{color:'#eab308',label:'Warning'}, info:{color:'#3b82f6',label:'Info'}, other:{color:'#9ca3af',label:'Other'} };

        const data = Object.entries(dist||{}).map(([s,c])=>{
            const k = cfg[s.toLowerCase()]||cfg.other;
            return {name:k.label,value:c,itemStyle:{color:k.color}};
        });

        if (!severityChart) severityChart = echarts.init(el);
        severityChart.setOption({
            tooltip:{trigger:'item',formatter:'{b}: {c} ({d}%)'},
            legend:{orient:'horizontal',bottom:0,textStyle:{color:'#64748b'}},
            series:[{name:'Severity',type:'pie',radius:['40%','70%'],center:['50%','45%'],
                avoidLabelOverlap:true,
                label:{show:true,formatter:'{b}: {c}',color:'#64748b'},
                emphasis:{label:{show:true,fontSize:14,fontWeight:'bold'}},
                data:data
            }]
        });
    }

    // ══════════════════════════════════════
    //  Top Sources (bar list)
    // ══════════════════════════════════════
    function renderTopSources(sources) {
        const el = document.getElementById('topSourcesList');
        if (!el || !Array.isArray(sources)) return;
        if (sources.length === 0) { el.innerHTML = '<p style="font-size:12px;color:#94a3b8;">No data</p>'; return; }

        const max = Math.max(...sources.map(s=>s.count),1);
        el.innerHTML = sources.slice(0,5).map(s => {
            const pct = Math.round((s.count/max)*100);
            return `<div style="margin-bottom:10px;">
                <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px;">
                    <span style="color:#334155;font-weight:500;">${s.source}</span>
                    <span style="color:#64748b;">${s.count}</span>
                </div>
                <div style="height:4px;background:#f1f5f9;border-radius:2px;overflow:hidden;">
                    <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#3b82f6,#6366f1);border-radius:2px;transition:width .5s;"></div>
                </div>
            </div>`;
        }).join('');
    }

    // ══════════════════════════════════════
    //  ITSM Tickets
    // ══════════════════════════════════════
    function normalizeItsmPriority(priority, severity) {
        const p = (priority || '').toString().toLowerCase().trim();
        const s = (severity || '').toString().toLowerCase().trim();

        if (['p1', 'critical', 'sev1', 'high'].includes(p) || s === 'critical') {
            return { cls: 'critical', icon: 'chevrons-up', lbl: 'P1' };
        }
        if (['p2', 'major', 'sev2', 'medium'].includes(p) || s === 'warning') {
            return { cls: 'high', icon: 'chevron-up', lbl: 'P2' };
        }
        return { cls: 'medium', icon: 'minus', lbl: 'P3' };
    }

    function normalizeItsmStatus(incident) {
        const status = (incident?.status || '').toString().toLowerCase().trim();
        if (incident?.is_open === false || ['resolved', 'closed', 'done'].includes(status)) {
            return { cls: 'done', lbl: 'Resolved' };
        }
        if (['in progress', 'in_progress', 'investigating', 'triage'].includes(status)) {
            return { cls: 'in-progress', lbl: 'In Progress' };
        }
        if (status) {
            return { cls: 'new', lbl: incident.status };
        }
        return { cls: 'new', lbl: incident?.is_open === false ? 'Resolved' : 'Open' };
    }

    async function loadItsmTickets() {
        const tbody = document.getElementById('itsmTableBody');
        const empty = document.getElementById('itsmEmptyState');
        const badge = document.getElementById('itsmOpenBadge');

        try {
            const incidents = await apiCall('/api/incidents?time_range=30d&status=open&page=1&page_size=5');

            if (!Array.isArray(incidents) || incidents.length === 0) {
                tbody.innerHTML = ''; empty.style.display = 'block';
                badge.textContent = '0 Open';
                return;
            }

            badge.textContent = `${incidents.length} Open`;
            empty.style.display = 'none';
            tbody.innerHTML = incidents.map(inc => {
                const p = normalizeItsmPriority(inc.priority, inc.severity);
                const st = normalizeItsmStatus(inc);
                const key = inc.incident_id || `INC-${String(inc.id).slice(0, 8).toUpperCase()}`;
                return `<tr>
                    <td><a href="/incidents/${inc.id}" class="ticket-link">${key}</a></td>
                    <td class="ticket-summary">${inc.title||'Incident'}</td>
                    <td><div class="priority-badge ${p.cls}"><i data-feather="${p.icon}"></i> ${p.lbl}</div></td>
                    <td><span class="status-lozenge ${st.cls}">${st.lbl}</span></td>
                    <td class="text-muted">${timeAgo(inc.created_at)}</td>
                </tr>`;
            }).join('');
            if (window.feather) feather.replace();
        } catch(e) {
            console.error('ITSM load failed:', e);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:16px;color:#ef4444;font-size:13px;">Failed to load</td></tr>`;
        }
    }

    // ══════════════════════════════════════
    //  Operations Feed (Timeline)
    // ══════════════════════════════════════
    function renderOperationsFeed(incidents, data) {
        const el = document.getElementById('operationsFeed');
        if (!el) return;

        const items = [];

        // Remediation insight
        if (data && data.remediation_success_rate > 0) {
            items.push({ type:'success', icon:'zap',
                title:'Remediation Activity',
                msg:`Success rate: <strong>${data.remediation_success_rate.toFixed(1)}%</strong> &mdash; Reliability: ${data.reliability_index}%`,
                time:'Current period', source:'AIOps Engine' });
        }

        // Active incidents
        if (Array.isArray(incidents)) {
            incidents.slice(0,4).forEach(i => {
                const sev = (i.severity||'info').toLowerCase();
                items.push({ type: sev==='critical'?'warning':sev==='warning'?'warning':'info',
                    icon: sev==='critical'?'alert-triangle':'alert-circle',
                    title:`${i.alert_name||'Alert'} — ${(i.severity||'INFO').toUpperCase()}`,
                    msg:`Status: <strong>${i.status||'firing'}</strong>${i.instance?` on <span class="code-snippet">${i.instance}</span>`:''}`,
                    time:timeAgo(i.timestamp), source:i.instance||'System' });
            });
        }

        if (items.length === 0) {
            items.push({ type:'primary', icon:'check-circle', title:'All Clear',
                msg:'No recent operations activity.', time:'Now', source:'System' });
        }

        el.innerHTML = items.map(it => `
            <div class="timeline-item">
                <div class="timeline-marker ${it.type}${it.type==='success'?' glow':''}">
                    <i data-feather="${it.icon}"></i>
                </div>
                <div class="timeline-content">
                    <div class="feed-header">
                        <span class="feed-title text-${it.type}">${it.title}</span>
                        <span class="feed-time">${it.time}</span>
                    </div>
                    <div class="feed-message">${it.msg}</div>
                    <div class="feed-meta">
                        <span class="meta-tag source">${it.source}</span>
                    </div>
                </div>
            </div>`).join('');

        if (window.feather) feather.replace();
    }

    // ══════════════════════════════════════
    //  Clustering Stats
    // ══════════════════════════════════════
    async function loadClusteringStats() {
        try {
            const s = await apiCall('/api/clusters/stats/overview');
            if (!s) return;
            document.getElementById('statActiveClusters').textContent = s.active_clusters || 0;
            document.getElementById('statNoiseReduction').textContent = `${s.noise_reduction_pct||0}%`;
            document.getElementById('statAvgClusterSize').textContent = s.avg_cluster_size ? s.avg_cluster_size.toFixed(1) : '0.0';
        } catch(e) { console.error('Clustering stats failed:', e); }
    }

    // ══════════════════════════════════════
    //  Recent Alerts (for feed)
    // ══════════════════════════════════════
    async function loadRecentAlerts() {
        try {
            const raw = await apiCall('/api/alerts?page_size=8');
            const alerts = Array.isArray(raw) ? raw : (raw?.alerts || []);
            if (alerts.length === 0) return;

            const el = document.getElementById('operationsFeed');
            if (!el) return;

            el.innerHTML = alerts.slice(0,5).map(a => {
                const sev = (a.severity||'info').toLowerCase();
                const type = a.status==='resolved'?'success':(sev==='critical'?'warning':sev==='warning'?'warning':'info');
                const icon = a.status==='resolved'?'check-circle':(sev==='critical'?'alert-triangle':'alert-circle');
                return `<div class="timeline-item">
                    <div class="timeline-marker ${type}"><i data-feather="${icon}"></i></div>
                    <div class="timeline-content">
                        <div class="feed-header">
                            <span class="feed-title text-${type}">${a.alert_name||'Alert'}</span>
                            <span class="feed-time">${timeAgo(a.timestamp)}</span>
                        </div>
                        <div class="feed-message">
                            Status: <strong>${a.status||'firing'}</strong>${a.instance?` — <span class="code-snippet">${a.instance}</span>`:''}
                        </div>
                        <div class="feed-meta">
                            <span class="meta-tag">Severity: ${(a.severity||'info').toUpperCase()}</span>
                            <span class="meta-tag source">${a.instance||'System'}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if (window.feather) feather.replace();
        } catch(e) { console.error('Recent alerts failed:', e); }
    }

    // ══════════════════════════════════════════════════════
    //  MAIN REFRESH
    // ══════════════════════════════════════════════════════
    async function refreshDashboard() {
        hideDashboardError();
        const btn = document.getElementById('refresh-btn');
        if (btn) btn.classList.add('animate-spin');

        try {
            const data = await apiCall(`/api/alerts/stats?time_range=${currentRange}`);
            if (!data) return;

            updateStats(data);
            renderServiceHealth(data.active_incidents);
            renderActiveIncidents(data.active_incidents);
            renderTrend(data.alert_trend);
            renderMttrTrend(data.alert_trend, data.mttr_minutes);
            renderSeverity(data.severity_distribution);
            renderTopSources(data.top_sources);
            renderOperationsFeed(data.active_incidents, data);
            loadClusteringStats();
        } catch(e) {
            console.error('Dashboard refresh failed:', e);
            showDashboardError(e.message);
            setConnection('Offline','offline');
        } finally {
            if (btn) btn.classList.remove('animate-spin');
        }
    }

    // ══════════════════════════════════════════════════════
    //  INIT
    // ══════════════════════════════════════════════════════
    async function initDashboard() {
        refreshDashboard();
        loadRecentAlerts();
        loadItsmTickets();

        refreshIntervalId = setInterval(() => {
            refreshDashboard();
            loadRecentAlerts();
            loadItsmTickets();
        }, 30000);

        console.log('Dashboard initialized — auto-refresh: 30s');
    }

    // Chart resize handler
    window.addEventListener('resize', () => {
        if (alertTrendChart) alertTrendChart.resize();
        if (severityChart) severityChart.resize();
        if (mttrTrendChart) mttrTrendChart.resize();
    });

    // Launch
    initDashboard();
</script>
{% endblock %}
