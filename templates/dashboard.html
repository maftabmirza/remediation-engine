{% extends "base.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard - AIOps Platform{% endblock %}

{% block head %}
{{ super() }}
<!-- ECharts is loaded globally from base.html -->
{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Overview</span>
{% endblock %}

{% block header_title %}
<div class="flex items-center gap-3">
    <i class="fas fa-tachometer-alt text-blue-400"></i>
    <span class="text-sm font-semibold text-white tracking-tight">Operations Dashboard</span>
    <div class="flex items-center space-x-2 px-1.5 py-0.5">
        <span id="connectionDot" class="w-1.5 h-1.5 rounded-full bg-gray-500"></span>
        <span class="text-[9px] text-gray-400" id="connectionStatus">Checking...</span>
    </div>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex items-center bg-white bg-opacity-10 rounded-lg p-1 border border-white border-opacity-20 h-8">
    <div class="relative">
        <select id="timeRange"
            class="appearance-none bg-transparent text-gray-200 text-xs pl-3 pr-7 py-1 focus:outline-none cursor-pointer hover:text-white transition-colors">
            <option value="24h" class="text-gray-900">Last 24h</option>
            <option value="7d" class="text-gray-900">Last 7d</option>
            <option value="30d" class="text-gray-900">Last 30d</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <i class="fas fa-chevron-down text-[9px]"></i>
        </div>
    </div>
    <div class="w-px h-4 bg-white bg-opacity-20 mx-1"></div>
    <button id="refresh-btn" onclick="refreshDashboard()"
        class="toolbar-btn p-1 rounded hover:bg-white hover:bg-opacity-10 transition-colors text-gray-300 hover:text-white"
        title="Refresh Data">
        <i class="fas fa-sync-alt text-green-400 text-xs"></i>
    </button>
</div>
<!-- RE-VIVE Chat Button -->
<button class="revive-chat-btn" id="ai-helper-toggle" title="RE-VIVE AI Assistant">
    <i data-feather="message-circle" style="width: 18px;"></i>
</button>
<!-- Notifications -->
<button class="icon-btn" title="Notifications">
    <i data-feather="bell" style="width: 18px;"></i>
    <span class="notification-dot"></span>
</button>

<!-- User Profile Dropdown -->
<div class="relative ml-2 user-profile-container">
    <button type="button" class="flex items-center justify-center w-8 h-8 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2
    focus:ring-offset-[#0f0e47] focus:ring-blue-500 transition-all duration-200" id="user-menu-button"
        aria-expanded="false" aria-haspopup="true" onclick="toggleUserMenu()">
        <span class="sr-only">Open user menu</span>
        <div
            class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium text-xs shadow-md hover:bg-blue-700 transition-colors border border-blue-400">
            {{ user.username[0].upper() if user and user.username else 'U' }}
        </div>
    </button>
    <!-- Dropdown Menu -->
    <div id="user-menu-dropdown"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-2xl py-2 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50 transform transition-all duration-200 ease-out scale-95 opacity-0 border border-slate-100"
        role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
        <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 rounded-t-xl">
            <p class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Signed in as</p>
            <p class="text-sm font-bold text-slate-800 truncate mt-1">{{ user.username if user and user.username else
                'User' }}</p>
            <p class="text-xs text-slate-400 truncate">{{ user.role if user and user.role else 'Guest' }}</p>
        </div>

        <div class="py-1">
            <a href="/profile"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="user"
                    class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Profile
            </a>
            <a href="/settings"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="settings"
                    class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Settings
            </a>
        </div>

        <div class="border-t border-slate-100 my-1"></div>

        <div class="py-1">
            <a href="#" onclick="logoutUser(event)"
                class="group flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="log-out"
                    class="mr-3 h-4 w-4 text-red-400 group-hover:text-red-500 transition-colors"></i>
                Sign out
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <div id="dashboardError"
        class="hidden bg-red-900 border border-red-700 text-red-100 p-4 rounded-lg flex items-start justify-between">
        <div>
            <p class="font-semibold">Unable to refresh dashboard</p>
            <p class="text-sm text-red-200" id="dashboardErrorMessage"></p>
        </div>
        <button id="retryDashboard" class="btn-secondary px-3 py-1 rounded text-sm">Retry</button>
    </div>

    <!-- Core Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Total Alerts</p>
                    <p class="text-3xl font-bold mt-1" id="statTotal">{{ stats.total_alerts }}</p>
                    <p class="text-xs text-gray-500 mt-1">Includes all severities in range</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-bell text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Analyzed</p>
                    <p class="text-3xl font-bold mt-1" id="statAnalyzed">{{ stats.analyzed }}</p>
                    <p class="text-xs text-gray-500 mt-1">LLM-reviewed or manual</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-green-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Pending Analysis</p>
                    <p class="text-3xl font-bold mt-1" id="statPending">{{ stats.pending }}</p>
                    <p class="text-xs text-gray-500 mt-1">Awaiting triage</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-yellow-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-400 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Critical Alerts</p>
                    <p class="text-3xl font-bold mt-1" id="statCritical">{{ stats.critical }}</p>
                    <p class="text-xs text-gray-500 mt-1">Unresolved critical items</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-red-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Reliability Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">MTTA</p>
                    <p class="text-3xl font-bold mt-1" id="statMtta">--</p>
                    <p class="text-xs text-gray-500 mt-1">Avg time to acknowledge</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-purple-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-hand-paper text-purple-300 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">MTTR</p>
                    <p class="text-3xl font-bold mt-1" id="statMttr">--</p>
                    <p class="text-xs text-gray-500 mt-1">Avg time to resolve</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-indigo-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-stopwatch text-indigo-300 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">Remediation Success</p>
                    <p class="text-3xl font-bold mt-1" id="statRemediation">--</p>
                    <p class="text-xs text-gray-500 mt-1">Automated runbook success rate</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-green-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-robot text-green-300 text-xl"></i>
                </div>
            </div>
            <div class="mt-3 w-full bg-gray-800 rounded-full h-2">
                <div id="remediationBar" class="h-2 rounded-full bg-green-400" style="width:0%"></div>
            </div>
        </div>
        <div class="rounded-lg shadow-lg p-5"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm flex items-center gap-2">Service Reliability Index
                        <span id="reliabilityInfo" class="text-gray-500" title="">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </p>
                    <p class="text-3xl font-bold mt-1" id="statReliability">--</p>
                    <p class="text-xs text-gray-500 mt-1">Hover the info icon for the weighted breakdown</p>
                </div>
                <div class="w-12 h-12 rounded-lg bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-heartbeat text-blue-300 text-xl"></i>
                </div>
            </div>
            <div class="mt-3 w-full bg-gray-800 rounded-full h-2">
                <div id="reliabilityBar" class="h-2 rounded-full bg-blue-400" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- Alert Clustering Stats -->
    <div class="rounded-lg shadow-lg p-6"
        style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i class="fas fa-layer-group text-purple-400"></i>
                    Alert Clustering
                </h2>
                <p class="text-gray-400 text-sm">Noise reduction through intelligent grouping</p>
            </div>
            <a href="/alerts" class="text-blue-400 text-sm hover:underline">View clusters</a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                <p class="text-gray-400 text-xs mb-1">Active Clusters</p>
                <p class="text-2xl font-bold" id="statActiveClusters">--</p>
                <p class="text-xs text-gray-500 mt-1">Grouped alerts</p>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                <p class="text-gray-400 text-xs mb-1">Noise Reduction</p>
                <p class="text-2xl font-bold text-green-400" id="statNoiseReduction">--</p>
                <p class="text-xs text-gray-500 mt-1">Alerts consolidated</p>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                <p class="text-gray-400 text-xs mb-1">Avg Cluster Size</p>
                <p class="text-2xl font-bold" id="statAvgClusterSize">--</p>
                <p class="text-xs text-gray-500 mt-1">Alerts per cluster</p>
            </div>
        </div>
    </div>

    <!-- Trends & Distribution -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div class="rounded-lg shadow-lg p-6 xl:col-span-2"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Alert Trend</h2>
                    <p class="text-gray-400 text-sm">Volume over selected range</p>
                </div>
                <span class="text-xs text-gray-500" id="trendRangeLabel"></span>
            </div>
            <div id="trendEmptyState"
                class="hidden flex flex-col items-center justify-center py-12 text-center text-gray-500">
                <i class="fas fa-chart-line text-4xl mb-3 text-gray-600"></i>
                <p class="text-sm font-medium text-gray-400">No trend data available</p>
                <p class="text-xs mt-1">Try adjusting the time range</p>
            </div>
            <div id="alertTrendChart" class="w-full" style="height: 280px;"></div>
        </div>
        <div class="rounded-lg shadow-lg p-6"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Severity Distribution</h2>
                    <p class="text-gray-400 text-sm">Visual breakdown by severity</p>
                </div>
            </div>
            <div id="severityChart" class="w-full" style="height: 280px;"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-lg shadow-lg p-6"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Top Alert Sources</h2>
                    <p class="text-gray-400 text-sm">Hosts and services generating most noise</p>
                </div>
            </div>
            <div id="topSources" class="space-y-3 text-sm"></div>
        </div>
        <div class="rounded-lg shadow-lg p-6 lg:col-span-2"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Recent Alerts</h2>
                    <p class="text-gray-400 text-sm">Latest alerts for quick triage</p>
                </div>
                <div class="flex items-center space-x-3 text-sm text-gray-400">
                    <span class="flex items-center space-x-1"><i class="fas fa-sync-alt"></i><span
                            id="lastUpdated">-</span></span>
                    <a href="/alerts" class="text-blue-400 hover:underline">View all</a>
                </div>
            </div>
            <div id="recentAlerts" class="space-y-3">
                <div id="recentAlertsSkeleton" class="space-y-3 animate-pulse">
                    <div class="p-3 rounded-lg bg-gray-800">
                        <div class="flex items-center space-x-3">
                            <div class="w-16 h-3 bg-gray-700 rounded"></div>
                            <div class="w-32 h-3 bg-gray-700 rounded"></div>
                        </div>
                        <div class="w-40 h-3 bg-gray-700 rounded mt-3"></div>
                    </div>
                    <div class="p-3 rounded-lg bg-gray-800">
                        <div class="flex items-center space-x-3">
                            <div class="w-16 h-3 bg-gray-700 rounded"></div>
                            <div class="w-32 h-3 bg-gray-700 rounded"></div>
                        </div>
                        <div class="w-40 h-3 bg-gray-700 rounded mt-3"></div>
                    </div>
                </div>
            </div>
            <div id="recentAlertsError"
                class="hidden text-sm text-red-200 bg-red-900 border border-red-800 rounded-lg p-3 mt-3 flex items-center justify-between">
                <span>Unable to load alerts.</span>
                <button id="retryAlerts" class="btn-secondary px-3 py-1 rounded text-xs">Retry</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="rounded-lg shadow-lg p-6 lg:col-span-3"
            style="background-color: #181b1f; border: 1px solid rgba(204, 204, 220, 0.12);">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Active Incidents Timeline</h2>
                <a href="/alerts" class="text-blue-400 text-sm hover:underline">View all alerts</a>
            </div>
            <div id="activeTimeline" class="relative">
                <div class="absolute left-3 top-0 bottom-0 w-px bg-gray-700"></div>
                <div id="timelineItems" class="space-y-4 relative"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let alertTrendChart = null;
    let severityChart = null;
    let currentRange = '24h';
    let prometheusConfig = null;
    let refreshIntervalId = null;

    // Load Prometheus configuration
    async function loadPrometheusConfig() {
        try {
            const response = await apiCall('/api/prometheus/config');
            if (response && response.ok) {
                prometheusConfig = await response.json();
                console.log('Loaded Prometheus config:', prometheusConfig);
                return prometheusConfig;
            }
        } catch (error) {
            console.error('Failed to load Prometheus config:', error);
            // Use defaults if config load fails
            prometheusConfig = {
                prometheus_refresh_interval: 30,
                infrastructure_cpu_warning_threshold: 75,
                infrastructure_cpu_critical_threshold: 90,
                infrastructure_memory_warning_threshold: 75,
                infrastructure_memory_critical_threshold: 90,
                infrastructure_disk_warning_threshold: 75,
                infrastructure_disk_critical_threshold: 90,
                infrastructure_show_cpu: true,
                infrastructure_show_memory: true,
                infrastructure_show_disk: true,
                infrastructure_metrics_enabled: true,
                chart_enable_zoom: true,
                chart_enable_animations: true
            };
        }
        return prometheusConfig;
    }

    // ECharts Grafana-inspired Dark Theme
    const grafanaDarkTheme = {
        color: [
            '#7EB26D', '#EAB839', '#6ED0E0', '#EF843C', '#E24D42',
            '#1F78C1', '#BA43A9', '#705DA0', '#508642', '#CCA300'
        ],
        backgroundColor: 'transparent',
        textStyle: {
            color: '#D8D9DA',
            fontFamily: 'Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
        },
        title: {
            textStyle: { color: '#D8D9DA' },
            subtextStyle: { color: '#9CA3AF' }
        },
        grid: {
            borderColor: '#374151',
            top: 40,
            bottom: 60,
            left: 60,
            right: 20,
            containLabel: true
        },
        categoryAxis: {
            axisLine: { lineStyle: { color: '#374151' } },
            splitLine: { show: true, lineStyle: { color: '#1F2937', type: 'dashed' } },
            axisLabel: { color: '#9CA3AF' }
        },
        valueAxis: {
            axisLine: { lineStyle: { color: '#374151' } },
            splitLine: { show: true, lineStyle: { color: '#1F2937', type: 'dashed' } },
            axisLabel: { color: '#9CA3AF' }
        },
        tooltip: {
            backgroundColor: '#1F2937',
            borderColor: '#374151',
            textStyle: { color: '#D8D9DA' }
        }
    };

    // Register theme
    if (typeof echarts !== 'undefined') {
        echarts.registerTheme('grafana-dark', grafanaDarkTheme);
    }

    const timeRangeSelect = document.getElementById('timeRange');
    const dashboardError = document.getElementById('dashboardError');
    const dashboardErrorMessage = document.getElementById('dashboardErrorMessage');
    const connectionDot = document.getElementById('connectionDot');
    const connectionStatus = document.getElementById('connectionStatus');
    const trendRangeLabel = document.getElementById('trendRangeLabel');

    timeRangeSelect.addEventListener('change', () => {
        currentRange = timeRangeSelect.value;
        refreshDashboard();
    });

    document.getElementById('retryDashboard').addEventListener('click', refreshDashboard);
    document.getElementById('retryAlerts').addEventListener('click', loadRecentAlerts);

    function setConnection(statusText, lastSyncTime, statusState = 'online') {
        connectionStatus.textContent = statusText;
        // lastSync element removed from UI
        connectionDot.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
        const colorClass = statusState === 'online' ? 'bg-green-500' : statusState === 'degraded' ? 'bg-yellow-500' : 'bg-red-500';
        connectionDot.classList.add(colorClass);
    }

    function showDashboardError(message) {
        dashboardErrorMessage.textContent = message || 'Unexpected error occurred.';
        dashboardError.classList.remove('hidden');
    }

    function hideDashboardError() {
        dashboardError.classList.add('hidden');
    }

    function formatMinutes(value) {
        if (!value || Number.isNaN(value)) return '—';
        if (value >= 60) {
            const hours = (value / 60).toFixed(1);
            return `${hours}h`;
        }
        return `${value.toFixed(1)}m`;
    }

    function updateStats(data) {
        document.getElementById('statTotal').textContent = data.total_alerts;
        document.getElementById('statAnalyzed').textContent = data.analyzed_alerts;
        document.getElementById('statPending').textContent = data.pending_alerts;
        document.getElementById('statCritical').textContent = data.critical_alerts;
        document.getElementById('statMtta').textContent = formatMinutes(data.mtta_minutes);
        document.getElementById('statMttr').textContent = formatMinutes(data.mttr_minutes);
        document.getElementById('statRemediation').textContent = `${data.remediation_success_rate.toFixed(1)}%`;
        document.getElementById('statReliability').textContent = `${data.reliability_index}%`;
        document.getElementById('remediationBar').style.width = `${Math.min(data.remediation_success_rate, 100)}%`;
        document.getElementById('reliabilityBar').style.width = `${Math.min(data.reliability_index, 100)}%`;
        const breakdown = data.reliability_breakdown || {};
        const tooltipText = [
            `Critical impact: ${(breakdown.critical_impact || 0).toFixed(1)} / 40`,
            `Timeliness: ${(breakdown.timeliness || 0).toFixed(1)} / 35`,
            `Remediation: ${(breakdown.remediation || 0).toFixed(1)} / 25`,
            'Weights: 40% critical, 35% timeliness, 25% remediation'
        ].join('\n');
        document.getElementById('reliabilityInfo').setAttribute('title', tooltipText);
        trendRangeLabel.textContent = `Range: ${data.time_range}`;
        setConnection(data.connection_status === 'online' ? 'Online' : 'Degraded', data.last_sync_time ? new Date(data.last_sync_time).toLocaleString() : '-', data.connection_status);
    }

    function renderTrend(trendData) {
        const chartContainer = document.getElementById('alertTrendChart');
        const emptyState = document.getElementById('trendEmptyState');
        const hasPoints = Array.isArray(trendData) && trendData.length > 0;

        if (!hasPoints) {
            emptyState.classList.remove('hidden');
            chartContainer.style.display = 'none';
            if (alertTrendChart) {
                alertTrendChart.dispose();
                alertTrendChart = null;
            }
            return;
        }

        const labels = trendData.map(p => new Date(p.bucket).toLocaleString());
        const values = trendData.map(p => p.count || 0);

        emptyState.classList.add('hidden');
        chartContainer.style.display = 'block';

        // Initialize or update chart
        if (!alertTrendChart) {
            alertTrendChart = echarts.init(chartContainer, 'grafana-dark');
        }

        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: labels,
                axisLabel: { rotate: 30, fontSize: 11 }
            },
            yAxis: {
                type: 'value',
                minInterval: 1
            },
            series: [{
                name: 'Alerts',
                type: 'line',
                smooth: true,
                areaStyle: { opacity: 0.3 },
                data: values,
                itemStyle: { color: '#7EB26D' },
                lineStyle: { width: 2 }
            }],
            dataZoom: [{
                type: 'inside',
                start: 0,
                end: 100
            }]
        };

        alertTrendChart.setOption(option);

        // Auto resize on window resize
        window.addEventListener('resize', () => {
            if (alertTrendChart) alertTrendChart.resize();
        });
    }

    function renderSeverity(distribution) {
        const chartContainer = document.getElementById('severityChart');

        // Define severity colors
        const severityConfig = {
            'critical': { color: '#E24D42', label: 'Critical' },
            'error': { color: '#EF843C', label: 'Error' },
            'warning': { color: '#EAB839', label: 'Warning' },
            'info': { color: '#6ED0E0', label: 'Info' },
            'other': { color: '#9ca3af', label: 'Other' }
        };

        const data = Object.entries(distribution).map(([sev, count]) => {
            const lowSev = sev.toLowerCase();
            const config = severityConfig[lowSev] || severityConfig['other'];
            return {
                name: config.label,
                value: count,
                itemStyle: { color: config.color }
            };
        });

        // Initialize or update chart
        if (!severityChart) {
            severityChart = echarts.init(chartContainer, 'grafana-dark');
        }

        const option = {
            tooltip: {
                trigger: 'item',
                formatter: '{b}: {c} ({d}%)'
            },
            legend: {
                orient: 'horizontal',
                bottom: '0',
                textStyle: { color: '#9CA3AF' }
            },
            series: [{
                name: 'Severity',
                type: 'pie',
                radius: ['40%', '70%'],
                center: ['50%', '45%'],
                avoidLabelOverlap: true,
                label: {
                    show: true,
                    formatter: '{b}: {c}',
                    color: '#D8D9DA'
                },
                emphasis: {
                    label: {
                        show: true,
                        fontSize: 14,
                        fontWeight: 'bold'
                    }
                },
                data: data
            }]
        };

        severityChart.setOption(option);

        // Auto resize on window resize
        window.addEventListener('resize', () => {
            if (severityChart) severityChart.resize();
        });
    }

    function renderTopSources(sources) {
        const container = document.getElementById('topSources');
        if (!sources.length) {
            container.innerHTML = '<p class="text-gray-400">No sources in selected range.</p>';
            return;
        }
        container.innerHTML = sources.map(item => `
            <div class="flex items-center justify-between p-3 rounded-lg bg-gray-800">
                <div class="flex items-center space-x-3">
                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                    <span class="font-medium">${item.source}</span>
                </div>
                <span class="text-gray-300 font-semibold">${item.count}</span>
            </div>
        `).join('');
    }

    function renderTimeline(incidents) {
        const container = document.getElementById('timelineItems');
        if (!incidents.length) {
            container.innerHTML = '<p class="text-gray-400">No active incidents right now.</p>';
            return;
        }
        container.innerHTML = incidents.map(incident => `
            <div class="relative pl-8">
                <div class="absolute left-0 top-1 w-4 h-4 rounded-full ${incident.severity === 'critical' ? 'bg-red-500' : incident.severity === 'warning' ? 'bg-yellow-400' : 'bg-blue-400'} border-2 border-gray-900"></div>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-semibold">${incident.alert_name}</p>
                        <p class="text-xs text-gray-400">${incident.severity || 'info'} • ${new Date(incident.timestamp).toLocaleString()}</p>
                    </div>
                    <span class="text-xs px-2 py-1 rounded bg-gray-800 border border-gray-700">${incident.status}</span>
                </div>
            </div>
        `).join('');
    }

    async function refreshDashboard() {
        hideDashboardError();
        try {
            const data = await apiCall(`/api/alerts/stats?time_range=${currentRange}`);
            if (!data) return;

            updateStats(data);
            renderTrend(data.alert_trend);
            renderSeverity(data.severity_distribution);
            renderTopSources(data.top_sources);
            renderTimeline(data.active_incidents);

            // Load clustering stats
            loadClusteringStats();
        } catch (error) {
            console.error('Failed to load dashboard', error);
            showDashboardError(error.message);
            setConnection('Offline', null, 'offline');
        }
    }

    async function loadClusteringStats() {
        try {
            const stats = await apiCall('/api/clusters/stats/overview');
            if (!stats) return;

            document.getElementById('statActiveClusters').textContent = stats.active_clusters || 0;
            document.getElementById('statNoiseReduction').textContent = `${stats.noise_reduction_pct || 0}%`;
            document.getElementById('statAvgClusterSize').textContent = stats.avg_cluster_size ? stats.avg_cluster_size.toFixed(1) : '0.0';
        } catch (error) {
            console.error('Failed to load clustering stats:', error);
            // Silently fail - don't break the dashboard
        }
    }

    // Recent alerts handling
    // Recent alerts handling
    async function loadRecentAlerts() {
        const skeleton = document.getElementById('recentAlertsSkeleton');
        const errorBox = document.getElementById('recentAlertsError');
        const container = document.getElementById('recentAlerts');

        if (skeleton) skeleton.classList.remove('hidden');
        if (errorBox) errorBox.classList.add('hidden');

        try {
            const data = await apiCall('/api/alerts?page_size=5');
            // apiCall handles 401 redirects. If null, we just return.
            if (!data) return;

            // data is expected to be a list of alerts based on API definition
            // But let's handle if it returns { alerts: [...] } wrapper
            const alerts = Array.isArray(data) ? data : (data.alerts || []);

            if (alerts.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-3 text-gray-600"></i>
                        <p class="text-sm font-medium text-gray-400">No recent alerts</p>
                        <p class="text-xs mt-1">System is healthy</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = alerts.map(alert => `
                <a href="/alerts/${alert.id}" class="block p-3 rounded-lg bg-gray-800 hover:bg-gray-700 transition">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="badge-${(alert.severity || 'info').toLowerCase()} px-2 py-1 rounded text-xs font-medium">
                                ${alert.severity || 'info'}
                            </span>
                            <span class="font-medium text-white">${alert.alert_name}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                             ${alert.status === 'firing'
                    ? '<i class="fas fa-fire text-red-400" title="Firing"></i>'
                    : '<i class="fas fa-check-circle text-green-400" title="Resolved"></i>'}
                        </div>
                    </div>
                    <div class="text-sm text-gray-400 mt-1">
                        ${alert.instance || 'No instance'} • ${new Date(alert.timestamp).toLocaleString()}
                    </div>
                </a>
            `).join('');

            // Update timestamp
            const timeDisplay = document.getElementById('lastUpdated');
            if (timeDisplay) timeDisplay.textContent = new Date().toLocaleTimeString();

        } catch (error) {
            console.error('Failed to load alerts:', error);
            if (errorBox) errorBox.classList.remove('hidden');
            if (container) container.innerHTML = '';
        } finally {
            if (skeleton) skeleton.classList.add('hidden');
        }
    }

    // Initialize dashboard
    async function initDashboard() {
        // Load configuration first
        await loadPrometheusConfig();

        // Initial data load
        refreshDashboard();
        loadRecentAlerts();

        // Load infrastructure only if enabled
        if (prometheusConfig && prometheusConfig.infrastructure_metrics_enabled !== false) {
            loadInfrastructureHealth();
        }

        // Setup auto-refresh with configurable interval
        const refreshInterval = (prometheusConfig?.prometheus_refresh_interval || 30) * 1000;

        // Clear any existing interval
        if (refreshIntervalId) {
            clearInterval(refreshIntervalId);
        }

        // Set new interval
        refreshIntervalId = setInterval(() => {
            refreshDashboard();
            loadRecentAlerts();

            if (prometheusConfig && prometheusConfig.infrastructure_metrics_enabled !== false) {
                loadInfrastructureHealth();
            }

            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }, refreshInterval);

        console.log(`Dashboard auto-refresh set to ${refreshInterval / 1000} seconds`);
    }

    // Start the dashboard
    initDashboard();

    // Placeholder for missing infrastructure health function
    function loadInfrastructureHealth() {
        console.warn('loadInfrastructureHealth not implemented or removed');
    }
</script>
{% endblock %}