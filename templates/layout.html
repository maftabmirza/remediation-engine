{% extends "base.html" %}

{% block body %}
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-20 fixed h-full flex flex-col transition-all duration-300 z-20">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <div class="flex items-center space-x-3 overflow-hidden">
                <i class="fas fa-robot text-2xl text-blue-400 flex-shrink-0"></i>
                <span class="text-xl font-bold sidebar-text whitespace-nowrap hidden">AIOps</span>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-2 overflow-hidden">
            <a href="/"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'dashboard' %}active{% endif %}"
                data-tooltip="Dashboard">
                <i class="fas fa-tachometer-alt w-5 flex-shrink-0 nav-icon text-blue-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Dashboard</span>
            </a>
            <a href="/alerts"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'alerts' %}active{% endif %}"
                data-tooltip="Alerts">
                <i class="fas fa-bell w-5 flex-shrink-0 nav-icon text-yellow-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Alerts</span>
            </a>
            <a href="/rules"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'rules' %}active{% endif %}"
                data-tooltip="Rules">
                <i class="fas fa-cogs w-5 flex-shrink-0 nav-icon text-purple-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Rules</span>
            </a>

            <!-- Auto-Remediation Section -->
            <div class="mt-4 mb-2 px-4 sidebar-text hidden">
                <span class="text-xs text-gray-500 uppercase tracking-wider">Remediation</span>
            </div>
            <a href="/runbooks"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'runbooks' %}active{% endif %}"
                data-tooltip="Runbooks">
                <i class="fas fa-book w-5 flex-shrink-0 nav-icon text-green-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Runbooks</span>
            </a>
            <a href="/executions"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'executions' %}active{% endif %}"
                data-tooltip="Executions">
                <i class="fas fa-play-circle w-5 flex-shrink-0 nav-icon text-red-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Executions</span>
            </a>
            <a href="/schedules"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'schedules' %}active{% endif %}"
                data-tooltip="Schedules">
                <i class="fas fa-calendar-alt w-5 flex-shrink-0 nav-icon text-orange-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Schedules</span>
            </a>

            <a href="/settings"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'settings' %}active{% endif %}"
                data-tooltip="Settings">
                <i class="fas fa-sliders-h w-5 flex-shrink-0 nav-icon text-gray-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Settings</span>
            </a>
            {% if user.role == 'admin' %}
            <a href="/audit"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'audit' %}active{% endif %}"
                data-tooltip="Audit Logs">
                <i class="fas fa-history w-5 flex-shrink-0 nav-icon text-cyan-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Audit Logs</span>
            </a>
            {% endif %}
        </nav>

        <!-- User Profile Dropdown -->
        <div class="p-4 border-t border-gray-700 relative group">
            <button id="userMenuBtn"
                class="flex items-center space-x-3 w-full hover:bg-gray-800 p-2 rounded-lg transition-colors focus:outline-none sidebar-item"
                onclick="toggleUserMenu()" data-tooltip="Profile / Theme">
                <div
                    class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 border-2 border-transparent group-hover:border-blue-400 transition-all">
                    <span class="text-sm font-bold">{{ user.username[0].upper() }}</span>
                </div>
                <div class="sidebar-text whitespace-nowrap hidden text-left flex-1">
                    <div class="font-medium text-sm truncate">{{ user.username }}</div>
                    <div class="text-xs text-gray-400 capitalize">{{ user.role }}</div>
                </div>
                <i class="fas fa-chevron-right text-gray-500 text-xs sidebar-text hidden"></i>
            </button>

            <!-- Dropdown Menu -->
            <div id="userMenu"
                class="fixed left-20 bottom-4 w-64 bg-[#181b1f] border border-gray-700 rounded-lg shadow-xl transform scale-95 opacity-0 pointer-events-none transition-all duration-200 z-50 origin-bottom-left ml-2 hidden">
                <!-- Header -->
                <div class="p-4 border-b border-gray-700 bg-gray-800/30">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center shadow-lg">
                            <span class="text-lg font-bold text-white">{{ user.username[0].upper() }}</span>
                        </div>
                        <div>
                            <div class="font-bold text-white">{{ user.username }}</div>
                            <div class="text-xs text-blue-400 capitalize">{{ user.role }}</div>
                        </div>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="p-2 space-y-1">
                    <button onclick="showThemeModal(); closeUserMenu()"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-palette text-purple-400"></i></div>
                        <span>Appearance</span>
                    </button>
                    <!-- Settings Link (Duplicate of sidebar for convenience) -->
                    <a href="/profile"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-user-cog text-gray-400"></i></div>
                        <span>User Settings</span>
                    </a>
                </div>

                <!-- Footer -->
                <div class="p-2 border-t border-gray-700 bg-gray-800/30">
                    <button onclick="logout()"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-red-400 hover:bg-red-900/20 hover:text-red-300 transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-sign-out-alt"></i></div>
                        <span>Log Out</span>
                    </button>
                </div>
            </div>

            <!-- Build Version -->
            <div class="mt-2 text-[10px] text-gray-600 text-center sidebar-text hidden">
                Build v1.0.2
            </div>
        </div>
    </aside>

    <!-- Main content -->
    <main id="main-content" class="flex-1 ml-20 p-6 h-screen overflow-y-auto flex flex-col transition-all duration-300">
        {% block content %}{% endblock %}
    </main>
</div>

<!-- Theme Selection Modal -->
<div id="themeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
    <div class="card p-6 w-full max-w-md m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-palette text-purple-400 mr-2"></i>
                Appearance
            </h3>
            <button onclick="closeThemeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- Theme Selection -->
            <div>
                <p class="text-sm text-gray-400 mb-3">Color Theme:</p>
                <div class="grid grid-cols-2 gap-3">
                    <button data-theme-btn="default" onclick="setTheme('default')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#1e1e2e] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Default</span>
                    </button>

                    <button data-theme-btn="light" onclick="setTheme('light')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#f3f4f6] border border-gray-300"></div>
                        <span class="text-sm group-hover:text-blue-400">Light</span>
                    </button>

                    <button data-theme-btn="aftab" onclick="setTheme('aftab')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div
                            class="w-6 h-6 rounded-full bg-[#111217] border border-gray-500 flex items-center justify-center">
                            <span class="text-xs font-bold text-orange-500">A</span>
                        </div>
                        <span class="text-sm group-hover:text-blue-400">Aftab</span>
                    </button>

                    <button data-theme-btn="twilight" onclick="setTheme('twilight')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#282a36] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Twilight</span>
                    </button>

                    <button data-theme-btn="midnight" onclick="setTheme('midnight')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#0f172a] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Midnight</span>
                    </button>
                </div>
            </div>

            <!-- Zoom Control -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm text-gray-400">Zoom:</p>
                    <span id="zoomValue" class="text-sm font-medium text-blue-400">100%</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="adjustZoom(-10)"
                        class="btn-secondary w-8 h-8 rounded flex items-center justify-center text-lg" title="Zoom Out">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <input type="range" id="zoomSlider" min="75" max="150" step="5" value="100"
                        class="zoom-slider flex-1" onchange="setZoom(this.value)"
                        oninput="updateZoomDisplay(this.value)">
                    <button onclick="adjustZoom(10)"
                        class="btn-secondary w-8 h-8 rounded flex items-center justify-center text-lg" title="Zoom In">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1 px-1">
                    <span>75%</span>
                    <span>100%</span>
                    <span>150%</span>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-between items-center">
            <button onclick="resetAppearance()" class="text-sm text-gray-400 hover:text-white">
                <i class="fas fa-undo mr-1"></i>Reset to Default
            </button>
            <button onclick="closeThemeModal()" class="btn-secondary px-4 py-2 rounded">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showThemeModal() {
        document.getElementById('themeModal').classList.remove('hidden');
        document.getElementById('themeModal').classList.add('flex');
        updateThemeButtons();
        updateZoomSlider();
    }

    function closeThemeModal() {
        document.getElementById('themeModal').classList.add('hidden');
        document.getElementById('themeModal').classList.remove('flex');
    }

    function updateThemeButtons() {
        const currentTheme = localStorage.getItem('aiops-theme') || 'aftab';
        // Remove active state from all buttons
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.remove('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
            btn.classList.add('border-gray-600');
        });
        // Add active state to current theme button using data attribute
        const activeBtn = document.querySelector(`[data-theme-btn="${currentTheme}"]`);
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-600');
            activeBtn.classList.add('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function updateZoomSlider() {
        const currentZoom = localStorage.getItem('aiops-zoom') || '100';
        const slider = document.getElementById('zoomSlider');
        const display = document.getElementById('zoomValue');
        if (slider) slider.value = currentZoom;
        if (display) display.textContent = currentZoom + '%';
    }

    function updateZoomDisplay(value) {
        document.getElementById('zoomValue').textContent = value + '%';
    }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('aiops-theme', themeName);
        updateThemeButtons();
        showToast(`Theme changed to ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`, 'success');
    }

    function setZoom(value) {
        document.documentElement.style.setProperty('--zoom-level', value);
        localStorage.setItem('aiops-zoom', value);
        updateZoomDisplay(value);
    }

    function adjustZoom(delta) {
        const slider = document.getElementById('zoomSlider');
        let newValue = parseInt(slider.value) + delta;
        newValue = Math.max(75, Math.min(150, newValue));
        slider.value = newValue;
        setZoom(newValue);
    }

    function resetAppearance() {
        setTheme('aftab');
        setZoom(100);
        showToast('Appearance reset to defaults', 'success');
    }

    function toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');
        const isHidden = menu.classList.contains('hidden');

        if (isHidden) {
            menu.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                menu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
            }, 10);
            btn.classList.add('bg-gray-800');
        } else {
            closeUserMenu();
        }
    }

    function closeUserMenu() {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');

        menu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        btn.classList.remove('bg-gray-800');

        setTimeout(() => {
            menu.classList.add('hidden');
        }, 200);
    }

    // Close user menu on outside click
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');

        if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
            closeUserMenu();
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const texts = document.querySelectorAll('.sidebar-text');

        if (sidebar.classList.contains('w-64')) {
            // Collapse
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-20');
            mainContent.classList.remove('ml-64');
            mainContent.classList.add('ml-20');
            texts.forEach(t => t.classList.add('hidden'));
        } else {
            // Expand
            sidebar.classList.remove('w-20');
            sidebar.classList.add('w-64');
            mainContent.classList.remove('ml-20');
            mainContent.classList.add('ml-64');
            texts.forEach(t => t.classList.remove('hidden'));
        }

        // Trigger resize for terminal
        setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (e) { }
        window.location.href = '/login';
    }
</script>
{{ super() }}
{% endblock %}