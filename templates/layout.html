{% extends "base.html" %}

{% block body %}
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-20 fixed h-full flex flex-col transition-all duration-300 z-20">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <div class="flex items-center space-x-3 overflow-hidden">
                <i class="fas fa-robot text-2xl text-blue-400 flex-shrink-0"></i>
                <span class="text-xl font-bold sidebar-text whitespace-nowrap hidden">AIOps</span>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        
        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-2 overflow-hidden">
            <a href="/" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'dashboard' %}active{% endif %}">
                <i class="fas fa-tachometer-alt w-5 flex-shrink-0 nav-icon text-blue-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Dashboard</span>
            </a>
            <a href="/alerts" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'alerts' %}active{% endif %}">
                <i class="fas fa-bell w-5 flex-shrink-0 nav-icon text-yellow-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Alerts</span>
            </a>
            <a href="/rules" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'rules' %}active{% endif %}">
                <i class="fas fa-cogs w-5 flex-shrink-0 nav-icon text-purple-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Rules</span>
            </a>
            
            <!-- Auto-Remediation Section -->
            <div class="mt-4 mb-2 px-4 sidebar-text hidden">
                <span class="text-xs text-gray-500 uppercase tracking-wider">Remediation</span>
            </div>
            <a href="/runbooks" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'runbooks' %}active{% endif %}">
                <i class="fas fa-book w-5 flex-shrink-0 nav-icon text-green-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Runbooks</span>
            </a>
            <a href="/executions" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'executions' %}active{% endif %}">
                <i class="fas fa-play-circle w-5 flex-shrink-0 nav-icon text-red-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Executions</span>
            </a>
            
            <a href="/settings" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'settings' %}active{% endif %}">
                <i class="fas fa-sliders-h w-5 flex-shrink-0 nav-icon text-gray-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Settings</span>
            </a>
            {% if user.role == 'admin' %}
            <a href="/audit" class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'audit' %}active{% endif %}">
                <i class="fas fa-history w-5 flex-shrink-0 nav-icon text-cyan-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Audit Logs</span>
            </a>
            {% endif %}
        </nav>
        
        <!-- User -->
        <div class="p-4 border-t border-gray-700 overflow-hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="showThemeModal()">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 hover:ring-2 hover:ring-white transition-all">
                        <span class="text-sm font-bold">{{ user.username[0].upper() }}</span>
                    </div>
                    <div class="sidebar-text whitespace-nowrap hidden">
                        <div class="font-medium">{{ user.username }}</div>
                        <div class="text-xs text-gray-400">{{ user.role }}</div>
                    </div>
                </div>
                <div class="flex space-x-1 sidebar-text hidden">
                    <button onclick="showThemeModal()" class="text-gray-400 hover:text-white p-1" title="Theme Settings">
                        <i class="fas fa-palette"></i>
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-white p-1" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            <!-- Build Version -->
            <div class="mt-2 text-[10px] text-gray-600 text-center sidebar-text hidden">
                Build v1.0.2
            </div>
        </div>
    </aside>
    
    <!-- Main content -->
    <main id="main-content" class="flex-1 ml-20 p-6 h-screen overflow-y-auto flex flex-col transition-all duration-300">
        {% block content %}{% endblock %}
    </main>
</div>

<!-- Theme Selection Modal -->
<div id="themeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-md m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-palette text-purple-400 mr-2"></i>
                Appearance
            </h3>
            <button onclick="closeThemeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <p class="text-sm text-gray-400">Choose your preferred color theme:</p>
            
            <div class="grid grid-cols-2 gap-3">
                <button id="theme-btn-default" onclick="setTheme('default')" class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                    <div class="w-6 h-6 rounded-full bg-[#1e1e2e] border border-gray-500"></div>
                    <span class="text-sm group-hover:text-blue-400">Default (Dark)</span>
                    <i class="fas fa-check text-green-400 ml-auto theme-check hidden"></i>
                </button>
                
                <button id="theme-btn-light" onclick="setTheme('light')" class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                    <div class="w-6 h-6 rounded-full bg-[#f3f4f6] border border-gray-300"></div>
                    <span class="text-sm group-hover:text-blue-400">Light</span>
                    <i class="fas fa-check text-green-400 ml-auto theme-check hidden"></i>
                </button>
                
                <button id="theme-btn-aftab" onclick="setTheme('aftab')" class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                    <div class="w-6 h-6 rounded-full bg-[#111217] border border-gray-500 flex items-center justify-center">
                        <span class="text-xs font-bold text-orange-500">A</span>
                    </div>
                    <span class="text-sm group-hover:text-blue-400">Aftab</span>
                    <i class="fas fa-check text-green-400 ml-auto theme-check hidden"></i>
                </button>
                
                <button id="theme-btn-twilight" onclick="setTheme('twilight')" class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                    <div class="w-6 h-6 rounded-full bg-[#282a36] border border-gray-500"></div>
                    <span class="text-sm group-hover:text-blue-400">Twilight</span>
                    <i class="fas fa-check text-green-400 ml-auto theme-check hidden"></i>
                </button>
                
                <button id="theme-btn-midnight" onclick="setTheme('midnight')" class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                    <div class="w-6 h-6 rounded-full bg-[#0f172a] border border-gray-500"></div>
                    <span class="text-sm group-hover:text-blue-400">Midnight</span>
                    <i class="fas fa-check text-green-400 ml-auto theme-check hidden"></i>
                </button>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button onclick="closeThemeModal()" class="btn-secondary px-4 py-2 rounded">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function showThemeModal() {
        document.getElementById('themeModal').classList.remove('hidden');
        document.getElementById('themeModal').classList.add('flex');
        updateThemeButtons();
    }
    
    function closeThemeModal() {
        document.getElementById('themeModal').classList.add('hidden');
        document.getElementById('themeModal').classList.remove('flex');
    }
    
    function updateThemeButtons() {
        const currentTheme = localStorage.getItem('aiops-theme') || 'aftab';
        // Remove active state from all buttons
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.remove('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
            btn.classList.add('border-gray-600');
            const check = btn.querySelector('.theme-check');
            if (check) check.classList.add('hidden');
        });
        // Add active state to current theme button
        const activeBtn = document.getElementById(`theme-btn-${currentTheme}`);
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-600');
            activeBtn.classList.add('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
            const check = activeBtn.querySelector('.theme-check');
            if (check) check.classList.remove('hidden');
        }
    }
    
    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('aiops-theme', themeName);
        updateThemeButtons();
        showToast(`Theme set to ${themeName}`, 'success');
        closeThemeModal();
    }

    // Close modal on outside click
    document.getElementById('themeModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeThemeModal();
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const texts = document.querySelectorAll('.sidebar-text');
        
        if (sidebar.classList.contains('w-64')) {
            // Collapse
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-20');
            mainContent.classList.remove('ml-64');
            mainContent.classList.add('ml-20');
            texts.forEach(t => t.classList.add('hidden'));
        } else {
            // Expand
            sidebar.classList.remove('w-20');
            sidebar.classList.add('w-64');
            mainContent.classList.remove('ml-20');
            mainContent.classList.add('ml-64');
            texts.forEach(t => t.classList.remove('hidden'));
        }
        
        // Trigger resize for terminal
        setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (e) {}
        window.location.href = '/login';
    }
</script>
{{ super() }}
{% endblock %}
