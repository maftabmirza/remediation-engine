{% extends "base.html" %}

{% set active_page = 'grafana-advanced' %}

{% block title %}Debug Step 4 ‚Äî Widget JS Only{% endblock %}

{% block content %}
<style>
    .grafana-container {
        position: fixed !important;
        top: 48px !important;
        left: 48px !important;
        right: 0 !important;
        width: auto !important;
        height: calc(100vh - 48px) !important;
        bottom: 0 !important;
        overflow: hidden !important;
        background: #111 !important;
        transition: left 0.3s ease, right 0.3s ease;
        z-index: 10;
    }

    .app-container:not(.collapsed) .grafana-container {
        left: 170px !important;
    }

    .grafana-container iframe {
        border: none !important;
        display: block !important;
        width: 100% !important;
        height: 100% !important;
    }

    .grafana-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #aaa;
        font-size: 18px;
        text-align: center;
    }

    .grafana-loading .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #333;
        border-top-color: #1f77b4;
        border-radius: 50%;
        animation: grafana-spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes grafana-spin {
        to { transform: rotate(360deg); }
    }

    .debug-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
        background: rgba(0,0,0,0.85);
        padding: 16px 20px;
        border-radius: 8px;
        color: #fff;
        font-size: 13px;
        max-width: 350px;
        border: 1px solid #333;
    }
</style>

<div class="grafana-container">
    <div class="grafana-loading" id="loading">
        <div class="spinner"></div>
        <div>Loading Grafana Dashboards...</div>
    </div>
    <iframe id="grafana-iframe"
        src="/grafana/dashboards?orgId=1&kiosk">
    </iframe>
    <div class="debug-overlay">
        <h3 style="font-size: 16px; margin-bottom: 8px;">üü° Step 4 ‚Äî Widget JS Added</h3>
        <ul style="line-height: 1.8; color: #aaa;">
            <li>‚úÖ base.html OK</li>
            <li>‚úÖ .grafana-container CSS OK</li>
            <li>‚úÖ iframe loading Grafana</li>
            <li>‚ö†Ô∏è revive_widget_grafana.js loaded</li>
            <li>‚ö†Ô∏è revive_widget.js ALSO loaded (from base.html)</li>
            <li id="widget-conflict-status">‚è≥ Checking for conflicts...</li>
        </ul>
        <p style="margin-top: 12px; font-size: 12px; color: #888;">
            If page goes blank here ‚Üí widget JS is the culprit.<br>
            Both revive_widget.js (base) and revive_widget_grafana.js load together.
        </p>
        <p style="margin-top: 12px;">
            <a href="/grafana-debug/step3" style="color: #60a5fa; text-decoration: underline; font-size: 12px;">‚Üê Step 3</a> |
            <a href="/grafana-debug/step5" style="color: #60a5fa; text-decoration: underline; font-size: 12px;">‚Üí Step 5 (Full)</a>
        </p>
    </div>
</div>

<script>
    (function() {
        var iframe = document.getElementById('grafana-iframe');
        if (!iframe) return;

        var loading = document.getElementById('loading');
        var timeoutId = setTimeout(function() {
            if (loading) {
                loading.innerHTML = '<div style="color: #f44;">Grafana did not load in time. Check if the proxy is reachable at <a href="/grafana/" target="_blank" style="color:#7aa2ff; text-decoration:underline;">/grafana/</a>.</div>';
            }
        }, 15000);

        iframe.onload = function () {
            clearTimeout(timeoutId);
            if (loading) loading.style.display = 'none';
        };

        iframe.onerror = function () {
            clearTimeout(timeoutId);
            if (loading) {
                loading.innerHTML = '<div style="color: #f44;">Failed to load Grafana. Please check if the service is running.</div>';
            }
        };
    })();

    // Detect dual-widget conflict
    window.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            var status = document.getElementById('widget-conflict-status');
            if (!status) return;
            var panels = document.querySelectorAll('#ai-helper-panel, .ai-helper-panel');
            var toggles = document.querySelectorAll('#ai-helper-toggle');
            status.innerHTML = 'üîç Found ' + panels.length + ' AI panels, ' + toggles.length + ' toggle buttons';
            if (panels.length > 1) {
                status.style.color = '#f44';
                status.innerHTML += ' ‚Äî <strong>CONFLICT DETECTED!</strong>';
            } else {
                status.style.color = '#4f4';
            }
        }, 3000);
    });
</script>

<!-- RE-VIVE Grafana Widget (on top of base.html's revive_widget.js) -->
<link href="/static/css/revive_widget_grafana.css?v=20260211a" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="/static/js/revive_widget_grafana.js?v=20260211a"></script>
{% endblock %}
