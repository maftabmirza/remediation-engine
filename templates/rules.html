{% extends "base.html" %}
{% set active_page = 'rules' %}

{% block title %}Rules - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Rules</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-list-check text-purple-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Auto-Analyze Rules</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<style>
    .rule-action-auto { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .rule-action-ignore { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .rule-action-manual { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .rules-new-btn:hover { background: linear-gradient(135deg, #2563eb, #1d4ed8) !important; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35); transform: translateY(-1px); }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar -->
    <div class="card p-4" style="overflow: visible;">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <p class="text-sm text-[#64748b]">Configure automated analysis policies based on alert patterns.</p>
            {% if user.role == 'admin' %}
            <button onclick="openModal()"
                class="rules-new-btn inline-flex items-center gap-2 px-4 py-2 text-sm font-semibold rounded-lg transition-all border-none cursor-pointer"
                style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);">
                <i class="fas fa-plus"></i>
                <span>New Rule</span>
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Rules Info -->
    <div class="card p-4 bg-[#eff6ff] border border-[#bfdbfe] rounded-lg">
        <div class="flex items-start gap-3">
            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
            <div class="text-sm">
                <p class="font-medium text-blue-700">How Rules Work</p>
                <p class="text-[#475569] mt-1">
                    Rules are evaluated in priority order (lower number = higher priority).
                    The first matching rule determines the action. Use wildcards (*) to match any value.
                </p>
            </div>
        </div>
    </div>

    <!-- Rules Table -->
    <div class="card overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-6 py-3 font-medium">Name</th>
                    <th class="px-6 py-3 font-medium">Priority</th>
                    <th class="px-6 py-3 font-medium">Match</th>
                    <th class="px-6 py-3 font-medium">Action</th>
                    <th class="px-6 py-3 font-medium">Enabled</th>
                    <th class="px-6 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="rulesTableBody" class="text-[#334155] divide-y divide-[#e2e8f0]">
                <tr>
                    <td colspan="6" class="p-8 text-center">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p class="text-[#64748b]">Loading rules...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Test Rule Matching -->
    <div class="card p-6">
        <h3 class="font-semibold text-lg mb-2 text-[#1e293b]">
            <i class="fas fa-flask text-purple-500 mr-2"></i>Test Rule Matching
        </h3>
        <p class="text-sm text-[#64748b] mb-4">Enter sample alert values to see which rule would match</p>

        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[140px]">
                <label class="block text-xs font-medium text-[#64748b] mb-1">Alert name</label>
                <input type="text" id="testAlertName" class="w-full bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#1e293b] focus:outline-none focus:border-[#3b82f6] focus:ring-2 focus:ring-[#3b82f6]/20"
                    placeholder="e.g. CPUHigh">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="block text-xs font-medium text-[#64748b] mb-1">Severity</label>
                <input type="text" id="testSeverity" class="w-full bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#1e293b] focus:outline-none focus:border-[#3b82f6] focus:ring-2 focus:ring-[#3b82f6]/20"
                    placeholder="e.g. critical">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="block text-xs font-medium text-[#64748b] mb-1">Instance</label>
                <input type="text" id="testInstance" class="w-full bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#1e293b] focus:outline-none focus:border-[#3b82f6] focus:ring-2 focus:ring-[#3b82f6]/20"
                    placeholder="e.g. prod-01">
            </div>
            <div class="flex-1 min-w-[120px]">
                <label class="block text-xs font-medium text-[#64748b] mb-1">Job</label>
                <input type="text" id="testJob" class="w-full bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#1e293b] focus:outline-none focus:border-[#3b82f6] focus:ring-2 focus:ring-[#3b82f6]/20"
                    placeholder="e.g. node-exporter">
            </div>
            <button onclick="testRules()" class="px-4 py-2 text-sm font-medium rounded-lg border border-[#e2e8f0] bg-white text-[#475569] hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-play mr-2"></i>Test Rule
            </button>
        </div>

        <div id="testResult" class="hidden mt-4 p-4 rounded-lg border"></div>
    </div>
</div>

<!-- Rule Modal -->
<div id="ruleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card w-full max-w-2xl m-4 max-h-[90vh] flex flex-col">
        <div class="flex items-center justify-between p-6 pb-0 flex-shrink-0">
            <h3 id="modalTitle" class="text-lg font-semibold text-[#1e293b]">New Rule</h3>
            <button onclick="closeModal()" class="text-[#64748b] hover:text-[#1e293b]">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="ruleForm" class="flex-1 min-h-0 flex flex-col">
            <input type="hidden" id="ruleId">
            <div class="flex-1 overflow-y-auto p-6 pt-4 space-y-4 custom-scrollbar">

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">
                            Rule Name
                            <span class="info-tooltip info-tooltip-align-left info-tooltip-bottom">
                                <span class="info-tooltip-icon">?</span>
                                <span class="info-tooltip-text">Descriptive name for this automation rule.</span>
                            </span>
                        </label>
                        <input type="text" id="ruleName" class="input-field w-full px-3 py-2 rounded" required>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium mb-1">
                            Description
                            <span class="info-tooltip info-tooltip-align-left">
                                <span class="info-tooltip-icon">?</span>
                                <span class="info-tooltip-text">Explain the purpose and logic of this rule.</span>
                            </span>
                        </label>
                        <textarea id="ruleDescription" class="input-field w-full px-3 py-2 rounded" rows="2"></textarea>
                    </div>
                </div>

                <div class="border-t border-gray-700 pt-4">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="font-medium text-blue-400">Match Conditions</h4>
                        <div class="flex bg-[#f1f5f9] rounded-lg p-1 text-xs border border-[#e2e8f0]">
                            <button type="button" id="btn-basic" onclick="setMode('basic')"
                                class="px-3 py-1.5 rounded-md bg-white text-[#2563eb] font-medium shadow-sm transition-colors">Basic</button>
                            <button type="button" id="btn-advanced" onclick="setMode('advanced')"
                                class="px-3 py-1.5 rounded-md text-[#64748b] hover:text-[#1e293b] transition-colors">Advanced</button>
                        </div>
                    </div>

                    <!-- Basic Mode -->
                    <div id="mode-basic" class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Alert Name Pattern
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Glob pattern for alert name (e.g., CPU*).</span>
                                </span>
                            </label>
                            <input type="text" id="ruleAlertPattern" class="input-field w-full px-3 py-2 rounded"
                                value="*" placeholder="e.g. CPU*">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Severity Pattern
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Glob pattern for severity (e.g., critical).</span>
                                </span>
                            </label>
                            <input type="text" id="ruleSeverityPattern" class="input-field w-full px-3 py-2 rounded"
                                value="*" placeholder="e.g. critical">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Instance Pattern
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Glob pattern for instance label (e.g.,
                                        prod-*).</span>
                                </span>
                            </label>
                            <input type="text" id="ruleInstancePattern" class="input-field w-full px-3 py-2 rounded"
                                value="*" placeholder="e.g. prod-*">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">
                                Job Pattern
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Glob pattern for job label.</span>
                                </span>
                            </label>
                            <input type="text" id="ruleJobPattern" class="input-field w-full px-3 py-2 rounded"
                                value="*" placeholder="e.g. node-exporter">
                        </div>
                    </div>

                    <!-- Advanced Mode -->
                    <div id="mode-advanced" class="hidden">
                        <label class="block text-sm font-medium mb-1">
                            JSON Logic Condition
                            <span class="info-tooltip info-tooltip-align-left">
                                <span class="info-tooltip-icon">?</span>
                                <span class="info-tooltip-text">Complex logic using JsonLogic syntax.</span>
                            </span>
                        </label>
                        <textarea id="ruleConditionJson" class="input-field w-full px-3 py-2 rounded font-mono text-xs"
                            rows="6"
                            placeholder='{"and": [{"==": [{"var": "severity"}, "critical"]}, {">": [{"var": "value"}, 90]}]}'></textarea>
                        <p class="text-xs text-gray-500 mt-1">Use JsonLogic format for complex conditions.</p>
                    </div>
                </div>

                <div class="border-t border-gray-700 pt-4 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">
                            Priority
                            <span class="info-tooltip info-tooltip-align-left">
                                <span class="info-tooltip-icon">?</span>
                                <span class="info-tooltip-text">Order of evaluation. Lower numbers = higher
                                    priority.</span>
                            </span>
                        </label>
                        <input type="number" id="rulePriority" class="input-field w-full px-3 py-2 rounded" value="100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">
                            Action
                            <span class="info-tooltip info-tooltip-align-left">
                                <span class="info-tooltip-icon">?</span>
                                <span class="info-tooltip-text">What to do when an alert matches this rule.</span>
                            </span>
                        </label>
                        <select id="ruleAction" class="input-field w-full px-3 py-2 rounded">
                            <option value="auto_analyze">Auto Analyze ( remediation )</option>
                            <option value="ignore">Ignore / Suppress</option>
                            <option value="manual">Manual / Notify Only</option>
                        </select>
                    </div>
                </div>

                <div class="pt-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="ruleEnabled"
                            class="form-checkbox text-blue-500 rounded bg-gray-700 border-gray-600" checked>
                        <span class="text-sm">Rule Enabled</span>
                    </label>
                </div>
            </div>

            <div
                class="flex justify-end space-x-2 p-6 border-t border-gray-700 flex-shrink-0 bg-gray-900 bg-opacity-95">
                <button type="button" onclick="closeModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
                <button type="submit" class="btn-primary px-4 py-2 rounded">Save Rule</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary flex items-center gap-2" id="confirmModalTitle">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                Confirm Action
            </h2>
            <button onclick="closeConfirmModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-6" id="confirmModalMessage">Are you sure?</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeConfirmModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
            <button id="confirmModalBtn"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Confirm</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const currentUserRole = "{{ user.role }}";
    let rules = [];
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type) { alert(message); };
    }
    let currentMode = 'basic';

    function setMode(mode) {
        currentMode = mode;
        const basicDiv = document.getElementById('mode-basic');
        const advancedDiv = document.getElementById('mode-advanced');
        const basicBtn = document.getElementById('btn-basic');
        const advancedBtn = document.getElementById('btn-advanced');

        if (mode === 'basic') {
            basicDiv.classList.remove('hidden');
            advancedDiv.classList.add('hidden');
            basicBtn.classList.add('bg-white', 'text-[#2563eb]', 'font-medium', 'shadow-sm');
            basicBtn.classList.remove('text-[#64748b]');
            advancedBtn.classList.remove('bg-white', 'text-[#2563eb]', 'font-medium', 'shadow-sm');
            advancedBtn.classList.add('text-[#64748b]');
        } else {
            basicDiv.classList.add('hidden');
            advancedDiv.classList.remove('hidden');
            advancedBtn.classList.add('bg-white', 'text-[#2563eb]', 'font-medium', 'shadow-sm');
            advancedBtn.classList.remove('text-[#64748b]');
            basicBtn.classList.remove('bg-white', 'text-[#2563eb]', 'font-medium', 'shadow-sm');
            basicBtn.classList.add('text-[#64748b]');
        }
    }

    async function loadRules() {
        try {
            const data = await apiCall('/api/rules');
            if (!data) {
                rules = [];
            } else {
                rules = Array.isArray(data) ? data : (data.rules || data);
            }
            renderRulesTable();
        } catch (error) {
            console.error('Failed to load rules:', error);
            rules = [];
            renderRulesTable();
            showToast('Failed to load rules', 'error');
        }
    }

    function renderRulesTable() {
        const tbody = document.getElementById('rulesTableBody');
        tbody.innerHTML = '';

        if (!rules || rules.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-[#64748b]">
                        <i class="fas fa-list-check text-4xl mb-3 text-[#94a3b8]"></i>
                        <p class="font-medium text-[#475569]">No rules configured</p>
                        <p class="text-sm mt-2">Create a rule to automatically trigger runbooks based on alerts</p>
                    </td>
                </tr>`;
            return;
        }

        rules.forEach(rule => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-[#f8fafc] transition-colors';

            // Format match patterns for display
            let matchDisplay = '';
            if (rule.condition_json) {
                matchDisplay = `<span class="px-2 py-1 rounded text-xs font-medium" style="background:#f5f3ff;color:#6d28d9;border:1px solid #e9d5ff;">JSON Logic</span>`;
            } else {
                const parts = [];
                if (rule.alert_name_pattern !== '*') parts.push(`Alert: ${rule.alert_name_pattern}`);
                if (rule.severity_pattern !== '*') parts.push(`Sev: ${rule.severity_pattern}`);
                if (rule.instance_pattern !== '*') parts.push(`Inst: ${rule.instance_pattern}`);
                if (rule.job_pattern !== '*') parts.push(`Job: ${rule.job_pattern}`);
                matchDisplay = parts.length > 0 ? parts.join(', ') : '<span class="text-[#94a3b8]">Match all</span>';
            }

            const actionClass = rule.action === 'auto_analyze' ? 'rule-action-auto' : rule.action === 'ignore' ? 'rule-action-ignore' : 'rule-action-manual';
            const actionLabel = rule.action === 'auto_analyze' ? 'Auto Analyze' : rule.action === 'ignore' ? 'Ignore' : 'Manual';

            tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="font-medium text-[#1e293b]">${rule.name}</div>
                        <div class="text-sm text-[#64748b]">${rule.description || '-'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-sm font-medium bg-[#f1f5f9] text-[#475569] border border-[#e2e8f0]">${rule.priority}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-[#475569]">
                        ${matchDisplay}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-semibold ${actionClass}">${actionLabel}</span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="toggleRule('${rule.id}')"
                            class="text-xl ${rule.enabled ? 'text-green-600' : 'text-[#94a3b8]'} focus:outline-none hover:opacity-80">
                            <i class="fas ${rule.enabled ? 'fa-toggle-on' : 'fa-toggle-off'}"></i>
                        </button>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openModal('${rule.id}')" class="p-1.5 rounded hover:bg-[#e2e8f0] transition-colors text-blue-500 mr-1">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${currentUserRole === 'admin' ? `
                        <button onclick="deleteRule('${rule.id}')" class="p-1.5 rounded hover:bg-[#fef2f2] transition-colors text-red-500">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                    `;
            tbody.appendChild(tr);
        });
    }

    function openModal(ruleId = null) {
        const modal = document.getElementById('ruleModal');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('ruleForm');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        if (ruleId) {
            const rule = rules.find(r => r.id === ruleId);
            title.textContent = 'Edit Rule';
            document.getElementById('ruleId').value = rule.id;
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleDescription').value = rule.description || '';
            document.getElementById('rulePriority').value = rule.priority;
            document.getElementById('ruleAction').value = rule.action;
            document.getElementById('ruleEnabled').checked = rule.enabled;

            // Check mode
            if (rule.condition_json) {
                setMode('advanced');
                document.getElementById('ruleConditionJson').value = JSON.stringify(rule.condition_json, null, 2);

                // Clear basic fields visually
                document.getElementById('ruleAlertPattern').value = '*';
                document.getElementById('ruleSeverityPattern').value = '*';
                document.getElementById('ruleInstancePattern').value = '*';
                document.getElementById('ruleJobPattern').value = '*';
            } else {
                setMode('basic');
                document.getElementById('ruleAlertPattern').value = rule.alert_name_pattern;
                document.getElementById('ruleSeverityPattern').value = rule.severity_pattern;
                document.getElementById('ruleInstancePattern').value = rule.instance_pattern;
                document.getElementById('ruleJobPattern').value = rule.job_pattern;
                document.getElementById('ruleConditionJson').value = '';
            }
        } else {
            title.textContent = 'New Rule';
            form.reset();
            document.getElementById('ruleId').value = '';
            document.getElementById('rulePriority').value = '100';
            setMode('basic');
        }
    }

    function closeModal() {
        const modal = document.getElementById('ruleModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    document.getElementById('ruleForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const ruleId = document.getElementById('ruleId').value;
        const data = {
            name: document.getElementById('ruleName').value,
            description: document.getElementById('ruleDescription').value,
            priority: parseInt(document.getElementById('rulePriority').value),
            action: document.getElementById('ruleAction').value,
            enabled: document.getElementById('ruleEnabled').checked,
            // Defaults
            alert_name_pattern: "*",
            severity_pattern: "*",
            instance_pattern: "*",
            job_pattern: "*"
        };

        if (currentMode === 'basic') {
            data.alert_name_pattern = document.getElementById('ruleAlertPattern').value;
            data.severity_pattern = document.getElementById('ruleSeverityPattern').value;
            data.instance_pattern = document.getElementById('ruleInstancePattern').value;
            data.job_pattern = document.getElementById('ruleJobPattern').value;
            data.condition_json = null;
        } else {
            // Advanced Mode
            try {
                const jsonStr = document.getElementById('ruleConditionJson').value;
                if (jsonStr && jsonStr.trim() !== '') {
                    data.condition_json = JSON.parse(jsonStr);
                } else {
                    data.condition_json = null;
                }
            } catch (e) {
                showToast('Invalid JSON in condition: ' + e.message, 'error');
                return;
            }
        }

        try {
            const url = ruleId ? `/api/rules/${ruleId}` : '/api/rules';
            const method = ruleId ? 'PUT' : 'POST';

            await apiCall(url, method, data);

            showToast(ruleId ? 'Rule updated' : 'Rule created', 'success');
            closeModal();
            loadRules();

        } catch (error) {
            showToast(error.message, 'error');
        }
    });

    async function toggleRule(ruleId) {
        try {
            await apiCall(`/api/rules/${ruleId}/toggle`, 'POST');
            loadRules();
            showToast('Rule status updated', 'success');
        } catch (error) {
            showToast('Failed to toggle rule', 'error');
        }
    }

    async function deleteRule(ruleId) {
            showConfirmModal(
            'Delete Rule',
            'Are you sure you want to delete this rule? This cannot be undone.',
            'Delete',
            async () => {
                try {
                    await apiCall(`/api/rules/${ruleId}`, 'DELETE');
                    showToast('Rule deleted', 'success');
                    loadRules();
                } catch (error) {
                    showToast('Failed to delete rule', 'error');
                }
            }
        );
    }

    // Confirmation Modal Functions
    let pendingConfirmAction = null;

    function showConfirmModal(title, message, btnText, action) {
        pendingConfirmAction = action;
        document.getElementById('confirmModalTitle').innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i>${title}`;
        document.getElementById('confirmModalMessage').textContent = message;
        document.getElementById('confirmModalBtn').textContent = btnText;
        document.getElementById('confirmModalBtn').onclick = executeConfirmAction;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        pendingConfirmAction = null;
    }

    function executeConfirmAction() {
        if (pendingConfirmAction) {
            pendingConfirmAction();
        }
        closeConfirmModal();
    }

    async function testRules() {
        const data = {
            alert_name: document.getElementById('testAlertName').value,
            severity: document.getElementById('testSeverity').value,
            instance: document.getElementById('testInstance').value,
            job: document.getElementById('testJob').value
        };

        try {
            const result = await apiCall('/api/rules/test', 'POST', data);
            if (!result) return;

            const resultDiv = document.getElementById('testResult');
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-4 p-4 rounded-lg border ' + (result.matched_rule ? 'bg-[#ecfdf5] border-[#a7f3d0] text-[#065f46]' : 'bg-[#f8fafc] border-[#e2e8f0] text-[#475569]');
            resultDiv.innerHTML = `
                <div class="font-medium">${result.message}</div>
                ${result.matched_rule ? `
                <div class="text-sm mt-2 opacity-90">
                    Matched Rule: <strong>${result.matched_rule.name}</strong>
                    (Priority: ${result.matched_rule.priority})
                </div>
                ` : ''}
            `;
        } catch (error) {
            showToast('Test failed', 'error');
        }
    }

    // Close modal handlers
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    document.getElementById('ruleModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal();
    });

    // Initial load
    loadRules();
</script>
{% endblock %}