{% extends "base.html" %}
{% set active_page = 'dashboards' %}

{% block title %}Dashboard View - AIOps Platform (v6){% endblock %}

{% block head %}
<!-- GridStack CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: #181b1f;
        border: 1px solid rgba(204, 204, 220, 0.12);
        border-radius: 0.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        /* Force 16px gap (8px on each side) */
        top: 8px !important;
        right: 8px !important;
        bottom: 8px !important;
        left: 8px !important;
        width: auto !important;
        height: auto !important;
        /* Enterprise Polish */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease-in-out;
    }

    .grid-stack-item-content:hover {
        border-color: rgba(204, 204, 220, 0.25);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
    }

    /* Enforce GridStack gaps using CSS variables (GridStack v8+) */
    .grid-stack {
        --gs-column-gap: 16px;
        --gs-row-gap: 16px;
        background: transparent;
        /* Visual debug: encourage transparency */
    }



    .panel-row-section {
        margin-bottom: 1.5rem;
    }

    .panel-drag-handle {
        cursor: move;
        padding: 0.75rem 1rem;
        background: #22252b;
        border-bottom: 1px solid rgba(204, 204, 220, 0.12);
        display: none;
        align-items: center;
        justify-content: space-between;
    }

    .panel-drag-handle:hover {
        background: #2a2d34;
    }

    .grid-stack-item.editing .panel-drag-handle {
        display: flex;
    }

    .edit-mode-active .grid-stack {
        border: 2px dashed #3b82f6;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .panel-content {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .panel-chart-container {
        flex: 1;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .panel-actions {
        display: flex;
        gap: 0.5rem;
    }

    .panel-actions button {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .panel-actions button:hover {
        transform: scale(1.1);
    }

    /* Kiosk Mode Styles */
    .kiosk-mode .dashboard-header,
    .kiosk-mode #variables-container,
    .kiosk-mode #sidebar,
    .kiosk-mode .sidebar,
    .kiosk-mode aside {
        display: none !important;
    }

    .kiosk-mode .grid-stack {
        margin-top: 0 !important;
    }

    /* Expand content to full width in kiosk mode */
    .kiosk-mode #main-content,
    .kiosk-mode main {
        margin-left: 0 !important;
        padding: 1rem !important;
    }

    /* Kiosk mode exit button - always visible */
    #kiosk-exit-btn {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 1000;
        opacity: 0.3;
        transition: opacity 0.2s;
    }

    #kiosk-exit-btn:hover {
        opacity: 1;
    }

    body:not(.kiosk-mode) #kiosk-exit-btn {
        display: none;
    }

    /* Panel Row Headers - Grafana Style */
    .panel-row-header {
        background: transparent;
        border-top: 1px solid rgba(204, 204, 220, 0.12);
        border-bottom: 1px solid rgba(204, 204, 220, 0.12);
        border-left: none;
        border-right: none;
        border-radius: 0;
        padding: 0.5rem 0.25rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .panel-row-header:hover {
        background: rgba(204, 204, 220, 0.05);
    }

    .panel-row-header .row-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        color: #ccccdc;
    }

    .panel-row-header .row-title i.fa-layer-group {
        color: #8e8e8e;
    }

    .panel-row-header .row-toggle {
        transition: transform 0.3s ease;
        font-size: 0.75rem;
        color: #8e8e8e;
    }

    .panel-row-header.collapsed .row-toggle {
        transform: rotate(-90deg);
    }

    .panel-row-content {
        transition: max-height 0.3s ease, opacity 0.2s ease;
        overflow: hidden;
    }

    .panel-row-content.collapsed {
        max-height: 0 !important;
        opacity: 0;
        margin-bottom: 0;
    }

    .panel-row-section {
        margin-bottom: 1rem;
    }

    .panel-row-badge {
        background: rgba(204, 204, 220, 0.1);
        color: #8e8e8e;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 400;
    }

    /* Grafana-style Toolbar Buttons */
    .toolbar-btn {
        color: #ccccdc;
        /* Grafana text color */
        transition: all 0.15s ease;
        border-radius: 4px;
        /* Grafana uses 4px */
    }

    .toolbar-btn:hover {
        color: #ffffff;
        background: #22252b;
        /* Grafana tertiary background */
    }

    .toolbar-btn:active {
        transform: scale(0.95);
    }

    .toolbar-btn i {
        font-size: 0.875rem;
    }

    /* Toolbar divider */
    .toolbar-divider {
        width: 1px;
        height: 24px;
        background: rgba(204, 204, 220, 0.12);
        /* Grafana border color */
        margin: 0 4px;
    }

    /* Query editor textarea styling */
    #query-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        background-color: #111217;
        /* Grafana primary bg */
        color: #ccccdc;
        /* Grafana text color */
        border: 1px solid rgba(204, 204, 220, 0.2);
        border-radius: 4px;
    }

    #query-editor:focus {
        border-color: #3d71d9;
        /* Grafana blue */
        outline: none;
    }

    /* Empty State Styling */
    .empty-state-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        text-align: center;
        border: 2px dashed rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin: 2rem;
        background: rgba(255, 255, 255, 0.02);
    }

    .empty-state-icon {
        font-size: 3rem;
        color: #3b82f6;
        margin-bottom: 1.5rem;
        opacity: 0.8;
    }

    /* Skeleton Loading Animation */
    .skeleton {
        background: linear-gradient(90deg, #22252b 25%, #2a2d34 50%, #22252b 75%);
        background-size: 200% 100%;
        animation: skeleton-loading 1.5s infinite;
        border-radius: 4px;
    }

    @keyframes skeleton-loading {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Grafana-style Toolbar -->
    <!-- Grafana-style Toolbar -->
    <div class="dashboard-header"
        style="padding: 12px; background: #16171b; border-bottom: 1px solid rgba(255,255,255,0.05);">
        <div class="flex items-center justify-between gap-4">
            <!-- Left: Breadcrumbs & Title -->
            <div class="flex flex-col min-w-0">
                <!-- Breadcrumbs -->
                <nav class="flex items-center text-xs text-gray-400 mb-1">
                    <a href="/" class="hover:text-blue-400 transition-colors">Home</a>
                    <span class="mx-2">/</span>
                    <a href="/dashboards" class="hover:text-blue-400 transition-colors">Dashboards</a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-200">Operations</span>
                </nav>
                <div class="flex items-center gap-3">
                    <h1 id="dashboard-title" class="text-xl font-bold text-white tracking-tight truncate">Loading...
                    </h1>
                    <span id="dashboard-description"
                        class="hidden px-2 py-0.5 rounded text-[10px] bg-gray-800 text-gray-400 border border-gray-700 truncate max-w-[200px]"></span>
                </div>
            </div>

            <!-- Right: Toolbar Actions -->
            <div class="flex items-center gap-2">

                <!-- Primary Actions Group -->
                <div class="flex items-center bg-gray-800 rounded-lg p-1 border border-gray-700">
                    <!-- Time Range -->
                    <button onclick="showTimePickerModal()"
                        class="toolbar-btn px-3 py-1.5 rounded text-sm hover:bg-gray-700 transition-colors flex items-center gap-2 text-gray-300">
                        <i class="fas fa-clock text-blue-400 text-xs"></i>
                        <span id="time-range-display">Last 24h</span>
                        <i class="fas fa-chevron-down text-[10px] text-gray-500"></i>
                    </button>

                    <div class="w-px h-5 bg-gray-600 mx-1"></div>

                    <!-- Refresh -->
                    <button id="refresh-btn" onclick="refreshAllPanels()"
                        class="toolbar-btn px-2 py-1.5 rounded hover:bg-gray-700 transition-colors flex items-center gap-2"
                        title="Refresh Data">
                        <i class="fas fa-sync-alt text-green-400 text-sm"></i>
                        <span id="refresh-countdown" class="text-xs text-gray-400 hidden"></span>
                    </button>
                </div>

                <!-- Editor Actions -->
                <button id="edit-mode-btn" onclick="toggleEditMode()"
                    class="toolbar-btn px-3 py-1.5 rounded border border-gray-600 hover:border-blue-400 hover:text-blue-400 text-sm transition-all flex items-center gap-2"
                    title="Edit Layout">
                    <i class="fas fa-pen text-xs"></i>
                    <span id="edit-mode-text" class="hidden sm:inline">Edit</span>
                </button>

                <!-- Save/Cancel (Hidden by default) -->
                <button id="save-layout-btn" onclick="saveLayoutChanges()"
                    class="hidden btn-primary px-3 py-1.5 text-sm flex items-center gap-2">
                    <i class="fas fa-save"></i> Save
                </button>
                <button id="cancel-edit-btn" onclick="cancelEditMode()"
                    class="hidden btn-secondary px-3 py-1.5 text-sm">
                    Cancel
                </button>

                <!-- More Actions Dropdown -->
                <div class="relative ml-2" id="more-actions-container">
                    <button onclick="toggleMoreActions()"
                        class="toolbar-btn p-2 rounded hover:bg-gray-700 transition-colors text-gray-400">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="more-actions-menu"
                        class="hidden absolute right-0 mt-2 w-56 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 py-1">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Dashboard
                        </div>

                        <button onclick="showRowsModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-layer-group text-indigo-400 w-4"></i> Manage Rows
                        </button>
                        <button onclick="showVariablesModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-sliders-h text-purple-400 w-4"></i> Variables
                        </button>
                        <button onclick="showAnnotationsModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-bookmark text-yellow-400 w-4"></i> Annotations
                        </button>
                        <button onclick="showAlertsModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <div class="relative">
                                <i class="fas fa-bell text-red-400 w-4"></i>
                                <span id="alerts-badge"
                                    class="hidden absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-2 h-2"></span>
                            </div>
                            Alerts
                        </button>

                        <!-- Links Section (Restored for JS compatibility) -->
                        <div id="links-dropdown" class="block">
                            <div class="border-t border-gray-700 my-1"></div>
                            <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Links
                            </div>
                            <div id="links-list"></div>
                        </div>

                        <div class="border-t border-gray-700 my-1"></div>
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions
                        </div>

                        <button onclick="showSnapshotModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-camera text-gray-400 w-4"></i> Snapshot
                        </button>
                        <button onclick="exportDashboard()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-download text-gray-400 w-4"></i> Export JSON
                        </button>
                        <button onclick="showImportModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-upload text-gray-400 w-4"></i> Import JSON
                        </button>

                        <div class="border-t border-gray-700 my-1"></div>

                        <button onclick="toggleKioskMode()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-tv text-orange-400 w-4"></i> Kiosk Mode
                        </button>

                        <!-- Settings Items Flattened -->
                        <button onclick="showShareModal()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-share-alt text-blue-400 w-4"></i> Share
                        </button>
                        <button onclick="duplicateDashboard()"
                            class="w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white flex items-center gap-3">
                            <i class="fas fa-copy text-green-400 w-4"></i> Duplicate
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Dashboard Variables -->
<div id="variables-container" class="hidden">
    <div class="rounded-lg p-4 mb-6 shadow-sm" style="background-color: #181b1f; border: 1px solid #2d2d31;">
        <div class="flex items-center gap-4 flex-wrap" id="variables-list">
            <!-- Variables will be populated here -->
        </div>
    </div>
</div>

<!-- Dashboard Loading State -->
<div id="loading-state" class="flex items-center justify-center py-20">
    <div class="text-center">
        <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
        <p class="text-gray-400">Loading dashboard...</p>
    </div>
</div>

<!-- Dashboard Error State -->
<div id="error-state" class="hidden">
    <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-6 text-center">
        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
        <h3 class="text-lg font-semibold text-red-300 mb-2">Failed to load dashboard</h3>
        <p id="error-message" class="text-red-200/70 mb-4"></p>
        <button onclick="loadDashboard()" class="btn-primary px-4 py-2 rounded-lg">
            <i class="fas fa-redo mr-2"></i>
            Retry
        </button>
    </div>
</div>

<!-- Empty State -->
<div id="empty-state" class="hidden">
    <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-10 text-center">
        <i class="fas fa-chart-bar text-5xl text-gray-600 mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-300 mb-2">No panels in this dashboard</h3>
        <p class="text-gray-500 mb-6">Add some panels to visualize your metrics.</p>
        <a href="/dashboards" class="btn-primary px-6 py-2 rounded-lg">
            <i class="fas fa-plus mr-2"></i>
            Add Panels
        </a>
    </div>
</div>

<!-- GridStack Container with Row Support -->
<div id="panels-container" class="hidden">
    <div id="rows-container">
        <!-- Row sections will be dynamically added here -->
    </div>
    <!-- Ungrouped panels grid -->
    <div id="ungrouped-section">
        <div class="grid-stack" id="grid-ungrouped"></div>
    </div>
</div>
</div>

<!-- Variables Management Modal -->
<div id="variables-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Dashboard Variables</h2>
            <button onclick="closeVariablesModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Variables List -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Variables</h3>
                <button onclick="showVariableEditor()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Add Variable
                </button>
            </div>

            <div id="variables-table" class="bg-gray-900 rounded-lg overflow-hidden">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Variable Editor Modal -->
<div id="variable-editor-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="variable-editor-title" class="text-xl font-bold text-white">New Variable</h2>
            <button onclick="closeVariableEditor()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="variable-form" onsubmit="saveVariable(event)">
            <input type="hidden" id="variable-id">

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Variable Name *</label>
                        <input type="text" id="variable-name" required placeholder="e.g., instance, job"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Used as $name in queries</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Label</label>
                        <input type="text" id="variable-label" placeholder="Display name"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Type *</label>
                    <select id="variable-type" onchange="handleVariableTypeChange()"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="query">Query - Values from Prometheus query</option>
                        <option value="custom">Custom - Manual list of values</option>
                        <option value="constant">Constant - Single fixed value</option>
                        <option value="textbox">Textbox - Free text input</option>
                        <option value="interval">Interval - Time intervals</option>
                    </select>
                </div>

                <!-- Query Type Fields -->
                <div id="query-fields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Datasource *</label>
                        <select id="variable-datasource"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Query *</label>
                        <textarea id="variable-query" rows="3" placeholder="label_values(instance)"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">PromQL query to get variable values</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Regex Filter</label>
                        <input type="text" id="variable-regex" placeholder="/.*prod.*/"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Optional regex to filter results</p>
                    </div>
                </div>

                <!-- Custom Type Fields -->
                <div id="custom-fields" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Values *</label>
                    <textarea id="variable-custom-values" rows="3" placeholder="value1&#10;value2&#10;value3"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">One value per line</p>
                </div>

                <!-- Constant/Textbox Type Fields -->
                <div id="default-value-field">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Default Value</label>
                    <input type="text" id="variable-default-value"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="variable-multi-select" class="mr-2">
                        Multi-select
                    </label>
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="variable-include-all" onchange="handleIncludeAllChange()"
                            class="mr-2">
                        Include "All" option
                    </label>
                </div>

                <div id="all-value-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-1">All Value</label>
                    <input type="text" id="variable-all-value" value=".*" placeholder=".*"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Value to use when "All" is selected (e.g., .* for regex)</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Hide</label>
                        <select id="variable-hide"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="0">Visible</option>
                            <option value="1">Label only</option>
                            <option value="2">Hidden</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Sort Order</label>
                        <input type="number" id="variable-sort" value="0" min="0"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeVariableEditor()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    <i class="fas fa-save mr-2"></i>
                    Save Variable
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Time Picker Modal -->
<div id="time-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Time Range</h2>
            <button onclick="closeTimePickerModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Quick Ranges -->
            <div class="col-span-1">
                <h3 class="text-sm font-semibold text-gray-300 mb-3">Quick Ranges</h3>
                <div class="space-y-1">
                    <button onclick="selectQuickRange('5m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        5 minutes</button>
                    <button onclick="selectQuickRange('15m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        15 minutes</button>
                    <button onclick="selectQuickRange('30m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        30 minutes</button>
                    <button onclick="selectQuickRange('1h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        1 hour</button>
                    <button onclick="selectQuickRange('3h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        3 hours</button>
                    <button onclick="selectQuickRange('6h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        6 hours</button>
                    <button onclick="selectQuickRange('12h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        12 hours</button>
                    <button onclick="selectQuickRange('24h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors bg-gray-700">Last
                        24 hours</button>
                    <button onclick="selectQuickRange('2d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        2 days</button>
                    <button onclick="selectQuickRange('7d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        7 days</button>
                    <button onclick="selectQuickRange('30d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        30 days</button>
                    <button onclick="selectQuickRange('90d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        90 days</button>
                </div>
            </div>

            <!-- Absolute/Relative Time -->
            <div class="col-span-2">
                <div class="mb-4">
                    <div class="flex gap-2 mb-4">
                        <button id="tab-relative" onclick="switchTimeTab('relative')"
                            class="px-4 py-2 rounded bg-blue-600 text-white text-sm">Relative</button>
                        <button id="tab-absolute" onclick="switchTimeTab('absolute')"
                            class="px-4 py-2 rounded bg-gray-700 text-gray-300 text-sm">Absolute</button>
                    </div>
                </div>

                <!-- Relative Time Range -->
                <div id="relative-time-panel" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">From</label>
                        <input type="text" id="relative-from" value="now-24h" placeholder="now-24h"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Examples: now-1h, now-24h, now-7d</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">To</label>
                        <input type="text" id="relative-to" value="now" placeholder="now"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Examples: now, now-1h</p>
                    </div>
                </div>

                <!-- Absolute Time Range -->
                <div id="absolute-time-panel" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">From</label>
                        <input type="datetime-local" id="absolute-from"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">To</label>
                        <input type="datetime-local" id="absolute-to"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <!-- Refresh Interval -->
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Auto Refresh</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectRefreshInterval(0)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">Off</button>
                        <button onclick="selectRefreshInterval(5)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">5s</button>
                        <button onclick="selectRefreshInterval(10)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">10s</button>
                        <button onclick="selectRefreshInterval(30)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">30s</button>
                        <button onclick="selectRefreshInterval(60)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">1m</button>
                        <button onclick="selectRefreshInterval(300)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">5m</button>
                    </div>
                    <div class="mt-2">
                        <input type="number" id="custom-refresh-interval" placeholder="Custom (seconds)" min="1"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeTimePickerModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                Cancel
            </button>
            <button onclick="applyTimeRange()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                <i class="fas fa-check mr-2"></i>
                Apply
            </button>
        </div>
    </div>
</div>

<!-- Panel Inspector Modal -->
<div id="panel-inspector-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
            <h2 class="text-xl font-bold text-white">
                <i class="fas fa-search text-purple-400 mr-2"></i>
                Panel Inspector
                <span id="inspector-panel-name" class="text-gray-400 text-sm ml-2"></span>
            </h2>
            <button onclick="closeInspectorModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Inspector Tabs -->
        <div class="flex gap-2 mb-4 border-b border-gray-700 flex-shrink-0">
            <button id="inspector-tab-query" onclick="switchInspectorTab('query')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400">
                <i class="fas fa-code mr-1"></i> Query
            </button>
            <button id="inspector-tab-stats" onclick="switchInspectorTab('stats')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-chart-bar mr-1"></i> Stats
            </button>
            <button id="inspector-tab-json" onclick="switchInspectorTab('json')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-file-code mr-1"></i> JSON
            </button>
            <button id="inspector-tab-data" onclick="switchInspectorTab('data')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-table mr-1"></i> Data
            </button>
        </div>

        <!-- Inspector Panels -->
        <div class="flex-1 overflow-auto">
            <!-- Query Panel -->
            <div id="inspector-panel-query" class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-300">Original Query</h3>
                        <button onclick="copyToClipboard('inspector-original-query')"
                            class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <pre id="inspector-original-query"
                        class="bg-gray-900 p-4 rounded text-sm text-gray-300 font-mono overflow-x-auto"></pre>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-300">Executed Query (with variables)</h3>
                        <button onclick="copyToClipboard('inspector-executed-query')"
                            class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <pre id="inspector-executed-query"
                        class="bg-gray-900 p-4 rounded text-sm text-green-400 font-mono overflow-x-auto"></pre>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Time Range</h3>
                    <div class="bg-gray-900 p-4 rounded text-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-500">From:</span>
                                <span id="inspector-time-from" class="text-gray-300 ml-2"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">To:</span>
                                <span id="inspector-time-to" class="text-gray-300 ml-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div id="inspector-panel-stats" class="hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Execution Time</div>
                        <div id="inspector-exec-time" class="text-2xl font-bold text-blue-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Data Points</div>
                        <div id="inspector-data-points" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Series Count</div>
                        <div id="inspector-series-count" class="text-2xl font-bold text-purple-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Response Size</div>
                        <div id="inspector-response-size" class="text-2xl font-bold text-orange-400">-</div>
                    </div>
                </div>
                <div class="mt-4 bg-gray-900 p-4 rounded">
                    <h3 class="text-sm font-semibold text-gray-300 mb-3">Series Details</h3>
                    <div id="inspector-series-details" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- JSON Panel -->
            <div id="inspector-panel-json" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-300">Raw Response</h3>
                    <button onclick="copyToClipboard('inspector-json-content')"
                        class="text-xs text-blue-400 hover:text-blue-300">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                </div>
                <pre id="inspector-json-content"
                    class="bg-gray-900 p-4 rounded text-xs text-gray-300 font-mono overflow-auto max-h-[600px]"></pre>
            </div>

            <!-- Data Panel -->
            <div id="inspector-panel-data" class="hidden overflow-auto">
                <div id="inspector-data-table" class="bg-gray-900 rounded overflow-auto"></div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Modal -->
<div id="alerts-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-5xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
            <h2 class="text-xl font-bold text-white">
                <i class="fas fa-bell text-red-400 mr-2"></i>
                Prometheus Alerts
            </h2>
            <button onclick="closeAlertsModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Alert Stats -->
        <div class="grid grid-cols-3 gap-4 mb-6 flex-shrink-0">
            <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4">
                <div class="text-xs text-red-300 mb-1">Firing</div>
                <div id="alert-count-firing" class="text-3xl font-bold text-red-400">0</div>
            </div>
            <div class="bg-yellow-900/30 border border-yellow-700/50 rounded-lg p-4">
                <div class="text-xs text-yellow-300 mb-1">Pending</div>
                <div id="alert-count-pending" class="text-3xl font-bold text-yellow-400">0</div>
            </div>
            <div class="bg-gray-700/30 border border-gray-600/50 rounded-lg p-4">
                <div class="text-xs text-gray-300 mb-1">Silenced</div>
                <div id="alert-count-silenced" class="text-3xl font-bold text-gray-400">0</div>
            </div>
        </div>

        <!-- Filter and Search -->
        <div class="flex gap-3 mb-4 flex-shrink-0">
            <input type="text" id="alert-search" placeholder="Search alerts..." onkeyup="filterAlerts()"
                class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
            <select id="alert-status-filter" onchange="filterAlerts()"
                class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                <option value="all">All States</option>
                <option value="firing">Firing</option>
                <option value="pending">Pending</option>
                <option value="silenced">Silenced</option>
            </select>
        </div>

        <!-- Alerts List -->
        <div class="flex-1 overflow-auto">
            <div id="alerts-list" class="space-y-2">
                <!-- Will be populated by JavaScript -->
            </div>
            <div id="alerts-empty" class="hidden p-8 text-center text-gray-400">
                <i class="fas fa-check-circle text-5xl text-green-400 mb-3"></i>
                <p class="text-lg">No active alerts</p>
                <p class="text-sm mt-1">All systems operational</p>
            </div>
            <div id="alerts-loading" class="p-8 text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-blue-400 mb-3"></i>
                <p class="text-gray-400">Loading alerts...</p>
            </div>
            <div id="alerts-error" class="hidden p-8 text-center">
                <i class="fas fa-exclamation-triangle text-3xl text-red-400 mb-3"></i>
                <p class="text-red-300" id="alerts-error-message">Failed to load alerts</p>
            </div>
        </div>
    </div>
</div>

<!-- Annotations Modal -->
<div id="annotations-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
        <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-bookmark text-indigo-400"></i>
                    Dashboard Annotations
                </h2>
                <button onclick="hideAnnotationsModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <button onclick="showCreateAnnotationForm()" class="btn-primary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-plus mr-2"></i>
                Create Annotation
            </button>
        </div>

        <div class="p-6">
            <!-- Create/Edit Annotation Form -->
            <div id="annotation-form" class="hidden mb-6 bg-gray-700 rounded-lg p-6">
                <h3 class="text-lg font-bold mb-4" id="annotation-form-title">Create Annotation</h3>
                <form id="annotation-form-element" onsubmit="saveAnnotation(event)">
                    <input type="hidden" id="annotation-id" value="">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Title</label>
                            <input type="text" id="annotation-title"
                                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                                placeholder="Optional title">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Time *</label>
                            <input type="datetime-local" id="annotation-time" required
                                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">End Time (Optional)</label>
                            <input type="datetime-local" id="annotation-time-end"
                                class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Color</label>
                            <input type="color" id="annotation-color" value="#FF6B6B"
                                class="w-full h-10 bg-gray-600 border border-gray-500 rounded px-3 py-2">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Description *</label>
                        <textarea id="annotation-text" required rows="3"
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                            placeholder="Describe the event (e.g., deployment, incident, maintenance)"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Tags (comma-separated)</label>
                        <input type="text" id="annotation-tags"
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                            placeholder="deployment, production, backend">
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                            <i class="fas fa-save mr-2"></i>
                            Save Annotation
                        </button>
                        <button type="button" onclick="hideAnnotationForm()" class="btn-secondary px-4 py-2 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Annotations List -->
            <div id="annotations-list" class="space-y-3">
                <!-- Annotations will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="annotations-empty" class="hidden p-8 text-center">
                <i class="fas fa-bookmark text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">No annotations yet</p>
                <p class="text-gray-500 text-sm mt-2">Create annotations to mark important events on your dashboards</p>
            </div>

            <!-- Loading State -->
            <div id="annotations-loading" class="hidden p-8 text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400 mb-3"></i>
                <p class="text-gray-400">Loading annotations...</p>
            </div>
        </div>
    </div>
</div>

<!-- Import Dashboard Modal -->
<div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg w-full max-w-2xl m-4">
        <div class="border-b border-gray-700 p-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-upload text-indigo-400"></i>
                    Import Dashboard
                </h2>
                <button onclick="hideImportModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Upload JSON File</label>
                <input type="file" id="import-file" accept=".json"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-indigo-600 file:text-white hover:file:bg-indigo-500">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Or Paste JSON</label>
                <textarea id="import-json" rows="10"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm"
                    placeholder='{"dashboard": {...}, "panels": [...], "variables": [...]}'>
</textarea>
            </div>

            <div id="import-error"
                class="hidden mb-4 p-4 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm"></div>
            <div id="import-success"
                class="hidden mb-4 p-4 bg-green-900/30 border border-green-700 rounded text-green-300 text-sm"></div>

            <div class="flex gap-2">
                <button onclick="importDashboard()" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-upload mr-2"></i>
                    Import Dashboard
                </button>
                <button onclick="hideImportModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Kiosk Mode Exit Button -->
<button id="kiosk-exit-btn" onclick="toggleKioskMode()"
    class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg border border-gray-600">
    <i class="fas fa-times mr-2"></i>
    Exit Kiosk Mode
</button>

<!-- Create/Edit Panel Modal -->
<div id="panel-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-start justify-center z-50 overflow-y-auto py-8">
    <div class="bg-gray-800 rounded-lg p-6 my-auto" style="width: 80vw; max-height: 85vh; overflow-y: auto;">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-white">Create Panel</h2>
            <button onclick="closePanelModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="panel-form" onsubmit="savePanel(event)">
            <input type="hidden" id="panel-id">

            <div class="grid grid-cols-2 gap-4">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Name *</label>
                        <input type="text" id="panel-name" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                        <textarea id="panel-description" rows="2"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Datasource *</label>
                        <select id="panel-datasource" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Type</label>
                        <select id="panel-type"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <optgroup label="Time Series">
                                <option value="graph">Line Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="stacked_area">Stacked Area</option>
                                <option value="bar">Bar Chart</option>
                                <option value="stacked_bar">Stacked Bar</option>
                            </optgroup>
                            <optgroup label="Single Value">
                                <option value="stat">Stat (Big Number)</option>
                                <option value="gauge">Gauge</option>
                                <option value="sparkline">Sparkline</option>
                            </optgroup>
                            <optgroup label="Distribution">
                                <option value="pie">Pie Chart</option>
                                <option value="doughnut">Doughnut Chart</option>
                                <option value="heatmap">Heatmap</option>
                            </optgroup>
                            <optgroup label="Data">
                                <option value="table">Table</option>
                            </optgroup>
                        </select>
                    </div>


                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Time Range</label>
                            <select id="panel-time-range"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="3h">3 hours</option>
                                <option value="6h">6 hours</option>
                                <option value="12h">12 hours</option>
                                <option value="24h" selected>24 hours</option>
                                <option value="7d">7 days</option>
                                <option value="30d">30 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Refresh (s)</label>
                            <input type="number" id="panel-refresh" value="30" min="5" max="3600"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-template" class="mr-2">
                            Save as Template
                        </label>
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-public" class="mr-2">
                            Public
                        </label>
                    </div>
                </div>

                <!-- Right Column - Query Editor -->
                <div class="space-y-4">
                    <!-- Query Examples -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Query Examples</label>
                        <select id="query-examples" onchange="loadQueryExample()"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select an example...</option>
                            <option value="cpu">CPU Usage (%)</option>
                            <option value="memory">Memory Usage (GB)</option>
                            <option value="disk">Disk Usage (%)</option>
                            <option value="network_rx">Network Received (MB/s)</option>
                            <option value="network_tx">Network Transmitted (MB/s)</option>
                            <option value="http_rate">HTTP Request Rate</option>
                            <option value="http_errors">HTTP Error Rate (%)</option>
                            <option value="http_latency">HTTP Request Duration p95</option>
                            <option value="alerts">Active Alerts</option>
                            <option value="up">Target Up/Down</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-300">PromQL Query *</label>
                            <button type="button" onclick="testQuery()"
                                class="text-blue-400 hover:text-blue-300 text-sm">
                                Test Query
                            </button>
                        </div>
                        <textarea id="query-editor" rows="8" required
                            placeholder="Example: rate(http_requests_total[5m])"
                            class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                        <p class="text-xs text-gray-400 mt-1">Enter your PromQL query or select an example above</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Legend Format</label>
                        <input type="text" id="panel-legend" placeholder="{{instance}}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-400 mt-1">Use {{label_name}} for label values</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Tags (comma-separated)</label>
                        <input type="text" id="panel-tags" placeholder="infrastructure, cpu, monitoring"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Query Preview Section - Full Width (outside the 2-column grid) -->
            <div id="query-result" class="hidden mt-6 border-t border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-white mb-4">Query Preview</h3>
                <div id="query-status" class="p-3 rounded text-sm mb-4"></div>
                <div id="query-preview-chart" class="hidden bg-gray-900 rounded-lg p-4 mb-4"
                    style="height: 280px; width: 100%;"></div>
                <div id="query-data-preview" class="hidden bg-gray-900 rounded-lg p-4 max-h-48 overflow-auto">
                    <div class="text-xs text-gray-400 mb-2 font-medium">Raw Data (first 3 series):</div>
                    <pre id="query-data-json" class="text-xs text-green-400 font-mono whitespace-pre-wrap"></pre>
                </div>
            </div>

            <!-- Advanced Chart Configuration -->
            <div class="mt-6 border-t border-gray-700 pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">Chart Configuration</h3>
                    <button type="button" onclick="toggleChartConfig()"
                        class="text-sm text-blue-400 hover:text-blue-300">
                        <i id="chart-config-icon" class="fas fa-chevron-down"></i>
                        <span id="chart-config-text">Show</span>
                    </button>
                </div>

                <div id="chart-config-section" class="hidden space-y-4">
                    <!-- Y-Axis Configuration -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Y-Axis</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Min Value</label>
                                <input type="number" id="y-axis-min" step="any" placeholder="Auto"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Max Value</label>
                                <input type="number" id="y-axis-max" step="any" placeholder="Auto"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Label</label>
                                <input type="text" id="y-axis-label" placeholder="Value"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Units & Formatting -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Units & Formatting</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Unit Format</label>
                                <select id="unit-format"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="">None (Number)</option>
                                    <option value="percent">Percent (%)</option>
                                    <option value="bytes">Bytes (B, KB, MB, GB)</option>
                                    <option value="seconds">Time (s, m, h, d)</option>
                                    <option value="milliseconds">Milliseconds (ms)</option>
                                    <option value="requests">Requests/sec</option>
                                    <option value="ops">Ops/sec</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Decimals</label>
                                <input type="number" id="decimals" min="0" max="5" value="2"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Color Scheme -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Colors</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Color Scheme</label>
                                <select id="color-scheme"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="default">Default (Blue)</option>
                                    <option value="green">Green</option>
                                    <option value="red">Red</option>
                                    <option value="purple">Purple</option>
                                    <option value="rainbow">Rainbow (Multi-color)</option>
                                    <option value="cool">Cool (Blue-Green)</option>
                                    <option value="warm">Warm (Orange-Red)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-gray-300 text-sm">
                                    <input type="checkbox" id="use-gradient" class="mr-2">
                                    Use Gradient Fill
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Thresholds -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-gray-300">Thresholds</h4>
                            <button type="button" onclick="addThreshold()"
                                class="text-xs text-green-400 hover:text-green-300">
                                <i class="fas fa-plus mr-1"></i>Add Threshold
                            </button>
                        </div>
                        <div id="thresholds-container" class="space-y-2">
                            <!-- Thresholds will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Legend</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Position</label>
                                <select id="legend-position"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="bottom">Bottom</option>
                                    <option value="top">Top</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-gray-300 text-sm">
                                    <input type="checkbox" id="show-legend" checked class="mr-2">
                                    Show Legend
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closePanelModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    Save Panel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- GridStack JS -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- Panel Editor Shared JS -->
<script src="/static/js/panel-editor.js"></script>

<script>
    const dashboardId = '{{ dashboard_id }}';
    let dashboard = null;
    let panels = [];
    let charts = {};
    let refreshInterval = null;
    let grid = null;
    let grids = {}; // Store multiple GridStack instances for rows
    let editMode = false;
    let variables = [];
    let variableValues = {}; // Store selected values for each variable
    let panelRows = []; // Store panel rows for grouping

    // Settings menu replaced by "More Actions"


    // More Actions Menu Toggle
    function toggleMoreActions() {
        const menu = document.getElementById('more-actions-menu');
        menu.classList.toggle('hidden');
    }

    // Close More Actions menu when clicking outside
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('more-actions-menu');
        const btn = e.target.closest('[onclick="toggleMoreActions()"]');
        if (menu && !menu.classList.contains('hidden') && !btn && !menu.contains(e.target)) {
            menu.classList.add('hidden');
        }
    });

    // Links dropdown toggle
    function toggleLinksDropdown() {
        const menu = document.getElementById('links-menu');
        menu.classList.toggle('hidden');
    }

    // Edit Mode Functions
    let originalLayoutState = null; // Store original layout for cancel functionality

    function toggleEditMode() {
        editMode = !editMode;
        const editBtn = document.getElementById('edit-mode-btn');
        const editText = document.getElementById('edit-mode-text');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const saveBtn = document.getElementById('save-layout-btn');

        if (editMode) {
            // Entering edit mode - save current state for potential cancel
            originalLayoutState = saveCurrentLayoutState();

            editBtn.classList.add('bg-blue-600', 'border-blue-500');
            editText.textContent = 'Editing';
            cancelBtn.classList.remove('hidden');
            saveBtn.classList.remove('hidden');

            // Enable grid dragging and resizing
            Object.values(grids).forEach(g => {
                if (g) {
                    g.enable();
                }
            });

            // Add 'editing' class to all grid items to show action buttons
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                item.classList.add('editing');
            });

            showToast('Edit mode enabled. Drag panels to rearrange.', 'info');
        } else {
            exitEditMode();
        }
    }

    function exitEditMode() {
        editMode = false;
        const editBtn = document.getElementById('edit-mode-btn');
        const editText = document.getElementById('edit-mode-text');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const saveBtn = document.getElementById('save-layout-btn');

        editBtn.classList.remove('bg-blue-600', 'border-blue-500');
        editText.textContent = 'Edit';
        cancelBtn.classList.add('hidden');
        saveBtn.classList.add('hidden');

        // Disable grid dragging and resizing
        Object.values(grids).forEach(g => {
            if (g) {
                g.disable();
            }
        });

        // Remove 'editing' class from all grid items to hide action buttons
        document.querySelectorAll('.grid-stack-item').forEach(item => {
            item.classList.remove('editing');
        });

        originalLayoutState = null;
    }

    function cancelEditMode() {
        if (originalLayoutState) {
            // Restore original layout
            restoreLayoutState(originalLayoutState);
            showToast('Layout changes cancelled', 'info');
        }
        exitEditMode();
    }

    async function saveLayoutChanges() {
        try {
            // Save layout for each grid
            for (const [gridId, gridInstance] of Object.entries(grids)) {
                if (gridInstance) {
                    const items = gridInstance.getGridItems();
                    for (const item of items) {
                        const panelId = item.getAttribute('gs-id');
                        const x = parseInt(item.getAttribute('gs-x')) || 0;
                        const y = parseInt(item.getAttribute('gs-y')) || 0;
                        const w = parseInt(item.getAttribute('gs-w')) || 6;
                        const h = parseInt(item.getAttribute('gs-h')) || 4;

                        // Update panel position
                        await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}/position`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ grid_x: x, grid_y: y, grid_width: w, grid_height: h })
                        });
                    }
                }
            }
            showToast('Layout saved successfully!', 'success');
        } catch (error) {
            console.error('Error saving layout:', error);
            showToast('Failed to save layout', 'error');
        }
        exitEditMode();
    }

    function saveCurrentLayoutState() {
        const state = {};
        Object.entries(grids).forEach(([gridId, gridInstance]) => {
            if (gridInstance) {
                state[gridId] = gridInstance.save(false);
            }
        });
        return state;
    }

    function restoreLayoutState(state) {
        Object.entries(state).forEach(([gridId, items]) => {
            const gridInstance = grids[gridId];
            if (gridInstance && items) {
                gridInstance.load(items, true);
            }
        });
    }

    // Placeholder functions for settings menu actions
    function showShareModal() {
        showToast('Share functionality coming soon!', 'info');
        // settings-menu removed
        const moreMenu = document.getElementById('more-actions-menu');
        if (moreMenu) moreMenu.classList.add('hidden');
    }

    function duplicateDashboard() {
        showToast('Duplicate functionality coming soon!', 'info');
        // settings-menu removed
        const moreMenu = document.getElementById('more-actions-menu');
        if (moreMenu) moreMenu.classList.add('hidden');
    }

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', async () => {
        initializeGrid();  // Must initialize grid BEFORE loading dashboard (which calls renderPanels)
        await loadDashboard();
    });

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', () => {
        refreshAllPanels();
    });

    function renderEmptyState() {
        const gridContainer = document.querySelector('.grid-stack');
        // Clear minimal height spacers if any
        if (gridContainer) gridContainer.innerHTML = '';

        const mainContainer = document.getElementById('dashboard-grid');
        if (mainContainer) mainContainer.innerHTML = '';

        // We create the empty state in the main content area, replacing the grid
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state-container';
        emptyState.innerHTML = `
            <i class="fas fa-chart-line empty-state-icon"></i>
            <h3 class="text-xl font-bold text-white mb-2">This dashboard is empty</h3>
            <p class="text-gray-400 mb-6 max-w-md">Start building your operations view by adding panels or importing an existing layout.</p>
            <div class="flex gap-4">
                <button onclick="showPanelModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white font-medium transition-colors flex items-center gap-2">
                    <i class="fas fa-plus"></i> Add New Panel
                </button>
                <button onclick="showImportModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-gray-200 font-medium transition-colors flex items-center gap-2">
                    <i class="fas fa-upload"></i> Import JSON
                </button>
            </div>
        `;

        // Find a good place to append it. Ideally replacing the grid.
        // If 'dashboard-grid' is the container for gridstack, we use that.
        // If not, we might need to find the parent of grid-stack.

        // Let's assume dashboard-grid is the main wrapper 
        if (mainContainer) {
            mainContainer.appendChild(emptyState);
        } else if (gridContainer) {
            gridContainer.parentNode.appendChild(emptyState);
            gridContainer.style.display = 'none';
        }
    }

    async function loadDashboard() {
        showLoading();

        try {
            // Fetch dashboard details
            const dashboardRes = await fetch(`/api/dashboards/${dashboardId}`);
            if (!dashboardRes.ok) {
                throw new Error('Dashboard not found');
            }
            dashboard = await dashboardRes.json();

            // Update header
            document.getElementById('dashboard-title').textContent = dashboard.name;
            document.getElementById('dashboard-description').textContent = dashboard.description || '';

            // Set time range if dashboard has default
            if (dashboard.time_range) {
                const timeSelect = document.getElementById('time-range');
                if (timeSelect && timeSelect.options && [...timeSelect.options].some(o => o.value === dashboard.time_range)) {
                    timeSelect.value = dashboard.time_range;
                }
            }

            // Use panels from dashboard response (they're already included)
            panels = dashboard.panels || [];

            // Load variables
            await loadVariables();

            // Load panel rows for grouping
            await loadPanelRows();

            if (panels.length === 0) {
                renderEmptyState();
            } else {
                renderPanels();
                showPanels();
                // Load annotations so they appear on charts
                await loadAnnotations();
                // Load data for all panels
                await refreshAllPanels();

                // Set up auto-refresh if dashboard has refresh interval
                if (dashboard.auto_refresh && dashboard.refresh_interval) {
                    startAutoRefresh(dashboard.refresh_interval);
                }
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError(error.message);
        }
    }

    async function loadVariables() {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/variables`);
            if (!response.ok) {
                console.warn('Failed to load variables');
                return;
            }

            variables = await response.json();

            // Initialize variable values with defaults
            variables.forEach(variable => {
                variableValues[variable.name] = variable.current_value || variable.default_value || (variable.options && variable.options[0]) || '';
            });

            // Render variables if any exist
            if (variables.length > 0) {
                renderVariables();
            }
        } catch (error) {
            console.error('Error loading variables:', error);
        }
    }

    function renderVariables() {
        const container = document.getElementById('variables-list');
        const variablesContainer = document.getElementById('variables-container');

        if (!variables || variables.length === 0) {
            variablesContainer.classList.add('hidden');
            return;
        }

        // Filter out hidden variables (hide=2)
        const visibleVariables = variables.filter(v => v.hide !== 2);

        if (visibleVariables.length === 0) {
            variablesContainer.classList.add('hidden');
            return;
        }

        container.innerHTML = '';
        variablesContainer.classList.remove('hidden');

        visibleVariables.forEach(variable => {
            const varDiv = document.createElement('div');
            varDiv.className = 'flex items-center gap-2';

            // Show label only if hide !== 1
            if (variable.hide !== 1) {
                const label = document.createElement('label');
                label.className = 'text-sm text-gray-400';
                label.textContent = variable.label || variable.name;
                varDiv.appendChild(label);
            }

            // Create select element
            const select = document.createElement('select');
            select.id = `var-${variable.name}`;
            select.className = 'rounded px-3 py-1.5 text-sm min-w-[150px] cursor-pointer text-gray-300 focus:border-blue-500 focus:outline-none';
            select.style.backgroundColor = '#0e0f11';
            select.style.border = '1px solid #2d2d31';


            // Only set multiple attribute for multi-select variables
            // But don't set size - let it be a regular dropdown
            if (variable.multi_select) {
                // Mark as multi-select but don't expand it
                select.setAttribute('data-multiselect', 'true');
            }

            // Populate options
            (variable.options || []).forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                opt.selected = option === variableValues[variable.name];
                select.appendChild(opt);
            });

            // Add change handler
            select.addEventListener('change', () => handleVariableChange(variable.name, select));

            varDiv.appendChild(select);
            container.appendChild(varDiv);
        });
    }

    async function handleVariableChange(variableName, selectElement) {
        const variable = variables.find(v => v.name === variableName);
        if (!variable) return;

        if (variable.multi_select) {
            // Get all selected options
            const selectedOptions = Array.from(selectElement.selectedOptions).map(opt => opt.value);
            variableValues[variableName] = selectedOptions.join(',');
        } else {
            variableValues[variableName] = selectElement.value;
        }

        // Update current value on server
        try {
            await fetch(`/api/dashboards/${dashboardId}/variables/${variable.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_value: variableValues[variableName] })
            });
        } catch (error) {
            console.error('Failed to update variable value:', error);
        }

        // Refresh all panels with new variable value
        await refreshAllPanels();
    }

    function substituteVariables(query) {
        if (!query) return query;

        let result = query;

        // Replace each variable with its current value
        variables.forEach(variable => {
            const value = variableValues[variable.name];
            if (value === undefined || value === null) return;

            // Handle "All" option
            let substitutionValue = value;
            if (value === 'All' && variable.include_all) {
                substitutionValue = variable.all_value || '.*';
            }

            // Replace $variableName with value
            const regex = new RegExp(`\\$${variable.name}\\b`, 'g');
            result = result.replace(regex, substitutionValue);

            // Also support ${variableName} syntax
            const bracketRegex = new RegExp(`\\$\\{${variable.name}\\}`, 'g');
            result = result.replace(bracketRegex, substitutionValue);
        });

        return result;
    }

    function initializeGrid() {
        // Initialize the ungrouped grid
        initializeGridFor('grid-ungrouped');
    }

    function initializeGridFor(elementId) {
        console.log('Initializing GridStack (Row Spacing Fix v6 - Forced CSS Inset)');
        const element = document.getElementById(elementId);
        if (!element) return null;

        const gridInstance = GridStack.init({
            cellHeight: 80,
            // margin: 16, // Handled by CSS in v6
            resizable: {
                handles: 'e, se, s, sw, w'
            },
            draggable: {
                handle: '.panel-drag-handle'
            },
            disableDrag: true,  // Disabled by default
            disableResize: true  // Disabled by default
        }, `#${elementId}`);

        // Save layout on change
        gridInstance.on('change', (event, items) => {
            if (!editMode) return;  // Only save in edit mode

            items.forEach(item => {
                const panelId = item.id;
                savePanelPosition(panelId, {
                    grid_x: item.x,
                    grid_y: item.y,
                    grid_width: item.w,
                    grid_height: item.h
                });

                // Resize chart when panel is resized
                if (charts[panelId]) {
                    setTimeout(() => {
                        charts[panelId].resize();
                    }, 100);
                }
            });
        });

        // Handle resize stop to ensure charts resize properly
        gridInstance.on('resizestop', (event, el) => {
            const panelId = el.getAttribute('gs-id');
            if (panelId && charts[panelId]) {
                setTimeout(() => {
                    charts[panelId].resize();
                }, 50);
            }
        });

        grids[elementId] = gridInstance;
        return gridInstance;
    }

    async function loadPanelRows() {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/rows`);
            if (!response.ok) {
                console.warn('Failed to load panel rows');
                panelRows = [];
                return;
            }
            panelRows = await response.json();
            // Sort by order
            panelRows.sort((a, b) => a.order - b.order);
        } catch (error) {
            console.error('Error loading panel rows:', error);
            panelRows = [];
        }
    }

    function toggleRow(rowId) {
        const header = document.getElementById(`row-header-${rowId}`);
        const content = document.getElementById(`row-content-${rowId}`);

        if (header && content) {
            header.classList.toggle('collapsed');
            content.classList.toggle('collapsed');

            // Save collapsed state to backend
            const isCollapsed = header.classList.contains('collapsed');
            fetch(`/api/dashboards/${dashboardId}/rows/${rowId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_collapsed: isCollapsed })
            }).catch(err => console.error('Failed to save row state:', err));
        }
    }

    // Wrapper function for reloading panels (called by row management)
    async function loadDashboardPanels() {
        await loadDashboard();
    }

    function renderPanels() {
        const rowsContainer = document.getElementById('rows-container');
        const ungroupedSection = document.getElementById('ungrouped-section');

        // Clear existing row sections
        rowsContainer.innerHTML = '';

        // Clear all grids
        Object.values(grids).forEach(g => {
            try { g.removeAll(); } catch (e) { }
        });
        grids = {};

        // Group panels by row_id
        const panelsByRow = {};
        const ungroupedPanels = [];

        panels.forEach(panel => {
            const rowId = panel.row_id;
            if (rowId) {
                if (!panelsByRow[rowId]) panelsByRow[rowId] = [];
                panelsByRow[rowId].push(panel);
            } else {
                ungroupedPanels.push(panel);
            }
        });

        // Render row sections
        panelRows.forEach(row => {
            const rowPanels = panelsByRow[row.id] || [];
            const panelCount = rowPanels.length;
            const isCollapsed = row.is_collapsed;
            const isSectionHeader = row.is_section_header;

            // Create row section HTML
            let sectionHtml = '';

            if (isSectionHeader) {
                // Section Header Style (Title only, no collapse, no badge)
                sectionHtml = `
                    <div class="panel-row-section section-header" id="row-section-${row.id}">
                        <div class="panel-row-header-title-only mb-2 mt-2">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                ${escapeHtml(row.title)}
                            </h3>
                            ${row.description ? `<p class="text-gray-400 text-sm mt-1">${escapeHtml(row.description)}</p>` : ''}
                        </div>
                        <div class="panel-row-content" id="row-content-${row.id}">
                            <div class="grid-stack" id="grid-row-${row.id}"></div>
                        </div>
                    </div>
                `;
            } else {
                // Standard Collapsible Row
                sectionHtml = `
                    <div class="panel-row-section" id="row-section-${row.id}">
                        <div class="panel-row-header ${isCollapsed ? 'collapsed' : ''}" 
                             id="row-header-${row.id}" 
                             onclick="toggleRow('${row.id}')">
                            <div class="row-title">
                                <i class="fas fa-chevron-down row-toggle"></i>
                                <i class="fas fa-layer-group text-indigo-400"></i>
                                <span>${escapeHtml(row.title)}</span>
                                ${row.description ? `<span class="text-gray-500 text-sm font-normal ml-2">- ${escapeHtml(row.description)}</span>` : ''}
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="panel-row-badge">${panelCount} panel${panelCount !== 1 ? 's' : ''}</span>
                            </div>
                        </div>
                        <div class="panel-row-content ${isCollapsed ? 'collapsed' : ''}" 
                             id="row-content-${row.id}"
                             style="${isCollapsed ? '' : 'max-height: 2000px;'}">
                            <div class="grid-stack" id="grid-row-${row.id}"></div>
                        </div>
                    </div>
                `;
            }

            rowsContainer.insertAdjacentHTML('beforeend', sectionHtml);

            // Initialize grid for this row
            const rowGrid = initializeGridFor(`grid-row-${row.id}`);

            // Add panels to this row's grid
            if (rowGrid && rowPanels.length > 0) {
                rowPanels.forEach((panelItem, index) => {
                    addPanelToGrid(rowGrid, panelItem, index);
                });
            }
        });

        // Render ungrouped panels
        if (ungroupedPanels.length > 0) {
            ungroupedSection.style.display = 'block';
            const ungroupedGrid = initializeGridFor('grid-ungrouped');
            if (ungroupedGrid) {
                ungroupedPanels.forEach((panelItem, index) => {
                    addPanelToGrid(ungroupedGrid, panelItem, index);
                });
            }
        } else {
            ungroupedSection.style.display = panelRows.length > 0 ? 'none' : 'block';
            // If no rows exist, still initialize ungrouped grid for all panels
            if (panelRows.length === 0) {
                const ungroupedGrid = initializeGridFor('grid-ungrouped');
                if (ungroupedGrid) {
                    panels.forEach((panelItem, index) => {
                        addPanelToGrid(ungroupedGrid, panelItem, index);
                    });
                }
            }
        }

        // Set main grid reference for compatibility
        grid = grids['grid-ungrouped'] || Object.values(grids)[0];
    }

    function addPanelToGrid(targetGrid, panelItem, index) {
        const panelId = panelItem.panel_id || panelItem.id;
        const panelName = panelItem.panel_name || panelItem.name || 'Unnamed Panel';
        const panelDescription = panelItem.description || '';
        const panelQuery = panelItem.promql_query || 'No query';

        // Use saved grid position or default
        const gridX = panelItem.grid_x !== undefined ? panelItem.grid_x : (index % 2) * 6;
        const gridY = panelItem.grid_y !== undefined ? panelItem.grid_y : Math.floor(index / 2) * 4;
        const gridWidth = panelItem.grid_width || 6;
        const gridHeight = panelItem.grid_height || 4;

        // Create panel HTML
        const panelHtml = `
            <div class="h-full flex flex-col">
                <div class="panel-drag-handle">
                    <div>
                        <i class="fas fa-grip-vertical mr-2"></i>
                        <span class="font-medium text-white">${escapeHtml(panelName)}</span>
                    </div>
                    <div class="panel-actions">
                        <button onclick="inspectPanel('${panelId}')" class="text-purple-400 hover:text-purple-300" title="Inspect Panel">
                            <i class="fas fa-search"></i>
                        </button>
                        <button onclick="editPanel('${panelId}')" class="text-blue-400 hover:text-blue-300" title="Edit Panel">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button onclick="duplicatePanel('${panelId}')" class="text-green-400 hover:text-green-300" title="Duplicate Panel">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="showAssignRowModal('${panelId}')" class="text-indigo-400 hover:text-indigo-300" title="Assign to Row">
                            <i class="fas fa-layer-group"></i>
                        </button>
                        <button onclick="removePanel('${panelId}')" class="text-red-400 hover:text-red-300" title="Remove Panel">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex-1 text-center">
                            <p class="text-sm text-gray-300 font-medium">${escapeHtml(panelDescription)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="inspectPanel('${panelId}')" class="text-gray-500 hover:text-purple-400 transition-colors" title="Inspect">
                                <i class="fas fa-search text-xs"></i>
                            </button>
                            <span id="panel-status-${panelId}" class="flex items-center gap-1 text-xs text-gray-500">
                                <i class="fas fa-circle text-green-400 text-xs"></i>
                                Live
                            </span>
                        </div>
                    </div>
                    <div id="chart-${panelId}" class="panel-chart-container bg-gray-800/50 rounded-lg">
                        <i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i>
                    </div>
                    <div class="mt-2 text-xs text-gray-600 font-mono truncate" title="${escapeHtml(panelQuery)}">
                        ${escapeHtml(panelQuery)}
                    </div>
                </div>
            </div>
        `;

        // Add to grid
        targetGrid.addWidget({
            x: gridX,
            y: gridY,
            w: gridWidth,
            h: gridHeight,
            content: panelHtml,
            id: panelId
        });
    }

    async function refreshAllPanels() {
        for (const panelItem of panels) {
            const panelId = panelItem.panel_id || panelItem.id;
            await loadPanelData(panelId, panelItem);
        }
    }

    async function loadPanelData(panelId, panelItem) {
        const chartContainer = document.getElementById(`chart-${panelId}`);
        const statusEl = document.getElementById(`panel-status-${panelId}`);

        if (!chartContainer) return;

        try {
            // Get time range bounds
            const { start, end } = getTimeRangeBounds();

            // Track execution time
            const execStartTime = performance.now();

            // Apply variable substitution to query
            const originalQuery = panelItem.promql_query || '';
            const substitutedQuery = substituteVariables(originalQuery);

            // If query has variable substitutions AND we have datasource_id, use test-query endpoint
            // Otherwise, use the normal panel data endpoint (which handles everything server-side)
            let response, result;

            const hasSubstitutions = substitutedQuery !== originalQuery;
            const hasDatasourceId = panelItem.datasource_id;

            if (hasSubstitutions && hasDatasourceId) {
                // Use test-query endpoint with substituted query
                // Use apiCall for correct auth handling
                response = await apiCall(`/api/panels/test-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datasource_id: panelItem.datasource_id,
                        promql_query: substitutedQuery,
                        time_range: '1h'  // test-query uses time_range, not start/end
                    })
                });

                if (!response) return; // Auth redirect happened

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const testResult = await response.json();
                result = {
                    data: testResult.sample_data || [],
                    metadata: { series_count: testResult.series_count || 0 }
                };
            } else {
                // Use normal panel data endpoint (handles datasource lookup via panel ID)
                // Use apiCall for correct auth handling
                response = await apiCall(`/api/panels/${panelId}/data?start=${start.toISOString()}&end=${end.toISOString()}`);

                if (!response) return; // Auth redirect happened

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                result = await response.json();
            }

            const execEndTime = performance.now();
            const executionTime = Math.round(execEndTime - execStartTime);

            // Store inspection data
            const responseText = JSON.stringify(result);
            const responseSize = formatBytes(new Blob([responseText]).size);

            panelInspectorData[panelId] = {
                executedQuery: substitutedQuery,
                originalQuery: originalQuery,
                timeRange: { start, end },
                rawResponse: result,
                executionTime: executionTime,
                responseSize: responseSize,
                timestamp: new Date().toISOString()
            };

            // Render chart based on panel type
            renderChart(panelId, result.data, chartContainer, panelItem);

            // Update status
            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-green-400 text-xs"></i>
                <span>${result.metadata?.series_count || 0} series</span>
            `;
            }

        } catch (error) {
            console.error(`Error loading panel ${panelId}:`, error);
            chartContainer.innerHTML = `
            <div class="text-center text-red-400">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p class="text-sm">Failed to load data</p>
                <p class="text-xs text-gray-500">${error.message}</p>
            </div>
        `;

            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-red-400 text-xs"></i>
                Error
            `;
            }
        }
    }

    // Unit Formatting Helper
    function formatUnit(value, unit, decimals = 2) {
        if (value === null || value === undefined) return '-';

        const num = parseFloat(value);
        if (isNaN(num)) return value;

        switch (unit) {
            case 'percent':
                return `${num.toFixed(decimals)}%`;

            case 'bytes':
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                if (num === 0) return '0 B';
                const i = Math.floor(Math.log(num) / Math.log(1024));
                return `${(num / Math.pow(1024, i)).toFixed(decimals)} ${sizes[i]}`;

            case 'seconds':
                if (num < 60) return `${num.toFixed(decimals)}s`;
                if (num < 3600) return `${(num / 60).toFixed(decimals)}m`;
                if (num < 86400) return `${(num / 3600).toFixed(decimals)}h`;
                return `${(num / 86400).toFixed(decimals)}d`;

            case 'milliseconds':
                return `${num.toFixed(decimals)}ms`;

            case 'requests':
                return `${num.toFixed(decimals)} req/s`;

            case 'ops':
                return `${num.toFixed(decimals)} ops/s`;

            default:
                return num.toFixed(decimals);
        }
    }

    // Color Scheme Maps - Grafana Dark Mode Palette
    const colorSchemes = {
        // Grafana's classic dark theme palette - vibrant colors with good contrast
        'default': [
            '#7eb26d',  // Green
            '#eab839',  // Yellow/Gold
            '#6ed0e0',  // Cyan/Teal
            '#ef843c',  // Orange
            '#e24d42',  // Red
            '#1f78c1',  // Blue
            '#ba43a9',  // Purple/Magenta
            '#705da0',  // Violet
            '#508642',  // Dark Green
            '#cca300',  // Dark Yellow
            '#447ebc',  // Steel Blue
            '#c15c17',  // Burnt Orange
            '#890f02',  // Dark Red
            '#0a437c',  // Navy Blue
            '#6d1f62',  // Dark Magenta
            '#584477'   // Dark Violet
        ],
        'green': ['#7eb26d', '#508642', '#3f6833', '#2f5127', '#1f3a1c'],
        'red': ['#e24d42', '#c15c17', '#890f02', '#6d1f1f', '#5c1a1a'],
        'purple': ['#ba43a9', '#705da0', '#584477', '#6d1f62', '#4a1f4a'],
        'rainbow': ['#e24d42', '#ef843c', '#eab839', '#7eb26d', '#1f78c1', '#ba43a9'],
        'cool': ['#6ed0e0', '#447ebc', '#1f78c1', '#0a437c', '#052b4d'],
        'warm': ['#ef843c', '#eab839', '#e24d42', '#c15c17', '#890f02'],
        // Grafana's new palette for more modern look
        'grafana_modern': [
            '#73bf69',  // Green
            '#f2cc0c',  // Yellow
            '#8ab8ff',  // Light Blue
            '#ff9830',  // Orange
            '#f2495c',  // Red
            '#5794f2',  // Blue
            '#b877d9',  // Purple
            '#ff6eb4'   // Pink
        ]
    };

    function getColors(scheme, count) {
        const colors = colorSchemes[scheme] || colorSchemes['default'];
        // Repeat colors if needed
        return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    }

    function renderChart(panelId, data, container, panelItem = {}) {
        // Clear container if it has spinner
        if (container.querySelector('.fa-spinner')) {
            container.innerHTML = '';
        }

        // Initialize or get existing chart
        if (!charts[panelId]) {
            charts[panelId] = echarts.init(container);

            // Add ResizeObserver to automatically resize chart when container size changes
            const resizeObserver = new ResizeObserver(() => {
                if (charts[panelId]) {
                    charts[panelId].resize();
                }
            });
            resizeObserver.observe(container);
        }
        const chart = charts[panelId];

        // Get visualization config
        const config = panelItem.visualization_config || {};
        const colorScheme = config.color_scheme || 'default';
        const colors = getColors(colorScheme, data.length);
        const useGradient = config.gradient || false;
        const decimals = config.decimals !== undefined ? config.decimals : 2;
        const unit = config.units || '';

        // Build series from Prometheus data
        const series = data.map((s, idx) => {
            // Smart default: If single series and unknown metric name, use panel name instead of instance
            let defaultLabel = null;

            if (data.length === 1 && !panelItem.legend_format) {
                defaultLabel = panelItem.panel_name || panelItem.name || `Series ${idx + 1}`;
            }

            const name = defaultLabel || formatLegend(panelItem.legend_format, s.metric) || `Series ${idx + 1}`;
            const values = (s.values || []).map(v => [
                new Date(v[0] * 1000),
                parseFloat(v[1])
            ]);

            const seriesConfig = {
                name: name,
                type: 'line',
                data: values,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 2,
                    color: colors[idx]
                },
                itemStyle: {
                    color: colors[idx]
                }
            };

            // Add gradient fill if enabled
            if (useGradient) {
                seriesConfig.areaStyle = {
                    opacity: 0.3,
                    color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [
                            { offset: 0, color: colors[idx] },
                            { offset: 1, color: 'transparent' }
                        ]
                    }
                };
            } else {
                seriesConfig.areaStyle = { opacity: 0.1 };
            }

            return seriesConfig;
        });

        // Y-Axis configuration
        const yAxisConfig = {
            type: 'value',
            axisLine: { lineStyle: { color: '#444' } },
            axisLabel: {
                color: '#888',
                formatter: (value) => formatUnit(value, unit, decimals)
            },
            splitLine: { lineStyle: { color: '#333' } }
        };

        // Apply custom Y-axis settings from config
        if (config.axis) {
            if (config.axis.y_min !== null && config.axis.y_min !== undefined) {
                yAxisConfig.min = config.axis.y_min;
            }
            if (config.axis.y_max !== null && config.axis.y_max !== undefined) {
                yAxisConfig.max = config.axis.y_max;
            }
            if (config.axis.y_label) {
                yAxisConfig.name = config.axis.y_label;
                yAxisConfig.nameTextStyle = { color: '#888' };
            }
        }

        // Legend configuration
        const legendConfig = {
            data: series.map(s => s.name),
            textStyle: { color: '#888' },
            type: 'scroll'
        };

        if (config.legend) {
            legendConfig.show = config.legend.show !== false;
            const position = config.legend.position || 'bottom';
            switch (position) {
                case 'top':
                    legendConfig.top = 0;
                    legendConfig.left = 'center';
                    break;
                case 'bottom':
                    legendConfig.bottom = 0;
                    legendConfig.left = 'center';
                    break;
                case 'left':
                    legendConfig.left = 0;
                    legendConfig.top = 'middle';
                    legendConfig.orient = 'vertical';
                    break;
                case 'right':
                    legendConfig.right = 0;
                    legendConfig.top = 'middle';
                    legendConfig.orient = 'vertical';
                    break;
            }
        }

        // Tooltip configuration
        const tooltipConfig = {
            trigger: 'axis',
            backgroundColor: 'rgba(30, 30, 30, 0.9)',
            borderColor: '#444',
            textStyle: { color: '#fff' },
            formatter: (params) => {
                let result = `<div style="font-size: 12px;">${new Date(params[0].value[0]).toLocaleString()}</div>`;
                params.forEach(param => {
                    const value = formatUnit(param.value[1], unit, decimals);
                    result += `<div style="margin-top: 4px;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${param.color};margin-right:5px;"></span>
                        ${param.seriesName}: <strong>${value}</strong>
                    </div>`;
                });
                return result;
            }
        };

        // Build threshold mark lines
        const markLines = [];
        if (config.thresholds && config.thresholds.length > 0) {
            config.thresholds.forEach(threshold => {
                markLines.push({
                    yAxis: threshold.value,
                    lineStyle: {
                        color: threshold.color || '#fac858',
                        type: 'dashed',
                        width: 2
                    },
                    label: {
                        formatter: threshold.label || `${threshold.value}`,
                        position: 'end',
                        color: threshold.color || '#fac858'
                    }
                });
            });

            // Add mark lines to first series
            if (series.length > 0) {
                series[0].markLine = {
                    silent: true,
                    data: markLines
                };
            }
        }

        // Add annotation markers
        const annotationMarkLines = [];
        if (annotations && annotations.length > 0 && data.length > 0 && data[0].values && data[0].values.length > 0) {
            // Get time range from chart data
            const chartStartTime = new Date(data[0].values[0][0] * 1000);
            const chartEndTime = new Date(data[0].values[data[0].values.length - 1][0] * 1000);

            // Filter annotations within chart time range
            annotations.forEach(annotation => {
                const annotationTime = new Date(annotation.time);
                if (annotationTime >= chartStartTime && annotationTime <= chartEndTime) {
                    annotationMarkLines.push({
                        xAxis: annotationTime,
                        lineStyle: {
                            color: annotation.color || '#FF6B6B',
                            type: 'solid',
                            width: 2,
                            opacity: 0.8
                        },
                        label: {
                            formatter: annotation.title || annotation.text.substring(0, 20),
                            position: 'insideEndTop',
                            color: annotation.color || '#FF6B6B',
                            fontSize: 10,
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            padding: [4, 6],
                            borderRadius: 3
                        }
                    });
                }
            });

            // Add annotation mark lines to first series
            if (annotationMarkLines.length > 0 && series.length > 0) {
                if (series[0].markLine) {
                    series[0].markLine.data.push(...annotationMarkLines);
                } else {
                    series[0].markLine = {
                        silent: false,
                        data: annotationMarkLines,
                        symbol: 'none'
                    };
                }
            }
        }

        const option = {
            backgroundColor: 'transparent',
            color: colors,
            grid: {
                left: 60,
                right: 20,
                top: legendConfig.top === 0 ? 40 : 30,
                bottom: legendConfig.bottom === 0 ? 40 : 30
            },
            tooltip: tooltipConfig,
            legend: legendConfig,
            xAxis: {
                type: 'time',
                axisLine: { lineStyle: { color: '#444' } },
                axisLabel: { color: '#888' },
                splitLine: { show: false }
            },
            yAxis: yAxisConfig,
            series: series
        };

        chart.setOption(option, true);
        chart.resize();
    }

    function formatLegend(format, metric) {
        if (!format || !metric) {
            // Default: use metric name if available, otherwise instance or job
            return metric.__name__ || metric.instance || metric.job || Object.values(metric)[0] || 'Value';
        }

        let result = format;
        for (const [key, value] of Object.entries(metric)) {
            // Use string concat to avoid Jinja2 template conflict
            result = result.replace('{% raw %}{{{% endraw %}' + key + '{% raw %}}}{% endraw %}', value);
        }
        return result;
    }

    function parseTimeRange(range) {
        const units = {
            'm': 60 * 1000,
            'h': 60 * 60 * 1000,
            'd': 24 * 60 * 60 * 1000
        };
        const match = range.match(/^(\d+)([mhd])$/);
        if (match) {
            return parseInt(match[1]) * units[match[2]];
        }
        return 24 * 60 * 60 * 1000; // Default 24h
    }

    function startAutoRefresh(intervalSeconds) {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(() => {
            refreshAllPanels();
        }, intervalSeconds * 1000);
    }

    // toggleEditMode is defined earlier in the file (around line 1429)
    // with proper Cancel/Save button handling

    async function savePanelPosition(panelId, position) {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}/position`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(position)
            });

            if (!response.ok) {
                console.error('Failed to save panel position:', await response.text());
            }
        } catch (error) {
            console.error('Failed to save panel position:', error);
        }
    }

    // --- Panel Edit Modal Logic ---

    let queryEditor = null;
    let thresholdCounter = 0;
    let previewChart = null;

    function editPanel(panelId) {
        // Find panel in the local panels array (populated from templating or API)
        // Since we don't have a global panels array here yet, we might need to fetch it or rely on what's available.
        // The dashboard view renders panels server-side.
        // We can fetch the panel details via API to ensure we have the latest.

        fetch(`/api/panels/${panelId}`)
            .then(response => response.json())
            .then(panel => {
                openEditModal(panel);
            })
            .catch(error => {
                console.error('Error fetching panel details:', error);
                showToast('Failed to load panel details', 'error');
            });
    }

    function openEditModal(panel) {
        document.getElementById('modal-title').textContent = 'Edit Panel';
        document.getElementById('panel-id').value = panel.id;
        document.getElementById('panel-name').value = panel.name;
        document.getElementById('panel-description').value = panel.description || '';

        // Populate Datasource Dropdown if empty (might need to fetch datasources)
        ensureDatasourcesLoaded().then(() => {
            document.getElementById('panel-datasource').value = panel.datasource_id;
        });

        document.getElementById('panel-type').value = panel.panel_type;
        document.getElementById('panel-legend').value = panel.legend_format || '';
        document.getElementById('panel-time-range').value = panel.time_range;
        document.getElementById('panel-refresh').value = panel.refresh_interval;
        document.getElementById('panel-is-template').checked = panel.is_template;
        document.getElementById('panel-is-public').checked = panel.is_public;
        document.getElementById('panel-tags').value = panel.tags ? panel.tags.join(', ') : '';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');

        // Set query editor value directly (no CodeMirror - it has rendering issues in modals)
        const queryTextarea = document.getElementById('query-editor');
        queryTextarea.value = panel.promql_query || '';
        queryTextarea.style.display = 'block'; // Ensure textarea is visible

        // Load visualization config using shared function
        PanelEditor.loadVisualizationConfig(panel.visualization_config);
    }

    function closePanelModal() {
        document.getElementById('panel-modal').classList.add('hidden');
    }

    async function savePanel(event) {
        event.preventDefault();
        const id = document.getElementById('panel-id').value;
        const tags = document.getElementById('panel-tags').value
            .split(',')
            .map(t => t.trim())
            .filter(t => t.length > 0);

        // Explicitly save current position from grid to ensure resize/move is persisted
        if (id) {
            const gridItem = document.querySelector(`.grid-stack-item[gs-id="${id}"]`);
            if (gridItem) {
                const x = parseInt(gridItem.getAttribute('gs-x')) || 0;
                const y = parseInt(gridItem.getAttribute('gs-y')) || 0;
                const w = parseInt(gridItem.getAttribute('gs-w')) || 6;
                const h = parseInt(gridItem.getAttribute('gs-h')) || 4;

                // We await this to ensure it completes before page reload
                await savePanelPosition(id, { grid_x: x, grid_y: y, grid_width: w, grid_height: h });
            }
        }

        const data = {
            name: document.getElementById('panel-name').value,
            description: document.getElementById('panel-description').value || null,
            datasource_id: document.getElementById('panel-datasource').value,
            promql_query: document.getElementById('query-editor').value,
            legend_format: document.getElementById('panel-legend').value || null,
            time_range: document.getElementById('panel-time-range').value,
            refresh_interval: parseInt(document.getElementById('panel-refresh').value),
            panel_type: document.getElementById('panel-type').value,
            is_template: document.getElementById('panel-is-template').checked,
            is_public: document.getElementById('panel-is-public').checked,
            tags: tags.length > 0 ? tags : null,
            visualization_config: collectChartConfig()
        };

        try {
            const response = await fetch(`/api/panels/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast('Panel updated successfully', 'success');
                closePanelModal();
                // Reload the specific panel or the whole page
                setTimeout(() => location.reload(), 500); // Simple reload for now to reflect changes matches existing behavior
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save panel', 'error');
            }
        } catch (error) {
            console.error('Failed to save panel:', error);
            showToast('Failed to save panel', 'error');
        }
    }

    // --- Helper Functions for Modal ---

    let datasourcesLoaded = false;
    async function ensureDatasourcesLoaded() {
        if (datasourcesLoaded) return;
        try {
            const response = await fetch('/api/datasources/?enabled_only=true');
            const datasources = await response.json();
            const select = document.getElementById('panel-datasource');
            // Keep the default option
            const defaultOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(defaultOption);

            datasources.forEach(ds => {
                const option = document.createElement('option');
                option.value = ds.id;
                option.textContent = ds.name;
                select.appendChild(option);
            });
            datasourcesLoaded = true;
        } catch (error) {
            console.error('Failed to load datasources:', error);
        }
    }

    // Note: toggleChartConfig, addThreshold, removeThreshold, collectChartConfig, 
    // testQuery, renderModalPreviewChart, getPreviewMetricLabel, loadQueryExample
    // are now provided by the shared panel-editor.js file



    async function duplicatePanel(panelId) {
        if (!confirm('Duplicate this panel?')) return;

        try {
            const response = await fetch(`/api/panels/${panelId}/clone`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error('Failed to duplicate panel');
            }

            showToast('Panel duplicated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Error duplicating panel:', error);
            showToast('Failed to duplicate panel', 'error');
        }
    }

    async function removePanel(panelId) {
        if (!confirm('Remove this panel from the dashboard?')) return;

        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to remove panel');
            }

            // Remove from grid
            const widget = document.querySelector(`[gs-id="${panelId}"]`);
            if (widget) {
                grid.removeWidget(widget);
            }

            // Remove from panels array
            panels = panels.filter(p => (p.panel_id || p.id) !== panelId);

            showToast('Panel removed successfully', 'success');
        } catch (error) {
            console.error('Error removing panel:', error);
            showToast('Failed to remove panel', 'error');
        }
    }

    function showAssignRowModal(panelId) {
        // Find the panel
        const panel = panels.find(p => (p.panel_id || p.id) === panelId);
        if (!panel) return;

        const panelName = panel.panel_name || panel.name || 'Unnamed Panel';
        const currentRowId = panel.row_id || '';

        // Set panel info
        document.getElementById('assign-row-panel-id').value = panelId;
        document.getElementById('assign-row-panel-name').textContent = panelName;

        // Populate row dropdown
        const select = document.getElementById('assign-row-select');
        select.innerHTML = '<option value="">-- No Row (Ungrouped) --</option>';
        panelRows.forEach(row => {
            const option = document.createElement('option');
            option.value = row.id;
            option.textContent = row.title;
            if (row.id === currentRowId) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        // Show modal
        document.getElementById('assign-row-modal').classList.remove('hidden');
    }

    function closeAssignRowModal() {
        document.getElementById('assign-row-modal').classList.add('hidden');
    }

    async function assignPanelToRow() {
        const panelId = document.getElementById('assign-row-panel-id').value;
        const rowId = document.getElementById('assign-row-select').value || null;

        try {
            // Update panel's row_id via API
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}/position`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ row_id: rowId })
            });

            if (!response.ok) {
                throw new Error('Failed to update panel');
            }

            // Update local panel data
            const panel = panels.find(p => (p.panel_id || p.id) === panelId);
            if (panel) {
                panel.row_id = rowId;
            }

            closeAssignRowModal();
            showToast('Panel assigned to row successfully', 'success');

            // Re-render panels to show new grouping
            renderPanels();
            // Refresh panel data
            await refreshAllPanels();
        } catch (error) {
            console.error('Error assigning panel to row:', error);
            showToast('Failed to assign panel to row', 'error');
        }
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-600' :
            type === 'error' ? 'bg-red-600' :
                'bg-blue-600'
            } text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function showLoading() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
        document.getElementById('error-message').textContent = message;
    }

    function showEmpty() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showPanels() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.remove('hidden');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function getLocalDateTimeString(date = new Date()) {
        // Format as YYYY-MM-DDTHH:MM for datetime-local input (in local time, not UTC)
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Time Range and Refresh State
    let currentTimeRange = {
        mode: 'quick', // 'quick', 'relative', 'absolute'
        value: '24h',
        from: 'now-24h',
        to: 'now',
        display: 'Last 24 hours'
    };
    let customRefreshIntervalSeconds = 0;
    let refreshCountdownTimer = null;
    let refreshCountdownSeconds = 0;

    // Panel Inspector State
    let panelInspectorData = {}; // Stores inspection data for each panel

    // Alerts State
    let alerts = [];
    let allAlerts = [];
    let alertsRefreshTimer = null;

    // Annotations State
    let annotations = [];
    let editingAnnotation = null;

    // Variables Management UI Functions
    let datasources = [];
    let editingVariable = null;

    async function loadDatasources() {
        try {
            const response = await fetch('/api/datasources/');
            if (response.ok) {
                datasources = await response.json();
            }
        } catch (error) {
            console.error('Error loading datasources:', error);
        }
    }

    async function showVariablesModal() {
        await loadDatasources();
        await loadVariables(); // Refresh variables list
        renderVariablesTable();
        document.getElementById('variables-modal').classList.remove('hidden');
    }

    function closeVariablesModal() {
        document.getElementById('variables-modal').classList.add('hidden');
    }

    function renderVariablesTable() {
        const container = document.getElementById('variables-table');

        if (!variables || variables.length === 0) {
            container.innerHTML = `
                <div class="p-8 text-center text-gray-400">
                    <i class="fas fa-sliders-h text-4xl mb-3"></i>
                    <p>No variables defined yet.</p>
                    <p class="text-sm mt-1">Variables allow dynamic filtering of dashboard data.</p>
                </div>
            `;
            return;
        }

        let html = `
            <table class="w-full text-sm">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-gray-300">Name</th>
                        <th class="px-4 py-3 text-left text-gray-300">Label</th>
                        <th class="px-4 py-3 text-left text-gray-300">Type</th>
                        <th class="px-4 py-3 text-left text-gray-300">Options</th>
                        <th class="px-4 py-3 text-left text-gray-300">Hide</th>
                        <th class="px-4 py-3 text-right text-gray-300">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
        `;

        variables.forEach(variable => {
            const optionsCount = variable.options?.length || 0;
            const hideText = variable.hide === 2 ? 'Hidden' : variable.hide === 1 ? 'Label only' : 'Visible';

            html += `
                <tr class="hover:bg-gray-800/50">
                    <td class="px-4 py-3">
                        <code class="text-blue-400">$${escapeHtml(variable.name)}</code>
                    </td>
                    <td class="px-4 py-3 text-gray-300">${escapeHtml(variable.label || variable.name)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300">${escapeHtml(variable.type)}</span>
                    </td>
                    <td class="px-4 py-3 text-gray-400">${optionsCount} options</td>
                    <td class="px-4 py-3 text-gray-400">${hideText}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editVariable('${variable.id}')" class="text-blue-400 hover:text-blue-300 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteVariable('${variable.id}')" class="text-red-400 hover:text-red-300" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;

        container.innerHTML = html;
    }

    function showVariableEditor(variableId = null) {
        editingVariable = variableId ? variables.find(v => v.id === variableId) : null;

        // Reset form
        document.getElementById('variable-form').reset();
        document.getElementById('variable-id').value = '';

        // Set title
        document.getElementById('variable-editor-title').textContent = editingVariable ? 'Edit Variable' : 'New Variable';

        // Populate datasources dropdown
        const datasourceSelect = document.getElementById('variable-datasource');
        datasourceSelect.innerHTML = '<option value="">Select datasource...</option>';
        datasources.forEach(ds => {
            datasourceSelect.innerHTML += `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`;
        });

        // If editing, populate form
        if (editingVariable) {
            document.getElementById('variable-id').value = editingVariable.id;
            document.getElementById('variable-name').value = editingVariable.name;
            document.getElementById('variable-label').value = editingVariable.label || '';
            document.getElementById('variable-type').value = editingVariable.type;
            document.getElementById('variable-datasource').value = editingVariable.datasource_id || '';
            document.getElementById('variable-query').value = editingVariable.query || '';
            document.getElementById('variable-regex').value = editingVariable.regex || '';
            document.getElementById('variable-custom-values').value = (editingVariable.custom_values || []).join('\n');
            document.getElementById('variable-default-value').value = editingVariable.default_value || '';
            document.getElementById('variable-multi-select').checked = editingVariable.multi_select || false;
            document.getElementById('variable-include-all').checked = editingVariable.include_all || false;
            document.getElementById('variable-all-value').value = editingVariable.all_value || '.*';
            document.getElementById('variable-hide').value = editingVariable.hide || 0;
            document.getElementById('variable-sort').value = editingVariable.sort || 0;
        }

        // Show/hide fields based on type
        handleVariableTypeChange();
        handleIncludeAllChange();

        // Show modal
        document.getElementById('variable-editor-modal').classList.remove('hidden');
    }

    function closeVariableEditor() {
        document.getElementById('variable-editor-modal').classList.add('hidden');
        editingVariable = null;
    }

    function handleVariableTypeChange() {
        const type = document.getElementById('variable-type').value;
        const queryFields = document.getElementById('query-fields');
        const customFields = document.getElementById('custom-fields');
        const defaultValueField = document.getElementById('default-value-field');

        // Hide all conditional fields first
        queryFields.classList.add('hidden');
        customFields.classList.add('hidden');
        defaultValueField.classList.add('hidden');

        // Show relevant fields based on type
        if (type === 'query') {
            queryFields.classList.remove('hidden');
        } else if (type === 'custom') {
            customFields.classList.remove('hidden');
            defaultValueField.classList.remove('hidden');
        } else if (type === 'constant' || type === 'textbox') {
            defaultValueField.classList.remove('hidden');
        }
    }

    function handleIncludeAllChange() {
        const includeAll = document.getElementById('variable-include-all').checked;
        const allValueField = document.getElementById('all-value-field');

        if (includeAll) {
            allValueField.classList.remove('hidden');
        } else {
            allValueField.classList.add('hidden');
        }
    }

    async function saveVariable(event) {
        event.preventDefault();

        const variableId = document.getElementById('variable-id').value;
        const type = document.getElementById('variable-type').value;

        // Build request data
        const data = {
            name: document.getElementById('variable-name').value,
            label: document.getElementById('variable-label').value || document.getElementById('variable-name').value,
            type: type,
            multi_select: document.getElementById('variable-multi-select').checked,
            include_all: document.getElementById('variable-include-all').checked,
            hide: parseInt(document.getElementById('variable-hide').value),
            sort: parseInt(document.getElementById('variable-sort').value)
        };

        // Add type-specific fields
        if (type === 'query') {
            data.datasource_id = document.getElementById('variable-datasource').value;
            data.query = document.getElementById('variable-query').value;
            data.regex = document.getElementById('variable-regex').value || null;
        } else if (type === 'custom') {
            const customValues = document.getElementById('variable-custom-values').value
                .split('\n')
                .map(v => v.trim())
                .filter(v => v.length > 0);
            data.custom_values = customValues;
            data.default_value = document.getElementById('variable-default-value').value || null;
        } else if (type === 'constant' || type === 'textbox') {
            data.default_value = document.getElementById('variable-default-value').value || null;
        }

        if (data.include_all) {
            data.all_value = document.getElementById('variable-all-value').value || '.*';
        }

        try {
            let response;
            if (variableId) {
                // Update existing variable
                response = await fetch(`/api/dashboards/${dashboardId}/variables/${variableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new variable
                response = await fetch(`/api/dashboards/${dashboardId}/variables`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save variable');
            }

            showToast(variableId ? 'Variable updated successfully' : 'Variable created successfully', 'success');
            closeVariableEditor();
            await loadVariables();
            renderVariablesTable();
            renderVariables(); // Update header dropdowns
        } catch (error) {
            console.error('Error saving variable:', error);
            showToast(error.message || 'Failed to save variable', 'error');
        }
    }

    function editVariable(variableId) {
        showVariableEditor(variableId);
    }

    async function deleteVariable(variableId) {
        const variable = variables.find(v => v.id === variableId);
        if (!variable) return;

        if (!confirm(`Delete variable "${variable.name}"?`)) return;

        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/variables/${variableId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete variable');
            }

            showToast('Variable deleted successfully', 'success');
            await loadVariables();
            renderVariablesTable();
            renderVariables(); // Update header dropdowns
        } catch (error) {
            console.error('Error deleting variable:', error);
            showToast('Failed to delete variable', 'error');
        }
    }

    // Time Picker Functions
    function showTimePickerModal() {
        document.getElementById('time-picker-modal').classList.remove('hidden');
    }

    function closeTimePickerModal() {
        document.getElementById('time-picker-modal').classList.add('hidden');
    }

    function switchTimeTab(tab) {
        const relativePanel = document.getElementById('relative-time-panel');
        const absolutePanel = document.getElementById('absolute-time-panel');
        const relativeTab = document.getElementById('tab-relative');
        const absoluteTab = document.getElementById('tab-absolute');

        if (tab === 'relative') {
            relativePanel.classList.remove('hidden');
            absolutePanel.classList.add('hidden');
            relativeTab.classList.add('bg-blue-600', 'text-white');
            relativeTab.classList.remove('bg-gray-700', 'text-gray-300');
            absoluteTab.classList.remove('bg-blue-600', 'text-white');
            absoluteTab.classList.add('bg-gray-700', 'text-gray-300');
            currentTimeRange.mode = 'relative';
        } else {
            relativePanel.classList.add('hidden');
            absolutePanel.classList.remove('hidden');
            absoluteTab.classList.add('bg-blue-600', 'text-white');
            absoluteTab.classList.remove('bg-gray-700', 'text-gray-300');
            relativeTab.classList.remove('bg-blue-600', 'text-white');
            relativeTab.classList.add('bg-gray-700', 'text-gray-300');
            currentTimeRange.mode = 'absolute';
        }
    }

    function selectQuickRange(range) {
        currentTimeRange.mode = 'quick';
        currentTimeRange.value = range;

        // Update display
        const rangeMap = {
            '5m': 'Last 5 minutes',
            '15m': 'Last 15 minutes',
            '30m': 'Last 30 minutes',
            '1h': 'Last 1 hour',
            '3h': 'Last 3 hours',
            '6h': 'Last 6 hours',
            '12h': 'Last 12 hours',
            '24h': 'Last 24 hours',
            '2d': 'Last 2 days',
            '7d': 'Last 7 days',
            '30d': 'Last 30 days',
            '90d': 'Last 90 days'
        };
        currentTimeRange.display = rangeMap[range] || range;

        // Update relative inputs
        document.getElementById('relative-from').value = `now-${range}`;
        document.getElementById('relative-to').value = 'now';

        // Highlight selected button
        document.querySelectorAll('.quick-range-btn').forEach(btn => {
            btn.classList.remove('bg-gray-700');
        });
        event.target.classList.add('bg-gray-700');
    }

    function selectRefreshInterval(seconds) {
        customRefreshIntervalSeconds = seconds;

        // Highlight selected button
        document.querySelectorAll('.refresh-interval-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-700');
        });
        event.target.classList.remove('bg-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');

        // Clear custom input if preset is selected
        if (seconds > 0) {
            document.getElementById('custom-refresh-interval').value = '';
        }
    }

    function applyTimeRange() {
        // Get values based on mode
        if (currentTimeRange.mode === 'relative') {
            currentTimeRange.from = document.getElementById('relative-from').value;
            currentTimeRange.to = document.getElementById('relative-to').value;
            currentTimeRange.display = `${currentTimeRange.from} to ${currentTimeRange.to}`;
        } else if (currentTimeRange.mode === 'absolute') {
            const fromInput = document.getElementById('absolute-from').value;
            const toInput = document.getElementById('absolute-to').value;
            if (fromInput && toInput) {
                currentTimeRange.from = new Date(fromInput).toISOString();
                currentTimeRange.to = new Date(toInput).toISOString();
                currentTimeRange.display = `${new Date(fromInput).toLocaleString()} to ${new Date(toInput).toLocaleString()}`;
            }
        }

        // Apply custom refresh interval if specified
        const customInterval = document.getElementById('custom-refresh-interval').value;
        if (customInterval && parseInt(customInterval) > 0) {
            customRefreshIntervalSeconds = parseInt(customInterval);
        }

        // Update display
        document.getElementById('time-range-display').textContent = currentTimeRange.display;

        // Start auto-refresh if enabled
        startCustomAutoRefresh();

        // Refresh panels
        refreshAllPanels();

        // Close modal
        closeTimePickerModal();
    }

    function startCustomAutoRefresh() {
        // Clear existing countdown timer
        if (refreshCountdownTimer) {
            clearInterval(refreshCountdownTimer);
            refreshCountdownTimer = null;
        }

        // Clear existing auto-refresh
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        const countdownEl = document.getElementById('refresh-countdown');
        const refreshTextEl = document.getElementById('refresh-text');

        if (customRefreshIntervalSeconds > 0) {
            // Show countdown
            countdownEl.classList.remove('hidden');
            refreshCountdownSeconds = customRefreshIntervalSeconds;

            // Start countdown timer
            refreshCountdownTimer = setInterval(() => {
                refreshCountdownSeconds--;
                countdownEl.textContent = `(${refreshCountdownSeconds}s)`;

                if (refreshCountdownSeconds <= 0) {
                    refreshCountdownSeconds = customRefreshIntervalSeconds;
                    refreshAllPanels();
                }
            }, 1000);

            // Initial countdown display
            countdownEl.textContent = `(${refreshCountdownSeconds}s)`;
        } else {
            // Hide countdown
            countdownEl.classList.add('hidden');
        }
    }

    function getTimeRangeBounds() {
        const now = new Date();

        if (currentTimeRange.mode === 'quick') {
            const duration = parseTimeRange(currentTimeRange.value);
            return {
                start: new Date(now.getTime() - duration),
                end: now
            };
        } else if (currentTimeRange.mode === 'relative') {
            return {
                start: parseRelativeTime(currentTimeRange.from),
                end: parseRelativeTime(currentTimeRange.to)
            };
        } else if (currentTimeRange.mode === 'absolute') {
            return {
                start: new Date(currentTimeRange.from),
                end: new Date(currentTimeRange.to)
            };
        }

        // Default fallback
        return {
            start: new Date(now.getTime() - 24 * 60 * 60 * 1000),
            end: now
        };
    }

    function parseRelativeTime(relativeString) {
        if (relativeString === 'now') {
            return new Date();
        }

        // Match pattern like "now-24h", "now-7d", "now-30m"
        const match = relativeString.match(/^now-(\d+)([mhd])$/);
        if (!match) {
            return new Date();
        }

        const value = parseInt(match[1]);
        const unit = match[2];
        const now = new Date();

        const units = {
            'm': 60 * 1000,
            'h': 60 * 60 * 1000,
            'd': 24 * 60 * 60 * 1000
        };

        return new Date(now.getTime() - value * units[unit]);
    }

    // Panel Inspector Functions
    function inspectPanel(panelId) {
        const panelData = panelInspectorData[panelId];
        const panelItem = panels.find(p => (p.panel_id || p.id) === panelId);

        if (!panelData || !panelItem) {
            showToast('No data available for inspection', 'error');
            return;
        }

        // Set panel name
        const panelName = panelItem.panel_name || panelItem.name || 'Unnamed Panel';
        document.getElementById('inspector-panel-name').textContent = `- ${panelName}`;

        // Populate Query tab
        const originalQuery = panelItem.promql_query || '';
        const executedQuery = panelData.executedQuery || originalQuery;
        document.getElementById('inspector-original-query').textContent = originalQuery;
        document.getElementById('inspector-executed-query').textContent = executedQuery;

        const { start, end } = panelData.timeRange || {};
        document.getElementById('inspector-time-from').textContent = start ? new Date(start).toLocaleString() : '-';
        document.getElementById('inspector-time-to').textContent = end ? new Date(end).toLocaleString() : '-';

        // Populate Stats tab
        const data = panelData.rawResponse?.data || [];
        let totalDataPoints = 0;
        data.forEach(series => {
            totalDataPoints += (series.values || []).length;
        });

        document.getElementById('inspector-exec-time').textContent = panelData.executionTime ? `${panelData.executionTime}ms` : '-';
        document.getElementById('inspector-data-points').textContent = totalDataPoints.toLocaleString();
        document.getElementById('inspector-series-count').textContent = data.length;
        document.getElementById('inspector-response-size').textContent = panelData.responseSize || '-';

        // Populate series details
        const seriesDetails = document.getElementById('inspector-series-details');
        seriesDetails.innerHTML = '';
        data.forEach((series, idx) => {
            const metricLabels = Object.entries(series.metric || {})
                .map(([key, value]) => `${key}="${value}"`)
                .join(', ');
            const dataPointCount = (series.values || []).length;

            seriesDetails.innerHTML += `
                <div class="bg-gray-800 p-3 rounded text-xs">
                    <div class="text-gray-400 mb-1">Series ${idx + 1}</div>
                    <div class="text-white font-mono">{${metricLabels}}</div>
                    <div class="text-gray-500 mt-1">${dataPointCount} data points</div>
                </div>
            `;
        });

        // Populate JSON tab
        const jsonContent = JSON.stringify(panelData.rawResponse, null, 2);
        document.getElementById('inspector-json-content').textContent = jsonContent;

        // Populate Data table
        renderInspectorDataTable(data);

        // Show modal
        document.getElementById('panel-inspector-modal').classList.remove('hidden');
        switchInspectorTab('query');
    }

    function closeInspectorModal() {
        document.getElementById('panel-inspector-modal').classList.add('hidden');
    }

    function switchInspectorTab(tab) {
        // Update tab buttons
        const tabs = ['query', 'stats', 'json', 'data'];
        tabs.forEach(t => {
            const btn = document.getElementById(`inspector-tab-${t}`);
            const panel = document.getElementById(`inspector-panel-${t}`);

            if (t === tab) {
                btn.classList.add('border-blue-500', 'text-blue-400');
                btn.classList.remove('border-transparent', 'text-gray-400');
                panel.classList.remove('hidden');
            } else {
                btn.classList.remove('border-blue-500', 'text-blue-400');
                btn.classList.add('border-transparent', 'text-gray-400');
                panel.classList.add('hidden');
            }
        });
    }

    function renderInspectorDataTable(data) {
        const container = document.getElementById('inspector-data-table');

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="p-8 text-center text-gray-400">No data available</div>';
            return;
        }

        let html = '<table class="w-full text-xs"><thead class="bg-gray-800 sticky top-0"><tr>';
        html += '<th class="px-3 py-2 text-left text-gray-300">Time</th>';

        // Create column for each series
        data.forEach((series, idx) => {
            const labels = Object.entries(series.metric || {})
                .map(([k, v]) => `${k}="${v}"`)
                .join(', ');
            html += `<th class="px-3 py-2 text-left text-gray-300">Series ${idx + 1}<br/><span class="text-gray-500 font-normal">{${labels}}</span></th>`;
        });

        html += '</tr></thead><tbody class="divide-y divide-gray-800">';

        // Collect all unique timestamps
        const timestamps = new Set();
        data.forEach(series => {
            (series.values || []).forEach(([ts]) => timestamps.add(ts));
        });

        const sortedTimestamps = Array.from(timestamps).sort((a, b) => b - a); // Descending

        // Render rows
        sortedTimestamps.slice(0, 1000).forEach(ts => { // Limit to 1000 rows
            html += '<tr class="hover:bg-gray-800/50">';
            html += `<td class="px-3 py-2 text-gray-400">${new Date(ts * 1000).toLocaleString()}</td>`;

            data.forEach(series => {
                const value = (series.values || []).find(([t]) => t === ts);
                const displayValue = value ? parseFloat(value[1]).toFixed(4) : '-';
                html += `<td class="px-3 py-2 text-gray-300 font-mono">${displayValue}</td>`;
            });

            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy to clipboard', 'error');
        });
    }

    // Alerts Functions
    async function loadAlerts() {
        try {
            // Fetch alerts from Prometheus AlertManager via our API
            const response = await fetch('/api/alerts');

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            allAlerts = data.alerts || [];
            alerts = allAlerts;

            // Update badge count
            updateAlertsBadge();

            return alerts;
        } catch (error) {
            console.error('Error loading alerts:', error);
            return [];
        }
    }

    async function showAlertsModal() {
        document.getElementById('alerts-modal').classList.remove('hidden');
        document.getElementById('alerts-loading').classList.remove('hidden');
        document.getElementById('alerts-list').classList.add('hidden');
        document.getElementById('alerts-empty').classList.add('hidden');
        document.getElementById('alerts-error').classList.add('hidden');

        try {
            await loadAlerts();
            renderAlerts();

            // Auto-refresh alerts every 30 seconds
            if (alertsRefreshTimer) {
                clearInterval(alertsRefreshTimer);
            }
            alertsRefreshTimer = setInterval(async () => {
                await loadAlerts();
                renderAlerts();
            }, 30000);
        } catch (error) {
            document.getElementById('alerts-loading').classList.add('hidden');
            document.getElementById('alerts-error').classList.remove('hidden');
            document.getElementById('alerts-error-message').textContent = error.message;
        }
    }

    function closeAlertsModal() {
        document.getElementById('alerts-modal').classList.add('hidden');

        // Stop auto-refresh
        if (alertsRefreshTimer) {
            clearInterval(alertsRefreshTimer);
            alertsRefreshTimer = null;
        }
    }

    function renderAlerts() {
        document.getElementById('alerts-loading').classList.add('hidden');

        // Count alerts by state
        let firingCount = 0;
        let pendingCount = 0;
        let silencedCount = 0;

        alerts.forEach(alert => {
            if (alert.status?.state === 'firing') {
                firingCount++;
            } else if (alert.status?.state === 'pending') {
                pendingCount++;
            }
            if (alert.status?.silencedBy?.length > 0 || alert.status?.inhibitedBy?.length > 0) {
                silencedCount++;
            }
        });

        document.getElementById('alert-count-firing').textContent = firingCount;
        document.getElementById('alert-count-pending').textContent = pendingCount;
        document.getElementById('alert-count-silenced').textContent = silencedCount;

        const container = document.getElementById('alerts-list');

        if (alerts.length === 0) {
            document.getElementById('alerts-list').classList.add('hidden');
            document.getElementById('alerts-empty').classList.remove('hidden');
            return;
        }

        document.getElementById('alerts-list').classList.remove('hidden');
        document.getElementById('alerts-empty').classList.add('hidden');

        container.innerHTML = '';

        alerts.forEach(alert => {
            const alertEl = createAlertElement(alert);
            container.appendChild(alertEl);
        });
    }

    function createAlertElement(alert) {
        const div = document.createElement('div');
        const state = alert.status?.state || 'unknown';
        const isSilenced = (alert.status?.silencedBy?.length > 0 || alert.status?.inhibitedBy?.length > 0);

        let stateColor = 'gray';
        let stateIcon = 'question-circle';

        if (state === 'firing') {
            stateColor = 'red';
            stateIcon = 'exclamation-circle';
        } else if (state === 'pending') {
            stateColor = 'yellow';
            stateIcon = 'clock';
        }

        if (isSilenced) {
            stateColor = 'gray';
            stateIcon = 'bell-slash';
        }

        div.className = `bg-gray-700/50 border-l-4 border-${stateColor}-500 rounded p-4 hover:bg-gray-700 transition-colors`;

        const alertName = alert.labels?.alertname || 'Unknown Alert';
        const severity = alert.labels?.severity || 'unknown';
        const instance = alert.labels?.instance || alert.labels?.job || 'N/A';
        const description = alert.annotations?.description || alert.annotations?.summary || 'No description available';
        const startsAt = new Date(alert.startsAt).toLocaleString();

        div.innerHTML = `
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-${stateIcon} text-${stateColor}-400"></i>
                        <span class="font-semibold text-white">${escapeHtml(alertName)}</span>
                        <span class="px-2 py-0.5 rounded text-xs ${severity === 'critical' ? 'bg-red-700' : severity === 'warning' ? 'bg-yellow-700' : 'bg-gray-600'} text-white">
                            ${escapeHtml(severity)}
                        </span>
                        <span class="text-xs text-gray-400">${state.toUpperCase()}</span>
                        ${isSilenced ? '<span class="text-xs text-gray-400"><i class="fas fa-bell-slash"></i> Silenced</span>' : ''}
                    </div>
                    <p class="text-sm text-gray-300 mb-2">${escapeHtml(description)}</p>
                    <div class="flex gap-4 text-xs text-gray-400">
                        <span><i class="fas fa-server mr-1"></i>${escapeHtml(instance)}</span>
                        <span><i class="fas fa-clock mr-1"></i>${startsAt}</span>
                    </div>
                </div>
                <button onclick="showAlertDetails('${alert.fingerprint}')" class="text-blue-400 hover:text-blue-300 text-sm ml-4">
                    Details
                </button>
            </div>
            ${alert.labels ? `
                <div class="mt-3 pt-3 border-t border-gray-600">
                    <details class="text-xs">
                        <summary class="cursor-pointer text-gray-400 hover:text-gray-300">Labels & Annotations</summary>
                        <div class="mt-2 space-y-1">
                            ${Object.entries(alert.labels).map(([key, value]) =>
            `<div><span class="text-gray-500">${escapeHtml(key)}:</span> <span class="text-gray-300">${escapeHtml(value)}</span></div>`
        ).join('')}
                        </div>
                    </details>
                </div>
            ` : ''}
        `;

        return div;
    }

    function filterAlerts() {
        const searchTerm = document.getElementById('alert-search').value.toLowerCase();
        const statusFilter = document.getElementById('alert-status-filter').value;

        alerts = allAlerts.filter(alert => {
            // Search filter
            const matchesSearch = !searchTerm ||
                (alert.labels?.alertname || '').toLowerCase().includes(searchTerm) ||
                (alert.labels?.instance || '').toLowerCase().includes(searchTerm) ||
                (alert.annotations?.description || '').toLowerCase().includes(searchTerm);

            // Status filter
            const state = alert.status?.state || 'unknown';
            const isSilenced = (alert.status?.silencedBy?.length > 0 || alert.status?.inhibitedBy?.length > 0);

            let matchesStatus = statusFilter === 'all';
            if (statusFilter === 'firing') matchesStatus = state === 'firing' && !isSilenced;
            if (statusFilter === 'pending') matchesStatus = state === 'pending' && !isSilenced;
            if (statusFilter === 'silenced') matchesStatus = isSilenced;

            return matchesSearch && matchesStatus;
        });

        renderAlerts();
    }

    function showAlertDetails(fingerprint) {
        const alert = allAlerts.find(a => a.fingerprint === fingerprint);
        if (!alert) return;

        const details = `
Alert: ${alert.labels?.alertname || 'Unknown'}
State: ${alert.status?.state || 'unknown'}
Severity: ${alert.labels?.severity || 'unknown'}
Instance: ${alert.labels?.instance || 'N/A'}

Description:
${alert.annotations?.description || alert.annotations?.summary || 'No description'}

Started: ${new Date(alert.startsAt).toLocaleString()}
${alert.endsAt ? `Ended: ${new Date(alert.endsAt).toLocaleString()}` : ''}

Labels:
${Object.entries(alert.labels || {}).map(([k, v]) => `  ${k}: ${v}`).join('\n')}

${alert.annotations ? `Annotations:
${Object.entries(alert.annotations).map(([k, v]) => `  ${k}: ${v}`).join('\n')}` : ''}
        `;

        alert(details);
    }

    function updateAlertsBadge() {
        const firingAlerts = allAlerts.filter(a =>
            a.status?.state === 'firing' &&
            !(a.status?.silencedBy?.length > 0 || a.status?.inhibitedBy?.length > 0)
        );

        const badge = document.getElementById('alerts-badge');
        if (firingAlerts.length > 0) {
            badge.textContent = firingAlerts.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Load alerts on dashboard load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadAlerts();
    });

    // ===== ANNOTATIONS FUNCTIONS =====

    async function loadAnnotations() {
        try {
            const response = await fetch(`/api/annotations?dashboard_id=${dashboardId}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            annotations = data || [];
            return annotations;
        } catch (error) {
            console.error('Error loading annotations:', error);
            return [];
        }
    }

    async function showAnnotationsModal() {
        document.getElementById('annotations-modal').classList.remove('hidden');
        document.getElementById('annotations-loading').classList.remove('hidden');
        document.getElementById('annotations-list').classList.add('hidden');
        document.getElementById('annotations-empty').classList.add('hidden');

        try {
            await loadAnnotations();
            renderAnnotations();
        } catch (error) {
            console.error('Error loading annotations:', error);
        }
    }

    function hideAnnotationsModal() {
        document.getElementById('annotations-modal').classList.add('hidden');
        hideAnnotationForm();
    }

    function showCreateAnnotationForm() {
        editingAnnotation = null;
        document.getElementById('annotation-form-title').textContent = 'Create Annotation';
        document.getElementById('annotation-id').value = '';
        document.getElementById('annotation-title').value = '';
        document.getElementById('annotation-time').value = getLocalDateTimeString();
        document.getElementById('annotation-time-end').value = '';
        document.getElementById('annotation-text').value = '';
        document.getElementById('annotation-tags').value = '';
        document.getElementById('annotation-color').value = '#FF6B6B';
        document.getElementById('annotation-form').classList.remove('hidden');
    }

    function hideAnnotationForm() {
        document.getElementById('annotation-form').classList.add('hidden');
        editingAnnotation = null;
    }

    function editAnnotation(annotation) {
        editingAnnotation = annotation;
        document.getElementById('annotation-form-title').textContent = 'Edit Annotation';
        document.getElementById('annotation-id').value = annotation.id;
        document.getElementById('annotation-title').value = annotation.title || '';
        document.getElementById('annotation-time').value = getLocalDateTimeString(new Date(annotation.time));
        document.getElementById('annotation-time-end').value = annotation.time_end ? getLocalDateTimeString(new Date(annotation.time_end)) : '';
        document.getElementById('annotation-text').value = annotation.text;
        document.getElementById('annotation-tags').value = (annotation.tags || []).join(', ');
        document.getElementById('annotation-color').value = annotation.color || '#FF6B6B';
        document.getElementById('annotation-form').classList.remove('hidden');
        document.getElementById('annotation-form').scrollIntoView({ behavior: 'smooth' });
    }

    async function saveAnnotation(event) {
        event.preventDefault();

        const annotationId = document.getElementById('annotation-id').value;
        const title = document.getElementById('annotation-title').value.trim();
        const time = document.getElementById('annotation-time').value;
        const timeEnd = document.getElementById('annotation-time-end').value;
        const text = document.getElementById('annotation-text').value.trim();
        const tagsInput = document.getElementById('annotation-tags').value.trim();
        const color = document.getElementById('annotation-color').value;

        const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

        const annotationData = {
            dashboard_id: dashboardId,
            time: new Date(time).toISOString(),
            time_end: timeEnd ? new Date(timeEnd).toISOString() : null,
            text: text,
            title: title || null,
            tags: tags,
            color: color
        };

        try {
            let response;
            if (annotationId) {
                // Update existing annotation
                response = await fetch(`/api/annotations/${annotationId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotationData)
                });
            } else {
                // Create new annotation
                response = await fetch('/api/annotations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotationData)
                });
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            await loadAnnotations();
            renderAnnotations();
            hideAnnotationForm();

            // Refresh charts to show new annotation
            await refreshAllCharts();

        } catch (error) {
            console.error('Error saving annotation:', error);
            alert('Failed to save annotation');
        }
    }

    async function deleteAnnotation(annotationId) {
        if (!confirm('Are you sure you want to delete this annotation?')) {
            return;
        }

        try {
            const response = await fetch(`/api/annotations/${annotationId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            await loadAnnotations();
            renderAnnotations();

            // Refresh charts to remove annotation
            await refreshAllCharts();

        } catch (error) {
            console.error('Error deleting annotation:', error);
            alert('Failed to delete annotation');
        }
    }

    function renderAnnotations() {
        document.getElementById('annotations-loading').classList.add('hidden');

        if (annotations.length === 0) {
            document.getElementById('annotations-empty').classList.remove('hidden');
            document.getElementById('annotations-list').classList.add('hidden');
            return;
        }

        document.getElementById('annotations-empty').classList.add('hidden');
        document.getElementById('annotations-list').classList.remove('hidden');

        const container = document.getElementById('annotations-list');
        container.innerHTML = '';

        annotations.forEach(annotation => {
            const card = createAnnotationCard(annotation);
            container.appendChild(card);
        });
    }

    function createAnnotationCard(annotation) {
        const div = document.createElement('div');
        div.className = 'bg-gray-700 rounded-lg p-4 border-l-4';
        div.style.borderLeftColor = annotation.color || '#FF6B6B';

        const time = new Date(annotation.time).toLocaleString();
        const timeEnd = annotation.time_end ? ` - ${new Date(annotation.time_end).toLocaleString()}` : '';

        const tagsHtml = annotation.tags && annotation.tags.length > 0
            ? `<div class="flex flex-wrap gap-2 mt-2">
                ${annotation.tags.map(tag => `<span class="px-2 py-1 bg-gray-600 rounded text-xs">${tag}</span>`).join('')}
               </div>`
            : '';

        div.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1">
                    ${annotation.title ? `<h4 class="font-bold text-white mb-1">${annotation.title}</h4>` : ''}
                    <p class="text-gray-300">${annotation.text}</p>
                </div>
                <div class="flex gap-2 ml-4">
                    <button onclick="editAnnotation(${JSON.stringify(annotation).replace(/"/g, '&quot;')})"
                            class="text-blue-400 hover:text-blue-300 transition">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="deleteAnnotation('${annotation.id}')"
                            class="text-red-400 hover:text-red-300 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="text-sm text-gray-400">
                <i class="fas fa-clock mr-1"></i>
                ${time}${timeEnd}
            </div>
            ${tagsHtml}
        `;

        return div;
    }

    // Load annotations on dashboard load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadAnnotations();
    });

    // ===== EXPORT/IMPORT FUNCTIONS =====

    async function exportDashboard() {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/export`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();

            // Download as JSON file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-${dashboardId}-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

        } catch (error) {
            console.error('Error exporting dashboard:', error);
            alert('Failed to export dashboard');
        }
    }

    function showImportModal() {
        document.getElementById('import-modal').classList.remove('hidden');
        document.getElementById('import-json').value = '';
        document.getElementById('import-file').value = '';
        document.getElementById('import-error').classList.add('hidden');
        document.getElementById('import-success').classList.add('hidden');
    }

    function hideImportModal() {
        document.getElementById('import-modal').classList.add('hidden');
    }

    // Handle file upload
    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('import-file');
        if (fileInput) {
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        document.getElementById('import-json').value = event.target.result;
                    };
                    reader.readAsText(file);
                }
            });
        }
    });

    async function importDashboard() {
        const jsonText = document.getElementById('import-json').value.trim();
        const errorDiv = document.getElementById('import-error');
        const successDiv = document.getElementById('import-success');

        errorDiv.classList.add('hidden');
        successDiv.classList.add('hidden');

        if (!jsonText) {
            errorDiv.textContent = 'Please provide JSON data to import';
            errorDiv.classList.remove('hidden');
            return;
        }

        try {
            const importData = JSON.parse(jsonText);

            const response = await fetch('/api/dashboards/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(importData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Import failed');
            }

            const newDashboard = await response.json();

            successDiv.textContent = `Dashboard imported successfully! Redirecting...`;
            successDiv.classList.remove('hidden');

            // Redirect to new dashboard after 2 seconds
            setTimeout(() => {
                window.location.href = `/dashboards/${newDashboard.id}`;
            }, 2000);

        } catch (error) {
            console.error('Error importing dashboard:', error);
            errorDiv.textContent = `Import failed: ${error.message}`;
            errorDiv.classList.remove('hidden');
        }
    }

    // ===== KIOSK MODE FUNCTIONS =====

    // Check for kiosk mode on load
    const urlParams = new URLSearchParams(window.location.search);
    const isKioskMode = urlParams.get('kiosk') === 'true' || urlParams.get('kiosk') === '1';

    function initKioskMode() {
        if (isKioskMode) {
            document.body.classList.add('kiosk-mode');
        }
    }

    function toggleKioskMode() {
        const url = new URL(window.location.href);
        if (isKioskMode || document.body.classList.contains('kiosk-mode')) {
            // Exit kiosk mode
            url.searchParams.delete('kiosk');
            window.location.href = url.toString();
        } else {
            // Enter kiosk mode
            url.searchParams.set('kiosk', 'true');
            window.location.href = url.toString();
        }
    }

    // Handle window resize
    window.addEventListener('resize', () => {
        Object.values(charts).forEach(chart => chart.resize());
    });

    // Initialize kiosk mode
    initKioskMode();

    // ===== DASHBOARD LINKS FUNCTIONS =====

    let dashboardLinks = [];

    async function loadDashboardLinks() {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/links`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            dashboardLinks = await response.json();
            renderDashboardLinks();
        } catch (error) {
            console.error('Error loading dashboard links:', error);
        }
    }

    function renderDashboardLinks() {
        const linksDropdown = document.getElementById('links-dropdown');
        const linksList = document.getElementById('links-list');

        if (dashboardLinks.length === 0) {
            linksDropdown.classList.add('hidden');
            return;
        }

        linksDropdown.classList.remove('hidden');
        linksList.innerHTML = '';

        dashboardLinks.forEach(link => {
            const linkElement = document.createElement('a');
            linkElement.href = link.url;
            if (link.open_in_new_tab) {
                linkElement.target = '_blank';
                linkElement.rel = 'noopener noreferrer';
            }
            linkElement.className = 'block px-3 py-2 hover:bg-gray-700 rounded text-white text-sm flex items-center gap-2';

            const icon = link.icon || 'link';
            linkElement.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${link.title}</span>
                ${link.open_in_new_tab ? '<i class="fas fa-external-link-alt text-xs ml-auto"></i>' : ''}
            `;

            linksList.appendChild(linkElement);
        });
    }

    // Links menu integrated into "More Actions" - obsolete toggles removed.


    // Load dashboard links on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadDashboardLinks();
    });

    // ===== SNAPSHOTS FUNCTIONS =====

    let dashboardSnapshots = [];

    async function loadSnapshots() {
        try {
            const response = await fetch(`/api/snapshots/dashboard/${dashboardId}/list`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            dashboardSnapshots = await response.json();
            renderSnapshots();
        } catch (error) {
            console.error('Error loading snapshots:', error);
            dashboardSnapshots = [];
            renderSnapshots();
        }
    }

    function showSnapshotModal() {
        document.getElementById('snapshot-modal').classList.remove('hidden');
        document.getElementById('snapshots-loading').classList.remove('hidden');
        loadSnapshots();
    }

    function hideSnapshotModal() {
        document.getElementById('snapshot-modal').classList.add('hidden');
        hideSnapshotForm();
    }

    function showCreateSnapshotForm() {
        document.getElementById('snapshot-form').classList.remove('hidden');
    }

    function hideSnapshotForm() {
        document.getElementById('snapshot-form').classList.add('hidden');
    }

    async function createSnapshot(event) {
        event.preventDefault();
        const name = document.getElementById('snapshot-name').value.trim();
        const expiresDays = document.getElementById('snapshot-expires').value;

        try {
            const response = await fetch(`/api/snapshots?dashboard_id=${dashboardId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    expires_days: expiresDays ? parseInt(expiresDays) : null
                })
            });

            if (!response.ok) throw new Error('Failed to create snapshot');
            const snapshot = await response.json();
            const shareUrl = `${window.location.origin}${snapshot.share_url}`;

            try {
                await navigator.clipboard.writeText(shareUrl);
                alert(`Snapshot created! Share URL copied:\n${shareUrl}`);
            } catch (e) {
                alert(`Snapshot created! Share URL:\n${shareUrl}`);
            }

            hideSnapshotForm();
            await loadSnapshots();
        } catch (error) {
            alert('Error creating snapshot: ' + error.message);
        }
    }

    function renderSnapshots() {
        document.getElementById('snapshots-loading').classList.add('hidden');
        const container = document.getElementById('snapshots-list');

        if (dashboardSnapshots.length === 0) {
            document.getElementById('snapshots-empty').classList.remove('hidden');
            document.getElementById('snapshots-list').classList.add('hidden');
            return;
        }

        document.getElementById('snapshots-empty').classList.add('hidden');
        container.classList.remove('hidden');
        container.innerHTML = '';

        dashboardSnapshots.forEach(snapshot => {
            const shareUrl = `${window.location.origin}${snapshot.share_url}`;
            const div = document.createElement('div');
            div.className = 'bg-gray-700 rounded-lg p-4 border-l-4 border-indigo-500';
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h4 class="font-bold text-white">${snapshot.name}</h4>
                        <p class="text-gray-400 text-sm">Created: ${new Date(snapshot.created_at).toLocaleString()}</p>
                        <p class="text-gray-400 text-sm">${snapshot.expires_at ? 'Expires: ' + new Date(snapshot.expires_at).toLocaleString() : 'Never expires'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="navigator.clipboard.writeText('${shareUrl}')" class="text-blue-400 hover:text-blue-300">
                            <i class="fas fa-copy"></i>
                        </button>
                        <a href="${snapshot.share_url}" target="_blank" class="text-green-400 hover:text-green-300">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                        <button onclick="deleteSnapshot('${snapshot.id}')" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-3 p-2 bg-gray-800 rounded font-mono text-xs break-all">${shareUrl}</div>
            `;
            container.appendChild(div);
        });
    }

    async function deleteSnapshot(snapshotId) {
        if (!confirm('Delete this snapshot?')) return;
        try {
            await fetch(`/api/snapshots/${snapshotId}`, { method: 'DELETE' });
            await loadSnapshots();
        } catch (error) {
            alert('Failed to delete snapshot');
        }
    }

    // ==== Panel Rows Management ====
    let dashboardRows = [];

    async function loadRows() {
        try {
            document.getElementById('rows-loading').classList.remove('hidden');
            document.getElementById('rows-list').classList.add('hidden');
            document.getElementById('rows-empty').classList.add('hidden');

            const response = await fetch(`/api/dashboards/${dashboardId}/rows`);
            dashboardRows = await response.json();
            renderRows();
        } catch (error) {
            console.error('Error loading rows:', error);
            document.getElementById('rows-loading').classList.add('hidden');
            document.getElementById('rows-empty').classList.remove('hidden');
        }
    }

    function renderRows() {
        const container = document.getElementById('rows-list');
        const empty = document.getElementById('rows-empty');
        const loading = document.getElementById('rows-loading');

        loading.classList.add('hidden');

        if (dashboardRows.length === 0) {
            container.classList.add('hidden');
            empty.classList.remove('hidden');
            return;
        }

        container.classList.remove('hidden');
        empty.classList.add('hidden');

        // Sort by order
        dashboardRows.sort((a, b) => a.order - b.order);

        container.innerHTML = dashboardRows.map(row => `
            <div class="bg-gray-700 rounded-lg p-4 border-l-4 ${row.is_section_header ? 'border-purple-500' : (row.is_collapsed ? 'border-gray-500' : 'border-indigo-500')}">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-${row.is_section_header ? 'heading' : 'grip-vertical'} text-gray-500"></i>
                            <h4 class="font-bold text-white">${row.title}</h4>
                            ${row.is_collapsed && !row.is_section_header ? '<span class="text-xs bg-gray-600 px-2 py-1 rounded">Collapsed</span>' : ''}
                            ${row.is_section_header ? '<span class="text-xs bg-purple-900 text-purple-200 px-2 py-1 rounded">Section Header</span>' : ''}
                        </div>
                        ${row.description ? `<p class="text-gray-400 text-sm mt-1 ml-6">${row.description}</p>` : ''}
                        <p class="text-gray-500 text-xs mt-1 ml-6">Order: ${row.order}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editRow('${row.id}')"
                            class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePanelRow('${row.id}')"
                            class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function showRowsModal() {
        document.getElementById('rows-modal').classList.remove('hidden');
        loadRows();
    }

    function hideRowsModal() {
        document.getElementById('rows-modal').classList.add('hidden');
        hideRowForm();
    }

    function showCreateRowForm() {
        document.getElementById('row-form-title').textContent = 'Create New Row';
        document.getElementById('row-form').classList.remove('hidden');
        document.getElementById('row-id').value = '';
        document.getElementById('row-title').value = '';
        document.getElementById('row-description').value = '';
        document.getElementById('row-order').value = dashboardRows.length;
        document.getElementById('row-collapsed').checked = false;
        document.getElementById('row-section-header').checked = false;
        handleSectionHeaderToggle();
        document.getElementById('row-title').focus();
    }

    function hideRowForm() {
        document.getElementById('row-form').classList.add('hidden');
    }

    async function saveRow(event) {
        event.preventDefault();

        const rowId = document.getElementById('row-id').value;
        const data = {
            title: document.getElementById('row-title').value,
            description: document.getElementById('row-description').value || null,
            order: parseInt(document.getElementById('row-order').value),
            is_collapsed: document.getElementById('row-collapsed').checked,
            is_section_header: document.getElementById('row-section-header').checked
        };

        try {
            let response;
            if (rowId) {
                // Update existing row
                response = await fetch(`/api/dashboards/${dashboardId}/rows/${rowId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new row
                response = await fetch(`/api/dashboards/${dashboardId}/rows`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                hideRowForm();
                await loadRows();
                await loadDashboardPanels(); // Reload panels to reflect row changes
            } else {
                const error = await response.json();
                alert(`Error: ${error.detail || 'Failed to save row'}`);
            }
        } catch (error) {
            console.error('Error saving row:', error);
            alert('Failed to save row');
        }
    }

    async function editRow(rowId) {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/rows/${rowId}`);
            const row = await response.json();

            document.getElementById('row-form-title').textContent = 'Edit Row';
            document.getElementById('row-id').value = row.id;
            document.getElementById('row-title').value = row.title;
            document.getElementById('row-description').value = row.description || '';
            document.getElementById('row-order').value = row.order;
            document.getElementById('row-collapsed').checked = row.is_collapsed;
            document.getElementById('row-section-header').checked = row.is_section_header;
            handleSectionHeaderToggle();
            document.getElementById('row-form').classList.remove('hidden');
            document.getElementById('row-title').focus();
        } catch (error) {
            console.error('Error loading row:', error);
            alert('Failed to load row');
        }
    }

    let confirmationCallback = null;

    function showConfirmationModal(title, message, onConfirm) {
        document.getElementById('confirmation-title').textContent = title;
        document.getElementById('confirmation-message').textContent = message;
        confirmationCallback = onConfirm;

        const modal = document.getElementById('confirmation-modal');
        // Ensure modal is at body level to avoid z-index stacking context issues
        document.body.appendChild(modal);
        modal.classList.remove('hidden');
        modal.style.zIndex = '9999';

        // Focus confirm button for a11y
        setTimeout(() => document.getElementById('confirmation-confirm-btn').focus(), 100);
    }

    function closeConfirmationModal() {
        document.getElementById('confirmation-modal').classList.add('hidden');
        confirmationCallback = null;
    }

    // Attach click handler to confirm button once
    document.addEventListener('DOMContentLoaded', () => {
        const confirmBtn = document.getElementById('confirmation-confirm-btn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                if (confirmationCallback) confirmationCallback();
                closeConfirmationModal();
            });
        }
    });

    async function deletePanelRow(rowId) {
        showConfirmationModal(
            'Delete Row',
            'Are you sure you want to delete this row? All panels in this row will be unassigned (moved to ungrouped).',
            async () => {
                const url = `/api/dashboards/${dashboardId}/rows/${rowId}`;

                try {
                    const response = await fetch(url, { method: 'DELETE' });

                    if (response.ok) {
                        await loadRows();
                        await loadDashboardPanels();
                        showToast('Row deleted successfully', 'success');
                    } else {
                        const errText = await response.text();
                        console.error('Deletion failed:', response.status, errText);
                        alert(`Failed to delete row: ${response.status}`);
                    }
                } catch (error) {
                    console.error('Error deleting row:', error);
                    alert('Failed to delete row (network error)');
                }
            }
        );
    }


    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        Object.values(charts).forEach(chart => chart.dispose());
    });
</script>

<!-- Confirmation Modal -->
<div id="confirmation-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[200] p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h3 id="confirmation-title" class="text-xl font-bold text-primary">Confirm Action</h3>
            <button onclick="closeConfirmationModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p id="confirmation-message" class="text-secondary mb-6">Are you sure you want to proceed?</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeConfirmationModal()" class="btn-secondary px-4 py-2 rounded-lg">
                Cancel
            </button>
            <button id="confirmation-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                <i class="fas fa-check"></i>
                Confirm
            </button>
        </div>
    </div>
</div>

<!-- Snapshot Modal -->
<div id="snapshot-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg w-full max-w-3xl max-h-[90vh] overflow-y-auto m-4">
        <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-camera text-indigo-400"></i>
                    Dashboard Snapshots
                </h2>
                <button onclick="hideSnapshotModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <button onclick="showCreateSnapshotForm()" class="btn-primary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-plus mr-2"></i>
                Create Snapshot
            </button>
        </div>

        <div class="p-6">
            <!-- Create Snapshot Form -->
            <div id="snapshot-form" class="hidden mb-6 bg-gray-700 rounded-lg p-6">
                <h3 class="text-lg font-bold mb-4">Create New Snapshot</h3>
                <form onsubmit="createSnapshot(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Snapshot Name *</label>
                        <input type="text" id="snapshot-name" required
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                            placeholder="Production Snapshot - 2024-12-22">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Expires In</label>
                        <select id="snapshot-expires"
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white">
                            <option value="">Never</option>
                            <option value="1">1 day</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    <div id="snapshot-create-error"
                        class="hidden mb-4 p-4 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm"></div>
                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                            <i class="fas fa-camera mr-2"></i>
                            Create Snapshot
                        </button>
                        <button type="button" onclick="hideSnapshotForm()" class="btn-secondary px-4 py-2 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Snapshots List -->
            <div id="snapshots-list" class="space-y-3">
                <!-- Snapshots will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="snapshots-empty" class="hidden p-8 text-center">
                <i class="fas fa-camera text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">No snapshots yet</p>
                <p class="text-gray-500 text-sm mt-2">Create a snapshot to share this dashboard</p>
            </div>

            <!-- Loading State -->
            <div id="snapshots-loading" class="hidden p-8 text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400 mb-3"></i>
                <p class="text-gray-400">Loading snapshots...</p>
            </div>
        </div>
    </div>
</div>


<!-- Assign Panel to Row Modal -->
<div id="assign-row-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg w-full max-w-md m-4 p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold flex items-center gap-3">
                <i class="fas fa-layer-group text-indigo-400"></i>
                Assign Panel to Row
            </h2>
            <button onclick="closeAssignRowModal()" class="text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <input type="hidden" id="assign-row-panel-id">

        <div class="mb-4">
            <p class="text-gray-400 text-sm mb-2">Panel: <span id="assign-row-panel-name"
                    class="text-white font-medium"></span></p>
        </div>

        <div class="mb-6">
            <label class="block text-sm text-gray-400 mb-2">Select Row</label>
            <select id="assign-row-select"
                class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white">
                <option value="">-- No Row (Ungrouped) --</option>
            </select>
        </div>

        <div class="flex justify-end gap-3">
            <button onclick="closeAssignRowModal()" class="btn-secondary px-4 py-2 rounded-lg">
                Cancel
            </button>
            <button onclick="assignPanelToRow()" class="btn-primary px-4 py-2 rounded-lg">
                <i class="fas fa-check mr-2"></i>
                Assign
            </button>
        </div>
    </div>
</div>

<!-- Rows Management Modal -->
<div id="rows-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4">
        <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-bars text-indigo-400"></i>
                    Panel Rows
                </h2>
                <button onclick="hideRowsModal()" class="text-gray-400 hover:text-white transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <p class="text-gray-400 text-sm mb-4">Organize panels into collapsible row groups</p>
            <button onclick="showCreateRowForm()" class="btn-primary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-plus mr-2"></i>
                Create Row
            </button>
        </div>

        <div class="p-6">
            <!-- Create/Edit Row Form -->
            <div id="row-form" class="hidden mb-6 bg-gray-700 rounded-lg p-6">
                <h3 class="text-lg font-bold mb-4" id="row-form-title">Create New Row</h3>
                <form onsubmit="saveRow(event)">
                    <input type="hidden" id="row-id" value="">

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Row Title *</label>
                        <input type="text" id="row-title" required
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                            placeholder="e.g., System Metrics">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                        <textarea id="row-description" rows="2"
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white"
                            placeholder="Optional description"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Order</label>
                        <input type="number" id="row-order" value="0" min="0"
                            class="w-full bg-gray-600 border border-gray-500 rounded px-3 py-2 text-white">
                        <p class="text-xs text-gray-500 mt-1">Lower numbers appear first</p>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="row-section-header" class="mr-2"
                                onchange="handleSectionHeaderToggle()">
                            <span class="font-bold text-indigo-400">Title Only (Section Header)</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1 ml-6">Render as a simple section title without collapse
                            functionality</p>
                    </div>

                    <div class="mb-4" id="row-collapsed-container">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="row-collapsed" class="mr-2">
                            Start collapsed
                        </label>
                    </div>

                    <script>
                        function handleSectionHeaderToggle() {
                            const isHeader = document.getElementById('row-section-header').checked;
                            const collapsedContainer = document.getElementById('row-collapsed-container');
                            if (isHeader) {
                                collapsedContainer.classList.add('hidden');
                                document.getElementById('row-collapsed').checked = false;
                            } else {
                                collapsedContainer.classList.remove('hidden');
                            }
                        }
                    </script>

                    <div class="flex gap-2">
                        <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                            <i class="fas fa-save mr-2"></i>
                            Save Row
                        </button>
                        <button type="button" onclick="hideRowForm()" class="btn-secondary px-4 py-2 rounded-lg">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Rows List -->
            <div id="rows-list" class="space-y-3">
                <!-- Rows will be rendered here -->
            </div>

            <!-- Empty State -->
            <div id="rows-empty" class="hidden p-8 text-center">
                <i class="fas fa-bars text-4xl text-gray-600 mb-3"></i>
                <p class="text-gray-400">No rows yet</p>
                <p class="text-gray-500 text-sm mt-2">Create rows to organize your panels</p>
            </div>

            <!-- Loading State -->
            <div id="rows-loading" class="hidden p-8 text-center">
                <i class="fas fa-spinner fa-spin text-3xl text-indigo-400 mb-3"></i>
                <p class="text-gray-400">Loading rows...</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}