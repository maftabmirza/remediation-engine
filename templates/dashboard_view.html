{% extends "layout.html" %}
{% set active_page = 'dashboards' %}

{% block title %}Dashboard View - AIOps Platform{% endblock %}

{% block head %}
<!-- GridStack CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: rgb(31, 41, 55);
        border: 1px solid rgb(55, 65, 81);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .panel-drag-handle {
        cursor: move;
        padding: 0.75rem 1rem;
        background: rgb(55, 65, 81);
        border-bottom: 1px solid rgb(75, 85, 99);
        display: none;
        align-items: center;
        justify-content: space-between;
    }

    .panel-drag-handle:hover {
        background: rgb(75, 85, 99);
    }

    .grid-stack-item.editing .panel-drag-handle {
        display: flex;
    }

    .edit-mode-active .grid-stack {
        border: 2px dashed #3b82f6;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .panel-content {
        padding: 1rem;
    }

    .panel-actions {
        display: flex;
        gap: 0.5rem;
    }

    .panel-actions button {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .panel-actions button:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
            <a href="/dashboards" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 id="dashboard-title" class="text-2xl font-bold">Loading Dashboard...</h1>
                <p id="dashboard-description" class="text-gray-400 text-sm"></p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Edit Layout Toggle -->
            <button id="edit-mode-btn" onclick="toggleEditMode()"
                class="px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-700 text-sm transition-colors">
                <i class="fas fa-edit mr-2"></i>
                <span id="edit-mode-text">Edit Layout</span>
            </button>

            <button onclick="showTimePickerModal()"
                class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm hover:bg-gray-700 transition-colors flex items-center gap-2">
                <i class="fas fa-clock text-blue-400"></i>
                <span id="time-range-display">Last 24h</span>
                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
            </button>
            <button id="refresh-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                <i class="fas fa-sync-alt"></i>
                <span id="refresh-text">Refresh</span>
                <span id="refresh-countdown" class="text-xs text-gray-400 hidden"></span>
            </button>
            <button onclick="showVariablesModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-sliders-h mr-2"></i>
                Variables
            </button>
            <a href="/dashboards" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-cog mr-2"></i>
                Settings
            </a>
        </div>
    </div>

    <!-- Dashboard Variables -->
    <div id="variables-container" class="hidden">
        <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-4 mb-6">
            <div class="flex items-center gap-3 flex-wrap" id="variables-list">
                <!-- Variables will be populated here -->
            </div>
        </div>
    </div>

    <!-- Dashboard Loading State -->
    <div id="loading-state" class="flex items-center justify-center py-20">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
            <p class="text-gray-400">Loading dashboard...</p>
        </div>
    </div>

    <!-- Dashboard Error State -->
    <div id="error-state" class="hidden">
        <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <h3 class="text-lg font-semibold text-red-300 mb-2">Failed to load dashboard</h3>
            <p id="error-message" class="text-red-200/70 mb-4"></p>
            <button onclick="loadDashboard()" class="btn-primary px-4 py-2 rounded-lg">
                <i class="fas fa-redo mr-2"></i>
                Retry
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden">
        <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-10 text-center">
            <i class="fas fa-chart-bar text-5xl text-gray-600 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-300 mb-2">No panels in this dashboard</h3>
            <p class="text-gray-500 mb-6">Add some panels to visualize your metrics.</p>
            <a href="/dashboards" class="btn-primary px-6 py-2 rounded-lg">
                <i class="fas fa-plus mr-2"></i>
                Add Panels
            </a>
        </div>
    </div>

    <!-- GridStack Container -->
    <div id="panels-container" class="hidden">
        <div class="grid-stack"></div>
    </div>
</div>

<!-- Variables Management Modal -->
<div id="variables-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Dashboard Variables</h2>
            <button onclick="closeVariablesModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Variables List -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Variables</h3>
                <button onclick="showVariableEditor()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Add Variable
                </button>
            </div>

            <div id="variables-table" class="bg-gray-900 rounded-lg overflow-hidden">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Variable Editor Modal -->
<div id="variable-editor-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="variable-editor-title" class="text-xl font-bold text-white">New Variable</h2>
            <button onclick="closeVariableEditor()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="variable-form" onsubmit="saveVariable(event)">
            <input type="hidden" id="variable-id">

            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Variable Name *</label>
                        <input type="text" id="variable-name" required placeholder="e.g., instance, job"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Used as $name in queries</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Label</label>
                        <input type="text" id="variable-label" placeholder="Display name"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Type *</label>
                    <select id="variable-type" onchange="handleVariableTypeChange()"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="query">Query - Values from Prometheus query</option>
                        <option value="custom">Custom - Manual list of values</option>
                        <option value="constant">Constant - Single fixed value</option>
                        <option value="textbox">Textbox - Free text input</option>
                        <option value="interval">Interval - Time intervals</option>
                    </select>
                </div>

                <!-- Query Type Fields -->
                <div id="query-fields" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Datasource *</label>
                        <select id="variable-datasource"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Query *</label>
                        <textarea id="variable-query" rows="3" placeholder="label_values(instance)"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500"></textarea>
                        <p class="text-xs text-gray-500 mt-1">PromQL query to get variable values</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Regex Filter</label>
                        <input type="text" id="variable-regex" placeholder="/.*prod.*/"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white font-mono text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Optional regex to filter results</p>
                    </div>
                </div>

                <!-- Custom Type Fields -->
                <div id="custom-fields" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Custom Values *</label>
                    <textarea id="variable-custom-values" rows="3" placeholder="value1&#10;value2&#10;value3"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">One value per line</p>
                </div>

                <!-- Constant/Textbox Type Fields -->
                <div id="default-value-field">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Default Value</label>
                    <input type="text" id="variable-default-value"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="variable-multi-select" class="mr-2">
                        Multi-select
                    </label>
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="variable-include-all" onchange="handleIncludeAllChange()"
                            class="mr-2">
                        Include "All" option
                    </label>
                </div>

                <div id="all-value-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-1">All Value</label>
                    <input type="text" id="variable-all-value" value=".*" placeholder=".*"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Value to use when "All" is selected (e.g., .* for regex)</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Hide</label>
                        <select id="variable-hide"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="0">Visible</option>
                            <option value="1">Label only</option>
                            <option value="2">Hidden</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Sort Order</label>
                        <input type="number" id="variable-sort" value="0" min="0"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeVariableEditor()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    <i class="fas fa-save mr-2"></i>
                    Save Variable
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Time Picker Modal -->
<div id="time-picker-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white">Time Range</h2>
            <button onclick="closeTimePickerModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Quick Ranges -->
            <div class="col-span-1">
                <h3 class="text-sm font-semibold text-gray-300 mb-3">Quick Ranges</h3>
                <div class="space-y-1">
                    <button onclick="selectQuickRange('5m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        5 minutes</button>
                    <button onclick="selectQuickRange('15m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        15 minutes</button>
                    <button onclick="selectQuickRange('30m')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        30 minutes</button>
                    <button onclick="selectQuickRange('1h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        1 hour</button>
                    <button onclick="selectQuickRange('3h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        3 hours</button>
                    <button onclick="selectQuickRange('6h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        6 hours</button>
                    <button onclick="selectQuickRange('12h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        12 hours</button>
                    <button onclick="selectQuickRange('24h')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors bg-gray-700">Last
                        24 hours</button>
                    <button onclick="selectQuickRange('2d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        2 days</button>
                    <button onclick="selectQuickRange('7d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        7 days</button>
                    <button onclick="selectQuickRange('30d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        30 days</button>
                    <button onclick="selectQuickRange('90d')"
                        class="quick-range-btn w-full text-left px-3 py-2 rounded text-sm hover:bg-gray-700 transition-colors">Last
                        90 days</button>
                </div>
            </div>

            <!-- Absolute/Relative Time -->
            <div class="col-span-2">
                <div class="mb-4">
                    <div class="flex gap-2 mb-4">
                        <button id="tab-relative" onclick="switchTimeTab('relative')"
                            class="px-4 py-2 rounded bg-blue-600 text-white text-sm">Relative</button>
                        <button id="tab-absolute" onclick="switchTimeTab('absolute')"
                            class="px-4 py-2 rounded bg-gray-700 text-gray-300 text-sm">Absolute</button>
                    </div>
                </div>

                <!-- Relative Time Range -->
                <div id="relative-time-panel" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">From</label>
                        <input type="text" id="relative-from" value="now-24h" placeholder="now-24h"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Examples: now-1h, now-24h, now-7d</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">To</label>
                        <input type="text" id="relative-to" value="now" placeholder="now"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Examples: now, now-1h</p>
                    </div>
                </div>

                <!-- Absolute Time Range -->
                <div id="absolute-time-panel" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">From</label>
                        <input type="datetime-local" id="absolute-from"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">To</label>
                        <input type="datetime-local" id="absolute-to"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <!-- Refresh Interval -->
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Auto Refresh</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectRefreshInterval(0)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">Off</button>
                        <button onclick="selectRefreshInterval(5)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">5s</button>
                        <button onclick="selectRefreshInterval(10)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">10s</button>
                        <button onclick="selectRefreshInterval(30)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">30s</button>
                        <button onclick="selectRefreshInterval(60)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">1m</button>
                        <button onclick="selectRefreshInterval(300)"
                            class="refresh-interval-btn px-3 py-2 rounded text-sm bg-gray-700 hover:bg-gray-600 transition-colors">5m</button>
                    </div>
                    <div class="mt-2">
                        <input type="number" id="custom-refresh-interval" placeholder="Custom (seconds)" min="1"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-2 mt-6">
            <button onclick="closeTimePickerModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                Cancel
            </button>
            <button onclick="applyTimeRange()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                <i class="fas fa-check mr-2"></i>
                Apply
            </button>
        </div>
    </div>
</div>

<!-- Panel Inspector Modal -->
<div id="panel-inspector-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-6xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center mb-6 flex-shrink-0">
            <h2 class="text-xl font-bold text-white">
                <i class="fas fa-search text-purple-400 mr-2"></i>
                Panel Inspector
                <span id="inspector-panel-name" class="text-gray-400 text-sm ml-2"></span>
            </h2>
            <button onclick="closeInspectorModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Inspector Tabs -->
        <div class="flex gap-2 mb-4 border-b border-gray-700 flex-shrink-0">
            <button id="inspector-tab-query" onclick="switchInspectorTab('query')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-400">
                <i class="fas fa-code mr-1"></i> Query
            </button>
            <button id="inspector-tab-stats" onclick="switchInspectorTab('stats')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-chart-bar mr-1"></i> Stats
            </button>
            <button id="inspector-tab-json" onclick="switchInspectorTab('json')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-file-code mr-1"></i> JSON
            </button>
            <button id="inspector-tab-data" onclick="switchInspectorTab('data')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white">
                <i class="fas fa-table mr-1"></i> Data
            </button>
        </div>

        <!-- Inspector Panels -->
        <div class="flex-1 overflow-auto">
            <!-- Query Panel -->
            <div id="inspector-panel-query" class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-300">Original Query</h3>
                        <button onclick="copyToClipboard('inspector-original-query')"
                            class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <pre id="inspector-original-query"
                        class="bg-gray-900 p-4 rounded text-sm text-gray-300 font-mono overflow-x-auto"></pre>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-semibold text-gray-300">Executed Query (with variables)</h3>
                        <button onclick="copyToClipboard('inspector-executed-query')"
                            class="text-xs text-blue-400 hover:text-blue-300">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <pre id="inspector-executed-query"
                        class="bg-gray-900 p-4 rounded text-sm text-green-400 font-mono overflow-x-auto"></pre>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-300 mb-2">Time Range</h3>
                    <div class="bg-gray-900 p-4 rounded text-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-500">From:</span>
                                <span id="inspector-time-from" class="text-gray-300 ml-2"></span>
                            </div>
                            <div>
                                <span class="text-gray-500">To:</span>
                                <span id="inspector-time-to" class="text-gray-300 ml-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Panel -->
            <div id="inspector-panel-stats" class="hidden">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Execution Time</div>
                        <div id="inspector-exec-time" class="text-2xl font-bold text-blue-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Data Points</div>
                        <div id="inspector-data-points" class="text-2xl font-bold text-green-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Series Count</div>
                        <div id="inspector-series-count" class="text-2xl font-bold text-purple-400">-</div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded">
                        <div class="text-xs text-gray-500 mb-1">Response Size</div>
                        <div id="inspector-response-size" class="text-2xl font-bold text-orange-400">-</div>
                    </div>
                </div>
                <div class="mt-4 bg-gray-900 p-4 rounded">
                    <h3 class="text-sm font-semibold text-gray-300 mb-3">Series Details</h3>
                    <div id="inspector-series-details" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
            </div>

            <!-- JSON Panel -->
            <div id="inspector-panel-json" class="hidden">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-300">Raw Response</h3>
                    <button onclick="copyToClipboard('inspector-json-content')"
                        class="text-xs text-blue-400 hover:text-blue-300">
                        <i class="fas fa-copy mr-1"></i> Copy
                    </button>
                </div>
                <pre id="inspector-json-content"
                    class="bg-gray-900 p-4 rounded text-xs text-gray-300 font-mono overflow-auto max-h-[600px]"></pre>
            </div>

            <!-- Data Panel -->
            <div id="inspector-panel-data" class="hidden overflow-auto">
                <div id="inspector-data-table" class="bg-gray-900 rounded overflow-auto"></div>
            </div>
        </div>
    </div>
</div>

<!-- GridStack JS -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    const dashboardId = '{{ dashboard_id }}';
    let dashboard = null;
    let panels = [];
    let charts = {};
    let refreshInterval = null;
    let grid = null;
    let editMode = false;
    let variables = [];
    let variableValues = {}; // Store selected values for each variable

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', async () => {
        initializeGrid();  // Must initialize grid BEFORE loading dashboard (which calls renderPanels)
        await loadDashboard();
    });

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', () => {
        refreshAllPanels();
    });

    async function loadDashboard() {
        showLoading();

        try {
            // Fetch dashboard details
            const dashboardRes = await fetch(`/api/dashboards/${dashboardId}`);
            if (!dashboardRes.ok) {
                throw new Error('Dashboard not found');
            }
            dashboard = await dashboardRes.json();

            // Update header
            document.getElementById('dashboard-title').textContent = dashboard.name;
            document.getElementById('dashboard-description').textContent = dashboard.description || '';

            // Set time range if dashboard has default
            if (dashboard.time_range) {
                const timeSelect = document.getElementById('time-range');
                if (timeSelect && timeSelect.options && [...timeSelect.options].some(o => o.value === dashboard.time_range)) {
                    timeSelect.value = dashboard.time_range;
                }
            }

            // Use panels from dashboard response (they're already included)
            panels = dashboard.panels || [];

            // Load variables
            await loadVariables();

            if (panels.length === 0) {
                showEmpty();
            } else {
                renderPanels();
                showPanels();
                // Load data for all panels
                await refreshAllPanels();

                // Set up auto-refresh if dashboard has refresh interval
                if (dashboard.auto_refresh && dashboard.refresh_interval) {
                    startAutoRefresh(dashboard.refresh_interval);
                }
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError(error.message);
        }
    }

    async function loadVariables() {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/variables`);
            if (!response.ok) {
                console.warn('Failed to load variables');
                return;
            }

            variables = await response.json();

            // Initialize variable values with defaults
            variables.forEach(variable => {
                variableValues[variable.name] = variable.current_value || variable.default_value || (variable.options && variable.options[0]) || '';
            });

            // Render variables if any exist
            if (variables.length > 0) {
                renderVariables();
            }
        } catch (error) {
            console.error('Error loading variables:', error);
        }
    }

    function renderVariables() {
        const container = document.getElementById('variables-list');
        const variablesContainer = document.getElementById('variables-container');

        if (!variables || variables.length === 0) {
            variablesContainer.classList.add('hidden');
            return;
        }

        // Filter out hidden variables (hide=2)
        const visibleVariables = variables.filter(v => v.hide !== 2);

        if (visibleVariables.length === 0) {
            variablesContainer.classList.add('hidden');
            return;
        }

        container.innerHTML = '';
        variablesContainer.classList.remove('hidden');

        visibleVariables.forEach(variable => {
            const varDiv = document.createElement('div');
            varDiv.className = 'flex items-center gap-2';

            // Show label only if hide !== 1
            if (variable.hide !== 1) {
                const label = document.createElement('label');
                label.className = 'text-sm text-gray-400';
                label.textContent = variable.label || variable.name;
                varDiv.appendChild(label);
            }

            // Create select element
            const select = document.createElement('select');
            select.id = `var-${variable.name}`;
            select.className = 'bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm min-w-[150px]';
            select.multiple = variable.multi_select;

            if (variable.multi_select) {
                select.size = Math.min(variable.options?.length || 3, 5);
            }

            // Populate options
            (variable.options || []).forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                opt.selected = option === variableValues[variable.name];
                select.appendChild(opt);
            });

            // Add change handler
            select.addEventListener('change', () => handleVariableChange(variable.name, select));

            varDiv.appendChild(select);
            container.appendChild(varDiv);
        });
    }

    async function handleVariableChange(variableName, selectElement) {
        const variable = variables.find(v => v.name === variableName);
        if (!variable) return;

        if (variable.multi_select) {
            // Get all selected options
            const selectedOptions = Array.from(selectElement.selectedOptions).map(opt => opt.value);
            variableValues[variableName] = selectedOptions.join(',');
        } else {
            variableValues[variableName] = selectElement.value;
        }

        // Update current value on server
        try {
            await fetch(`/api/dashboards/${dashboardId}/variables/${variable.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_value: variableValues[variableName] })
            });
        } catch (error) {
            console.error('Failed to update variable value:', error);
        }

        // Refresh all panels with new variable value
        await refreshAllPanels();
    }

    function substituteVariables(query) {
        if (!query) return query;

        let result = query;

        // Replace each variable with its current value
        variables.forEach(variable => {
            const value = variableValues[variable.name];
            if (value === undefined || value === null) return;

            // Handle "All" option
            let substitutionValue = value;
            if (value === 'All' && variable.include_all) {
                substitutionValue = variable.all_value || '.*';
            }

            // Replace $variableName with value
            const regex = new RegExp(`\\$${variable.name}\\b`, 'g');
            result = result.replace(regex, substitutionValue);

            // Also support ${variableName} syntax
            const bracketRegex = new RegExp(`\\$\\{${variable.name}\\}`, 'g');
            result = result.replace(bracketRegex, substitutionValue);
        });

        return result;
    }

    function initializeGrid() {
        if (!grid) {
            grid = GridStack.init({
                cellHeight: 80,
                margin: 10,
                resizable: {
                    handles: 'e, se, s, sw, w'
                },
                draggable: {
                    handle: '.panel-drag-handle'
                },
                disableDrag: true,  // Disabled by default
                disableResize: true  // Disabled by default
            });

            // Save layout on change
            grid.on('change', (event, items) => {
                if (!editMode) return;  // Only save in edit mode

                items.forEach(item => {
                    const panelId = item.id;
                    savePanelPosition(panelId, {
                        grid_x: item.x,
                        grid_y: item.y,
                        grid_width: item.w,
                        grid_height: item.h
                    });
                });
            });
        }
    }

    function renderPanels() {
        if (!grid) return;

        // Clear existing widgets
        grid.removeAll();

        panels.forEach((panelItem, index) => {
            // Handle DashboardPanelInfo (panel_id, panel_name) or direct panel objects
            const panelId = panelItem.panel_id || panelItem.id;
            const panelName = panelItem.panel_name || panelItem.name || 'Unnamed Panel';
            const panelDescription = panelItem.description || '';
            const panelQuery = panelItem.promql_query || 'No query';

            // Use saved grid position or default
            const gridX = panelItem.grid_x !== undefined ? panelItem.grid_x : (index % 2) * 6;
            const gridY = panelItem.grid_y !== undefined ? panelItem.grid_y : Math.floor(index / 2) * 4;
            const gridWidth = panelItem.grid_width || 6;
            const gridHeight = panelItem.grid_height || 4;

            // Create panel HTML
            const panelHtml = `
                <div class="grid-stack-item-content">
                    <div class="panel-drag-handle">
                        <div>
                            <i class="fas fa-grip-vertical mr-2"></i>
                            <span class="font-medium text-white">${escapeHtml(panelName)}</span>
                        </div>
                        <div class="panel-actions">
                            <button onclick="inspectPanel('${panelId}')" class="text-purple-400 hover:text-purple-300" title="Inspect Panel">
                                <i class="fas fa-search"></i>
                            </button>
                            <button onclick="editPanel('${panelId}')" class="text-blue-400 hover:text-blue-300" title="Edit Panel">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button onclick="duplicatePanel('${panelId}')" class="text-green-400 hover:text-green-300" title="Duplicate Panel">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="removePanel('${panelId}')" class="text-red-400 hover:text-red-300" title="Remove Panel">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">${escapeHtml(panelDescription)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="inspectPanel('${panelId}')" class="text-gray-500 hover:text-purple-400 transition-colors" title="Inspect">
                                    <i class="fas fa-search text-xs"></i>
                                </button>
                                <span id="panel-status-${panelId}" class="flex items-center gap-1 text-xs text-gray-500">
                                    <i class="fas fa-circle text-green-400 text-xs"></i>
                                    Live
                                </span>
                            </div>
                        </div>
                        <div id="chart-${panelId}" style="width: 100%; height: 220px;" class="bg-gray-800/50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i>
                        </div>
                        <div class="mt-2 text-xs text-gray-600 font-mono truncate" title="${escapeHtml(panelQuery)}">
                            ${escapeHtml(panelQuery)}
                        </div>
                    </div>
                </div>
            `;

            // Add to grid
            grid.addWidget({
                x: gridX,
                y: gridY,
                w: gridWidth,
                h: gridHeight,
                content: panelHtml,
                id: panelId
            });
        });
    }

    async function refreshAllPanels() {
        for (const panelItem of panels) {
            const panelId = panelItem.panel_id || panelItem.id;
            await loadPanelData(panelId, panelItem);
        }
    }

    async function loadPanelData(panelId, panelItem) {
        const chartContainer = document.getElementById(`chart-${panelId}`);
        const statusEl = document.getElementById(`panel-status-${panelId}`);

        if (!chartContainer) return;

        try {
            // Get time range bounds
            const { start, end } = getTimeRangeBounds();

            // Track execution time
            const execStartTime = performance.now();

            // Apply variable substitution to query
            const originalQuery = panelItem.promql_query || '';
            const substitutedQuery = substituteVariables(originalQuery);

            // If query has variables, use test-query endpoint with substituted query
            // Otherwise, use the normal panel data endpoint
            let response, result;

            if (substitutedQuery !== originalQuery || variables.length > 0) {
                // Use test-query endpoint with substituted query
                response = await fetch(`/api/panels/test-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datasource_id: panelItem.datasource_id,
                        promql_query: substitutedQuery,
                        start: start.toISOString(),
                        end: end.toISOString()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const testResult = await response.json();
                result = {
                    data: testResult.data || [],
                    metadata: testResult.metadata || {}
                };
            } else {
                // Use normal panel data endpoint
                response = await fetch(`/api/panels/${panelId}/data?start=${start.toISOString()}&end=${end.toISOString()}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                result = await response.json();
            }

            const execEndTime = performance.now();
            const executionTime = Math.round(execEndTime - execStartTime);

            // Store inspection data
            const responseText = JSON.stringify(result);
            const responseSize = formatBytes(new Blob([responseText]).size);

            panelInspectorData[panelId] = {
                executedQuery: substitutedQuery,
                originalQuery: originalQuery,
                timeRange: { start, end },
                rawResponse: result,
                executionTime: executionTime,
                responseSize: responseSize,
                timestamp: new Date().toISOString()
            };

            // Render chart based on panel type
            renderChart(panelId, result.data, chartContainer, panelItem);

            // Update status
            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-green-400 text-xs"></i>
                <span>${result.metadata?.series_count || 0} series</span>
            `;
            }

        } catch (error) {
            console.error(`Error loading panel ${panelId}:`, error);
            chartContainer.innerHTML = `
            <div class="text-center text-red-400">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p class="text-sm">Failed to load data</p>
                <p class="text-xs text-gray-500">${error.message}</p>
            </div>
        `;

            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-red-400 text-xs"></i>
                Error
            `;
            }
        }
    }

    // Unit Formatting Helper
    function formatUnit(value, unit, decimals = 2) {
        if (value === null || value === undefined) return '-';

        const num = parseFloat(value);
        if (isNaN(num)) return value;

        switch (unit) {
            case 'percent':
                return `${num.toFixed(decimals)}%`;

            case 'bytes':
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                if (num === 0) return '0 B';
                const i = Math.floor(Math.log(num) / Math.log(1024));
                return `${(num / Math.pow(1024, i)).toFixed(decimals)} ${sizes[i]}`;

            case 'seconds':
                if (num < 60) return `${num.toFixed(decimals)}s`;
                if (num < 3600) return `${(num / 60).toFixed(decimals)}m`;
                if (num < 86400) return `${(num / 3600).toFixed(decimals)}h`;
                return `${(num / 86400).toFixed(decimals)}d`;

            case 'milliseconds':
                return `${num.toFixed(decimals)}ms`;

            case 'requests':
                return `${num.toFixed(decimals)} req/s`;

            case 'ops':
                return `${num.toFixed(decimals)} ops/s`;

            default:
                return num.toFixed(decimals);
        }
    }

    // Color Scheme Maps
    const colorSchemes = {
        'default': ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272'],
        'green': ['#10b981', '#059669', '#047857', '#065f46', '#064e3b'],
        'red': ['#ef4444', '#dc2626', '#b91c1c', '#991b1b', '#7f1d1d'],
        'purple': ['#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6', '#4c1d95'],
        'rainbow': ['#ef4444', '#f97316', '#eab308', '#10b981', '#3b82f6', '#8b5cf6'],
        'cool': ['#06b6d4', '#0891b2', '#0e7490', '#155e75', '#164e63'],
        'warm': ['#f97316', '#ea580c', '#c2410c', '#9a3412', '#7c2d12']
    };

    function getColors(scheme, count) {
        const colors = colorSchemes[scheme] || colorSchemes['default'];
        // Repeat colors if needed
        return Array.from({ length: count }, (_, i) => colors[i % colors.length]);
    }

    function renderChart(panelId, data, container, panelItem = {}) {
        // Clear container if it has spinner
        if (container.querySelector('.fa-spinner')) {
            container.innerHTML = '';
        }

        // Initialize or get existing chart
        if (!charts[panelId]) {
            charts[panelId] = echarts.init(container);
        }
        const chart = charts[panelId];

        // Get visualization config
        const config = panelItem.visualization_config || {};
        const colorScheme = config.color_scheme || 'default';
        const colors = getColors(colorScheme, data.length);
        const useGradient = config.gradient || false;
        const decimals = config.decimals !== undefined ? config.decimals : 2;
        const unit = config.units || '';

        // Build series from Prometheus data
        const series = data.map((s, idx) => {
            const name = formatLegend(null, s.metric) || `Series ${idx + 1}`;
            const values = (s.values || []).map(v => [
                new Date(v[0] * 1000),
                parseFloat(v[1])
            ]);

            const seriesConfig = {
                name: name,
                type: 'line',
                data: values,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 2,
                    color: colors[idx]
                },
                itemStyle: {
                    color: colors[idx]
                }
            };

            // Add gradient fill if enabled
            if (useGradient) {
                seriesConfig.areaStyle = {
                    opacity: 0.3,
                    color: {
                        type: 'linear',
                        x: 0,
                        y: 0,
                        x2: 0,
                        y2: 1,
                        colorStops: [
                            { offset: 0, color: colors[idx] },
                            { offset: 1, color: 'transparent' }
                        ]
                    }
                };
            } else {
                seriesConfig.areaStyle = { opacity: 0.1 };
            }

            return seriesConfig;
        });

        // Y-Axis configuration
        const yAxisConfig = {
            type: 'value',
            axisLine: { lineStyle: { color: '#444' } },
            axisLabel: {
                color: '#888',
                formatter: (value) => formatUnit(value, unit, decimals)
            },
            splitLine: { lineStyle: { color: '#333' } }
        };

        // Apply custom Y-axis settings from config
        if (config.axis) {
            if (config.axis.y_min !== null && config.axis.y_min !== undefined) {
                yAxisConfig.min = config.axis.y_min;
            }
            if (config.axis.y_max !== null && config.axis.y_max !== undefined) {
                yAxisConfig.max = config.axis.y_max;
            }
            if (config.axis.y_label) {
                yAxisConfig.name = config.axis.y_label;
                yAxisConfig.nameTextStyle = { color: '#888' };
            }
        }

        // Legend configuration
        const legendConfig = {
            data: series.map(s => s.name),
            textStyle: { color: '#888' },
            type: 'scroll'
        };

        if (config.legend) {
            legendConfig.show = config.legend.show !== false;
            const position = config.legend.position || 'bottom';
            switch (position) {
                case 'top':
                    legendConfig.top = 0;
                    legendConfig.left = 'center';
                    break;
                case 'bottom':
                    legendConfig.bottom = 0;
                    legendConfig.left = 'center';
                    break;
                case 'left':
                    legendConfig.left = 0;
                    legendConfig.top = 'middle';
                    legendConfig.orient = 'vertical';
                    break;
                case 'right':
                    legendConfig.right = 0;
                    legendConfig.top = 'middle';
                    legendConfig.orient = 'vertical';
                    break;
            }
        }

        // Tooltip configuration
        const tooltipConfig = {
            trigger: 'axis',
            backgroundColor: 'rgba(30, 30, 30, 0.9)',
            borderColor: '#444',
            textStyle: { color: '#fff' },
            formatter: (params) => {
                let result = `<div style="font-size: 12px;">${new Date(params[0].value[0]).toLocaleString()}</div>`;
                params.forEach(param => {
                    const value = formatUnit(param.value[1], unit, decimals);
                    result += `<div style="margin-top: 4px;">
                        <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${param.color};margin-right:5px;"></span>
                        ${param.seriesName}: <strong>${value}</strong>
                    </div>`;
                });
                return result;
            }
        };

        // Build threshold mark lines
        const markLines = [];
        if (config.thresholds && config.thresholds.length > 0) {
            config.thresholds.forEach(threshold => {
                markLines.push({
                    yAxis: threshold.value,
                    lineStyle: {
                        color: threshold.color || '#fac858',
                        type: 'dashed',
                        width: 2
                    },
                    label: {
                        formatter: threshold.label || `${threshold.value}`,
                        position: 'end',
                        color: threshold.color || '#fac858'
                    }
                });
            });

            // Add mark lines to first series
            if (series.length > 0) {
                series[0].markLine = {
                    silent: true,
                    data: markLines
                };
            }
        }

        const option = {
            backgroundColor: 'transparent',
            color: colors,
            grid: {
                left: 60,
                right: 20,
                top: legendConfig.top === 0 ? 40 : 30,
                bottom: legendConfig.bottom === 0 ? 40 : 30
            },
            tooltip: tooltipConfig,
            legend: legendConfig,
            xAxis: {
                type: 'time',
                axisLine: { lineStyle: { color: '#444' } },
                axisLabel: { color: '#888' },
                splitLine: { show: false }
            },
            yAxis: yAxisConfig,
            series: series
        };

        chart.setOption(option, true);
        chart.resize();
    }

    function formatLegend(format, metric) {
        if (!format || !metric) {
            // Default: use instance or job label
            return metric.instance || metric.job || Object.values(metric)[0] || 'Value';
        }

        let result = format;
        for (const [key, value] of Object.entries(metric)) {
            // Use string concat to avoid Jinja2 template conflict
            result = result.replace('{% raw %}{{{% endraw %}' + key + '{% raw %}}}{% endraw %}', value);
        }
        return result;
    }

    function parseTimeRange(range) {
        const units = {
            'm': 60 * 1000,
            'h': 60 * 60 * 1000,
            'd': 24 * 60 * 60 * 1000
        };
        const match = range.match(/^(\d+)([mhd])$/);
        if (match) {
            return parseInt(match[1]) * units[match[2]];
        }
        return 24 * 60 * 60 * 1000; // Default 24h
    }

    function startAutoRefresh(intervalSeconds) {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(() => {
            refreshAllPanels();
        }, intervalSeconds * 1000);
    }

    function toggleEditMode() {
        editMode = !editMode;

        const btn = document.getElementById('edit-mode-btn');
        const text = document.getElementById('edit-mode-text');
        const container = document.getElementById('panels-container');

        if (editMode) {
            // Enable editing
            grid.enable();
            text.textContent = 'Save Layout';
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.remove('border-gray-600');
            container.classList.add('edit-mode-active');
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                item.classList.add('editing');
            });
        } else {
            // Disable editing
            grid.disable();
            text.textContent = 'Edit Layout';
            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.add('border-gray-600');
            container.classList.remove('edit-mode-active');
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                item.classList.remove('editing');
            });
            showToast('Layout saved successfully', 'success');
        }
    }

    async function savePanelPosition(panelId, position) {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}/position`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(position)
            });

            if (!response.ok) {
                console.error('Failed to save panel position:', await response.text());
            }
        } catch (error) {
            console.error('Failed to save panel position:', error);
        }
    }

    function editPanel(panelId) {
        // Redirect to panels page with edit mode
        window.location.href = `/panels?edit=${panelId}`;
    }

    async function duplicatePanel(panelId) {
        if (!confirm('Duplicate this panel?')) return;

        try {
            const response = await fetch(`/api/panels/${panelId}/clone`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error('Failed to duplicate panel');
            }

            showToast('Panel duplicated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Error duplicating panel:', error);
            showToast('Failed to duplicate panel', 'error');
        }
    }

    async function removePanel(panelId) {
        if (!confirm('Remove this panel from the dashboard?')) return;

        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to remove panel');
            }

            // Remove from grid
            const widget = document.querySelector(`[gs-id="${panelId}"]`);
            if (widget) {
                grid.removeWidget(widget);
            }

            // Remove from panels array
            panels = panels.filter(p => (p.panel_id || p.id) !== panelId);

            showToast('Panel removed successfully', 'success');
        } catch (error) {
            console.error('Error removing panel:', error);
            showToast('Failed to remove panel', 'error');
        }
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-600' :
            type === 'error' ? 'bg-red-600' :
                'bg-blue-600'
            } text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function showLoading() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
        document.getElementById('error-message').textContent = message;
    }

    function showEmpty() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showPanels() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.remove('hidden');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Time Range and Refresh State
    let currentTimeRange = {
        mode: 'quick', // 'quick', 'relative', 'absolute'
        value: '24h',
        from: 'now-24h',
        to: 'now',
        display: 'Last 24 hours'
    };
    let customRefreshIntervalSeconds = 0;
    let refreshCountdownTimer = null;
    let refreshCountdownSeconds = 0;

    // Panel Inspector State
    let panelInspectorData = {}; // Stores inspection data for each panel

    // Variables Management UI Functions
    let datasources = [];
    let editingVariable = null;

    async function loadDatasources() {
        try {
            const response = await fetch('/api/datasources/');
            if (response.ok) {
                datasources = await response.json();
            }
        } catch (error) {
            console.error('Error loading datasources:', error);
        }
    }

    async function showVariablesModal() {
        await loadDatasources();
        await loadVariables(); // Refresh variables list
        renderVariablesTable();
        document.getElementById('variables-modal').classList.remove('hidden');
    }

    function closeVariablesModal() {
        document.getElementById('variables-modal').classList.add('hidden');
    }

    function renderVariablesTable() {
        const container = document.getElementById('variables-table');

        if (!variables || variables.length === 0) {
            container.innerHTML = `
                <div class="p-8 text-center text-gray-400">
                    <i class="fas fa-sliders-h text-4xl mb-3"></i>
                    <p>No variables defined yet.</p>
                    <p class="text-sm mt-1">Variables allow dynamic filtering of dashboard data.</p>
                </div>
            `;
            return;
        }

        let html = `
            <table class="w-full text-sm">
                <thead class="bg-gray-800">
                    <tr>
                        <th class="px-4 py-3 text-left text-gray-300">Name</th>
                        <th class="px-4 py-3 text-left text-gray-300">Label</th>
                        <th class="px-4 py-3 text-left text-gray-300">Type</th>
                        <th class="px-4 py-3 text-left text-gray-300">Options</th>
                        <th class="px-4 py-3 text-left text-gray-300">Hide</th>
                        <th class="px-4 py-3 text-right text-gray-300">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-800">
        `;

        variables.forEach(variable => {
            const optionsCount = variable.options?.length || 0;
            const hideText = variable.hide === 2 ? 'Hidden' : variable.hide === 1 ? 'Label only' : 'Visible';

            html += `
                <tr class="hover:bg-gray-800/50">
                    <td class="px-4 py-3">
                        <code class="text-blue-400">$${escapeHtml(variable.name)}</code>
                    </td>
                    <td class="px-4 py-3 text-gray-300">${escapeHtml(variable.label || variable.name)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300">${escapeHtml(variable.type)}</span>
                    </td>
                    <td class="px-4 py-3 text-gray-400">${optionsCount} options</td>
                    <td class="px-4 py-3 text-gray-400">${hideText}</td>
                    <td class="px-4 py-3 text-right">
                        <button onclick="editVariable('${variable.id}')" class="text-blue-400 hover:text-blue-300 mr-3" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteVariable('${variable.id}')" class="text-red-400 hover:text-red-300" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
        `;

        container.innerHTML = html;
    }

    function showVariableEditor(variableId = null) {
        editingVariable = variableId ? variables.find(v => v.id === variableId) : null;

        // Reset form
        document.getElementById('variable-form').reset();
        document.getElementById('variable-id').value = '';

        // Set title
        document.getElementById('variable-editor-title').textContent = editingVariable ? 'Edit Variable' : 'New Variable';

        // Populate datasources dropdown
        const datasourceSelect = document.getElementById('variable-datasource');
        datasourceSelect.innerHTML = '<option value="">Select datasource...</option>';
        datasources.forEach(ds => {
            datasourceSelect.innerHTML += `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`;
        });

        // If editing, populate form
        if (editingVariable) {
            document.getElementById('variable-id').value = editingVariable.id;
            document.getElementById('variable-name').value = editingVariable.name;
            document.getElementById('variable-label').value = editingVariable.label || '';
            document.getElementById('variable-type').value = editingVariable.type;
            document.getElementById('variable-datasource').value = editingVariable.datasource_id || '';
            document.getElementById('variable-query').value = editingVariable.query || '';
            document.getElementById('variable-regex').value = editingVariable.regex || '';
            document.getElementById('variable-custom-values').value = (editingVariable.custom_values || []).join('\n');
            document.getElementById('variable-default-value').value = editingVariable.default_value || '';
            document.getElementById('variable-multi-select').checked = editingVariable.multi_select || false;
            document.getElementById('variable-include-all').checked = editingVariable.include_all || false;
            document.getElementById('variable-all-value').value = editingVariable.all_value || '.*';
            document.getElementById('variable-hide').value = editingVariable.hide || 0;
            document.getElementById('variable-sort').value = editingVariable.sort || 0;
        }

        // Show/hide fields based on type
        handleVariableTypeChange();
        handleIncludeAllChange();

        // Show modal
        document.getElementById('variable-editor-modal').classList.remove('hidden');
    }

    function closeVariableEditor() {
        document.getElementById('variable-editor-modal').classList.add('hidden');
        editingVariable = null;
    }

    function handleVariableTypeChange() {
        const type = document.getElementById('variable-type').value;
        const queryFields = document.getElementById('query-fields');
        const customFields = document.getElementById('custom-fields');
        const defaultValueField = document.getElementById('default-value-field');

        // Hide all conditional fields first
        queryFields.classList.add('hidden');
        customFields.classList.add('hidden');
        defaultValueField.classList.add('hidden');

        // Show relevant fields based on type
        if (type === 'query') {
            queryFields.classList.remove('hidden');
        } else if (type === 'custom') {
            customFields.classList.remove('hidden');
            defaultValueField.classList.remove('hidden');
        } else if (type === 'constant' || type === 'textbox') {
            defaultValueField.classList.remove('hidden');
        }
    }

    function handleIncludeAllChange() {
        const includeAll = document.getElementById('variable-include-all').checked;
        const allValueField = document.getElementById('all-value-field');

        if (includeAll) {
            allValueField.classList.remove('hidden');
        } else {
            allValueField.classList.add('hidden');
        }
    }

    async function saveVariable(event) {
        event.preventDefault();

        const variableId = document.getElementById('variable-id').value;
        const type = document.getElementById('variable-type').value;

        // Build request data
        const data = {
            name: document.getElementById('variable-name').value,
            label: document.getElementById('variable-label').value || document.getElementById('variable-name').value,
            type: type,
            multi_select: document.getElementById('variable-multi-select').checked,
            include_all: document.getElementById('variable-include-all').checked,
            hide: parseInt(document.getElementById('variable-hide').value),
            sort: parseInt(document.getElementById('variable-sort').value)
        };

        // Add type-specific fields
        if (type === 'query') {
            data.datasource_id = document.getElementById('variable-datasource').value;
            data.query = document.getElementById('variable-query').value;
            data.regex = document.getElementById('variable-regex').value || null;
        } else if (type === 'custom') {
            const customValues = document.getElementById('variable-custom-values').value
                .split('\n')
                .map(v => v.trim())
                .filter(v => v.length > 0);
            data.custom_values = customValues;
            data.default_value = document.getElementById('variable-default-value').value || null;
        } else if (type === 'constant' || type === 'textbox') {
            data.default_value = document.getElementById('variable-default-value').value || null;
        }

        if (data.include_all) {
            data.all_value = document.getElementById('variable-all-value').value || '.*';
        }

        try {
            let response;
            if (variableId) {
                // Update existing variable
                response = await fetch(`/api/dashboards/${dashboardId}/variables/${variableId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new variable
                response = await fetch(`/api/dashboards/${dashboardId}/variables`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save variable');
            }

            showToast(variableId ? 'Variable updated successfully' : 'Variable created successfully', 'success');
            closeVariableEditor();
            await loadVariables();
            renderVariablesTable();
            renderVariables(); // Update header dropdowns
        } catch (error) {
            console.error('Error saving variable:', error);
            showToast(error.message || 'Failed to save variable', 'error');
        }
    }

    function editVariable(variableId) {
        showVariableEditor(variableId);
    }

    async function deleteVariable(variableId) {
        const variable = variables.find(v => v.id === variableId);
        if (!variable) return;

        if (!confirm(`Delete variable "${variable.name}"?`)) return;

        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/variables/${variableId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete variable');
            }

            showToast('Variable deleted successfully', 'success');
            await loadVariables();
            renderVariablesTable();
            renderVariables(); // Update header dropdowns
        } catch (error) {
            console.error('Error deleting variable:', error);
            showToast('Failed to delete variable', 'error');
        }
    }

    // Time Picker Functions
    function showTimePickerModal() {
        document.getElementById('time-picker-modal').classList.remove('hidden');
    }

    function closeTimePickerModal() {
        document.getElementById('time-picker-modal').classList.add('hidden');
    }

    function switchTimeTab(tab) {
        const relativePanel = document.getElementById('relative-time-panel');
        const absolutePanel = document.getElementById('absolute-time-panel');
        const relativeTab = document.getElementById('tab-relative');
        const absoluteTab = document.getElementById('tab-absolute');

        if (tab === 'relative') {
            relativePanel.classList.remove('hidden');
            absolutePanel.classList.add('hidden');
            relativeTab.classList.add('bg-blue-600', 'text-white');
            relativeTab.classList.remove('bg-gray-700', 'text-gray-300');
            absoluteTab.classList.remove('bg-blue-600', 'text-white');
            absoluteTab.classList.add('bg-gray-700', 'text-gray-300');
            currentTimeRange.mode = 'relative';
        } else {
            relativePanel.classList.add('hidden');
            absolutePanel.classList.remove('hidden');
            absoluteTab.classList.add('bg-blue-600', 'text-white');
            absoluteTab.classList.remove('bg-gray-700', 'text-gray-300');
            relativeTab.classList.remove('bg-blue-600', 'text-white');
            relativeTab.classList.add('bg-gray-700', 'text-gray-300');
            currentTimeRange.mode = 'absolute';
        }
    }

    function selectQuickRange(range) {
        currentTimeRange.mode = 'quick';
        currentTimeRange.value = range;

        // Update display
        const rangeMap = {
            '5m': 'Last 5 minutes',
            '15m': 'Last 15 minutes',
            '30m': 'Last 30 minutes',
            '1h': 'Last 1 hour',
            '3h': 'Last 3 hours',
            '6h': 'Last 6 hours',
            '12h': 'Last 12 hours',
            '24h': 'Last 24 hours',
            '2d': 'Last 2 days',
            '7d': 'Last 7 days',
            '30d': 'Last 30 days',
            '90d': 'Last 90 days'
        };
        currentTimeRange.display = rangeMap[range] || range;

        // Update relative inputs
        document.getElementById('relative-from').value = `now-${range}`;
        document.getElementById('relative-to').value = 'now';

        // Highlight selected button
        document.querySelectorAll('.quick-range-btn').forEach(btn => {
            btn.classList.remove('bg-gray-700');
        });
        event.target.classList.add('bg-gray-700');
    }

    function selectRefreshInterval(seconds) {
        customRefreshIntervalSeconds = seconds;

        // Highlight selected button
        document.querySelectorAll('.refresh-interval-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-700');
        });
        event.target.classList.remove('bg-gray-700');
        event.target.classList.add('bg-blue-600', 'text-white');

        // Clear custom input if preset is selected
        if (seconds > 0) {
            document.getElementById('custom-refresh-interval').value = '';
        }
    }

    function applyTimeRange() {
        // Get values based on mode
        if (currentTimeRange.mode === 'relative') {
            currentTimeRange.from = document.getElementById('relative-from').value;
            currentTimeRange.to = document.getElementById('relative-to').value;
            currentTimeRange.display = `${currentTimeRange.from} to ${currentTimeRange.to}`;
        } else if (currentTimeRange.mode === 'absolute') {
            const fromInput = document.getElementById('absolute-from').value;
            const toInput = document.getElementById('absolute-to').value;
            if (fromInput && toInput) {
                currentTimeRange.from = new Date(fromInput).toISOString();
                currentTimeRange.to = new Date(toInput).toISOString();
                currentTimeRange.display = `${new Date(fromInput).toLocaleString()} to ${new Date(toInput).toLocaleString()}`;
            }
        }

        // Apply custom refresh interval if specified
        const customInterval = document.getElementById('custom-refresh-interval').value;
        if (customInterval && parseInt(customInterval) > 0) {
            customRefreshIntervalSeconds = parseInt(customInterval);
        }

        // Update display
        document.getElementById('time-range-display').textContent = currentTimeRange.display;

        // Start auto-refresh if enabled
        startCustomAutoRefresh();

        // Refresh panels
        refreshAllPanels();

        // Close modal
        closeTimePickerModal();
    }

    function startCustomAutoRefresh() {
        // Clear existing countdown timer
        if (refreshCountdownTimer) {
            clearInterval(refreshCountdownTimer);
            refreshCountdownTimer = null;
        }

        // Clear existing auto-refresh
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        const countdownEl = document.getElementById('refresh-countdown');
        const refreshTextEl = document.getElementById('refresh-text');

        if (customRefreshIntervalSeconds > 0) {
            // Show countdown
            countdownEl.classList.remove('hidden');
            refreshCountdownSeconds = customRefreshIntervalSeconds;

            // Start countdown timer
            refreshCountdownTimer = setInterval(() => {
                refreshCountdownSeconds--;
                countdownEl.textContent = `(${refreshCountdownSeconds}s)`;

                if (refreshCountdownSeconds <= 0) {
                    refreshCountdownSeconds = customRefreshIntervalSeconds;
                    refreshAllPanels();
                }
            }, 1000);

            // Initial countdown display
            countdownEl.textContent = `(${refreshCountdownSeconds}s)`;
        } else {
            // Hide countdown
            countdownEl.classList.add('hidden');
        }
    }

    function getTimeRangeBounds() {
        const now = new Date();

        if (currentTimeRange.mode === 'quick') {
            const duration = parseTimeRange(currentTimeRange.value);
            return {
                start: new Date(now.getTime() - duration),
                end: now
            };
        } else if (currentTimeRange.mode === 'relative') {
            return {
                start: parseRelativeTime(currentTimeRange.from),
                end: parseRelativeTime(currentTimeRange.to)
            };
        } else if (currentTimeRange.mode === 'absolute') {
            return {
                start: new Date(currentTimeRange.from),
                end: new Date(currentTimeRange.to)
            };
        }

        // Default fallback
        return {
            start: new Date(now.getTime() - 24 * 60 * 60 * 1000),
            end: now
        };
    }

    function parseRelativeTime(relativeString) {
        if (relativeString === 'now') {
            return new Date();
        }

        // Match pattern like "now-24h", "now-7d", "now-30m"
        const match = relativeString.match(/^now-(\d+)([mhd])$/);
        if (!match) {
            return new Date();
        }

        const value = parseInt(match[1]);
        const unit = match[2];
        const now = new Date();

        const units = {
            'm': 60 * 1000,
            'h': 60 * 60 * 1000,
            'd': 24 * 60 * 60 * 1000
        };

        return new Date(now.getTime() - value * units[unit]);
    }

    // Panel Inspector Functions
    function inspectPanel(panelId) {
        const panelData = panelInspectorData[panelId];
        const panelItem = panels.find(p => (p.panel_id || p.id) === panelId);

        if (!panelData || !panelItem) {
            showToast('No data available for inspection', 'error');
            return;
        }

        // Set panel name
        const panelName = panelItem.panel_name || panelItem.name || 'Unnamed Panel';
        document.getElementById('inspector-panel-name').textContent = `- ${panelName}`;

        // Populate Query tab
        const originalQuery = panelItem.promql_query || '';
        const executedQuery = panelData.executedQuery || originalQuery;
        document.getElementById('inspector-original-query').textContent = originalQuery;
        document.getElementById('inspector-executed-query').textContent = executedQuery;

        const { start, end } = panelData.timeRange || {};
        document.getElementById('inspector-time-from').textContent = start ? new Date(start).toLocaleString() : '-';
        document.getElementById('inspector-time-to').textContent = end ? new Date(end).toLocaleString() : '-';

        // Populate Stats tab
        const data = panelData.rawResponse?.data || [];
        let totalDataPoints = 0;
        data.forEach(series => {
            totalDataPoints += (series.values || []).length;
        });

        document.getElementById('inspector-exec-time').textContent = panelData.executionTime ? `${panelData.executionTime}ms` : '-';
        document.getElementById('inspector-data-points').textContent = totalDataPoints.toLocaleString();
        document.getElementById('inspector-series-count').textContent = data.length;
        document.getElementById('inspector-response-size').textContent = panelData.responseSize || '-';

        // Populate series details
        const seriesDetails = document.getElementById('inspector-series-details');
        seriesDetails.innerHTML = '';
        data.forEach((series, idx) => {
            const metricLabels = Object.entries(series.metric || {})
                .map(([key, value]) => `${key}="${value}"`)
                .join(', ');
            const dataPointCount = (series.values || []).length;

            seriesDetails.innerHTML += `
                <div class="bg-gray-800 p-3 rounded text-xs">
                    <div class="text-gray-400 mb-1">Series ${idx + 1}</div>
                    <div class="text-white font-mono">{${metricLabels}}</div>
                    <div class="text-gray-500 mt-1">${dataPointCount} data points</div>
                </div>
            `;
        });

        // Populate JSON tab
        const jsonContent = JSON.stringify(panelData.rawResponse, null, 2);
        document.getElementById('inspector-json-content').textContent = jsonContent;

        // Populate Data table
        renderInspectorDataTable(data);

        // Show modal
        document.getElementById('panel-inspector-modal').classList.remove('hidden');
        switchInspectorTab('query');
    }

    function closeInspectorModal() {
        document.getElementById('panel-inspector-modal').classList.add('hidden');
    }

    function switchInspectorTab(tab) {
        // Update tab buttons
        const tabs = ['query', 'stats', 'json', 'data'];
        tabs.forEach(t => {
            const btn = document.getElementById(`inspector-tab-${t}`);
            const panel = document.getElementById(`inspector-panel-${t}`);

            if (t === tab) {
                btn.classList.add('border-blue-500', 'text-blue-400');
                btn.classList.remove('border-transparent', 'text-gray-400');
                panel.classList.remove('hidden');
            } else {
                btn.classList.remove('border-blue-500', 'text-blue-400');
                btn.classList.add('border-transparent', 'text-gray-400');
                panel.classList.add('hidden');
            }
        });
    }

    function renderInspectorDataTable(data) {
        const container = document.getElementById('inspector-data-table');

        if (!data || data.length === 0) {
            container.innerHTML = '<div class="p-8 text-center text-gray-400">No data available</div>';
            return;
        }

        let html = '<table class="w-full text-xs"><thead class="bg-gray-800 sticky top-0"><tr>';
        html += '<th class="px-3 py-2 text-left text-gray-300">Time</th>';

        // Create column for each series
        data.forEach((series, idx) => {
            const labels = Object.entries(series.metric || {})
                .map(([k, v]) => `${k}="${v}"`)
                .join(', ');
            html += `<th class="px-3 py-2 text-left text-gray-300">Series ${idx + 1}<br/><span class="text-gray-500 font-normal">{${labels}}</span></th>`;
        });

        html += '</tr></thead><tbody class="divide-y divide-gray-800">';

        // Collect all unique timestamps
        const timestamps = new Set();
        data.forEach(series => {
            (series.values || []).forEach(([ts]) => timestamps.add(ts));
        });

        const sortedTimestamps = Array.from(timestamps).sort((a, b) => b - a); // Descending

        // Render rows
        sortedTimestamps.slice(0, 1000).forEach(ts => { // Limit to 1000 rows
            html += '<tr class="hover:bg-gray-800/50">';
            html += `<td class="px-3 py-2 text-gray-400">${new Date(ts * 1000).toLocaleString()}</td>`;

            data.forEach(series => {
                const value = (series.values || []).find(([t]) => t === ts);
                const displayValue = value ? parseFloat(value[1]).toFixed(4) : '-';
                html += `<td class="px-3 py-2 text-gray-300 font-mono">${displayValue}</td>`;
            });

            html += '</tr>';
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            showToast('Copied to clipboard', 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            showToast('Failed to copy to clipboard', 'error');
        });
    }

    // Handle window resize
    window.addEventListener('resize', () => {
        Object.values(charts).forEach(chart => chart.resize());
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        Object.values(charts).forEach(chart => chart.dispose());
    });
</script>
{% endblock %}