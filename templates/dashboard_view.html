{% extends "layout.html" %}
{% set active_page = 'dashboards' %}

{% block title %}Dashboard View - AIOps Platform{% endblock %}

{% block head %}
<!-- GridStack CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack.min.css" />
<style>
    .grid-stack-item-content {
        background: rgb(31, 41, 55);
        border: 1px solid rgb(55, 65, 81);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    .panel-drag-handle {
        cursor: move;
        padding: 0.75rem 1rem;
        background: rgb(55, 65, 81);
        border-bottom: 1px solid rgb(75, 85, 99);
        display: none;
        align-items: center;
        justify-content: space-between;
    }

    .panel-drag-handle:hover {
        background: rgb(75, 85, 99);
    }

    .grid-stack-item.editing .panel-drag-handle {
        display: flex;
    }

    .edit-mode-active .grid-stack {
        border: 2px dashed #3b82f6;
        border-radius: 0.5rem;
        padding: 0.5rem;
    }

    .panel-content {
        padding: 1rem;
    }

    .panel-actions {
        display: flex;
        gap: 0.5rem;
    }

    .panel-actions button {
        padding: 0.25rem 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .panel-actions button:hover {
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-4">
            <a href="/dashboards" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 id="dashboard-title" class="text-2xl font-bold">Loading Dashboard...</h1>
                <p id="dashboard-description" class="text-gray-400 text-sm"></p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Edit Layout Toggle -->
            <button id="edit-mode-btn" onclick="toggleEditMode()" class="px-4 py-2 rounded-lg border border-gray-600 hover:bg-gray-700 text-sm transition-colors">
                <i class="fas fa-edit mr-2"></i>
                <span id="edit-mode-text">Edit Layout</span>
            </button>

            <select id="time-range" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm">
                <option value="15m">Last 15m</option>
                <option value="1h">Last 1h</option>
                <option value="6h">Last 6h</option>
                <option value="24h" selected>Last 24h</option>
                <option value="7d">Last 7d</option>
                <option value="30d">Last 30d</option>
            </select>
            <button id="refresh-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <a href="/dashboards" class="btn-secondary px-4 py-2 rounded-lg text-sm">
                <i class="fas fa-cog mr-2"></i>
                Settings
            </a>
        </div>
    </div>

    <!-- Dashboard Loading State -->
    <div id="loading-state" class="flex items-center justify-center py-20">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-400 mb-4"></i>
            <p class="text-gray-400">Loading dashboard...</p>
        </div>
    </div>

    <!-- Dashboard Error State -->
    <div id="error-state" class="hidden">
        <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
            <h3 class="text-lg font-semibold text-red-300 mb-2">Failed to load dashboard</h3>
            <p id="error-message" class="text-red-200/70 mb-4"></p>
            <button onclick="loadDashboard()" class="btn-primary px-4 py-2 rounded-lg">
                <i class="fas fa-redo mr-2"></i>
                Retry
            </button>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden">
        <div class="bg-gray-800/50 border border-gray-700/50 rounded-lg p-10 text-center">
            <i class="fas fa-chart-bar text-5xl text-gray-600 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-300 mb-2">No panels in this dashboard</h3>
            <p class="text-gray-500 mb-6">Add some panels to visualize your metrics.</p>
            <a href="/dashboards" class="btn-primary px-6 py-2 rounded-lg">
                <i class="fas fa-plus mr-2"></i>
                Add Panels
            </a>
        </div>
    </div>

    <!-- GridStack Container -->
    <div id="panels-container" class="hidden">
        <div class="grid-stack"></div>
    </div>
</div>

<!-- GridStack JS -->
<script src="https://cdn.jsdelivr.net/npm/gridstack@8.4.0/dist/gridstack-all.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    const dashboardId = '{{ dashboard_id }}';
    let dashboard = null;
    let panels = [];
    let charts = {};
    let refreshInterval = null;
    let grid = null;
    let editMode = false;

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadDashboard();
        initializeGrid();
    });

    // Time range change
    document.getElementById('time-range').addEventListener('change', () => {
        refreshAllPanels();
    });

    // Refresh button
    document.getElementById('refresh-btn').addEventListener('click', () => {
        refreshAllPanels();
    });

    async function loadDashboard() {
        showLoading();

        try {
            // Fetch dashboard details
            const dashboardRes = await fetch(`/api/dashboards/${dashboardId}`);
            if (!dashboardRes.ok) {
                throw new Error('Dashboard not found');
            }
            dashboard = await dashboardRes.json();

            // Update header
            document.getElementById('dashboard-title').textContent = dashboard.name;
            document.getElementById('dashboard-description').textContent = dashboard.description || '';

            // Set time range if dashboard has default
            if (dashboard.time_range) {
                const timeSelect = document.getElementById('time-range');
                if ([...timeSelect.options].some(o => o.value === dashboard.time_range)) {
                    timeSelect.value = dashboard.time_range;
                }
            }

            // Use panels from dashboard response (they're already included)
            panels = dashboard.panels || [];

            if (panels.length === 0) {
                showEmpty();
            } else {
                renderPanels();
                showPanels();
                // Load data for all panels
                await refreshAllPanels();

                // Set up auto-refresh if dashboard has refresh interval
                if (dashboard.auto_refresh && dashboard.refresh_interval) {
                    startAutoRefresh(dashboard.refresh_interval);
                }
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            showError(error.message);
        }
    }

    function initializeGrid() {
        if (!grid) {
            grid = GridStack.init({
                cellHeight: 80,
                margin: 10,
                resizable: {
                    handles: 'e, se, s, sw, w'
                },
                draggable: {
                    handle: '.panel-drag-handle'
                },
                disableDrag: true,  // Disabled by default
                disableResize: true  // Disabled by default
            });

            // Save layout on change
            grid.on('change', (event, items) => {
                if (!editMode) return;  // Only save in edit mode

                items.forEach(item => {
                    const panelId = item.id;
                    savePanelPosition(panelId, {
                        grid_x: item.x,
                        grid_y: item.y,
                        grid_width: item.w,
                        grid_height: item.h
                    });
                });
            });
        }
    }

    function renderPanels() {
        if (!grid) return;

        // Clear existing widgets
        grid.removeAll();

        panels.forEach((panelItem, index) => {
            // Handle DashboardPanelInfo (panel_id, panel_name) or direct panel objects
            const panelId = panelItem.panel_id || panelItem.id;
            const panelName = panelItem.panel_name || panelItem.name || 'Unnamed Panel';
            const panelDescription = panelItem.description || '';
            const panelQuery = panelItem.promql_query || 'No query';

            // Use saved grid position or default
            const gridX = panelItem.grid_x !== undefined ? panelItem.grid_x : (index % 2) * 6;
            const gridY = panelItem.grid_y !== undefined ? panelItem.grid_y : Math.floor(index / 2) * 4;
            const gridWidth = panelItem.grid_width || 6;
            const gridHeight = panelItem.grid_height || 4;

            // Create panel HTML
            const panelHtml = `
                <div class="grid-stack-item-content">
                    <div class="panel-drag-handle">
                        <div>
                            <i class="fas fa-grip-vertical mr-2"></i>
                            <span class="font-medium text-white">${escapeHtml(panelName)}</span>
                        </div>
                        <div class="panel-actions">
                            <button onclick="editPanel('${panelId}')" class="text-blue-400 hover:text-blue-300" title="Edit Panel">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button onclick="duplicatePanel('${panelId}')" class="text-green-400 hover:text-green-300" title="Duplicate Panel">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="removePanel('${panelId}')" class="text-red-400 hover:text-red-300" title="Remove Panel">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex-1">
                                <p class="text-xs text-gray-500">${escapeHtml(panelDescription)}</p>
                            </div>
                            <span id="panel-status-${panelId}" class="flex items-center gap-1 text-xs text-gray-500">
                                <i class="fas fa-circle text-green-400 text-xs"></i>
                                Live
                            </span>
                        </div>
                        <div id="chart-${panelId}" style="width: 100%; height: 220px;" class="bg-gray-800/50 rounded-lg flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i>
                        </div>
                        <div class="mt-2 text-xs text-gray-600 font-mono truncate" title="${escapeHtml(panelQuery)}">
                            ${escapeHtml(panelQuery)}
                        </div>
                    </div>
                </div>
            `;

            // Add to grid
            grid.addWidget({
                x: gridX,
                y: gridY,
                w: gridWidth,
                h: gridHeight,
                content: panelHtml,
                id: panelId
            });
        });
    }

    async function refreshAllPanels() {
        const timeRange = document.getElementById('time-range').value;

        for (const panelItem of panels) {
            const panelId = panelItem.panel_id || panelItem.id;
            await loadPanelData(panelId, timeRange);
        }
    }

    async function loadPanelData(panelId, timeRange) {
        const chartContainer = document.getElementById(`chart-${panelId}`);
        const statusEl = document.getElementById(`panel-status-${panelId}`);

        if (!chartContainer) return;

        try {
            // Calculate time range
            const end = new Date();
            const duration = parseTimeRange(timeRange);
            const start = new Date(end.getTime() - duration);

            // Fetch panel data from API
            const response = await fetch(`/api/panels/${panelId}/data?start=${start.toISOString()}&end=${end.toISOString()}`);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const result = await response.json();

            // Render chart based on panel type
            renderChart(panelId, result.data, chartContainer);

            // Update status
            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-green-400 text-xs"></i>
                <span>${result.metadata?.series_count || 0} series</span>
            `;
            }

        } catch (error) {
            console.error(`Error loading panel ${panelId}:`, error);
            chartContainer.innerHTML = `
            <div class="text-center text-red-400">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p class="text-sm">Failed to load data</p>
                <p class="text-xs text-gray-500">${error.message}</p>
            </div>
        `;

            if (statusEl) {
                statusEl.innerHTML = `
                <i class="fas fa-circle text-red-400 text-xs"></i>
                Error
            `;
            }
        }
    }

    function renderChart(panelId, data, container) {
        // Clear container if it has spinner
        if (container.querySelector('.fa-spinner')) {
            container.innerHTML = '';
        }

        // Initialize or get existing chart
        if (!charts[panelId]) {
            charts[panelId] = echarts.init(container);
        }
        const chart = charts[panelId];

        // Build series from Prometheus data
        const series = data.map((s, idx) => {
            const name = formatLegend(null, s.metric) || `Series ${idx + 1}`;
            const values = (s.values || []).map(v => [
                new Date(v[0] * 1000),
                parseFloat(v[1])
            ]);

            return {
                name: name,
                type: 'line',  // Default to line chart
                data: values,
                smooth: true,
                showSymbol: false,
                lineStyle: { width: 2 },
                areaStyle: { opacity: 0.1 }  // Default area style
            };
        });

        const option = {
            backgroundColor: 'transparent',
            grid: {
                left: 50,
                right: 20,
                top: 30,
                bottom: 30
            },
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(30, 30, 30, 0.9)',
                borderColor: '#444',
                textStyle: { color: '#fff' }
            },
            legend: {
                data: series.map(s => s.name),
                textStyle: { color: '#888' },
                type: 'scroll',
                top: 0
            },
            xAxis: {
                type: 'time',
                axisLine: { lineStyle: { color: '#444' } },
                axisLabel: { color: '#888' },
                splitLine: { show: false }
            },
            yAxis: {
                type: 'value',
                axisLine: { lineStyle: { color: '#444' } },
                axisLabel: { color: '#888' },
                splitLine: { lineStyle: { color: '#333' } }
            },
            series: series
        };

        chart.setOption(option, true);
        chart.resize();
    }

    function formatLegend(format, metric) {
        if (!format || !metric) {
            // Default: use instance or job label
            return metric.instance || metric.job || Object.values(metric)[0] || 'Value';
        }

        let result = format;
        for (const [key, value] of Object.entries(metric)) {
            // Use string concat to avoid Jinja2 template conflict
            result = result.replace('{% raw %}{{{% endraw %}' + key + '{% raw %}}}{% endraw %}', value);
        }
        return result;
    }

    function parseTimeRange(range) {
        const units = {
            'm': 60 * 1000,
            'h': 60 * 60 * 1000,
            'd': 24 * 60 * 60 * 1000
        };
        const match = range.match(/^(\d+)([mhd])$/);
        if (match) {
            return parseInt(match[1]) * units[match[2]];
        }
        return 24 * 60 * 60 * 1000; // Default 24h
    }

    function startAutoRefresh(intervalSeconds) {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        refreshInterval = setInterval(() => {
            refreshAllPanels();
        }, intervalSeconds * 1000);
    }

    function toggleEditMode() {
        editMode = !editMode;

        const btn = document.getElementById('edit-mode-btn');
        const text = document.getElementById('edit-mode-text');
        const container = document.getElementById('panels-container');

        if (editMode) {
            // Enable editing
            grid.enable();
            text.textContent = 'Save Layout';
            btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.remove('border-gray-600');
            container.classList.add('edit-mode-active');
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                item.classList.add('editing');
            });
        } else {
            // Disable editing
            grid.disable();
            text.textContent = 'Edit Layout';
            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.add('border-gray-600');
            container.classList.remove('edit-mode-active');
            document.querySelectorAll('.grid-stack-item').forEach(item => {
                item.classList.remove('editing');
            });
            showToast('Layout saved successfully', 'success');
        }
    }

    async function savePanelPosition(panelId, position) {
        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}/position`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(position)
            });

            if (!response.ok) {
                console.error('Failed to save panel position:', await response.text());
            }
        } catch (error) {
            console.error('Failed to save panel position:', error);
        }
    }

    function editPanel(panelId) {
        // Redirect to panels page with edit mode
        window.location.href = `/panels?edit=${panelId}`;
    }

    async function duplicatePanel(panelId) {
        if (!confirm('Duplicate this panel?')) return;

        try {
            const response = await fetch(`/api/panels/${panelId}/clone`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error('Failed to duplicate panel');
            }

            showToast('Panel duplicated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            console.error('Error duplicating panel:', error);
            showToast('Failed to duplicate panel', 'error');
        }
    }

    async function removePanel(panelId) {
        if (!confirm('Remove this panel from the dashboard?')) return;

        try {
            const response = await fetch(`/api/dashboards/${dashboardId}/panels/${panelId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to remove panel');
            }

            // Remove from grid
            const widget = document.querySelector(`[gs-id="${panelId}"]`);
            if (widget) {
                grid.removeWidget(widget);
            }

            // Remove from panels array
            panels = panels.filter(p => (p.panel_id || p.id) !== panelId);

            showToast('Panel removed successfully', 'success');
        } catch (error) {
            console.error('Error removing panel:', error);
            showToast('Failed to remove panel', 'error');
        }
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-600' :
            type === 'error' ? 'bg-red-600' :
            'bg-blue-600'
        } text-white`;
        toast.textContent = message;
        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function showLoading() {
        document.getElementById('loading-state').classList.remove('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.add('hidden');
        document.getElementById('error-message').textContent = message;
    }

    function showEmpty() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('panels-container').classList.add('hidden');
    }

    function showPanels() {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('error-state').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('panels-container').classList.remove('hidden');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Handle window resize
    window.addEventListener('resize', () => {
        Object.values(charts).forEach(chart => chart.resize());
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
        Object.values(charts).forEach(chart => chart.dispose());
    });
</script>
{% endblock %}