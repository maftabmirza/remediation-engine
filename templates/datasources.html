{% extends "base.html" %}

{% block title %}Prometheus Datasources{% endblock %}

{% block head %}
<style>
    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
    }
    .status-enabled { background-color: #10b981; }
    .status-disabled { background-color: #ef4444; }
    .badge-default {
        background-color: #3b82f6;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">Prometheus Datasources</h1>
            <p class="text-gray-400 text-sm">Manage Prometheus server connections</p>
        </div>
        <button onclick="showCreateModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Add Datasource
        </button>
    </div>

    <!-- Datasources Table -->
    <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <table class="w-full">
            <thead class="bg-gray-900">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">URL</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Auth</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="datasources-table" class="divide-y divide-gray-700">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="datasource-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-white">Add Datasource</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="datasource-form" onsubmit="saveDatasource(event)">
            <input type="hidden" id="datasource-id">

            <div class="space-y-4">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Name *</label>
                    <input type="text" id="datasource-name" required
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <!-- URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">URL *</label>
                    <input type="url" id="datasource-url" required placeholder="http://prometheus:9090"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-gray-400 mt-1">Full URL including protocol (http:// or https://)</p>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                    <textarea id="datasource-description" rows="2"
                              class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                </div>

                <!-- Authentication Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Authentication</label>
                    <select id="datasource-auth-type" onchange="toggleAuthFields()"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <option value="none">None</option>
                        <option value="basic">Basic Auth</option>
                        <option value="bearer">Bearer Token</option>
                    </select>
                </div>

                <!-- Basic Auth Fields -->
                <div id="basic-auth-fields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                        <input type="text" id="datasource-username"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="datasource-password" autocomplete="new-password"
                               class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <!-- Bearer Token Field -->
                <div id="bearer-token-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Bearer Token</label>
                    <input type="password" id="datasource-bearer-token"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <!-- Timeout -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Timeout (seconds)</label>
                    <input type="number" id="datasource-timeout" value="30" min="5" max="300"
                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                </div>

                <!-- Flags -->
                <div class="flex gap-4">
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="datasource-is-default" class="mr-2">
                        Set as Default
                    </label>
                    <label class="flex items-center text-gray-300">
                        <input type="checkbox" id="datasource-is-enabled" checked class="mr-2">
                        Enabled
                    </label>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let datasources = [];

async function loadDatasources() {
    try {
        const response = await apiCall('/api/datasources/');
        datasources = await response.json();
        renderDatasources();
    } catch (error) {
        console.error('Failed to load datasources:', error);
        showToast('Failed to load datasources', 'error');
    }
}

function renderDatasources() {
    const tbody = document.getElementById('datasources-table');

    if (datasources.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                    No datasources configured. Click "Add Datasource" to get started.
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = datasources.map(ds => `
        <tr class="hover:bg-gray-700">
            <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                    <span class="text-white font-medium">${escapeHtml(ds.name)}</span>
                    ${ds.is_default ? '<span class="badge-default">DEFAULT</span>' : ''}
                </div>
                ${ds.description ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(ds.description)}</div>` : ''}
            </td>
            <td class="px-6 py-4 text-gray-300">
                <code class="text-sm">${escapeHtml(ds.url)}</code>
            </td>
            <td class="px-6 py-4">
                <span class="text-sm ${ds.auth_type === 'none' ? 'text-gray-400' : 'text-blue-400'}">
                    ${ds.auth_type === 'none' ? 'None' : ds.auth_type === 'basic' ? 'Basic Auth' : 'Bearer Token'}
                </span>
            </td>
            <td class="px-6 py-4">
                <div class="flex items-center">
                    <span class="status-indicator ${ds.is_enabled ? 'status-enabled' : 'status-disabled'}"></span>
                    <span class="text-sm ${ds.is_enabled ? 'text-green-400' : 'text-red-400'}">
                        ${ds.is_enabled ? 'Enabled' : 'Disabled'}
                    </span>
                </div>
            </td>
            <td class="px-6 py-4">
                <div class="flex gap-2">
                    <button onclick="testConnection('${ds.id}')" class="text-blue-400 hover:text-blue-300" title="Test Connection">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </button>
                    <button onclick="editDatasource('${ds.id}')" class="text-gray-400 hover:text-white" title="Edit">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </button>
                    <button onclick="deleteDatasource('${ds.id}', '${escapeHtml(ds.name)}')"
                            class="text-red-400 hover:text-red-300"
                            title="Delete"
                            ${ds.is_default ? 'disabled opacity-50' : ''}>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function showCreateModal() {
    document.getElementById('modal-title').textContent = 'Add Datasource';
    document.getElementById('datasource-form').reset();
    document.getElementById('datasource-id').value = '';
    document.getElementById('datasource-is-enabled').checked = true;
    toggleAuthFields();
    document.getElementById('datasource-modal').classList.remove('hidden');
}

function editDatasource(id) {
    const ds = datasources.find(d => d.id === id);
    if (!ds) return;

    document.getElementById('modal-title').textContent = 'Edit Datasource';
    document.getElementById('datasource-id').value = ds.id;
    document.getElementById('datasource-name').value = ds.name;
    document.getElementById('datasource-url').value = ds.url;
    document.getElementById('datasource-description').value = ds.description || '';
    document.getElementById('datasource-auth-type').value = ds.auth_type;
    document.getElementById('datasource-username').value = ds.username || '';
    document.getElementById('datasource-timeout').value = ds.timeout;
    document.getElementById('datasource-is-default').checked = ds.is_default;
    document.getElementById('datasource-is-enabled').checked = ds.is_enabled;

    toggleAuthFields();
    document.getElementById('datasource-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('datasource-modal').classList.add('hidden');
}

function toggleAuthFields() {
    const authType = document.getElementById('datasource-auth-type').value;
    const basicAuthFields = document.getElementById('basic-auth-fields');
    const bearerTokenField = document.getElementById('bearer-token-field');

    basicAuthFields.classList.add('hidden');
    bearerTokenField.classList.add('hidden');

    if (authType === 'basic') {
        basicAuthFields.classList.remove('hidden');
    } else if (authType === 'bearer') {
        bearerTokenField.classList.remove('hidden');
    }
}

async function saveDatasource(event) {
    event.preventDefault();

    const id = document.getElementById('datasource-id').value;
    const data = {
        name: document.getElementById('datasource-name').value,
        url: document.getElementById('datasource-url').value,
        description: document.getElementById('datasource-description').value || null,
        auth_type: document.getElementById('datasource-auth-type').value,
        timeout: parseInt(document.getElementById('datasource-timeout').value),
        is_default: document.getElementById('datasource-is-default').checked,
        is_enabled: document.getElementById('datasource-is-enabled').checked
    };

    // Add auth fields
    if (data.auth_type === 'basic') {
        data.username = document.getElementById('datasource-username').value;
        const password = document.getElementById('datasource-password').value;
        if (password) {
            data.password = password;
        }
    } else if (data.auth_type === 'bearer') {
        const token = document.getElementById('datasource-bearer-token').value;
        if (token) {
            data.bearer_token = token;
        }
    }

    try {
        const url = id ? `/api/datasources/${id}` : '/api/datasources/';
        const method = id ? 'PUT' : 'POST';

        const response = await apiCall(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            showToast(id ? 'Datasource updated successfully' : 'Datasource created successfully', 'success');
            closeModal();
            await loadDatasources();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to save datasource', 'error');
        }
    } catch (error) {
        console.error('Failed to save datasource:', error);
        showToast('Failed to save datasource', 'error');
    }
}

async function deleteDatasource(id, name) {
    if (!confirm(`Are you sure you want to delete datasource "${name}"?`)) {
        return;
    }

    try {
        const response = await apiCall(`/api/datasources/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Datasource deleted successfully', 'success');
            await loadDatasources();
        } else {
            const error = await response.json();
            showToast(error.detail || 'Failed to delete datasource', 'error');
        }
    } catch (error) {
        console.error('Failed to delete datasource:', error);
        showToast('Failed to delete datasource', 'error');
    }
}

async function testConnection(id) {
    try {
        showToast('Testing connection...', 'info');

        const response = await apiCall(`/api/datasources/${id}/test`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            showToast(`✓ ${result.message}${result.version ? ` (v${result.version})` : ''}`, 'success');
        } else {
            showToast(`✗ ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Failed to test connection:', error);
        showToast('Failed to test connection', 'error');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load datasources on page load
document.addEventListener('DOMContentLoaded', loadDatasources);
</script>
{% endblock %}
