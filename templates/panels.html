{% extends "layout.html" %}
{% set active_page = 'panels' %}

{% block title %}Prometheus Panels{% endblock %}

{% block head %}
<style>
    .panel-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .panel-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-graph {
        background-color: #3b82f6;
        color: white;
    }

    .badge-gauge {
        background-color: #10b981;
        color: white;
    }

    .badge-stat {
        background-color: #f59e0b;
        color: white;
    }

    .badge-table {
        background-color: #8b5cf6;
        color: white;
    }

    .badge-template {
        background-color: #ec4899;
        color: white;
    }

    #query-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">Prometheus Panels</h1>
            <p class="text-gray-400 text-sm">Create and manage custom PromQL panels</p>
        </div>
        <button onclick="showCreateModal()"
            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Create Panel
        </button>
    </div>

    <!-- Filters -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6 flex gap-4">
        <div class="flex-1">
            <input type="text" id="search-input" placeholder="Search panels..." onkeyup="filterPanels()"
                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
        </div>
        <select id="datasource-filter" onchange="filterPanels()"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">All Datasources</option>
        </select>
        <select id="type-filter" onchange="filterPanels()"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">All Types</option>
            <option value="graph">Graph</option>
            <option value="gauge">Gauge</option>
            <option value="stat">Stat</option>
            <option value="table">Table</option>
        </select>
        <label class="flex items-center text-gray-300">
            <input type="checkbox" id="templates-only" onchange="filterPanels()" class="mr-2">
            Templates Only
        </label>
    </div>

    <!-- Panels Grid -->
    <div id="panels-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Populated by JavaScript -->
    </div>

    <div id="no-panels" class="hidden bg-gray-800 rounded-lg p-8 text-center">
        <p class="text-gray-400">No panels found. Create your first panel to get started.</p>
    </div>
</div>

<!-- Create/Edit Panel Modal -->
<div id="panel-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-white">Create Panel</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="panel-form" onsubmit="savePanel(event)">
            <input type="hidden" id="panel-id">

            <div class="grid grid-cols-2 gap-4">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Name *</label>
                        <input type="text" id="panel-name" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                        <textarea id="panel-description" rows="2"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Datasource *</label>
                        <select id="panel-datasource" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Type</label>
                        <select id="panel-type"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="graph">Graph</option>
                            <option value="gauge">Gauge</option>
                            <option value="stat">Stat</option>
                            <option value="table">Table</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Time Range</label>
                            <select id="panel-time-range"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="3h">3 hours</option>
                                <option value="6h">6 hours</option>
                                <option value="12h">12 hours</option>
                                <option value="24h" selected>24 hours</option>
                                <option value="7d">7 days</option>
                                <option value="30d">30 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Refresh (s)</label>
                            <input type="number" id="panel-refresh" value="30" min="5" max="3600"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-template" class="mr-2">
                            Save as Template
                        </label>
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-public" class="mr-2">
                            Public
                        </label>
                    </div>
                </div>

                <!-- Right Column - Query Editor -->
                <div class="space-y-4">
                    <!-- Query Examples -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Query Examples</label>
                        <select id="query-examples" onchange="loadQueryExample()"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select an example...</option>
                            <option value="cpu">CPU Usage (%)</option>
                            <option value="memory">Memory Usage (GB)</option>
                            <option value="disk">Disk Usage (%)</option>
                            <option value="network_rx">Network Received (MB/s)</option>
                            <option value="network_tx">Network Transmitted (MB/s)</option>
                            <option value="http_rate">HTTP Request Rate</option>
                            <option value="http_errors">HTTP Error Rate (%)</option>
                            <option value="http_latency">HTTP Request Duration p95</option>
                            <option value="alerts">Active Alerts</option>
                            <option value="up">Target Up/Down</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-300">PromQL Query *</label>
                            <button type="button" onclick="testQuery()"
                                class="text-blue-400 hover:text-blue-300 text-sm">
                                Test Query
                            </button>
                        </div>
                        <textarea id="query-editor" rows="8" required
                            placeholder="Example: rate(http_requests_total[5m])"
                            class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                        <p class="text-xs text-gray-400 mt-1">Enter your PromQL query or select an example above</p>
                    </div>

                    <div id="query-result" class="hidden p-3 rounded text-sm">
                        <!-- Test results shown here -->
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Legend Format</label>
                        <input type="text" id="panel-legend" placeholder="{{instance}}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-400 mt-1">Use {{label_name}} for label values</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Tags (comma-separated)</label>
                        <input type="text" id="panel-tags" placeholder="infrastructure, cpu, monitoring"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    Save Panel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let panels = [];
    let datasources = [];
    let filteredPanels = [];

    async function loadDatasources() {
        try {
            const response = await apiCall('/api/datasources/?enabled_only=true');
            datasources = await response.json();

            // Populate datasource selectors
            const panelDatasource = document.getElementById('panel-datasource');
            const datasourceFilter = document.getElementById('datasource-filter');

            panelDatasource.innerHTML = '<option value="">Select datasource...</option>' +
                datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');

            datasourceFilter.innerHTML = '<option value="">All Datasources</option>' +
                datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');
        } catch (error) {
            console.error('Failed to load datasources:', error);
        }
    }

    async function loadPanels() {
        try {
            const response = await apiCall('/api/panels/?limit=500');
            panels = await response.json();
            filterPanels();
        } catch (error) {
            console.error('Failed to load panels:', error);
            showToast('Failed to load panels', 'error');
        }
    }

    function filterPanels() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const datasourceFilter = document.getElementById('datasource-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        const templatesOnly = document.getElementById('templates-only').checked;

        filteredPanels = panels.filter(panel => {
            const matchesSearch = !search ||
                panel.name.toLowerCase().includes(search) ||
                (panel.description && panel.description.toLowerCase().includes(search));

            const matchesDatasource = !datasourceFilter || panel.datasource_id === datasourceFilter;
            const matchesType = !typeFilter || panel.panel_type === typeFilter;
            const matchesTemplate = !templatesOnly || panel.is_template;

            return matchesSearch && matchesDatasource && matchesType && matchesTemplate;
        });

        renderPanels();
    }

    function renderPanels() {
        const grid = document.getElementById('panels-grid');
        const noPanel = document.getElementById('no-panels');

        if (filteredPanels.length === 0) {
            grid.classList.add('hidden');
            noPanel.classList.remove('hidden');
            return;
        }

        grid.classList.remove('hidden');
        noPanel.classList.add('hidden');

        grid.innerHTML = filteredPanels.map(panel => {
            const datasource = datasources.find(ds => ds.id === panel.datasource_id);
            const badgeClass = `badge-${panel.panel_type}`;

            return `
            <div class="panel-card bg-gray-800 rounded-lg p-4 border border-gray-700">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-white font-medium">${escapeHtml(panel.name)}</h3>
                    <div class="flex gap-2">
                        <button onclick="editPanel('${panel.id}')" class="text-gray-400 hover:text-white" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deletePanel('${panel.id}', '${escapeHtml(panel.name)}')" class="text-red-400 hover:text-red-300" title="Delete">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>

                ${panel.description ? `<p class="text-gray-400 text-sm mb-3">${escapeHtml(panel.description)}</p>` : ''}

                <div class="bg-gray-900 rounded p-2 mb-3">
                    <code class="text-xs text-green-400">${escapeHtml(panel.promql_query)}</code>
                </div>

                <div class="flex flex-wrap gap-2 mb-2">
                    <span class="badge ${badgeClass}">${panel.panel_type.toUpperCase()}</span>
                    ${panel.is_template ? '<span class="badge badge-template">TEMPLATE</span>' : ''}
                </div>

                <div class="text-xs text-gray-400">
                    <div>Datasource: ${datasource ? escapeHtml(datasource.name) : 'Unknown'}</div>
                    <div>Range: ${panel.time_range} | Refresh: ${panel.refresh_interval}s</div>
                </div>
            </div>
        `;
        }).join('');
    }

    function showCreateModal() {
        document.getElementById('modal-title').textContent = 'Create Panel';
        document.getElementById('panel-form').reset();
        document.getElementById('panel-id').value = '';
        document.getElementById('panel-time-range').value = '24h';
        document.getElementById('panel-refresh').value = '30';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');
    }

    function loadQueryExample() {
        const exampleType = document.getElementById('query-examples').value;
        const queryEditor = document.getElementById('query-editor');

        const examples = {
            'cpu': '100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)',
            'memory': '(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / 1024 / 1024 / 1024',
            'disk': '100 - ((node_filesystem_avail_bytes{mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{mountpoint="/",fstype!="rootfs"})',
            'network_rx': 'rate(node_network_receive_bytes_total[5m]) / 1024 / 1024',
            'network_tx': 'rate(node_network_transmit_bytes_total[5m]) / 1024 / 1024',
            'http_rate': 'sum(rate(http_requests_total[5m])) by (method, status)',
            'http_errors': '(sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100',
            'http_latency': 'histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))',
            'alerts': 'ALERTS{alertstate="firing"}',
            'up': 'up'
        };

        if (exampleType && examples[exampleType]) {
            queryEditor.value = examples[exampleType];
            document.getElementById('query-examples').value = ''; // Reset dropdown
        }
    }

    function editPanel(id) {
        const panel = panels.find(p => p.id === id);
        if (!panel) return;

        document.getElementById('modal-title').textContent = 'Edit Panel';
        document.getElementById('panel-id').value = panel.id;
        document.getElementById('panel-name').value = panel.name;
        document.getElementById('panel-description').value = panel.description || '';
        document.getElementById('panel-datasource').value = panel.datasource_id;
        document.getElementById('panel-type').value = panel.panel_type;
        document.getElementById('query-editor').value = panel.promql_query;
        document.getElementById('panel-legend').value = panel.legend_format || '';
        document.getElementById('panel-time-range').value = panel.time_range;
        document.getElementById('panel-refresh').value = panel.refresh_interval;
        document.getElementById('panel-is-template').checked = panel.is_template;
        document.getElementById('panel-is-public').checked = panel.is_public;
        document.getElementById('panel-tags').value = panel.tags ? panel.tags.join(', ') : '';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('panel-modal').classList.add('hidden');
    }

    async function testQuery() {
        const datasourceId = document.getElementById('panel-datasource').value;
        const query = document.getElementById('query-editor').value;

        if (!datasourceId || !query) {
            showToast('Please select a datasource and enter a query', 'error');
            return;
        }

        const resultDiv = document.getElementById('query-result');
        resultDiv.innerHTML = '<div class="text-gray-400">Testing query...</div>';
        resultDiv.className = 'p-3 rounded text-sm bg-gray-900';
        resultDiv.classList.remove('hidden');

        try {
            const response = await apiCall('/api/panels/test-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    datasource_id: datasourceId,
                    promql_query: query
                })
            });

            const result = await response.json();

            if (result.valid) {
                resultDiv.className = 'p-3 rounded text-sm bg-green-900 border border-green-600';
                resultDiv.innerHTML = `
                <div class="text-green-300 font-medium">✓ ${escapeHtml(result.message)}</div>
                <div class="text-xs text-green-200 mt-1">Result Type: ${result.result_type}</div>
            `;
            } else {
                resultDiv.className = 'p-3 rounded text-sm bg-red-900 border border-red-600';
                resultDiv.innerHTML = `<div class="text-red-300">✗ ${escapeHtml(result.message)}</div>`;
            }
        } catch (error) {
            resultDiv.className = 'p-3 rounded text-sm bg-red-900 border border-red-600';
            resultDiv.innerHTML = `<div class="text-red-300">Error testing query</div>`;
        }
    }

    async function savePanel(event) {
        event.preventDefault();

        const id = document.getElementById('panel-id').value;
        const tags = document.getElementById('panel-tags').value
            .split(',')
            .map(t => t.trim())
            .filter(t => t.length > 0);

        const data = {
            name: document.getElementById('panel-name').value,
            description: document.getElementById('panel-description').value || null,
            datasource_id: document.getElementById('panel-datasource').value,
            promql_query: document.getElementById('query-editor').value,
            legend_format: document.getElementById('panel-legend').value || null,
            time_range: document.getElementById('panel-time-range').value,
            refresh_interval: parseInt(document.getElementById('panel-refresh').value),
            panel_type: document.getElementById('panel-type').value,
            is_template: document.getElementById('panel-is-template').checked,
            is_public: document.getElementById('panel-is-public').checked,
            tags: tags.length > 0 ? tags : null
        };

        try {
            const url = id ? `/api/panels/${id}` : '/api/panels/';
            const method = id ? 'PUT' : 'POST';

            const response = await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Panel updated successfully' : 'Panel created successfully', 'success');
                closeModal();
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save panel', 'error');
            }
        } catch (error) {
            console.error('Failed to save panel:', error);
            showToast('Failed to save panel', 'error');
        }
    }

    async function deletePanel(id, name) {
        if (!confirm(`Are you sure you want to delete panel "${name}"?`)) {
            return;
        }

        try {
            const response = await apiCall(`/api/panels/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Panel deleted successfully', 'success');
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to delete panel', 'error');
            }
        } catch (error) {
            console.error('Failed to delete panel:', error);
            showToast('Failed to delete panel', 'error');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadDatasources();
        await loadPanels();
    });
</script>
{% endblock %}