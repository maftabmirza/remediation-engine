{% extends "layout.html" %}
{% set active_page = 'panels' %}

{% block title %}Prometheus Panels{% endblock %}

{% block head %}
{{ super() }}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.min.css">
<style>
    /* Grafana-aligned Panel Card */
    .panel-card {
        background-color: #181b1f;
        /* Grafana secondary bg */
        border: 1px solid rgba(204, 204, 220, 0.12);
        /* Grafana border */
        border-radius: 4px;
        /* Grafana uses 4px */
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .panel-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        border-color: rgba(204, 204, 220, 0.2);
    }

    /* Grafana-style Badges */
    .badge {
        padding: 2px 8px;
        border-radius: 2px;
        /* Grafana uses smaller radius */
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-graph,
    .badge-area {
        background-color: #3d71d9;
        /* Grafana blue */
        color: white;
    }

    .badge-stacked_area,
    .badge-stacked_bar {
        background-color: #b877d9;
        /* Grafana purple */
        color: white;
    }

    .badge-bar {
        background-color: #6e9fff;
        /* Grafana light blue */
        color: #111217;
    }

    .badge-gauge {
        background-color: #1a7f4b;
        /* Grafana green */
        color: white;
    }

    .badge-stat,
    .badge-sparkline {
        background-color: #eb7b18;
        /* Grafana orange */
        color: white;
    }

    .badge-pie,
    .badge-doughnut {
        background-color: #d10e5c;
        /* Grafana pink/magenta */
        color: white;
    }

    .badge-heatmap {
        background-color: #ff5286;
        /* Grafana red */
        color: white;
    }

    .badge-table {
        background-color: #b877d9;
        /* Grafana purple */
        color: white;
    }

    .badge-template {
        background-color: #6ccf8e;
        /* Grafana light green */
        color: #111217;
    }


    /* CodeMirror customization - Grafana style */
    .CodeMirror {
        height: 200px;
        border: 1px solid rgba(204, 204, 220, 0.2);
        border-radius: 4px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        background-color: #111217;
        /* Grafana primary bg */
    }

    .CodeMirror-gutters {
        background-color: #181b1f;
        border-right: 1px solid rgba(204, 204, 220, 0.12);
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Enterprise Standard Toolbar -->
    <div class="dashboard-header"
        style="padding: 12px; background: #16171b; border-bottom: 1px solid rgba(255,255,255,0.05); border-radius: 8px;">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <!-- Left: Breadcrumbs & Title -->
            <div class="flex flex-col min-w-0">
                <!-- Breadcrumbs -->
                <nav class="flex items-center text-xs text-gray-400 mb-1">
                    <a href="/" class="hover:text-blue-400 transition-colors">Home</a>
                    <span class="mx-2">/</span>
                    <span class="text-gray-200">Panels</span>
                </nav>
                <div class="flex items-center gap-3">
                    <h1 class="text-xl font-bold text-white tracking-tight truncate">Metric Panels</h1>
                </div>
                <p class="text-xs text-gray-500 mt-1">Create and manage custom PromQL panels</p>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2">
                <button onclick="showCreateModal()"
                    class="bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-white text-sm flex items-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    Create Panel
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card p-4 flex flex-wrap gap-4 items-center">
        <div class="flex-1">
            <input type="text" id="search-input" placeholder="Search panels..." onkeyup="filterPanels()"
                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
        </div>
        <select id="datasource-filter" onchange="filterPanels()"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">All Datasources</option>
        </select>
        <select id="type-filter" onchange="filterPanels()"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
            <option value="">All Types</option>
            <option value="graph">Graph</option>
            <option value="gauge">Gauge</option>
            <option value="stat">Stat</option>
            <option value="table">Table</option>
        </select>
        <label class="flex items-center text-gray-300">
            <input type="checkbox" id="templates-only" onchange="filterPanels()" class="mr-2">
            Templates Only
        </label>
    </div>

    <!-- Panels Table -->
    <div class="card overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#181b1f] text-left text-[#8e8e8e]"
                    style="border-bottom: 1px solid rgba(204, 204, 220, 0.07);">
                    <th class="px-4 py-3 font-medium w-10"></th>
                    <th class="px-4 py-3 font-medium">Name</th>
                    <th class="px-4 py-3 font-medium">Type</th>
                    <th class="px-4 py-3 font-medium">Datasource</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Query</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Created</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Updated</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="panels-tbody" class="text-[#ccccdc]">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="flex items-center justify-between mt-4 text-sm">
        <div class="text-[#8e8e8e]">
            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            panels
        </div>
        <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="first-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#22252b] transition-colors">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#22252b] transition-colors">
                <i class="fas fa-angle-left"></i>
            </button>
            <span class="px-3 py-1.5 text-[#ccccdc]">Page <span id="current-page">1</span> of <span
                    id="total-pages">1</span></span>
            <button onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#22252b] transition-colors">
                <i class="fas fa-angle-right"></i>
            </button>
            <button onclick="goToPage(totalPages)" id="last-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#22252b] transition-colors">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <select id="page-size" onchange="changePageSize(this.value)"
                class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] focus:outline-none focus:border-[#3d71d9]">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>

    <div id="no-panels" class="hidden bg-[#181b1f] rounded border border-[rgba(204,204,220,0.12)] p-8 text-center">
        <i class="fas fa-chart-bar text-4xl text-[#8e8e8e] mb-3"></i>
        <p class="text-[#8e8e8e]">No panels found. Create your first panel to get started.</p>
    </div>
</div>

<!-- Create/Edit Panel Modal -->
<div id="panel-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-start justify-center z-50 overflow-y-auto py-8">
    <div class="bg-gray-800 rounded-lg p-6 my-auto" style="width: 80vw; max-height: 85vh; overflow-y: auto;">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-xl font-bold text-white">Create Panel</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="panel-form" onsubmit="savePanel(event)">
            <input type="hidden" id="panel-id">

            <div class="grid grid-cols-2 gap-4">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Name *</label>
                        <input type="text" id="panel-name" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Description</label>
                        <textarea id="panel-description" rows="2"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Datasource *</label>
                        <select id="panel-datasource" required
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Panel Type</label>
                        <select id="panel-type"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <optgroup label="Time Series">
                                <option value="graph">Line Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="stacked_area">Stacked Area</option>
                                <option value="bar">Bar Chart</option>
                                <option value="stacked_bar">Stacked Bar</option>
                            </optgroup>
                            <optgroup label="Single Value">
                                <option value="stat">Stat (Big Number)</option>
                                <option value="gauge">Gauge</option>
                                <option value="sparkline">Sparkline</option>
                            </optgroup>
                            <optgroup label="Distribution">
                                <option value="pie">Pie Chart</option>
                                <option value="doughnut">Doughnut Chart</option>
                                <option value="heatmap">Heatmap</option>
                            </optgroup>
                            <optgroup label="Data">
                                <option value="table">Table</option>
                            </optgroup>
                        </select>
                    </div>


                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Time Range</label>
                            <select id="panel-time-range"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="3h">3 hours</option>
                                <option value="6h">6 hours</option>
                                <option value="12h">12 hours</option>
                                <option value="24h" selected>24 hours</option>
                                <option value="7d">7 days</option>
                                <option value="30d">30 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-1">Refresh (s)</label>
                            <input type="number" id="panel-refresh" value="30" min="5" max="3600"
                                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-template" class="mr-2">
                            Save as Template
                        </label>
                        <label class="flex items-center text-gray-300">
                            <input type="checkbox" id="panel-is-public" class="mr-2">
                            Public
                        </label>
                    </div>
                </div>

                <!-- Right Column - Query Editor -->
                <div class="space-y-4">
                    <!-- Query Examples -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Query Examples</label>
                        <select id="query-examples" onchange="loadQueryExample()"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                            <option value="">Select an example...</option>
                            <option value="cpu">CPU Usage (%)</option>
                            <option value="memory">Memory Usage (GB)</option>
                            <option value="disk">Disk Usage (%)</option>
                            <option value="network_rx">Network Received (MB/s)</option>
                            <option value="network_tx">Network Transmitted (MB/s)</option>
                            <option value="http_rate">HTTP Request Rate</option>
                            <option value="http_errors">HTTP Error Rate (%)</option>
                            <option value="http_latency">HTTP Request Duration p95</option>
                            <option value="alerts">Active Alerts</option>
                            <option value="up">Target Up/Down</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-sm font-medium text-gray-300">PromQL Query *</label>
                            <button type="button" onclick="testQuery()"
                                class="text-blue-400 hover:text-blue-300 text-sm">
                                Test Query
                            </button>
                        </div>
                        <textarea id="query-editor" rows="8" placeholder="Example: rate(http_requests_total[5m])"
                            class="w-full bg-gray-900 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"></textarea>
                        <p class="text-xs text-gray-400 mt-1">Enter your PromQL query or select an example above</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Legend Format</label>
                        <input type="text" id="panel-legend" placeholder="{{instance}}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        <p class="text-xs text-gray-400 mt-1">Use {{label_name}} for label values</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Tags (comma-separated)</label>
                        <input type="text" id="panel-tags" placeholder="infrastructure, cpu, monitoring"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- Query Preview Section - Full Width (outside the 2-column grid) -->
            <div id="query-result" class="hidden mt-6 border-t border-gray-700 pt-6">
                <h3 class="text-lg font-semibold text-white mb-4">Query Preview</h3>
                <div id="query-status" class="p-3 rounded text-sm mb-4"></div>
                <div id="query-preview-chart" class="hidden bg-gray-900 rounded-lg p-4 mb-4"
                    style="height: 280px; width: 100%;"></div>
                <div id="query-data-preview" class="hidden bg-gray-900 rounded-lg p-4 max-h-48 overflow-auto">
                    <div class="text-xs text-gray-400 mb-2 font-medium">Raw Data (first 3 series):</div>
                    <pre id="query-data-json" class="text-xs text-green-400 font-mono whitespace-pre-wrap"></pre>
                </div>
            </div>

            <!-- Advanced Chart Configuration -->
            <div class="mt-6 border-t border-gray-700 pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-white">Chart Configuration</h3>
                    <button type="button" onclick="toggleChartConfig()"
                        class="text-sm text-blue-400 hover:text-blue-300">
                        <i id="chart-config-icon" class="fas fa-chevron-down"></i>
                        <span id="chart-config-text">Show</span>
                    </button>
                </div>

                <div id="chart-config-section" class="hidden space-y-4">
                    <!-- Y-Axis Configuration -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Y-Axis</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Min Value</label>
                                <input type="number" id="y-axis-min" step="any" placeholder="Auto"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Max Value</label>
                                <input type="number" id="y-axis-max" step="any" placeholder="Auto"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Label</label>
                                <input type="text" id="y-axis-label" placeholder="Value"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Units & Formatting -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Units & Formatting</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Unit Format</label>
                                <select id="unit-format"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="">None (Number)</option>
                                    <option value="percent">Percent (%)</option>
                                    <option value="bytes">Bytes (B, KB, MB, GB)</option>
                                    <option value="seconds">Time (s, m, h, d)</option>
                                    <option value="milliseconds">Milliseconds (ms)</option>
                                    <option value="requests">Requests/sec</option>
                                    <option value="ops">Ops/sec</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Decimals</label>
                                <input type="number" id="decimals" min="0" max="5" value="2"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Color Scheme -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Colors</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Color Scheme</label>
                                <select id="color-scheme"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="default">Default (Blue)</option>
                                    <option value="green">Green</option>
                                    <option value="red">Red</option>
                                    <option value="purple">Purple</option>
                                    <option value="rainbow">Rainbow (Multi-color)</option>
                                    <option value="cool">Cool (Blue-Green)</option>
                                    <option value="warm">Warm (Orange-Red)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-gray-300 text-sm">
                                    <input type="checkbox" id="use-gradient" class="mr-2">
                                    Use Gradient Fill
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Thresholds -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-gray-300">Thresholds</h4>
                            <button type="button" onclick="addThreshold()"
                                class="text-xs text-green-400 hover:text-green-300">
                                <i class="fas fa-plus mr-1"></i>Add Threshold
                            </button>
                        </div>
                        <div id="thresholds-container" class="space-y-2">
                            <!-- Thresholds will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="bg-gray-800/50 rounded-lg p-4 space-y-3">
                        <h4 class="text-sm font-medium text-gray-300 mb-3">Legend</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Position</label>
                                <select id="legend-position"
                                    class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:outline-none focus:border-blue-500">
                                    <option value="bottom">Bottom</option>
                                    <option value="top">Top</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-gray-300 text-sm">
                                    <input type="checkbox" id="show-legend" checked class="mr-2">
                                    Show Legend
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="closeModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    Save Panel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/closebrackets.min.js"></script>

<script>
    let panels = [];
    let datasources = [];
    let filteredPanels = [];
    let queryEditor = null;  // CodeMirror instance
    let thresholdCounter = 0;  // Counter for threshold IDs

    async function loadDatasources() {
        try {
            const response = await apiCall('/api/datasources/?enabled_only=true');
            datasources = await response.json();

            // Populate datasource selectors
            const panelDatasource = document.getElementById('panel-datasource');
            const datasourceFilter = document.getElementById('datasource-filter');

            panelDatasource.innerHTML = '<option value="">Select datasource...</option>' +
                datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');

            datasourceFilter.innerHTML = '<option value="">All Datasources</option>' +
                datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');
        } catch (error) {
            console.error('Failed to load datasources:', error);
        }
    }

    async function loadPanels() {
        try {
            const response = await apiCall('/api/panels/?limit=500');
            panels = await response.json();
            filterPanels();
        } catch (error) {
            console.error('Failed to load panels:', error);
            showToast('Failed to load panels', 'error');
        }
    }

    // Pagination state
    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;

    function filterPanels() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const datasourceFilter = document.getElementById('datasource-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        const templatesOnly = document.getElementById('templates-only').checked;

        filteredPanels = panels.filter(panel => {
            const matchesSearch = !search ||
                panel.name.toLowerCase().includes(search) ||
                (panel.description && panel.description.toLowerCase().includes(search));

            const matchesDatasource = !datasourceFilter || panel.datasource_id === datasourceFilter;
            const matchesType = !typeFilter || panel.panel_type === typeFilter;
            const matchesTemplate = !templatesOnly || panel.is_template;

            return matchesSearch && matchesDatasource && matchesType && matchesTemplate;
        });

        currentPage = 1; // Reset to first page on filter
        renderPanels();
    }

    function getPanelTypeIcon(type) {
        // Returns icon class and color matching badge colors
        const iconConfig = {
            'graph': { icon: 'fa-chart-line', color: '#3d71d9' },      // Blue
            'area': { icon: 'fa-chart-area', color: '#3d71d9' },       // Blue
            'stacked_area': { icon: 'fa-layer-group', color: '#b877d9' }, // Purple
            'stacked_bar': { icon: 'fa-bars', color: '#b877d9' },       // Purple
            'bar': { icon: 'fa-chart-bar', color: '#6e9fff' },          // Light blue
            'gauge': { icon: 'fa-tachometer-alt', color: '#1a7f4b' },   // Green
            'stat': { icon: 'fa-hashtag', color: '#eb7b18' },           // Orange
            'sparkline': { icon: 'fa-wave-square', color: '#eb7b18' },  // Orange
            'pie': { icon: 'fa-chart-pie', color: '#d10e5c' },          // Pink/Magenta
            'doughnut': { icon: 'fa-circle-notch', color: '#d10e5c' },  // Pink/Magenta
            'heatmap': { icon: 'fa-th', color: '#ff5286' },             // Red
            'table': { icon: 'fa-table', color: '#b877d9' }             // Purple
        };
        return iconConfig[type] || { icon: 'fa-chart-bar', color: '#6e9fff' };
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }

    function truncateQuery(query, maxLen = 50) {
        if (!query) return '-';
        return query.length > maxLen ? query.substring(0, maxLen) + '...' : query;
    }

    function renderPanels() {
        const tbody = document.getElementById('panels-tbody');
        const noPanel = document.getElementById('no-panels');
        const paginationContainer = document.getElementById('pagination-container');
        const tableContainer = tbody.closest('.card');

        if (filteredPanels.length === 0) {
            tableContainer.classList.add('hidden');
            paginationContainer.classList.add('hidden');
            noPanel.classList.remove('hidden');
            return;
        }

        tableContainer.classList.remove('hidden');
        paginationContainer.classList.remove('hidden');
        noPanel.classList.add('hidden');

        // Calculate pagination
        totalPages = Math.ceil(filteredPanels.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filteredPanels.length);
        const paginatedPanels = filteredPanels.slice(start, end);

        // Update pagination info
        document.getElementById('showing-start').textContent = filteredPanels.length > 0 ? start + 1 : 0;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = filteredPanels.length;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;

        // Update pagination buttons
        document.getElementById('first-page-btn').disabled = currentPage <= 1;
        document.getElementById('prev-page-btn').disabled = currentPage <= 1;
        document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        document.getElementById('last-page-btn').disabled = currentPage >= totalPages;

        // Render table rows
        tbody.innerHTML = paginatedPanels.map(panel => {
            const datasource = datasources.find(ds => ds.id === panel.datasource_id);
            const badgeClass = `badge-${panel.panel_type}`;
            const icon = getPanelTypeIcon(panel.panel_type);

            return `
            <tr class="border-b border-[rgba(204,204,220,0.07)] hover:bg-[rgba(204,204,220,0.04)] transition-colors">
                <td class="px-4 py-3">
                    <i class="fas ${icon.icon}" style="color: ${icon.color}"></i>
                </td>
                <td class="px-4 py-3">
                    <div class="font-medium text-white">${escapeHtml(panel.name)}</div>
                    ${panel.description ? `<div class="text-xs text-[#8e8e8e] mt-0.5 truncate max-w-xs">${escapeHtml(panel.description)}</div>` : ''}
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${badgeClass}">${panel.panel_type.toUpperCase()}</span>
                    ${panel.is_template ? '<span class="badge badge-template ml-1">TEMPLATE</span>' : ''}
                </td>
                <td class="px-4 py-3 text-[#8e8e8e]">
                    ${datasource ? escapeHtml(datasource.name) : '<span class="text-[#ff5286]">Unknown</span>'}
                </td>
                <td class="px-4 py-3 hidden lg:table-cell">
                    <code class="text-xs text-[#6ccf8e] bg-[#111217] px-2 py-1 rounded">${escapeHtml(truncateQuery(panel.promql_query))}</code>
                </td>
                <td class="px-4 py-3 text-[#8e8e8e] text-xs hidden md:table-cell">
                    ${formatDate(panel.created_at)}
                </td>
                <td class="px-4 py-3 text-[#8e8e8e] text-xs hidden md:table-cell">
                    ${formatDate(panel.updated_at)}
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        <button onclick="editPanel('${panel.id}')" 
                            class="p-1.5 hover:bg-[#22252b] rounded transition-colors" 
                            style="color: #6e9fff;"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="duplicatePanel('${panel.id}')" 
                            class="p-1.5 hover:bg-[#22252b] rounded transition-colors" 
                            style="color: #6ccf8e;"
                            title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="deletePanel('${panel.id}', '${escapeHtml(panel.name)}')" 
                            class="p-1.5 hover:bg-[#22252b] rounded transition-colors" 
                            style="color: #ff5286;"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }).join('');
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderPanels();
    }

    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1;
        renderPanels();
    }

    async function duplicatePanel(panelId) {
        const panel = panels.find(p => p.id === panelId);
        if (!panel) return;

        try {
            const newPanel = {
                ...panel,
                name: panel.name + ' (Copy)',
                is_template: false
            };
            delete newPanel.id;
            delete newPanel.created_at;
            delete newPanel.updated_at;

            const response = await apiCall('/api/panels/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newPanel)
            });

            if (response.ok) {
                showToast('Panel duplicated successfully', 'success');
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to duplicate panel', 'error');
            }
        } catch (error) {
            console.error('Failed to duplicate panel:', error);
            showToast('Failed to duplicate panel', 'error');
        }
    }

    function showCreateModal() {
        document.getElementById('modal-title').textContent = 'Create Panel';
        document.getElementById('panel-form').reset();
        document.getElementById('panel-id').value = '';
        document.getElementById('panel-time-range').value = '24h';
        document.getElementById('panel-refresh').value = '30';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');

        // Initialize CodeMirror if not already initialized
        if (!queryEditor) {
            const textarea = document.getElementById('query-editor');
            queryEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'javascript',  // Use javascript mode as approximation for PromQL
                theme: 'dracula',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                placeholder: 'Example: rate(http_requests_total[5m])'
            });
        } else {
            // Clear the editor
            queryEditor.setValue('');
        }
    }

    function loadQueryExample() {
        const exampleType = document.getElementById('query-examples').value;

        const examples = {
            'cpu': '100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)',
            'memory': '(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / 1024 / 1024 / 1024',
            'disk': '100 - ((node_filesystem_avail_bytes{mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{mountpoint="/",fstype!="rootfs"})',
            'network_rx': 'rate(node_network_receive_bytes_total[5m]) / 1024 / 1024',
            'network_tx': 'rate(node_network_transmit_bytes_total[5m]) / 1024 / 1024',
            'http_rate': 'sum(rate(http_requests_total[5m])) by (method, status)',
            'http_errors': '(sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100',
            'http_latency': 'histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))',
            'alerts': 'ALERTS{alertstate="firing"}',
            'up': 'up'
        };

        if (exampleType && examples[exampleType]) {
            // Use CodeMirror instance
            if (queryEditor) {
                queryEditor.setValue(examples[exampleType]);
            }
            document.getElementById('query-examples').value = ''; // Reset dropdown
        }
    }

    function editPanel(id) {
        const panel = panels.find(p => p.id === id);
        if (!panel) return;

        document.getElementById('modal-title').textContent = 'Edit Panel';
        document.getElementById('panel-id').value = panel.id;
        document.getElementById('panel-name').value = panel.name;
        document.getElementById('panel-description').value = panel.description || '';
        document.getElementById('panel-datasource').value = panel.datasource_id;
        document.getElementById('panel-type').value = panel.panel_type;
        document.getElementById('panel-legend').value = panel.legend_format || '';
        document.getElementById('panel-time-range').value = panel.time_range;
        document.getElementById('panel-refresh').value = panel.refresh_interval;
        document.getElementById('panel-is-template').checked = panel.is_template;
        document.getElementById('panel-is-public').checked = panel.is_public;
        document.getElementById('panel-tags').value = panel.tags ? panel.tags.join(', ') : '';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');

        // Initialize CodeMirror and set query value
        if (!queryEditor) {
            const textarea = document.getElementById('query-editor');
            queryEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'javascript',
                theme: 'dracula',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true
            });
        }
        queryEditor.setValue(panel.promql_query || '');

        // Load visualization config
        const config = panel.visualization_config || {};
        document.getElementById('y-axis-min').value = config.axis?.y_min || '';
        document.getElementById('y-axis-max').value = config.axis?.y_max || '';
        document.getElementById('y-axis-label').value = config.axis?.y_label || '';
        document.getElementById('unit-format').value = config.units || '';
        document.getElementById('decimals').value = config.decimals || 2;
        document.getElementById('color-scheme').value = config.color_scheme || 'default';
        document.getElementById('use-gradient').checked = config.gradient || false;
        document.getElementById('legend-position').value = config.legend?.position || 'bottom';
        document.getElementById('show-legend').checked = config.legend?.show !== false;

        // Load thresholds
        const thresholdsContainer = document.getElementById('thresholds-container');
        thresholdsContainer.innerHTML = '';
        thresholdCounter = 0;
        if (config.thresholds && config.thresholds.length > 0) {
            config.thresholds.forEach(threshold => {
                const thresholdId = `threshold-${thresholdCounter++}`;
                const thresholdHtml = `
                    <div id="${thresholdId}" class="flex items-center gap-2 bg-gray-700/50 p-2 rounded">
                        <input type="number" step="any" placeholder="Value" value="${threshold.value}"
                            class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white threshold-value"
                            data-threshold-id="${thresholdId}">
                        <input type="text" placeholder="Label" value="${threshold.label || ''}"
                            class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white threshold-label"
                            data-threshold-id="${thresholdId}">
                        <input type="color" value="${threshold.color || '#fac858'}"
                            class="w-12 h-8 bg-gray-700 border border-gray-600 rounded cursor-pointer threshold-color"
                            data-threshold-id="${thresholdId}">
                        <button type="button" onclick="removeThreshold('${thresholdId}')"
                            class="text-red-400 hover:text-red-300 px-2">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `;
                thresholdsContainer.insertAdjacentHTML('beforeend', thresholdHtml);
            });
        }
    }

    function closeModal() {
        document.getElementById('panel-modal').classList.add('hidden');
    }

    let previewChart = null;  // ECharts instance for preview

    async function testQuery() {
        const datasourceId = document.getElementById('panel-datasource').value;
        const query = queryEditor ? queryEditor.getValue() : document.getElementById('query-editor').value;
        const timeRange = document.getElementById('panel-time-range').value;
        const panelType = document.getElementById('panel-type').value;

        if (!datasourceId || !query) {
            showToast('Please select a datasource and enter a query', 'error');
            return;
        }

        const resultDiv = document.getElementById('query-result');
        const statusDiv = document.getElementById('query-status');
        const chartDiv = document.getElementById('query-preview-chart');
        const dataDiv = document.getElementById('query-data-preview');
        const jsonPre = document.getElementById('query-data-json');

        // Show loading state
        resultDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<div class="text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i>Testing query and fetching data...</div>';
        statusDiv.className = 'p-3 rounded text-sm bg-gray-900 mb-3';
        chartDiv.classList.add('hidden');
        dataDiv.classList.add('hidden');

        try {
            // First test the query validity
            const testResponse = await apiCall('/api/panels/test-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    datasource_id: datasourceId,
                    promql_query: query
                })
            });

            const testResult = await testResponse.json();

            if (!testResult.valid) {
                statusDiv.className = 'p-3 rounded text-sm bg-red-900 border border-red-600 mb-3';
                statusDiv.innerHTML = `<div class="text-red-300">✗ ${escapeHtml(testResult.message)}</div>`;
                return;
            }

            // Query is valid, now fetch actual data for preview
            statusDiv.className = 'p-3 rounded text-sm bg-green-900 border border-green-600 mb-3';
            statusDiv.innerHTML = `
                <div class="text-green-300 font-medium">✓ ${escapeHtml(testResult.message)}</div>
                <div class="text-xs text-green-200 mt-1">Result Type: ${testResult.result_type} | Fetching preview data...</div>
            `;

            // Fetch actual data using the snapshots query endpoint (public)
            const dataResponse = await fetch(`/api/snapshots/query/data?promql_query=${encodeURIComponent(query)}&time_range=${timeRange}`);
            const queryData = await dataResponse.json();

            // API returns {data: [...]} or {data: [], error: "..."}
            if (queryData.data && Array.isArray(queryData.data) && queryData.data.length > 0) {
                const result = queryData.data;

                // Show raw data
                jsonPre.textContent = JSON.stringify(result.slice(0, 3), null, 2); // Show first 3 results
                if (result.length > 3) {
                    jsonPre.textContent += `\n... and ${result.length - 3} more series`;
                }
                dataDiv.classList.remove('hidden');

                // Render preview chart if we have data
                renderPreviewChart(result, panelType);
                chartDiv.classList.remove('hidden');
                statusDiv.innerHTML = `
                    <div class="text-green-300 font-medium">✓ Query successful - ${result.length} series returned</div>
                    <div class="text-xs text-green-200 mt-1">Result Type: ${testResult.result_type} | Time Range: ${timeRange}</div>
                `;
            } else if (queryData.error) {
                statusDiv.innerHTML += `<div class="text-yellow-300 text-xs mt-1">⚠ ${queryData.error}</div>`;
            } else {
                statusDiv.innerHTML += `<div class="text-yellow-300 text-xs mt-1">⚠ No data returned for the selected time range</div>`;
            }


        } catch (error) {
            console.error('Query test error:', error);
            statusDiv.className = 'p-3 rounded text-sm bg-red-900 border border-red-600 mb-3';
            statusDiv.innerHTML = `<div class="text-red-300">Error testing query: ${error.message}</div>`;
        }
    }

    function renderPreviewChart(data, panelType) {
        const chartDiv = document.getElementById('query-preview-chart');

        // IMPORTANT: Show the container BEFORE initializing ECharts
        chartDiv.classList.remove('hidden');
        chartDiv.style.width = '100%';
        chartDiv.style.minHeight = '200px';

        // Dispose old chart if exists
        if (previewChart) {
            previewChart.dispose();
            previewChart = null;
        }

        // Small delay to ensure the container is fully rendered
        setTimeout(() => {
            try {
                // For table, just show HTML
                if (panelType === 'table') {
                    const tableData = data.slice(0, 10).map(series => {
                        const metric = series.metric || {};
                        const value = series.values ? series.values[series.values.length - 1][1] : (series.value ? series.value[1] : 'N/A');
                        return { metric: JSON.stringify(metric), value: parseFloat(value).toFixed(2) };
                    });
                    chartDiv.innerHTML = `<div class="text-xs text-gray-400 p-4"><pre>${JSON.stringify(tableData, null, 2)}</pre></div>`;
                    return;
                }

                previewChart = echarts.init(chartDiv, 'dark');
                let option;

                // Common tooltip and grid config
                const baseTooltip = {
                    trigger: 'axis',
                    backgroundColor: '#1f2937',
                    borderColor: '#374151',
                    textStyle: { color: '#e5e7eb' }
                };
                const baseGrid = { top: 20, right: 20, bottom: 40, left: 60 };
                const baseXAxis = {
                    type: 'time',
                    axisLine: { lineStyle: { color: '#374151' } },
                    axisLabel: { color: '#9ca3af', fontSize: 10 },
                    splitLine: { show: false }
                };
                const baseYAxis = {
                    type: 'value',
                    axisLine: { lineStyle: { color: '#374151' } },
                    axisLabel: { color: '#9ca3af', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#1f2937' } }
                };

                // Color palette
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

                switch (panelType) {
                    case 'stat':
                    case 'sparkline': {
                        const latestValue = getLatestValue(data);
                        if (panelType === 'sparkline') {
                            // Mini line chart
                            const values = data[0]?.values || [];
                            option = {
                                backgroundColor: 'transparent',
                                grid: { top: 5, right: 5, bottom: 5, left: 5 },
                                xAxis: { type: 'time', show: false },
                                yAxis: { type: 'value', show: false },
                                series: [{
                                    type: 'line',
                                    data: values.map(v => [new Date(v[0] * 1000), parseFloat(v[1]) || 0]),
                                    smooth: true,
                                    showSymbol: false,
                                    lineStyle: { width: 2, color: '#3b82f6' },
                                    areaStyle: { color: 'rgba(59, 130, 246, 0.2)' }
                                }]
                            };
                        } else {
                            // Big number stat
                            option = {
                                backgroundColor: 'transparent',
                                title: {
                                    text: latestValue.toFixed(2),
                                    left: 'center',
                                    top: 'center',
                                    textStyle: { color: '#fff', fontSize: 48, fontWeight: 'bold' }
                                }
                            };
                        }
                        break;
                    }

                    case 'gauge': {
                        const latestValue = getLatestValue(data);
                        option = {
                            backgroundColor: 'transparent',
                            series: [{
                                type: 'gauge',
                                startAngle: 200,
                                endAngle: -20,
                                min: 0,
                                max: Math.max(100, latestValue * 1.2),
                                progress: { show: true, width: 20 },
                                axisLine: { lineStyle: { width: 20, color: [[0.3, '#10b981'], [0.7, '#f59e0b'], [1, '#ef4444']] } },
                                axisTick: { show: false },
                                splitLine: { show: false },
                                axisLabel: { show: true, distance: 25, color: '#9ca3af', fontSize: 10 },
                                pointer: { show: true, length: '60%', width: 6 },
                                title: { show: false },
                                detail: {
                                    valueAnimation: true,
                                    fontSize: 28,
                                    offsetCenter: [0, '70%'],
                                    color: '#fff',
                                    formatter: '{value}'
                                },
                                data: [{ value: parseFloat(latestValue.toFixed(2)) }]
                            }]
                        };
                        break;
                    }

                    case 'pie':
                    case 'doughnut': {
                        const pieData = data.slice(0, 8).map((s, idx) => ({
                            name: getMetricLabel(s.metric),
                            value: parseFloat(getLatestValueFromSeries(s)) || 0,
                            itemStyle: { color: colors[idx % colors.length] }
                        }));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                            legend: { bottom: 0, textStyle: { color: '#9ca3af', fontSize: 10 } },
                            series: [{
                                type: 'pie',
                                radius: panelType === 'doughnut' ? ['40%', '70%'] : '70%',
                                center: ['50%', '45%'],
                                data: pieData,
                                label: { show: false },
                                emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } }
                            }]
                        };
                        break;
                    }

                    case 'bar':
                    case 'stacked_bar': {
                        const categories = data.slice(0, 10).map(s => getMetricLabel(s.metric));
                        const seriesData = data.slice(0, 10).map((s, idx) => ({
                            value: parseFloat(getLatestValueFromSeries(s)) || 0,
                            itemStyle: { color: colors[idx % colors.length] }
                        }));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: baseTooltip,
                            grid: { top: 20, right: 20, bottom: 60, left: 60 },
                            xAxis: {
                                type: 'category',
                                data: categories,
                                axisLine: { lineStyle: { color: '#374151' } },
                                axisLabel: { color: '#9ca3af', fontSize: 9, rotate: 30 }
                            },
                            yAxis: baseYAxis,
                            series: [{
                                type: 'bar',
                                data: seriesData,
                                barWidth: '60%'
                            }]
                        };
                        break;
                    }

                    case 'heatmap': {
                        // Create heatmap data from time series
                        const heatmapData = [];
                        data.slice(0, 5).forEach((s, seriesIdx) => {
                            const values = s.values || [];
                            values.forEach((v, timeIdx) => {
                                heatmapData.push([timeIdx, seriesIdx, parseFloat(v[1]) || 0]);
                            });
                        });
                        const labels = data.slice(0, 5).map(s => getMetricLabel(s.metric));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: { position: 'top' },
                            grid: { top: 10, right: 60, bottom: 40, left: 100 },
                            xAxis: { type: 'category', splitArea: { show: true }, axisLabel: { show: false } },
                            yAxis: { type: 'category', data: labels, axisLabel: { color: '#9ca3af', fontSize: 10 } },
                            visualMap: {
                                min: 0,
                                max: Math.max(...heatmapData.map(d => d[2]), 100),
                                calculable: true,
                                orient: 'vertical',
                                right: 0,
                                top: 'center',
                                textStyle: { color: '#9ca3af' },
                                inRange: { color: ['#1e3a5f', '#3b82f6', '#f59e0b', '#ef4444'] }
                            },
                            series: [{
                                type: 'heatmap',
                                data: heatmapData,
                                label: { show: false }
                            }]
                        };
                        break;
                    }

                    case 'area':
                    case 'stacked_area':
                    case 'graph':
                    default: {
                        // Line/Area charts
                        const series = data.slice(0, 5).map((s, idx) => {
                            const label = getMetricLabel(s.metric);
                            const values = s.values || (s.value ? [[s.value[0], s.value[1]]] : []);
                            const isArea = panelType === 'area' || panelType === 'stacked_area';
                            const isStacked = panelType === 'stacked_area';
                            return {
                                name: label,
                                type: 'line',
                                smooth: true,
                                showSymbol: false,
                                data: values.map(v => [new Date(v[0] * 1000), parseFloat(v[1]) || 0]),
                                lineStyle: { width: 2 },
                                itemStyle: { color: colors[idx % colors.length] },
                                areaStyle: isArea ? { opacity: isStacked ? 0.8 : 0.3 } : null,
                                stack: isStacked ? 'total' : null
                            };
                        });

                        option = {
                            backgroundColor: 'transparent',
                            tooltip: baseTooltip,
                            legend: {
                                show: series.length > 1 && series.length <= 5,
                                bottom: 0,
                                textStyle: { color: '#9ca3af', fontSize: 10 }
                            },
                            grid: baseGrid,
                            xAxis: baseXAxis,
                            yAxis: baseYAxis,
                            series: series
                        };
                        break;
                    }
                }

                previewChart.setOption(option, true);
                previewChart.resize();
            } catch (err) {
                console.error('Error rendering preview chart:', err);
                chartDiv.innerHTML = '<div class="text-red-400 text-sm p-4">Error rendering chart</div>';
            }
        }, 100);
    }

    function getLatestValueFromSeries(series) {
        if (series.values && series.values.length > 0) {
            return series.values[series.values.length - 1][1];
        }
        if (series.value) {
            return series.value[1];
        }
        return 0;
    }


    function getLatestValue(data) {
        if (!data || data.length === 0) return 0;
        const first = data[0];
        if (first.values && first.values.length > 0) {
            return parseFloat(first.values[first.values.length - 1][1]) || 0;
        }
        if (first.value) {
            return parseFloat(first.value[1]) || 0;
        }
        return 0;
    }

    function getMetricLabel(metric) {
        if (!metric) return 'value';
        const keys = Object.keys(metric);
        if (keys.length === 0) return 'value';
        if (keys.includes('instance')) return metric.instance;
        if (keys.includes('job')) return metric.job;
        return metric[keys[0]] || 'value';
    }


    async function savePanel(event) {
        event.preventDefault();

        const id = document.getElementById('panel-id').value;
        const tags = document.getElementById('panel-tags').value
            .split(',')
            .map(t => t.trim())
            .filter(t => t.length > 0);

        const data = {
            name: document.getElementById('panel-name').value,
            description: document.getElementById('panel-description').value || null,
            datasource_id: document.getElementById('panel-datasource').value,
            promql_query: queryEditor ? queryEditor.getValue() : document.getElementById('query-editor').value,
            legend_format: document.getElementById('panel-legend').value || null,
            time_range: document.getElementById('panel-time-range').value,
            refresh_interval: parseInt(document.getElementById('panel-refresh').value),
            panel_type: document.getElementById('panel-type').value,
            is_template: document.getElementById('panel-is-template').checked,
            is_public: document.getElementById('panel-is-public').checked,
            tags: tags.length > 0 ? tags : null,
            visualization_config: collectChartConfig()  // Add chart configuration
        };

        // Manual validation for PromQL query (since CodeMirror hides the required textarea)
        if (!data.promql_query || !data.promql_query.trim()) {
            showToast('PromQL Query is required', 'error');
            return;
        }

        try {
            const url = id ? `/api/panels/${id}` : '/api/panels/';
            const method = id ? 'PUT' : 'POST';

            const response = await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Panel updated successfully' : 'Panel created successfully', 'success');
                closeModal();
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save panel', 'error');
            }
        } catch (error) {
            console.error('Failed to save panel:', error);
            showToast('Failed to save panel', 'error');
        }
    }

    async function deletePanel(id, name) {
        if (!confirm(`Are you sure you want to delete panel "${name}"?`)) {
            return;
        }

        try {
            const response = await apiCall(`/api/panels/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Panel deleted successfully', 'success');
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to delete panel', 'error');
            }
        } catch (error) {
            console.error('Failed to delete panel:', error);
            showToast('Failed to delete panel', 'error');
        }
    }

    // Chart Configuration Functions
    function toggleChartConfig() {
        const section = document.getElementById('chart-config-section');
        const icon = document.getElementById('chart-config-icon');
        const text = document.getElementById('chart-config-text');

        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            text.textContent = 'Hide';
        } else {
            section.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            text.textContent = 'Show';
        }
    }

    function addThreshold() {
        const container = document.getElementById('thresholds-container');
        const thresholdId = `threshold-${thresholdCounter++}`;

        const thresholdHtml = `
            <div id="${thresholdId}" class="flex items-center gap-2 bg-gray-700/50 p-2 rounded">
                <input type="number" step="any" placeholder="Value"
                    class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white threshold-value"
                    data-threshold-id="${thresholdId}">
                <input type="text" placeholder="Label (e.g., Warning)"
                    class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white threshold-label"
                    data-threshold-id="${thresholdId}">
                <input type="color" value="#fac858"
                    class="w-12 h-8 bg-gray-700 border border-gray-600 rounded cursor-pointer threshold-color"
                    data-threshold-id="${thresholdId}">
                <button type="button" onclick="removeThreshold('${thresholdId}')"
                    class="text-red-400 hover:text-red-300 px-2">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', thresholdHtml);
    }

    function removeThreshold(thresholdId) {
        const element = document.getElementById(thresholdId);
        if (element) {
            element.remove();
        }
    }

    function collectChartConfig() {
        // Collect Y-axis configuration
        const yAxisMin = document.getElementById('y-axis-min').value;
        const yAxisMax = document.getElementById('y-axis-max').value;
        const yAxisLabel = document.getElementById('y-axis-label').value;

        // Collect units and formatting
        const unitFormat = document.getElementById('unit-format').value;
        const decimals = parseInt(document.getElementById('decimals').value) || 2;

        // Collect color scheme
        const colorScheme = document.getElementById('color-scheme').value;
        const useGradient = document.getElementById('use-gradient').checked;

        // Collect thresholds
        const thresholds = [];
        document.querySelectorAll('.threshold-value').forEach(input => {
            const thresholdId = input.getAttribute('data-threshold-id');
            const value = parseFloat(input.value);
            const label = document.querySelector(`.threshold-label[data-threshold-id="${thresholdId}"]`).value;
            const color = document.querySelector(`.threshold-color[data-threshold-id="${thresholdId}"]`).value;

            if (!isNaN(value)) {
                thresholds.push({ value, label, color });
            }
        });

        // Collect legend options
        const legendPosition = document.getElementById('legend-position').value;
        const showLegend = document.getElementById('show-legend').checked;

        // Build visualization_config object
        const config = {
            axis: {
                y_min: yAxisMin ? parseFloat(yAxisMin) : null,
                y_max: yAxisMax ? parseFloat(yAxisMax) : null,
                y_label: yAxisLabel || null
            },
            units: unitFormat || null,
            decimals: decimals,
            color_scheme: colorScheme,
            gradient: useGradient,
            thresholds: thresholds.length > 0 ? thresholds : null,
            legend: {
                show: showLegend,
                position: legendPosition
            }
        };

        return config;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load data on page load
    document.addEventListener('DOMContentLoaded', async () => {
        await loadDatasources();
        await loadPanels();
    });
</script>
{% endblock %}