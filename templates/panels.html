{% extends "base.html" %}
{% set active_page = 'panels' %}

{% block title %}Metric Panels - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Panels</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-chart-bar text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Metric Panels</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/theme/dracula.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.min.css">
<style>
    .pnl-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        white-space: nowrap;
    }
    .pnl-action-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }
    .pnl-action-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
        transform: translateY(-1px);
    }
    .pnl-search-input {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 14px 8px 36px;
        font-size: 13px;
        color: #1e293b;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
    }
    .pnl-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }
    .pnl-search-wrapper .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 13px;
    }
    .pnl-dropdown {
        position: relative;
        min-width: 140px;
    }
    .pnl-dropdown-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 12px 8px 14px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        user-select: none;
        white-space: nowrap;
    }
    .pnl-dropdown.open .pnl-dropdown-trigger {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }
    .pnl-dropdown-trigger .pnl-dd-chevron {
        width: 14px;
        height: 14px;
        color: #94a3b8;
        transition: transform 0.2s ease;
    }
    .pnl-dropdown.open .pnl-dd-chevron { transform: rotate(180deg); }
    .pnl-dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        min-width: 100%;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
        z-index: 9999;
        padding: 5px;
        overflow: hidden;
        max-height: 280px;
        overflow-y: auto;
    }
    .pnl-dropdown.open .pnl-dropdown-menu { display: block; }
    .pnl-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.12s ease;
        white-space: nowrap;
    }
    .pnl-dropdown-item:hover { background: #f1f5f9; color: #1e293b; }
    .pnl-dropdown-item.selected { background: rgba(59, 130, 246, 0.08); color: #2563eb; }
    .pnl-dropdown-item .pnl-dd-check { opacity: 0; font-size: 11px; color: #3b82f6; }
    .pnl-dropdown-item.selected .pnl-dd-check { opacity: 1; }
    .pnl-dropdown select { display: none; }
    .pnl-modal-overlay { z-index: 2000; }
    .pnl-modal-dialog {
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #3b82f6;
    }
    .badge { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .badge-graph, .badge-area { background-color: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
    .badge-stacked_area, .badge-stacked_bar { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #e9d5ff; }
    .badge-bar { background-color: #eff6ff; color: #3b82f6; border: 1px solid #bfdbfe; }
    .badge-gauge { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .badge-stat, .badge-sparkline { background-color: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
    .badge-pie, .badge-doughnut { background-color: #fdf2f8; color: #db2777; border: 1px solid #fbcfe8; }
    .badge-heatmap { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
    .badge-table { background-color: #f5f3ff; color: #7c3aed; border: 1px solid #e9d5ff; }
    .badge-template { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .CodeMirror {
        height: 200px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Courier New', monospace;
        background-color: #1e293b;
    }
    .CodeMirror-gutters { background-color: #334155; border-right: 1px solid #475569; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar -->
    <div class="card p-4" style="overflow: visible; position: relative; z-index: 200;">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-wrap gap-3 items-center flex-1">
                <div class="pnl-search-wrapper flex-1 min-w-[200px]">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-input" placeholder="Search panels..."
                        onkeyup="filterPanels()" class="pnl-search-input w-full">
                </div>
                <div class="pnl-dropdown" id="datasourceDropdown">
                    <select id="datasource-filter" onchange="filterPanels()">
                        <option value="">All Datasources</option>
                    </select>
                    <div class="pnl-dropdown-trigger" onclick="togglePnlDropdown('datasourceDropdown')">
                        <span class="pnl-dd-label">All Datasources</span>
                        <svg class="pnl-dd-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="pnl-dropdown-menu" id="datasourceDropdownMenu"></div>
                </div>
                <div class="pnl-dropdown" id="typeDropdown">
                    <select id="type-filter" onchange="filterPanels()">
                        <option value="">All Types</option>
                        <option value="graph">Graph</option>
                        <option value="gauge">Gauge</option>
                        <option value="stat">Stat</option>
                        <option value="table">Table</option>
                    </select>
                    <div class="pnl-dropdown-trigger" onclick="togglePnlDropdown('typeDropdown')">
                        <span class="pnl-dd-label">All Types</span>
                        <svg class="pnl-dd-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="pnl-dropdown-menu">
                        <div class="pnl-dropdown-item selected" data-value="" onclick="selectPnlOption('typeDropdown','','All Types')"><i class="fas fa-check pnl-dd-check"></i> All Types</div>
                        <div class="pnl-dropdown-item" data-value="graph" onclick="selectPnlOption('typeDropdown','graph','Graph')"><i class="fas fa-check pnl-dd-check"></i> Graph</div>
                        <div class="pnl-dropdown-item" data-value="gauge" onclick="selectPnlOption('typeDropdown','gauge','Gauge')"><i class="fas fa-check pnl-dd-check"></i> Gauge</div>
                        <div class="pnl-dropdown-item" data-value="stat" onclick="selectPnlOption('typeDropdown','stat','Stat')"><i class="fas fa-check pnl-dd-check"></i> Stat</div>
                        <div class="pnl-dropdown-item" data-value="table" onclick="selectPnlOption('typeDropdown','table','Table')"><i class="fas fa-check pnl-dd-check"></i> Table</div>
                    </div>
                </div>
                <label class="flex items-center text-[#475569] text-sm cursor-pointer">
                    <input type="checkbox" id="templates-only" onchange="filterPanels()" class="mr-2 h-4 w-4">
                    Templates Only
                </label>
            </div>
            <div class="flex items-center gap-2" style="position: relative; z-index: 210;">
                <button onclick="showCreateModal()" class="pnl-action-btn pnl-action-primary">
                    <i class="fas fa-plus"></i>
                    <span>Create Panel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4" style="border-left: 3px solid #3b82f6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas fa-chart-bar" style="color: #2563eb; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Total Panels</p>
                    <p class="text-2xl font-bold text-primary" id="statTotal" style="line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #8b5cf6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #f5f3ff, #ede9fe);">
                    <i class="fas fa-layer-group" style="color: #7c3aed; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Templates</p>
                    <p class="text-2xl font-bold" id="statTemplates" style="color: #7c3aed; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #10b981;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #ecfdf5, #d1fae5);">
                    <i class="fas fa-chart-line" style="color: #059669; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Time Series</p>
                    <p class="text-2xl font-bold" id="statTimeSeries" style="color: #059669; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #f59e0b;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #fffbeb, #fef3c7);">
                    <i class="fas fa-hashtag" style="color: #d97706; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Stats & Gauges</p>
                    <p class="text-2xl font-bold" id="statStats" style="color: #d97706; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Panels Table -->
    <div class="card overflow-hidden" id="tableContainer">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-4 py-3 font-medium w-10"></th>
                    <th class="px-4 py-3 font-medium">Name</th>
                    <th class="px-4 py-3 font-medium">Type</th>
                    <th class="px-4 py-3 font-medium">Datasource</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Query</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Created</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Updated</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="panels-tbody" class="text-[#334155]">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="flex items-center justify-between mt-4 text-sm hidden">
        <div class="text-[#64748b]">
            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            panels
        </div>
        <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="first-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-left"></i>
            </button>
            <span class="px-3 py-1.5 text-[#475569]">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
            <button onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-right"></i>
            </button>
            <button onclick="goToPage(totalPages)" id="last-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <select id="page-size" onchange="changePageSize(this.value)"
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] focus:outline-none focus:border-[#3b82f6]">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>

    <!-- Empty State -->
    <div id="no-panels" class="hidden card p-12 text-center">
        <i class="fas fa-chart-bar text-4xl text-secondary mb-4"></i>
        <h3 class="text-lg font-medium text-primary mb-2">No Panels Found</h3>
        <p class="text-secondary mb-4">Create your first PromQL panel to visualize metrics.</p>
        <button onclick="showCreateModal()" class="btn-primary px-4 py-2 rounded-lg">
            <i class="fas fa-plus mr-2"></i>Create Panel
        </button>
    </div>
</div>

<!-- Create/Edit Panel Modal -->
<div id="panel-modal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden pnl-modal-overlay flex items-start justify-center overflow-y-auto py-8">
    <div class="card p-6 my-auto pnl-modal-dialog" style="width: 80vw; max-width: 1200px; max-height: 85vh; overflow-y: auto;">
        <div class="flex justify-between items-center mb-6 pb-4 border-b border-[#e2e8f0]">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas fa-chart-bar text-[#2563eb]"></i>
                </div>
                <div>
                    <h2 id="modal-title" class="text-xl font-bold text-primary">Create Panel</h2>
                    <p class="text-xs text-secondary mt-0.5">Configure your PromQL visualization</p>
                </div>
            </div>
            <button onclick="closeModal()" class="p-2 rounded-lg text-secondary hover:text-primary hover:bg-[#f1f5f9] transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="panel-form" onsubmit="savePanel(event)">
            <input type="hidden" id="panel-id">

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Basic Settings -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-cog text-[#64748b]"></i>
                        <h4 class="text-sm font-semibold text-primary">Basic Settings</h4>
                    </div>
                    <div>
                        <label class="block text-secondary text-sm mb-1">Panel Name *</label>
                        <input type="text" id="panel-name" required
                            class="input-field w-full px-3 py-2 rounded text-sm">
                    </div>

                    <div>
                        <label class="block text-secondary text-sm mb-1">Description</label>
                        <textarea id="panel-description" rows="2"
                            class="input-field w-full px-3 py-2 rounded text-sm resize-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-secondary text-sm mb-1">Datasource *</label>
                        <select id="panel-datasource" required
                            class="input-field w-full px-3 py-2 rounded text-sm">
                            <option value="">Select datasource...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-secondary text-sm mb-1">Panel Type</label>
                        <select id="panel-type"
                            class="input-field w-full px-3 py-2 rounded text-sm">
                            <optgroup label="Time Series">
                                <option value="graph">Line Chart</option>
                                <option value="area">Area Chart</option>
                                <option value="stacked_area">Stacked Area</option>
                                <option value="bar">Bar Chart</option>
                                <option value="stacked_bar">Stacked Bar</option>
                            </optgroup>
                            <optgroup label="Single Value">
                                <option value="stat">Stat (Big Number)</option>
                                <option value="gauge">Gauge</option>
                                <option value="sparkline">Sparkline</option>
                            </optgroup>
                            <optgroup label="Distribution">
                                <option value="pie">Pie Chart</option>
                                <option value="doughnut">Doughnut Chart</option>
                                <option value="heatmap">Heatmap</option>
                            </optgroup>
                            <optgroup label="Data">
                                <option value="table">Table</option>
                            </optgroup>
                        </select>
                    </div>


                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-secondary text-sm mb-1">Time Range</label>
                            <select id="panel-time-range"
                                class="input-field w-full px-3 py-2 rounded text-sm">
                                <option value="5m">5 minutes</option>
                                <option value="15m">15 minutes</option>
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="3h">3 hours</option>
                                <option value="6h">6 hours</option>
                                <option value="12h">12 hours</option>
                                <option value="24h" selected>24 hours</option>
                                <option value="7d">7 days</option>
                                <option value="30d">30 days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-secondary text-sm mb-1">Refresh (s)</label>
                            <input type="number" id="panel-refresh" value="30" min="5" max="3600"
                                class="input-field w-full px-3 py-2 rounded text-sm">
                        </div>
                    </div>

                    <div class="flex gap-4 flex-wrap">
                        <label class="flex items-center text-secondary text-sm cursor-pointer">
                            <input type="checkbox" id="panel-is-template" class="mr-2 h-4 w-4">
                            Save as Template
                        </label>
                        <label class="flex items-center text-secondary text-sm cursor-pointer">
                            <input type="checkbox" id="panel-is-public" class="mr-2 h-4 w-4">
                            Public
                        </label>
                    </div>
                </div>

                <!-- Right Column: Query -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-code text-[#64748b]"></i>
                        <h4 class="text-sm font-semibold text-primary">Query & Visualization</h4>
                    </div>
                    <!-- Query Examples -->
                    <div>
                        <label class="block text-secondary text-sm mb-1">Query Examples</label>
                        <select id="query-examples" onchange="loadQueryExample()"
                            class="input-field w-full px-3 py-2 rounded text-sm">
                            <option value="">Select an example...</option>
                            <option value="cpu">CPU Usage (%)</option>
                            <option value="memory">Memory Usage (GB)</option>
                            <option value="disk">Disk Usage (%)</option>
                            <option value="network_rx">Network Received (MB/s)</option>
                            <option value="network_tx">Network Transmitted (MB/s)</option>
                            <option value="http_rate">HTTP Request Rate</option>
                            <option value="http_errors">HTTP Error Rate (%)</option>
                            <option value="http_latency">HTTP Request Duration p95</option>
                            <option value="alerts">Active Alerts</option>
                            <option value="up">Target Up/Down</option>
                        </select>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-secondary text-sm">PromQL Query *</label>
                            <button type="button" onclick="testQuery()"
                                class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium bg-[#eff6ff] text-[#2563eb] hover:bg-[#dbeafe] transition-colors">
                                <i class="fas fa-bolt"></i>Test Query
                            </button>
                        </div>
                        <textarea id="query-editor" rows="8" placeholder="Example: rate(http_requests_total[5m])"
                            class="w-full border border-[#e2e8f0] rounded px-3 py-2 text-sm"></textarea>
                        <p class="text-xs text-secondary mt-1">Enter your PromQL query or select an example above</p>
                    </div>

                    <div>
                        <label class="block text-secondary text-sm mb-1">Legend Format</label>
                        <input type="text" id="panel-legend" placeholder="{{instance}}"
                            class="input-field w-full px-3 py-2 rounded text-sm">
                        <p class="text-xs text-secondary mt-1">Use {{label_name}} for label values</p>
                    </div>

                    <div>
                        <label class="block text-secondary text-sm mb-1">Tags (comma-separated)</label>
                        <input type="text" id="panel-tags" placeholder="infrastructure, cpu, monitoring"
                            class="input-field w-full px-3 py-2 rounded text-sm">
                    </div>
                </div>
            </div>

            <!-- Query Preview Section -->
            <div id="query-result" class="hidden mt-6 border-t border-[#e2e8f0] pt-6">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fas fa-eye text-[#3b82f6]"></i>
                    <h3 class="text-lg font-semibold text-primary">Query Preview</h3>
                </div>
                <div id="query-status" class="p-4 rounded-lg text-sm mb-4 bg-[#f8fafc] border border-[#e2e8f0]"></div>
                <div id="query-preview-chart" class="hidden rounded-lg p-4 mb-4 border border-[#e2e8f0] bg-[#f8fafc]"
                    style="height: 280px; width: 100%;"></div>
                <div id="query-data-preview" class="hidden rounded-lg p-4 max-h-48 overflow-auto bg-[#f8fafc] border border-[#e2e8f0]">
                    <div class="text-xs text-secondary mb-2 font-medium">Raw Data (first 3 series):</div>
                    <pre id="query-data-json" class="text-xs text-[#059669] font-mono whitespace-pre-wrap"></pre>
                </div>
            </div>

            <!-- Advanced Chart Configuration -->
            <div class="mt-6 border-t border-[#e2e8f0] pt-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-sliders-h text-[#64748b]"></i>
                        <h3 class="text-lg font-semibold text-primary">Chart Configuration</h3>
                    </div>
                    <button type="button" onclick="toggleChartConfig()"
                        class="text-sm font-medium text-[#3b82f6] hover:text-[#2563eb] flex items-center gap-1">
                        <i id="chart-config-icon" class="fas fa-chevron-down"></i>
                        <span id="chart-config-text">Show</span>
                    </button>
                </div>

                <div id="chart-config-section" class="hidden space-y-4">
                    <!-- Y-Axis Configuration -->
                    <div class="rounded-lg p-4 space-y-3 bg-[#f8fafc] border border-[#e2e8f0]">
                        <h4 class="text-sm font-medium text-primary flex items-center gap-2">
                            <i class="fas fa-chart-line text-[#94a3b8]"></i>Y-Axis
                        </h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-secondary mb-1">Min Value</label>
                                <input type="number" id="y-axis-min" step="any" placeholder="Auto"
                                    class="input-field w-full px-2 py-1.5 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-secondary mb-1">Max Value</label>
                                <input type="number" id="y-axis-max" step="any" placeholder="Auto"
                                    class="input-field w-full px-2 py-1.5 rounded text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-secondary mb-1">Label</label>
                                <input type="text" id="y-axis-label" placeholder="Value"
                                    class="input-field w-full px-2 py-1.5 rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Units & Formatting -->
                    <div class="rounded-lg p-4 space-y-3 bg-[#f8fafc] border border-[#e2e8f0]">
                        <h4 class="text-sm font-medium text-primary flex items-center gap-2">
                            <i class="fas fa-calculator text-[#94a3b8]"></i>Units & Formatting
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-secondary mb-1">Unit Format</label>
                                <select id="unit-format" class="input-field w-full px-2 py-1.5 rounded text-sm">
                                    <option value="">None (Number)</option>
                                    <option value="percent">Percent (%)</option>
                                    <option value="bytes">Bytes (B, KB, MB, GB)</option>
                                    <option value="seconds">Time (s, m, h, d)</option>
                                    <option value="milliseconds">Milliseconds (ms)</option>
                                    <option value="requests">Requests/sec</option>
                                    <option value="ops">Ops/sec</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-secondary mb-1">Decimals</label>
                                <input type="number" id="decimals" min="0" max="5" value="2"
                                    class="input-field w-full px-2 py-1.5 rounded text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Color Scheme -->
                    <div class="rounded-lg p-4 space-y-3 bg-[#f8fafc] border border-[#e2e8f0]">
                        <h4 class="text-sm font-medium text-primary flex items-center gap-2">
                            <i class="fas fa-palette text-[#94a3b8]"></i>Colors
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-secondary mb-1">Color Scheme</label>
                                <select id="color-scheme" class="input-field w-full px-2 py-1.5 rounded text-sm">
                                    <option value="default">Default (Blue)</option>
                                    <option value="green">Green</option>
                                    <option value="red">Red</option>
                                    <option value="purple">Purple</option>
                                    <option value="rainbow">Rainbow (Multi-color)</option>
                                    <option value="cool">Cool (Blue-Green)</option>
                                    <option value="warm">Warm (Orange-Red)</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-secondary text-sm cursor-pointer">
                                    <input type="checkbox" id="use-gradient" class="mr-2 h-4 w-4">
                                    Use Gradient Fill
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Thresholds -->
                    <div class="rounded-lg p-4 space-y-3 bg-[#f8fafc] border border-[#e2e8f0]">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-primary flex items-center gap-2">
                                <i class="fas fa-tachometer-alt text-[#94a3b8]"></i>Thresholds
                            </h4>
                            <button type="button" onclick="addThreshold()"
                                class="text-xs font-medium text-[#059669] hover:text-[#047857] flex items-center gap-1">
                                <i class="fas fa-plus"></i>Add Threshold
                            </button>
                        </div>
                        <div id="thresholds-container" class="space-y-2">
                            <!-- Thresholds will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="rounded-lg p-4 space-y-3 bg-[#f8fafc] border border-[#e2e8f0]">
                        <h4 class="text-sm font-medium text-primary flex items-center gap-2">
                            <i class="fas fa-list text-[#94a3b8]"></i>Legend
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-secondary mb-1">Position</label>
                                <select id="legend-position" class="input-field w-full px-2 py-1.5 rounded text-sm">
                                    <option value="bottom">Bottom</option>
                                    <option value="top">Top</option>
                                    <option value="left">Left</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center text-secondary text-sm cursor-pointer">
                                    <input type="checkbox" id="show-legend" checked class="mr-2 h-4 w-4">
                                    Show Legend
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-[#e2e8f0]">
                <button type="button" onclick="closeModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Panel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/hint/show-hint.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/addon/edit/closebrackets.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/keymap/sublime.min.js"></script>

<script>
    let panels = [];
    let datasources = [];
    let filteredPanels = [];
    let queryEditor = null;
    let thresholdCounter = 0;

    function togglePnlDropdown(id) {
        const dd = document.getElementById(id);
        const wasOpen = dd && dd.classList.contains('open');
        document.querySelectorAll('.pnl-dropdown.open').forEach(d => d.classList.remove('open'));
        if (dd && !wasOpen) dd.classList.add('open');
    }
    function selectPnlOption(dropdownId, value, label) {
        const dd = document.getElementById(dropdownId);
        if (!dd) return;
        const select = dd.querySelector('select');
        const trigger = dd.querySelector('.pnl-dd-label');
        if (select) select.value = value;
        if (trigger) trigger.textContent = label;
        dd.querySelectorAll('.pnl-dropdown-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.value === value);
        });
        dd.classList.remove('open');
        filterPanels();
    }
    function selectPnlFromData(el) {
        const value = el.dataset.value || '';
        const label = el.dataset.label || '';
        const dd = el.closest('.pnl-dropdown');
        if (dd) {
            const id = dd.id;
            selectPnlOption(id, value, label);
        }
    }
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.pnl-dropdown')) {
            document.querySelectorAll('.pnl-dropdown.open').forEach(d => d.classList.remove('open'));
        }
    });

    async function loadDatasources() {
        try {
            const response = await fetch('/api/datasources/?enabled_only=true');
            if (response.ok) {
                datasources = await response.json();
                const panelDatasource = document.getElementById('panel-datasource');
                const select = document.getElementById('datasource-filter');
                const menu = document.getElementById('datasourceDropdownMenu');

                panelDatasource.innerHTML = '<option value="">Select datasource...</option>' +
                    datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');

                select.innerHTML = '<option value="">All Datasources</option>' +
                    datasources.map(ds => `<option value="${ds.id}">${escapeHtml(ds.name)}</option>`).join('');

                if (menu) {
                    menu.innerHTML = '<div class="pnl-dropdown-item selected" data-value="" data-label="All Datasources" onclick="selectPnlFromData(this)"><i class="fas fa-check pnl-dd-check"></i> All Datasources</div>' +
                        datasources.map(ds => `<div class="pnl-dropdown-item" data-value="${ds.id}" data-label="${escapeHtml(ds.name)}" onclick="selectPnlFromData(this)"><i class="fas fa-check pnl-dd-check"></i> ${escapeHtml(ds.name)}</div>`).join('');
                }
            }
        } catch (error) {
            console.error('Failed to load datasources:', error);
        }
    }

    async function loadPanels() {
        try {
            const response = await fetch('/api/panels/?limit=500');
            if (!response.ok) throw new Error('Failed to load panels');
            panels = await response.json();
            updateStats();
            filterPanels();
        } catch (error) {
            console.error('Failed to load panels:', error);
            showToast('Failed to load panels', 'error');
        }
    }

    function updateStats() {
        const total = panels.length;
        const templates = panels.filter(p => p.is_template).length;
        const timeSeries = panels.filter(p => ['graph','area','stacked_area','bar','stacked_bar'].includes(p.panel_type)).length;
        const stats = panels.filter(p => ['stat','gauge','sparkline'].includes(p.panel_type)).length;
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statTemplates').textContent = templates;
        document.getElementById('statTimeSeries').textContent = timeSeries;
        document.getElementById('statStats').textContent = stats;
    }

    // Pagination state
    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;

    function filterPanels() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const datasourceFilter = document.getElementById('datasource-filter').value;
        const typeFilter = document.getElementById('type-filter').value;
        const templatesOnly = document.getElementById('templates-only').checked;

        filteredPanels = panels.filter(panel => {
            const matchesSearch = !search ||
                panel.name.toLowerCase().includes(search) ||
                (panel.description && panel.description.toLowerCase().includes(search));

            const matchesDatasource = !datasourceFilter || panel.datasource_id === datasourceFilter;
            const matchesType = !typeFilter || panel.panel_type === typeFilter;
            const matchesTemplate = !templatesOnly || panel.is_template;

            return matchesSearch && matchesDatasource && matchesType && matchesTemplate;
        });

        currentPage = 1; // Reset to first page on filter
        renderPanels();
    }

    function getPanelTypeIcon(type) {
        // Returns icon class and color matching badge colors
        const iconConfig = {
            'graph': { icon: 'fa-chart-line', color: '#3d71d9' },      // Blue
            'area': { icon: 'fa-chart-area', color: '#3d71d9' },       // Blue
            'stacked_area': { icon: 'fa-layer-group', color: '#b877d9' }, // Purple
            'stacked_bar': { icon: 'fa-bars', color: '#b877d9' },       // Purple
            'bar': { icon: 'fa-chart-bar', color: '#6e9fff' },          // Light blue
            'gauge': { icon: 'fa-tachometer-alt', color: '#1a7f4b' },   // Green
            'stat': { icon: 'fa-hashtag', color: '#eb7b18' },           // Orange
            'sparkline': { icon: 'fa-wave-square', color: '#eb7b18' },  // Orange
            'pie': { icon: 'fa-chart-pie', color: '#d10e5c' },          // Pink/Magenta
            'doughnut': { icon: 'fa-circle-notch', color: '#d10e5c' },  // Pink/Magenta
            'heatmap': { icon: 'fa-th', color: '#ff5286' },             // Red
            'table': { icon: 'fa-table', color: '#b877d9' }             // Purple
        };
        return iconConfig[type] || { icon: 'fa-chart-bar', color: '#6e9fff' };
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }

    function truncateQuery(query, maxLen = 50) {
        if (!query) return '-';
        return query.length > maxLen ? query.substring(0, maxLen) + '...' : query;
    }

    function renderPanels() {
        const tbody = document.getElementById('panels-tbody');
        const noPanel = document.getElementById('no-panels');
        const paginationContainer = document.getElementById('pagination-container');
        const tableContainer = tbody.closest('.card');

        if (filteredPanels.length === 0) {
            tableContainer.classList.add('hidden');
            paginationContainer.classList.add('hidden');
            noPanel.classList.remove('hidden');
            return;
        }

        tableContainer.classList.remove('hidden');
        paginationContainer.classList.remove('hidden');
        noPanel.classList.add('hidden');

        // Calculate pagination
        totalPages = Math.ceil(filteredPanels.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filteredPanels.length);
        const paginatedPanels = filteredPanels.slice(start, end);

        // Update pagination info
        document.getElementById('showing-start').textContent = filteredPanels.length > 0 ? start + 1 : 0;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = filteredPanels.length;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;

        // Update pagination buttons
        document.getElementById('first-page-btn').disabled = currentPage <= 1;
        document.getElementById('prev-page-btn').disabled = currentPage <= 1;
        document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        document.getElementById('last-page-btn').disabled = currentPage >= totalPages;

        // Render table rows
        tbody.innerHTML = paginatedPanels.map(panel => {
            const datasource = datasources.find(ds => ds.id === panel.datasource_id);
            const badgeClass = `badge-${panel.panel_type}`;
            const icon = getPanelTypeIcon(panel.panel_type);

            return `
            <tr class="border-b border-[#f1f5f9] hover:bg-[#f8fafc] transition-colors">
                <td class="px-4 py-3">
                    <i class="fas ${icon.icon}" style="color: ${icon.color}"></i>
                </td>
                <td class="px-4 py-3">
                    <div class="font-medium text-[#1e40af]">${escapeHtml(panel.name)}</div>
                    ${panel.description ? `<div class="text-xs text-[#94a3b8] mt-0.5 truncate max-w-xs">${escapeHtml(panel.description)}</div>` : ''}
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${badgeClass}">${panel.panel_type.toUpperCase()}</span>
                    ${panel.is_template ? '<span class="badge badge-template ml-1">TEMPLATE</span>' : ''}
                </td>
                <td class="px-4 py-3 text-[#475569]">
                    ${datasource ? escapeHtml(datasource.name) : '<span class="text-[#dc2626]">Unknown</span>'}
                </td>
                <td class="px-4 py-3 hidden lg:table-cell">
                    <code class="text-xs bg-[#f1f5f9] text-[#059669] px-2 py-1 rounded">${escapeHtml(truncateQuery(panel.promql_query))}</code>
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden md:table-cell">
                    ${formatDate(panel.created_at)}
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden md:table-cell">
                    ${formatDate(panel.updated_at)}
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        <button onclick="editPanel('${panel.id}')" 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #3b82f6;"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="duplicatePanel('${panel.id}')" 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #059669;"
                            title="Duplicate">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button onclick="deletePanel('${panel.id}', ${JSON.stringify(panel.name)})" 
                            class="p-1.5 hover:bg-[#fef2f2] rounded transition-colors" 
                            style="color: #dc2626;"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }).join('');
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderPanels();
    }

    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1;
        renderPanels();
    }

    async function duplicatePanel(panelId) {
        const panel = panels.find(p => p.id === panelId);
        if (!panel) return;

        try {
            const newPanel = {
                ...panel,
                name: panel.name + ' (Copy)',
                is_template: false
            };
            delete newPanel.id;
            delete newPanel.created_at;
            delete newPanel.updated_at;

            const response = await fetch('/api/panels/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newPanel)
            });

            if (response.ok) {
                showToast('Panel duplicated successfully', 'success');
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to duplicate panel', 'error');
            }
        } catch (error) {
            console.error('Failed to duplicate panel:', error);
            showToast('Failed to duplicate panel', 'error');
        }
    }

    function showCreateModal() {
        document.getElementById('modal-title').textContent = 'Create Panel';
        document.getElementById('panel-form').reset();
        document.getElementById('panel-id').value = '';
        document.getElementById('panel-time-range').value = '24h';
        document.getElementById('panel-refresh').value = '30';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');

        // Initialize CodeMirror if not already initialized
        if (!queryEditor) {
            const textarea = document.getElementById('query-editor');
            queryEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'javascript',  // Use javascript mode as approximation for PromQL
                theme: 'dracula',
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                keyMap: 'sublime',
                inputStyle: 'contenteditable',
                placeholder: 'Example: rate(http_requests_total[5m])'
            });
        } else {
            // Clear the editor
            queryEditor.setValue('');
        }
    }

    function loadQueryExample() {
        const exampleType = document.getElementById('query-examples').value;

        const examples = {
            'cpu': '100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)',
            'memory': '(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / 1024 / 1024 / 1024',
            'disk': '100 - ((node_filesystem_avail_bytes{mountpoint="/",fstype!="rootfs"} * 100) / node_filesystem_size_bytes{mountpoint="/",fstype!="rootfs"})',
            'network_rx': 'rate(node_network_receive_bytes_total[5m]) / 1024 / 1024',
            'network_tx': 'rate(node_network_transmit_bytes_total[5m]) / 1024 / 1024',
            'http_rate': 'sum(rate(http_requests_total[5m])) by (method, status)',
            'http_errors': '(sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100',
            'http_latency': 'histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le))',
            'alerts': 'ALERTS{alertstate="firing"}',
            'up': 'up'
        };

        if (exampleType && examples[exampleType]) {
            // Use CodeMirror instance
            if (queryEditor) {
                queryEditor.setValue(examples[exampleType]);
            }
            document.getElementById('query-examples').value = ''; // Reset dropdown
        }
    }

    function editPanel(id) {
        const panel = panels.find(p => p.id === id);
        if (!panel) return;

        document.getElementById('modal-title').textContent = 'Edit Panel';
        document.getElementById('panel-id').value = panel.id;
        document.getElementById('panel-name').value = panel.name;
        document.getElementById('panel-description').value = panel.description || '';
        document.getElementById('panel-datasource').value = panel.datasource_id;
        document.getElementById('panel-type').value = panel.panel_type;
        document.getElementById('panel-legend').value = panel.legend_format || '';
        document.getElementById('panel-time-range').value = panel.time_range;
        document.getElementById('panel-refresh').value = panel.refresh_interval;
        document.getElementById('panel-is-template').checked = panel.is_template;
        document.getElementById('panel-is-public').checked = panel.is_public;
        document.getElementById('panel-tags').value = panel.tags ? panel.tags.join(', ') : '';
        document.getElementById('query-result').classList.add('hidden');
        document.getElementById('panel-modal').classList.remove('hidden');

        // Initialize CodeMirror and set query value
        if (!queryEditor) {
            const textarea = document.getElementById('query-editor');
            queryEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'javascript',
                theme: 'dracula',
                lineNumbers: true,
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                lineWrapping: true,
                keyMap: 'sublime',
                inputStyle: 'contenteditable'
            });
        }
        queryEditor.setValue(panel.promql_query || '');

        // Load visualization config
        const config = panel.visualization_config || {};
        document.getElementById('y-axis-min').value = config.axis?.y_min || '';
        document.getElementById('y-axis-max').value = config.axis?.y_max || '';
        document.getElementById('y-axis-label').value = config.axis?.y_label || '';
        document.getElementById('unit-format').value = config.units || '';
        document.getElementById('decimals').value = config.decimals || 2;
        document.getElementById('color-scheme').value = config.color_scheme || 'default';
        document.getElementById('use-gradient').checked = config.gradient || false;
        document.getElementById('legend-position').value = config.legend?.position || 'bottom';
        document.getElementById('show-legend').checked = config.legend?.show !== false;

        // Load thresholds
        const thresholdsContainer = document.getElementById('thresholds-container');
        thresholdsContainer.innerHTML = '';
        thresholdCounter = 0;
        if (config.thresholds && config.thresholds.length > 0) {
            config.thresholds.forEach(threshold => {
                const thresholdId = `threshold-${thresholdCounter++}`;
                const thresholdHtml = `
                    <div id="${thresholdId}" class="flex items-center gap-2 bg-white p-3 rounded-lg border border-[#e2e8f0]">
                        <input type="number" step="any" placeholder="Value" value="${threshold.value}"
                            class="flex-1 input-field px-2 py-1 rounded text-sm threshold-value"
                            data-threshold-id="${thresholdId}">
                        <input type="text" placeholder="Label" value="${threshold.label || ''}"
                            class="flex-1 input-field px-2 py-1 rounded text-sm threshold-label"
                            data-threshold-id="${thresholdId}">
                        <input type="color" value="${threshold.color || '#fac858'}"
                            class="w-12 h-8 border border-[#e2e8f0] rounded cursor-pointer threshold-color"
                            data-threshold-id="${thresholdId}">
                        <button type="button" onclick="removeThreshold('${thresholdId}')"
                            class="text-[#dc2626] hover:text-[#b91c1c] p-2 rounded hover:bg-[#fef2f2] transition-colors">
                            <i class="fas fa-trash text-sm"></i>
                        </button>
                    </div>
                `;
                thresholdsContainer.insertAdjacentHTML('beforeend', thresholdHtml);
            });
        }
    }

    function closeModal() {
        document.getElementById('panel-modal').classList.add('hidden');
    }

    let previewChart = null;  // ECharts instance for preview

    async function testQuery() {
        const datasourceId = document.getElementById('panel-datasource').value;
        const query = queryEditor ? queryEditor.getValue() : document.getElementById('query-editor').value;
        const timeRange = document.getElementById('panel-time-range').value;
        const panelType = document.getElementById('panel-type').value;

        if (!datasourceId || !query) {
            showToast('Please select a datasource and enter a query', 'error');
            return;
        }

        const resultDiv = document.getElementById('query-result');
        const statusDiv = document.getElementById('query-status');
        const chartDiv = document.getElementById('query-preview-chart');
        const dataDiv = document.getElementById('query-data-preview');
        const jsonPre = document.getElementById('query-data-json');

        // Show loading state
        resultDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<div class="text-secondary"><i class="fas fa-spinner fa-spin mr-2"></i>Testing query and fetching data...</div>';
        statusDiv.className = 'p-4 rounded-lg text-sm bg-[#f8fafc] border border-[#e2e8f0] mb-4';
        chartDiv.classList.add('hidden');
        dataDiv.classList.add('hidden');

        try {
            // First test the query validity
            const testResponse = await fetch('/api/panels/test-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    datasource_id: datasourceId,
                    promql_query: query
                })
            });

            const testResult = await testResponse.json();

            if (!testResult.valid) {
                statusDiv.className = 'p-4 rounded-lg text-sm bg-[#fef2f2] border border-[#fecaca] mb-4';
                statusDiv.innerHTML = `<div class="text-[#dc2626] font-medium"> ${escapeHtml(testResult.message)}</div>`;
                return;
            }

            // Query is valid, now fetch actual data for preview
            statusDiv.className = 'p-4 rounded-lg text-sm bg-[#ecfdf5] border border-[#a7f3d0] mb-4';
            statusDiv.innerHTML = `
                <div class="text-[#059669] font-medium"> ${escapeHtml(testResult.message)}</div>
                <div class="text-xs text-[#047857] mt-1">Result Type: ${testResult.result_type} | Fetching preview data...</div>
            `;

            // Fetch actual data using the snapshots query endpoint (public)
            const dataResponse = await fetch(`/api/snapshots/query/data?promql_query=${encodeURIComponent(query)}&time_range=${timeRange}`);
            const queryData = await dataResponse.json();

            // API returns {data: [...]} or {data: [], error: "..."}
            if (queryData.data && Array.isArray(queryData.data) && queryData.data.length > 0) {
                const result = queryData.data;

                // Show raw data
                jsonPre.textContent = JSON.stringify(result.slice(0, 3), null, 2); // Show first 3 results
                if (result.length > 3) {
                    jsonPre.textContent += `\n... and ${result.length - 3} more series`;
                }
                dataDiv.classList.remove('hidden');

                // Render preview chart if we have data
                renderPreviewChart(result, panelType);
                chartDiv.classList.remove('hidden');
                statusDiv.innerHTML = `
                    <div class="text-[#059669] font-medium"> Query successful - ${result.length} series returned</div>
                    <div class="text-xs text-[#047857] mt-1">Result Type: ${testResult.result_type} | Time Range: ${timeRange}</div>
                `;
            } else if (queryData.error) {
                statusDiv.innerHTML += `<div class="text-[#d97706] text-xs mt-1"> ${queryData.error}</div>`;
            } else {
                statusDiv.innerHTML += `<div class="text-[#d97706] text-xs mt-1"> No data returned for the selected time range</div>`;
            }


        } catch (error) {
            console.error('Query test error:', error);
            statusDiv.className = 'p-4 rounded-lg text-sm bg-[#fef2f2] border border-[#fecaca] mb-4';
            statusDiv.innerHTML = `<div class="text-[#dc2626] font-medium">Error testing query: ${error.message}</div>`;
        }
    }

    function renderPreviewChart(data, panelType) {
        const chartDiv = document.getElementById('query-preview-chart');

        // IMPORTANT: Show the container BEFORE initializing ECharts
        chartDiv.classList.remove('hidden');
        chartDiv.style.width = '100%';
        chartDiv.style.minHeight = '200px';

        // Dispose old chart if exists
        if (previewChart) {
            previewChart.dispose();
            previewChart = null;
        }

        // Small delay to ensure the container is fully rendered
        setTimeout(() => {
            try {
                // For table, just show HTML
                if (panelType === 'table') {
                    const tableData = data.slice(0, 10).map(series => {
                        const metric = series.metric || {};
                        const value = series.values ? series.values[series.values.length - 1][1] : (series.value ? series.value[1] : 'N/A');
                        return { metric: JSON.stringify(metric), value: parseFloat(value).toFixed(2) };
                    });
                    chartDiv.innerHTML = `<div class="text-xs text-secondary p-4"><pre class="text-primary">${JSON.stringify(tableData, null, 2)}</pre></div>`;
                    return;
                }

                previewChart = echarts.init(chartDiv, 'dark');
                let option;

                // Common tooltip and grid config
                const baseTooltip = {
                    trigger: 'axis',
                    backgroundColor: '#1f2937',
                    borderColor: '#374151',
                    textStyle: { color: '#e5e7eb' }
                };
                const baseGrid = { top: 20, right: 20, bottom: 40, left: 60 };
                const baseXAxis = {
                    type: 'time',
                    axisLine: { lineStyle: { color: '#374151' } },
                    axisLabel: { color: '#9ca3af', fontSize: 10 },
                    splitLine: { show: false }
                };
                const baseYAxis = {
                    type: 'value',
                    axisLine: { lineStyle: { color: '#374151' } },
                    axisLabel: { color: '#9ca3af', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#1f2937' } }
                };

                // Color palette
                const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

                switch (panelType) {
                    case 'stat':
                    case 'sparkline': {
                        const latestValue = getLatestValue(data);
                        if (panelType === 'sparkline') {
                            // Mini line chart
                            const values = data[0]?.values || [];
                            option = {
                                backgroundColor: 'transparent',
                                grid: { top: 5, right: 5, bottom: 5, left: 5 },
                                xAxis: { type: 'time', show: false },
                                yAxis: { type: 'value', show: false },
                                series: [{
                                    type: 'line',
                                    data: values.map(v => [new Date(v[0] * 1000), parseFloat(v[1]) || 0]),
                                    smooth: true,
                                    showSymbol: false,
                                    lineStyle: { width: 2, color: '#3b82f6' },
                                    areaStyle: { color: 'rgba(59, 130, 246, 0.2)' }
                                }]
                            };
                        } else {
                            // Big number stat
                            option = {
                                backgroundColor: 'transparent',
                                title: {
                                    text: latestValue.toFixed(2),
                                    left: 'center',
                                    top: 'center',
                                    textStyle: { color: '#fff', fontSize: 48, fontWeight: 'bold' }
                                }
                            };
                        }
                        break;
                    }

                    case 'gauge': {
                        const latestValue = getLatestValue(data);
                        option = {
                            backgroundColor: 'transparent',
                            series: [{
                                type: 'gauge',
                                startAngle: 200,
                                endAngle: -20,
                                min: 0,
                                max: Math.max(100, latestValue * 1.2),
                                progress: { show: true, width: 20 },
                                axisLine: { lineStyle: { width: 20, color: [[0.3, '#10b981'], [0.7, '#f59e0b'], [1, '#ef4444']] } },
                                axisTick: { show: false },
                                splitLine: { show: false },
                                axisLabel: { show: true, distance: 25, color: '#9ca3af', fontSize: 10 },
                                pointer: { show: true, length: '60%', width: 6 },
                                title: { show: false },
                                detail: {
                                    valueAnimation: true,
                                    fontSize: 28,
                                    offsetCenter: [0, '70%'],
                                    color: '#fff',
                                    formatter: '{value}'
                                },
                                data: [{ value: parseFloat(latestValue.toFixed(2)) }]
                            }]
                        };
                        break;
                    }

                    case 'pie':
                    case 'doughnut': {
                        const pieData = data.slice(0, 8).map((s, idx) => ({
                            name: getMetricLabel(s.metric),
                            value: parseFloat(getLatestValueFromSeries(s)) || 0,
                            itemStyle: { color: colors[idx % colors.length] }
                        }));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                            legend: { bottom: 0, textStyle: { color: '#9ca3af', fontSize: 10 } },
                            series: [{
                                type: 'pie',
                                radius: panelType === 'doughnut' ? ['40%', '70%'] : '70%',
                                center: ['50%', '45%'],
                                data: pieData,
                                label: { show: false },
                                emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } }
                            }]
                        };
                        break;
                    }

                    case 'bar':
                    case 'stacked_bar': {
                        const categories = data.slice(0, 10).map(s => getMetricLabel(s.metric));
                        const seriesData = data.slice(0, 10).map((s, idx) => ({
                            value: parseFloat(getLatestValueFromSeries(s)) || 0,
                            itemStyle: { color: colors[idx % colors.length] }
                        }));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: baseTooltip,
                            grid: { top: 20, right: 20, bottom: 60, left: 60 },
                            xAxis: {
                                type: 'category',
                                data: categories,
                                axisLine: { lineStyle: { color: '#374151' } },
                                axisLabel: { color: '#9ca3af', fontSize: 9, rotate: 30 }
                            },
                            yAxis: baseYAxis,
                            series: [{
                                type: 'bar',
                                data: seriesData,
                                barWidth: '60%'
                            }]
                        };
                        break;
                    }

                    case 'heatmap': {
                        // Create heatmap data from time series
                        const heatmapData = [];
                        data.slice(0, 5).forEach((s, seriesIdx) => {
                            const values = s.values || [];
                            values.forEach((v, timeIdx) => {
                                heatmapData.push([timeIdx, seriesIdx, parseFloat(v[1]) || 0]);
                            });
                        });
                        const labels = data.slice(0, 5).map(s => getMetricLabel(s.metric));
                        option = {
                            backgroundColor: 'transparent',
                            tooltip: { position: 'top' },
                            grid: { top: 10, right: 60, bottom: 40, left: 100 },
                            xAxis: { type: 'category', splitArea: { show: true }, axisLabel: { show: false } },
                            yAxis: { type: 'category', data: labels, axisLabel: { color: '#9ca3af', fontSize: 10 } },
                            visualMap: {
                                min: 0,
                                max: Math.max(...heatmapData.map(d => d[2]), 100),
                                calculable: true,
                                orient: 'vertical',
                                right: 0,
                                top: 'center',
                                textStyle: { color: '#9ca3af' },
                                inRange: { color: ['#1e3a5f', '#3b82f6', '#f59e0b', '#ef4444'] }
                            },
                            series: [{
                                type: 'heatmap',
                                data: heatmapData,
                                label: { show: false }
                            }]
                        };
                        break;
                    }

                    case 'area':
                    case 'stacked_area':
                    case 'graph':
                    default: {
                        // Line/Area charts
                        const series = data.slice(0, 5).map((s, idx) => {
                            const label = getMetricLabel(s.metric);
                            const values = s.values || (s.value ? [[s.value[0], s.value[1]]] : []);
                            const isArea = panelType === 'area' || panelType === 'stacked_area';
                            const isStacked = panelType === 'stacked_area';
                            return {
                                name: label,
                                type: 'line',
                                smooth: true,
                                showSymbol: false,
                                data: values.map(v => [new Date(v[0] * 1000), parseFloat(v[1]) || 0]),
                                lineStyle: { width: 2 },
                                itemStyle: { color: colors[idx % colors.length] },
                                areaStyle: isArea ? { opacity: isStacked ? 0.8 : 0.3 } : null,
                                stack: isStacked ? 'total' : null
                            };
                        });

                        option = {
                            backgroundColor: 'transparent',
                            tooltip: baseTooltip,
                            legend: {
                                show: series.length > 1 && series.length <= 5,
                                bottom: 0,
                                textStyle: { color: '#9ca3af', fontSize: 10 }
                            },
                            grid: baseGrid,
                            xAxis: baseXAxis,
                            yAxis: baseYAxis,
                            series: series
                        };
                        break;
                    }
                }

                previewChart.setOption(option, true);
                previewChart.resize();
            } catch (err) {
                console.error('Error rendering preview chart:', err);
                chartDiv.innerHTML = '<div class="text-[#dc2626] text-sm p-4 font-medium">Error rendering chart</div>';
            }
        }, 100);
    }

    function getLatestValueFromSeries(series) {
        if (series.values && series.values.length > 0) {
            return series.values[series.values.length - 1][1];
        }
        if (series.value) {
            return series.value[1];
        }
        return 0;
    }


    function getLatestValue(data) {
        if (!data || data.length === 0) return 0;
        const first = data[0];
        if (first.values && first.values.length > 0) {
            return parseFloat(first.values[first.values.length - 1][1]) || 0;
        }
        if (first.value) {
            return parseFloat(first.value[1]) || 0;
        }
        return 0;
    }

    function getMetricLabel(metric) {
        if (!metric) return 'value';
        const keys = Object.keys(metric);
        if (keys.length === 0) return 'value';
        if (keys.includes('instance')) return metric.instance;
        if (keys.includes('job')) return metric.job;
        return metric[keys[0]] || 'value';
    }


    async function savePanel(event) {
        event.preventDefault();

        const id = document.getElementById('panel-id').value;
        const tags = document.getElementById('panel-tags').value
            .split(',')
            .map(t => t.trim())
            .filter(t => t.length > 0);

        const data = {
            name: document.getElementById('panel-name').value,
            description: document.getElementById('panel-description').value || null,
            datasource_id: document.getElementById('panel-datasource').value,
            promql_query: queryEditor ? queryEditor.getValue() : document.getElementById('query-editor').value,
            legend_format: document.getElementById('panel-legend').value || null,
            time_range: document.getElementById('panel-time-range').value,
            refresh_interval: parseInt(document.getElementById('panel-refresh').value),
            panel_type: document.getElementById('panel-type').value,
            is_template: document.getElementById('panel-is-template').checked,
            is_public: document.getElementById('panel-is-public').checked,
            tags: tags.length > 0 ? tags : null,
            visualization_config: collectChartConfig()  // Add chart configuration
        };

        // Manual validation for PromQL query (since CodeMirror hides the required textarea)
        if (!data.promql_query || !data.promql_query.trim()) {
            showToast('PromQL Query is required', 'error');
            return;
        }

        try {
            const url = id ? `/api/panels/${id}` : '/api/panels/';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Panel updated successfully' : 'Panel created successfully', 'success');
                closeModal();
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save panel', 'error');
            }
        } catch (error) {
            console.error('Failed to save panel:', error);
            showToast('Failed to save panel', 'error');
        }
    }

    async function deletePanel(id, name) {
        if (!confirm(`Are you sure you want to delete panel "${name}"?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/panels/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Panel deleted successfully', 'success');
                await loadPanels();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to delete panel', 'error');
            }
        } catch (error) {
            console.error('Failed to delete panel:', error);
            showToast('Failed to delete panel', 'error');
        }
    }

    // Chart Configuration Functions
    function toggleChartConfig() {
        const section = document.getElementById('chart-config-section');
        const icon = document.getElementById('chart-config-icon');
        const text = document.getElementById('chart-config-text');

        if (section.classList.contains('hidden')) {
            section.classList.remove('hidden');
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            text.textContent = 'Hide';
        } else {
            section.classList.add('hidden');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            text.textContent = 'Show';
        }
    }

    function addThreshold() {
        const container = document.getElementById('thresholds-container');
        const thresholdId = `threshold-${thresholdCounter++}`;

        const thresholdHtml = `
            <div id="${thresholdId}" class="flex items-center gap-2 bg-white p-3 rounded-lg border border-[#e2e8f0]">
                <input type="number" step="any" placeholder="Value"
                    class="flex-1 input-field px-2 py-1 rounded text-sm threshold-value"
                    data-threshold-id="${thresholdId}">
                <input type="text" placeholder="Label (e.g., Warning)"
                    class="flex-1 input-field px-2 py-1 rounded text-sm threshold-label"
                    data-threshold-id="${thresholdId}">
                <input type="color" value="#fac858"
                    class="w-12 h-8 border border-[#e2e8f0] rounded cursor-pointer threshold-color"
                    data-threshold-id="${thresholdId}">
                <button type="button" onclick="removeThreshold('${thresholdId}')"
                    class="text-[#dc2626] hover:text-[#b91c1c] p-2 rounded hover:bg-[#fef2f2] transition-colors">
                    <i class="fas fa-trash text-sm"></i>
                </button>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', thresholdHtml);
    }

    function removeThreshold(thresholdId) {
        const element = document.getElementById(thresholdId);
        if (element) {
            element.remove();
        }
    }

    function collectChartConfig() {
        // Collect Y-axis configuration
        const yAxisMin = document.getElementById('y-axis-min').value;
        const yAxisMax = document.getElementById('y-axis-max').value;
        const yAxisLabel = document.getElementById('y-axis-label').value;

        // Collect units and formatting
        const unitFormat = document.getElementById('unit-format').value;
        const decimals = parseInt(document.getElementById('decimals').value) || 2;

        // Collect color scheme
        const colorScheme = document.getElementById('color-scheme').value;
        const useGradient = document.getElementById('use-gradient').checked;

        // Collect thresholds
        const thresholds = [];
        document.querySelectorAll('.threshold-value').forEach(input => {
            const thresholdId = input.getAttribute('data-threshold-id');
            const value = parseFloat(input.value);
            const label = document.querySelector(`.threshold-label[data-threshold-id="${thresholdId}"]`).value;
            const color = document.querySelector(`.threshold-color[data-threshold-id="${thresholdId}"]`).value;

            if (!isNaN(value)) {
                thresholds.push({ value, label, color });
            }
        });

        // Collect legend options
        const legendPosition = document.getElementById('legend-position').value;
        const showLegend = document.getElementById('show-legend').checked;

        // Build visualization_config object
        const config = {
            axis: {
                y_min: yAxisMin ? parseFloat(yAxisMin) : null,
                y_max: yAxisMax ? parseFloat(yAxisMax) : null,
                y_label: yAxisLabel || null
            },
            units: unitFormat || null,
            decimals: decimals,
            color_scheme: colorScheme,
            gradient: useGradient,
            thresholds: thresholds.length > 0 ? thresholds : null,
            legend: {
                show: showLegend,
                position: legendPosition
            }
        };

        return config;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await loadDatasources();
        await loadPanels();
    });

    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const div = document.createElement('div');
            div.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-[10000] flex items-center gap-2 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
            div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i><span>${escapeHtml(message)}</span>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        };
    }
</script>
{% endblock %}