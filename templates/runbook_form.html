{% extends "layout.html" %}
{% set active_page = 'runbooks' %}

{% block title %}{{ 'Edit Runbook' if mode == 'edit' else 'Create Runbook' }} - AIOps Platform{% endblock %}

{% block content %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

<style>
    /* Sidebar navigation styles */
    .form-sidebar {
        position: sticky;
        top: 1rem;
    }

    .form-sidebar a {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        color: var(--text-secondary);
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .form-sidebar a:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .form-sidebar a.active {
        background: var(--bg-tertiary);
        color: var(--accent-primary);
        border-left-color: var(--accent-primary);
    }

    .form-sidebar a i {
        width: 1.25rem;
        margin-right: 0.75rem;
    }

    /* Section styles */
    .form-section {
        scroll-margin-top: 2rem;
    }

    /* Step card styles */
    .step-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        transition: all 0.2s;
    }

    .step-card:hover {
        border-color: var(--accent-primary);
    }

    .step-card.dragging {
        opacity: 0.5;
        border-color: var(--accent-primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .step-card .drag-handle {
        cursor: grab;
        color: var(--text-secondary);
        padding: 0.5rem;
    }

    .step-card .drag-handle:hover {
        color: var(--text-primary);
    }

    .step-card .drag-handle:active {
        cursor: grabbing;
    }

    /* CodeMirror customization */
    .CodeMirror {
        height: auto;
        min-height: 80px;
        max-height: 300px;
        border-radius: 0.375rem;
        font-size: 13px;
        border: 1px solid var(--border-color);
    }

    .CodeMirror-focused {
        border-color: var(--accent-primary);
    }

    .cm-s-dracula {
        background: var(--bg-tertiary) !important;
    }

    /* Command tabs */
    .cmd-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 0.5rem;
    }

    .cmd-tab {
        padding: 0.5rem 1rem;
        cursor: pointer;
        color: var(--text-secondary);
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .cmd-tab:hover {
        color: var(--text-primary);
    }

    .cmd-tab.active {
        color: var(--accent-primary);
        border-bottom-color: var(--accent-primary);
    }

    .cmd-content {
        display: none;
    }

    .cmd-content.active {
        display: block;
    }

    /* Trigger card */
    .trigger-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        padding: 1rem;
    }

    /* Collapsible sections in step */
    .step-advanced {
        display: none;
    }

    .step-advanced.show {
        display: block;
    }
</style>

<div class="h-full flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-shrink-0">
        <div class="flex items-center gap-4">
            <a href="/runbooks" class="text-secondary hover:text-primary transition-colors">
                <i class="fas fa-arrow-left text-lg"></i>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-primary" id="pageTitle">
                    {{ 'Edit Runbook' if mode == 'edit' else 'Create Runbook' }}
                </h1>
                <p class="text-secondary text-sm mt-1" id="pageSubtitle">
                    {{ 'Modify runbook configuration' if mode == 'edit' else 'Define a new automated remediation
                    runbook' }}
                </p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="cancelForm()" class="btn-secondary px-4 py-2 rounded-lg">
                Cancel
            </button>
            <button onclick="saveRunbook()" class="btn-primary px-4 py-2 rounded-lg flex items-center gap-2">
                <i class="fas fa-save"></i>
                <span>Save Runbook</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex gap-6 flex-1 min-h-0">
        <!-- Sidebar Navigation -->
        <div class="w-48 flex-shrink-0">
            <nav class="form-sidebar space-y-1">
                <a href="#section-basic" class="active" onclick="scrollToSection(event, 'section-basic')">
                    <i class="fas fa-info-circle"></i>
                    <span>Basic Info</span>
                </a>
                <a href="#section-steps" onclick="scrollToSection(event, 'section-steps')">
                    <i class="fas fa-list-ol"></i>
                    <span>Steps</span>
                    <span class="ml-auto text-xs bg-blue-500 bg-opacity-20 text-blue-400 px-2 py-0.5 rounded-full"
                        id="stepsCount">0</span>
                </a>
                <a href="#section-triggers" onclick="scrollToSection(event, 'section-triggers')">
                    <i class="fas fa-bolt"></i>
                    <span>Triggers</span>
                    <span class="ml-auto text-xs bg-yellow-500 bg-opacity-20 text-yellow-400 px-2 py-0.5 rounded-full"
                        id="triggersCount">0</span>
                </a>
                <a href="#section-settings" onclick="scrollToSection(event, 'section-settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </nav>

            <!-- Quick Actions -->
            <div class="mt-6 pt-6 border-t border-gray-700">
                <p class="text-xs text-secondary uppercase tracking-wider mb-3 px-4">Quick Actions</p>
                <button onclick="addStep()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-gray-800 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2 text-green-400"></i>Add Step
                </button>
                <button onclick="addTrigger()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-gray-800 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2 text-yellow-400"></i>Add Trigger
                </button>
                <button onclick="previewYAML()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary hover:bg-gray-800 rounded-lg transition-colors">
                    <i class="fas fa-code mr-2 text-purple-400"></i>Preview YAML
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <div class="flex-1 overflow-y-auto pr-2" id="formContent">
            <form id="runbookForm" class="space-y-8">
                <input type="hidden" id="runbookId" value="{{ runbook_id or '' }}">

                <!-- Section: Basic Info -->
                <section id="section-basic" class="form-section card p-6">
                    <h2 class="text-lg font-semibold text-primary mb-4 flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-400"></i>
                        Basic Information
                    </h2>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-secondary text-sm mb-1">
                                Name <span class="text-red-400">*</span>
                                <span class="info-tooltip info-tooltip-align-left info-tooltip-bottom">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">A unique, descriptive name for this runbook.</span>
                                </span>
                            </label>
                            <input type="text" id="runbookName" required class="input-field w-full px-3 py-2 rounded"
                                placeholder="e.g., Restart Nginx Service">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-secondary text-sm mb-1">
                                Category
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Group similar runbooks together for easier
                                        management.</span>
                                </span>
                            </label>
                            <select id="runbookCategory" class="input-field w-full px-3 py-2 rounded">
                                <option value="infrastructure">Infrastructure</option>
                                <option value="application">Application</option>
                                <option value="database">Database</option>
                                <option value="network">Network</option>
                                <option value="security">Security</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-secondary text-sm mb-1">
                                Description
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Explain the purpose of this runbook and when it
                                        should be used.</span>
                                </span>
                            </label>
                            <textarea id="runbookDescription" rows="3" class="input-field w-full px-3 py-2 rounded"
                                placeholder="Describe what this runbook does, when to use it, and any prerequisites..."></textarea>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-secondary text-sm mb-1">
                                Tags
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Keywords to help search and filter runbooks.</span>
                                </span>
                            </label>
                            <input type="text" id="runbookTags" class="input-field w-full px-3 py-2 rounded"
                                placeholder="web, nginx, restart (comma-separated)">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-secondary text-sm mb-1">
                                Documentation URL
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Link to external wiki or docs for this
                                        runbook.</span>
                                </span>
                            </label>
                            <input type="url" id="runbookDocUrl" class="input-field w-full px-3 py-2 rounded"
                                placeholder="https://wiki.example.com/runbooks/nginx">
                        </div>
                    </div>
                </section>

                <!-- Section: Steps -->
                <section id="section-steps" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary flex items-center gap-2">
                            <i class="fas fa-list-ol text-green-400"></i>
                            Steps
                        </h2>
                        <button type="button" onclick="addStep()"
                            class="btn-primary px-3 py-1.5 rounded text-sm flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Step
                        </button>
                    </div>

                    <p class="text-secondary text-sm mb-4">
                        <i class="fas fa-info-circle mr-1"></i>
                        Drag and drop to reorder steps. Steps execute in sequence from top to bottom.
                    </p>

                    <div id="stepsContainer" class="space-y-4">
                        <!-- Steps will be added dynamically -->
                    </div>

                    <div id="noStepsMessage" class="text-center py-8 text-secondary">
                        <i class="fas fa-layer-group text-3xl mb-3 opacity-50"></i>
                        <p>No steps defined yet. Click "Add Step" to create your first step.</p>
                    </div>
                </section>

                <!-- Section: Triggers -->
                <section id="section-triggers" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-primary flex items-center gap-2">
                            <i class="fas fa-bolt text-yellow-400"></i>
                            Triggers
                        </h2>
                        <button type="button" onclick="addTrigger()"
                            class="btn-primary px-3 py-1.5 rounded text-sm flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Trigger
                        </button>
                    </div>

                    <p class="text-secondary text-sm mb-4">
                        <i class="fas fa-info-circle mr-1"></i>
                        Triggers determine when this runbook executes automatically. Runbook executes if
                        <strong>ANY</strong> trigger matches.
                    </p>

                    <div id="triggersContainer" class="space-y-4">
                        <!-- Triggers will be added dynamically -->
                    </div>

                    <div id="noTriggersMessage" class="text-center py-8 text-secondary">
                        <i class="fas fa-bolt text-3xl mb-3 opacity-50"></i>
                        <p>No triggers defined. This runbook can only be executed manually.</p>
                    </div>
                </section>

                <!-- Section: Settings -->
                <section id="section-settings" class="form-section card p-6">
                    <h2 class="text-lg font-semibold text-primary mb-4 flex items-center gap-2">
                        <i class="fas fa-cog text-gray-400"></i>
                        Settings
                    </h2>

                    <div class="space-y-6">
                        <!-- Status -->
                        <div>
                            <label class="block text-secondary text-sm mb-2">
                                Status
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text"><strong>Draft:</strong> Testing
                                        only.<br><strong>Active:</strong> Enabled for
                                        execution.<br><strong>Disabled:</strong> Cannot be executed.</span>
                                </span>
                            </label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="status" value="draft" checked class="text-blue-500">
                                    <span class="text-primary">Draft</span>
                                    <span class="text-xs text-secondary">(Testing mode)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="status" value="active" class="text-green-500">
                                    <span class="text-primary">Active</span>
                                    <span class="text-xs text-secondary">(Auto-execute enabled)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="status" value="disabled" class="text-gray-500">
                                    <span class="text-primary">Disabled</span>
                                </label>
                            </div>
                        </div>

                        <!-- Approval Settings -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Approval Required
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Control whether human approval is needed before
                                            execution.</span>
                                    </span>
                                </label>
                                <select id="approvalRequired" class="input-field w-full px-3 py-2 rounded">
                                    <option value="none">None (Execute immediately)</option>
                                    <option value="manual" selected>Manual Approval</option>
                                    <option value="auto">Auto-approve after timeout</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Approval Timeout (minutes)
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Time before auto-approval (if enabled) or
                                            expiry.</span>
                                    </span>
                                </label>
                                <input type="number" id="approvalTimeout" value="30" min="1" max="1440"
                                    class="input-field w-full px-3 py-2 rounded">
                            </div>
                        </div>

                        <!-- Rate Limiting -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Max Executions per Hour
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Limit how often this runbook can run to prevent
                                            storms.</span>
                                    </span>
                                </label>
                                <input type="number" id="maxExecutions" value="5" min="1" max="100"
                                    class="input-field w-full px-3 py-2 rounded">
                            </div>
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Cooldown (minutes)
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Wait time between executions to prevent
                                            flapping.</span>
                                    </span>
                                </label>
                                <input type="number" id="cooldownMinutes" value="10" min="0" max="1440"
                                    class="input-field w-full px-3 py-2 rounded">
                            </div>
                        </div>

                        <!-- Target Settings -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Default Server
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Server to run on if none is specified in
                                            execution.</span>
                                    </span>
                                </label>
                                <select id="defaultServer" class="input-field w-full px-3 py-2 rounded">
                                    <option value="">None (derive from alert)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Target OS Filter
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Restrict this runbook to specific operating
                                            systems.</span>
                                    </span>
                                </label>
                                <div class="flex gap-4 mt-2">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="osLinux" checked class="text-blue-500">
                                        <span class="text-primary">Linux</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" id="osWindows" checked class="text-blue-500">
                                        <span class="text-primary">Windows</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Alert Target -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="targetFromAlert" checked class="text-blue-500">
                                    <span class="text-secondary text-sm">Extract target server from alert</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-secondary text-sm mb-1">
                                    Alert Label for Target
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Alert label containing the hostname/IP (e.g.,
                                            'instance').</span>
                                    </span>
                                </label>
                                <input type="text" id="targetAlertLabel" value="instance"
                                    class="input-field w-full px-3 py-2 rounded" placeholder="instance">
                            </div>
                        </div>
                    </div>
                </section>
            </form>
        </div>
    </div>
</div>

<!-- YAML Preview Modal -->
<div id="yamlModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary">YAML Preview</h2>
            <button onclick="closeYAMLModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-auto">
            <pre id="yamlContent"
                class="bg-gray-900 p-4 rounded-lg text-sm text-green-400 font-mono overflow-auto"></pre>
        </div>
        <div class="flex justify-end gap-3 mt-4">
            <button onclick="copyYAML()" class="btn-secondary px-4 py-2 rounded-lg">
                <i class="fas fa-copy mr-2"></i>Copy
            </button>
            <button onclick="closeYAMLModal()" class="btn-primary px-4 py-2 rounded-lg">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/powershell/powershell.min.js"></script>

<!-- Sortable.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    // Global state
    let stepCounter = 0;
    let triggerCounter = 0;
    let codeMirrorInstances = {};
    let servers = [];
    let apiProfiles = [];
    const mode = '{{ mode }}';
    const runbookId = '{{ runbook_id or "" }}';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function () {
        await loadServers();
        await loadApiProfiles();

        if (mode === 'edit' && runbookId) {
            await loadRunbook(runbookId);
        }

        // Initialize sortable for steps
        initSortable();

        // Setup scroll spy for sidebar
        setupScrollSpy();

        updateCounts();
    });

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            if (response.ok) {
                servers = await response.json();
                populateServerDropdown();
            }
        } catch (error) {
            console.error('Error loading servers:', error);
        }
    }

    async function loadApiProfiles() {
        try {
            const response = await fetch('/api/credential-profiles?enabled_only=true');
            if (response.ok) {
                apiProfiles = await response.json();
                updateApiProfileDropdowns();
            }
        } catch (error) {
            console.error('Error loading API profiles:', error);
        }
    }

    function updateApiProfileDropdowns() {
        document.querySelectorAll('.step-api-profile').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select API Credential Profile --</option>';
            apiProfiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name} (${profile.base_url})`;
                if (profile.id === currentValue) option.selected = true;
                select.appendChild(option);
            });
        });
    }

    function populateServerDropdown() {
        const select = document.getElementById('defaultServer');
        select.innerHTML = '<option value="">None (derive from alert)</option>';
        servers.forEach(server => {
            const option = document.createElement('option');
            option.value = server.id;
            option.textContent = `${server.name} (${server.hostname})`;
            select.appendChild(option);
        });
    }

    async function loadRunbook(id) {
        try {
            const response = await fetch(`/api/remediation/runbooks/${id}`);
            if (!response.ok) {
                showToast('Failed to load runbook', 'error');
                return;
            }

            const runbook = await response.json();

            // Populate basic info
            document.getElementById('runbookName').value = runbook.name || '';
            document.getElementById('runbookDescription').value = runbook.description || '';
            document.getElementById('runbookCategory').value = runbook.category || 'infrastructure';
            document.getElementById('runbookTags').value = (runbook.tags || []).join(', ');
            document.getElementById('runbookDocUrl').value = runbook.documentation_url || '';

            // Status
            let status = 'draft';
            if (!runbook.enabled) status = 'disabled';
            else if (runbook.auto_execute) status = 'active';
            document.querySelector(`input[name="status"][value="${status}"]`).checked = true;

            // Settings
            let approval = 'manual';
            if (!runbook.approval_required) approval = 'none';
            else if (runbook.approval_timeout_minutes <= 5) approval = 'auto';
            document.getElementById('approvalRequired').value = approval;
            document.getElementById('approvalTimeout').value = runbook.approval_timeout_minutes || 30;
            document.getElementById('maxExecutions').value = runbook.max_executions_per_hour || 5;
            document.getElementById('cooldownMinutes').value = runbook.cooldown_minutes || 10;
            document.getElementById('defaultServer').value = runbook.default_server_id || '';

            const osFilter = runbook.target_os_filter || ['linux', 'windows'];
            document.getElementById('osLinux').checked = osFilter.includes('linux');
            document.getElementById('osWindows').checked = osFilter.includes('windows');
            document.getElementById('targetFromAlert').checked = runbook.target_from_alert !== false;
            document.getElementById('targetAlertLabel').value = runbook.target_alert_label || 'instance';

            // Load steps
            if (runbook.steps && runbook.steps.length > 0) {
                runbook.steps.sort((a, b) => a.step_order - b.step_order);
                for (const step of runbook.steps) {
                    addStep(step);
                }
            }

            // Load triggers
            if (runbook.triggers && runbook.triggers.length > 0) {
                for (const trigger of runbook.triggers) {
                    addTrigger(trigger);
                }
            }

            updateCounts();

        } catch (error) {
            console.error('Error loading runbook:', error);
            showToast('Error loading runbook', 'error');
        }
    }

    function initSortable() {
        const container = document.getElementById('stepsContainer');
        new Sortable(container, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'dragging',
            onEnd: function (evt) {
                updateStepNumbers();
            }
        });
    }

    function updateStepNumbers() {
        const steps = document.querySelectorAll('.step-card');
        steps.forEach((step, index) => {
            const numberEl = step.querySelector('.step-number');
            if (numberEl) {
                numberEl.textContent = index + 1;
            }
        });
    }

    function setupScrollSpy() {
        const sections = document.querySelectorAll('.form-section');
        const navLinks = document.querySelectorAll('.form-sidebar a');
        const formContent = document.getElementById('formContent');

        formContent.addEventListener('scroll', () => {
            let current = '';

            sections.forEach(section => {
                const sectionTop = section.offsetTop - formContent.offsetTop;
                if (formContent.scrollTop >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    }

    function scrollToSection(event, sectionId) {
        event.preventDefault();
        const section = document.getElementById(sectionId);
        const formContent = document.getElementById('formContent');

        formContent.scrollTo({
            top: section.offsetTop - formContent.offsetTop,
            behavior: 'smooth'
        });

        // Update active state
        document.querySelectorAll('.form-sidebar a').forEach(a => a.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function addStep(stepData = null) {
        stepCounter++;
        const container = document.getElementById('stepsContainer');
        const stepId = `step-${stepCounter}`;

        const stepHtml = `
        <div class="step-card" id="${stepId}" data-step-id="${stepData?.id || ''}">
            <div class="flex items-center gap-3 p-4 border-b border-gray-700">
                <div class="drag-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="w-8 h-8 rounded-full bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <span class="step-number text-blue-400 font-medium">${document.querySelectorAll('.step-card').length + 1}</span>
                </div>
                <input type="text" class="step-name input-field flex-1 px-3 py-1.5 rounded text-sm" 
                    placeholder="Step name" value="${escapeHtml(stepData?.name || '')}">
                <select class="step-os input-field px-2 py-1.5 rounded text-sm w-28">
                    <option value="any" ${stepData?.target_os === 'any' ? 'selected' : ''}>Any OS</option>
                    <option value="linux" ${stepData?.target_os === 'linux' ? 'selected' : ''}>Linux</option>
                    <option value="windows" ${stepData?.target_os === 'windows' ? 'selected' : ''}>Windows</option>
                </select>
                <button type="button" onclick="toggleStepAdvanced('${stepId}')" class="text-secondary hover:text-primary p-1" title="Advanced settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" onclick="removeStep('${stepId}')" class="text-red-400 hover:text-red-300 p-1" title="Remove step">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="p-4">
                <!-- Step Type Selector -->
                <div class="mb-4">
                    <label class="block text-secondary text-xs mb-2">Step Type</label>
                    <select class="step-type input-field w-full px-3 py-2 rounded" onchange="toggleStepType('${stepId}')">
                        <option value="command" ${!stepData || stepData?.step_type === 'command' ? 'selected' : ''}>Command (SSH/WinRM)</option>
                        <option value="api" ${stepData?.step_type === 'api' ? 'selected' : ''}>API / REST Call</option>
                    </select>
                </div>

                <!-- API Credential Profile Selector (for API steps) -->
                <div class="mb-4" id="${stepId}-api-profile" style="${stepData?.step_type === 'api' ? '' : 'display:none'}">
                    <label class="block text-secondary text-xs mb-1">
                        API Credential Profile <span class="text-red-400">*</span>
                    </label>
                    <select class="step-api-profile input-field w-full px-3 py-2 rounded text-sm">
                        <option value="">-- Select API Credential Profile --</option>
                        <!-- Populated via JavaScript from /api/credential-profiles -->
                    </select>
                    <p class="text-xs text-secondary mt-1">
                        <i class="fas fa-info-circle mr-1"></i>Provides: Base URL + Authentication (endpoint path specified below)
                    </p>
                </div>

                <!-- Command Configuration (for command type) -->
                <div class="step-command-config" id="${stepId}-command-config" style="${stepData?.step_type === 'api' ? 'display:none' : ''}">
                    <div class="cmd-tabs">
                        <div class="cmd-tab active" onclick="switchCmdTab('${stepId}', 'linux')">
                            <i class="fab fa-linux mr-1"></i> Linux
                        </div>
                        <div class="cmd-tab" onclick="switchCmdTab('${stepId}', 'windows')">
                            <i class="fab fa-windows mr-1"></i> Windows
                        </div>
                    </div>

                    <div class="cmd-content active" id="${stepId}-linux-content">
                        <textarea id="${stepId}-linux" class="step-cmd-linux w-full" placeholder="# Bash command...">${escapeHtml(stepData?.command_linux || '')}</textarea>
                    </div>
                    <div class="cmd-content" id="${stepId}-windows-content">
                        <textarea id="${stepId}-windows" class="step-cmd-windows w-full" placeholder="# PowerShell command...">${escapeHtml(stepData?.command_windows || '')}</textarea>
                    </div>
                </div>

                <!-- API Configuration (for api type) -->
                <div class="step-api-config" id="${stepId}-api-config" style="${stepData?.step_type === 'api' ? '' : 'display:none'}">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">HTTP Method <span class="text-red-400">*</span></label>
                            <select class="step-api-method input-field w-full px-3 py-2 rounded text-sm">
                                <option value="GET" ${stepData?.api_method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${stepData?.api_method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${stepData?.api_method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${stepData?.api_method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                <option value="PATCH" ${stepData?.api_method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                                <option value="HEAD" ${stepData?.api_method === 'HEAD' ? 'selected' : ''}>HEAD</option>
                                <option value="OPTIONS" ${stepData?.api_method === 'OPTIONS' ? 'selected' : ''}>OPTIONS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">API Endpoint Path <span class="text-red-400">*</span></label>
                            <input type="text" class="step-api-endpoint input-field w-full px-3 py-2 rounded text-sm"
                                placeholder="/jobs/launch or /api/resource" value="${escapeHtml(stepData?.api_endpoint || '')}">
                            <p class="text-xs text-secondary mt-1">Path appended to credential profile's base URL</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Body Type</label>
                            <select class="step-api-body-type input-field w-full px-3 py-2 rounded text-sm">
                                <option value="json" ${!stepData || stepData?.api_body_type === 'json' ? 'selected' : ''}>JSON</option>
                                <option value="form" ${stepData?.api_body_type === 'form' ? 'selected' : ''}>Form Data</option>
                                <option value="raw" ${stepData?.api_body_type === 'raw' ? 'selected' : ''}>Raw Text</option>
                                <option value="template" ${stepData?.api_body_type === 'template' ? 'selected' : ''}>Jinja2 Template</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Expected Status Codes</label>
                            <input type="text" class="step-api-status-codes input-field w-full px-3 py-2 rounded text-sm"
                                placeholder="200,201,202" value="${(stepData?.api_expected_status_codes || [200, 201, 202, 204]).join(',')}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Request Body
                            <span class="text-xs text-secondary ml-2">(Supports Jinja2: {{ '{{' }} server.hostname {{ '}}' }}, {{ '{{' }} alert.labels.instance {{ '}}' }})</span>
                        </label>
                        <textarea class="step-api-body input-field w-full px-3 py-2 rounded text-sm font-mono" rows="4"
                            placeholder='{"key": "value"} or template with variables'>${escapeHtml(stepData?.api_body || '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Custom Headers (JSON)
                            <span class="text-xs text-secondary ml-2">(Merged with server defaults)</span>
                        </label>
                        <textarea class="step-api-headers input-field w-full px-3 py-2 rounded text-sm font-mono" rows="3"
                            placeholder='{"Content-Type": "application/json", "X-Custom-Header": "value"}'>${escapeHtml(stepData?.api_headers_json ? JSON.stringify(stepData.api_headers_json, null, 2) : '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Query Parameters (JSON)
                        </label>
                        <textarea class="step-api-query-params input-field w-full px-3 py-2 rounded text-sm font-mono" rows="2"
                            placeholder='{"param1": "value1", "param2": "value2"}'>${escapeHtml(stepData?.api_query_params_json ? JSON.stringify(stepData.api_query_params_json, null, 2) : '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Response Value Extraction (JSON)
                            <span class="text-xs text-secondary ml-2">(JSONPath: $.field.subfield or Regex: pattern)</span>
                        </label>
                        <textarea class="step-api-extract input-field w-full px-3 py-2 rounded text-sm font-mono" rows="3"
                            placeholder='{"job_id": "$.id", "status": "$.status"}'>${escapeHtml(stepData?.api_response_extract_json ? JSON.stringify(stepData.api_response_extract_json, null, 2) : '')}</textarea>
                    </div>
                </div>
                
                <!-- Advanced Settings (collapsed by default) -->
                <div class="step-advanced mt-4 pt-4 border-t border-gray-700" id="${stepId}-advanced">
                    
                    <!-- Output Configuration -->
                    <div class="mb-4 pb-4 border-b border-gray-700">
                        <h5 class="text-xs font-semibold text-secondary uppercase tracking-wider mb-3">Output Configuration</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Output Variable Name
                                    <span class="text-xs text-secondary ml-2 group relative cursor-help">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip hidden absolute bottom-full left-0 bg-gray-800 text-xs p-2 rounded w-48 z-10 transition-opacity opacity-0 group-hover:opacity-100 pointer-events-none">
                                            Variable name to store this step's output (e.g., process_id). Access in later steps as {{ process_id }}
                                        </span>
                                    </span>
                                </label>
                                <input type="text" class="step-output-variable input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. process_id" value="${escapeHtml(stepData?.output_variable || '')}">
                            </div>
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Extraction Regex (Optional)
                                    <span class="text-xs text-secondary ml-2 group relative cursor-help">
                                        <i class="fas fa-info-circle"></i>
                                        <span class="tooltip hidden absolute bottom-full left-0 bg-gray-800 text-xs p-2 rounded w-48 z-10 transition-opacity opacity-0 group-hover:opacity-100 pointer-events-none">
                                            Regex to extract specific value from output (e.g., PID: (\d+))
                                        </span>
                                    </span>
                                </label>
                                <input type="text" class="step-output-pattern input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. PID: (\d+)" value="${escapeHtml(stepData?.output_extract_pattern || '')}">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Timeout (seconds)</label>
                            <input type="number" class="step-timeout input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.timeout_seconds || 60}" min="1" max="3600">
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Retry Count</label>
                            <input type="number" class="step-retry input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.retry_count || 0}" min="0" max="5">
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Expected Exit Code</label>
                            <input type="number" class="step-exit-code input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.expected_exit_code || 0}">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="step-continue-on-fail" ${stepData?.continue_on_fail ? 'checked' : ''}>
                                <span class="text-secondary text-sm">Continue on failure</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="step-elevation" ${stepData?.requires_elevation ? 'checked' : ''}>
                                <span class="text-secondary text-sm">Requires elevation (sudo/admin)</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">Description</label>
                        <input type="text" class="step-description input-field w-full px-2 py-1 rounded text-sm" 
                            placeholder="Optional description" value="${escapeHtml(stepData?.description || '')}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Rollback Command (Linux)</label>
                            <textarea class="step-rollback-linux input-field w-full px-2 py-1 rounded text-sm" rows="2" 
                                placeholder="Command to undo this step">${escapeHtml(stepData?.rollback_command_linux || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Rollback Command (Windows)</label>
                            <textarea class="step-rollback-windows input-field w-full px-2 py-1 rounded text-sm" rows="2" 
                                placeholder="Command to undo this step">${escapeHtml(stepData?.rollback_command_windows || '')}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', stepHtml);
        document.getElementById('noStepsMessage').style.display = 'none';

        // Initialize CodeMirror for command textareas
        initCodeMirror(`${stepId}-linux`, 'shell');
        initCodeMirror(`${stepId}-windows`, 'powershell');

        // Populate API profile dropdown for this step
        updateApiProfileDropdowns();

        // Pre-select the profile if provided in stepData
        if (stepData?.api_credential_profile_id) {
            const profileSelect = document.querySelector(`#${stepId} .step-api-profile`);
            if (profileSelect) {
                profileSelect.value = stepData.api_credential_profile_id;
            }
        }

        updateCounts();
    }

    function initCodeMirror(textareaId, mode) {
        const textarea = document.getElementById(textareaId);
        if (!textarea) return;

        const editor = CodeMirror.fromTextArea(textarea, {
            mode: mode === 'powershell' ? 'powershell' : 'shell',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            viewportMargin: Infinity
        });

        codeMirrorInstances[textareaId] = editor;
    }

    function switchCmdTab(stepId, tab) {
        const step = document.getElementById(stepId);

        // Update tab styles
        step.querySelectorAll('.cmd-tab').forEach(t => t.classList.remove('active'));
        step.querySelector(`.cmd-tab:${tab === 'linux' ? 'first-child' : 'last-child'}`).classList.add('active');

        // Show/hide content
        step.querySelectorAll('.cmd-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${stepId}-${tab}-content`).classList.add('active');

        // Refresh CodeMirror
        const editor = codeMirrorInstances[`${stepId}-${tab}`];
        if (editor) {
            setTimeout(() => editor.refresh(), 10);
        }
    }

    function toggleStepType(stepId) {
        const step = document.getElementById(stepId);
        const stepType = step.querySelector('.step-type').value;
        const commandConfig = document.getElementById(`${stepId}-command-config`);
        const apiConfig = document.getElementById(`${stepId}-api-config`);
        const apiProfileSelector = document.getElementById(`${stepId}-api-profile`);

        if (stepType === 'api') {
            commandConfig.style.display = 'none';
            apiConfig.style.display = 'block';
            if (apiProfileSelector) apiProfileSelector.style.display = 'block';
        } else {
            commandConfig.style.display = 'block';
            apiConfig.style.display = 'none';
            if (apiProfileSelector) apiProfileSelector.style.display = 'none';
        }
    }

    function toggleStepAdvanced(stepId) {
        const advanced = document.getElementById(`${stepId}-advanced`);
        advanced.classList.toggle('show');
    }

    function removeStep(stepId) {
        document.getElementById(stepId).remove();
        updateStepNumbers();
        updateCounts();

        // Show empty message if no steps
        if (document.querySelectorAll('.step-card').length === 0) {
            document.getElementById('noStepsMessage').style.display = 'block';
        }

        // Cleanup CodeMirror instances
        delete codeMirrorInstances[`${stepId}-linux`];
        delete codeMirrorInstances[`${stepId}-windows`];
    }

    function addTrigger(triggerData = null) {
        triggerCounter++;
        const container = document.getElementById('triggersContainer');
        const triggerId = `trigger-${triggerCounter}`;

        const triggerHtml = `
        <div class="trigger-card" id="${triggerId}" data-trigger-id="${triggerData?.id || ''}">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-primary flex items-center gap-2">
                    <i class="fas fa-bolt text-yellow-400"></i>
                    Trigger ${triggerCounter}
                </span>
                <button type="button" onclick="removeTrigger('${triggerId}')" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-secondary text-xs mb-1">Alert Name Pattern</label>
                    <input type="text" class="trigger-alert-name input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., CPU.*high, HighMemory*" value="${escapeHtml(triggerData?.alert_name_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Severity</label>
                    <select class="trigger-severity input-field w-full px-2 py-1.5 rounded text-sm">
                        <option value="*" ${triggerData?.severity_pattern === '*' ? 'selected' : ''}>Any</option>
                        <option value="critical" ${triggerData?.severity_pattern === 'critical' ? 'selected' : ''}>Critical</option>
                        <option value="warning" ${triggerData?.severity_pattern === 'warning' ? 'selected' : ''}>Warning</option>
                        <option value="info" ${triggerData?.severity_pattern === 'info' ? 'selected' : ''}>Info</option>
                    </select>
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Instance Pattern</label>
                    <input type="text" class="trigger-instance input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., prod-*, 10.0.0.*" value="${escapeHtml(triggerData?.instance_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Job Pattern</label>
                    <input type="text" class="trigger-job input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., nginx, node-exporter" value="${escapeHtml(triggerData?.job_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Min Duration (seconds)</label>
                    <input type="number" class="trigger-duration input-field w-full px-2 py-1.5 rounded text-sm" 
                        value="${triggerData?.min_duration_seconds || 0}" min="0">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Priority (lower = higher)</label>
                    <input type="number" class="trigger-priority input-field w-full px-2 py-1.5 rounded text-sm" 
                        value="${triggerData?.priority || 100}" min="1" max="1000">
                </div>
            </div>
            
            <div class="mt-3">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="trigger-enabled" ${triggerData?.enabled !== false ? 'checked' : ''}>
                    <span class="text-secondary text-sm">Trigger enabled</span>
                </label>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', triggerHtml);
        document.getElementById('noTriggersMessage').style.display = 'none';

        updateCounts();
    }

    function removeTrigger(triggerId) {
        document.getElementById(triggerId).remove();
        updateCounts();

        if (document.querySelectorAll('.trigger-card').length === 0) {
            document.getElementById('noTriggersMessage').style.display = 'block';
        }
    }

    function updateCounts() {
        const stepsCount = document.querySelectorAll('.step-card').length;
        const triggersCount = document.querySelectorAll('.trigger-card').length;

        document.getElementById('stepsCount').textContent = stepsCount;
        document.getElementById('triggersCount').textContent = triggersCount;
    }

    function collectFormData() {
        // Sync CodeMirror instances to textareas
        Object.values(codeMirrorInstances).forEach(editor => editor.save());

        // Collect steps
        const steps = [];
        document.querySelectorAll('.step-card').forEach((stepEl, index) => {
            const stepId = stepEl.id;
            const stepType = stepEl.querySelector('.step-type').value;

            const stepData = {
                id: stepEl.dataset.stepId || null,
                step_order: index + 1,
                step_type: stepType,
                name: stepEl.querySelector('.step-name').value || `Step ${index + 1}`,
                description: stepEl.querySelector('.step-description')?.value || null,
                target_os: stepEl.querySelector('.step-os').value,
                timeout_seconds: parseInt(stepEl.querySelector('.step-timeout')?.value) || 60,
                requires_elevation: stepEl.querySelector('.step-elevation')?.checked || false,
                continue_on_fail: stepEl.querySelector('.step-continue-on-fail')?.checked || false,
                retry_count: parseInt(stepEl.querySelector('.step-retry')?.value) || 0,
                retry_delay_seconds: 5,
                expected_exit_code: parseInt(stepEl.querySelector('.step-exit-code')?.value) || 0,
                output_variable: stepEl.querySelector('.step-output-variable')?.value || null,
                output_extract_pattern: stepEl.querySelector('.step-output-pattern')?.value || null,
                rollback_command_linux: stepEl.querySelector('.step-rollback-linux')?.value || null,
                rollback_command_windows: stepEl.querySelector('.step-rollback-windows')?.value || null
            };

            // Add command-specific fields
            if (stepType === 'command') {
                stepData.command_linux = codeMirrorInstances[`${stepId}-linux`]?.getValue() || null;
                stepData.command_windows = codeMirrorInstances[`${stepId}-windows`]?.getValue() || null;
            }
            // Add API-specific fields
            else if (stepType === 'api') {
                stepData.api_credential_profile_id = stepEl.querySelector('.step-api-profile')?.value || null;
                stepData.api_method = stepEl.querySelector('.step-api-method')?.value || 'GET';
                stepData.api_endpoint = stepEl.querySelector('.step-api-endpoint')?.value || null;
                stepData.api_body_type = stepEl.querySelector('.step-api-body-type')?.value || 'json';
                stepData.api_body = stepEl.querySelector('.step-api-body')?.value || null;

                // Parse JSON fields
                try {
                    const headersText = stepEl.querySelector('.step-api-headers')?.value?.trim();
                    stepData.api_headers_json = headersText ? JSON.parse(headersText) : null;
                } catch (e) {
                    stepData.api_headers_json = null;
                }

                try {
                    const queryParamsText = stepEl.querySelector('.step-api-query-params')?.value?.trim();
                    stepData.api_query_params_json = queryParamsText ? JSON.parse(queryParamsText) : null;
                } catch (e) {
                    stepData.api_query_params_json = null;
                }

                try {
                    const extractText = stepEl.querySelector('.step-api-extract')?.value?.trim();
                    stepData.api_response_extract_json = extractText ? JSON.parse(extractText) : null;
                } catch (e) {
                    stepData.api_response_extract_json = null;
                }

                // Parse expected status codes
                const statusCodesText = stepEl.querySelector('.step-api-status-codes')?.value?.trim();
                if (statusCodesText) {
                    stepData.api_expected_status_codes = statusCodesText.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c));
                } else {
                    stepData.api_expected_status_codes = [200, 201, 202, 204];
                }
            }

            steps.push(stepData);
        });

        // Collect triggers
        const triggers = [];
        document.querySelectorAll('.trigger-card').forEach((triggerEl, index) => {
            triggers.push({
                id: triggerEl.dataset.triggerId || null,
                alert_name_pattern: triggerEl.querySelector('.trigger-alert-name').value || '*',
                severity_pattern: triggerEl.querySelector('.trigger-severity').value,
                instance_pattern: triggerEl.querySelector('.trigger-instance').value || '*',
                job_pattern: triggerEl.querySelector('.trigger-job').value || '*',
                min_duration_seconds: parseInt(triggerEl.querySelector('.trigger-duration').value) || 0,
                min_occurrences: 1,
                priority: parseInt(triggerEl.querySelector('.trigger-priority').value) || 100,
                enabled: triggerEl.querySelector('.trigger-enabled').checked
            });
        });

        // Status
        const statusValue = document.querySelector('input[name="status"]:checked').value;
        const enabled = statusValue !== 'disabled';
        const autoExecute = statusValue === 'active';

        // Approval
        const approvalValue = document.getElementById('approvalRequired').value;
        const approvalRequired = approvalValue !== 'none';

        // OS Filter
        const osFilter = [];
        if (document.getElementById('osLinux').checked) osFilter.push('linux');
        if (document.getElementById('osWindows').checked) osFilter.push('windows');

        // Tags
        const tagsStr = document.getElementById('runbookTags').value;
        const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

        return {
            name: document.getElementById('runbookName').value,
            description: document.getElementById('runbookDescription').value || null,
            category: document.getElementById('runbookCategory').value,
            tags: tags,
            documentation_url: document.getElementById('runbookDocUrl').value || null,
            enabled: enabled,
            auto_execute: autoExecute,
            approval_required: approvalRequired,
            approval_roles: ['operator', 'engineer', 'admin'],
            approval_timeout_minutes: parseInt(document.getElementById('approvalTimeout').value) || 30,
            max_executions_per_hour: parseInt(document.getElementById('maxExecutions').value) || 5,
            cooldown_minutes: parseInt(document.getElementById('cooldownMinutes').value) || 10,
            default_server_id: document.getElementById('defaultServer').value || null,
            target_os_filter: osFilter.length > 0 ? osFilter : ['linux', 'windows'],
            target_from_alert: document.getElementById('targetFromAlert').checked,
            target_alert_label: document.getElementById('targetAlertLabel').value || 'instance',
            steps: steps,
            triggers: triggers
        };
    }

    async function saveRunbook() {
        const data = collectFormData();

        // Validation
        if (!data.name) {
            showToast('Runbook name is required', 'error');
            document.getElementById('runbookName').focus();
            return;
        }

        if (data.steps.length === 0) {
            showToast('At least one step is required', 'error');
            scrollToSection({ preventDefault: () => { } }, 'section-steps');
            return;
        }

        // Check if steps have required fields based on type
        for (const step of data.steps) {
            if (step.step_type === 'api') {
                if (!step.api_endpoint) {
                    showToast(`API step "${step.name}" is missing endpoint`, 'error');
                    return;
                }
                if (!step.api_method) {
                    showToast(`API step "${step.name}" is missing HTTP method`, 'error');
                    return;
                }
            } else if (step.step_type === 'command') {
                if (!step.command_linux && !step.command_windows) {
                    showToast(`Command step "${step.name}" has no command defined`, 'error');
                    return;
                }
            }
        }

        try {
            const id = document.getElementById('runbookId').value;
            const url = id ? `/api/remediation/runbooks/${id}` : '/api/remediation/runbooks';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Runbook updated successfully' : 'Runbook created successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/runbooks';
                }, 1000);
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save runbook', 'error');
            }
        } catch (error) {
            console.error('Error saving runbook:', error);
            showToast('Error saving runbook', 'error');
        }
    }

    function cancelForm() {
        if (confirm('Discard changes and go back to runbooks list?')) {
            window.location.href = '/runbooks';
        }
    }

    function previewYAML() {
        const data = collectFormData();

        const yaml = {
            apiVersion: 'aiops.io/v1',
            kind: 'Runbook',
            metadata: {
                name: data.name,
                description: data.description,
                category: data.category,
                tags: data.tags
            },
            spec: {
                execution: {
                    auto_execute: data.auto_execute,
                    approval_required: data.approval_required,
                    approval_timeout_minutes: data.approval_timeout_minutes
                },
                safety: {
                    max_executions_per_hour: data.max_executions_per_hour,
                    cooldown_minutes: data.cooldown_minutes
                },
                target: {
                    os_filter: data.target_os_filter,
                    from_alert: data.target_from_alert,
                    alert_label: data.target_alert_label
                }
            },
            triggers: data.triggers.map(t => ({
                alert_name_pattern: t.alert_name_pattern,
                severity_pattern: t.severity_pattern,
                instance_pattern: t.instance_pattern,
                priority: t.priority,
                enabled: t.enabled
            })),
            steps: data.steps.map(s => ({
                name: s.name,
                command_linux: s.command_linux,
                command_windows: s.command_windows,
                target_os: s.target_os,
                timeout_seconds: s.timeout_seconds,
                continue_on_fail: s.continue_on_fail
            }))
        };

        // Simple YAML conversion (basic)
        const yamlStr = jsonToYaml(yaml);
        document.getElementById('yamlContent').textContent = yamlStr;
        document.getElementById('yamlModal').classList.remove('hidden');
    }

    function jsonToYaml(obj, indent = 0) {
        let yaml = '';
        const spaces = '  '.repeat(indent);

        for (const [key, value] of Object.entries(obj)) {
            if (value === null || value === undefined) continue;

            if (Array.isArray(value)) {
                if (value.length === 0) {
                    yaml += `${spaces}${key}: []\n`;
                } else if (typeof value[0] === 'object') {
                    yaml += `${spaces}${key}:\n`;
                    value.forEach(item => {
                        yaml += `${spaces}- `;
                        const itemYaml = jsonToYaml(item, indent + 1);
                        yaml += itemYaml.trim().replace(/^/gm, '  '.repeat(indent + 1)).slice(2 * (indent + 1)) + '\n';
                    });
                } else {
                    yaml += `${spaces}${key}: [${value.map(v => typeof v === 'string' ? `"${v}"` : v).join(', ')}]\n`;
                }
            } else if (typeof value === 'object') {
                yaml += `${spaces}${key}:\n`;
                yaml += jsonToYaml(value, indent + 1);
            } else if (typeof value === 'string') {
                if (value.includes('\n')) {
                    yaml += `${spaces}${key}: |\n`;
                    value.split('\n').forEach(line => {
                        yaml += `${spaces}  ${line}\n`;
                    });
                } else {
                    yaml += `${spaces}${key}: "${value}"\n`;
                }
            } else {
                yaml += `${spaces}${key}: ${value}\n`;
            }
        }

        return yaml;
    }

    function closeYAMLModal() {
        document.getElementById('yamlModal').classList.add('hidden');
    }

    function copyYAML() {
        const content = document.getElementById('yamlContent').textContent;
        navigator.clipboard.writeText(content).then(() => {
            showToast('YAML copied to clipboard', 'success');
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Toast notification (use global if available)
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
            toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${escapeHtml(message)}</span>
        `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    }
</script>
{{ super() }}
{% endblock %}