{% extends "base.html" %}
{% set active_page = 'runbooks' %}

{% block title %}{{ 'Edit Runbook' if mode == 'edit' else 'Create Runbook' }} - AIOps Platform{% endblock %}

{% block header_title %}
<i class="fas fa-book text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">{{ 'Edit Runbook' if mode == 'edit' else 'Create Runbook'
    }}</span>
{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<a href="/runbooks" class="hover:text-blue-400 transition-colors">Runbooks</a>
<span class="mx-2">/</span>
<span class="text-gray-200">{{ 'Edit' if mode == 'edit' else 'Create' }}</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block content %}
<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

<style>
    /* ── Theme Variables ── */
    :root {
        --bg-tertiary: #f8fafc;
        --border-color: #e2e8f0;
        --accent-primary: #3b82f6;
        --form-radius: 10px;
    }

    /* ── Input Fields (polished) ── */
    .input-field {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        color: #1e293b;
        font-size: 13px;
        border-radius: var(--form-radius);
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .input-field:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .input-field:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .input-field::placeholder {
        color: #94a3b8;
    }

    select.input-field {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 32px;
    }

    textarea.input-field {
        resize: vertical;
    }

    /* ── Form Labels (tighter) ── */
    .form-label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
        letter-spacing: 0.01em;
    }

    .form-label .required {
        color: #ef4444;
        margin-left: 2px;
    }

    .form-hint {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 4px;
    }

    /* ── Settings Sub-sections ── */
    .settings-group {
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        border-radius: 10px;
        padding: 16px 20px;
    }

    .settings-group-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 700;
        color: #334155;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 14px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
    }

    .settings-group-title i {
        font-size: 13px;
        width: 16px;
        text-align: center;
    }

    /* ── Status Cards (New Design) ── */
    .status-card-group {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    @media (max-width: 640px) {
        .status-card-group {
            grid-template-columns: 1fr;
        }
    }

    .status-card {
        position: relative;
        display: block;
        cursor: pointer;
    }

    .status-card input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .status-card-content {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .status-card:hover .status-card-content {
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    .status-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .status-info {
        flex: 1;
        min-width: 0;
    }

    .status-title {
        font-size: 14px;
        font-weight: 600;
        color: #334155;
        line-height: 1.2;
    }

    .status-desc {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 2px;
    }

    .status-check {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: transparent;
        transition: all 0.2s;
        font-size: 14px;
    }

    /* Draft Style */
    .status-card.draft .status-icon {
        background: #eff6ff;
        color: #3b82f6;
    }

    .status-card.draft input:checked+.status-card-content {
        border-color: #3b82f6;
        background: #eff6ff;
        box-shadow: 0 0 0 1px #3b82f6;
    }

    .status-card.draft input:checked+.status-card-content .status-title {
        color: #1d4ed8;
    }

    .status-card.draft input:checked+.status-card-content .status-desc {
        color: #60a5fa;
    }

    .status-card.draft input:checked+.status-card-content .status-check {
        color: #3b82f6;
    }

    /* Active Style */
    .status-card.active .status-icon {
        background: #ecfdf5;
        color: #10b981;
    }

    .status-card.active input:checked+.status-card-content {
        border-color: #10b981;
        background: #ecfdf5;
        box-shadow: 0 0 0 1px #10b981;
    }

    .status-card.active input:checked+.status-card-content .status-title {
        color: #047857;
    }

    .status-card.active input:checked+.status-card-content .status-desc {
        color: #34d399;
    }

    .status-card.active input:checked+.status-card-content .status-check {
        color: #10b981;
    }

    /* Disabled Style */
    .status-card.disabled .status-icon {
        background: #f1f5f9;
        color: #64748b;
    }

    .status-card.disabled input:checked+.status-card-content {
        border-color: #94a3b8;
        background: #f8fafc;
        box-shadow: 0 0 0 1px #94a3b8;
    }

    .status-card.disabled input:checked+.status-card-content .status-title {
        color: #334155;
    }

    .status-card.disabled input:checked+.status-card-content .status-desc {
        color: #94a3b8;
    }

    .status-card.disabled input:checked+.status-card-content .status-check {
        color: #64748b;
    }


    /* ── Checkboxes & toggles ── */
    .toggle-check {
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 8px;
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        transition: all 0.15s;
        cursor: pointer;
    }

    .toggle-check:hover {
        background: #f1f5f9;
        border-color: #e2e8f0;
    }

    .toggle-check input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
        cursor: pointer;
    }

    .toggle-check span {
        font-size: 13px;
        color: #475569;
    }

    /* ── Sidebar Navigation (polished) ── */
    .form-sidebar {
        position: sticky;
        top: 1rem;
    }

    .form-sidebar a {
        display: flex;
        align-items: center;
        padding: 9px 12px;
        border-radius: 8px;
        color: #64748b;
        transition: all 0.15s;
        border-left: 3px solid transparent;
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
    }

    .form-sidebar a:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .form-sidebar a.active {
        background: #eff6ff;
        color: #2563eb;
        border-left-color: #3b82f6;
        font-weight: 600;
    }

    .form-sidebar a i {
        width: 18px;
        margin-right: 10px;
        font-size: 13px;
        text-align: center;
    }

    .sidebar-quick-action {
        display: flex;
        align-items: center;
        border: none;
        background: none;
        font-size: 13px;
        cursor: pointer;
    }

    .sidebar-quick-action:hover {
        background: #f1f5f9 !important;
    }

    /* ── Sidebar Count Badges ── */
    .sidebar-badge {
        margin-left: auto;
        font-size: 11px;
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 99px;
        min-width: 22px;
        text-align: center;
    }

    .sidebar-badge.blue {
        background: #dbeafe;
        color: #2563eb;
    }

    .sidebar-badge.yellow {
        background: #fef3c7;
        color: #b45309;
    }

    /* ── Section Headers (refined) ── */
    .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        padding-bottom: 14px;
        border-bottom: 1px solid #f1f5f9;
    }

    .section-header-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .section-header-icon.blue {
        background: #dbeafe;
        color: #2563eb;
    }

    .section-header-icon.green {
        background: #dcfce7;
        color: #16a34a;
    }

    .section-header-icon.yellow {
        background: #fef3c7;
        color: #d97706;
    }

    .section-header-icon.purple {
        background: #f3e8ff;
        color: #7c3aed;
    }

    .section-header-icon.slate {
        background: #f1f5f9;
        color: #475569;
    }

    .section-header-text h2 {
        font-size: 15px;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
    }

    .section-header-text p {
        font-size: 12px;
        color: #94a3b8;
        margin: 2px 0 0;
    }

    /* ── Empty States ── */
    .empty-state {
        text-align: center;
        padding: 32px 16px;
    }

    .empty-state-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        font-size: 20px;
    }

    .empty-state-icon.green {
        background: #dcfce7;
        color: #16a34a;
    }

    .empty-state-icon.yellow {
        background: #fef3c7;
        color: #d97706;
    }

    .empty-state p {
        font-size: 13px;
        color: #94a3b8;
        margin: 0;
    }

    .empty-state .empty-state-action {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 12px;
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px dashed #cbd5e1;
        color: #64748b;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        background: none;
    }

    .empty-state .empty-state-action:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        background: #eff6ff;
    }

    /* ── Step Card ── */
    .step-card {
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 10px;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        overflow: hidden;
    }

    .step-card:hover {
        border-color: #3b82f6 !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.08);
    }

    .step-card.dragging {
        opacity: 0.5;
        border-color: #3b82f6 !important;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .step-card .drag-handle {
        cursor: grab;
        color: #cbd5e1;
        padding: 0.5rem;
        transition: color 0.15s;
    }

    .step-card .drag-handle:hover {
        color: #64748b;
    }

    .step-card .drag-handle:active {
        cursor: grabbing;
    }

    .step-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        background: #fafbfc;
        border-bottom: 1px solid #f1f5f9;
    }

    .step-number-badge {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: #dbeafe;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 700;
        color: #2563eb;
        flex-shrink: 0;
    }

    /* ── Trigger Card ── */
    .trigger-card {
        background: white !important;
        border: 1px solid #e2e8f0 !important;
        border-radius: 10px;
        padding: 16px;
        transition: all 0.2s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .trigger-card:hover {
        border-color: #f59e0b !important;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.08);
    }

    /* ── CodeMirror ── */
    .CodeMirror {
        height: auto;
        min-height: 80px;
        max-height: 300px;
        border-radius: 8px;
        font-size: 13px;
        border: 1px solid #e2e8f0;
    }

    .CodeMirror-focused {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
    }

    .cm-s-dracula {
        background: #f8fafc !important;
    }

    /* ── Command Tabs ── */
    .cmd-tabs {
        display: flex;
        gap: 0;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 0.5rem;
    }

    .cmd-tab {
        padding: 8px 16px;
        cursor: pointer;
        color: #94a3b8;
        border-bottom: 2px solid transparent;
        transition: all 0.15s;
        font-size: 13px;
        font-weight: 500;
    }

    .cmd-tab:hover {
        color: #475569;
    }

    .cmd-tab.active {
        color: #2563eb;
        border-bottom-color: #3b82f6;
    }

    .cmd-content {
        display: none;
    }

    .cmd-content.active {
        display: block;
    }

    /* ── Advanced Toggle ── */
    .advanced-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #64748b;
        cursor: pointer;
        padding: 8px 0;
        transition: color 0.15s;
        background: none;
        border: none;
    }

    .advanced-toggle:hover {
        color: #3b82f6;
    }

    .advanced-toggle i {
        transition: transform 0.2s;
        font-size: 10px;
    }

    .step-advanced {
        display: none;
    }

    .step-advanced.show {
        display: block;
    }

    /* ── Advanced Sub-headers ── */
    .adv-subheader {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        font-weight: 700;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 12px;
    }

    .adv-subheader i {
        font-size: 11px;
        color: #94a3b8;
    }

    /* ── Scroll & Section ── */
    .form-section {
        scroll-margin-top: 2rem;
    }

    /* ── Save Button (gradient matching runbooks page) ── */
    .btn-save {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 20px;
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }

    .btn-save:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
        transform: translateY(-1px);
    }

    .btn-save:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    /* ── Cancel Button (matching runbooks secondary) ── */
    .btn-cancel {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 9px 16px;
        background: #ffffff;
        color: #475569;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .btn-cancel:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        background: #f8fafc;
        transform: translateY(-1px);
    }

    .btn-cancel:active {
        transform: translateY(0);
    }

    /* ── Workflow Container ── */
    .workflow-container {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 16px;
        position: relative;
        overflow: hidden;
    }

    .workflow-legend {
        position: absolute;
        bottom: 12px;
        right: 12px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 11px;
        color: #64748b;
        backdrop-filter: blur(8px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .workflow-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .workflow-legend-item+.workflow-legend-item {
        margin-top: 4px;
    }

    .workflow-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        flex-shrink: 0;
    }

    /* ── Info tooltip refinement ── */
    .form-tooltip {
        position: relative;
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
    }

    .form-tooltip-icon {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #e2e8f0;
        color: #64748b;
        font-size: 9px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: help;
        transition: all 0.15s;
    }

    .form-tooltip-icon:hover {
        background: #3b82f6;
        color: white;
    }

    /* ── ACL table polish ── */
    .acl-table {
        width: 100%;
        font-size: 13px;
        border-collapse: separate;
        border-spacing: 0;
    }

    .acl-table thead th {
        font-size: 11px;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 8px 12px;
        border-bottom: 1px solid #e2e8f0;
    }

    .acl-table tbody td {
        padding: 10px 12px;
        border-bottom: 1px solid #f1f5f9;
    }

    .acl-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* ── CodeMirror Light Override ── */
    .cm-s-dracula {
        background: #f8fafc !important;
        color: #334155 !important;
    }

    .cm-s-dracula .CodeMirror-gutters {
        background: #f1f5f9 !important;
        border-right: 1px solid #e2e8f0 !important;
    }

    .cm-s-dracula .CodeMirror-linenumber {
        color: #94a3b8 !important;
    }

    .cm-s-dracula .CodeMirror-cursor {
        border-left-color: #334155 !important;
    }

    .cm-s-dracula .cm-comment {
        color: #64748b !important;
    }

    .cm-s-dracula .cm-keyword {
        color: #7c3aed !important;
    }

    .cm-s-dracula .cm-string {
        color: #059669 !important;
    }

    .cm-s-dracula .cm-variable {
        color: #2563eb !important;
    }

    .cm-s-dracula .cm-number {
        color: #d97706 !important;
    }

    .cm-s-dracula .cm-operator {
        color: #475569 !important;
    }

    .cm-s-dracula .cm-def {
        color: #0369a1 !important;
    }

    .cm-s-dracula .CodeMirror-selected {
        background: rgba(59, 130, 246, 0.12) !important;
    }

    .cm-s-dracula .CodeMirror-activeline-background {
        background: rgba(59, 130, 246, 0.04) !important;
    }

    /* ── Permission toggle-row ── */
    .perm-toggle-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 10px;
        background: #f8fafc;
        border: 1px solid #f1f5f9;
        transition: all 0.15s;
    }

    .perm-toggle-row:hover {
        background: #f1f5f9;
        border-color: #e2e8f0;
    }

    .perm-toggle-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
        cursor: pointer;
        flex-shrink: 0;
    }

    .perm-toggle-row .perm-label {
        font-size: 13px;
        color: #334155;
        font-weight: 500;
    }

    .perm-toggle-row .perm-hint {
        font-size: 11px;
        color: #94a3b8;
    }

    /* ── Settings grid alignment ── */
    .settings-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @media (max-width: 768px) {
        .settings-row {
            grid-template-columns: 1fr;
        }
    }

    /* ── Info badge (inline) ── */
    .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        background: #eff6ff;
        color: #2563eb;
    }
</style>

<div class="h-full flex flex-col">
    <!-- Toolbar with Actions (matching runbooks design) -->
    <div class="card p-4 mb-5 flex-shrink-0">
        <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
            <!-- Left: Title -->
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0"
                    style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas {{ 'fa-edit' if mode == 'edit' else 'fa-plus-circle' }}"
                        style="color: #2563eb; font-size: 16px;"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-primary tracking-tight" id="pageTitle" style="line-height: 1.3;">
                        {{ 'Edit Runbook' if mode == 'edit' else 'Create Runbook' }}
                    </h1>
                    <p class="text-xs text-secondary" id="pageSubtitle" style="margin-top: 1px;">
                        {{ 'Modify runbook configuration and steps' if mode == 'edit' else 'Define a new automated
                        remediation runbook' }}
                    </p>
                </div>
            </div>
            <!-- Right: Actions -->
            <div class="flex items-center gap-3">
                <button onclick="cancelForm()" class="btn-cancel">
                    <i class="fas fa-arrow-left" style="font-size: 11px;"></i>
                    Cancel
                </button>
                <button onclick="previewYAML()" class="btn-cancel">
                    <i class="fas fa-code" style="font-size: 11px;"></i>
                    Preview
                </button>
                <button onclick="saveRunbook()" class="btn-save">
                    <i class="fas fa-save"></i>
                    Save Runbook
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex gap-6 flex-1 min-h-0">
        <!-- Sidebar Navigation -->
        <div class="w-48 flex-shrink-0">
            <nav class="form-sidebar space-y-1">
                <a href="#section-basic" class="active" onclick="scrollToSection(event, 'section-basic')">
                    <i class="fas fa-info-circle"></i>
                    <span>Basic Info</span>
                </a>
                <a href="#section-steps" onclick="scrollToSection(event, 'section-steps')">
                    <i class="fas fa-list-ol"></i>
                    <span>Steps</span>
                    <span class="sidebar-badge blue" id="stepsCount">0</span>
                </a>
                <a href="#section-triggers" onclick="scrollToSection(event, 'section-triggers')">
                    <i class="fas fa-bolt"></i>
                    <span>Triggers</span>
                    <span class="sidebar-badge yellow" id="triggersCount">0</span>
                </a>
                <a href="#section-settings" onclick="scrollToSection(event, 'section-settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#section-permissions" onclick="scrollToSection(event, 'section-permissions')">
                    <i class="fas fa-shield-alt"></i>
                    <span>Permissions</span>
                </a>
                <a href="#section-workflow"
                    onclick="scrollToSection(event, 'section-workflow'); updateWorkflowDiagram();">
                    <i class="fas fa-project-diagram"></i>
                    <span>Workflow</span>
                </a>
            </nav>

            <!-- Quick Actions -->
            <div class="mt-6 pt-6 border-t" style="border-color: #e2e8f0;">
                <p class="text-xs text-secondary uppercase tracking-wider mb-3 px-4">Quick Actions</p>
                <button onclick="addStep()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary rounded-lg transition-colors sidebar-quick-action">
                    <i class="fas fa-plus mr-2 text-green-500"></i>Add Step
                </button>
                <button onclick="addTrigger()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary rounded-lg transition-colors sidebar-quick-action">
                    <i class="fas fa-plus mr-2 text-yellow-500"></i>Add Trigger
                </button>
                <button onclick="previewYAML()"
                    class="w-full text-left px-4 py-2 text-sm text-secondary hover:text-primary rounded-lg transition-colors sidebar-quick-action">
                    <i class="fas fa-code mr-2 text-purple-500"></i>Preview YAML
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <div class="flex-1 overflow-y-auto pr-2" id="formContent">
            <form id="runbookForm" class="space-y-8">
                <input type="hidden" id="runbookId" value="{{ runbook_id or '' }}">

                <!-- Section: Basic Info -->
                <section id="section-basic" class="form-section card p-6">
                    <div class="section-header">
                        <div class="section-header-icon blue"><i class="fas fa-info-circle"></i></div>
                        <div class="section-header-text">
                            <h2>Basic Information</h2>
                            <p>Core details that identify this runbook</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5">
                        <div class="col-span-2 md:col-span-1">
                            <label class="form-label">
                                Name <span class="required">*</span>
                                <span class="info-tooltip info-tooltip-align-left info-tooltip-bottom">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">A unique, descriptive name for this runbook.</span>
                                </span>
                            </label>
                            <input type="text" id="runbookName" required class="input-field w-full px-3 py-2 rounded"
                                placeholder="e.g., Restart Nginx Service">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="form-label">
                                Category
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Group similar runbooks together for easier
                                        management.</span>
                                </span>
                            </label>
                            <select id="runbookCategory" class="input-field w-full px-3 py-2 rounded">
                                <option value="infrastructure">Infrastructure</option>
                                <option value="application">Application</option>
                                <option value="database">Database</option>
                                <option value="network">Network</option>
                                <option value="security">Security</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="form-label">
                                Description
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Explain the purpose of this runbook and when it
                                        should be used.</span>
                                </span>
                            </label>
                            <textarea id="runbookDescription" rows="3" class="input-field w-full px-3 py-2 rounded"
                                placeholder="Describe what this runbook does, when to use it, and any prerequisites..."></textarea>
                            <p class="form-hint">A clear description helps others understand when to use this runbook
                            </p>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="form-label">
                                Tags
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Keywords to help search and filter runbooks.</span>
                                </span>
                            </label>
                            <input type="text" id="runbookTags" class="input-field w-full px-3 py-2 rounded"
                                placeholder="web, nginx, restart (comma-separated)">
                            <p class="form-hint">Comma-separated keywords for search and filtering</p>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="form-label">
                                Documentation URL
                                <span class="info-tooltip info-tooltip-align-left">
                                    <span class="info-tooltip-icon">?</span>
                                    <span class="info-tooltip-text">Link to external wiki or docs for this
                                        runbook.</span>
                                </span>
                            </label>
                            <input type="url" id="runbookDocUrl" class="input-field w-full px-3 py-2 rounded"
                                placeholder="https://wiki.example.com/runbooks/nginx">
                            <p class="form-hint">Optional link to detailed documentation or wiki</p>
                        </div>
                    </div>
                </section>

                <!-- Section: Steps -->
                <section id="section-steps" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-header" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                            <div class="section-header-icon green"><i class="fas fa-list-ol"></i></div>
                            <div class="section-header-text">
                                <h2>Steps</h2>
                                <p>Commands executed in sequence from top to bottom</p>
                            </div>
                        </div>
                        <button type="button" onclick="addStep()" class="btn-save"
                            style="padding: 7px 14px; font-size: 12px;">
                            <i class="fas fa-plus"></i>
                            Add Step
                        </button>
                    </div>

                    <div id="stepsContainer" class="space-y-4">
                        <!-- Steps will be added dynamically -->
                    </div>

                    <div id="noStepsMessage" class="empty-state">
                        <div class="empty-state-icon green"><i class="fas fa-layer-group"></i></div>
                        <p>No steps defined yet</p>
                        <button type="button" onclick="addStep()" class="empty-state-action">
                            <i class="fas fa-plus"></i> Add your first step
                        </button>
                    </div>
                </section>

                <!-- Section: Triggers -->
                <section id="section-triggers" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-header" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                            <div class="section-header-icon yellow"><i class="fas fa-bolt"></i></div>
                            <div class="section-header-text">
                                <h2>Triggers</h2>
                                <p>Auto-execute when <strong>any</strong> trigger matches an incoming alert</p>
                            </div>
                        </div>
                        <button type="button" onclick="addTrigger()" class="btn-save"
                            style="padding: 7px 14px; font-size: 12px;">
                            <i class="fas fa-plus"></i>
                            Add Trigger
                        </button>
                    </div>

                    <div id="triggersContainer" class="space-y-4">
                        <!-- Triggers will be added dynamically -->
                    </div>

                    <div id="noTriggersMessage" class="empty-state">
                        <div class="empty-state-icon yellow"><i class="fas fa-bolt"></i></div>
                        <p>No triggers defined — manual execution only</p>
                        <button type="button" onclick="addTrigger()" class="empty-state-action">
                            <i class="fas fa-plus"></i> Add a trigger
                        </button>
                    </div>
                </section>

                <!-- Section: Settings -->
                <section id="section-settings" class="form-section card p-6">
                    <div class="section-header">
                        <div class="section-header-icon slate"><i class="fas fa-cog"></i></div>
                        <div class="section-header-text">
                            <h2>Settings</h2>
                            <p>Execution behavior, safety limits, and targeting</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Status Group -->
                        <div class="settings-group">
                            <div class="settings-group-title">
                                <i class="fas fa-toggle-on"></i> Runbook Status
                            </div>
                            <div class="status-card-group">
                                <!-- Draft Option -->
                                <label class="status-card draft">
                                    <input type="radio" name="status" value="draft" id="status-draft" checked>
                                    <div class="status-card-content">
                                        <div class="status-icon">
                                            <i class="fas fa-pencil-ruler"></i>
                                        </div>
                                        <div class="status-info">
                                            <div class="status-title">Draft</div>
                                            <div class="status-desc">Testing only</div>
                                        </div>
                                        <div class="status-check">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                </label>

                                <!-- Active Option -->
                                <label class="status-card active">
                                    <input type="radio" name="status" value="active" id="status-active">
                                    <div class="status-card-content">
                                        <div class="status-icon">
                                            <i class="fas fa-play-circle"></i>
                                        </div>
                                        <div class="status-info">
                                            <div class="status-title">Active</div>
                                            <div class="status-desc">Auto-execute</div>
                                        </div>
                                        <div class="status-check">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                </label>

                                <!-- Disabled Option -->
                                <label class="status-card disabled">
                                    <input type="radio" name="status" value="disabled" id="status-disabled">
                                    <div class="status-card-content">
                                        <div class="status-icon">
                                            <i class="fas fa-ban"></i>
                                        </div>
                                        <div class="status-info">
                                            <div class="status-title">Disabled</div>
                                            <div class="status-desc">Cannot run</div>
                                        </div>
                                        <div class="status-check">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Approval Group -->
                        <div class="settings-group">
                            <div class="settings-group-title">
                                <i class="fas fa-user-check"></i> Approval
                            </div>
                            <div class="settings-row">
                                <div>
                                    <label class="form-label">
                                        Approval Mode
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Control whether human approval is needed
                                                before execution.</span>
                                        </span>
                                    </label>
                                    <select id="approvalRequired" class="input-field w-full px-3 py-2 rounded">
                                        <option value="none">None — Execute immediately</option>
                                        <option value="manual" selected>Manual Approval</option>
                                        <option value="auto">Auto-approve after timeout</option>
                                    </select>
                                    <p class="form-hint">Manual requires a user to approve each run</p>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Timeout
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Time (minutes) before auto-approval or
                                                expiry.</span>
                                        </span>
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="approvalTimeout" value="30" min="1" max="1440"
                                            class="input-field w-full px-3 py-2 rounded">
                                        <span class="text-xs text-secondary whitespace-nowrap">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rate Limiting Group -->
                        <div class="settings-group">
                            <div class="settings-group-title">
                                <i class="fas fa-tachometer-alt"></i> Rate Limiting
                            </div>
                            <div class="settings-row">
                                <div>
                                    <label class="form-label">
                                        Max Executions / Hour
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Limit how often this runbook can run to
                                                prevent storms.</span>
                                        </span>
                                    </label>
                                    <input type="number" id="maxExecutions" value="5" min="1" max="100"
                                        class="input-field w-full px-3 py-2 rounded">
                                    <p class="form-hint">Prevents execution storms during outages</p>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Cooldown Period
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Wait time between executions to prevent
                                                flapping.</span>
                                        </span>
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="cooldownMinutes" value="10" min="0" max="1440"
                                            class="input-field w-full px-3 py-2 rounded">
                                        <span class="text-xs text-secondary whitespace-nowrap">minutes</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Target Group -->
                        <div class="settings-group">
                            <div class="settings-group-title">
                                <i class="fas fa-crosshairs"></i> Targeting
                            </div>
                            <div class="settings-row" style="margin-bottom: 16px;">
                                <div>
                                    <label class="form-label">
                                        Default Server
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Server to run on if none is specified in
                                                execution.</span>
                                        </span>
                                    </label>
                                    <select id="defaultServer" class="input-field w-full px-3 py-2 rounded">
                                        <option value="">None (derive from alert)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Operating Systems</label>
                                    <div class="flex gap-3 mt-1">
                                        <label class="toggle-check" style="flex: 1;">
                                            <input type="checkbox" id="osLinux" checked>
                                            <span><i class="fab fa-linux"
                                                    style="margin-right: 4px; color: #475569;"></i> Linux</span>
                                        </label>
                                        <label class="toggle-check" style="flex: 1;">
                                            <input type="checkbox" id="osWindows" checked>
                                            <span><i class="fab fa-windows"
                                                    style="margin-right: 4px; color: #0078d4;"></i> Windows</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-row">
                                <div>
                                    <label class="toggle-check">
                                        <input type="checkbox" id="targetFromAlert" checked>
                                        <span>Extract target server from alert</span>
                                    </label>
                                    <p class="form-hint" style="margin-left: 26px;">Auto-detect server from alert labels
                                    </p>
                                </div>
                                <div>
                                    <label class="form-label">
                                        Alert Label for Target
                                        <span class="info-tooltip info-tooltip-align-left">
                                            <span class="info-tooltip-icon">?</span>
                                            <span class="info-tooltip-text">Alert label containing the hostname/IP (e.g.
                                                'instance').</span>
                                        </span>
                                    </label>
                                    <input type="text" id="targetAlertLabel" value="instance"
                                        class="input-field w-full px-3 py-2 rounded" placeholder="instance">
                                    <p class="form-hint">Common labels: instance, host, node</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section: Permissions -->
                <section id="section-permissions" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-header" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                            <div class="section-header-icon purple"><i class="fas fa-shield-alt"></i></div>
                            <div class="section-header-text">
                                <h2>Permissions</h2>
                                <p>Group-based access control (additive to global roles)</p>
                            </div>
                        </div>
                        <button type="button" onclick="addAclEntry()" class="btn-save"
                            style="padding: 7px 14px; font-size: 12px;">
                            <i class="fas fa-plus"></i>
                            Add Group
                        </button>
                    </div>

                    <div class="settings-group" style="padding: 0; overflow: hidden;">
                        <div id="aclContainer">
                            <div class="text-center py-6 text-secondary">
                                <i class="fas fa-spinner fa-spin mr-2"></i>Loading groups...
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section: Workflow Visualization -->
                <section id="section-workflow" class="form-section card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="section-header" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                            <div class="section-header-icon purple"><i class="fas fa-project-diagram"></i></div>
                            <div class="section-header-text">
                                <h2>Workflow Visualization</h2>
                                <p>Visual execution flow of all steps</p>
                            </div>
                        </div>
                        <button type="button" onclick="updateWorkflowDiagram()" class="btn-cancel"
                            style="padding: 7px 14px; font-size: 12px;">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>

                    <div class="rounded-lg h-[400px] flex items-center justify-center overflow-hidden relative"
                        style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px;">
                        <div id="workflowGraph" class="w-full h-full flex items-center justify-center text-secondary">
                            Loading workflow...
                        </div>
                        <!-- Legend -->
                        <div class="workflow-legend">
                            <div class="workflow-legend-item"><span class="workflow-legend-dot"
                                    style="background: rgba(59,130,246,0.2); border: 1.5px solid #3b82f6;"></span>
                                Command</div>
                            <div class="workflow-legend-item"><span class="workflow-legend-dot"
                                    style="background: rgba(16,185,129,0.2); border: 1.5px solid #10b981;"></span> API
                                Request</div>
                            <div class="workflow-legend-item"><span class="workflow-legend-dot"
                                    style="background: rgba(245,158,11,0.2); border: 1.5px solid #f59e0b;"></span>
                                Condition</div>
                        </div>
                    </div>
                </section>
            </form>
        </div>
    </div>
</div>

<!-- YAML Preview Modal -->
<div id="yamlModal" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-center justify-center p-4"
    style="backdrop-filter: blur(4px); z-index: 99999;">
    <div class="p-6 w-full max-w-3xl relative"
        style="background: white; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-height: 85vh; display: flex; flex-direction: column; overflow: visible;">
        <!-- Header row: sticky, never scrolled away -->
        <div class="flex items-center justify-between" style="flex-shrink: 0; margin-bottom: 16px;">
            <div class="flex items-center gap-3">
                <div class="section-header-icon purple"><i class="fas fa-code"></i></div>
                <h2 style="font-size: 16px; font-weight: 700; color: #0f172a;">YAML Preview</h2>
            </div>
            <button onclick="closeYAMLModal()"
                style="color: #94a3b8; background: none; border: none; cursor: pointer; padding: 8px; border-radius: 6px; transition: all 0.15s; font-size: 18px; line-height: 1; z-index: 1;"
                onmouseover="this.style.color='#1e293b'; this.style.background='#f1f5f9'"
                onmouseout="this.style.color='#94a3b8'; this.style.background='none'" title="Close preview">
                <i class="fas fa-times" style="font-size: 16px;"></i>
            </button>
        </div>
        <!-- Scrollable YAML content -->
        <div style="flex: 1 1 auto; overflow-y: auto; min-height: 0;">
            <pre id="yamlContent"
                style="background: #f8fafc; color: #334155; border: 1px solid #e2e8f0; border-radius: 10px; padding: 20px; font-size: 13px; font-family: 'Fira Code', monospace; line-height: 1.6; white-space: pre-wrap; word-break: break-word; overflow-x: hidden; margin: 0;"></pre>
        </div>
        <!-- Footer buttons: sticky at bottom -->
        <div class="flex justify-end gap-3"
            style="flex-shrink: 0; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f1f5f9;">
            <button onclick="copyYAML()" class="btn-cancel">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button onclick="closeYAMLModal()" class="btn-save">Done</button>
        </div>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div id="cancelConfirmModal"
    class="fixed inset-0 bg-black bg-opacity-30 hidden z-50 flex items-center justify-center p-4"
    style="backdrop-filter: blur(4px);">
    <div class="card p-6 w-full max-w-md" style="border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.15);">
        <div class="flex items-center gap-3 mb-4">
            <div
                style="width: 40px; height: 40px; border-radius: 10px; background: #fef3c7; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-exclamation-triangle" style="color: #d97706; font-size: 16px;"></i>
            </div>
            <div>
                <h2 style="font-size: 16px; font-weight: 700; color: #0f172a;">Discard Changes?</h2>
                <p style="font-size: 12px; color: #94a3b8; margin-top: 2px;">This action cannot be undone</p>
            </div>
        </div>
        <p
            style="font-size: 13px; color: #64748b; margin-bottom: 20px; line-height: 1.5; padding: 12px 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #f1f5f9;">
            Are you sure you want to discard your changes and go back to the runbooks list?
        </p>
        <div class="flex justify-end gap-3">
            <button onclick="closeCancelConfirmModal()" class="btn-cancel">Stay Here</button>
            <button onclick="confirmCancel()"
                style="display: inline-flex; align-items: center; gap: 6px; padding: 9px 16px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 6px rgba(239,68,68,0.25);">
                <i class="fas fa-trash" style="font-size: 11px;"></i> Discard Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/powershell/powershell.min.js"></script>

<!-- Sortable.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<script>
    // Global state
    let stepCounter = 0;
    let triggerCounter = 0;
    let codeMirrorInstances = {};
    let servers = [];
    let apiProfiles = [];
    let groups = [];
    let aclEntries = [];
    const mode = '{{ mode }}';
    const runbookId = '{{ runbook_id or "" }}';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', async function () {
        await loadServers();
        await loadApiProfiles();
        await loadGroups();

        if (mode === 'edit' && runbookId) {
            await loadRunbook(runbookId);
            await loadRunbookAcl(runbookId);
        } else {
            renderAclEntries();
        }

        // Initialize sortable for steps
        initSortable();

        // Setup scroll spy for sidebar
        setupScrollSpy();

        updateCounts();
    });

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            if (response.ok) {
                servers = await response.json();
                populateServerDropdown();
            }
        } catch (error) {
            console.error('Error loading servers:', error);
        }
    }

    async function loadApiProfiles() {
        try {
            const response = await fetch('/api/credential-profiles?enabled_only=true');
            if (response.ok) {
                apiProfiles = await response.json();
                updateApiProfileDropdowns();
            }
        } catch (error) {
            console.error('Error loading API profiles:', error);
        }
    }

    function updateApiProfileDropdowns() {
        document.querySelectorAll('.step-api-profile').forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select API Credential Profile --</option>';
            apiProfiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile.id;
                option.textContent = `${profile.name} (${profile.base_url})`;
                if (profile.id === currentValue) option.selected = true;
                select.appendChild(option);
            });
        });
    }

    function populateServerDropdown() {
        const select = document.getElementById('defaultServer');
        select.innerHTML = '<option value="">None (derive from alert)</option>';
        servers.forEach(server => {
            const option = document.createElement('option');
            option.value = server.id;
            option.textContent = `${server.name} (${server.hostname})`;
            select.appendChild(option);
        });
    }

    // --- ACL Management ---
    async function loadGroups() {
        try {
            const response = await fetch('/api/groups');
            if (response.ok) {
                groups = await response.json();
            }
        } catch (error) {
            console.error('Error loading groups:', error);
        }
    }

    async function loadRunbookAcl(id) {
        try {
            const response = await fetch(`/api/runbooks/${id}/acl`);
            if (response.ok) {
                aclEntries = await response.json();
            }
        } catch (error) {
            console.error('Error loading ACL:', error);
        }
        renderAclEntries();
    }

    function renderAclEntries() {
        const container = document.getElementById('aclContainer');

        if (!groups || groups.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 28px 16px;">
                    <div class="empty-state-icon" style="background: #f1f5f9; color: #64748b;"><i class="fas fa-users"></i></div>
                    <p style="color: #64748b; font-weight: 500;">No groups available</p>
                    <p class="form-hint" style="margin-top: 4px;">Create groups in Settings first to manage permissions.</p>
                </div>
            `;
            return;
        }

        if (aclEntries.length === 0) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 28px 16px;">
                    <div class="empty-state-icon" style="background: #eff6ff; color: #2563eb;"><i class="fas fa-globe"></i></div>
                    <p style="color: #475569; font-weight: 500;">Using global role permissions</p>
                    <p class="form-hint" style="margin-top: 4px;">Add group permissions for fine-grained access control.</p>
                    <button type="button" onclick="addAclEntry()" class="empty-state-action">
                        <i class="fas fa-plus"></i> Add group permission
                    </button>
                </div>
            `;
            return;
        }

        let html = `
            <table class="acl-table">
                <thead>
                    <tr>
                        <th style="text-align: left; padding-left: 20px;">Group</th>
                        <th style="text-align: center;">View</th>
                        <th style="text-align: center;">Edit</th>
                        <th style="text-align: center;">Execute</th>
                        <th style="text-align: right; padding-right: 20px; width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>
        `;

        aclEntries.forEach((entry, index) => {
            const group = groups.find(g => g.id === entry.group_id) || { name: entry.group_name || 'Unknown' };
            html += `
                <tr data-acl-index="${index}">
                    <td style="padding-left: 20px; font-weight: 500; color: #1e293b;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 28px; height: 28px; border-radius: 8px; background: #f3e8ff; color: #7c3aed; display: flex; align-items: center; justify-content: center; font-size: 11px;"><i class="fas fa-users"></i></div>
                            ${escapeHtml(group.name)}
                        </div>
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${entry.can_view ? 'checked' : ''} 
                            onchange="updateAclEntry(${index}, 'can_view', this.checked)"
                            style="width: 16px; height: 16px; accent-color: #3b82f6; cursor: pointer;">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${entry.can_edit ? 'checked' : ''} 
                            onchange="updateAclEntry(${index}, 'can_edit', this.checked)"
                            style="width: 16px; height: 16px; accent-color: #10b981; cursor: pointer;">
                    </td>
                    <td style="text-align: center;">
                        <input type="checkbox" ${entry.can_execute ? 'checked' : ''} 
                            onchange="updateAclEntry(${index}, 'can_execute', this.checked)"
                            style="width: 16px; height: 16px; accent-color: #8b5cf6; cursor: pointer;">
                    </td>
                    <td style="text-align: right; padding-right: 20px;">
                        <button type="button" onclick="removeAclEntry(${index})" 
                            style="color: #cbd5e1; transition: color 0.15s; background: none; border: none; cursor: pointer; padding: 4px;" 
                            onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#cbd5e1'" title="Remove">
                            <i class="fas fa-trash" style="font-size: 12px;"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function addAclEntry() {
        // Get groups not already added
        const existingGroupIds = aclEntries.map(e => e.group_id);
        const availableGroups = groups.filter(g => !existingGroupIds.includes(g.id));

        if (availableGroups.length === 0) {
            showToast('All groups already have permissions', 'warning');
            return;
        }

        // Show a simple dropdown to select group
        const groupOptions = availableGroups.map(g =>
            `<option value="${g.id}">${escapeHtml(g.name)}</option>`
        ).join('');

        const container = document.getElementById('aclContainer');
        const addRow = document.createElement('div');
        addRow.className = 'flex items-center gap-3 p-4'; addRow.style.cssText = 'background: #fafbfc; border-top: 1px solid #f1f5f9;';
        addRow.innerHTML = `
            <select id="newAclGroup" class="input-field flex-1 px-3 py-2 rounded text-sm">
                <option value="">-- Select Group --</option>
                ${groupOptions}
            </select>
            <button type="button" onclick="confirmAddAclEntry()" class="btn-save" style="padding: 7px 14px; font-size: 12px;">Add</button>
            <button type="button" onclick="cancelAddAclEntry()" class="btn-cancel" style="padding: 7px 14px; font-size: 12px;">Cancel</button>
        `;
        container.appendChild(addRow);
    }

    function confirmAddAclEntry() {
        const select = document.getElementById('newAclGroup');
        const groupId = select.value;
        if (!groupId) {
            showToast('Please select a group', 'warning');
            return;
        }

        const group = groups.find(g => g.id === groupId);
        aclEntries.push({
            group_id: groupId,
            group_name: group?.name,
            can_view: true,
            can_edit: false,
            can_execute: false
        });
        renderAclEntries();
    }

    function cancelAddAclEntry() {
        renderAclEntries();
    }

    function updateAclEntry(index, field, value) {
        if (aclEntries[index]) {
            aclEntries[index][field] = value;
        }
    }

    function removeAclEntry(index) {
        aclEntries.splice(index, 1);
        renderAclEntries();
    }

    function collectAclEntries() {
        return aclEntries.map(e => ({
            group_id: e.group_id,
            can_view: e.can_view === true,
            can_edit: e.can_edit === true,
            can_execute: e.can_execute === true
        }));
    }

    async function loadRunbook(id) {
        try {
            const response = await fetch(`/api/remediation/runbooks/${id}`);
            if (!response.ok) {
                showToast('Failed to load runbook', 'error');
                return;
            }

            const runbook = await response.json();

            // Populate basic info
            document.getElementById('runbookName').value = runbook.name || '';
            document.getElementById('runbookDescription').value = runbook.description || '';
            document.getElementById('runbookCategory').value = runbook.category || 'infrastructure';
            document.getElementById('runbookTags').value = (runbook.tags || []).join(', ');
            document.getElementById('runbookDocUrl').value = runbook.documentation_url || '';

            // Status
            let status = 'draft';
            if (!runbook.enabled) status = 'disabled';
            else if (runbook.auto_execute) status = 'active';
            const statusRadio = document.getElementById(`status-${status}`);
            if (statusRadio) statusRadio.checked = true;

            // Settings
            let approval = 'manual';
            if (!runbook.approval_required) approval = 'none';
            else if (runbook.approval_timeout_minutes <= 5) approval = 'auto';
            document.getElementById('approvalRequired').value = approval;
            document.getElementById('approvalTimeout').value = runbook.approval_timeout_minutes || 30;
            document.getElementById('maxExecutions').value = runbook.max_executions_per_hour || 5;
            document.getElementById('cooldownMinutes').value = runbook.cooldown_minutes || 10;
            document.getElementById('defaultServer').value = runbook.default_server_id || '';

            const osFilter = runbook.target_os_filter || ['linux', 'windows'];
            document.getElementById('osLinux').checked = osFilter.includes('linux');
            document.getElementById('osWindows').checked = osFilter.includes('windows');
            document.getElementById('targetFromAlert').checked = runbook.target_from_alert !== false;
            document.getElementById('targetAlertLabel').value = runbook.target_alert_label || 'instance';

            // Load steps
            if (runbook.steps && runbook.steps.length > 0) {
                runbook.steps.sort((a, b) => a.step_order - b.step_order);
                for (const step of runbook.steps) {
                    addStep(step);
                }
            }

            // Load triggers
            if (runbook.triggers && runbook.triggers.length > 0) {
                for (const trigger of runbook.triggers) {
                    addTrigger(trigger);
                }
            }

            updateCounts();

        } catch (error) {
            console.error('Error loading runbook:', error);
            showToast('Error loading runbook', 'error');
        }
    }

    function initSortable() {
        const container = document.getElementById('stepsContainer');
        new Sortable(container, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'dragging',
            onEnd: function (evt) {
                updateStepNumbers();
            }
        });
    }

    function updateStepNumbers() {
        const steps = document.querySelectorAll('.step-card');
        steps.forEach((step, index) => {
            const numberEl = step.querySelector('.step-number');
            if (numberEl) {
                numberEl.textContent = index + 1;
            }
        });
    }

    function setupScrollSpy() {
        const sections = document.querySelectorAll('.form-section');
        const navLinks = document.querySelectorAll('.form-sidebar a');
        const formContent = document.getElementById('formContent');

        formContent.addEventListener('scroll', () => {
            let current = '';

            sections.forEach(section => {
                const sectionTop = section.offsetTop - formContent.offsetTop;
                if (formContent.scrollTop >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    }

    function scrollToSection(event, sectionId) {
        event.preventDefault();
        const section = document.getElementById(sectionId);
        const formContent = document.getElementById('formContent');

        formContent.scrollTo({
            top: section.offsetTop - formContent.offsetTop,
            behavior: 'smooth'
        });

        // Update active state
        document.querySelectorAll('.form-sidebar a').forEach(a => a.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function addStep(stepData = null) {
        stepCounter++;
        const container = document.getElementById('stepsContainer');
        const stepId = `step-${stepCounter}`;

        const stepHtml = `
        <div class="step-card" id="${stepId}" data-step-id="${stepData?.id || ''}">
            <div class="flex items-center gap-3 p-4" style="border-bottom: 1px solid #e2e8f0;">
                <div class="drag-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                <div class="w-8 h-8 rounded-full bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <span class="step-number text-blue-400 font-medium">${document.querySelectorAll('.step-card').length + 1}</span>
                </div>
                <input type="text" class="step-name input-field flex-1 px-3 py-1.5 rounded text-sm" 
                    placeholder="Step name" value="${escapeHtml(stepData?.name || '')}">
                <select class="step-os input-field px-2 py-1.5 rounded text-sm w-28">
                    <option value="any" ${stepData?.target_os === 'any' ? 'selected' : ''}>Any OS</option>
                    <option value="linux" ${stepData?.target_os === 'linux' ? 'selected' : ''}>Linux</option>
                    <option value="windows" ${stepData?.target_os === 'windows' ? 'selected' : ''}>Windows</option>
                </select>
                <button type="button" onclick="toggleStepAdvanced('${stepId}')" class="text-secondary hover:text-primary p-1" title="Advanced settings">
                    <i class="fas fa-cog"></i>
                </button>
                <button type="button" onclick="removeStep('${stepId}')" class="text-red-400 hover:text-red-300 p-1" title="Remove step">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            
            <div class="p-4">
                <!-- Step Type Selector -->
                <div class="mb-4">
                    <label class="block text-secondary text-xs mb-2">Step Type</label>
                    <select class="step-type input-field w-full px-3 py-2 rounded" onchange="toggleStepType('${stepId}')">
                        <option value="command" ${!stepData || stepData?.step_type === 'command' ? 'selected' : ''}>Command (SSH/WinRM)</option>
                        <option value="api" ${stepData?.step_type === 'api' ? 'selected' : ''}>API / REST Call</option>
                    </select>
                </div>

                <!-- API Credential Profile Selector (for API steps) -->
                <div class="mb-4" id="${stepId}-api-profile" style="${stepData?.step_type === 'api' ? '' : 'display:none'}">
                    <label class="block text-secondary text-xs mb-1">
                        API Credential Profile <span class="text-red-400">*</span>
                    </label>
                    <select class="step-api-profile input-field w-full px-3 py-2 rounded text-sm">
                        <option value="">-- Select API Credential Profile --</option>
                        <!-- Populated via JavaScript from /api/credential-profiles -->
                    </select>
                    <p class="text-xs text-secondary mt-1">
                        <i class="fas fa-info-circle mr-1"></i>Provides: Base URL + Authentication (endpoint path specified below)
                    </p>
                </div>

                <!-- Command Configuration (for command type) -->
                <div class="step-command-config" id="${stepId}-command-config" style="${stepData?.step_type === 'api' ? 'display:none' : ''}">
                    <div class="cmd-tabs">
                        <div class="cmd-tab active" onclick="switchCmdTab('${stepId}', 'linux')">
                            <i class="fab fa-linux mr-1"></i> Linux
                        </div>
                        <div class="cmd-tab" onclick="switchCmdTab('${stepId}', 'windows')">
                            <i class="fab fa-windows mr-1"></i> Windows
                        </div>
                    </div>

                    <div class="cmd-content active" id="${stepId}-linux-content">
                        <textarea id="${stepId}-linux" class="step-cmd-linux w-full" placeholder="# Bash command...">${escapeHtml(stepData?.command_linux || '')}</textarea>
                    </div>
                    <div class="cmd-content" id="${stepId}-windows-content">
                        <textarea id="${stepId}-windows" class="step-cmd-windows w-full" placeholder="# PowerShell command...">${escapeHtml(stepData?.command_windows || '')}</textarea>
                    </div>
                </div>

                <!-- API Configuration (for api type) -->
                <div class="step-api-config" id="${stepId}-api-config" style="${stepData?.step_type === 'api' ? '' : 'display:none'}">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">HTTP Method <span class="text-red-400">*</span></label>
                            <select class="step-api-method input-field w-full px-3 py-2 rounded text-sm">
                                <option value="GET" ${stepData?.api_method === 'GET' ? 'selected' : ''}>GET</option>
                                <option value="POST" ${stepData?.api_method === 'POST' ? 'selected' : ''}>POST</option>
                                <option value="PUT" ${stepData?.api_method === 'PUT' ? 'selected' : ''}>PUT</option>
                                <option value="DELETE" ${stepData?.api_method === 'DELETE' ? 'selected' : ''}>DELETE</option>
                                <option value="PATCH" ${stepData?.api_method === 'PATCH' ? 'selected' : ''}>PATCH</option>
                                <option value="HEAD" ${stepData?.api_method === 'HEAD' ? 'selected' : ''}>HEAD</option>
                                <option value="OPTIONS" ${stepData?.api_method === 'OPTIONS' ? 'selected' : ''}>OPTIONS</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">API Endpoint Path <span class="text-red-400">*</span></label>
                            <input type="text" class="step-api-endpoint input-field w-full px-3 py-2 rounded text-sm"
                                placeholder="/jobs/launch or /api/resource" value="${escapeHtml(stepData?.api_endpoint || '')}">
                            <p class="text-xs text-secondary mt-1">Path appended to credential profile's base URL</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Body Type</label>
                            <select class="step-api-body-type input-field w-full px-3 py-2 rounded text-sm">
                                <option value="json" ${!stepData || stepData?.api_body_type === 'json' ? 'selected' : ''}>JSON</option>
                                <option value="form" ${stepData?.api_body_type === 'form' ? 'selected' : ''}>Form Data</option>
                                <option value="raw" ${stepData?.api_body_type === 'raw' ? 'selected' : ''}>Raw Text</option>
                                <option value="template" ${stepData?.api_body_type === 'template' ? 'selected' : ''}>Jinja2 Template</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Expected Status Codes</label>
                            <input type="text" class="step-api-status-codes input-field w-full px-3 py-2 rounded text-sm"
                                placeholder="200,201,202" value="${(stepData?.api_expected_status_codes || [200, 201, 202, 204]).join(',')}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Request Body
                            <span class="text-xs text-secondary ml-2">(Supports Jinja2: {{ '{{' }} server.hostname {{ '}}' }}, {{ '{{' }} alert.labels.instance {{ '}}' }})</span>
                        </label>
                        <textarea class="step-api-body input-field w-full px-3 py-2 rounded text-sm font-mono" rows="4"
                            placeholder='{"key": "value"} or template with variables'>${escapeHtml(stepData?.api_body || '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Custom Headers (JSON)
                            <span class="text-xs text-secondary ml-2">(Merged with server defaults)</span>
                        </label>
                        <textarea class="step-api-headers input-field w-full px-3 py-2 rounded text-sm font-mono" rows="3"
                            placeholder='{"Content-Type": "application/json", "X-Custom-Header": "value"}'>${escapeHtml(stepData?.api_headers_json ? JSON.stringify(stepData.api_headers_json, null, 2) : '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Query Parameters (JSON)
                        </label>
                        <textarea class="step-api-query-params input-field w-full px-3 py-2 rounded text-sm font-mono" rows="2"
                            placeholder='{"param1": "value1", "param2": "value2"}'>${escapeHtml(stepData?.api_query_params_json ? JSON.stringify(stepData.api_query_params_json, null, 2) : '')}</textarea>
                    </div>

                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">
                            Response Value Extraction (JSON)
                            <span class="text-xs text-secondary ml-2">(JSONPath: $.field.subfield or Regex: pattern)</span>
                        </label>
                        <textarea class="step-api-extract input-field w-full px-3 py-2 rounded text-sm font-mono" rows="3"
                            placeholder='{"job_id": "$.id", "status": "$.status"}'>${escapeHtml(stepData?.api_response_extract_json ? JSON.stringify(stepData.api_response_extract_json, null, 2) : '')}</textarea>
                    </div>
                </div>
                
                <!-- Advanced Settings Toggle Button -->
                <div class="mt-4 pt-3" style="border-top: 1px solid #e2e8f0;">
                    <button type="button" class="advanced-toggle flex items-center gap-2 text-sm text-secondary hover:text-primary transition-colors" 
                        onclick="toggleAdvancedSettings('${stepId}')">
                        <i class="fas fa-chevron-right transition-transform" id="${stepId}-advanced-icon"></i>
                        <span>Advanced Settings</span>
                        <span class="text-xs text-secondary ml-2">(Output, Conditions, Timeout, Rollback)</span>
                    </button>
                </div>
                
                <!-- Advanced Settings (collapsed by default) -->
                <div class="step-advanced mt-3 pl-4" id="${stepId}-advanced">
                    
                    <!-- Output Configuration -->
                    <div class="mb-4 pb-4" style="border-bottom: 1px solid #e2e8f0;">
                        <h5 class="text-xs font-semibold text-secondary uppercase tracking-wider mb-3">Output Configuration</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Output Variable Name
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Variable name to store this step's output (e.g., process_id). Access in later steps as \${'{'}{ process_id }{'}'}.</span>
                                    </span>
                                </label>
                                <input type="text" class="step-output-variable input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. process_id" value="${escapeHtml(stepData?.output_variable || '')}">
                            </div>
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Extraction Regex (Optional)
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Regex to extract a specific value from the output (e.g., PID: (\d+)).</span>
                                    </span>
                                </label>
                                <input type="text" class="step-output-pattern input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. PID: (\d+)" value="${escapeHtml(stepData?.output_extract_pattern || '')}">
                            </div>
                        </div>
                    </div>

                    <!-- Conditional Execution -->
                    <div class="mb-4 pb-4" style="border-bottom: 1px solid #e2e8f0;">
                        <h5 class="text-xs font-semibold text-secondary uppercase tracking-wider mb-3">Conditional Execution (Run If)</h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Run Condition Variable
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Variable to check (e.g. svc_status). If empty, step always runs.</span>
                                    </span>
                                </label>
                                <input type="text" class="step-run-if-variable input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. svc_status" value="${escapeHtml(stepData?.run_if_variable || '')}">
                            </div>
                            <div>
                                 <label class="block text-secondary text-xs mb-1">
                                    Run Condition Value
                                    <span class="info-tooltip info-tooltip-align-left">
                                        <span class="info-tooltip-icon">?</span>
                                        <span class="info-tooltip-text">Value required to execute (exact match or regex).</span>
                                    </span>
                                </label>
                                <input type="text" class="step-run-if-value input-field w-full px-2 py-1 rounded text-sm font-mono"
                                    placeholder="e.g. active" value="${escapeHtml(stepData?.run_if_value || '')}">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Timeout (seconds)</label>
                            <input type="number" class="step-timeout input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.timeout_seconds || 60}" min="1" max="3600">
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Retry Count</label>
                            <input type="number" class="step-retry input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.retry_count || 0}" min="0" max="5">
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Expected Exit Code</label>
                            <input type="number" class="step-exit-code input-field w-full px-2 py-1 rounded text-sm" 
                                value="${stepData?.expected_exit_code || 0}">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="step-continue-on-fail" ${stepData?.continue_on_fail ? 'checked' : ''}>
                                <span class="text-secondary text-sm">Continue on failure</span>
                            </label>
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="step-elevation" ${stepData?.requires_elevation ? 'checked' : ''}>
                                <span class="text-secondary text-sm">Requires elevation (sudo/admin)</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-secondary text-xs mb-1">Description</label>
                        <input type="text" class="step-description input-field w-full px-2 py-1 rounded text-sm" 
                            placeholder="Optional description" value="${escapeHtml(stepData?.description || '')}">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-secondary text-xs mb-1">Rollback Command (Linux)</label>
                            <textarea class="step-rollback-linux input-field w-full px-2 py-1 rounded text-sm" rows="2" 
                                placeholder="Command to undo this step">${escapeHtml(stepData?.rollback_command_linux || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-secondary text-xs mb-1">Rollback Command (Windows)</label>
                            <textarea class="step-rollback-windows input-field w-full px-2 py-1 rounded text-sm" rows="2" 
                                placeholder="Command to undo this step">${escapeHtml(stepData?.rollback_command_windows || '')}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', stepHtml);
        document.getElementById('noStepsMessage').style.display = 'none';

        // Initialize CodeMirror for command textareas
        initCodeMirror(`${stepId}-linux`, 'shell');
        initCodeMirror(`${stepId}-windows`, 'powershell');

        // Populate API profile dropdown for this step
        updateApiProfileDropdowns();

        // Pre-select the profile if provided in stepData
        if (stepData?.api_credential_profile_id) {
            const profileSelect = document.querySelector(`#${stepId} .step-api-profile`);
            if (profileSelect) {
                profileSelect.value = stepData.api_credential_profile_id;
            }
        }

        // Auto-expand advanced settings if any values are present
        /* 
        const hasAdvancedValues = stepData?.output_variable ||
            stepData?.output_extract_pattern ||
            stepData?.run_if_variable ||
            stepData?.run_if_value ||
            stepData?.description ||
            stepData?.rollback_command_linux ||
            stepData?.rollback_command_windows ||
            (stepData?.timeout_seconds && stepData.timeout_seconds !== 60) ||
            (stepData?.retry_count && stepData.retry_count > 0) ||
            stepData?.continue_on_fail ||
            stepData?.requires_elevation;

        if (hasAdvancedValues) {
            // Expand the advanced section
            setTimeout(() => toggleAdvancedSettings(stepId), 0);
        }
        */

        updateCounts();
    }

    function initCodeMirror(textareaId, mode) {
        const textarea = document.getElementById(textareaId);
        if (!textarea) return;

        const editor = CodeMirror.fromTextArea(textarea, {
            mode: mode === 'powershell' ? 'powershell' : 'shell',
            theme: 'dracula',
            lineNumbers: true,
            lineWrapping: true,
            viewportMargin: Infinity
        });

        codeMirrorInstances[textareaId] = editor;
    }

    function switchCmdTab(stepId, tab) {
        const step = document.getElementById(stepId);

        // Update tab styles
        step.querySelectorAll('.cmd-tab').forEach(t => t.classList.remove('active'));
        step.querySelector(`.cmd-tab:${tab === 'linux' ? 'first-child' : 'last-child'}`).classList.add('active');

        // Show/hide content
        step.querySelectorAll('.cmd-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${stepId}-${tab}-content`).classList.add('active');

        // Refresh CodeMirror
        const editor = codeMirrorInstances[`${stepId}-${tab}`];
        if (editor) {
            setTimeout(() => editor.refresh(), 10);
        }
    }

    function toggleStepType(stepId) {
        const step = document.getElementById(stepId);
        const stepType = step.querySelector('.step-type').value;
        const commandConfig = document.getElementById(`${stepId}-command-config`);
        const apiConfig = document.getElementById(`${stepId}-api-config`);
        const apiProfileSelector = document.getElementById(`${stepId}-api-profile`);

        if (stepType === 'api') {
            commandConfig.style.display = 'none';
            apiConfig.style.display = 'block';
            if (apiProfileSelector) apiProfileSelector.style.display = 'block';
        } else {
            commandConfig.style.display = 'block';
            apiConfig.style.display = 'none';
            if (apiProfileSelector) apiProfileSelector.style.display = 'none';
        }
    }

    function toggleStepAdvanced(stepId) {
        const advanced = document.getElementById(`${stepId}-advanced`);
        advanced.classList.toggle('show');
    }

    function toggleAdvancedSettings(stepId) {
        const advanced = document.getElementById(`${stepId}-advanced`);
        const icon = document.getElementById(`${stepId}-advanced-icon`);

        // Toggle 'show' class to override CSS display:none
        advanced.classList.toggle('show');

        if (advanced.classList.contains('show')) {
            icon.style.transform = 'rotate(90deg)';
        } else {
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function removeStep(stepId) {
        document.getElementById(stepId).remove();
        updateStepNumbers();
        updateCounts();

        // Show empty message if no steps
        if (document.querySelectorAll('.step-card').length === 0) {
            document.getElementById('noStepsMessage').style.display = 'block';
        }

        // Cleanup CodeMirror instances
        delete codeMirrorInstances[`${stepId}-linux`];
        delete codeMirrorInstances[`${stepId}-windows`];
    }

    function addTrigger(triggerData = null) {
        triggerCounter++;
        const container = document.getElementById('triggersContainer');
        const triggerId = `trigger-${triggerCounter}`;

        const triggerHtml = `
        <div class="trigger-card" id="${triggerId}" data-trigger-id="${triggerData?.id || ''}">
            <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-primary flex items-center gap-2">
                    <i class="fas fa-bolt text-yellow-400"></i>
                    Trigger ${triggerCounter}
                </span>
                <button type="button" onclick="removeTrigger('${triggerId}')" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-secondary text-xs mb-1">Alert Name Pattern</label>
                    <input type="text" class="trigger-alert-name input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., CPU.*high, HighMemory*" value="${escapeHtml(triggerData?.alert_name_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Severity</label>
                    <select class="trigger-severity input-field w-full px-2 py-1.5 rounded text-sm">
                        <option value="*" ${triggerData?.severity_pattern === '*' ? 'selected' : ''}>Any</option>
                        <option value="critical" ${triggerData?.severity_pattern === 'critical' ? 'selected' : ''}>Critical</option>
                        <option value="warning" ${triggerData?.severity_pattern === 'warning' ? 'selected' : ''}>Warning</option>
                        <option value="info" ${triggerData?.severity_pattern === 'info' ? 'selected' : ''}>Info</option>
                    </select>
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Instance Pattern</label>
                    <input type="text" class="trigger-instance input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., prod-*, 10.0.0.*" value="${escapeHtml(triggerData?.instance_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Job Pattern</label>
                    <input type="text" class="trigger-job input-field w-full px-2 py-1.5 rounded text-sm" 
                        placeholder="e.g., nginx, node-exporter" value="${escapeHtml(triggerData?.job_pattern || '*')}">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Min Duration (seconds)</label>
                    <input type="number" class="trigger-duration input-field w-full px-2 py-1.5 rounded text-sm" 
                        value="${triggerData?.min_duration_seconds || 0}" min="0">
                </div>
                <div>
                    <label class="block text-secondary text-xs mb-1">Priority (lower = higher)</label>
                    <input type="number" class="trigger-priority input-field w-full px-2 py-1.5 rounded text-sm" 
                        value="${triggerData?.priority || 100}" min="1" max="1000">
                </div>
            </div>
            
            <div class="mt-3">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" class="trigger-enabled" ${triggerData?.enabled !== false ? 'checked' : ''}>
                    <span class="text-secondary text-sm">Trigger enabled</span>
                </label>
            </div>
        </div>
    `;

        container.insertAdjacentHTML('beforeend', triggerHtml);
        document.getElementById('noTriggersMessage').style.display = 'none';

        updateCounts();
    }

    function removeTrigger(triggerId) {
        document.getElementById(triggerId).remove();
        updateCounts();

        if (document.querySelectorAll('.trigger-card').length === 0) {
            document.getElementById('noTriggersMessage').style.display = 'block';
        }
    }

    function updateCounts() {
        const stepsCount = document.querySelectorAll('.step-card').length;
        const triggersCount = document.querySelectorAll('.trigger-card').length;

        document.getElementById('stepsCount').textContent = stepsCount;
        document.getElementById('triggersCount').textContent = triggersCount;
    }

    function collectFormData() {
        // Sync CodeMirror instances to textareas
        Object.values(codeMirrorInstances).forEach(editor => editor.save());

        // Collect steps
        const steps = [];
        document.querySelectorAll('.step-card').forEach((stepEl, index) => {
            const stepId = stepEl.id;
            const stepType = stepEl.querySelector('.step-type').value;

            const stepData = {
                id: stepEl.dataset.stepId || null,
                step_order: index + 1,
                step_type: stepType,
                name: stepEl.querySelector('.step-name').value || `Step ${index + 1}`,
                description: stepEl.querySelector('.step-description')?.value || null,
                target_os: stepEl.querySelector('.step-os').value,
                timeout_seconds: parseInt(stepEl.querySelector('.step-timeout')?.value) || 60,
                requires_elevation: stepEl.querySelector('.step-elevation')?.checked || false,
                continue_on_fail: stepEl.querySelector('.step-continue-on-fail')?.checked || false,
                retry_count: parseInt(stepEl.querySelector('.step-retry')?.value) || 0,
                retry_delay_seconds: 5,
                expected_exit_code: parseInt(stepEl.querySelector('.step-exit-code')?.value) || 0,
                output_variable: stepEl.querySelector('.step-output-variable')?.value || null,
                output_extract_pattern: stepEl.querySelector('.step-output-pattern')?.value || null,
                run_if_variable: stepEl.querySelector('.step-run-if-variable')?.value || null,
                run_if_value: stepEl.querySelector('.step-run-if-value')?.value || null,
                rollback_command_linux: stepEl.querySelector('.step-rollback-linux')?.value || null,
                rollback_command_windows: stepEl.querySelector('.step-rollback-windows')?.value || null
            };

            // Add command-specific fields
            if (stepType === 'command') {
                stepData.command_linux = codeMirrorInstances[`${stepId}-linux`]?.getValue() || null;
                stepData.command_windows = codeMirrorInstances[`${stepId}-windows`]?.getValue() || null;
            }
            // Add API-specific fields
            else if (stepType === 'api') {
                stepData.api_credential_profile_id = stepEl.querySelector('.step-api-profile')?.value || null;
                stepData.api_method = stepEl.querySelector('.step-api-method')?.value || 'GET';
                stepData.api_endpoint = stepEl.querySelector('.step-api-endpoint')?.value || null;
                stepData.api_body_type = stepEl.querySelector('.step-api-body-type')?.value || 'json';
                stepData.api_body = stepEl.querySelector('.step-api-body')?.value || null;

                // Parse JSON fields
                try {
                    const headersText = stepEl.querySelector('.step-api-headers')?.value?.trim();
                    stepData.api_headers_json = headersText ? JSON.parse(headersText) : null;
                } catch (e) {
                    stepData.api_headers_json = null;
                }

                try {
                    const queryParamsText = stepEl.querySelector('.step-api-query-params')?.value?.trim();
                    stepData.api_query_params_json = queryParamsText ? JSON.parse(queryParamsText) : null;
                } catch (e) {
                    stepData.api_query_params_json = null;
                }

                try {
                    const extractText = stepEl.querySelector('.step-api-extract')?.value?.trim();
                    stepData.api_response_extract_json = extractText ? JSON.parse(extractText) : null;
                } catch (e) {
                    stepData.api_response_extract_json = null;
                }

                // Parse expected status codes
                const statusCodesText = stepEl.querySelector('.step-api-status-codes')?.value?.trim();
                if (statusCodesText) {
                    stepData.api_expected_status_codes = statusCodesText.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c));
                } else {
                    stepData.api_expected_status_codes = [200, 201, 202, 204];
                }
            }

            steps.push(stepData);
        });

        // Collect triggers
        const triggers = [];
        document.querySelectorAll('.trigger-card').forEach((triggerEl, index) => {
            triggers.push({
                id: triggerEl.dataset.triggerId || null,
                alert_name_pattern: triggerEl.querySelector('.trigger-alert-name').value || '*',
                severity_pattern: triggerEl.querySelector('.trigger-severity').value,
                instance_pattern: triggerEl.querySelector('.trigger-instance').value || '*',
                job_pattern: triggerEl.querySelector('.trigger-job').value || '*',
                min_duration_seconds: parseInt(triggerEl.querySelector('.trigger-duration').value) || 0,
                min_occurrences: 1,
                priority: parseInt(triggerEl.querySelector('.trigger-priority').value) || 100,
                enabled: triggerEl.querySelector('.trigger-enabled').checked
            });
        });

        // Status
        const statusValue = document.querySelector('input[name="status"]:checked').value;
        const enabled = statusValue !== 'disabled';
        const autoExecute = statusValue === 'active';

        // Approval
        const approvalValue = document.getElementById('approvalRequired').value;
        const approvalRequired = approvalValue !== 'none';

        // OS Filter
        const osFilter = [];
        if (document.getElementById('osLinux').checked) osFilter.push('linux');
        if (document.getElementById('osWindows').checked) osFilter.push('windows');

        // Tags
        const tagsStr = document.getElementById('runbookTags').value;
        const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

        return {
            name: document.getElementById('runbookName').value,
            description: document.getElementById('runbookDescription').value || null,
            category: document.getElementById('runbookCategory').value,
            tags: tags,
            documentation_url: document.getElementById('runbookDocUrl').value || null,
            enabled: enabled,
            auto_execute: autoExecute,
            approval_required: approvalRequired,
            approval_roles: ['operator', 'engineer', 'admin'],
            approval_timeout_minutes: parseInt(document.getElementById('approvalTimeout').value) || 30,
            max_executions_per_hour: parseInt(document.getElementById('maxExecutions').value) || 5,
            cooldown_minutes: parseInt(document.getElementById('cooldownMinutes').value) || 10,
            default_server_id: document.getElementById('defaultServer').value || null,
            target_os_filter: osFilter.length > 0 ? osFilter : ['linux', 'windows'],
            target_from_alert: document.getElementById('targetFromAlert').checked,
            target_alert_label: document.getElementById('targetAlertLabel').value || 'instance',
            steps: steps,
            triggers: triggers
        };
    }

    async function saveRunbook() {
        const data = collectFormData();

        // Validation
        if (!data.name) {
            showToast('Runbook name is required', 'error');
            document.getElementById('runbookName').focus();
            return;
        }

        if (data.steps.length === 0) {
            showToast('At least one step is required', 'error');
            scrollToSection({ preventDefault: () => { } }, 'section-steps');
            return;
        }

        // Check if steps have required fields based on type
        for (const step of data.steps) {
            if (step.step_type === 'api') {
                if (!step.api_endpoint) {
                    showToast(`API step "${step.name}" is missing endpoint`, 'error');
                    return;
                }
                if (!step.api_method) {
                    showToast(`API step "${step.name}" is missing HTTP method`, 'error');
                    return;
                }
            } else if (step.step_type === 'command') {
                if (!step.command_linux && !step.command_windows) {
                    showToast(`Command step "${step.name}" has no command defined`, 'error');
                    return;
                }
            }
        }

        try {
            const id = document.getElementById('runbookId').value;
            const url = id ? `/api/remediation/runbooks/${id}` : '/api/remediation/runbooks';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Runbook updated successfully' : 'Runbook created successfully', 'success');
                setTimeout(() => {
                    window.location.href = '/runbooks';
                }, 1000);
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save runbook', 'error');
            }
        } catch (error) {
            console.error('Error saving runbook:', error);
            showToast('Error saving runbook', 'error');
        }
    }

    function cancelForm() {
        document.getElementById('cancelConfirmModal').classList.remove('hidden');
    }

    function closeCancelConfirmModal() {
        document.getElementById('cancelConfirmModal').classList.add('hidden');
    }

    function confirmCancel() {
        window.location.href = '/runbooks';
    }

    function previewYAML() {
        const data = collectFormData();

        const yaml = {
            apiVersion: 'aiops.io/v1',
            kind: 'Runbook',
            metadata: {
                name: data.name,
                description: data.description,
                category: data.category,
                tags: data.tags
            },
            spec: {
                execution: {
                    auto_execute: data.auto_execute,
                    approval_required: data.approval_required,
                    approval_timeout_minutes: data.approval_timeout_minutes
                },
                safety: {
                    max_executions_per_hour: data.max_executions_per_hour,
                    cooldown_minutes: data.cooldown_minutes
                },
                target: {
                    os_filter: data.target_os_filter,
                    from_alert: data.target_from_alert,
                    alert_label: data.target_alert_label
                }
            },
            triggers: data.triggers.map(t => ({
                alert_name_pattern: t.alert_name_pattern,
                severity_pattern: t.severity_pattern,
                instance_pattern: t.instance_pattern,
                priority: t.priority,
                enabled: t.enabled
            })),
            steps: data.steps.map(s => ({
                name: s.name,
                command_linux: s.command_linux,
                command_windows: s.command_windows,
                target_os: s.target_os,
                timeout_seconds: s.timeout_seconds,
                continue_on_fail: s.continue_on_fail
            }))
        };

        // Simple YAML conversion (basic)
        const yamlStr = jsonToYaml(yaml);
        document.getElementById('yamlContent').textContent = yamlStr;
        document.getElementById('yamlModal').classList.remove('hidden');
    }

    function jsonToYaml(obj, indent = 0) {
        let yaml = '';
        const spaces = '  '.repeat(indent);

        for (const [key, value] of Object.entries(obj)) {
            if (value === null || value === undefined) continue;

            if (Array.isArray(value)) {
                if (value.length === 0) {
                    yaml += `${spaces}${key}: []\n`;
                } else if (typeof value[0] === 'object') {
                    yaml += `${spaces}${key}:\n`;
                    value.forEach(item => {
                        yaml += `${spaces}- `;
                        const itemYaml = jsonToYaml(item, indent + 1);
                        yaml += itemYaml.trim().replace(/^/gm, '  '.repeat(indent + 1)).slice(2 * (indent + 1)) + '\n';
                    });
                } else {
                    yaml += `${spaces}${key}: [${value.map(v => typeof v === 'string' ? `"${v}"` : v).join(', ')}]\n`;
                }
            } else if (typeof value === 'object') {
                yaml += `${spaces}${key}:\n`;
                yaml += jsonToYaml(value, indent + 1);
            } else if (typeof value === 'string') {
                if (value.includes('\n')) {
                    yaml += `${spaces}${key}: |\n`;
                    value.split('\n').forEach(line => {
                        yaml += `${spaces}  ${line}\n`;
                    });
                } else {
                    yaml += `${spaces}${key}: "${value}"\n`;
                }
            } else {
                yaml += `${spaces}${key}: ${value}\n`;
            }
        }

        return yaml;
    }

    function closeYAMLModal() {
        document.getElementById('yamlModal').classList.add('hidden');
    }

    function copyYAML() {
        const content = document.getElementById('yamlContent').textContent;
        navigator.clipboard.writeText(content).then(() => {
            showToast('YAML copied to clipboard', 'success');
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Toast notification (use global if available)
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const toast = document.createElement('div');
            const bgColors = {
                success: 'background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46;',
                error: 'background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;',
                warning: 'background: #fffbeb; border: 1px solid #fde68a; color: #92400e;',
                info: 'background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af;'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            toast.style.cssText = `position: fixed; bottom: 16px; right: 16px; padding: 12px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 9999; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; ${bgColors[type] || bgColors.info}`;
            toast.innerHTML = `
            <i class="fas ${icons[type] || icons.info}"></i>
            <span>${escapeHtml(message)}</span>
        `;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
        };
    }
</script>

<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        flowchart: { curve: 'basis' },
        themeVariables: {
            fontFamily: 'Segoe UI, Roboto, Helvetica, Arial, sans-serif',
            fontSize: '13px'
        }
    });

    window.updateWorkflowDiagram = async function () {
        const element = document.getElementById('workflowGraph');
        // Get current steps from data collection
        const data = collectFormData();
        const steps = data.steps;

        if (!steps || steps.length === 0) {
            element.innerHTML = '<div class="flex flex-col items-center text-secondary"><i class="fas fa-list-ul text-4xl mb-2"></i><span>No steps defined</span></div>';
            return;
        }

        // Build Mermaid syntax with conditional support
        let mmd = 'graph TD\n';
        mmd += '    Start((Start)):::start\n';

        // Track the previous node to connect from
        let prevNode = 'Start';

        steps.forEach((step, index) => {
            const safeName = (step.name || 'Untitled').replace(/["'\n]/g, '').substring(0, 30);
            const stepNode = `Step${index}`;

            // Check if this step has a condition
            const hasCondition = step.run_if_variable && step.run_if_value;
            const conditionNode = `Cond${index}`;

            // Build node label with extra info
            let label = safeName;

            // Add icon
            let icon = 'fa:fa-terminal';
            if (step.step_type === 'api') icon = 'fa:fa-globe';
            label = `${icon} ${label}`;

            // Show Output Variable if set
            if (step.output_variable) {
                label += `<br/><small>➜ $${step.output_variable}</small>`;
            }

            // Determine style
            let style = ':::cmd';
            if (step.step_type === 'api') style = ':::api';

            if (hasCondition) {
                // Create a decision diamond for the condition
                const condVar = step.run_if_variable;
                const condVal = step.run_if_value.length > 10 ? step.run_if_value.substring(0, 10) + '...' : step.run_if_value;

                mmd += '    ' + conditionNode + '{' + condVar + ' == ' + condVal + '?}:::condition\n';
                mmd += '    ' + stepNode + '["' + label + '"]' + style + '\n';

                // Connect previous node to condition
                mmd += `    ${prevNode} --> ${conditionNode}\n`;

                // Condition true: run the step
                mmd += `    ${conditionNode} -->|Yes| ${stepNode}\n`;

                // Condition false: skip to next step or end
                if (index < steps.length - 1) {
                    // Check if next step also has condition
                    const nextStep = steps[index + 1];
                    const nextHasCondition = nextStep.run_if_variable && nextStep.run_if_value;
                    if (nextHasCondition) {
                        mmd += `    ${conditionNode} -.->|No/Skip| Cond${index + 1}\n`;
                    } else {
                        mmd += `    ${conditionNode} -.->|No/Skip| Step${index + 1}\n`;
                    }
                } else {
                    mmd += `    ${conditionNode} -.->|No/Skip| EndNode((End)):::finish\n`;
                }

                // Step continues to next
                if (index < steps.length - 1) {
                    const nextStep = steps[index + 1];
                    const nextHasCondition = nextStep.run_if_variable && nextStep.run_if_value;
                    if (nextHasCondition) {
                        prevNode = stepNode; // Will connect to next condition
                    } else {
                        prevNode = stepNode; // Will connect directly to next step
                    }
                } else {
                    mmd += `    ${stepNode} --> EndNode((End)):::finish\n`;
                }

                // Update prevNode for steps that complete
                if (index < steps.length - 1) {
                    // The step output connects to the next node
                }
                prevNode = stepNode;
            } else {
                // No condition - simple linear connection
                mmd += `    ${stepNode}["${label}"]${style}\n`;
                mmd += `    ${prevNode} --> ${stepNode}\n`;

                if (index === steps.length - 1) {
                    mmd += `    ${stepNode} --> EndNode((End)):::finish\n`;
                }
                prevNode = stepNode;
            }
        });

        // Styles
        mmd += `
    classDef start fill:#10b981,stroke:#059669,color:white;
    classDef finish fill:#ef4444,stroke:#dc2626,color:white;
    classDef cmd fill:#3b82f6,stroke:#2563eb,color:white;
    classDef api fill:#10b981,stroke:#059669,color:white;
    classDef condition fill:#f59e0b,stroke:#d97706,color:white;
        `;

        try {
            // Need unique ID for each render to avoid conflicts if re-rendering
            const { svg } = await mermaid.render('workflowSvg-' + Date.now(), mmd);
            element.innerHTML = svg;
        } catch (e) {
            console.error('Mermaid render error:', e, mmd);
            element.innerHTML = '<div class="text-red-400 text-sm">Error rendering workflow. Check console for details.</div>';
        }
    };
</script>
{{ super() }}
{% endblock %}