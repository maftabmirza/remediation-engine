{% extends "base.html" %}

{% block body %}
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-20 fixed h-full flex flex-col transition-all duration-300 z-20">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-700 flex justify-between items-center">
            <div class="flex items-center space-x-3 overflow-hidden">
                <i class="fas fa-robot text-2xl text-blue-400 flex-shrink-0"></i>
                <span class="text-xl font-bold sidebar-text whitespace-nowrap hidden">AIOps</span>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-2 overflow-hidden">
            <!-- Dashboard with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('dashboardFlyout')"
                onmouseleave="hideFlyout('dashboardFlyout')">
                <button onclick="toggleSubmenu('dashboardSubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'dashboard' or active_page == 'analytics' or active_page == 'changes' %}active{% endif %}"
                    data-tooltip="Dashboard" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-tachometer-alt w-5 flex-shrink-0 nav-icon text-blue-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">Dashboard</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="dashboardSubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="dashboardSubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'dashboard' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-home w-4 text-blue-300"></i>
                        <span>Overview</span>
                    </a>
                    <a href="/analytics"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'analytics' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-chart-line w-4 text-teal-300"></i>
                        <span>MTTR Analytics</span>
                    </a>
                    <a href="/changes"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'changes' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-code-branch w-4 text-purple-300"></i>
                        <span>Change Correlation</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="dashboardFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        Dashboard</div>
                    <a href="/"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-home w-4 text-blue-300"></i>
                        <span>Overview</span>
                    </a>
                    <a href="/analytics"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-chart-line w-4 text-teal-300"></i>
                        <span>MTTR Analytics</span>
                    </a>
                    <a href="/changes"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-code-branch w-4 text-purple-300"></i>
                        <span>Change Correlation</span>
                    </a>
                </div>
            </div>

            <!-- Observability with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('observabilityFlyout')"
                onmouseleave="hideFlyout('observabilityFlyout')">
                <button onclick="toggleSubmenu('observabilitySubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'logs' or active_page == 'traces' or active_page == 'grafana-alerts' or active_page == 'grafana-advanced' %}active{% endif %}"
                    data-tooltip="Observability" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-eye w-5 flex-shrink-0 nav-icon text-emerald-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">Observability</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="observabilitySubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="observabilitySubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/logs"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'logs' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-file-alt w-4 text-emerald-300"></i>
                        <span>Logs</span>
                    </a>
                    <a href="/traces"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'traces' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-project-diagram w-4 text-violet-300"></i>
                        <span>Traces</span>
                    </a>
                    <a href="/grafana-alerts"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'grafana-alerts' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-exclamation-triangle w-4 text-amber-300"></i>
                        <span>Alert Manager</span>
                    </a>
                    <a href="/grafana-advanced"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'grafana-advanced' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-chart-area w-4 text-fuchsia-300"></i>
                        <span>Advanced</span>
                    </a>
                    <a href="/prometheus-view"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'prometheus-view' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-fire w-4 text-orange-500"></i>
                        <span>Prometheus</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="observabilityFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        Observability</div>
                    <a href="/logs"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-file-alt w-4 text-emerald-300"></i>
                        <span>Logs</span>
                    </a>
                    <a href="/traces"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-project-diagram w-4 text-violet-300"></i>
                        <span>Traces</span>
                    </a>
                    <a href="/grafana-alerts"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-exclamation-triangle w-4 text-amber-300"></i>
                        <span>Alert Manager</span>
                    </a>
                    <a href="/grafana-advanced"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-chart-area w-4 text-fuchsia-300"></i>
                        <span>Advanced</span>
                    </a>
                    <a href="/prometheus-view"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-fire w-4 text-orange-500"></i>
                        <span>Prometheus</span>
                    </a>
                </div>
            </div>

            <!-- Prometheus with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('prometheusFlyout')"
                onmouseleave="hideFlyout('prometheusFlyout')">
                <button onclick="toggleSubmenu('prometheusSubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'dashboards' or active_page == 'datasources' or active_page == 'panels' or active_page == 'playlists' %}active{% endif %}"
                    data-tooltip="Prometheus" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-fire w-5 flex-shrink-0 nav-icon text-orange-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">Prometheus</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="prometheusSubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="prometheusSubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/dashboards"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'dashboards' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-th-large w-4 text-pink-300"></i>
                        <span>Dashboards</span>
                    </a>
                    <a href="/datasources"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'datasources' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-database w-4 text-orange-300"></i>
                        <span>Datasources</span>
                    </a>
                    <a href="/panels"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'panels' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-chart-bar w-4 text-green-300"></i>
                        <span>Panels</span>
                    </a>
                    <a href="/playlists"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'playlists' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-play-circle w-4 text-cyan-300"></i>
                        <span>Playlists</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="prometheusFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        Prometheus</div>
                    <a href="/dashboards"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-th-large w-4 text-pink-300"></i>
                        <span>Dashboards</span>
                    </a>
                    <a href="/datasources"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-database w-4 text-orange-300"></i>
                        <span>Datasources</span>
                    </a>
                    <a href="/panels"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-chart-bar w-4 text-green-300"></i>
                        <span>Panels</span>
                    </a>
                    <a href="/playlists"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-play-circle w-4 text-cyan-300"></i>
                        <span>Playlists</span>
                    </a>
                </div>
            </div>

            <!-- Standalone Items -->
            <a href="/alerts"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'alerts' %}active{% endif %}"
                data-tooltip="Alerts">
                <i class="fas fa-bell w-5 flex-shrink-0 nav-icon text-yellow-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Alerts</span>
            </a>
            <a href="/inquiry"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'inquiry' %}active{% endif %}"
                data-tooltip="AI Analyst">
                <i class="fas fa-search w-5 flex-shrink-0 nav-icon text-blue-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">AI Analyst</span>
            </a>
            <a href="/troubleshoot"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'troubleshoot' %}active{% endif %}"
                data-tooltip="Troubleshoot Console">
                <i class="fas fa-terminal w-5 flex-shrink-0 nav-icon text-green-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Troubleshoot</span>
            </a>

            <!-- Remediation with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('remediationFlyout')"
                onmouseleave="hideFlyout('remediationFlyout')">
                <button onclick="toggleSubmenu('remediationSubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'runbooks' or active_page == 'executions' or active_page == 'schedules' %}active{% endif %}"
                    data-tooltip="Remediation" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-wrench w-5 flex-shrink-0 nav-icon text-green-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">Remediation</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="remediationSubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="remediationSubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/runbooks"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'runbooks' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-book w-4 text-green-300"></i>
                        <span>Runbooks</span>
                    </a>
                    <a href="/executions"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'executions' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-play-circle w-4 text-red-300"></i>
                        <span>Executions</span>
                    </a>
                    <a href="/schedules"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'schedules' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-calendar-alt w-4 text-orange-300"></i>
                        <span>Schedules</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="remediationFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        Remediation</div>
                    <a href="/runbooks"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-book w-4 text-green-300"></i>
                        <span>Runbooks</span>
                    </a>
                    <a href="/executions"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-play-circle w-4 text-red-300"></i>
                        <span>Executions</span>
                    </a>
                    <a href="/schedules"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-calendar-alt w-4 text-orange-300"></i>
                        <span>Schedules</span>
                    </a>
                </div>
            </div>

            <!-- Knowledge with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('knowledgeFlyout')"
                onmouseleave="hideFlyout('knowledgeFlyout')">
                <button onclick="toggleSubmenu('knowledgeSubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'applications' or active_page == 'knowledge' %}active{% endif %}"
                    data-tooltip="Knowledge" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-book-open w-5 flex-shrink-0 nav-icon text-cyan-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">Knowledge</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="knowledgeSubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="knowledgeSubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/applications"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'applications' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-sitemap w-4 text-indigo-300"></i>
                        <span>Applications</span>
                    </a>
                    <a href="/knowledge"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'knowledge' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-brain w-4 text-cyan-300"></i>
                        <span>Knowledge Base</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="knowledgeFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        Knowledge</div>
                    <a href="/applications"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-sitemap w-4 text-indigo-300"></i>
                        <span>Applications</span>
                    </a>
                    <a href="/knowledge"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-brain w-4 text-cyan-300"></i>
                        <span>Knowledge Base</span>
                    </a>
                </div>
            </div>

            <!-- Settings and Rules standalone -->
            <a href="/settings"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'settings' %}active{% endif %}"
                data-tooltip="Settings">
                <i class="fas fa-sliders-h w-5 flex-shrink-0 nav-icon text-gray-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Settings</span>
            </a>
            <a href="/rules"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'rules' %}active{% endif %}"
                data-tooltip="Rules">
                <i class="fas fa-cogs w-5 flex-shrink-0 nav-icon text-purple-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Rules</span>
            </a>
            {% if user.role == 'admin' %}
            <a href="/audit"
                class="sidebar-item flex items-center space-x-3 px-4 py-3 rounded-lg {% if active_page == 'audit' %}active{% endif %}"
                data-tooltip="Audit Logs">
                <i class="fas fa-history w-5 flex-shrink-0 nav-icon text-cyan-400"></i>
                <span class="sidebar-text whitespace-nowrap hidden">Audit Logs</span>
            </a>
            {% endif %}
            
            <!-- PII Detection with Submenu -->
            <div class="nav-group relative" onmouseenter="showFlyout('piiDetectionFlyout')"
                onmouseleave="hideFlyout('piiDetectionFlyout')">
                <button onclick="toggleSubmenu('piiDetectionSubmenu')"
                    class="sidebar-item flex items-center justify-between w-full px-4 py-3 rounded-lg {% if active_page == 'pii_detection' or active_page == 'pii_logs' %}active{% endif %}"
                    data-tooltip="PII Detection" data-has-submenu="true">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-shield-alt w-5 flex-shrink-0 nav-icon text-yellow-400"></i>
                        <span class="sidebar-text whitespace-nowrap hidden">PII Detection</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-500 sidebar-text hidden submenu-arrow"
                        id="piiDetectionSubmenuArrow"></i>
                </button>
                <!-- Inline submenu (shown when sidebar expanded) -->
                <div id="piiDetectionSubmenu"
                    class="submenu ml-4 mt-1 space-y-1 sidebar-text hidden overflow-hidden transition-all duration-200">
                    <a href="/pii-detection"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'pii_detection' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-cog w-4 text-yellow-300"></i>
                        <span>Configuration</span>
                    </a>
                    <a href="/pii-logs"
                        class="sidebar-subitem flex items-center space-x-3 px-4 py-2 rounded-lg text-sm {% if active_page == 'pii_logs' %}bg-gray-800 text-white{% else %}text-gray-400 hover:text-white hover:bg-gray-800{% endif %}">
                        <i class="fas fa-list w-4 text-orange-300"></i>
                        <span>Detection Logs</span>
                    </a>
                </div>
                <!-- Flyout submenu (shown on hover when sidebar collapsed) -->
                <div id="piiDetectionFlyout"
                    class="flyout-menu fixed left-20 bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-2 z-50 hidden min-w-48">
                    <div class="px-3 py-2 text-xs text-gray-500 uppercase tracking-wider border-b border-gray-700 mb-1">
                        PII Detection</div>
                    <a href="/pii-detection"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-cog w-4 text-yellow-300"></i>
                        <span>Configuration</span>
                    </a>
                    <a href="/pii-logs"
                        class="flex items-center space-x-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors">
                        <i class="fas fa-list w-4 text-orange-300"></i>
                        <span>Detection Logs</span>
                    </a>
                </div>
            </div>
        </nav>

        <!-- User Profile Dropdown -->
        <div class="p-4 border-t border-gray-700 relative group">
            <button id="userMenuBtn"
                class="flex items-center space-x-3 w-full hover:bg-gray-800 p-2 rounded-lg transition-colors focus:outline-none sidebar-item"
                onclick="toggleUserMenu()" data-tooltip="Profile / Theme">
                <div
                    class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0 border-2 border-transparent group-hover:border-blue-400 transition-all">
                    <span class="text-sm font-bold">{{ user.username[0].upper() }}</span>
                </div>
                <div class="sidebar-text whitespace-nowrap hidden text-left flex-1">
                    <div class="font-medium text-sm truncate">{{ user.username }}</div>
                    <div class="text-xs text-gray-400 capitalize">{{ user.role }}</div>
                </div>
                <i class="fas fa-chevron-right text-gray-500 text-xs sidebar-text hidden"></i>
            </button>

            <!-- Dropdown Menu -->
            <div id="userMenu"
                class="fixed left-20 bottom-4 w-64 bg-[#181b1f] border border-gray-700 rounded-lg shadow-xl transform scale-95 opacity-0 pointer-events-none transition-all duration-200 z-50 origin-bottom-left ml-2 hidden">
                <!-- Header -->
                <div class="p-4 border-b border-gray-700 bg-gray-800/30">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center shadow-lg">
                            <span class="text-lg font-bold text-white">{{ user.username[0].upper() }}</span>
                        </div>
                        <div>
                            <div class="font-bold text-white">{{ user.username }}</div>
                            <div class="text-xs text-blue-400 capitalize">{{ user.role }}</div>
                        </div>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="p-2 space-y-1">
                    <button onclick="showThemeModal(); closeUserMenu()"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-palette text-purple-400"></i></div>
                        <span>Appearance</span>
                    </button>
                    <!-- Settings Link (Duplicate of sidebar for convenience) -->
                    <a href="/profile"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-gray-300 hover:bg-gray-700 hover:text-white transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-user-cog text-gray-400"></i></div>
                        <span>User Settings</span>
                    </a>
                </div>

                <!-- Footer -->
                <div class="p-2 border-t border-gray-700 bg-gray-800/30">
                    <button onclick="logout()"
                        class="w-full flex items-center space-x-3 px-3 py-2 rounded text-red-400 hover:bg-red-900/20 hover:text-red-300 transition-colors text-sm text-left">
                        <div class="w-6 flex justify-center"><i class="fas fa-sign-out-alt"></i></div>
                        <span>Log Out</span>
                    </button>
                </div>
            </div>

            <!-- Build Version -->
            <div class="mt-2 text-[10px] text-gray-600 text-center sidebar-text hidden">
                Build v1.0.2
            </div>
        </div>
    </aside>

    <!-- Main content container -->
    <div id="main-wrapper" class="flex-1 ml-20 h-screen flex flex-col transition-all duration-300">
        <!-- Enterprise Standard Global Header -->
        <header id="global-header"
            class="dashboard-header flex-shrink-0 flex items-center bg-[#16171b] border-b border-gray-800 h-14 px-4 shadow-sm z-10">
            <div class="flex items-center justify-between w-full">
                <!-- Left: Title & Context -->
                <div class="flex flex-col justify-center gap-0.5">
                    <!-- Title Region (Clean, No Border) -->
                    <div class="flex items-center text-white gap-2" id="header-title-container">
                        {% block header_title %}
                        <span class="text-sm font-semibold tracking-wide">AIOps Platform</span>
                        {% endblock %}
                    </div>

                    <!-- Breadcrumbs (2nd line) -->
                    <nav class="flex items-center text-[10px] text-gray-500 space-x-1 leading-none">
                        <a href="/" class="hover:text-blue-400 transition-colors">Home</a>
                        {% block breadcrumbs %}
                        <span class="mx-1">/</span>
                        <span>Page</span>
                        {% endblock %}
                    </nav>
                </div>

                <!-- Right: Actions & Tools -->
                <div class="flex items-center gap-3">
                    <!-- Page Actions -->
                    <div class="flex items-center gap-2">
                        {% block header_actions %}{% endblock %}
                    </div>

                    <!-- Divider -->
                    <div class="h-4 w-px bg-gray-700/50 mx-1"></div>

                    <!-- AI Assistant Toggle -->
                    <button id="ai-helper-toggle"
                        class="flex items-center gap-2 px-3 py-1.5 rounded text-xs font-medium text-gray-300 hover:text-white hover:bg-gray-800 transition-colors border border-transparent hover:border-gray-700"
                        title="Toggle RE-VIVE assistant">
                        <i class="fas fa-robot text-purple-400"></i>
                        <span class="hidden sm:inline">RE-VIVE</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main id="main-content" class="flex-1 px-6 pb-6 pt-4 overflow-y-auto transition-all duration-300">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Theme Selection Modal -->
<div id="themeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
    <div class="card p-6 w-full max-w-md m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">
                <i class="fas fa-palette text-purple-400 mr-2"></i>
                Appearance
            </h3>
            <button onclick="closeThemeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- Theme Selection -->
            <div>
                <p class="text-sm text-gray-400 mb-3">Color Theme:</p>
                <div class="grid grid-cols-2 gap-3">
                    <button data-theme-btn="default" onclick="setTheme('default')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#1e1e2e] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Default</span>
                    </button>

                    <button data-theme-btn="light" onclick="setTheme('light')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#f3f4f6] border border-gray-300"></div>
                        <span class="text-sm group-hover:text-blue-400">Light</span>
                    </button>

                    <button data-theme-btn="aftab" onclick="setTheme('aftab')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div
                            class="w-6 h-6 rounded-full bg-[#111217] border border-gray-500 flex items-center justify-center">
                            <span class="text-xs font-bold text-orange-500">A</span>
                        </div>
                        <span class="text-sm group-hover:text-blue-400">Aftab</span>
                    </button>

                    <button data-theme-btn="twilight" onclick="setTheme('twilight')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#282a36] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Twilight</span>
                    </button>

                    <button data-theme-btn="midnight" onclick="setTheme('midnight')"
                        class="theme-btn p-3 rounded-lg border border-gray-600 hover:border-blue-400 transition-all flex items-center space-x-3 group">
                        <div class="w-6 h-6 rounded-full bg-[#0f172a] border border-gray-500"></div>
                        <span class="text-sm group-hover:text-blue-400">Midnight</span>
                    </button>
                </div>
            </div>

            <!-- Zoom Control -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm text-gray-400">Zoom:</p>
                    <span id="zoomValue" class="text-sm font-medium text-blue-400">100%</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="adjustZoom(-10)"
                        class="btn-secondary w-8 h-8 rounded flex items-center justify-center text-lg" title="Zoom Out">
                        <i class="fas fa-minus text-xs"></i>
                    </button>
                    <input type="range" id="zoomSlider" min="75" max="150" step="5" value="100"
                        class="zoom-slider flex-1" onchange="setZoom(this.value)"
                        oninput="updateZoomDisplay(this.value)">
                    <button onclick="adjustZoom(10)"
                        class="btn-secondary w-8 h-8 rounded flex items-center justify-center text-lg" title="Zoom In">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1 px-1">
                    <span>75%</span>
                    <span>100%</span>
                    <span>150%</span>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-between items-center">
            <button onclick="resetAppearance()" class="text-sm text-gray-400 hover:text-white">
                <i class="fas fa-undo mr-1"></i>Reset to Default
            </button>
            <button onclick="closeThemeModal()" class="btn-secondary px-4 py-2 rounded">Close</button>
        </div>
    </div>
</div>

<!-- Command Palette Modal -->
<div id="commandPalette" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[100]"
    onclick="if(event.target === this) toggleCommandPalette()">
    <div class="bg-[#181b1f] border border-gray-700 rounded-lg shadow-2xl w-full max-w-2xl transform transition-all">
        <!-- Search Input -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center space-x-3 text-gray-400">
                <i class="fas fa-search text-xl"></i>
                <input type="text" id="commandInput"
                    class="bg-transparent border-none focus:ring-0 text-white text-lg w-full placeholder-gray-500"
                    placeholder="Type a command or search..." oninput="filterCommands()">
                <span class="text-xs border border-gray-600 rounded px-1.5 py-0.5">ESC</span>
            </div>
        </div>

        <!-- Results -->
        <div id="commandResults" class="max-h-[60vh] overflow-y-auto p-2">
            <!-- Populated by JS -->
        </div>

        <!-- Footer -->
        <div
            class="p-2 border-t border-gray-800 bg-gray-900/50 rounded-b-lg flex justify-between px-4 text-xs text-gray-500">
            <div>
                <span class="mr-3">Select <strong class="text-gray-400">↵</strong></span>
                <span>Navigate <strong class="text-gray-400">↑↓</strong></span>
            </div>
            <span>Antigravity AI</span>
        </div>
    </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div id="shortcutsModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[100]"
    onclick="if(event.target === this) toggleShortcutsModal()">
    <div class="card p-0 w-full max-w-3xl m-8 overflow-hidden">
        <div class="p-6 border-b border-gray-700 flex justify-between items-center bg-gray-800/30">
            <h3 class="text-xl font-bold flex items-center">
                <i class="fas fa-keyboard text-purple-400 mr-3"></i>
                Keyboard Shortcuts
            </h3>
            <button onclick="toggleShortcutsModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="p-6 grid grid-cols-2 gap-8">
            <div>
                <h4 class="text-sm uppercase text-gray-500 font-semibold mb-4 tracking-wider">Global</h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">Command Palette</span>
                        <div class="flex space-x-1">
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">Ctrl</span>
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">K</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">Help / Shortcuts</span>
                        <span
                            class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">?</span>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">Theme Settings</span>
                        <div class="flex space-x-1">
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">Ctrl</span>
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">/</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="text-sm uppercase text-gray-500 font-semibold mb-4 tracking-wider">Navigation</h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">Go to Dashboard</span>
                        <div class="flex space-x-1">
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">G</span>
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">D</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-gray-300">Go to Alerts</span>
                        <div class="flex space-x-1">
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">G</span>
                            <span
                                class="kbd bg-gray-800 border border-gray-600 rounded px-2 py-1 text-xs text-gray-300">A</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Listen for RE-VIVE toggle messages from iframes
    window.addEventListener('message', function (event) {
        if (event.data && event.data.type === 'REVIVE_TOGGLE') {
            const isOpen = event.data.isOpen;
            // Resize Grafana/Prometheus containers
            const containers = document.querySelectorAll('.grafana-container, .prometheus-container');
            containers.forEach(container => {
                if (isOpen) {
                    container.style.setProperty('right', '380px', 'important');
                    container.style.setProperty('width', 'calc(100% - 80px - 380px)', 'important');
                } else {
                    container.style.setProperty('right', '0', 'important');
                    container.style.setProperty('width', 'calc(100% - 80px)', 'important');
                }
            });
        }
    });
</script>
<script>
    function showThemeModal() {
        document.getElementById('themeModal').classList.remove('hidden');
        document.getElementById('themeModal').classList.add('flex');
        updateThemeButtons();
        updateZoomSlider();
    }

    function closeThemeModal() {
        document.getElementById('themeModal').classList.add('hidden');
        document.getElementById('themeModal').classList.remove('flex');
    }

    function updateThemeButtons() {
        const currentTheme = localStorage.getItem('aiops-theme') || 'aftab';
        // Remove active state from all buttons
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.remove('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
            btn.classList.add('border-gray-600');
        });
        // Add active state to current theme button using data attribute
        const activeBtn = document.querySelector(`[data-theme-btn="${currentTheme}"]`);
        if (activeBtn) {
            activeBtn.classList.remove('border-gray-600');
            activeBtn.classList.add('border-blue-400', 'bg-blue-500', 'bg-opacity-10');
        }
    }

    function updateZoomSlider() {
        const currentZoom = localStorage.getItem('aiops-zoom') || '100';
        const slider = document.getElementById('zoomSlider');
        const display = document.getElementById('zoomValue');
        if (slider) slider.value = currentZoom;
        if (display) display.textContent = currentZoom + '%';
    }

    function updateZoomDisplay(value) {
        document.getElementById('zoomValue').textContent = value + '%';
    }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('aiops-theme', themeName);
        updateThemeButtons();
        showToast(`Theme changed to ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`, 'success');
    }

    function setZoom(value) {
        document.documentElement.style.setProperty('--zoom-level', value);
        localStorage.setItem('aiops-zoom', value);
        updateZoomDisplay(value);
    }

    function adjustZoom(delta) {
        const slider = document.getElementById('zoomSlider');
        let newValue = parseInt(slider.value) + delta;
        newValue = Math.max(75, Math.min(150, newValue));
        slider.value = newValue;
        setZoom(newValue);
    }

    function resetAppearance() {
        setTheme('aftab');
        setZoom(100);
        showToast('Appearance reset to defaults', 'success');
    }

    function toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');
        const isHidden = menu.classList.contains('hidden');

        if (isHidden) {
            menu.classList.remove('hidden');
            // Small delay to allow display:block to apply before opacity transition
            setTimeout(() => {
                menu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
            }, 10);
            btn.classList.add('bg-gray-800');
        } else {
            closeUserMenu();
        }
    }

    function closeUserMenu() {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');

        menu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        btn.classList.remove('bg-gray-800');

        setTimeout(() => {
            menu.classList.add('hidden');
        }, 200);
    }

    // Close user menu on outside click
    document.addEventListener('click', (e) => {
        const menu = document.getElementById('userMenu');
        const btn = document.getElementById('userMenuBtn');

        if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
            closeUserMenu();
        }
    });

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const texts = document.querySelectorAll('.sidebar-text');

        if (sidebar.classList.contains('w-64')) {
            // Collapse
            sidebar.classList.remove('w-64');
            sidebar.classList.add('w-20');
            mainContent.classList.remove('ml-64');
            mainContent.classList.add('ml-20');
            texts.forEach(t => t.classList.add('hidden'));
        } else {
            // Expand
            sidebar.classList.remove('w-20');
            sidebar.classList.add('w-64');
            mainContent.classList.remove('ml-20');
            mainContent.classList.add('ml-64');
            texts.forEach(t => t.classList.remove('hidden'));
        }

        // Trigger resize for terminal
        setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
    }

    async function logout() {
        try {
            await fetch('/api/auth/logout', { method: 'POST' });
        } catch (e) { }
        window.location.href = '/login';
    }

    // Submenu toggle function
    function toggleSubmenu(submenuId) {
        const submenu = document.getElementById(submenuId);
        const arrow = document.getElementById(submenuId + 'Arrow');

        if (submenu.classList.contains('submenu-open')) {
            submenu.classList.remove('submenu-open');
            submenu.style.maxHeight = '0px';
            if (arrow) arrow.classList.remove('rotate-180');
        } else {
            submenu.classList.add('submenu-open');
            submenu.style.maxHeight = submenu.scrollHeight + 'px';
            if (arrow) arrow.classList.add('rotate-180');
        }
    }

    // Auto-expand submenus for active pages
    document.addEventListener('DOMContentLoaded', function () {
        // Check all submenus for active children
        const submenus = [
            { id: 'dashboardSubmenu', arrowId: 'dashboardSubmenuArrow' },
            { id: 'observabilitySubmenu', arrowId: 'observabilitySubmenuArrow' },
            { id: 'prometheusSubmenu', arrowId: 'prometheusSubmenuArrow' },
            { id: 'remediationSubmenu', arrowId: 'remediationSubmenuArrow' },
            { id: 'knowledgeSubmenu', arrowId: 'knowledgeSubmenuArrow' }
        ];

        submenus.forEach(function (config) {
            const submenu = document.getElementById(config.id);
            if (submenu) {
                const hasActiveChild = submenu.querySelector('.bg-gray-800');
                if (hasActiveChild) {
                    submenu.classList.add('submenu-open');
                    submenu.style.maxHeight = submenu.scrollHeight + 'px';
                    const arrow = document.getElementById(config.arrowId);
                    if (arrow) arrow.classList.add('rotate-180');
                }
            }
        });
    });

    // Flyout menu for collapsed sidebar
    let flyoutTimeout = null;

    function showFlyout(flyoutId) {
        const sidebar = document.getElementById('sidebar');
        // Only show flyout when sidebar is collapsed (width 20 = 80px)
        if (sidebar.classList.contains('w-20')) {
            // Clear any pending hide timeout
            if (flyoutTimeout) {
                clearTimeout(flyoutTimeout);
                flyoutTimeout = null;
            }

            const flyout = document.getElementById(flyoutId);
            const trigger = flyout.closest('.nav-group').querySelector('button');
            if (flyout && trigger) {
                const rect = trigger.getBoundingClientRect();
                flyout.style.top = rect.top + 'px';
                flyout.style.left = '80px'; // Match collapsed sidebar width
                flyout.classList.remove('hidden');
            }
        }
    }

    function hideFlyout(flyoutId) {
        // Add a small delay before hiding to allow mouse to move to flyout
        flyoutTimeout = setTimeout(() => {
            const flyout = document.getElementById(flyoutId);
            if (flyout) {
                flyout.classList.add('hidden');
            }
        }, 150);
    }

    // Keep flyout open when mouse is over it
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.flyout-menu').forEach(flyout => {
            flyout.addEventListener('mouseenter', () => {
                if (flyoutTimeout) {
                    clearTimeout(flyoutTimeout);
                    flyoutTimeout = null;
                }
            });
            flyout.addEventListener('mouseleave', () => {
                flyout.classList.add('hidden');
            });
        });
    });
</script>
<script>
    // --- Command Palette Logic ---
    const commands = [
        { id: 'dash', name: 'Go to Dashboard', icon: 'fa-tachometer-alt', action: () => window.location.href = '/' },
        { id: 'dashboards', name: 'Go to Dashboards', icon: 'fa-th-large', action: () => window.location.href = '/dashboards' },
        { id: 'logs', name: 'Go to Logs (Loki)', icon: 'fa-file-alt', action: () => window.location.href = '/logs' },
        { id: 'traces', name: 'Go to Traces (Tempo)', icon: 'fa-project-diagram', action: () => window.location.href = '/traces' },
        { id: 'grafana-alerts', name: 'Go to Alert Manager', icon: 'fa-exclamation-triangle', action: () => window.location.href = '/grafana-alerts' },
        { id: 'grafana-advanced', name: 'Go to Advanced Dashboards', icon: 'fa-chart-area', action: () => window.location.href = '/grafana-advanced' },
        { id: 'alerts', name: 'Go to Alerts', icon: 'fa-bell', action: () => window.location.href = '/alerts' },
        { id: 'ai', name: 'Go to AI Assistant', icon: 'fa-robot', action: () => window.location.href = '/ai' },
        { id: 'rules', name: 'Go to Rules', icon: 'fa-cogs', action: () => window.location.href = '/rules' },
        { id: 'runbooks', name: 'Go to Runbooks', icon: 'fa-book', action: () => window.location.href = '/runbooks' },
        { id: 'kb', name: 'Go to Knowledge Base', icon: 'fa-book-open', action: () => window.location.href = '/knowledge' },
        { id: 'settings', name: 'Go to Settings', icon: 'fa-sliders-h', action: () => window.location.href = '/settings' },
        { id: 'theme', name: 'Change Theme', icon: 'fa-palette', action: () => { toggleCommandPalette(); showThemeModal(); } },
        { id: 'logout', name: 'Log Out', icon: 'fa-sign-out-alt', action: () => logout(), class: 'text-red-400' }
    ];

    let selectedCommandIndex = 0;

    document.addEventListener('keydown', (e) => {
        // Toggle Command Palette: Ctrl+K or Cmd+K
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            toggleCommandPalette();
        }

        // Shortcuts Modal: ? (Shift+/)
        // Check if not focused on input
        const activeTag = document.activeElement.tagName;
        if (e.key === '?' && activeTag !== 'INPUT' && activeTag !== 'TEXTAREA') {
            e.preventDefault();
            toggleShortcutsModal();
        }

        // Navigation handling when palette is open
        const palette = document.getElementById('commandPalette');
        if (!palette.classList.contains('hidden')) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigatePalette(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigatePalette(-1);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                executeSelectedCommand();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                toggleCommandPalette();
            }
        }

        // Shortcuts: G then Key
        // Simple implementation for G-chord would require state, skipping for now to keep simple
    });

    function toggleCommandPalette() {
        const palette = document.getElementById('commandPalette');
        const input = document.getElementById('commandInput');

        if (palette.classList.contains('hidden')) {
            palette.classList.remove('hidden');
            palette.classList.add('flex');
            input.value = '';
            filterCommands();
            setTimeout(() => input.focus(), 50);
        } else {
            palette.classList.add('hidden');
            palette.classList.remove('flex');
        }
    }

    function toggleShortcutsModal() {
        const modal = document.getElementById('shortcutsModal');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } else {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    }

    function filterCommands() {
        const input = document.getElementById('commandInput').value.toLowerCase();
        const resultsDiv = document.getElementById('commandResults');
        resultsDiv.innerHTML = '';

        const filtered = commands.filter(c => c.name.toLowerCase().includes(input));

        if (filtered.length === 0) {
            resultsDiv.innerHTML = '<div class="p-4 text-center text-gray-500">No matching commands</div>';
            return;
        }

        filtered.forEach((cmd, index) => {
            const el = document.createElement('div');
            el.className = `flex items-center p-3 rounded-lg cursor-pointer transition-colors ${index === 0 ? 'bg-blue-600/20 border border-blue-500/50' : 'hover:bg-gray-800'}`;
            el.dataset.index = index;
            el.onclick = () => { cmd.action(); toggleCommandPalette(); };

            const iconClass = cmd.class || 'text-gray-400';

            el.innerHTML = `
                <i class="fas ${cmd.icon} w-6 ${iconClass}"></i>
                <span class="${cmd.class || 'text-gray-200'}">${cmd.name}</span>
                ${index === 0 ? '<i class="fas fa-check text-blue-400 ml-auto text-xs"></i>' : ''}
            `;
            resultsDiv.appendChild(el);
        });

        selectedCommandIndex = 0;
    }

    function navigatePalette(direction) {
        const resultsDiv = document.getElementById('commandResults');
        const items = resultsDiv.children;
        if (!items.length) return;

        // Remove style from current
        if (items[selectedCommandIndex]) {
            items[selectedCommandIndex].className = 'flex items-center p-3 rounded-lg cursor-pointer transition-colors hover:bg-gray-800';
            const check = items[selectedCommandIndex].querySelector('.fa-check');
            if (check) check.remove();
        }

        selectedCommandIndex += direction;

        if (selectedCommandIndex >= items.length) selectedCommandIndex = 0;
        if (selectedCommandIndex < 0) selectedCommandIndex = items.length - 1;

        // Add style to new
        const newSelected = items[selectedCommandIndex];
        newSelected.className = 'flex items-center p-3 rounded-lg cursor-pointer transition-colors bg-blue-600/20 border border-blue-500/50';
        newSelected.innerHTML += '<i class="fas fa-check text-blue-400 ml-auto text-xs"></i>';
        newSelected.scrollIntoView({ block: 'nearest' });
    }

    function executeSelectedCommand() {
        const input = document.getElementById('commandInput').value.toLowerCase();
        const filtered = commands.filter(c => c.name.toLowerCase().includes(input));

        if (filtered[selectedCommandIndex]) {
            filtered[selectedCommandIndex].action();
            toggleCommandPalette();
        }
    }
</script>
{{ super() }}
{% endblock %}