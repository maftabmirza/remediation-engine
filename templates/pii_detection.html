{% extends "base.html" %}
{% set active_page = 'settings' %}
{% set active_section = 'pii-detection' %}
{% set section_label = 'PII Detection' %}

{% block title %}PII & Secret Detection - Settings{% endblock %}

{% block content %}
<style>
    /* Tab Styling matching settings theme */
    .pii-tabs {
        display: flex;
        border-bottom: 1px solid #e2e8f0;
        margin-bottom: 24px;
        gap: 24px;
    }

    .tab-button {
        padding: 12px 4px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #64748b;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-button:hover {
        color: #0f172a;
    }

    .tab-button.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    /* Helper classes for JS compatibility */
    .btn-secondary {
        /* Map to settings-btn-secondary style */
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background: #ffffff;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        color: #475569;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-secondary:hover {
        background: #f8fafc;
        border-color: #94a3b8;
        color: #1e293b;
    }

    .btn-primary {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        transition: all 0.2s ease;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
    }

    .custom-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #3b82f6;
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    /* Ensure tables inside settings-table class behave */
    .settings-table td {
        vertical-align: middle;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-size: 14px;
        color: #1e293b;
    }

    .form-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        margin-bottom: 4px;
    }

    .form-control {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 13px;
        color: #1e293b;
        width: 100%;
    }
</style>

<div class="settings-full-width">
    <!-- Header -->
    <div class="settings-header-bar">
        {% include 'partials/settings_nav_dropdown.html' %}
        <span class="admin-badge"><i data-feather="shield"></i> PII Admin</span>
    </div>

    <!-- Active Section Container -->
    <div class="settings-section active space-y-4" style="display:block; margin-top:12px;">

        <!-- Toolbar -->
        <div class="settings-toolbar">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex flex-col min-w-0">
                    <h1 class="toolbar-title">PII & Secret Detection</h1>
                    <p class="toolbar-subtitle">Configure Presidio and detect-secrets engines</p>
                </div>
                <div class="flex items-center gap-3">
                    <button class="settings-btn-primary" onclick="saveConfiguration()">
                        <i data-feather="save" class="w-4 h-4 mr-2"></i>
                        Save Configuration
                    </button>
                    <!-- Notification Bell (Reused from header if needed, or kept separately) -->
                </div>
            </div>
        </div>

        <div id="alertMessage"></div>

        <!-- Info Card (Simplified) -->
        <div class="settings-light-card p-6 bg-gradient-to-r from-slate-50 to-white">
            <h3 class="font-semibold text-slate-800 mb-4 flex items-center">
                <i data-feather="info" class="w-4 h-4 mr-2 text-blue-500"></i> Detection Engines
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-semibold text-blue-600 mb-1">Presidio (Microsoft)</h4>
                    <p class="text-xs text-slate-500">Standard PII: Email, Phone, SSN, Credit Card, Names, Driver
                        License, IBAN</p>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-amber-500 mb-1">detect-secrets (Yelp)</h4>
                    <p class="text-xs text-slate-500">Secrets: Passwords, API Keys (AWS, GitHub, Slack, Stripe), JWT,
                        Private Keys</p>
                </div>
            </div>
        </div>

        <!-- Global Settings Card -->
        <div class="settings-light-card p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Global Settings</h3>
            <div class="flex flex-wrap gap-6 mb-6">
                <label class="checkbox-label">
                    <input type="checkbox" id="enablePresidio" checked>
                    Enable PII Detection (Presidio)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="enableSecrets" checked>
                    Enable Secret Detection (detect-secrets)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoRedact" checked>
                    Auto-redact in outputs
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="logDetections" checked>
                    Log all detections
                </label>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl">
                <div class="form-group">
                    <label for="defaultRedaction">Default Redaction:</label>
                    <select id="defaultRedaction" class="form-control">
                        <option value="mask">Mask</option>
                        <option value="hash">Hash</option>
                        <option value="remove">Remove</option>
                        <option value="tag">Tag</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="maskChar">Mask Character:</label>
                    <input type="text" id="maskChar" value="*" maxlength="1" class="form-control" style="width: 60px;">
                </div>
            </div>
        </div>

        <!-- Configuration Tabs -->
        <div class="settings-light-card">
            <!-- Tab Headers -->
            <div class="px-6 pt-2">
                <div class="pii-tabs">
                    <button class="tab-button active" data-tab="presidio" onclick="switchTab('presidio', this)">
                        <i data-feather="shield" class="w-4 h-4"></i> Presidio (PII)
                    </button>
                    <button class="tab-button" data-tab="secrets" onclick="switchTab('secrets', this)">
                        <i data-feather="key" class="w-4 h-4"></i> detect-secrets
                    </button>
                    <button class="tab-button" data-tab="exceptions" onclick="switchTab('exceptions', this)">
                        <i data-feather="list" class="w-4 h-4"></i> Exceptions
                    </button>
                    <button class="tab-button" data-tab="test" onclick="switchTab('test', this)">
                        <i data-feather="activity" class="w-4 h-4"></i> Test Detection
                    </button>
                </div>
            </div>

            <!-- Presidio Tab -->
            <div id="presidio-tab" class="tab-content active p-6 pt-0">
                <table class="settings-table w-full">
                    <thead>
                        <tr>
                            <th class="p-4 text-left">Entity Type</th>
                            <th class="p-4 text-left">Enabled</th>
                            <th class="p-4 text-left">Threshold</th>
                            <th class="p-4 text-left">Redaction</th>
                            <th class="p-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="presidioEntitiesTable">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Secrets Tab -->
            <div id="secrets-tab" class="tab-content p-6 pt-0">
                <table class="settings-table w-full">
                    <thead>
                        <tr>
                            <th class="p-4 text-left">Plugin</th>
                            <th class="p-4 text-left">Enabled</th>
                            <th class="p-4 text-left">Description</th>
                            <th class="p-4 text-left">Status</th>
                        </tr>
                    </thead>
                    <tbody id="pluginsTable">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Exceptions Tab -->
            <div id="exceptions-tab" class="tab-content p-6 pt-0">
                <div class="bg-slate-50 border border-slate-200 rounded-lg p-5 mb-6">
                    <h3 class="font-semibold text-slate-800 mb-2">Add Exception</h3>
                    <p class="text-xs text-slate-500 mb-4">Add known safe values to the whitelist.</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="form-group">
                            <label for="exceptionText">Detected Text</label>
                            <input type="text" id="exceptionText" class="form-control"
                                placeholder="e.g. test@example.com">
                        </div>
                        <div class="form-group">
                            <label for="exceptionEntityType">Entity Type</label>
                            <input type="text" id="exceptionEntityType" class="form-control" list="exceptionEntityList"
                                placeholder="EMAIL_ADDRESS">
                            <datalist id="exceptionEntityList"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="exceptionEngine">Engine</label>
                            <select id="exceptionEngine" class="form-control">
                                <option value="presidio">presidio</option>
                                <option value="detect_secrets">detect_secrets</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group mb-4">
                        <label for="exceptionComment">Comment</label>
                        <input type="text" id="exceptionComment" class="form-control"
                            placeholder="Reason for exclusion">
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="checkbox-label">
                            <input type="checkbox" id="showInactiveWhitelist" onchange="loadWhitelist()">
                            Show inactive entries
                        </label>
                        <button class="settings-btn-primary" onclick="addWhitelistEntry()">Add Exception</button>
                    </div>
                </div>

                <table class="settings-table w-full">
                    <thead>
                        <tr>
                            <th class="p-4 text-left">Detected Text</th>
                            <th class="p-4 text-left">Entity Type</th>
                            <th class="p-4 text-left">Scope</th>
                            <th class="p-4 text-left">Added</th>
                            <th class="p-4 text-left">Reporter</th>
                            <th class="p-4 text-left">Session</th>
                            <th class="p-4 text-left">Status</th>
                            <th class="p-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="whitelistTable">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Test Tab -->
            <div id="test-tab" class="tab-content p-6 pt-0">
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Test Text</label>
                        <textarea id="testInput" class="form-control" style="min-height: 120px; font-family: monospace;"
                            placeholder="Enter text to test detection...&#10;&#10;Example:&#10;My email is test@example.com&#10;password = &quot;SecretPass@123&quot;"></textarea>
                    </div>
                    <div>
                        <button class="settings-btn-primary" onclick="runTest()">
                            <i data-feather="search" class="w-4 h-4 mr-2"></i> Run Detection
                            <span id="testLoading"
                                class="loading inline-block w-4 h-4 ml-2 border-2 border-white border-t-transparent rounded-full animate-spin"
                                style="display: none;"></span>
                        </button>
                    </div>

                    <div id="testResults" style="display: none;" class="border-t border-slate-200 pt-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-3">Detection Results</h4>
                                <div id="detectionsResults"
                                    class="bg-slate-50 border border-slate-200 rounded p-4 max-h-64 overflow-y-auto">
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800 mb-3">Redacted Preview</h4>
                                <div id="redactedPreview"
                                    class="bg-slate-900 text-slate-50 rounded p-4 font-mono text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block head %}
<!-- Load PII Logic -->
<script src="/static/js/pii_detection.js"></script>
<script>
    // Local implementation of dropdown toggle since we are on a separate page
    function toggleSettingsDropdown(e) {
        e.stopPropagation();
        const dropdown = document.getElementById('settingsDropdownMenu');
        const btn = document.getElementById('settingsDropdownBtn');
        dropdown.classList.toggle('open');
        btn.classList.toggle('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        const dropdown = document.getElementById('settingsDropdownMenu');
        const btn = document.getElementById('settingsDropdownBtn');
        if (dropdown && dropdown.classList.contains('open')) {
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('open');
                btn.classList.remove('open');
            }
        }
    });
</script>
{% endblock %}