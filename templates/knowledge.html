{% extends "base.html" %}
{% set active_page = 'knowledge' %}

{% block title %}Knowledge Base - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Knowledge Base</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-book-open text-teal-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Knowledge Base</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="space-y-4">

    <!-- Page Action Buttons -->
    <div class="flex justify-end items-center gap-2 px-1">
        <button onclick="showAppModal()"
            class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 text-sm rounded flex items-center gap-2 transition-colors">
            <i class="fas fa-layer-group"></i>
            Manage Apps
        </button>
        <button onclick="showGitSyncModal()"
            class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 text-sm rounded flex items-center gap-2 transition-colors">
            <i class="fab fa-git-alt"></i>
            Sync Git Repo
        </button>
        <button onclick="showUploadModal()"
            class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 text-sm rounded flex items-center gap-2 transition-colors">
            <i class="fas fa-plus"></i>
            Add Document
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Total Documents</p>
                    <p id="totalDocs" class="text-xl font-bold text-slate-900">-</p>
                </div>
                <i class="fas fa-file-alt text-2xl text-blue-400"></i>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Generated Chunks</p>
                    <p id="totalChunks" class="text-xl font-bold text-slate-900">-</p>
                </div>
                <i class="fas fa-puzzle-piece text-2xl text-green-400"></i>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Embedding Model</p>
                    <p id="embeddingModel" class="text-lg font-bold text-slate-900 truncate max-w-[150px]">-</p>
                </div>
                <i class="fas fa-brain text-2xl text-purple-400"></i>
            </div>
        </div>
        <div class="card p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-xs text-slate-500 font-medium uppercase tracking-wider">Status</p>
                    <p id="embeddingStatus" class="text-lg font-bold">-</p>
                </div>
                <i class="fas fa-check-circle text-2xl text-teal-400"></i>
            </div>
        </div>
    </div>

    <!-- Toolbar & Search -->
    <div class="card p-4 flex gap-4 items-center flex-wrap">
        <div class="flex-1 relative">
            <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
            <input type="text" id="searchQuery"
                class="input-field pl-10 pr-4 py-2 rounded w-full border border-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                placeholder="Search documents, code, or runbooks..."
                onkeypress="if(event.key === 'Enter') searchKnowledge()">
        </div>

        <select id="filterApp" class="input-field px-3 py-2 rounded border border-slate-200 bg-white"
            onchange="loadDocuments()">
            <option value="">All Applications</option>
            <!-- Populated by JS -->
        </select>

        <select id="filterDocType" class="input-field px-3 py-2 rounded border border-slate-200 bg-white"
            onchange="loadDocuments()">
            <option value="">All Types</option>
            <option value="sop">SOP</option>
            <option value="architecture">Architecture</option>
            <option value="code">Code</option>
        </select>

        <button onclick="loadDocuments()"
            class="btn-secondary px-3 py-2 rounded border border-slate-200 hover:bg-slate-50 text-slate-600">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <!-- Search Results View -->
    <div id="searchResults" class="hidden space-y-4">
        <!-- JS populated -->
    </div>

    <!-- Main Content: Document Table -->
    <div id="mainContent" class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50 text-slate-500 text-xs uppercase border-b border-slate-200">
                        <th class="px-6 py-3 font-medium">Type</th>
                        <th class="px-6 py-3 font-medium">Title</th>
                        <th class="px-6 py-3 font-medium">Application</th>
                        <th class="px-6 py-3 font-medium">Stats</th>
                        <th class="px-6 py-3 font-medium">Source</th>
                        <th class="px-6 py-3 font-medium text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="documentsTableBody" class="divide-y divide-slate-200">
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-slate-500">
                            <i class="fas fa-circle-notch fa-spin mr-2"></i> Loading documents...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4 shadow-2xl border border-gray-700">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">
                Add Knowledge
            </h3>
            <button onclick="closeUploadModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="uploadForm" onsubmit="uploadDocument(event)" class="space-y-5">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                <input type="text" name="title" required
                    class="input-field w-full px-4 py-2 rounded border border-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                    placeholder="e.g., Payment Service Architecture">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Type *</label>
                    <select name="doc_type" required
                        class="input-field w-full px-4 py-2 rounded border border-slate-200 focus:border-blue-500">
                        <option value="">Select type...</option>
                        <option value="sop">SOP</option>
                        <option value="architecture">Architecture</option>
                        <option value="code">Code</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Application</label>
                    <select name="app_id" id="uploadAppSelect"
                        class="input-field w-full px-4 py-2 rounded border border-slate-200 focus:border-blue-500">
                        <option value="">(None)</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <!-- File Upload Option -->
            <div
                class="border border-dashed border-slate-300 rounded-lg p-6 bg-slate-50 text-center hover:bg-slate-100 transition-colors cursor-pointer relative">
                <input type="file" id="fileUpload" accept=".md,.txt,.markdown,.pdf,.jpg,.jpeg,.png,.gif"
                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileUpload(event)">
                <div class="pointer-events-none">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-2"></i>
                    <p class="text-sm font-medium text-blue-600">Click to upload file</p>
                    <p class="text-xs text-slate-500 mt-1">Markdown, PDF, Images</p>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
                <textarea name="content" id="docContent" rows="8"
                    class="input-field w-full px-4 py-2 rounded font-mono text-sm border border-slate-200 focus:border-blue-500"
                    placeholder="# Markdown Content..."></textarea>
            </div>

            <input type="hidden" name="format" value="markdown">

            <div class="flex justify-end space-x-3 pt-4 border-t border-slate-100">
                <button type="button" onclick="closeUploadModal()"
                    class="px-4 py-2 rounded hover:bg-slate-100 text-slate-600 transition-colors">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-6 py-2 rounded shadow-lg shadow-blue-500/20">
                    <i class="fas fa-save mr-2"></i> Save Document
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Git Sync Modal -->
<div id="gitSyncModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-lg m-4 shadow-2xl border border-slate-200 bg-white">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                <i class="fab fa-git-alt text-orange-500"></i> Sync Git Repository
            </h3>
            <button onclick="closeGitSyncModal()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="gitSyncForm" onsubmit="syncGitRepo(event)" class="space-y-4">
            <div>
                <label class="block text-sm text-slate-500 mb-1">Repository URL *</label>
                <input type="url" name="repo_url" required
                    class="input-field w-full px-3 py-2 rounded border border-slate-200"
                    placeholder="https://github.com/username/repo">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Application</label>
                    <select name="app_id" id="syncAppSelect"
                        class="input-field w-full px-3 py-2 rounded border border-slate-200">
                        <option value="">(Create New / None)</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-500 mb-1">Branch</label>
                    <input type="text" name="branch" value="main"
                        class="input-field w-full px-3 py-2 rounded border border-slate-200" placeholder="main">
                </div>
            </div>

            <div class="p-4 bg-slate-50 rounded border border-slate-200">
                <p class="text-sm font-semibold mb-2 text-slate-700">Sync Options</p>
                <div class="space-y-3">
                    <label
                        class="flex items-center gap-3 text-sm text-slate-600 cursor-pointer hover:bg-slate-100 p-2 rounded transition-colors">
                        <input type="checkbox" name="sync_docs" checked
                            class="w-4 h-4 rounded bg-white border-slate-300 text-blue-500 focus:ring-blue-500">
                        <span>Sync Documentation <span class="text-xs text-slate-400">(.md, .txt)</span></span>
                    </label>
                    <label
                        class="flex items-center gap-3 text-sm text-slate-600 cursor-pointer hover:bg-slate-100 p-2 rounded transition-colors">
                        <input type="checkbox" name="sync_code"
                            class="w-4 h-4 rounded bg-white border-slate-300 text-blue-500 focus:ring-blue-500">
                        <span>Sync Code <span
                                class="text-xs bg-orange-100 text-orange-600 px-1.5 py-0.5 rounded ml-2">Experimental</span></span>
                    </label>
                </div>
            </div>

            <div class="flex justify-end space-x-2 pt-4">
                <button type="button" onclick="closeGitSyncModal()"
                    class="btn-secondary px-4 py-2 rounded bg-white border border-slate-200 text-slate-600 hover:bg-slate-50">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded">
                    <i class="fas fa-sync-alt mr-2"></i> Start Sync
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Document Modal -->
<div id="viewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div
        class="card bg-white p-6 w-full max-w-5xl h-[90vh] overflow-hidden flex flex-col m-4 shadow-2xl border border-slate-200 rounded-xl">
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <div>
                <h3 id="viewTitle"
                    class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-green-600">
                    Loading...</h3>
                <div id="viewMeta" class="flex gap-2 mt-1 text-xs text-slate-500"></div>
            </div>
            <button onclick="closeViewModal()" class="text-slate-400 hover:text-slate-600 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="viewContent" class="prose prose-invert max-w-none p-2"></div>
        </div>
    </div>
</div>

<!-- Application Management Modal -->
<div id="appModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-3xl m-4 shadow-2xl border border-slate-200 h-[80vh] flex flex-col bg-white">
        <div class="flex items-center justify-between mb-6 flex-shrink-0">
            <h3 class="text-xl font-bold text-slate-900">Manage Applications</h3>
            <button onclick="closeAppModal()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden">
            <!-- App List -->
            <div class="md:col-span-1 border-r border-slate-200 pr-4 overflow-y-auto custom-scrollbar">
                <button onclick="resetAppForm()"
                    class="w-full text-left p-3 rounded mb-2 border border-dashed border-slate-300 text-blue-600 hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Application
                </button>
                <div id="appList" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- App Form -->
            <div class="md:col-span-2 pl-2 overflow-y-auto">
                <form id="appForm" onsubmit="saveApplication(event)" class="space-y-4">
                    <input type="hidden" name="id" id="appId">

                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Application Name *</label>
                        <input type="text" name="name" id="appName" required
                            class="input-field w-full px-3 py-2 rounded border border-slate-200 focus:border-blue-500"
                            placeholder="service-name">
                        <p class="text-xs text-slate-400 mt-1">Unique identifier (slug)</p>
                    </div>

                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Display Name</label>
                        <input type="text" name="display_name" id="appDisplayName"
                            class="input-field w-full px-3 py-2 rounded border border-slate-200 focus:border-blue-500"
                            placeholder="Friendly Name">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-500 mb-1">Criticality</label>
                            <select name="criticality" id="appCriticality"
                                class="input-field w-full px-3 py-2 rounded border border-slate-200 focus:border-blue-500">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-500 mb-1">Team Owner</label>
                            <input type="text" name="team_owner" id="appTeam"
                                class="input-field w-full px-3 py-2 rounded border border-slate-200 focus:border-blue-500"
                                placeholder="Platform Team">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-slate-500 mb-1">Description</label>
                        <textarea name="description" id="appDescription" rows="3"
                            class="input-field w-full px-3 py-2 rounded border border-slate-200 focus:border-blue-500"></textarea>
                    </div>

                    <div class="pt-4 flex justify-between items-center border-t border-slate-200">
                        <button type="button" id="deleteAppBtn" onclick="deleteApplication()"
                            class="text-red-500 hover:text-red-600 text-sm hidden">
                            <i class="fas fa-trash mr-1"></i> Delete Application
                        </button>
                        <button type="submit" class="btn-primary px-6 py-2 rounded">
                            <i class="fas fa-save mr-2"></i> Save Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // State
    let allDocuments = [];
    let applications = [];

    // Icons map
    const typeIcons = {
        'architecture': 'fa-sitemap text-purple-400',
        'api_spec': 'fa-server text-blue-400',
        'runbook': 'fa-book-medical text-green-400',
        'sop': 'fa-list-check text-teal-400',
        'troubleshooting': 'fa-wrench text-orange-400',
        'code': 'fa-code text-pink-400',
        'deployment': 'fa-rocket text-indigo-400',
        'config': 'fa-cogs text-gray-400',
        'default': 'fa-file-alt text-gray-400'
    };

    // --- Data Loading ---

    async function initialize() {
        await Promise.all([
            loadStats(),
            loadApplications(),
            loadDocuments()
        ]);
        populateAppSelects();
    }

    async function loadStats() {
        try {
            const response = await apiCall('/api/knowledge/stats');
            if (!response) return;
            const stats = await response.json();

            document.getElementById('totalDocs').textContent = stats.total_documents;
            document.getElementById('totalChunks').textContent = stats.total_chunks;

            // Format model name
            const model = stats.embedding_model || 'Unknown';
            document.getElementById('embeddingModel').textContent = model.replace('text-embedding-', '').replace('openai/', '');
            document.getElementById('embeddingModel').title = model;

            const isConfigured = stats.embedding_configured;
            const statusEl = document.getElementById('embeddingStatus');
            statusEl.textContent = isConfigured ? 'Active' : 'Missing Key';
            statusEl.className = isConfigured ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-red-400';

        } catch (e) {
            console.error(e);
        }
    }

    async function loadApplications() {
        try {
            const response = await apiCall('/api/applications?page_size=100');
            if (!response) return;
            const data = await response.json();
            applications = data.items;
            renderAppList();
        } catch (e) {
            console.error("Failed to load apps", e);
        }
    }

    function populateAppSelects() {
        const selects = ['filterApp', 'uploadAppSelect', 'syncAppSelect'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;

            const currentVal = select.value;
            // Clear existing options except first
            while (select.options.length > 1) select.remove(1);

            applications.forEach(app => {
                const opt = document.createElement('option');
                opt.value = app.id;
                opt.textContent = app.display_name || app.name;
                select.appendChild(opt);
            });

            if (currentVal) select.value = currentVal;
        });
    }

    async function loadDocuments() {
        const appFilter = document.getElementById('filterApp').value;
        const typeFilter = document.getElementById('filterDocType').value;

        let url = `/api/knowledge/documents?limit=100`;
        if (appFilter) url += `&app_id=${appFilter}`;
        if (typeFilter) url += `&doc_type=${typeFilter}`;

        const tbody = document.getElementById('documentsTableBody');
        tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center"><div class="loading-spinner mx-auto mb-2"></div>Looking for knowledge...</td></tr>';

        try {
            const response = await apiCall(url);
            if (!response) return;
            const data = await response.json();
            allDocuments = data.items;
            renderDocumentsTable(allDocuments);
        } catch (e) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-400">Failed to load documents</td></tr>';
        }
    }

    function renderDocumentsTable(docs) {
        const tbody = document.getElementById('documentsTableBody');

        if (!docs || docs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-wind text-4xl mb-3 opacity-50"></i>
                        <p>No documents found matching filters.</p>
                    </td>
                </tr>`;
            return;
        }

        // Group by Application if no app filter is selected
        const appGroups = {};
        docs.forEach(doc => {
            const appName = doc.app_name || 'General / Uncategorized';
            if (!appGroups[appName]) appGroups[appName] = [];
            appGroups[appName].push(doc);
        });

        let html = '';

        // Sort groups: General last, others alphabetical
        const groupNames = Object.keys(appGroups).sort((a, b) => {
            if (a === 'General / Uncategorized') return 1;
            if (b === 'General / Uncategorized') return -1;
            return a.localeCompare(b);
        });

        for (const group of groupNames) {
            const groupDocs = appGroups[group];
            // Group Header
            html += `
                <tr class="bg-slate-50">
                    <td colspan="6" class="px-6 py-2 font-semibold text-xs uppercase text-slate-500 tracking-wider border-b border-t border-slate-200">
                        <i class="fas fa-layer-group mr-2 opacity-50"></i> ${group}
                    </td>
                </tr>
            `;

            for (const doc of groupDocs) {
                const iconClass = typeIcons[doc.doc_type] || typeIcons['default'];
                const chunkCount = doc.chunk_count || 0;

                html += `
                <tr class="hover:bg-slate-50 transition-colors group border-b border-slate-100 last:border-0">
                    <td class="px-6 py-3 whitespace-nowrap">
                        <div class="flex items-center" title="${doc.doc_type}">
                            <div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center mr-3 border border-slate-200">
                                <i class="fas ${iconClass}"></i>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-3">
                        <div class="font-medium text-slate-900 group-hover:text-blue-600 transition-colors cursor-pointer" onclick="viewDocument('${doc.id}')">
                            ${doc.title}
                        </div>
                        <div class="text-xs text-slate-500 truncate max-w-[200px]" title="${doc.description || ''}">
                            ${doc.description || doc.slug}
                        </div>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap">
                         ${doc.app_name ?
                        `<span class="px-2 py-0.5 rounded text-xs bg-slate-100 text-slate-600 border border-slate-200">${doc.app_name}</span>` :
                        `<span class="text-slate-400 text-xs">-</span>`}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap">
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 border border-slate-200" title="Chunks generated">
                            <i class="fas fa-puzzle-piece text-green-500 mr-1"></i> ${chunkCount}
                        </span>
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-xs text-slate-500">
                         ${doc.source_type === 'git' ? '<i class="fab fa-git-alt mr-1"></i> Git' : '<i class="fas fa-user-edit mr-1"></i> Manual'}
                    </td>
                    <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="viewDocument('${doc.id}')" class="text-slate-400 hover:text-blue-600" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteDocument('${doc.id}')" class="text-slate-400 hover:text-red-500" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }
        }

        tbody.innerHTML = html;
    }

    // --- Search ---

    async function searchKnowledge() {
        const query = document.getElementById('searchQuery').value.trim();
        const resultsDiv = document.getElementById('searchResults');
        const mainContent = document.getElementById('mainContent');

        if (!query) {
            resultsDiv.classList.add('hidden');
            mainContent.classList.remove('hidden');
            return;
        }

        mainContent.classList.add('hidden');
        resultsDiv.classList.remove('hidden');
        resultsDiv.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto mb-2"></div>Searching...</div>';

        try {
            const response = await apiCall('/api/knowledge/search', {
                method: 'POST',
                body: JSON.stringify({ query: query, limit: 15 })
            });
            const data = await response.json();

            if (!data.results || data.results.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="card p-8 text-center text-gray-400">
                        <i class="fas fa-search text-3xl mb-3 opacity-50"></i>
                        <p>No results found for "${query}"</p>
                        <button onclick="document.getElementById('searchQuery').value=''; searchKnowledge()" class="text-blue-400 mt-2 hover:underline">Clear Search</button>
                    </div>`;
                return;
            }

            resultsDiv.innerHTML = `
                <div class="flex justify-between items-center px-2">
                    <p class="text-sm text-gray-400">Found ${data.total_found} matched chunks in ${data.processing_time_ms}ms</p>
                    <button onclick="document.getElementById('searchQuery').value=''; searchKnowledge()" class="text-xs text-gray-500 hover:text-white">Clear</button>
                </div>
                <div class="grid gap-3">
                    ${data.results.map(r => `
                        <div class="card p-4 hover:border-blue-400 transition-colors border border-slate-200 cursor-pointer group bg-white" onclick="viewDocument('${r.source_id}')">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-blue-600 group-hover:text-blue-700">
                                        <i class="fas ${typeIcons[r.doc_type] || 'fa-file'} mr-2 text-sm"></i>
                                        ${r.source_title}
                                    </h4>
                                    <p class="text-xs text-slate-500 mt-0.5">Matched from ${r.source_type} • Score: ${Math.round(r.similarity * 100)}%</p>
                                </div>
                                <span class="badge-primary px-2 py-0.5 rounded text-xs">${r.doc_type || 'doc'}</span>
                            </div>
                            <div class="text-sm text-slate-600 bg-slate-50 p-2 rounded border border-slate-200 font-mono text-xs">
                                ...${r.content}...
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

        } catch (e) {
            resultsDiv.innerHTML = '<div class="card p-4 text-red-400">Search failed</div>';
        }
    }

    // --- Document Actions ---

    async function viewDocument(id) {
        const modal = document.getElementById('viewModal');
        const titleEl = document.getElementById('viewTitle');
        const contentEl = document.getElementById('viewContent');
        const metaEl = document.getElementById('viewMeta');

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        titleEl.textContent = 'Loading...';
        contentEl.innerHTML = '<div class="loading-spinner mx-auto my-12"></div>';

        try {
            const response = await apiCall(`/api/knowledge/documents/${id}`);
            const doc = await response.json();

            titleEl.textContent = doc.title;
            metaEl.innerHTML = `
                <span class="bg-gray-700 px-2 rounded">${doc.doc_type}</span>
                <span>• v${doc.version}</span>
                <span>• ${new Date(doc.updated_at).toLocaleString()}</span>
                ${doc.app_name ? `<span>• App: ${doc.app_name}</span>` : ''}
            `;

            // Render Markdown
            contentEl.innerHTML = marked.parse(doc.raw_content || '*No content*');

            // Highlight code blocks (basic)
            contentEl.querySelectorAll('pre code').forEach((block) => {
                block.className = "bg-gray-800 p-2 rounded block overflow-x-auto text-sm";
            });

        } catch (e) {
            titleEl.textContent = 'Error';
            contentEl.textContent = 'Failed to load document content.';
        }
    }

    // --- Application Management ---

    function showAppModal() {
        document.getElementById('appModal').classList.remove('hidden');
        document.getElementById('appModal').classList.add('flex');
        renderAppList();
        resetAppForm();
    }

    function closeAppModal() {
        document.getElementById('appModal').classList.add('hidden');
        document.getElementById('appModal').classList.remove('flex');
        loadApplications(); // Refresh main view stats/filters
        populateAppSelects();
    }

    function renderAppList() {
        const list = document.getElementById('appList');
        list.innerHTML = applications.map(app => `
            <div onclick="selectApp('${app.id}')" 
                 class="p-3 bg-white border border-slate-200 rounded cursor-pointer hover:bg-slate-50 hover:border-blue-300 transition-all">
                <div class="flex justify-between items-center">
                    <span class="font-medium text-sm text-slate-800">${app.display_name || app.name}</span>
                    <span class="text-xs ${app.criticality === 'critical' ? 'text-red-500' : 'text-slate-500'}">
                        ${app.criticality || 'low'}
                    </span>
                </div>
                <div class="text-xs text-slate-500 truncate">${app.name}</div>
            </div>
        `).join('');
    }

    function selectApp(id) {
        const app = applications.find(a => a.id === id);
        if (!app) return;

        document.getElementById('appId').value = app.id;
        document.getElementById('appName').value = app.name;
        document.getElementById('appDisplayName').value = app.display_name || '';
        document.getElementById('appCriticality').value = app.criticality || 'low';
        document.getElementById('appTeam').value = app.team_owner || '';
        document.getElementById('appDescription').value = app.description || '';

        document.getElementById('deleteAppBtn').classList.remove('hidden');
    }

    function resetAppForm() {
        document.getElementById('appForm').reset();
        document.getElementById('appId').value = '';
        document.getElementById('deleteAppBtn').classList.add('hidden');
    }

    async function saveApplication(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        const id = data.id;
        delete data.id; // Don't send ID in body for create/update consistency check

        const method = id ? 'PUT' : 'POST';
        const url = id ? `/api/applications/${id}` : '/api/applications';

        try {
            const response = await apiCall(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(`Application ${id ? 'updated' : 'created'}`, 'success');
                // Reload apps
                const appsRes = await apiCall('/api/applications?page_size=100');
                const appsData = await appsRes.json();
                applications = appsData.items;
                renderAppList();
                if (!id) resetAppForm();
            } else {
                throw new Error('Save failed');
            }
        } catch (error) {
            showToast('Failed to save application', 'error');
        }
    }

    async function deleteApplication() {
        const id = document.getElementById('appId').value;
        if (!id || !confirm('Delete this application? ALL associated documents will be unlinked or deleted.')) return;

        try {
            const response = await apiCall(`/api/applications/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('Application deleted', 'success');
                loadApplications(); // Reloads all
                resetAppForm();
            }
        } catch (e) {
            showToast('Delete failed', 'error');
        }
    }

    // --- Modals ---

    function showUploadModal() {
        document.getElementById('uploadModal').classList.remove('hidden');
        document.getElementById('uploadModal').classList.add('flex');
    }
    function closeUploadModal() {
        document.getElementById('uploadModal').classList.add('hidden');
        document.getElementById('uploadModal').classList.remove('flex');
        document.getElementById('uploadForm').reset();
    }
    function showGitSyncModal() {
        document.getElementById('gitSyncModal').classList.remove('hidden');
        document.getElementById('gitSyncModal').classList.add('flex');
    }
    function closeGitSyncModal() {
        document.getElementById('gitSyncModal').classList.add('hidden');
        document.getElementById('gitSyncModal').classList.remove('flex');
    }
    function closeViewModal() {
        document.getElementById('viewModal').classList.add('hidden');
        document.getElementById('viewModal').classList.remove('flex');
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Auto fill title and type
        const name = file.name;
        document.querySelector('input[name="title"]').value = name.split('.')[0];

        const ext = name.split('.').pop().toLowerCase();
        if (['py', 'js', 'go', 'java'].includes(ext)) {
            document.querySelector('select[name="doc_type"]').value = 'code';
        } else if (ext === 'md') {
            document.querySelector('select[name="doc_type"]').value = 'runbook'; // guess
        }

        // Read content if text
        if (['md', 'txt', 'py', 'js', 'json', 'yaml', 'yml'].includes(ext)) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('docContent').value = e.target.result;
            reader.readAsText(file);
        }
    }

    async function uploadDocument(e) {
        e.preventDefault();
        const formData = new FormData(e.target);

        // Handle file
        const fileInput = document.getElementById('fileUpload');
        if (fileInput.files[0]) {
            formData.set('file', fileInput.files[0]);
        }

        try {
            const res = await apiCall('/api/knowledge/documents', {
                method: 'POST',
                body: formData, // Auto Content-Type for FormData
                isFormData: true
            });
            if (res.ok) {
                showToast('Document uploaded', 'success');
                closeUploadModal();
                initialize();
            } else {
                throw new Error('Upload failed');
            }
        } catch (err) {
            showToast(err.message, 'error');
        }
    }

    async function deleteDocument(id) {
        if (!confirm('Delete document?')) return;
        await apiCall(`/api/knowledge/documents/${id}`, { method: 'DELETE' });
        loadDocuments();
        loadStats();
    }

    // Git Sync
    async function syncGitRepo(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        data.sync_docs = data.sync_docs === 'on';
        data.sync_code = data.sync_code === 'on';

        const btn = e.target.querySelector('button[type="submit"]');
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
        btn.disabled = true;

        try {
            const res = await apiCall('/api/knowledge/sync/git', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const json = await res.json();
            showToast(`Synced ${json.stats.docs_synced} docs, ${json.stats.code_synced} code`, 'success');
            closeGitSyncModal();
            initialize();
        } catch (err) {
            showToast('Sync failed: ' + err.message, 'error');
        } finally {
            btn.innerHTML = oldHtml;
            btn.disabled = false;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', initialize);

</script>
{% endblock %}