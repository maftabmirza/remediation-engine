{% extends "base.html" %}
{% set active_page = 'playlists' %}

{% block title %}Playlists - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Playlists</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-play-circle text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Dashboard Playlists</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<style>
    .pl-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        white-space: nowrap;
    }
    .pl-action-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }
    .pl-action-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
        transform: translateY(-1px);
    }
    .pl-search-input {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 14px 8px 36px;
        font-size: 13px;
        color: #1e293b;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
    }
    .pl-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }
    .pl-search-wrapper .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 13px;
    }
    .dashboard-item {
        cursor: grab;
        transition: background-color 0.2s, border-color 0.2s;
    }
    .dashboard-item:hover {
        background-color: rgba(59, 130, 246, 0.08);
        border-color: #cbd5e1;
    }
    .dashboard-item.dragging {
        opacity: 0.5;
    }
    .badge { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .badge-loop { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .badge-once { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
    .pl-modal-overlay { z-index: 2000; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar -->
    <div class="card p-4" style="overflow: visible; position: relative; z-index: 200;">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="flex flex-wrap gap-3 items-center flex-1">
                <div class="pl-search-wrapper flex-1 min-w-[200px]">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search-playlists" placeholder="Search playlists..."
                        onkeyup="filterPlaylists()" class="pl-search-input w-full">
                </div>
            </div>
            <div class="flex items-center gap-2" style="position: relative; z-index: 210;">
                <button onclick="showCreatePlaylistModal()" class="pl-action-btn pl-action-primary">
                    <i class="fas fa-plus"></i>
                    <span>New Playlist</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4" style="border-left: 3px solid #3b82f6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas fa-play-circle" style="color: #2563eb; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Total Playlists</p>
                    <p class="text-2xl font-bold text-primary" id="statTotal" style="line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #10b981;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #ecfdf5, #d1fae5);">
                    <i class="fas fa-sync-alt" style="color: #059669; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Looping</p>
                    <p class="text-2xl font-bold" id="statLooping" style="color: #059669; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #8b5cf6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #f5f3ff, #ede9fe);">
                    <i class="fas fa-th-large" style="color: #7c3aed; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Total Dashboards</p>
                    <p class="text-2xl font-bold" id="statDashboards" style="color: #7c3aed; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #f59e0b;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #fffbeb, #fef3c7);">
                    <i class="fas fa-clock" style="color: #d97706; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs" style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Avg Interval</p>
                    <p class="text-2xl font-bold" id="statInterval" style="color: #d97706; line-height: 1.2;">0s</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Playlists Table -->
    <div class="card overflow-hidden" id="tableContainer">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-4 py-3 font-medium w-10"></th>
                    <th class="px-4 py-3 font-medium">Name</th>
                    <th class="px-4 py-3 font-medium">Mode</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Interval</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Dashboards</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Created</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="playlists-tbody" class="text-[#334155]">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="flex items-center justify-between mt-4 text-sm hidden">
        <div class="text-[#64748b]">
            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            playlists
        </div>
        <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="first-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-left"></i>
            </button>
            <span class="px-3 py-1.5 text-[#475569]">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
            <button onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-right"></i>
            </button>
            <button onclick="goToPage(totalPages)" id="last-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <select id="page-size" onchange="changePageSize(this.value)"
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] focus:outline-none focus:border-[#3b82f6]">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
            </select>
        </div>
    </div>

    <!-- Empty State -->
    <div id="no-playlists" class="hidden card p-12 text-center">
        <i class="fas fa-play-circle text-4xl text-secondary mb-4"></i>
        <h3 class="text-lg font-medium text-primary mb-2">No Playlists Found</h3>
        <p class="text-secondary mb-4">Create your first playlist to auto-rotate dashboards for TV mode.</p>
        <button onclick="showCreatePlaylistModal()" class="btn-primary px-4 py-2 rounded-lg">
            <i class="fas fa-plus mr-2"></i>New Playlist
        </button>
    </div>
</div>

<!-- Create/Edit Playlist Modal -->
<div id="playlist-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden pl-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 id="playlist-modal-title" class="text-xl font-bold text-primary">New Playlist</h2>
            <button onclick="closePlaylistModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="playlist-form" onsubmit="savePlaylist(event)">
            <input type="hidden" id="playlist-id" value="">

            <div class="mb-4">
                <label class="block text-secondary text-sm mb-1">Name *</label>
                <input type="text" id="playlist-name" required
                    class="input-field w-full px-3 py-2 rounded text-sm">
            </div>

            <div class="mb-4">
                <label class="block text-secondary text-sm mb-1">Description</label>
                <textarea id="playlist-description" rows="3"
                    class="input-field w-full px-3 py-2 rounded text-sm resize-none"></textarea>
            </div>

            <div class="mb-4">
                <label class="block text-secondary text-sm mb-1">Interval (seconds)</label>
                <input type="number" id="playlist-interval" value="30" min="5" max="3600"
                    class="input-field w-full px-3 py-2 rounded text-sm">
                <p class="text-secondary text-xs mt-1">Time each dashboard is displayed</p>
            </div>

            <div class="mb-4">
                <label class="flex items-center text-secondary text-sm cursor-pointer">
                    <input type="checkbox" id="playlist-loop" checked class="mr-2 h-4 w-4">
                    Loop continuously
                </label>
                <p class="text-secondary text-xs mt-1">If unchecked, playlist stops after one cycle</p>
            </div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="closePlaylistModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Manage Playlist Items Modal -->
<div id="items-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden pl-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-primary">Manage Dashboards</h2>
            <button onclick="closeItemsModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-6">
            <div>
                <h3 class="text-sm font-semibold text-primary mb-3">Available Dashboards</h3>
                <input type="text" id="search-available" placeholder="Search dashboards..." onkeyup="filterAvailableDashboards()"
                    class="input-field w-full px-3 py-2 rounded text-sm mb-3">
                <div id="available-dashboards" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-primary mb-3">Playlist Dashboards (Drag to reorder)</h3>
                <div id="playlist-items" class="space-y-2 max-h-96 overflow-y-auto">
                    <!-- Populated by JavaScript -->
                </div>
                <div id="no-items" class="hidden text-secondary text-center py-8">
                    No dashboards added. Add dashboards from the left panel.
                </div>
            </div>
        </div>

        <div class="flex justify-end mt-6">
            <button onclick="closeItemsModal()" class="btn-secondary px-4 py-2 rounded-lg">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    let playlists = [];
    let filteredPlaylists = [];
    let allDashboards = [];
    let currentPlaylistId = null;
    let playlistItems = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadPlaylists();
        loadDashboards();
    });

    async function loadPlaylists() {
        try {
            const response = await fetch('/api/playlists');
            if (!response.ok) throw new Error('Failed to load playlists');
            playlists = await response.json();
            updateStats();
            filterPlaylists();
        } catch (error) {
            console.error('Error loading playlists:', error);
            showToast('Failed to load playlists', 'error');
        }
    }

    async function loadDashboards() {
        try {
            const response = await fetch('/api/dashboards');
            if (response.ok) allDashboards = await response.json();
        } catch (error) {
            console.error('Error loading dashboards:', error);
        }
    }

    function updateStats() {
        document.getElementById('statTotal').textContent = playlists.length;
        document.getElementById('statLooping').textContent = playlists.filter(p => p.loop).length;
        document.getElementById('statDashboards').textContent = playlists.reduce((sum, p) => sum + (p.item_count || 0), 0);
        const avg = playlists.length > 0
            ? Math.round(playlists.reduce((sum, p) => sum + (p.interval || 0), 0) / playlists.length)
            : 0;
        document.getElementById('statInterval').textContent = avg + 's';
    }

    function filterPlaylists() {
        const search = document.getElementById('search-playlists').value.toLowerCase();
        filteredPlaylists = playlists.filter(p =>
            !search ||
            (p.name && p.name.toLowerCase().includes(search)) ||
            (p.description && p.description.toLowerCase().includes(search))
        );
        renderPlaylists();
    }

    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderPlaylists() {
        const tbody = document.getElementById('playlists-tbody');
        const noPlaylists = document.getElementById('no-playlists');
        const paginationContainer = document.getElementById('pagination-container');
        const tableContainer = document.getElementById('tableContainer');

        if (filteredPlaylists.length === 0) {
            tableContainer.classList.add('hidden');
            paginationContainer.classList.add('hidden');
            noPlaylists.classList.remove('hidden');
            return;
        }

        tableContainer.classList.remove('hidden');
        paginationContainer.classList.remove('hidden');
        noPlaylists.classList.add('hidden');

        totalPages = Math.ceil(filteredPlaylists.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filteredPlaylists.length);
        const paginatedPlaylists = filteredPlaylists.slice(start, end);

        document.getElementById('showing-start').textContent = filteredPlaylists.length > 0 ? start + 1 : 0;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = filteredPlaylists.length;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;

        document.getElementById('first-page-btn').disabled = currentPage <= 1;
        document.getElementById('prev-page-btn').disabled = currentPage <= 1;
        document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        document.getElementById('last-page-btn').disabled = currentPage >= totalPages;

        tbody.innerHTML = paginatedPlaylists.map(playlist => {
            const badgeClass = playlist.loop ? 'badge-loop' : 'badge-once';
            return `
            <tr class="border-b border-[#f1f5f9] hover:bg-[#f8fafc] transition-colors">
                <td class="px-4 py-3">
                    <i class="fas fa-play-circle" style="color: #3b82f6;"></i>
                </td>
                <td class="px-4 py-3">
                    <div class="font-medium text-[#1e40af]">${escapeHtml(playlist.name)}</div>
                    ${playlist.description ? `<div class="text-xs text-[#94a3b8] mt-0.5 truncate max-w-xs">${escapeHtml(playlist.description)}</div>` : ''}
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${badgeClass}">${playlist.loop ? 'LOOP' : 'ONCE'}</span>
                </td>
                <td class="px-4 py-3 text-[#475569] hidden md:table-cell">
                    ${playlist.interval}s
                </td>
                <td class="px-4 py-3 text-[#475569] hidden md:table-cell">
                    ${playlist.item_count || 0}
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden lg:table-cell">
                    ${formatDate(playlist.created_at)}
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        <button onclick="playPlaylist('${playlist.id}')" 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors ${playlist.item_count === 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                            style="color: #059669;"
                            title="Play"
                            ${playlist.item_count === 0 ? 'disabled' : ''}>
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="manageItems('${playlist.id}')" 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #8b5cf6;"
                            title="Manage Dashboards">
                            <i class="fas fa-list"></i>
                        </button>
                        <button onclick="editPlaylist('${playlist.id}')" 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #3b82f6;"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deletePlaylist('${playlist.id}')" 
                            class="p-1.5 hover:bg-[#fef2f2] rounded transition-colors" 
                            style="color: #dc2626;"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        }).join('');
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderPlaylists();
    }

    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1;
        renderPlaylists();
    }

    function showToast(message, type) {
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
            return;
        }
        const div = document.createElement('div');
        div.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-[10000] flex items-center gap-2 ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
        div.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i><span>${escapeHtml(message)}</span>`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function showCreatePlaylistModal() {
        document.getElementById('playlist-modal-title').textContent = 'New Playlist';
        document.getElementById('playlist-form').reset();
        document.getElementById('playlist-id').value = '';
        document.getElementById('playlist-loop').checked = true;
        document.getElementById('playlist-interval').value = '30';
        document.getElementById('playlist-modal').classList.remove('hidden');
    }

    function closePlaylistModal() {
        document.getElementById('playlist-modal').classList.add('hidden');
    }

    async function savePlaylist(event) {
        event.preventDefault();

        const playlistId = document.getElementById('playlist-id').value;
        const data = {
            name: document.getElementById('playlist-name').value,
            description: document.getElementById('playlist-description').value || null,
            interval: parseInt(document.getElementById('playlist-interval').value),
            loop: document.getElementById('playlist-loop').checked
        };

        try {
            let response;
            if (playlistId) {
                // Update existing playlist
                response = await fetch(`/api/playlists/${playlistId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // Create new playlist
                response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                showToast(playlistId ? 'Playlist updated' : 'Playlist created', 'success');
                closePlaylistModal();
                await loadPlaylists();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save playlist', 'error');
            }
        } catch (error) {
            console.error('Error saving playlist:', error);
            showToast('Failed to save playlist', 'error');
        }
    }

    async function editPlaylist(playlistId) {
        try {
            const response = await fetch(`/api/playlists/${playlistId}`);
            const playlist = await response.json();

            document.getElementById('playlist-modal-title').textContent = 'Edit Playlist';
            document.getElementById('playlist-id').value = playlist.id;
            document.getElementById('playlist-name').value = playlist.name;
            document.getElementById('playlist-description').value = playlist.description || '';
            document.getElementById('playlist-interval').value = playlist.interval;
            document.getElementById('playlist-loop').checked = playlist.loop;
            document.getElementById('playlist-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading playlist:', error);
            showToast('Failed to load playlist', 'error');
        }
    }

    async function deletePlaylist(playlistId) {
        if (!confirm('Are you sure you want to delete this playlist?')) return;

        try {
            const response = await fetch(`/api/playlists/${playlistId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Playlist deleted', 'success');
                await loadPlaylists();
            } else {
                showToast('Failed to delete playlist', 'error');
            }
        } catch (error) {
            console.error('Error deleting playlist:', error);
            showToast('Failed to delete playlist', 'error');
        }
    }

    async function manageItems(playlistId) {
        currentPlaylistId = playlistId;

        try {
            const response = await fetch(`/api/playlists/${playlistId}`);
            const playlist = await response.json();
            playlistItems = playlist.items || [];

            renderAvailableDashboards();
            renderPlaylistItems();

            document.getElementById('items-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading playlist items:', error);
            showToast('Failed to load playlist items', 'error');
        }
    }

    function closeItemsModal() {
        document.getElementById('items-modal').classList.add('hidden');
        currentPlaylistId = null;
    }

    function renderAvailableDashboards() {
        const container = document.getElementById('available-dashboards');

        // Filter out dashboards already in playlist
        const playlistDashboardIds = playlistItems.map(item => item.dashboard_id);
        const available = allDashboards.filter(d => !playlistDashboardIds.includes(d.id));

        container.innerHTML = available.map(dashboard => `
        <div class="dashboard-item card p-3 flex justify-between items-center border border-[#e2e8f0] hover:border-[#cbd5e1]">
            <div>
                <div class="font-medium text-primary">${escapeHtml(dashboard.name)}</div>
                ${dashboard.description ? `<div class="text-secondary text-xs">${escapeHtml(dashboard.description)}</div>` : ''}
            </div>
            <button onclick="addDashboardToPlaylist('${dashboard.id}')"
                class="px-3 py-1.5 btn-primary rounded text-sm">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `).join('');

        if (available.length === 0) {
            container.innerHTML = '<div class="text-secondary text-center py-4">All dashboards added or no dashboards available</div>';
        }
    }

    function renderPlaylistItems() {
        const container = document.getElementById('playlist-items');
        const noItems = document.getElementById('no-items');

        if (playlistItems.length === 0) {
            container.classList.add('hidden');
            noItems.classList.remove('hidden');
            return;
        }

        container.classList.remove('hidden');
        noItems.classList.add('hidden');

        // Sort by order
        playlistItems.sort((a, b) => a.order - b.order);

        container.innerHTML = playlistItems.map((item, index) => `
        <div class="dashboard-item card p-3 flex items-center gap-2 border border-[#e2e8f0] hover:border-[#cbd5e1]"
             draggable="true" data-item-id="${item.id}" data-order="${item.order}">
            <div class="cursor-grab text-secondary">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <div class="flex-1">
                <div class="font-medium text-primary">${escapeHtml(item.dashboard_name)}</div>
                <div class="text-secondary text-xs">Order: ${index + 1}</div>
            </div>
            <button onclick="removeDashboardFromPlaylist('${item.id}')"
                class="px-3 py-1.5 rounded text-sm bg-red-600 hover:bg-red-700 text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');

        // Add drag and drop handlers
        setupDragAndDrop();
    }

    function filterAvailableDashboards() {
        const search = document.getElementById('search-available').value.toLowerCase();
        const items = document.querySelectorAll('#available-dashboards .dashboard-item');

        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? 'flex' : 'none';
        });
    }

    async function addDashboardToPlaylist(dashboardId) {
        try {
            const maxOrder = playlistItems.length > 0
                ? Math.max(...playlistItems.map(i => i.order))
                : -1;

            const response = await fetch(`/api/playlists/${currentPlaylistId}/items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    dashboard_id: dashboardId,
                    order: maxOrder + 1
                })
            });

            if (response.ok) {
                const newItem = await response.json();
                playlistItems.push(newItem);
                showToast('Dashboard added to playlist', 'success');
                renderAvailableDashboards();
                renderPlaylistItems();
                await loadPlaylists();
            } else {
                showToast('Failed to add dashboard', 'error');
            }
        } catch (error) {
            console.error('Error adding dashboard:', error);
            showToast('Failed to add dashboard', 'error');
        }
    }

    async function removeDashboardFromPlaylist(itemId) {
        try {
            const response = await fetch(`/api/playlists/${currentPlaylistId}/items/${itemId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                playlistItems = playlistItems.filter(i => i.id !== itemId);
                showToast('Dashboard removed from playlist', 'success');
                renderAvailableDashboards();
                renderPlaylistItems();
                await loadPlaylists();
            } else {
                showToast('Failed to remove dashboard', 'error');
            }
        } catch (error) {
            console.error('Error removing dashboard:', error);
            showToast('Failed to remove dashboard', 'error');
        }
    }

    function setupDragAndDrop() {
        const items = document.querySelectorAll('#playlist-items .dashboard-item');

        items.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        });
    }

    let draggedItem = null;

    function handleDragStart(e) {
        draggedItem = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedItem !== this) {
            const allItems = Array.from(document.querySelectorAll('#playlist-items .dashboard-item'));
            const draggedIndex = allItems.indexOf(draggedItem);
            const targetIndex = allItems.indexOf(this);

            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedItem, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedItem, this);
            }

            updateItemOrder();
        }

        return false;
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
    }

    async function updateItemOrder() {
        const items = document.querySelectorAll('#playlist-items .dashboard-item');

        // Update order in playlistItems array
        items.forEach((item, index) => {
            const itemId = item.dataset.itemId;
            const playlistItem = playlistItems.find(i => i.id === itemId);
            if (playlistItem) {
                playlistItem.order = index;
            }
        });

        // Re-render to show updated order numbers
        renderPlaylistItems();

        // Note: For a production app, you'd want to persist this order to the backend
        // For now, the order is only persisted when items are added
    }

    function playPlaylist(playlistId) {
        window.open(`/playlists/${playlistId}/play`, '_blank');
    }
</script>
{% endblock %}