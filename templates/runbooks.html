{% extends "base.html" %}
{% set active_page = 'runbooks' %}

{% block title %}Runbooks - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Runbooks</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-book text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Runbook Library</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<style>
    /* Action Buttons - Inspired by Troubleshoot Page */
    .runbook-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        white-space: nowrap;
    }

    .runbook-action-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }

    .runbook-action-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
        transform: translateY(-1px);
    }

    .runbook-action-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    .runbook-action-secondary {
        background: #ffffff;
        color: #475569;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .runbook-action-secondary:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        background: #f8fafc;
        transform: translateY(-1px);
    }

    .runbook-action-secondary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .runbook-action-btn i {
        font-size: 12px;
    }

    /* Search Input Styling */
    .runbook-search-input {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 14px 8px 36px;
        font-size: 13px;
        color: #1e293b;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
    }

    .runbook-search-input::placeholder {
        color: #94a3b8;
    }

    .runbook-search-input:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .runbook-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .runbook-search-wrapper {
        position: relative;
    }

    .runbook-search-wrapper .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 13px;
        pointer-events: none;
    }

    /* Custom Dropdown Component */
    .rb-dropdown {
        position: relative;
        min-width: 150px;
    }

    .rb-dropdown-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 12px 8px 14px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
        user-select: none;
        white-space: nowrap;
    }

    .rb-dropdown-trigger:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .rb-dropdown.open .rb-dropdown-trigger {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .rb-dropdown-trigger .rb-dd-chevron {
        width: 14px;
        height: 14px;
        color: #94a3b8;
        transition: transform 0.2s ease;
        flex-shrink: 0;
    }

    .rb-dropdown.open .rb-dd-chevron {
        transform: rotate(180deg);
    }

    .rb-dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        min-width: 100%;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
        z-index: 9999;
        padding: 5px;
        overflow: hidden;
    }

    .rb-dropdown.open .rb-dropdown-menu {
        display: block;
        animation: rbDropIn 0.15s ease-out;
    }

    @keyframes rbDropIn {
        from {
            opacity: 0;
            transform: translateY(-6px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .rb-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.12s ease;
        white-space: nowrap;
    }

    .rb-dropdown-item:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .rb-dropdown-item.selected {
        background: rgba(59, 130, 246, 0.08);
        color: #2563eb;
    }

    .rb-dropdown-item .rb-dd-check {
        width: 14px;
        font-size: 11px;
        color: #3b82f6;
        opacity: 0;
    }

    .rb-dropdown-item.selected .rb-dd-check {
        opacity: 1;
    }

    /* Hidden native select for form compat */
    .rb-dropdown select {
        display: none;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 640px) {
        .runbook-action-btn {
            padding: 8px 12px;
        }

        .rb-dropdown {
            min-width: 120px;
        }
    }

    /* Grafana-aligned Panel/Table Style */
    .panel-card {
        background-color: #181b1f;
        border: 1px solid rgba(204, 204, 220, 0.12);
        border-radius: 4px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    /* Modern Badge Styles */
    .badge {
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        letter-spacing: 0.03em;
    }

    .badge-active {
        background-color: #ecfdf5;
        color: #059669;
        border: 1px solid #a7f3d0;
    }

    .badge-active::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #10b981;
        display: inline-block;
    }

    .badge-draft {
        background-color: #fffbeb;
        color: #d97706;
        border: 1px solid #fde68a;
    }

    .badge-draft::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #f59e0b;
        display: inline-block;
    }

    .badge-disabled {
        background-color: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .badge-disabled::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #94a3b8;
        display: inline-block;
    }

    .badge-infrastructure {
        background-color: #eff6ff;
        color: #2563eb;
        border: 1px solid #bfdbfe;
    }

    .badge-application {
        background-color: #faf5ff;
        color: #9333ea;
        border: 1px solid #e9d5ff;
    }

    .badge-database {
        background-color: #fdf2f8;
        color: #db2777;
        border: 1px solid #fbcfe8;
    }

    .badge-network {
        background-color: #eff6ff;
        color: #3b82f6;
        border: 1px solid #bfdbfe;
    }

    .badge-security {
        background-color: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .badge-diagnostics {
        background-color: #ecfeff;
        color: #0f766e;
        border: 1px solid #a5f3fc;
    }

    /* Dropdown color indicators */
    .rb-dd-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    .rb-dd-icon {
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        flex-shrink: 0;
    }

    .rb-modal-overlay {
        z-index: 2000;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar with Filters and Actions -->
    <div class="card p-4" style="overflow: visible; position: relative; z-index: 200;">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <!-- Left: Filters -->
            <div class="flex flex-wrap gap-3 items-center flex-1">
                <div class="runbook-search-wrapper flex-1 min-w-[200px]">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search runbooks..." onkeyup="filterRunbooks()"
                        class="runbook-search-input w-full">
                </div>
                <!-- Status Dropdown -->
                <div class="rb-dropdown" id="statusDropdown">
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="draft">Draft</option>
                        <option value="disabled">Disabled</option>
                    </select>
                    <div class="rb-dropdown-trigger" onclick="toggleRbDropdown('statusDropdown')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-circle-dot" style="font-size: 11px; color: #94a3b8;"></i>
                            <span class="rb-dd-label">All Status</span>
                        </div>
                        <svg class="rb-dd-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="rb-dropdown-menu">
                        <div class="rb-dropdown-item selected" data-value=""
                            onclick="selectRbOption('statusDropdown','','All Status')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-dot"
                                style="background: linear-gradient(135deg, #10b981, #f59e0b, #94a3b8);"></span>
                            All Status
                        </div>
                        <div class="rb-dropdown-item" data-value="active"
                            onclick="selectRbOption('statusDropdown','active','Active')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-dot" style="background: #10b981;"></span>
                            Active
                        </div>
                        <div class="rb-dropdown-item" data-value="draft"
                            onclick="selectRbOption('statusDropdown','draft','Draft')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-dot" style="background: #f59e0b;"></span>
                            Draft
                        </div>
                        <div class="rb-dropdown-item" data-value="disabled"
                            onclick="selectRbOption('statusDropdown','disabled','Disabled')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-dot" style="background: #94a3b8;"></span>
                            Disabled
                        </div>
                    </div>
                </div>

                <!-- Category Dropdown -->
                <div class="rb-dropdown" id="categoryDropdown">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="application">Application</option>
                        <option value="database">Database</option>
                        <option value="network">Network</option>
                        <option value="security">Security</option>
                        <option value="diagnostics">Diagnostics</option>
                    </select>
                    <div class="rb-dropdown-trigger" onclick="toggleRbDropdown('categoryDropdown')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-th-large" style="font-size: 11px; color: #94a3b8;"></i>
                            <span class="rb-dd-label">All Categories</span>
                        </div>
                        <svg class="rb-dd-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="rb-dropdown-menu">
                        <div class="rb-dropdown-item selected" data-value=""
                            onclick="selectRbOption('categoryDropdown','','All Categories')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #64748b;"><i class="fas fa-th-large"></i></span>
                            All Categories
                        </div>
                        <div class="rb-dropdown-item" data-value="infrastructure"
                            onclick="selectRbOption('categoryDropdown','infrastructure','Infrastructure')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #2563eb;"><i class="fas fa-server"></i></span>
                            Infrastructure
                        </div>
                        <div class="rb-dropdown-item" data-value="application"
                            onclick="selectRbOption('categoryDropdown','application','Application')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #9333ea;"><i class="fas fa-cubes"></i></span>
                            Application
                        </div>
                        <div class="rb-dropdown-item" data-value="database"
                            onclick="selectRbOption('categoryDropdown','database','Database')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #db2777;"><i class="fas fa-database"></i></span>
                            Database
                        </div>
                        <div class="rb-dropdown-item" data-value="network"
                            onclick="selectRbOption('categoryDropdown','network','Network')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #3b82f6;"><i class="fas fa-network-wired"></i></span>
                            Network
                        </div>
                        <div class="rb-dropdown-item" data-value="security"
                            onclick="selectRbOption('categoryDropdown','security','Security')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #dc2626;"><i class="fas fa-shield-alt"></i></span>
                            Security
                        </div>
                        <div class="rb-dropdown-item" data-value="diagnostics"
                            onclick="selectRbOption('categoryDropdown','diagnostics','Diagnostics')">
                            <i class="fas fa-check rb-dd-check"></i>
                            <span class="rb-dd-icon" style="color: #0f766e;"><i class="fas fa-stethoscope"></i></span>
                            Diagnostics
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Action Buttons -->
            <div class="flex items-center gap-2 flex-wrap" style="position: relative; z-index: 210;">
                <button onclick="openTemplatesModal()" class="runbook-action-btn runbook-action-secondary"
                    title="Browse runbook templates">
                    <i class="fas fa-layer-group"></i>
                    <span class="hidden sm:inline">Templates</span>
                </button>
                <button onclick="openImportModal()" class="runbook-action-btn runbook-action-secondary"
                    title="Import runbook from file">
                    <i class="fas fa-file-import"></i>
                    <span class="hidden sm:inline">Import</span>
                </button>
                <a href="/runbooks/new" class="runbook-action-btn runbook-action-primary" title="Create new runbook">
                    <i class="fas fa-plus"></i>
                    <span>Create Runbook</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" class="hidden card p-3 bg-blue-900 bg-opacity-10">
        <div class="flex items-center gap-3 flex-wrap">
            <span id="selectedCount" class="text-sm text-blue-400 font-medium">0 selected</span>
            <button onclick="bulkEnable()" class="runbook-action-btn runbook-action-secondary px-3 py-1.5 text-xs">
                <i class="fas fa-check-circle"></i>
                <span>Enable</span>
            </button>
            <button onclick="bulkDisable()" class="runbook-action-btn runbook-action-secondary px-3 py-1.5 text-xs">
                <i class="fas fa-ban"></i>
                <span>Disable</span>
            </button>
            <button onclick="bulkDelete()"
                class="runbook-action-btn runbook-action-secondary px-3 py-1.5 text-xs text-red-400 hover:text-red-300 hover:border-red-400">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
            </button>
            <button onclick="clearSelection()"
                class="runbook-action-btn runbook-action-secondary px-3 py-1.5 text-xs ml-auto">
                <span>Clear Selection</span>
            </button>
        </div>
    </div>

    <div id="runbooksGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4">
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-4" style="border-left: 3px solid #3b82f6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas fa-book" style="color: #2563eb; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Total Runbooks</p>
                    <p class="text-2xl font-bold text-primary" id="totalCount" style="line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #10b981;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #ecfdf5, #d1fae5);">
                    <i class="fas fa-check-circle" style="color: #059669; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Active</p>
                    <p class="text-2xl font-bold" id="activeCount" style="color: #059669; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #f59e0b;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #fffbeb, #fef3c7);">
                    <i class="fas fa-edit" style="color: #d97706; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Drafts</p>
                    <p class="text-2xl font-bold" id="draftCount" style="color: #d97706; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #8b5cf6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #f5f3ff, #ede9fe);">
                    <i class="fas fa-play" style="color: #7c3aed; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Executions Today
                    </p>
                    <p class="text-2xl font-bold" id="executionCount" style="color: #7c3aed; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Runbooks Table -->
    <div class="card overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-4 py-3 font-medium w-10">
                        <input type="checkbox" id="selectAllCheckbox" onclick="toggleSelectAll()" class="h-4 w-4">
                    </th>
                    <th class="px-4 py-3 font-medium">Name</th>
                    <th class="px-4 py-3 font-medium">Status</th>
                    <th class="px-4 py-3 font-medium">Category</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Steps</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Triggers</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Created</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Updated</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="runbooks-tbody" class="text-[#334155]">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="flex items-center justify-between mt-4 text-sm hidden">
        <div class="text-[#64748b]">
            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            runbooks
        </div>
        <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="first-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-left"></i>
            </button>
            <span class="px-3 py-1.5 text-[#475569]">Page <span id="current-page">1</span> of <span
                    id="total-pages">1</span></span>
            <button onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-right"></i>
            </button>
            <button onclick="goToPage(totalPages)" id="last-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <select id="page-size" onchange="changePageSize(this.value)"
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] focus:outline-none focus:border-[#3b82f6]">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
            </select>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="card p-12 text-center hidden">
        <i class="fas fa-book-open text-4xl text-secondary mb-4"></i>
        <h3 class="text-lg font-medium text-primary mb-2">No Runbooks Found</h3>
        <p class="text-secondary mb-4">Create your first runbook to start automating remediation tasks.</p>
        <button onclick="openCreateModal()" class="btn-primary px-4 py-2 rounded-lg">
            <i class="fas fa-plus mr-2"></i>Create Runbook
        </button>
    </div>
</div>

<!-- Create/Edit Runbook Modal -->
<div id="runbookModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary" id="modalTitle">Create Runbook</h2>
            <button onclick="closeModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <form id="runbookForm" onsubmit="saveRunbook(event)">
            <input type="hidden" id="runbookId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="label-with-tooltip block text-secondary text-sm mb-1">
                        Name *
                        <span class="info-tooltip info-tooltip-bottom info-tooltip-align-left">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">A unique, descriptive name for this runbook. Use clear
                                naming like "Restart Nginx Service" or "Clear Redis Cache".</span>
                        </span>
                    </label>
                    <input type="text" id="runbookName" required class="input-field w-full px-3 py-2 rounded"
                        placeholder="e.g., Restart Service">
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-sm mb-1">
                        Category
                        <span class="info-tooltip info-tooltip-bottom info-tooltip-align-right">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">Group runbooks by type for easier organization. Categories
                                help filter and find runbooks quickly.</span>
                        </span>
                    </label>
                    <select id="runbookCategory" class="input-field w-full px-3 py-2 rounded">
                        <option value="infrastructure">Infrastructure</option>
                        <option value="application">Application</option>
                        <option value="database">Database</option>
                        <option value="network">Network</option>
                        <option value="security">Security</option>
                        <option value="diagnostics">Diagnostics</option>
                    </select>
                </div>
            </div>

            <div class="mb-4">
                <label class="label-with-tooltip block text-secondary text-sm mb-1">
                    Description
                    <span class="info-tooltip">
                        <span class="info-tooltip-icon">?</span>
                        <span class="info-tooltip-text">Provide a detailed explanation of what this runbook does, when
                            to use it, and any prerequisites or considerations.</span>
                    </span>
                </label>
                <textarea id="runbookDescription" rows="2" class="input-field w-full px-3 py-2 rounded"
                    placeholder="Describe what this runbook does"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="label-with-tooltip block text-secondary text-sm mb-1">
                        Status
                        <span class="info-tooltip info-tooltip-align-left">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text"><strong>Draft:</strong> Testing mode, cannot be triggered
                                automatically.<br><strong>Active:</strong> Production ready, can be executed manually or
                                by triggers.<br><strong>Disabled:</strong> Temporarily turned off.</span>
                        </span>
                    </label>
                    <select id="runbookStatus" class="input-field w-full px-3 py-2 rounded">
                        <option value="draft">Draft</option>
                        <option value="active">Active</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-sm mb-1">
                        Approval Required
                        <span class="info-tooltip">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text"><strong>None:</strong> Execute immediately without
                                approval.<br><strong>Manual:</strong> Requires user approval before
                                execution.<br><strong>Auto:</strong> Auto-approves after a configurable delay.</span>
                        </span>
                    </label>
                    <select id="runbookApproval" class="input-field w-full px-3 py-2 rounded">
                        <option value="none">None</option>
                        <option value="manual">Manual</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-sm mb-1">
                        Max Executions / Hour
                        <span class="info-tooltip info-tooltip-align-right">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">Limit how many times this runbook may execute within an hour
                                to avoid runaway automation.</span>
                        </span>
                    </label>
                    <input type="number" id="runbookMaxExecutions" value="5" min="1" max="100"
                        class="input-field w-full px-3 py-2 rounded">
                </div>
            </div>

            <!-- Steps Section -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <label class="label-with-tooltip block text-secondary text-sm">
                        Steps
                        <span class="info-tooltip">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">Define the sequence of actions to perform. Steps execute in
                                order. Each step can be a shell command, HTTP request, script, or automation tool
                                action.</span>
                        </span>
                    </label>
                    <button type="button" onclick="addStep()" class="btn-secondary px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Step
                    </button>
                </div>
                <div id="stepsContainer" class="space-y-3">
                    <!-- Steps will be added dynamically -->
                </div>
            </div>

            <!-- Triggers Section -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="label-with-tooltip block text-secondary text-sm">
                        Triggers
                        <span class="info-tooltip">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">Define conditions that automatically start this runbook.
                                Triggers can match alert patterns, labels, or specific conditions.</span>
                        </span>
                    </label>
                    <button type="button" onclick="addTrigger()" class="btn-secondary px-3 py-1 rounded text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Trigger
                    </button>
                </div>
                <p class="text-xs text-secondary mb-3">
                    <i class="fas fa-info-circle mr-1"></i>
                    Runbook executes if <strong>ANY</strong> of the configured triggers match (OR condition).
                </p>
                <div id="triggersContainer" class="space-y-3">
                    <!-- Triggers will be added dynamically -->
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save Runbook
                </button>
            </div>
        </form>
    </div>
</div>

<!-- View Runbook Modal -->
<div id="viewModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary" id="viewTitle">Runbook Details</h2>
            <button onclick="closeViewModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="viewContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Execute Runbook Modal -->
<div id="executeModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary">Execute Runbook</h2>
            <button onclick="closeExecuteModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="executeForm" onsubmit="executeRunbook(event)">
            <input type="hidden" id="executeRunbookId">
            <p class="text-secondary mb-4" id="executeMessage">Are you sure you want to execute this runbook?</p>

            <div class="mb-4">
                <label class="label-with-tooltip block text-secondary text-sm mb-1">
                    Server Credential
                    <span class="info-tooltip">
                        <span class="info-tooltip-icon">?</span>
                        <span class="info-tooltip-text">Choose a stored server credential for this execution. Leave
                            blank to use the runbook default server or alert-derived target.</span>
                    </span>
                </label>
                <select id="executeServerId" class="input-field w-full px-3 py-2 rounded">
                    <option value="">Use runbook default / alert context</option>
                </select>
            </div>

            <div class="mb-4 flex items-center gap-2">
                <input type="checkbox" id="executeDryRun" class="h-4 w-4">
                <label for="executeDryRun" class="text-sm text-secondary">Dry run (validate only, do not execute
                    commands)</label>
            </div>

            <div class="mb-4">
                <label class="label-with-tooltip block text-secondary text-sm mb-1">
                    Parameters (JSON)
                    <span class="info-tooltip">
                        <span class="info-tooltip-icon">?</span>
                        <span class="info-tooltip-text">Optional JSON object with runtime parameters to pass to the
                            runbook. These can be used in steps with template syntax like {% raw %}{{param_name}}{%
                            endraw %}.</span>
                    </span>
                </label>
                <textarea id="executeParams" rows="3" class="input-field w-full px-3 py-2 rounded font-mono text-sm"
                    placeholder='{"key": "value"}'></textarea>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeExecuteModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-play mr-2"></i>Execute
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary" id="confirmTitle">Confirm Action</h2>
            <button onclick="closeConfirmModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-6" id="confirmMessage">Are you sure?</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeConfirmModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
            <button id="confirmBtn" class="btn-primary px-4 py-2 rounded-lg">Confirm</button>
        </div>
    </div>
</div>

<!-- Import YAML Modal -->
<div id="importModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-2xl">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary">Import Runbook from YAML</h2>
            <button onclick="closeImportModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="importForm" onsubmit="importYAML(event)">
            <div class="mb-4">
                <label class="block text-secondary text-sm mb-2">
                    Upload YAML File or Paste Content
                </label>
                <div class="mb-3">
                    <input type="file" id="yamlFile" accept=".yaml,.yml" class="input-field w-full px-3 py-2 rounded"
                        onchange="handleFileUpload(event)">
                </div>
                <textarea id="yamlContent" rows="15" class="input-field w-full px-3 py-2 rounded font-mono text-sm"
                    placeholder="Paste YAML content here..."></textarea>
            </div>
            <div class="mb-4 flex items-center gap-2">
                <input type="checkbox" id="overwriteExisting" class="h-4 w-4">
                <label for="overwriteExisting" class="text-sm text-secondary">
                    Overwrite existing runbook with same name
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeImportModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-file-import mr-2"></i>Import
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Templates Modal -->
<div id="templatesModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden rb-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary">Runbook Templates</h2>
            <button onclick="closeTemplatesModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="templatesGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Templates will be loaded dynamically -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========================================================================
    // Custom Dropdown Logic
    // ========================================================================
    function toggleRbDropdown(id) {
        const dd = document.getElementById(id);
        const wasOpen = dd.classList.contains('open');

        // Close all open dropdowns first
        document.querySelectorAll('.rb-dropdown.open').forEach(d => d.classList.remove('open'));

        if (!wasOpen) dd.classList.add('open');
    }

    function selectRbOption(dropdownId, value, label) {
        const dd = document.getElementById(dropdownId);
        const select = dd.querySelector('select');
        const trigger = dd.querySelector('.rb-dd-label');

        // Update hidden select
        select.value = value;

        // Update label text
        trigger.textContent = label;

        // Update selected state on items
        dd.querySelectorAll('.rb-dropdown-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.value === value);
        });

        // Close dropdown
        dd.classList.remove('open');

        // Trigger filter
        filterRunbooks();
    }

    // Close dropdowns on outside click
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.rb-dropdown')) {
            document.querySelectorAll('.rb-dropdown.open').forEach(d => d.classList.remove('open'));
        }
    });

    // ========================================================================
    // Runbooks Data & Logic
    // ========================================================================
    let runbooks = [];
    let servers = [];
    let filteredRunbooks = [];
    let stepCount = 0;
    let triggerCount = 0;

    // Pagination state
    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;

    // Load runbooks on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadRunbooks();
        loadServers();
    });

    async function loadRunbooks() {
        try {
            const response = await fetch('/api/remediation/runbooks');
            if (response.ok) {
                runbooks = await response.json();
                renderRunbooks();
                updateStats();
            } else {
                showToast('Failed to load runbooks', 'error');
            }
        } catch (error) {
            console.error('Error loading runbooks:', error);
            showToast('Error loading runbooks', 'error');
        }
    }

    async function loadServers() {
        try {
            const response = await fetch('/api/servers');
            if (response.ok) {
                servers = await response.json();
            } else {
                servers = [];
            }
            populateServerOptions();
        } catch (error) {
            console.error('Error loading servers:', error);
            servers = [];
        }
    }

    function renderRunbooks() {
        const tbody = document.getElementById('runbooks-tbody');
        const emptyState = document.getElementById('emptyState');
        const paginationContainer = document.getElementById('pagination-container');
        const tableContainer = tbody.closest('.card');

        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;

        // Filter runs
        filteredRunbooks = runbooks.filter(rb => {
            const matchesSearch = rb.name.toLowerCase().includes(searchTerm) ||
                (rb.description && rb.description.toLowerCase().includes(searchTerm));
            const runbookStatus = deriveStatus(rb);
            const matchesStatus = !statusFilter || runbookStatus === statusFilter;
            const matchesCategory = !categoryFilter || rb.category === categoryFilter;
            return matchesSearch && matchesStatus && matchesCategory;
        });

        if (filteredRunbooks.length === 0) {
            tableContainer.classList.add('hidden');
            paginationContainer.classList.add('hidden');
            emptyState.classList.remove('hidden');
            return;
        }

        tableContainer.classList.remove('hidden');
        paginationContainer.classList.remove('hidden');
        emptyState.classList.add('hidden');

        // Calculate pagination
        totalPages = Math.ceil(filteredRunbooks.length / pageSize);
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filteredRunbooks.length);
        const paginatedRunbooks = filteredRunbooks.slice(start, end);

        // Update pagination info
        document.getElementById('showing-start').textContent = filteredRunbooks.length > 0 ? start + 1 : 0;
        document.getElementById('showing-end').textContent = end;
        document.getElementById('total-count').textContent = filteredRunbooks.length;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;

        // Update pagination buttons
        document.getElementById('first-page-btn').disabled = currentPage <= 1;
        document.getElementById('prev-page-btn').disabled = currentPage <= 1;
        document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        document.getElementById('last-page-btn').disabled = currentPage >= totalPages;

        // Render Table Rows
        tbody.innerHTML = paginatedRunbooks.map(rb => {
            const runbookStatus = deriveStatus(rb);
            const runbookName = rb.name || 'Untitled Runbook';
            const badgeClass = `badge-${runbookStatus}`;
            const categoryBadgeClass = `badge-${rb.category || 'infrastructure'}`;
            const icon = getRunbookIcon(rb.category || 'infrastructure');

            return `
            <tr class="border-b border-[#f1f5f9] hover:bg-[#f8fafc] transition-colors">
                <td class="px-4 py-3">
                    <input type="checkbox" class="runbook-checkbox h-4 w-4" data-runbook-id="${rb.id}"
                        onclick="event.stopPropagation(); toggleRunbookSelection('${rb.id}')" />
                </td>
                <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                        <i class="fas ${icon.icon}" style="color: ${icon.color}"></i>
                        <div class="font-medium text-[#1e40af] cursor-pointer hover:text-blue-500 hover:underline" onclick='viewRunbook(${JSON.stringify(rb.id)})'>
                            ${escapeHtml(runbookName)}
                        </div>
                    </div>
                    ${rb.description ? `<div class="text-xs text-[#94a3b8] mt-0.5 truncate max-w-xs pl-6">${escapeHtml(rb.description)}</div>` : ''}
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${badgeClass}">${runbookStatus.toUpperCase()}</span>
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${categoryBadgeClass}">${(rb.category || 'Infrastructure').toUpperCase()}</span>
                </td>
                <td class="px-4 py-3 text-[#475569] font-mono text-xs hidden md:table-cell">
                    ${rb.steps_count ?? 0}
                </td>
                <td class="px-4 py-3 text-[#475569] font-mono text-xs hidden md:table-cell">
                    ${rb.triggers_count ?? 0}
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden lg:table-cell">
                    ${formatDate(rb.created_at)}
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden lg:table-cell">
                    ${formatDate(rb.updated_at || rb.created_at)}
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        <a href='/runbooks/${rb.id}/edit' 
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #3b82f6;"
                            title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button onclick='cloneRunbook(${JSON.stringify(rb.id)})'
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #16a34a;"
                            title="Clone">
                            <i class="fas fa-clone"></i>
                        </button>
                        <button onclick='openExecuteModal(${JSON.stringify(rb.id)}, ${JSON.stringify(runbookName)})'
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors" 
                            style="color: #2563eb;"
                            title="Run"
                            ${rb.enabled ? '' : 'disabled style="opacity:0.5; cursor:not-allowed;"'}>
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick='deleteRunbook(${JSON.stringify(rb.id)})'
                            class="p-1.5 hover:bg-[#fef2f2] rounded transition-colors" 
                            style="color: #dc2626;"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    }

    // Styling Helpers
    function deriveStatus(runbook) {
        if (!runbook.enabled) return 'disabled';
        return runbook.auto_execute ? 'active' : 'draft';
    }

    function updateStats() {
        document.getElementById('totalCount').textContent = runbooks.length;
        document.getElementById('activeCount').textContent = runbooks.filter(r => deriveStatus(r) === 'active').length;
        document.getElementById('draftCount').textContent = runbooks.filter(r => deriveStatus(r) === 'draft').length;
        const executionsTotal = runbooks.reduce((sum, rb) => sum + (rb.executions_count || 0), 0);
        document.getElementById('executionCount').textContent = executionsTotal;
    }

    function getRunbookIcon(category) {
        const map = {
            'infrastructure': { icon: 'fa-server', color: '#3d71d9' },  // Blue
            'application': { icon: 'fa-cubes', color: '#b877d9' },      // Purple
            'database': { icon: 'fa-database', color: '#d10e5c' },      // Pink
            'network': { icon: 'fa-network-wired', color: '#6e9fff' },  // Light Blue
            'security': { icon: 'fa-shield-alt', color: '#ff5286' },    // Red
            'diagnostics': { icon: 'fa-stethoscope', color: '#0f766e' } // Teal
        };
        return map[category] || { icon: 'fa-book', color: '#8e8e8e' };
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
        });
    }

    function filterRunbooks() {
        currentPage = 1;
        renderRunbooks();
    }

    // Pagination Helpers
    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderRunbooks();
    }

    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1;
        renderRunbooks();
    }

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Create Runbook';
        document.getElementById('runbookForm').reset();
        document.getElementById('runbookId').value = '';
        document.getElementById('stepsContainer').innerHTML = '';
        document.getElementById('triggersContainer').innerHTML = '';
        stepCount = 0;
        triggerCount = 0;
        addStep(); // Add one default step
        document.getElementById('runbookModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('runbookModal').classList.add('hidden');
    }

    function addStep() {
        stepCount++;
        const container = document.getElementById('stepsContainer');
        const stepHtml = `
        <div class="card p-3 step-item" data-step="${stepCount}">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-primary">Step ${stepCount}</span>
                <button type="button" onclick="removeStep(this)" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Step Name
                        <span class="info-tooltip info-tooltip-align-left">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">A descriptive name for this step. Helps identify the action in execution logs.</span>
                        </span>
                    </label>
                    <input type="text" name="step_name_${stepCount}" required
                        class="input-field w-full px-2 py-1 rounded text-sm" placeholder="Step name">
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Type
                        <span class="info-tooltip info-tooltip-align-right">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text"><strong>Shell:</strong> Execute shell commands<br><strong>HTTP:</strong> Make API calls<br><strong>Script:</strong> Run scripts<br><strong>Ansible:</strong> Run playbooks<br><strong>Kubernetes:</strong> K8s operations</span>
                        </span>
                    </label>
                    <select name="step_type_${stepCount}" class="input-field w-full px-2 py-1 rounded text-sm">
                        <option value="shell">Shell Command</option>
                        <option value="http">HTTP Request</option>
                        <option value="script">Script</option>
                        <option value="ansible">Ansible</option>
                        <option value="kubernetes">Kubernetes</option>
                    </select>
                </div>
            </div>
            <div class="mt-2">
                <label class="label-with-tooltip block text-secondary text-xs mb-1">
                    Command / Action
                    <span class="info-tooltip info-tooltip-align-left">
                        <span class="info-tooltip-icon">?</span>
                        <span class="info-tooltip-text">The command or action to execute. Supports template variables like {% raw %}{{alert.host}}{% endraw %} from the triggering alert.</span>
                    </span>
                </label>
                <textarea name="step_command_${stepCount}" rows="2" required
                    class="input-field w-full px-2 py-1 rounded text-sm font-mono" placeholder="e.g., systemctl restart nginx"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-2">
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Timeout (seconds)
                        <span class="info-tooltip info-tooltip-align-left">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">Maximum time to wait for step completion. Step fails if timeout is exceeded.</span>
                        </span>
                    </label>
                    <input type="number" name="step_timeout_${stepCount}" value="60" min="1"
                        class="input-field w-full px-2 py-1 rounded text-sm">
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Continue on Error
                        <span class="info-tooltip info-tooltip-align-right">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text"><strong>No:</strong> Stop execution if this step fails.<br><strong>Yes:</strong> Continue to next step even if this one fails.</span>
                        </span>
                    </label>
                    <select name="step_continue_${stepCount}" class="input-field w-full px-2 py-1 rounded text-sm">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
            </div>
        </div>
    `;
        container.insertAdjacentHTML('beforeend', stepHtml);
    }

    function removeStep(btn) {
        btn.closest('.step-item').remove();
    }

    function addTrigger() {
        triggerCount++;
        const container = document.getElementById('triggersContainer');
        const triggerHtml = `
        <div class="card p-3 trigger-item" data-trigger="${triggerCount}">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-primary">Trigger ${triggerCount}</span>
                <button type="button" onclick="removeTrigger(this)" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Trigger Type
                        <span class="info-tooltip info-tooltip-align-left">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text"><strong>Alert Pattern:</strong> Match alerts by name/labels<br><strong>Metric Threshold:</strong> Trigger on metric values<br><strong>Schedule:</strong> Run on cron schedule<br><strong>Manual:</strong> Only manual execution</span>
                        </span>
                    </label>
                    <select name="trigger_type_${triggerCount}" class="input-field w-full px-2 py-1 rounded text-sm">
                        <option value="alert_pattern">Alert Pattern</option>
                        <option value="metric_threshold">Metric Threshold</option>
                        <option value="schedule">Schedule (Cron)</option>
                        <option value="manual">Manual Only</option>
                    </select>
                </div>
                <div>
                    <label class="label-with-tooltip block text-secondary text-xs mb-1">
                        Pattern / Value
                        <span class="info-tooltip info-tooltip-align-right">
                            <span class="info-tooltip-icon">?</span>
                            <span class="info-tooltip-text">For Alert Pattern: regex like "CPU.*high"<br>For Metric: threshold value<br>For Schedule: cron expression like "0 */5 * * *"</span>
                        </span>
                    </label>
                    <input type="text" name="trigger_pattern_${triggerCount}"
                        class="input-field w-full px-2 py-1 rounded text-sm" placeholder="e.g., CPU.*high">
                </div>
            </div>
        </div>
    `;
        container.insertAdjacentHTML('beforeend', triggerHtml);
    }

    function removeTrigger(btn) {
        btn.closest('.trigger-item').remove();
    }

    async function saveRunbook(event) {
        event.preventDefault();

        const id = document.getElementById('runbookId').value;
        const steps = [];
        const triggers = [];

        // Collect steps
        document.querySelectorAll('.step-item').forEach((item, index) => {
            const stepNum = item.dataset.step;
            const commandValue = document.querySelector(`[name="step_command_${stepNum}"]`).value;
            steps.push({
                step_order: index + 1,
                name: document.querySelector(`[name="step_name_${stepNum}"]`).value,
                description: null,
                command_linux: commandValue,
                command_windows: null,
                target_os: 'any',
                timeout_seconds: parseInt(document.querySelector(`[name="step_timeout_${stepNum}"]`).value) || 60,
                requires_elevation: false,
                working_directory: null,
                environment_json: null,
                continue_on_fail: document.querySelector(`[name="step_continue_${stepNum}"]`).value === 'true',
                retry_count: 0,
                retry_delay_seconds: 5,
                expected_exit_code: 0,
                expected_output_pattern: null,
                rollback_command_linux: null,
                rollback_command_windows: null
            });
        });

        // Collect triggers
        document.querySelectorAll('.trigger-item').forEach((item, index) => {
            const trigNum = item.dataset.trigger;
            const patternValue = document.querySelector(`[name="trigger_pattern_${trigNum}"]`).value || '*';
            triggers.push({
                alert_name_pattern: patternValue,
                severity_pattern: '*',
                instance_pattern: '*',
                job_pattern: '*',
                label_matchers_json: null,
                annotation_matchers_json: null,
                min_duration_seconds: 0,
                min_occurrences: 1,
                priority: index + 1,
                enabled: true
            });
        });

        const statusValue = document.getElementById('runbookStatus').value;
        const approvalValue = document.getElementById('runbookApproval').value;
        const enabled = statusValue !== 'disabled';
        const autoExecute = statusValue === 'active';
        const approvalRequired = approvalValue !== 'none';

        const data = {
            name: document.getElementById('runbookName').value,
            description: document.getElementById('runbookDescription').value,
            category: document.getElementById('runbookCategory').value,
            tags: [],
            enabled: enabled,
            auto_execute: autoExecute,
            approval_required: approvalRequired,
            approval_roles: ['operator', 'engineer', 'admin'],
            approval_timeout_minutes: approvalValue === 'auto' ? 5 : 30,
            max_executions_per_hour: parseInt(document.getElementById('runbookMaxExecutions').value) || 5,
            cooldown_minutes: 10,
            default_server_id: null,
            target_os_filter: ['linux', 'windows'],
            target_from_alert: true,
            target_alert_label: 'instance',
            notifications_json: null,
            documentation_url: null,
            steps: steps,
            triggers: triggers
        };

        try {
            const url = id ? `/api/remediation/runbooks/${id}` : '/api/remediation/runbooks';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast(id ? 'Runbook updated successfully' : 'Runbook created successfully', 'success');
                closeModal();
                loadRunbooks();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to save runbook', 'error');
            }
        } catch (error) {
            console.error('Error saving runbook:', error);
            showToast('Error saving runbook', 'error');
        }
    }

    async function editRunbook(id) {
        try {
            const response = await fetch(`/api/remediation/runbooks/${id}`);
            if (response.ok) {
                const rb = await response.json();

                document.getElementById('modalTitle').textContent = 'Edit Runbook';
                document.getElementById('runbookId').value = rb.id;
                document.getElementById('runbookName').value = rb.name;
                document.getElementById('runbookDescription').value = rb.description || '';
                document.getElementById('runbookCategory').value = rb.category || 'infrastructure';

                let statusValue = 'draft';
                if (!rb.enabled) {
                    statusValue = 'disabled';
                } else if (rb.auto_execute) {
                    statusValue = 'active';
                }
                document.getElementById('runbookStatus').value = statusValue;

                let approvalValue = 'manual';
                if (!rb.approval_required) {
                    approvalValue = 'none';
                } else if (rb.approval_timeout_minutes && rb.approval_timeout_minutes <= 5) {
                    approvalValue = 'auto';
                }
                document.getElementById('runbookApproval').value = approvalValue;
                document.getElementById('runbookMaxExecutions').value = rb.max_executions_per_hour || 5;

                // Load steps
                document.getElementById('stepsContainer').innerHTML = '';
                stepCount = 0;
                if (rb.steps && rb.steps.length > 0) {
                    rb.steps.forEach(step => {
                        addStep();
                        document.querySelector(`[name="step_name_${stepCount}"]`).value = step.name;
                        document.querySelector(`[name="step_type_${stepCount}"]`).value = 'shell';
                        document.querySelector(`[name="step_command_${stepCount}"]`).value = step.command_linux || step.command_windows || '';
                        document.querySelector(`[name="step_timeout_${stepCount}"]`).value = step.timeout_seconds || 60;
                        document.querySelector(`[name="step_continue_${stepCount}"]`).value = step.continue_on_fail ? 'true' : 'false';
                    });
                }

                // Load triggers
                document.getElementById('triggersContainer').innerHTML = '';
                triggerCount = 0;
                if (rb.triggers && rb.triggers.length > 0) {
                    rb.triggers.forEach(trigger => {
                        addTrigger();
                        document.querySelector(`[name="trigger_type_${triggerCount}"]`).value = 'alert_pattern';
                        document.querySelector(`[name="trigger_pattern_${triggerCount}"]`).value = trigger.alert_name_pattern || '';
                    });
                }

                document.getElementById('runbookModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error loading runbook:', error);
            showToast('Error loading runbook', 'error');
        }
    }

    async function viewRunbook(id) {
        // Navigate to the runbook view page
        window.location.href = `/runbooks/${id}/view`;
    }

    function closeViewModal() {
        document.getElementById('viewModal').classList.add('hidden');
    }

    function populateServerOptions(selectedId = '') {
        const select = document.getElementById('executeServerId');
        if (!select) return;
        const options = [
            '<option value="">Use runbook default / alert context</option>'
        ];
        servers.forEach(server => {
            options.push(`<option value="${server.id}">${escapeHtml(server.name)} (${escapeHtml(server.hostname)})</option>`);
        });
        select.innerHTML = options.join('');
        if (selectedId) {
            select.value = selectedId;
        }
    }

    function openExecuteModal(id, name) {
        document.getElementById('executeRunbookId').value = id;
        document.getElementById('executeMessage').textContent = `Execute runbook: ${name}`;
        document.getElementById('executeServerId').value = '';
        document.getElementById('executeDryRun').checked = false;
        document.getElementById('executeParams').value = '';
        populateServerOptions();
        document.getElementById('executeModal').classList.remove('hidden');

        // Fetch runbook details to detect default server selection (best effort)
        fetch(`/api/remediation/runbooks/${id}`)
            .then(resp => resp.ok ? resp.json() : null)
            .then(rb => {
                if (rb && rb.default_server_id) {
                    populateServerOptions(rb.default_server_id);
                }
            })
            .catch(() => {
                // Ignoreserver dropdown stays on manual selection
            });
    }

    function closeExecuteModal() {
        document.getElementById('executeModal').classList.add('hidden');
    }

    async function executeRunbook(event) {
        event.preventDefault();

        const id = document.getElementById('executeRunbookId').value;
        const serverId = document.getElementById('executeServerId').value;
        const dryRun = document.getElementById('executeDryRun').checked;
        let params = {};

        try {
            const paramsText = document.getElementById('executeParams').value;
            if (paramsText.trim()) {
                params = JSON.parse(paramsText);
            }
        } catch (e) {
            showToast('Invalid JSON in parameters', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/remediation/executions?runbook_id=${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    server_id: serverId || null,
                    alert_id: null,
                    dry_run: dryRun,
                    variables: params,
                    bypass_cooldown: false,
                    bypass_blackout: false
                })
            });

            if (response.ok) {
                const result = await response.json();
                closeExecuteModal();
                // Redirect to executions page to see status/approval
                window.location.href = '/executions';
            } else {
                let errorDetail = 'Failed to execute runbook';
                try {
                    const error = await response.json();
                    errorDetail = error.detail || error.message || errorDetail;
                } catch (err) {
                    // ignore parse errors
                }
                showToast(errorDetail, 'error');
            }
        } catch (error) {
            console.error('Error executing runbook:', error);
            showToast('Error executing runbook', 'error');
        }
    }

    // Custom confirmation modal
    let confirmCallback = null;

    function showConfirmModal(title, message, buttonText, buttonClass, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmBtn').textContent = buttonText;
        document.getElementById('confirmBtn').className = `px-4 py-2 rounded-lg ${buttonClass}`;
        confirmCallback = callback;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmCallback = null;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('confirmBtn').addEventListener('click', function () {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });
    });

    function deleteRunbook(id) {
        showConfirmModal(
            'Delete Runbook',
            'Are you sure you want to delete this runbook? This action cannot be undone.',
            'Delete',
            'bg-red-600 hover:bg-red-700 text-white',
            async () => {
                try {
                    const response = await fetch(`/api/remediation/runbooks/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showToast('Runbook deleted successfully', 'success');
                        loadRunbooks();
                    } else {
                        showToast('Failed to delete runbook', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting runbook:', error);
                    showToast('Error deleting runbook', 'error');
                }
            }
        );
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============================================================================
    // BULK OPERATIONS
    // ============================================================================
    let selectedRunbooks = new Set();

    function toggleRunbookSelection(id) {
        if (selectedRunbooks.has(id)) {
            selectedRunbooks.delete(id);
        } else {
            selectedRunbooks.add(id);
        }
        updateBulkActionsBar();
    }

    function updateBulkActionsBar() {
        const bar = document.getElementById('bulkActionsBar');
        const count = document.getElementById('selectedCount');

        if (selectedRunbooks.size > 0) {
            bar.classList.remove('hidden');
            count.textContent = `${selectedRunbooks.size} selected`;
        } else {
            bar.classList.add('hidden');
        }
    }

    function clearSelection() {
        selectedRunbooks.clear();
        document.querySelectorAll('.runbook-checkbox').forEach(cb => cb.checked = false);
        updateBulkActionsBar();
    }

    async function bulkAction(action) {
        if (selectedRunbooks.size === 0) {
            showToast('No runbooks selected', 'error');
            return;
        }

        const ids = Array.from(selectedRunbooks);
        try {
            const response = await fetch(`/api/remediation/runbooks/bulk-action?action=${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ids)
            });

            if (response.ok) {
                const result = await response.json();
                showToast(result.message, 'success');
                clearSelection();
                loadRunbooks();
            } else {
                const error = await response.json();
                showToast(error.detail || `Failed to ${action} runbooks`, 'error');
            }
        } catch (error) {
            console.error(`Bulk ${action} error:`, error);
            showToast(`Error performing bulk ${action}`, 'error');
        }
    }

    function bulkEnable() {
        bulkAction('enable');
    }

    function bulkDisable() {
        bulkAction('disable');
    }

    function bulkDelete() {
        showConfirmModal(
            'Delete Multiple Runbooks',
            `Are you sure you want to delete ${selectedRunbooks.size} runbook(s)? This action cannot be undone.`,
            'Delete All',
            'bg-red-600 hover:bg-red-700 text-white',
            () => bulkAction('delete')
        );
    }

    // ============================================================================
    // CLONE RUNBOOK
    // ============================================================================
    async function cloneRunbook(id) {
        try {
            const response = await fetch(`/api/remediation/runbooks/${id}/clone`, {
                method: 'POST'
            });

            if (response.ok) {
                showToast('Runbook cloned successfully', 'success');
                loadRunbooks();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to clone runbook', 'error');
            }
        } catch (error) {
            console.error('Clone error:', error);
            showToast('Error cloning runbook', 'error');
        }
    }

    // ============================================================================
    // IMPORT/EXPORT YAML
    // ============================================================================
    function openImportModal() {
        document.getElementById('yamlContent').value = '';
        document.getElementById('yamlFile').value = '';
        document.getElementById('overwriteExisting').checked = false;
        document.getElementById('importModal').classList.remove('hidden');
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.add('hidden');
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('yamlContent').value = e.target.result;
            };
            reader.readAsText(file);
        }
    }

    async function importYAML(event) {
        event.preventDefault();

        const content = document.getElementById('yamlContent').value;
        const overwrite = document.getElementById('overwriteExisting').checked;

        if (!content.trim()) {
            showToast('Please provide YAML content', 'error');
            return;
        }

        try {
            const response = await fetch('/api/remediation/runbooks/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    content: content,
                    format: 'yaml',
                    overwrite: overwrite
                })
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    showToast(`Runbook ${result.action} successfully`, 'success');
                    closeImportModal();
                    loadRunbooks();
                } else {
                    showToast(result.errors.join(', ') || 'Import failed', 'error');
                }
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to import runbook', 'error');
            }
        } catch (error) {
            console.error('Import error:', error);
            showToast('Error importing runbook', 'error');
        }
    }

    // ============================================================================
    // TEMPLATES
    // ============================================================================
    async function openTemplatesModal() {
        document.getElementById('templatesModal').classList.remove('hidden');
        await loadTemplates();
    }

    function closeTemplatesModal() {
        document.getElementById('templatesModal').classList.add('hidden');
    }

    async function loadTemplates() {
        try {
            const response = await fetch('/api/remediation/templates');
            if (response.ok) {
                const data = await response.json();
                renderTemplates(data.templates);
            } else {
                showToast('Failed to load templates', 'error');
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            showToast('Error loading templates', 'error');
        }
    }

    function renderTemplates(templates) {
        const grid = document.getElementById('templatesGrid');
        grid.innerHTML = templates.map(t => `
        <div class="card p-4">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-layer-group text-blue-400"></i>
                <h3 class="font-medium text-primary">${escapeHtml(t.name)}</h3>
            </div>
            <p class="text-secondary text-sm mb-3">${escapeHtml(t.description)}</p>
            <div class="flex items-center justify-between text-xs text-secondary mb-3">
                <span><i class="fas fa-tag mr-1"></i>${t.category}</span>
                <span><i class="fas fa-layer-group mr-1"></i>${t.steps.length} steps</span>
            </div>
            <button onclick='createFromTemplate(${JSON.stringify(t.id)})'
                class="w-full btn-primary px-3 py-2 rounded text-sm">
                <i class="fas fa-plus mr-1"></i>Use Template
            </button>
        </div>
    `).join('');
    }

    async function createFromTemplate(templateId) {
        try {
            const response = await fetch(`/api/remediation/templates/${templateId}/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                showToast('Runbook created from template', 'success');
                closeTemplatesModal();
                loadRunbooks();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Failed to create from template', 'error');
            }
        } catch (error) {
            console.error('Template creation error:', error);
            showToast('Error creating from template', 'error');
        }
    }

    // Only define showToast if not already defined by parent
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-[10000] flex items-center gap-2 ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
            toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${escapeHtml(message)}</span>
        `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    }
</script>
{{ super() }}
{% endblock %}