{% extends "layout.html" %}
{% set active_page = 'credential-profiles' %}

{% block title %}API Credential Profiles - AIOps Platform{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">API Credential Profiles</h1>
            <p class="text-gray-400">Manage credentials for external APIs (Ansible AWX, Jenkins, Kubernetes, etc.)</p>
        </div>
        <button onclick="showCreateModal()" class="btn-primary px-4 py-2 rounded">
            <i class="fas fa-plus mr-2"></i>New Profile
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="card p-4">
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
                <input
                    id="searchInput"
                    type="text"
                    class="input-field w-full px-3 py-2 rounded text-sm"
                    placeholder="Search by name or base URL..."
                    oninput="filterProfiles()"
                >
            </div>
            <div>
                <select id="authTypeFilter" class="input-field px-3 py-2 rounded text-sm" onchange="filterProfiles()">
                    <option value="">All Auth Types</option>
                    <option value="none">No Auth</option>
                    <option value="api_key">API Key</option>
                    <option value="bearer">Bearer Token</option>
                    <option value="basic">Basic Auth</option>
                    <option value="oauth">OAuth 2.0</option>
                </select>
            </div>
            <div>
                <select id="statusFilter" class="input-field px-3 py-2 rounded text-sm" onchange="filterProfiles()">
                    <option value="">All Statuses</option>
                    <option value="enabled">Enabled</option>
                    <option value="disabled">Disabled</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Profiles List -->
    <div id="profilesContainer">
        <div class="text-center py-8">
            <div class="loading-spinner mx-auto"></div>
            <p class="text-gray-400 mt-4">Loading profiles...</p>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content max-w-2xl">
        <div class="flex items-center justify-between mb-4">
            <h2 id="modalTitle" class="text-xl font-bold">Create API Credential Profile</h2>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="profileForm" class="space-y-4">
            <input type="hidden" id="profileId">

            <!-- Basic Info -->
            <div>
                <label class="block text-sm font-medium mb-1">
                    Profile Name <span class="text-red-400">*</span>
                </label>
                <input
                    type="text"
                    id="profileName"
                    class="input-field w-full px-3 py-2 rounded"
                    placeholder="e.g., Production AWX"
                    required
                >
                <p class="text-xs text-gray-400 mt-1">Unique identifier for this credential profile</p>
            </div>

            <div>
                <label class="block text-sm font-medium mb-1">Description</label>
                <textarea
                    id="profileDescription"
                    class="input-field w-full px-3 py-2 rounded"
                    rows="2"
                    placeholder="Optional description..."
                ></textarea>
            </div>

            <!-- API Configuration -->
            <div>
                <label class="block text-sm font-medium mb-1">
                    Base URL <span class="text-red-400">*</span>
                </label>
                <input
                    type="url"
                    id="profileBaseUrl"
                    class="input-field w-full px-3 py-2 rounded"
                    placeholder="https://api.example.com"
                    required
                >
                <p class="text-xs text-gray-400 mt-1">Base URL for the API (e.g., https://awx.example.com/api/v2)</p>
            </div>

            <!-- Authentication -->
            <div>
                <label class="block text-sm font-medium mb-1">
                    Authentication Type <span class="text-red-400">*</span>
                </label>
                <select id="profileAuthType" class="input-field w-full px-3 py-2 rounded" onchange="toggleAuthFields()" required>
                    <option value="none">No Authentication</option>
                    <option value="api_key">API Key (Header)</option>
                    <option value="bearer">Bearer Token</option>
                    <option value="basic">Basic Auth (Username/Password)</option>
                    <option value="oauth">OAuth 2.0</option>
                </select>
            </div>

            <!-- Auth Header (for api_key type) -->
            <div id="authHeaderField" class="hidden">
                <label class="block text-sm font-medium mb-1">Auth Header Name</label>
                <input
                    type="text"
                    id="profileAuthHeader"
                    class="input-field w-full px-3 py-2 rounded"
                    placeholder="e.g., X-API-Key"
                >
                <p class="text-xs text-gray-400 mt-1">Header name for API key (default: Authorization)</p>
            </div>

            <!-- Token/API Key (for api_key, bearer types) -->
            <div id="tokenField" class="hidden">
                <label class="block text-sm font-medium mb-1">Token / API Key</label>
                <input
                    type="password"
                    id="profileToken"
                    class="input-field w-full px-3 py-2 rounded"
                    placeholder="Enter token or API key"
                >
                <p class="text-xs text-gray-400 mt-1">Will be encrypted before storage</p>
            </div>

            <!-- Username/Password (for basic auth) -->
            <div id="basicAuthFields" class="hidden space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input
                        type="text"
                        id="profileUsername"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="Username"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input
                        type="password"
                        id="profilePassword"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="Password"
                    >
                </div>
            </div>

            <!-- OAuth Fields -->
            <div id="oauthFields" class="hidden space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">OAuth Token URL</label>
                    <input
                        type="url"
                        id="profileOAuthTokenUrl"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="https://auth.example.com/oauth/token"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Client ID</label>
                    <input
                        type="text"
                        id="profileOAuthClientId"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="Client ID"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Client Secret</label>
                    <input
                        type="password"
                        id="profileOAuthClientSecret"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="Client Secret"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Scope (Optional)</label>
                    <input
                        type="text"
                        id="profileOAuthScope"
                        class="input-field w-full px-3 py-2 rounded"
                        placeholder="read write"
                    >
                </div>
            </div>

            <!-- Advanced Options -->
            <div class="border-t border-gray-700 pt-4 space-y-3">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="profileVerifySSL" class="form-checkbox" checked>
                    <label for="profileVerifySSL" class="text-sm">Verify SSL Certificate</label>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Timeout (seconds)</label>
                    <input
                        type="number"
                        id="profileTimeout"
                        class="input-field w-full px-3 py-2 rounded"
                        value="30"
                        min="1"
                        max="300"
                    >
                </div>

                <div class="flex items-center gap-3">
                    <input type="checkbox" id="profileEnabled" class="form-checkbox" checked>
                    <label for="profileEnabled" class="text-sm font-medium">Enable this profile</label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-700">
                <button type="button" onclick="closeModal()" class="btn-secondary px-4 py-2 rounded">
                    Cancel
                </button>
                <button type="button" onclick="testConnection()" class="btn-secondary px-4 py-2 rounded" id="testButton">
                    <i class="fas fa-plug mr-2"></i>Test Connection
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded">
                    <i class="fas fa-save mr-2"></i>Save Profile
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-red-400">Confirm Deletion</h2>
            <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p class="text-gray-300 mb-4">
            Are you sure you want to delete the profile "<span id="deleteProfileName" class="font-semibold"></span>"?
            This action cannot be undone.
        </p>
        <div class="flex justify-end gap-3">
            <button onclick="closeDeleteModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
            <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                <i class="fas fa-trash mr-2"></i>Delete
            </button>
        </div>
    </div>
</div>

<script>
let profiles = [];
let editingProfileId = null;
let deleteProfileId = null;

// Load profiles on page load
document.addEventListener('DOMContentLoaded', function() {
    loadProfiles();
});

// Load all profiles
async function loadProfiles() {
    try {
        const response = await fetch('/api/credential-profiles');
        if (response.ok) {
            profiles = await response.json();
            renderProfiles();
        } else {
            showError('Failed to load credential profiles');
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
        showError('Error loading credential profiles');
    }
}

// Render profiles list
function renderProfiles() {
    const container = document.getElementById('profilesContainer');

    if (profiles.length === 0) {
        container.innerHTML = `
            <div class="card p-8 text-center">
                <i class="fas fa-key text-4xl text-gray-600 mb-3"></i>
                <h3 class="text-lg font-semibold mb-2">No API Credential Profiles</h3>
                <p class="text-gray-400 mb-4">Create your first credential profile to connect to external APIs</p>
                <button onclick="showCreateModal()" class="btn-primary px-4 py-2 rounded">
                    <i class="fas fa-plus mr-2"></i>Create Profile
                </button>
            </div>
        `;
        return;
    }

    // Filter profiles
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
    const authTypeFilter = document.getElementById('authTypeFilter')?.value || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';

    const filtered = profiles.filter(p => {
        const matchesSearch = !searchTerm ||
            p.name.toLowerCase().includes(searchTerm) ||
            p.base_url.toLowerCase().includes(searchTerm);
        const matchesAuthType = !authTypeFilter || p.auth_type === authTypeFilter;
        const matchesStatus = !statusFilter ||
            (statusFilter === 'enabled' && p.enabled) ||
            (statusFilter === 'disabled' && !p.enabled);
        return matchesSearch && matchesAuthType && matchesStatus;
    });

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="card p-8 text-center">
                <p class="text-gray-400">No profiles match your filters</p>
            </div>
        `;
        return;
    }

    // Render as cards
    container.innerHTML = filtered.map(profile => `
        <div class="card p-4 mb-4">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-lg font-semibold">${escapeHtml(profile.name)}</h3>
                        <span class="px-2 py-1 text-xs rounded ${profile.enabled ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-400'}">
                            ${profile.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                        <span class="px-2 py-1 text-xs rounded bg-blue-900 text-blue-300">
                            ${formatAuthType(profile.auth_type)}
                        </span>
                    </div>

                    ${profile.description ? `<p class="text-sm text-gray-400 mb-3">${escapeHtml(profile.description)}</p>` : ''}

                    <div class="grid md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <span class="text-gray-400">Base URL:</span>
                            <span class="text-gray-300 ml-2 font-mono text-xs">${escapeHtml(profile.base_url)}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Timeout:</span>
                            <span class="text-gray-300 ml-2">${profile.timeout_seconds}s</span>
                        </div>
                        <div>
                            <span class="text-gray-400">SSL Verification:</span>
                            <span class="text-gray-300 ml-2">${profile.verify_ssl ? 'Enabled' : 'Disabled'}</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Created:</span>
                            <span class="text-gray-300 ml-2">${formatDate(profile.created_at)}</span>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2 ml-4">
                    <button
                        onclick="testConnectionById('${profile.id}')"
                        class="btn-secondary px-3 py-2 rounded text-sm"
                        title="Test connection"
                    >
                        <i class="fas fa-plug"></i>
                    </button>
                    <button
                        onclick="showEditModal('${profile.id}')"
                        class="btn-secondary px-3 py-2 rounded text-sm"
                        title="Edit"
                    >
                        <i class="fas fa-edit"></i>
                    </button>
                    <button
                        onclick="toggleEnabled('${profile.id}', ${!profile.enabled})"
                        class="btn-secondary px-3 py-2 rounded text-sm"
                        title="${profile.enabled ? 'Disable' : 'Enable'}"
                    >
                        <i class="fas fa-${profile.enabled ? 'toggle-on' : 'toggle-off'}"></i>
                    </button>
                    <button
                        onclick="showDeleteModal('${profile.id}')"
                        class="bg-red-900 hover:bg-red-800 text-red-300 px-3 py-2 rounded text-sm"
                        title="Delete"
                    >
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Show create modal
function showCreateModal() {
    editingProfileId = null;
    document.getElementById('modalTitle').textContent = 'Create API Credential Profile';
    document.getElementById('profileForm').reset();
    document.getElementById('profileId').value = '';
    document.getElementById('profileEnabled').checked = true;
    document.getElementById('profileVerifySSL').checked = true;
    document.getElementById('profileTimeout').value = '30';
    toggleAuthFields();
    document.getElementById('profileModal').classList.add('active');
}

// Show edit modal
async function showEditModal(profileId) {
    try {
        const response = await fetch(`/api/credential-profiles/${profileId}`);
        if (!response.ok) throw new Error('Failed to load profile');

        const profile = await response.json();
        editingProfileId = profileId;

        document.getElementById('modalTitle').textContent = 'Edit API Credential Profile';
        document.getElementById('profileId').value = profile.id;
        document.getElementById('profileName').value = profile.name;
        document.getElementById('profileDescription').value = profile.description || '';
        document.getElementById('profileBaseUrl').value = profile.base_url;
        document.getElementById('profileAuthType').value = profile.auth_type;
        document.getElementById('profileAuthHeader').value = profile.auth_header || '';
        document.getElementById('profileUsername').value = profile.username || '';
        document.getElementById('profileOAuthTokenUrl').value = profile.oauth_token_url || '';
        document.getElementById('profileOAuthClientId').value = profile.oauth_client_id || '';
        document.getElementById('profileOAuthScope').value = profile.oauth_scope || '';
        document.getElementById('profileVerifySSL').checked = profile.verify_ssl;
        document.getElementById('profileTimeout').value = profile.timeout_seconds;
        document.getElementById('profileEnabled').checked = profile.enabled;

        // Don't populate sensitive fields (token, password, client secret)
        document.getElementById('profileToken').value = '';
        document.getElementById('profilePassword').value = '';
        document.getElementById('profileOAuthClientSecret').value = '';

        toggleAuthFields();
        document.getElementById('profileModal').classList.add('active');
    } catch (error) {
        console.error('Error loading profile:', error);
        showError('Failed to load profile details');
    }
}

// Toggle auth fields based on auth type
function toggleAuthFields() {
    const authType = document.getElementById('profileAuthType').value;

    document.getElementById('authHeaderField').classList.add('hidden');
    document.getElementById('tokenField').classList.add('hidden');
    document.getElementById('basicAuthFields').classList.add('hidden');
    document.getElementById('oauthFields').classList.add('hidden');

    if (authType === 'api_key') {
        document.getElementById('authHeaderField').classList.remove('hidden');
        document.getElementById('tokenField').classList.remove('hidden');
    } else if (authType === 'bearer') {
        document.getElementById('tokenField').classList.remove('hidden');
    } else if (authType === 'basic') {
        document.getElementById('basicAuthFields').classList.remove('hidden');
    } else if (authType === 'oauth') {
        document.getElementById('oauthFields').classList.remove('hidden');
    }
}

// Close modal
function closeModal() {
    document.getElementById('profileModal').classList.remove('active');
}

// Handle form submission
document.getElementById('profileForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const data = {
        name: document.getElementById('profileName').value.trim(),
        description: document.getElementById('profileDescription').value.trim() || null,
        base_url: document.getElementById('profileBaseUrl').value.trim(),
        auth_type: document.getElementById('profileAuthType').value,
        auth_header: document.getElementById('profileAuthHeader').value.trim() || null,
        token: document.getElementById('profileToken').value || null,
        username: document.getElementById('profileUsername').value.trim() || null,
        password: document.getElementById('profilePassword').value || null,
        oauth_token_url: document.getElementById('profileOAuthTokenUrl').value.trim() || null,
        oauth_client_id: document.getElementById('profileOAuthClientId').value.trim() || null,
        oauth_client_secret: document.getElementById('profileOAuthClientSecret').value || null,
        oauth_scope: document.getElementById('profileOAuthScope').value.trim() || null,
        verify_ssl: document.getElementById('profileVerifySSL').checked,
        timeout_seconds: parseInt(document.getElementById('profileTimeout').value),
        enabled: document.getElementById('profileEnabled').checked,
        profile_metadata: {}
    };

    try {
        let response;
        if (editingProfileId) {
            // Update existing
            response = await fetch(`/api/credential-profiles/${editingProfileId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            // Create new
            response = await fetch('/api/credential-profiles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        if (response.ok) {
            showSuccess(editingProfileId ? 'Profile updated successfully' : 'Profile created successfully');
            closeModal();
            await loadProfiles();
        } else {
            const error = await response.json();
            showError(error.detail || 'Failed to save profile');
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        showError('Error saving profile');
    }
});

// Test connection
async function testConnection() {
    if (!editingProfileId) {
        showError('Please save the profile first before testing');
        return;
    }

    await testConnectionById(editingProfileId);
}

async function testConnectionById(profileId) {
    const button = document.getElementById('testButton');
    if (button) button.disabled = true;

    try {
        const response = await fetch(`/api/credential-profiles/${profileId}/test`, {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showSuccess('Connection test successful!');
        } else {
            showError(result.error || 'Connection test failed');
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        showError('Error testing connection');
    } finally {
        if (button) button.disabled = false;
    }
}

// Toggle enabled status
async function toggleEnabled(profileId, enabled) {
    try {
        const profile = profiles.find(p => p.id === profileId);
        const response = await fetch(`/api/credential-profiles/${profileId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...profile, enabled })
        });

        if (response.ok) {
            showSuccess(`Profile ${enabled ? 'enabled' : 'disabled'} successfully`);
            await loadProfiles();
        } else {
            showError('Failed to update profile status');
        }
    } catch (error) {
        console.error('Error toggling profile:', error);
        showError('Error updating profile status');
    }
}

// Show delete modal
function showDeleteModal(profileId) {
    deleteProfileId = profileId;
    const profile = profiles.find(p => p.id === profileId);
    document.getElementById('deleteProfileName').textContent = profile.name;
    document.getElementById('deleteModal').classList.add('active');
}

// Close delete modal
function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    deleteProfileId = null;
}

// Confirm delete
async function confirmDelete() {
    if (!deleteProfileId) return;

    try {
        const response = await fetch(`/api/credential-profiles/${deleteProfileId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showSuccess('Profile deleted successfully');
            closeDeleteModal();
            await loadProfiles();
        } else {
            showError('Failed to delete profile');
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        showError('Error deleting profile');
    }
}

// Filter profiles
function filterProfiles() {
    renderProfiles();
}

// Utility functions
function formatAuthType(authType) {
    const types = {
        'none': 'No Auth',
        'api_key': 'API Key',
        'bearer': 'Bearer Token',
        'basic': 'Basic Auth',
        'oauth': 'OAuth 2.0'
    };
    return types[authType] || authType;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showSuccess(message) {
    // Reuse existing notification system if available
    if (typeof showNotification === 'function') {
        showNotification(message, 'success');
    } else {
        alert(message);
    }
}

function showError(message) {
    // Reuse existing notification system if available
    if (typeof showNotification === 'function') {
        showNotification(message, 'error');
    } else {
        alert('Error: ' + message);
    }
}
</script>
{% endblock %}
