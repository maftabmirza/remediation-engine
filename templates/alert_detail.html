{% extends "layout.html" %}
{% set active_page = 'alerts' %}

{% block title %}Alert Details - AIOps Platform{% endblock %}

{% block content %}
<div id="alertContent" class="space-y-6 h-full flex flex-col">
    <div class="text-center py-8">
        <div class="loading-spinner mx-auto"></div>
        <p class="text-gray-400 mt-2">Loading alert...</p>
    </div>
</div>

<!-- Server Selection Modal -->
<div id="serverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-96 max-w-full">
        <h3 class="text-xl font-bold mb-4">Connect to Server</h3>
        <div id="serverList" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
            <!-- Servers will be populated here -->
            <p class="text-gray-400 text-sm">Loading servers...</p>
        </div>
        <div class="flex justify-end space-x-2">
            <button onclick="closeServerModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- Agent Mode Modal -->
<div id="agentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-[480px] max-w-full">
        <div class="flex items-center mb-4">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold">Agent Mode</h3>
                <p class="text-xs text-gray-400">Autonomous troubleshooting assistant</p>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">What should the agent accomplish?</label>
            <textarea id="agentGoal" class="w-full input-field p-3 rounded resize-none h-24"
                placeholder="e.g., Find out why disk space is low and clean up unnecessary files"></textarea>
        </div>

        <div class="bg-gray-800 rounded-lg p-3 mb-4">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="autoApprove"
                    class="form-checkbox h-4 w-4 text-purple-600 rounded border-gray-600 bg-gray-700 mr-3">
                <div>
                    <span class="text-sm text-white">Auto-approve commands</span>
                    <p class="text-xs text-gray-400">Agent will execute commands without asking for approval</p>
                </div>
            </label>
        </div>

        <div class="bg-yellow-900/30 border border-yellow-700 rounded-lg p-3 mb-4">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-2"></i>
                <div class="text-xs text-yellow-200">
                    <strong>Note:</strong> Agent will execute commands on the connected server.
                    Make sure you're connected to the correct server before starting.
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-2">
            <button onclick="closeAgentModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
            <button onclick="startAgent()"
                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white px-4 py-2 rounded font-medium">
                <i class="fas fa-play mr-2"></i>Start Agent
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const alertId = '{{ alert_id }}';
    let chatSocket = null;
    let terminalSocket = null;
    let currentSessionId = null;
    let currentSession = null;
    let term = null;
    let fitAddon = null;
    let availableProviders = [];

    // --- Font Size Logic ---
    let chatFontSize = 14; // default
    function adjustChatFont(delta) {
        chatFontSize = Math.max(10, Math.min(24, chatFontSize + delta));
        document.getElementById('chatMessages').style.fontSize = `${chatFontSize}px`;
    }

    function adjustTermFont(delta) {
        if (!term) return;
        const newSize = Math.max(8, Math.min(24, term.options.fontSize + delta));
        term.options.fontSize = newSize;
        fitAddon.fit();
    }

    // --- Alert Management ---

    async function loadAlert() {
        try {
            const response = await apiCall(`/api/alerts/${alertId}`);
            if (!response) return;

            if (!response.ok) throw new Error('Alert not found');

            const alert = await response.json();
            renderAlert(alert);

            // Initialize Chat Session automatically
            initChatSession(alert.id);

        } catch (error) {
            document.getElementById('alertContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-red-400 text-4xl mb-3"></i>
                    <p class="text-gray-400">Alert not found</p>
                    <a href="/alerts" class="btn-primary mt-4 px-4 py-2 rounded inline-block">Back to Alerts</a>
                </div>
            `;
        }
    }

    function renderAlert(alert) {
        const container = document.getElementById('alertContent');

        // Format labels/annotations (same as before)
        const labelsHtml = Object.entries(alert.labels_json || {})
            .map(([k, v]) => `<span class="inline-block bg-gray-700 px-2 py-1 rounded text-sm mr-2 mb-2">${k}: ${v}</span>`)
            .join('');

        const annotationsHtml = Object.entries(alert.annotations_json || {})
            .map(([k, v]) => `<div class="mb-1"><span class="text-gray-400">${k}:</span> <span class="ml-2">${v}</span></div>`)
            .join('');

        container.innerHTML = `
            <!-- Header -->
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center space-x-3">
                    <a href="/alerts" class="text-gray-400 hover:text-white" title="Back to Alerts"><i class="fas fa-arrow-left"></i></a>
                    <div class="flex items-center space-x-3">
                        <h1 class="text-lg font-bold" title="Alert Name">${alert.alert_name}</h1>
                        <span class="badge-${alert.severity || 'info'} px-1.5 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider" title="Severity">${alert.severity || 'info'}</span>
                        <span class="status-${alert.status} text-xs flex items-center" title="Status"><i class="fas fa-circle text-[8px] mr-1"></i>${alert.status}</span>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="deleteAlert()" class="btn-secondary px-2 py-1 rounded text-red-400 hover:text-red-300 text-xs" title="Delete Alert"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            
            <!-- Compact Details Bar -->
            <div class="bg-gray-800 rounded-lg p-2 mb-2 flex items-center space-x-4 text-xs border border-gray-700">
                <div class="flex items-center text-gray-400" title="Instance"><i class="fas fa-server mr-1"></i><span class="text-white">${alert.instance || 'N/A'}</span></div>
                <div class="flex items-center text-gray-400" title="Job"><i class="fas fa-cube mr-1"></i><span class="text-white">${alert.job || 'N/A'}</span></div>
                <div class="flex items-center text-gray-400" title="Time"><i class="fas fa-clock mr-1"></i><span class="text-white">${new Date(alert.timestamp).toLocaleTimeString()}</span></div>
                <div class="flex-grow border-l border-gray-700 pl-4 text-gray-300 truncate" title="${alert.annotations_json.description || ''}">
                    ${alert.annotations_json.summary || 'No summary'}
                </div>
                
                <!-- Hover for more details -->
                <div class="relative group">
                    <button class="text-blue-400 hover:text-blue-300" title="View Full Details"><i class="fas fa-info-circle"></i> Details</button>
                    <div class="absolute right-0 top-full mt-2 w-80 bg-gray-800 border border-gray-600 rounded-lg shadow-xl p-4 hidden group-hover:block z-50">
                        <h3 class="font-bold mb-2 text-gray-300">Labels</h3>
                        <div class="mb-3">${labelsHtml || '<span class="text-gray-500 text-sm">No labels</span>'}</div>
                        <h3 class="font-bold mb-2 text-gray-300">Annotations</h3>
                        <div>${annotationsHtml || '<span class="text-gray-500 text-sm">No annotations</span>'}</div>
                    </div>
                </div>
            </div>
            
            <!-- 2-Pane Layout (Chat 40% | Terminal 60%) -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-grow overflow-hidden" style="height: calc(100vh - 140px);">
                
                <!-- Pane 1: Chat (5 cols ~ 41%) -->
                <div class="lg:col-span-5 flex flex-col card h-full min-h-0 overflow-hidden">
                    <div class="p-2 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center flex-grow">
                            <h2 class="font-semibold text-sm mr-2"><i class="fas fa-robot text-purple-400 mr-1"></i>AI Assistant</h2>

                            <!-- MODEL SELECTOR -->
                            <select id="modelSelector"
                                    class="bg-gray-700 text-white text-xs px-2 py-1 rounded border border-gray-600 hover:border-blue-400 cursor-pointer mr-2"
                                    onchange="switchModel(this.value)"
                                    title="Select LLM Model">
                                <option value="">Loading...</option>
                            </select>

                            <span id="chatStatus" class="text-[10px] text-gray-500" title="Connection Status">Disconnected</span>
                        </div>
                        <div class="flex space-x-1">
                            <button id="agentModeBtn" onclick="openAgentModal()" class="text-gray-400 hover:text-purple-400 px-1 transition-colors" title="Agent Mode (Ctrl+Shift+A)">
                                <i class="fas fa-magic text-xs"></i>
                            </button>
                            <button onclick="clearChat()" class="text-gray-400 hover:text-white px-1" title="Clear Chat (Ctrl+L)"><i class="fas fa-eraser text-xs"></i></button>
                            <button onclick="adjustChatFont(-1)" class="text-gray-400 hover:text-white px-1" title="Decrease Font Size"><i class="fas fa-minus text-xs"></i></button>
                            <button onclick="adjustChatFont(1)" class="text-gray-400 hover:text-white px-1" title="Increase Font Size"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                    </div>
                    
                    <div id="chatMessages" class="flex-grow overflow-y-auto p-4 space-y-4 min-h-0 text-sm">
                        <!-- Messages go here -->
                        <div class="text-center text-gray-500 mt-10">
                            <p>Starting conversation...</p>
                        </div>
                    </div>
                    
                    <div class="p-3 border-t border-gray-700 flex-shrink-0 bg-gray-800 z-10">
                        <form id="chatForm" onsubmit="sendMessage(event)" class="flex space-x-2">
                            <textarea id="chatInput" class="input-field flex-grow px-3 py-2 rounded resize-none h-12" placeholder="Ask AI to troubleshoot..." autocomplete="off" title="Type your message here"></textarea>
                            <button type="submit" class="btn-primary px-4 py-2 rounded h-12" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
                
                <!-- Pane 2: Terminal (7 cols ~ 58%) -->
                <div class="lg:col-span-7 flex flex-col card h-full bg-black overflow-hidden">
                    <div class="p-2 border-b border-gray-800 flex justify-between items-center bg-gray-900 flex-shrink-0">
                        <div class="flex items-center">
                            <h2 class="font-semibold text-sm mr-2"><i class="fas fa-terminal text-green-400 mr-1"></i>Terminal</h2>
                            <div class="flex space-x-1 mr-2">
                                <button onclick="adjustTermFont(-1)" class="text-gray-400 hover:text-white px-1" title="Decrease Font Size"><i class="fas fa-minus text-xs"></i></button>
                                <button onclick="adjustTermFont(1)" class="text-gray-400 hover:text-white px-1" title="Increase Font Size"><i class="fas fa-plus text-xs"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="termStatus" class="text-[10px] text-gray-500" title="Connection Status">Disconnected</span>
                            <button onclick="openServerModal()" class="btn-secondary px-2 py-1 text-[10px] rounded" title="Connect to Server">
                                <i class="fas fa-plug mr-1"></i>Connect
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow relative overflow-hidden h-full w-full">
                        <div id="terminal" class="absolute inset-0"></div>
                    </div>
                </div>
            </div>
        `;
    }

    // --- Chat Logic ---

    async function initChatSession(alertId) {
        try {
            // Load available providers first
            await loadAvailableProviders();

            // Try to find existing session for this alert
            let existingResponse = await apiCall(`/api/chat/sessions/by-alert/${alertId}`);

            if (existingResponse.ok) {
                // Reuse existing session
                currentSession = await existingResponse.json();
                currentSessionId = currentSession.id;
                console.log('Reusing existing chat session:', currentSessionId);
            } else {
                // Create new session only if none exists
                const createResponse = await apiCall('/api/chat/sessions', {
                    method: 'POST',
                    body: JSON.stringify({ alert_id: alertId })
                });

                if (!createResponse.ok) throw new Error('Failed to create chat session');

                currentSession = await createResponse.json();
                currentSessionId = currentSession.id;
                console.log('Created new chat session:', currentSessionId);
            }

            // Update model selector to show current model
            updateModelSelector();

            // Load message history (will have messages if reused session)
            await loadMessageHistory(currentSession.id);

            // Connect WebSocket
            connectChatWebSocket(currentSession.id);

        } catch (error) {
            console.error('Chat init failed:', error);
            showToast('Failed to initialize chat', 'error');
        }
    }

    async function loadAvailableProviders() {
        try {
            const response = await apiCall('/api/chat/providers');
            if (!response.ok) throw new Error('Failed to load providers');

            availableProviders = await response.json();

            const selector = document.getElementById('modelSelector');
            if (availableProviders.length === 0) {
                selector.innerHTML = '<option value="">No providers configured</option>';
                return;
            }

            selector.innerHTML = availableProviders.map(p =>
                `<option value="${p.id}">${p.provider_name}${p.is_default ? ' ‚≠ê' : ''}</option>`
            ).join('');

        } catch (error) {
            console.error('Failed to load providers:', error);
            const selector = document.getElementById('modelSelector');
            selector.innerHTML = '<option value="">Error loading models</option>';
        }
    }

    function updateModelSelector() {
        const selector = document.getElementById('modelSelector');
        if (currentSession && currentSession.llm_provider_id) {
            selector.value = currentSession.llm_provider_id;
        } else {
            // Select default provider
            const defaultProvider = availableProviders.find(p => p.is_default);
            if (defaultProvider) {
                selector.value = defaultProvider.id;
            }
        }
    }

    async function switchModel(providerId) {
        if (!currentSessionId || !providerId) return;

        try {
            const response = await apiCall(`/api/chat/sessions/${currentSessionId}/provider`, {
                method: 'PATCH',
                body: JSON.stringify({ provider_id: providerId })
            });

            if (!response.ok) throw new Error('Failed to switch model');

            const result = await response.json();
            showToast(`Switched to ${result.provider_name} - ${result.model_name}`, 'success');

            // Add system message to chat
            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'text-center text-xs text-gray-500 my-2 italic';
            msg.innerHTML = `<i class="fas fa-sync-alt mr-1"></i>Now using: ${result.provider_name} - ${result.model_name}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            // Update current session
            currentSession.llm_provider_id = providerId;

        } catch (error) {
            console.error('Failed to switch model:', error);
            showToast('Failed to switch model', 'error');
        }
    }

    async function loadMessageHistory(sessionId) {
        try {
            const response = await apiCall(`/api/chat/sessions/${sessionId}/messages`);
            if (!response.ok) throw new Error('Failed to load history');

            const messages = await response.json();
            const container = document.getElementById('chatMessages');
            container.innerHTML = ''; // Clear loading message

            if (messages.length === 0) {
                // Show welcome screen with suggestions
                showWelcomeScreen();
                return;
            }

            // Render existing messages
            messages.forEach(msg => {
                if (msg.role === 'user') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-end mb-3';
                    wrapper.innerHTML = `
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-3 max-w-xs lg:max-w-md text-sm text-white shadow-md">
                            ${escapeHtml(msg.content)}
                        </div>
                    `;
                    container.appendChild(wrapper);
                    lastMessageRole = 'user';
                } else if (msg.role === 'assistant') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-start w-full pr-2 mb-3';
                    wrapper.innerHTML = `
                        <div class="ai-message-wrapper w-full">
                            <div class="flex items-center mb-2">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-2">
                                    <i class="fas fa-robot text-white text-xs"></i>
                                </div>
                                <span class="text-xs text-gray-400">AI Assistant</span>
                            </div>
                            <div class="bg-gray-800/80 rounded-lg p-4 border border-purple-500/20 text-sm ai-message-content shadow-lg">
                                ${marked.parse(msg.content)}
                            </div>
                        </div>
                    `;
                    container.appendChild(wrapper);
                    addRunButtons(wrapper);
                    lastMessageRole = 'assistant';
                }
            });

            container.scrollTop = container.scrollHeight;

        } catch (error) {
            console.error('Failed to load chat history:', error);
            showWelcomeScreen();
        }
    }

    function showWelcomeScreen() {
        const container = document.getElementById('chatMessages');
        container.innerHTML = `
            <div class="text-center text-gray-400 mt-10">
                <i class="fas fa-robot text-4xl mb-3 text-purple-400"></i>
                <p class="mb-2 text-lg">üëã Hi! I'm your AI assistant.</p>
                <p class="text-sm text-gray-500 mb-4">Ask me to help troubleshoot this alert:</p>
                <div class="mt-3 space-y-2 text-left max-w-sm mx-auto">
                    <button onclick="sendSuggestion('Analyze this alert and tell me what might be wrong')"
                            class="w-full text-left bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm border border-gray-700 transition-colors">
                        <i class="fas fa-chart-line text-blue-400 mr-2"></i>Analyze this alert
                    </button>
                    <button onclick="sendSuggestion('What commands should I run to troubleshoot this issue?')"
                            class="w-full text-left bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm border border-gray-700 transition-colors">
                        <i class="fas fa-terminal text-green-400 mr-2"></i>Suggest troubleshooting commands
                    </button>
                    <button onclick="sendSuggestion('Show me where to find relevant logs for this alert')"
                            class="w-full text-left bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm border border-gray-700 transition-colors">
                        <i class="fas fa-file-alt text-yellow-400 mr-2"></i>Help me check logs
                    </button>
                    <button onclick="sendSuggestion('Explain this error in simple terms')"
                            class="w-full text-left bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded text-sm border border-gray-700 transition-colors">
                        <i class="fas fa-question-circle text-purple-400 mr-2"></i>Explain this error
                    </button>
                </div>
            </div>
        `;
    }

    function sendSuggestion(text) {
        const input = document.getElementById('chatInput');
        input.value = text;
        sendMessage(new Event('submit'));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function connectChatWebSocket(sessionId) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // We need a token for WS auth. For now, we'll assume the cookie is enough or pass a dummy if using cookie-based auth.
        // But our backend expects a token query param. We need to get the JWT.
        // Since we don't have a "get token" endpoint exposed to JS easily (it's HttpOnly cookie usually), 
        // we might need to adjust the backend to accept cookie or expose a token endpoint.
        // For this prototype, let's assume we stored the token in localStorage on login (common pattern).
        // If not, we need to fix auth. Let's assume localStorage for now.

        const token = localStorage.getItem('token'); // You need to ensure login saves this!
        if (!token) {
            document.getElementById('chatMessages').innerHTML = '<div class="text-red-400 text-center">Authentication error. Please login again.</div>';
            return;
        }

        chatSocket = new WebSocket(`${protocol}//${window.location.host}/ws/chat/${sessionId}?token=${token}`);

        chatSocket.onopen = () => {
            document.getElementById('chatStatus').textContent = 'Connected';
            document.getElementById('chatStatus').className = 'text-xs text-green-400';
            // Don't clear messages here - loadMessageHistory() already loaded them
        };

        chatSocket.onmessage = (event) => {
            const msg = event.data;
            if (msg === '[DONE]') return;

            // Append to last message or create new one
            appendAIMessage(msg);
        };

        chatSocket.onclose = () => {
            document.getElementById('chatStatus').textContent = 'Disconnected';
            document.getElementById('chatStatus').className = 'text-xs text-red-400';

            // Auto-reconnect after 3 seconds
            setTimeout(() => {
                if (currentSessionId) {
                    document.getElementById('chatStatus').textContent = 'Reconnecting...';
                    document.getElementById('chatStatus').className = 'text-xs text-yellow-400';
                    connectChatWebSocket(currentSessionId);
                }
            }, 3000);
        };
    }

    let lastMessageRole = null;
    let currentMessageDiv = null;

    function appendAIMessage(text) {
        removeTypingIndicator(); // Remove typing indicator when AI starts responding

        const container = document.getElementById('chatMessages');

        if (lastMessageRole !== 'assistant') {
            // Create new message bubble with Agent Mode styling
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start w-full pr-2';
            wrapper.innerHTML = `
                <div class="ai-message-wrapper w-full">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-2">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-400">AI Assistant</span>
                    </div>
                    <div class="bg-gray-800/80 rounded-lg p-4 border border-purple-500/20 text-sm ai-message-content shadow-lg"></div>
                </div>
            `;
            container.appendChild(wrapper);
            currentMessageDiv = wrapper.querySelector('.ai-message-content');
            lastMessageRole = 'assistant';
        }

        // Append text (we need to buffer and render markdown properly)
        // For streaming, simple appending works, but markdown rendering needs full text.
        // A simple hack: store full text in a data attribute and re-render marked.
        const currentText = currentMessageDiv.getAttribute('data-full-text') || '';
        const newText = currentText + text;
        currentMessageDiv.setAttribute('data-full-text', newText);
        currentMessageDiv.innerHTML = marked.parse(newText);

        // Add "Run" and "Copy" buttons to code blocks
        addRunButtons(currentMessageDiv);

        container.scrollTop = container.scrollHeight;
    }

    function appendUserMessage(text) {
        const container = document.getElementById('chatMessages');
        const wrapper = document.createElement('div');
        wrapper.className = 'flex justify-end';
        wrapper.innerHTML = `
            <div class="bg-blue-600 rounded-lg p-3 max-w-xs lg:max-w-md text-sm text-white">
                ${text}
            </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        lastMessageRole = 'user';
    }

    function getTerminalContent() {
        if (!term) return '';

        // Get all lines from the buffer
        const buffer = term.buffer.active;
        const lines = [];
        // Limit to last 100 lines to avoid token limits
        const start = Math.max(0, buffer.baseY + buffer.cursorY - 100);
        const end = buffer.baseY + buffer.cursorY + 1;

        for (let i = start; i < end; i++) {
            const line = buffer.getLine(i);
            if (line) {
                lines.push(line.translateToString(true));
            }
        }

        return lines.join('\n').trim();
    }

    function sendMessage(e) {
        e.preventDefault();

        // Clear pending analysis button if user types manually
        if (analysisButton) {
            analysisButton.remove();
            analysisButton = null;
        }

        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !chatSocket) return;

        appendUserMessage(text);
        showTypingIndicator(); // Show typing indicator

        // Inject terminal context if available
        const termContent = getTerminalContent();
        let finalMessage = text;

        if (termContent) {
            finalMessage += `\n\n[SYSTEM: The user has the following active terminal output. Use it if relevant to the query.]\n\`\`\`\n${termContent}\n\`\`\``;
        }

        chatSocket.send(finalMessage);
        input.value = '';
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        const indicator = document.createElement('div');
        indicator.id = 'typingIndicator';
        indicator.className = 'flex justify-start my-2';
        indicator.innerHTML = `
            <div class="bg-gray-700 rounded-lg px-4 py-3 flex items-center space-x-2">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <span class="text-gray-400 text-xs">AI is thinking...</span>
            </div>
        `;
        container.appendChild(indicator);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // Handle Enter key in textarea (Event Delegation)
    document.addEventListener('keydown', function (e) {
        if (e.target && e.target.id === 'chatInput') {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(e);
            }
        }
    });

    // Copy to clipboard with fallback for non-HTTPS
    function copyToClipboard(text) {
        // Try modern Clipboard API first (HTTPS/localhost only)
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
        } else {
            // Fallback for HTTP: use execCommand
            return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.top = '-9999px';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    if (successful) {
                        resolve();
                    } else {
                        reject(new Error('Copy command failed'));
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    reject(err);
                }
            });
        }
    }

    function addRunButtons(element) {
        // Find all pre code blocks that don't have buttons yet
        const blocks = element.querySelectorAll('pre code');
        blocks.forEach(block => {
            const pre = block.parentElement;
            if (pre.querySelector('.code-actions') || pre.closest('.command-card')) return; // Already processed

            // Detect language from class
            const lang = block.className.match(/language-(\w+)/)?.[1] || 'shell';
            const isShellCommand = ['shell', 'bash', 'sh', 'zsh', 'fish', ''].includes(lang);
            const command = block.innerText.trim();

            if (isShellCommand && command) {
                // Create approval card (Agent Mode style)
                createCommandCard(pre, command);
            } else {
                // Non-shell code: just add copy button
                addCopyButton(pre, block, lang);
            }
        });
    }

    function createCommandCard(pre, command) {
        // Create wrapper that replaces the plain pre block
        const cardId = 'cmd-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        const card = document.createElement('div');
        card.id = cardId;
        card.className = 'command-card bg-gradient-to-r from-gray-800 to-gray-800/80 rounded-lg border border-purple-500/30 my-3 overflow-hidden';
        card.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-900/50 border-b border-gray-700">
                <div class="flex items-center text-xs text-gray-400">
                    <i class="fas fa-terminal text-green-400 mr-2"></i>
                    <span>Command</span>
                </div>
                <div class="flex space-x-1">
                    <button class="copy-cmd-btn bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded transition-colors" title="Copy">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="p-3">
                <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 whitespace-pre-wrap break-all">${escapeHtml(command)}</div>
            </div>
            <div class="cmd-actions flex space-x-2 px-3 pb-3">
                <button class="run-cmd-btn flex-1 bg-green-600 hover:bg-green-500 text-white text-sm px-4 py-2 rounded font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-play mr-2"></i>Run in Terminal
                </button>
                <button class="skip-cmd-btn bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded font-medium transition-colors" title="Skip this command">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
            <div class="cmd-output hidden"></div>
        `;

        // Replace pre with card
        pre.parentNode.replaceChild(card, pre);

        // Add event listeners
        const copyBtn = card.querySelector('.copy-cmd-btn');
        const runBtn = card.querySelector('.run-cmd-btn');
        const skipBtn = card.querySelector('.skip-cmd-btn');

        copyBtn.onclick = () => {
            copyToClipboard(command).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        };

        runBtn.onclick = () => {
            executeCommandWithOutput(cardId, command);
        };

        skipBtn.onclick = () => {
            dismissCommandCard(cardId);
        };
    }

    function addCopyButton(pre, block, lang) {
        // Simple copy button for non-shell code
        const btnContainer = document.createElement('div');
        btnContainer.className = 'code-actions absolute top-1 right-1 flex space-x-1 z-10';

        const langBadge = document.createElement('span');
        langBadge.className = 'bg-gray-800 text-gray-400 text-[10px] px-1.5 py-0.5 rounded';
        langBadge.textContent = lang;
        btnContainer.appendChild(langBadge);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded transition-colors';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.title = 'Copy code';
        copyBtn.onclick = () => {
            copyToClipboard(block.innerText.trim()).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        };
        btnContainer.appendChild(copyBtn);

        pre.className += ' relative bg-gray-900 rounded-md p-3 my-2 border border-gray-700 whitespace-pre-wrap break-words overflow-x-auto';
        pre.appendChild(btnContainer);
    }

    async function executeCommandWithOutput(cardId, command) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Check if we have a server connection (via terminal or direct)
        if (!currentServerId) {
            showToast('No server connected. Connect to a server first.', 'error');
            return;
        }

        // Update card to "executing" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center justify-center text-blue-400 text-sm py-2">
                <i class="fas fa-spinner fa-spin mr-2"></i>Executing via SSH...
            </div>
        `;

        // Update header to show running state
        const headerBadge = card.querySelector('.text-green-400');
        if (headerBadge) {
            headerBadge.className = 'fas fa-cog fa-spin text-blue-400 mr-2';
        }

        try {
            // Execute command via SSH API (clean output, no terminal escape codes)
            const result = await apiCall(`/api/servers/${currentServerId}/execute`, {
                method: 'POST',
                body: JSON.stringify({ command: command, timeout: 60 })
            });

            // Also show in terminal for visual feedback (optional)
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                terminalSocket.send(command + '\r');
            }

            // Use the clean output from SSH
            const output = result.success
                ? (result.stdout || result.stderr || 'Command completed successfully')
                : (result.error || result.stderr || 'Command failed');

            showCommandOutputInCard(cardId, command, output, result.success, result.exit_code);

        } catch (error) {
            console.error('Command execution failed:', error);

            // Fallback to terminal-based execution if API fails
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                actionsDiv.innerHTML = `
                    <div class="flex-1 flex items-center justify-center text-yellow-400 text-sm py-2">
                        <i class="fas fa-terminal mr-2"></i>Running in terminal (fallback)...
                    </div>
                `;

                const beforeLineCount = term.buffer.active.baseY + term.buffer.active.cursorY;
                terminalSocket.send(command + '\r');
                term.focus();

                setTimeout(() => {
                    const output = getCommandOutput(beforeLineCount, command);
                    showCommandOutputInCard(cardId, command, output, true, null);
                }, 2500);
            } else {
                showToast('Command execution failed: ' + error.message, 'error');
                actionsDiv.innerHTML = `
                    <div class="flex-1 flex items-center text-red-400 text-sm py-2">
                        <i class="fas fa-times-circle mr-2"></i>Failed
                    </div>
                `;
            }
        }
    }

    function getCommandOutput(beforeLineCount, command) {
        // Get only the lines that were added after the command was executed
        const buffer = term.buffer.active;
        const currentLineCount = buffer.baseY + buffer.cursorY;

        const lines = [];
        // Start from where we were before executing, skip 1 line (the command itself)
        const startLine = Math.max(0, beforeLineCount + 1);
        const endLine = currentLineCount + 1;

        for (let i = startLine; i < endLine; i++) {
            const line = buffer.getLine(i);
            if (line) {
                const text = line.translateToString(true);
                // Skip empty lines and the command prompt line at the end
                if (text.trim() && !text.match(/^\s*\$\s*$/)) {
                    lines.push(text);
                }
            }
        }

        // Remove the last line if it's just a prompt
        const lastLine = lines[lines.length - 1];
        if (lastLine && (lastLine.includes('$') || lastLine.includes('#')) && lastLine.trim().endsWith('$')) {
            lines.pop();
        }

        return lines.join('\n').trim();
    }

    function showCommandOutputInCard(cardId, command, output, success = true, exitCode = null) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Determine status based on success flag
        const isSuccess = success && (exitCode === null || exitCode === 0);
        const statusText = isSuccess
            ? (exitCode !== null ? `Executed (exit code: ${exitCode})` : 'Executed successfully')
            : `Failed (exit code: ${exitCode !== null ? exitCode : 'unknown'})`;
        const statusColor = isSuccess ? 'text-green-400' : 'text-red-400';
        const statusIcon = isSuccess ? 'fa-check-circle' : 'fa-times-circle';

        // Update card to "executed" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center ${statusColor} text-sm py-2">
                <i class="fas ${statusIcon} mr-2"></i>${statusText}
            </div>
            <button class="toggle-output-btn text-gray-400 hover:text-white text-sm px-3 py-2 transition-colors" title="Toggle output">
                <i class="fas fa-chevron-down"></i>
            </button>
        `;

        // Update header icon
        const headerIcon = card.querySelector('.fa-cog, .fa-terminal');
        if (headerIcon) {
            headerIcon.className = `fas ${statusIcon} ${statusColor} mr-2`;
        }

        // Add output section
        const outputDiv = card.querySelector('.cmd-output');
        if (outputDiv && output) {
            // Truncate very long output
            let displayOutput = output;
            if (displayOutput.length > 3000) {
                displayOutput = displayOutput.substring(0, 1500) + '\n... [truncated] ...\n' + displayOutput.substring(displayOutput.length - 1500);
            }

            outputDiv.innerHTML = `
                <div class="border-t border-gray-700 p-3 bg-gray-900/50">
                    <div class="text-xs text-gray-400 mb-2 flex items-center">
                        <i class="fas fa-terminal mr-1"></i>Output
                    </div>
                    <pre class="bg-gray-950 rounded p-3 text-xs text-gray-300 overflow-x-auto max-h-60 overflow-y-auto whitespace-pre-wrap">${escapeHtml(displayOutput)}</pre>
                </div>
            `;
            outputDiv.classList.remove('hidden');
        }

        // Toggle output visibility
        const toggleBtn = card.querySelector('.toggle-output-btn');
        if (toggleBtn && outputDiv) {
            toggleBtn.onclick = () => {
                outputDiv.classList.toggle('hidden');
                const icon = toggleBtn.querySelector('i');
                icon.className = outputDiv.classList.contains('hidden') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            };
        }

        // Trigger auto-analyze after showing output
        triggerAutoAnalyze(command, output);
    }

    function dismissCommandCard(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Update card to "skipped" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center text-gray-500 text-sm py-2">
                <i class="fas fa-forward mr-2"></i>Skipped
            </div>
        `;

        // Dim the card
        card.className = card.className.replace('border-purple-500/30', 'border-gray-700/50');
        card.style.opacity = '0.6';
    }

    function triggerAutoAnalyze(command, output) {
        // Only analyze if we have actual output
        if (!output || !output.trim()) {
            return;
        }

        // Small delay then auto-analyze
        setTimeout(() => {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                // Send only the command and its output, not entire terminal buffer
                const analysisRequest = `[SYSTEM: The user executed the following command:\n\`\`\`\n${command}\n\`\`\`\n\nHere is the output:\n\`\`\`\n${output}\n\`\`\`\n\nPlease analyze this output and suggest the next step.]`;
                chatSocket.send(analysisRequest);

                // Show analyzing indicator
                const container = document.getElementById('chatMessages');
                const note = document.createElement('div');
                note.className = 'text-center text-xs text-gray-500 my-2';
                note.innerHTML = '<i class="fas fa-magic mr-1"></i>Analyzing output...';
                container.appendChild(note);
                container.scrollTop = container.scrollHeight;

                showTypingIndicator();
            }
        }, 500);
    }

    // --- Terminal Logic ---

    function initTerminal() {
        if (term) return;

        term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#ffffff'
            },
            fontSize: 12,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        term.onData(data => {
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                terminalSocket.send(data);
            }
        });
    }

    async function openServerModal() {
        const modal = document.getElementById('serverModal');
        const list = document.getElementById('serverList');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        try {
            const response = await apiCall('/api/servers');
            if (!response.ok) throw new Error('Failed to load servers');

            const servers = await response.json();

            if (servers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm p-2">No servers configured.</p>';
                return;
            }

            list.innerHTML = servers.map(server => `
                <div class="p-3 bg-gray-800 rounded cursor-pointer hover:bg-gray-700 transition-colors" onclick="connectTerminal('${server.id}')">
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-blue-400">${server.name}</div>
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded">${server.environment}</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        <i class="fas fa-server mr-1"></i>${server.username}@${server.hostname}:${server.port}
                    </div>
                </div>
            `).join('');

        } catch (error) {
            list.innerHTML = `<p class="text-red-400 text-sm p-2">Error: ${error.message}</p>`;
        }
    }

    function closeServerModal() {
        const modal = document.getElementById('serverModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function connectTerminal(serverId) {
        closeServerModal();
        initTerminal();

        // Store server ID for Agent Mode
        currentServerId = serverId;

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const token = localStorage.getItem('token');

        if (terminalSocket) {
            terminalSocket.close();
        }

        terminalSocket = new WebSocket(`${protocol}//${window.location.host}/ws/terminal/${serverId}?token=${token}&cols=${term.cols}&rows=${term.rows}`);

        // Loading state
        document.getElementById('termStatus').textContent = 'Connecting...';
        document.getElementById('termStatus').className = 'text-xs text-yellow-400';

        terminalSocket.onopen = () => {
            document.getElementById('termStatus').textContent = 'Connected';
            document.getElementById('termStatus').className = 'text-xs text-green-400';
            term.reset();
            term.write('\r\n\x1b[32mConnected to server...\x1b[0m\r\n');
        };

        terminalSocket.onmessage = (event) => {
            const data = event.data;
            // Filter out control messages (ping, pong, resize confirmations, etc.)
            if (data.startsWith('{"type":')) {
                try {
                    const msg = JSON.parse(data);
                    // Handle control messages silently
                    if (msg.type === 'ping' || msg.type === 'pong') {
                        return; // Ignore ping/pong messages
                    }
                    if (msg.type === 'error') {
                        term.write(`\r\n\x1b[31mError: ${msg.message}\x1b[0m\r\n`);
                        return;
                    }
                    // Unknown control message, ignore
                    return;
                } catch (e) {
                    // Not valid JSON, treat as terminal data
                }
            }
            term.write(data);
        };

        terminalSocket.onclose = () => {
            document.getElementById('termStatus').textContent = 'Disconnected';
            document.getElementById('termStatus').className = 'text-xs text-red-400';
            term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
        };
    }

    let analysisButton = null;
    let autoAnalyzeTimer = null;

    function runCommand(cmd) {
        if (!terminalSocket || terminalSocket.readyState !== WebSocket.OPEN) {
            showToast('Terminal not connected. Connect to a server first.', 'error');
            return;
        }

        // Clear any pending auto-analyze
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }

        // Send command with newline to auto-execute
        terminalSocket.send(cmd + '\r');
        term.focus();

        // Show in chat
        const container = document.getElementById('chatMessages');
        const runMsg = document.createElement('div');
        runMsg.className = 'flex justify-end my-2';
        runMsg.innerHTML = `
            <div class="bg-gray-800 border border-green-600/50 rounded-lg px-3 py-2 text-xs text-green-300 font-mono whitespace-pre-wrap break-all max-w-full">
                <i class="fas fa-play text-green-400 mr-2"></i><span class="text-gray-400">Executing:</span> ${escapeHtml(cmd)}
            </div>`;

        // If button exists, remove it first so we can move it to bottom
        if (analysisButton) {
            analysisButton.remove();
        }

        container.appendChild(runMsg);

        // Add countdown/analyze button
        analysisButton = document.createElement('div');
        analysisButton.className = 'flex justify-center my-4 fade-in';
        analysisButton.id = 'analysisCountdown';

        let countdown = 3;
        const updateCountdown = () => {
            analysisButton.innerHTML = `
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>Auto-analyzing in ${countdown}s...
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="triggerAnalysis()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-full shadow-lg flex items-center transition-all">
                            <i class="fas fa-magic mr-2"></i>Analyze Now
                        </button>
                        <button onclick="cancelAutoAnalyze()" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded-full">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        updateCountdown();
        container.appendChild(analysisButton);
        container.scrollTop = container.scrollHeight;

        // Auto-analyze countdown
        const tick = () => {
            countdown--;
            if (countdown <= 0) {
                triggerAnalysis();
            } else {
                updateCountdown();
                autoAnalyzeTimer = setTimeout(tick, 1000);
            }
        };
        autoAnalyzeTimer = setTimeout(tick, 1000);

        // Reset last message role to force new bubble for next AI response
        lastMessageRole = 'system';
    }

    function cancelAutoAnalyze() {
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }
        if (analysisButton) {
            analysisButton.innerHTML = `
                <button onclick="triggerAnalysis()" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-6 py-2 rounded-full shadow-lg flex items-center transition-all">
                    <i class="fas fa-magic mr-2"></i>Analyze Later
                </button>
            `;
        }
    }

    function triggerAnalysis() {
        // Clear auto-analyze timer if running
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }

        if (analysisButton) {
            analysisButton.remove();
            analysisButton = null;
        }

        const container = document.getElementById('chatMessages');
        const note = document.createElement('div');
        note.className = 'text-center text-xs text-gray-500 my-2';
        note.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Reading terminal & analyzing...';
        container.appendChild(note);
        container.scrollTop = container.scrollHeight;

        // Small delay to ensure terminal buffer is updated
        setTimeout(() => {
            const termContent = getTerminalContent();
            if (termContent && chatSocket) {
                const analysisRequest = `[SYSTEM: The user has run one or more commands. Here is the current terminal output:\n\`\`\`\n${termContent}\n\`\`\`\nPlease analyze this output and suggest the next step.]`;
                chatSocket.send(analysisRequest);
                note.innerHTML = '<i class="fas fa-magic mr-1"></i>Analyzing terminal output...';
            } else {
                note.remove();
            }
        }, 500);
    }

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
        // Ctrl+L - Clear chat
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            clearChat();
        }

        // Ctrl+K - Focus chat input
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            if (input) input.focus();
        }

        // Ctrl+` - Focus terminal
        if (e.ctrlKey && e.key === '`') {
            e.preventDefault();
            if (term) term.focus();
        }

        // Escape - Clear chat input
        if (e.key === 'Escape') {
            const input = document.getElementById('chatInput');
            if (input && document.activeElement === input) {
                input.value = '';
                input.blur();
            }
        }
    });

    function clearChat() {
        if (!confirm('Clear chat history? This will only clear the display, not the stored messages.')) {
            return;
        }

        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        showWelcomeScreen();
        lastMessageRole = null;
        currentMessageDiv = null;

        showToast('Chat cleared', 'success');
    }

    // --- Init ---
    // Use window.load to wait for ALL resources (including marked.js from CDN)
    window.addEventListener('load', function () {
        // Double-check marked is loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js failed to load from CDN');
            showToast('Failed to load chat library', 'error');
            return;
        }
        console.log('All resources loaded, initializing chat...');
        loadAlert();
    });

    // Handle window resize for terminal
    window.addEventListener('resize', () => {
        if (fitAddon) fitAddon.fit();
    });

    // ============================================
    // AGENT MODE
    // ============================================

    let agentSocket = null;
    let currentAgentSession = null;
    let currentServerId = null;
    let isAgentMode = false;

    function openAgentModal() {
        // Check if terminal is connected
        if (!terminalSocket || terminalSocket.readyState !== WebSocket.OPEN) {
            showToast('Please connect to a server first', 'error');
            return;
        }

        const modal = document.getElementById('agentModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('agentGoal').focus();
    }

    function closeAgentModal() {
        const modal = document.getElementById('agentModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('agentGoal').value = '';
        document.getElementById('autoApprove').checked = false;
    }

    async function startAgent() {
        const goal = document.getElementById('agentGoal').value.trim();
        const autoApprove = document.getElementById('autoApprove').checked;

        if (!goal) {
            showToast('Please enter a goal for the agent', 'error');
            return;
        }

        if (!currentServerId) {
            showToast('Please connect to a server first', 'error');
            return;
        }

        try {
            const response = await apiCall('/api/agent/start', {
                method: 'POST',
                body: JSON.stringify({
                    chat_session_id: currentSessionId,
                    server_id: currentServerId,
                    goal: goal,
                    auto_approve: autoApprove
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to start agent');
            }

            currentAgentSession = await response.json();
            closeAgentModal();
            enterAgentMode(goal);
            connectAgentWebSocket(currentAgentSession.id);

        } catch (error) {
            console.error('Failed to start agent:', error);
            showToast(error.message || 'Failed to start agent', 'error');
        }
    }

    function enterAgentMode(goal) {
        isAgentMode = true;

        // Update UI
        const container = document.getElementById('chatMessages');
        container.innerHTML = `
            <div id="agentHeader" class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 mb-4 border border-purple-500/30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3 animate-pulse">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="text-sm font-semibold text-white">Agent Mode Active</div>
                            <div class="text-xs text-gray-400 truncate max-w-xs" title="${escapeHtml(goal)}">${escapeHtml(goal)}</div>
                        </div>
                    </div>
                    <button id="agentStopBtn" onclick="stopAgent()" class="text-red-400 hover:text-red-300 text-xs px-3 py-1 border border-red-500/30 rounded hover:bg-red-500/10 transition-colors">
                        <i class="fas fa-stop mr-1"></i>Stop
                    </button>
                </div>
                <div class="mt-3 flex items-center text-xs">
                    <span id="agentStatusBadge" class="px-2 py-1 rounded bg-purple-600/50 text-purple-200 mr-2">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Starting...
                    </span>
                    <span class="text-gray-400">Step <span id="agentStepNum">0</span> of <span id="agentMaxSteps">20</span></span>
                </div>
            </div>
            <div id="agentSteps" class="space-y-4"></div>
            <div id="agentApprovalPanel" class="hidden"></div>
        `;

        // Hide normal chat input, show agent input
        document.getElementById('chatForm').style.display = 'none';

        // Update agent button
        const agentBtn = document.getElementById('agentModeBtn');
        if (agentBtn) {
            agentBtn.classList.remove('text-gray-400', 'hover:text-purple-400');
            agentBtn.classList.add('text-purple-400', 'animate-pulse');
        }
    }

    function exitAgentMode() {
        isAgentMode = false;
        currentAgentSession = null;

        if (agentSocket) {
            agentSocket.close();
            agentSocket = null;
        }

        // Restore normal chat
        document.getElementById('chatForm').style.display = 'flex';

        // Reset agent button
        const agentBtn = document.getElementById('agentModeBtn');
        if (agentBtn) {
            agentBtn.classList.remove('text-purple-400', 'animate-pulse');
            agentBtn.classList.add('text-gray-400', 'hover:text-purple-400');
        }

        // Reload chat history
        if (currentSessionId) {
            loadMessageHistory(currentSessionId);
        }
    }

    function connectAgentWebSocket(sessionId) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const token = localStorage.getItem('token');

        if (agentSocket) {
            agentSocket.close();
        }

        agentSocket = new WebSocket(`${protocol}//${window.location.host}/ws/agent/${sessionId}?token=${token}`);

        agentSocket.onopen = () => {
            console.log('Agent WebSocket connected');
            updateAgentStatus('thinking', 'Analyzing...');
        };

        agentSocket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleAgentMessage(data);
            } catch (e) {
                console.error('Failed to parse agent message:', e);
            }
        };

        agentSocket.onclose = () => {
            console.log('Agent WebSocket closed');
        };

        agentSocket.onerror = (error) => {
            console.error('Agent WebSocket error:', error);
            showToast('Agent connection error', 'error');
        };
    }

    function handleAgentMessage(data) {
        console.log('Agent message:', data.type, data);

        switch (data.type) {
            case 'connected':
                updateAgentStatus('thinking', 'Analyzing goal...');
                break;

            case 'status_changed':
                updateAgentStatusFromServer(data.status);
                break;

            case 'step_created':
                addAgentStep(data.step);
                break;

            case 'step_updated':
                updateAgentStep(data.step);
                break;

            case 'complete':
                handleAgentComplete(data);
                break;

            case 'error':
                showToast(data.message || 'Agent error', 'error');
                break;
        }
    }

    function updateAgentStatus(status, text) {
        const badge = document.getElementById('agentStatusBadge');
        if (!badge) return;

        const statusMap = {
            'thinking': { icon: 'fa-brain', color: 'bg-purple-600/50 text-purple-200', text: text || 'Thinking...' },
            'awaiting_approval': { icon: 'fa-pause-circle', color: 'bg-yellow-600/50 text-yellow-200', text: 'Awaiting approval' },
            'executing': { icon: 'fa-cog fa-spin', color: 'bg-blue-600/50 text-blue-200', text: 'Executing...' },
            'completed': { icon: 'fa-check-circle', color: 'bg-green-600/50 text-green-200', text: 'Completed' },
            'failed': { icon: 'fa-times-circle', color: 'bg-red-600/50 text-red-200', text: 'Failed' },
            'stopped': { icon: 'fa-stop-circle', color: 'bg-gray-600/50 text-gray-200', text: 'Stopped' }
        };

        const config = statusMap[status] || statusMap.thinking;
        badge.className = `px-2 py-1 rounded ${config.color} mr-2`;
        badge.innerHTML = `<i class="fas ${config.icon} mr-1"></i>${config.text}`;
    }

    function updateAgentStatusFromServer(status) {
        updateAgentStatus(status);

        if (status === 'completed' || status === 'failed' || status === 'stopped') {
            // Stop the pulsing
            const agentBtn = document.getElementById('agentModeBtn');
            if (agentBtn) {
                agentBtn.classList.remove('animate-pulse');
            }
        }
    }

    function addAgentStep(step) {
        const container = document.getElementById('agentSteps');
        if (!container) return;

        // Update step counter
        const stepNum = document.getElementById('agentStepNum');
        if (stepNum) stepNum.textContent = step.step_number;

        const stepEl = document.createElement('div');
        stepEl.id = `agent-step-${step.id}`;
        stepEl.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700';

        if (step.step_type === 'command') {
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-blue-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-terminal text-blue-400 text-xs"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="text-xs text-gray-400 mb-1">Step ${step.step_number} - Command</div>
                        <div class="bg-gray-900 rounded p-2 font-mono text-sm text-green-400 break-all">${escapeHtml(step.content)}</div>
                        ${step.reasoning ? `<div class="text-xs text-gray-500 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>${escapeHtml(step.reasoning)}</div>` : ''}
                        <div id="step-output-${step.id}" class="mt-2 hidden">
                            <div class="text-xs text-gray-400 mb-1">Output:</div>
                            <pre class="bg-gray-900 rounded p-2 text-xs text-gray-300 overflow-x-auto max-h-40 overflow-y-auto"></pre>
                        </div>
                        <div id="step-status-${step.id}" class="mt-2 flex items-center text-xs text-gray-400">
                            <i class="fas fa-clock mr-1"></i>Pending...
                        </div>
                    </div>
                </div>
            `;

            // Show approval panel if pending
            if (step.status === 'pending') {
                showApprovalPanel(step);
            }

        } else if (step.step_type === 'complete') {
            stepEl.className = 'bg-green-900/30 rounded-lg p-4 border border-green-500/30';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-green-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-check text-green-400 text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs text-green-400 mb-1 font-semibold">Goal Achieved!</div>
                        <div class="text-sm text-gray-300">${marked.parse(step.content)}</div>
                    </div>
                </div>
            `;

        } else if (step.step_type === 'failed') {
            stepEl.className = 'bg-red-900/30 rounded-lg p-4 border border-red-500/30';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-red-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-times text-red-400 text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs text-red-400 mb-1 font-semibold">Agent Failed</div>
                        <div class="text-sm text-gray-300">${escapeHtml(step.content)}</div>
                    </div>
                </div>
            `;

        } else if (step.step_type === 'question') {
            stepEl.className = 'bg-yellow-900/30 rounded-lg p-4 border border-yellow-500/30';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-yellow-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-question text-yellow-400 text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs text-yellow-400 mb-1">Question from Agent</div>
                        <div class="text-sm text-gray-300 mb-3">${escapeHtml(step.content)}</div>
                        <div class="flex space-x-2">
                            <input type="text" id="agent-answer-${step.id}" class="input-field flex-grow px-3 py-2 rounded text-sm" placeholder="Your answer...">
                            <button onclick="answerAgentQuestion('${step.id}')" class="btn-primary px-4 py-2 rounded text-sm">Send</button>
                        </div>
                    </div>
                </div>
            `;
        }

        container.appendChild(stepEl);
        container.scrollTop = container.scrollHeight;
    }

    function updateAgentStep(step) {
        const outputDiv = document.getElementById(`step-output-${step.id}`);
        const statusDiv = document.getElementById(`step-status-${step.id}`);

        if (step.output && outputDiv) {
            outputDiv.classList.remove('hidden');
            const pre = outputDiv.querySelector('pre');
            if (pre) {
                // Truncate very long output
                let output = step.output;
                if (output.length > 5000) {
                    output = output.substring(0, 2500) + '\n... [truncated] ...\n' + output.substring(output.length - 2500);
                }
                pre.textContent = output;
            }
        }

        if (statusDiv) {
            if (step.status === 'executed') {
                const exitCode = step.exit_code || 0;
                if (exitCode === 0) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-1"></i>Executed successfully';
                    statusDiv.className = 'mt-2 flex items-center text-xs text-green-400';
                } else {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-400 mr-1"></i>Exited with code ${exitCode}`;
                    statusDiv.className = 'mt-2 flex items-center text-xs text-yellow-400';
                }
            } else if (step.status === 'rejected') {
                statusDiv.innerHTML = '<i class="fas fa-ban text-gray-400 mr-1"></i>Skipped by user';
                statusDiv.className = 'mt-2 flex items-center text-xs text-gray-400';
            } else if (step.status === 'failed') {
                statusDiv.innerHTML = '<i class="fas fa-times-circle text-red-400 mr-1"></i>Failed';
                statusDiv.className = 'mt-2 flex items-center text-xs text-red-400';
            }
        }

        // Hide approval panel
        hideApprovalPanel();
    }

    function showApprovalPanel(step) {
        updateAgentStatus('awaiting_approval');

        const panel = document.getElementById('agentApprovalPanel');
        if (!panel) return;

        panel.className = 'bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded-lg p-4 mt-4 border border-yellow-500/30';
        panel.innerHTML = `
            <div class="flex items-center mb-3">
                <i class="fas fa-shield-alt text-yellow-400 mr-2"></i>
                <span class="text-sm font-semibold text-yellow-200">Approval Required</span>
            </div>
            <div class="text-xs text-gray-400 mb-2">The agent wants to execute:</div>
            <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 mb-3 break-all">${escapeHtml(step.content)}</div>
            ${step.reasoning ? `<div class="text-xs text-gray-400 mb-3"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>${escapeHtml(step.reasoning)}</div>` : ''}
            <div class="flex space-x-2">
                <button onclick="approveAgentStep()" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-medium transition-colors">
                    <i class="fas fa-check mr-2"></i>Approve & Run
                </button>
                <button onclick="rejectAgentStep()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded font-medium transition-colors">
                    <i class="fas fa-forward mr-2"></i>Skip
                </button>
            </div>
        `;

        // Scroll to show panel
        const container = document.getElementById('chatMessages');
        if (container) container.scrollTop = container.scrollHeight;
    }

    function hideApprovalPanel() {
        const panel = document.getElementById('agentApprovalPanel');
        if (panel) {
            panel.className = 'hidden';
            panel.innerHTML = '';
        }
    }

    async function approveAgentStep() {
        if (!currentAgentSession) return;

        try {
            // Send via WebSocket for faster response
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'approve' }));
            } else {
                // Fallback to REST API
                await apiCall(`/api/agent/${currentAgentSession.id}/approve`, { method: 'POST' });
            }

            hideApprovalPanel();
            updateAgentStatus('executing', 'Running command...');

        } catch (error) {
            console.error('Failed to approve step:', error);
            showToast('Failed to approve step', 'error');
        }
    }

    async function rejectAgentStep() {
        if (!currentAgentSession) return;

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'reject' }));
            } else {
                await apiCall(`/api/agent/${currentAgentSession.id}/reject`, { method: 'POST' });
            }

            hideApprovalPanel();
            updateAgentStatus('thinking', 'Agent is reconsidering...');

        } catch (error) {
            console.error('Failed to reject step:', error);
            showToast('Failed to skip step', 'error');
        }
    }

    async function answerAgentQuestion(stepId) {
        const input = document.getElementById(`agent-answer-${stepId}`);
        if (!input || !input.value.trim()) return;

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'answer', answer: input.value.trim() }));
            } else {
                await apiCall(`/api/agent/${currentAgentSession.id}/answer`, {
                    method: 'POST',
                    body: JSON.stringify({ answer: input.value.trim() })
                });
            }

            input.disabled = true;
            input.parentElement.innerHTML = `<div class="text-sm text-gray-400"><i class="fas fa-check text-green-400 mr-1"></i>Answered: ${escapeHtml(input.value)}</div>`;

        } catch (error) {
            console.error('Failed to send answer:', error);
            showToast('Failed to send answer', 'error');
        }
    }

    async function stopAgent() {
        if (!currentAgentSession) {
            exitAgentMode();
            return;
        }

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'stop' }));
            }

            await apiCall(`/api/agent/${currentAgentSession.id}/stop`, { method: 'POST' });

            updateAgentStatus('stopped');
            showToast('Agent stopped', 'info');

            // Add a button to exit agent mode
            const container = document.getElementById('agentSteps');
            if (container) {
                const exitBtn = document.createElement('div');
                exitBtn.className = 'text-center mt-4';
                exitBtn.innerHTML = `
                    <button onclick="exitAgentMode()" class="btn-secondary px-4 py-2 rounded">
                        <i class="fas fa-arrow-left mr-2"></i>Return to Chat
                    </button>
                `;
                container.appendChild(exitBtn);
            }

        } catch (error) {
            console.error('Failed to stop agent:', error);
            showToast('Failed to stop agent', 'error');
        }
    }

    function handleAgentComplete(data) {
        updateAgentStatus(data.status, data.status === 'completed' ? 'Goal achieved!' : 'Failed');

        // Stop the pulsing animation
        const robotIcon = document.querySelector('#agentHeader .animate-pulse');
        if (robotIcon) {
            robotIcon.classList.remove('animate-pulse');
        }

        // Replace Stop button with Return to Chat button in header
        const stopBtn = document.getElementById('agentStopBtn');
        if (stopBtn) {
            stopBtn.id = 'agentReturnBtn'; // Change ID so we don't try to replace twice
            stopBtn.className = 'text-blue-400 hover:text-blue-300 text-xs px-3 py-1 border border-blue-500/30 rounded hover:bg-blue-500/10 transition-colors';
            stopBtn.onclick = exitAgentMode;
            stopBtn.innerHTML = '<i class="fas fa-arrow-left mr-1"></i>Return to Chat';
        }

        // Also add exit button at bottom for visibility
        const container = document.getElementById('agentSteps');
        if (container) {
            const exitBtn = document.createElement('div');
            exitBtn.className = 'text-center mt-4';
            exitBtn.innerHTML = `
                <button onclick="exitAgentMode()" class="btn-primary px-4 py-2 rounded">
                    <i class="fas fa-arrow-left mr-2"></i>Return to Chat
                </button>
            `;
            container.appendChild(exitBtn);
        }

        if (data.status === 'completed') {
            showToast('Agent completed the goal!', 'success');
        } else {
            showToast(data.message || 'Agent failed', 'error');
        }
    }

    // Add keyboard shortcut for Agent Mode
    document.addEventListener('keydown', (e) => {
        // Ctrl+Shift+A - Open Agent Mode
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            if (!isAgentMode) {
                openAgentModal();
            } else {
                stopAgent();
            }
        }
    });

</script>
{% endblock %}