{% extends "base.html" %}
{% set active_page = 'alerts' %}

{% block title %}Alert Details - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<a href="/alerts" class="hover:text-blue-400 transition-colors">Alerts</a>
<span class="mx-2">/</span>
<span class="text-gray-200">Details</span>
{% endblock %}

{% block header_title %}
<div class="flex items-center gap-3">
    <i class="fas fa-exclamation-triangle text-pink-400"></i>
    <span id="header_alert_name" class="text-sm font-semibold text-white tracking-tight truncate">Loading
        alert...</span>
</div>
{% endblock %}

{% block head %}
<style>
    /* Alert-specific badge and status styles (aligned with runbooks/alerts) */
    .badge-critical { background-color: #ff5286; color: white; padding: 2px 8px; border-radius: 2px; font-size: 0.75rem; font-weight: 500; }
    .badge-warning { background-color: #eb7b18; color: white; padding: 2px 8px; border-radius: 2px; font-size: 0.75rem; font-weight: 500; }
    .badge-info { background-color: #3d71d9; color: white; padding: 2px 8px; border-radius: 2px; font-size: 0.75rem; font-weight: 500; }
    .badge-other { background-color: #6e9fff; color: #111217; padding: 2px 8px; border-radius: 2px; font-size: 0.75rem; font-weight: 500; }
    .status-firing { color: #ff5286; }
    .status-resolved { color: #1a7f4b; }
    .status-acknowledged { color: #6e9fff; }
    /* Alert detail cards - compact, aligned with runbooks/applications */
    .alert-detail-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .alert-detail-tabs { display: flex; gap: 16px; border-bottom: 1px solid #e2e8f0; margin-bottom: 0; padding-bottom: 0; }
    .alert-detail-tab { background: none; border: none; padding: 8px 2px; font-size: 13px; font-weight: 500; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .alert-detail-tab:hover { color: #1e293b; }
    .alert-detail-tab.active { color: #3b82f6; border-bottom-color: #3b82f6; font-weight: 600; }
    /* Compact analysis section */
    .alert-analysis-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .alert-detail-card .ts-chat-messages { padding: 20px 16px; gap: 14px; }
    .alert-detail-card .ts-chat-input-container { padding: 10px 14px 14px; }
</style>
{% endblock %}

{% block header_actions %}
<div id="header_actions_container" class="flex items-center gap-2 hidden">
    <button onclick="deleteAlert()"
        class="bg-gray-800 hover:bg-red-900/40 text-red-500 px-3 py-1 text-[11px] rounded flex items-center gap-2 border border-gray-700 transition-all">
        <i class="fas fa-trash"></i> Delete
    </button>
</div>
{{ super() }}
{% endblock %}

{% block content %}
<!-- Markdown Support -->
<script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
<script>
    // Ensure showToast is defined globally
    window.showToast = window.showToast || function (message, type = 'info') {
        console.log(`[Toast ${type}] ${message}`);
        // Create simple toast if not exists
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toast-container';
            toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
        toast.className = `${colors} text-white px-4 py-2 rounded shadow-lg mb-2 flex items-center`;
        toast.innerHTML = `<span>${message}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    };
</script>
<style>
    /* Fix user message code blocks to respect parent width */
    .user-message-content pre,
    .user-message-content code {
        max-width: 100% !important;
        overflow-x: auto !important;
        white-space: pre-wrap !important;
        word-break: break-word !important;
    }

    .user-message-content pre {
        margin: 0.5rem 0;
    }
</style>
<div id="alertContent" class="space-y-0 h-full flex flex-col">
    <div class="text-center py-8">
        <div class="loading-spinner mx-auto"></div>
        <p class="text-gray-400 mt-2">Loading alert...</p>
    </div>
</div>

<!-- Server Selection Modal -->
<div id="serverModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-[450px] max-w-full">
        <h3 class="text-xl font-bold mb-4">Connect to Server</h3>

        <!-- Tabs -->
        <div class="flex border-b border-gray-700 mb-4">
            <button id="tabSavedServers" onclick="switchServerTab('saved')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-purple-500 text-purple-400">
                <i class="fas fa-server mr-1"></i>Saved Servers
            </button>
            <button id="tabQuickConnect" onclick="switchServerTab('quick')"
                class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300">
                <i class="fas fa-bolt mr-1"></i>Quick Connect
            </button>
        </div>

        <!-- Saved Servers Tab -->
        <div id="savedServersPane" class="space-y-2 mb-4 max-h-60 overflow-y-auto">
            <div id="serverList">
                <p class="text-gray-400 text-sm">Loading servers...</p>
            </div>
        </div>

        <!-- Quick Connect Tab -->
        <div id="quickConnectPane" class="hidden space-y-3 mb-4">
            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-3">
                <p class="text-xs text-gray-400 mb-3">
                    <i class="fas fa-info-circle text-blue-400 mr-1"></i>
                    Connect to any SSH server without saving credentials
                </p>
                <div class="space-y-3">
                    <div class="flex space-x-2">
                        <div class="flex-grow">
                            <label class="block text-xs text-gray-400 mb-1">Host</label>
                            <input type="text" id="adhocHost" class="w-full input-field px-3 py-2 rounded text-sm"
                                placeholder="hostname or IP" />
                        </div>
                        <div class="w-20">
                            <label class="block text-xs text-gray-400 mb-1">Port</label>
                            <input type="number" id="adhocPort" class="w-full input-field px-3 py-2 rounded text-sm"
                                value="22" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Username</label>
                        <input type="text" id="adhocUsername" class="w-full input-field px-3 py-2 rounded text-sm"
                            placeholder="root" />
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Password</label>
                        <input type="password" id="adhocPassword" class="w-full input-field px-3 py-2 rounded text-sm"
                            placeholder="••••••••" />
                    </div>
                </div>
            </div>
            <button onclick="connectAdhoc()"
                class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-medium">
                <i class="fas fa-plug mr-2"></i>Connect
            </button>
        </div>

        <div class="flex justify-end space-x-2">
            <button onclick="closeServerModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
        </div>
    </div>
</div>

<!-- Agent Mode Modal -->
<div id="agentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-[480px] max-w-full">
        <div class="flex items-center mb-4">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3">
                <i class="fas fa-robot text-white"></i>
            </div>
            <div>
                <h3 class="text-xl font-bold">Agent Mode</h3>
                <p class="text-xs text-gray-400">Autonomous troubleshooting assistant</p>
            </div>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-300 mb-2">What should the agent accomplish?</label>
            <textarea id="agentGoal" class="w-full input-field p-3 rounded resize-none h-24"
                placeholder="e.g., Find out why disk space is low and clean up unnecessary files"></textarea>
        </div>

        <div class="bg-gray-800 rounded-lg p-3 mb-4">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="autoApprove"
                    class="form-checkbox h-4 w-4 text-purple-600 rounded border-gray-600 bg-gray-700 mr-3">
                <div>
                    <span class="text-sm text-white">Auto-approve commands</span>
                    <p class="text-xs text-gray-400">Agent will execute commands without asking for approval</p>
                </div>
            </label>
        </div>

        <div class="bg-yellow-900/30 border border-yellow-700 rounded-lg p-3 mb-4">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5 mr-2"></i>
                <div class="text-xs text-yellow-200">
                    <strong>Note:</strong> Agent will execute commands on the connected server.
                    Make sure you're connected to the correct server before starting.
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-2">
            <button onclick="closeAgentModal()" class="btn-secondary px-4 py-2 rounded">Cancel</button>
            <button onclick="startAgent()"
                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white px-4 py-2 rounded font-medium">
                <i class="fas fa-play mr-2"></i>Start Agent
            </button>
        </div>
    </div>
</div>

<!-- Clear Chat Confirmation Modal -->
<div id="clearChatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary flex items-center gap-2">
                <i class="fas fa-eraser text-yellow-400"></i>
                Clear Chat History
            </h2>
            <button onclick="closeClearChatModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-6">Clear chat display? This will only clear the visual display, not the stored
            messages.</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeClearChatModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
            <button onclick="confirmClearChat()"
                class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg">Clear Chat</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const alertId = '{{ alert_id }}';
    let chatSocket = null;
    let terminalSocket = null;
    let currentSessionId = null;
    let currentSession = null;
    let term = null;
    let fitAddon = null;
    let availableProviders = [];

    // Command History - tracks all commands executed in this session
    let commandHistory = [];
    const MAX_HISTORY_SIZE = 50;

    function addToCommandHistory(command, output, exitCode, success) {
        const entry = {
            id: Date.now(),
            command: command,
            output: output,
            exitCode: exitCode,
            success: success,
            timestamp: new Date().toISOString(),
            displayTime: new Date().toLocaleTimeString()
        };

        // Add to beginning (most recent first)
        commandHistory.unshift(entry);

        // Keep only last MAX_HISTORY_SIZE entries
        if (commandHistory.length > MAX_HISTORY_SIZE) {
            commandHistory = commandHistory.slice(0, MAX_HISTORY_SIZE);
        }

        // Update history panel if visible
        updateCommandHistoryPanel();
        updateHistoryCount();

        return entry;
    }

    function getCommandHistoryContext() {
        // Generate a structured summary for AI context
        if (commandHistory.length === 0) return '';

        const recentCommands = commandHistory.slice(0, 10); // Last 10 commands
        let context = '\n\n[COMMAND HISTORY - Recent commands executed in this session]\n';

        recentCommands.forEach((entry, index) => {
            const status = entry.success ? '✓' : '✗';
            const outputPreview = entry.output ? entry.output.substring(0, 200) : '(no output)';
            context += `${index + 1}. [${status}] ${entry.command} (exit: ${entry.exitCode})\n`;
            if (entry.output) {
                context += `   Output: ${outputPreview}${entry.output.length > 200 ? '...' : ''}\n`;
            }
        });

        return context;
    }

    function toggleCommandHistory() {
        const panel = document.getElementById('commandHistoryPanel');
        if (!panel) return;

        panel.classList.toggle('hidden');

        // Update the panel content when showing
        if (!panel.classList.contains('hidden')) {
            updateCommandHistoryPanel();
        }
    }

    function clearCommandHistory() {
        commandHistory = [];
        updateCommandHistoryPanel();
        showToast('Command history cleared', 'success');
    }

    function updateHistoryCount() {
        const countEl = document.getElementById('historyCount');
        if (countEl) {
            countEl.textContent = commandHistory.length;
        }
    }

    // --- Font Size Logic ---
    let chatFontSize = 14; // default
    function adjustChatFont(delta) {
        chatFontSize = Math.max(10, Math.min(24, chatFontSize + delta));
        document.getElementById('chatMessages').style.fontSize = `${chatFontSize}px`;
    }

    function adjustTermFont(delta) {
        if (!term) return;
        const newSize = Math.max(8, Math.min(24, term.options.fontSize + delta));
        term.options.fontSize = newSize;
        fitAddon.fit();
    }

    // --- Alert Management ---

    async function loadAlert() {
        try {
            const alert = await apiCall(`/api/alerts/${alertId}`);
            if (!alert) return;

            renderAlert(alert);
            if (typeof feather !== 'undefined') feather.replace();

            // Initialize Chat Session automatically
            initChatSession(alert.id);

        } catch (error) {
            console.error('Error loading alert:', error);
            document.getElementById('alertContent').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-circle text-red-400 text-4xl mb-3"></i>
                    <p class="text-gray-400 font-bold">Alert not found</p>
                    <p class="text-sm text-gray-500 mb-4">ID: ${alertId}<br>Error: ${error.message}</p>
                    <a href="/alerts" class="btn-primary mt-4 px-4 py-2 rounded inline-block">Back to Alerts</a>
                </div>
            `;
        }
    }

    function renderAlert(alert) {
        const container = document.getElementById('alertContent');

        // Format labels/annotations (light theme for Details popover)
        const labelsHtml = Object.entries(alert.labels_json || {})
            .map(([k, v]) => `<span class="inline-block bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs mr-2 mb-2 border border-slate-200">${escapeHtml(String(k))}: ${escapeHtml(String(v))}</span>`)
            .join('');

        // Update header title
        const headerTitle = document.getElementById('header_alert_name');
        if (headerTitle) headerTitle.textContent = alert.alert_name;

        const annotationsHtml = Object.entries(alert.annotations_json || {})
            .map(([k, v]) => `<div class="mb-1.5"><span class="text-slate-500 font-medium">${escapeHtml(String(k))}:</span> <span class="ml-2 text-slate-700">${escapeHtml(String(v))}</span></div>`)
            .join('');

        const summary = (alert.annotations_json || {}).summary || (alert.annotations_json || {}).description || 'No description';
        container.innerHTML = `
            <!-- Alert Info Bar (single line, compact) -->
            <div class="alert-detail-card px-3 py-2 mb-2">
                <div class="flex items-center gap-3 flex-shrink-0 flex-wrap md:flex-nowrap">
                    <div class="w-7 h-7 rounded flex items-center justify-center flex-shrink-0 ${alert.severity === 'critical' ? 'bg-red-50' : alert.severity === 'warning' ? 'bg-amber-50' : 'bg-blue-50'}">
                        <i class="fas fa-exclamation-triangle text-[10px] ${alert.severity === 'critical' ? 'text-red-500' : alert.severity === 'warning' ? 'text-amber-500' : 'text-blue-500'}"></i>
                    </div>
                    <span class="text-sm font-semibold text-slate-800 truncate">${alert.alert_name}</span>
                    <span class="badge-${alert.severity || 'info'} flex-shrink-0">${(alert.severity || 'info').toUpperCase()}</span>
                    <span class="status-${alert.status || 'firing'} text-[10px] font-medium flex items-center flex-shrink-0"><i class="fas fa-circle text-[3px] mr-1"></i>${(alert.status || 'firing').toUpperCase()}</span>
                    <span class="text-xs text-slate-500 truncate flex-1 min-w-0">${summary}</span>
                    <div class="hidden md:flex items-center gap-4 text-[10px] text-slate-500 flex-shrink-0">
                        <span title="Instance"><i class="fas fa-server mr-1 text-slate-400"></i>${alert.instance || 'N/A'}</span>
                        <span title="Job"><i class="fas fa-cube mr-1 text-slate-400"></i>${alert.job || 'N/A'}</span>
                        <span title="Time"><i class="fas fa-clock mr-1 text-slate-400"></i>${new Date(alert.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="relative group flex-shrink-0">
                        <button class="text-slate-500 hover:text-slate-700 text-[10px] px-2 py-1 rounded border border-slate-200 hover:border-slate-300 hover:bg-slate-50 transition-colors">
                            <i class="fas fa-info-circle mr-1"></i>Details
                        </button>
                        <div class="absolute right-0 top-full mt-1.5 w-64 alert-detail-card p-3 hidden group-hover:block z-50 shadow-lg">
                            <h3 class="font-semibold mb-1.5 text-slate-700 text-[11px] uppercase tracking-wide">Labels</h3>
                            <div class="mb-2 text-xs text-slate-600">${labelsHtml || '<span class="text-slate-400">No labels</span>'}</div>
                            <h3 class="font-semibold mb-1.5 text-slate-700 text-[11px] uppercase tracking-wide">Annotations</h3>
                            <div class="text-xs text-slate-600">${annotationsHtml || '<span class="text-slate-400">No annotations</span>'}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="alert-detail-tabs mb-2">
                <button id="btn-tab-live" onclick="switchMainTab('live')" class="alert-detail-tab active">
                    <i class="fas fa-terminal mr-2" style="font-size:12px;"></i>Live Investigation
                </button>
                <button id="btn-tab-analysis" onclick="switchMainTab('analysis')" class="alert-detail-tab">
                    <i class="fas fa-project-diagram mr-2" style="font-size:12px;"></i>Analysis
                </button>
            </div>

            <!-- Tab Content: Live Investigation -->
            <div id="tab-live" class="flex-grow flex flex-col min-h-0">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-1.5 flex-grow overflow-hidden" style="height: calc(100vh - 105px);">
                
                <!-- Pane 1: Chat (troubleshoot style) -->
                <div class="lg:col-span-5 flex flex-col alert-detail-card h-full min-h-0 overflow-hidden">
                    <div class="ts-session-header px-3 py-2 border-b border-slate-200 flex-shrink-0 bg-slate-50">
                        <div class="ts-session-left flex items-center gap-2 flex-grow min-w-0">
                            <div class="ts-llm-selector" id="llmSelector">
                                <div class="ts-llm-selected" onclick="toggleAlertModelDropdown()">
                                    <span id="chatStatusDot" class="ts-model-dot w-2 h-2" style="background:#ef4444;" title="Disconnected"></span>
                                    <span class="ts-llm-text" id="currentModelName">Select Model</span>
                                    <i data-feather="chevron-down" class="ts-dropdown-icon"></i>
                                </div>
                                <div class="ts-llm-options" id="modelListContainer" style="display: none;">
                                    <!-- Options injected by populateAlertModelDropdown -->
                                </div>
                            </div>
                        </div>
                        <div class="ts-session-actions flex gap-1">
                            <button id="agentModeBtn" onclick="openAgentModal()" class="ts-icon-btn text-slate-500 hover:text-purple-600" title="Agent Mode" style="width:28px;height:28px;"><i class="fas fa-magic text-xs"></i></button>
                            <button onclick="toggleCommandHistory()" class="ts-icon-btn text-slate-500 hover:text-blue-600" title="Command History" style="width:28px;height:28px;"><i class="fas fa-history text-xs"></i></button>
                            <button onclick="clearChat()" class="ts-icon-btn text-slate-500 hover:text-red-600" title="Clear Chat" style="width:28px;height:28px;"><i class="fas fa-eraser text-xs"></i></button>
                            <button onclick="adjustChatFont(-1)" class="ts-icon-btn text-slate-500 hover:text-slate-700" title="Font -" style="width:28px;height:28px;"><i class="fas fa-minus text-xs"></i></button>
                            <button onclick="adjustChatFont(1)" class="ts-icon-btn text-slate-500 hover:text-slate-700" title="Font +" style="width:28px;height:28px;"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                    </div>
                    
                    <!-- Command History Panel (collapsed by default) -->
                    <div id="commandHistoryPanel" class="hidden border-b border-gray-700 bg-gray-900/80 flex-shrink-0">
                        <div class="p-2 border-b border-gray-700/50 flex justify-between items-center">
                            <div class="flex items-center text-xs text-gray-400">
                                <i class="fas fa-history text-blue-400 mr-2"></i>
                                <span>Command History</span>
                                <span id="historyCount" class="ml-2 bg-gray-700 text-gray-300 px-1.5 py-0.5 rounded text-[10px]">0</span>
                            </div>
                            <div class="flex space-x-1">
                                <button onclick="clearCommandHistory()" class="text-gray-400 hover:text-red-400 text-xs px-2 py-1" title="Clear History">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="toggleCommandHistory()" class="text-gray-400 hover:text-white text-xs px-2 py-1" title="Close">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="history-list p-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-500 text-sm text-center py-4">No commands executed yet</p>
                        </div>
                    </div>
                    
                    <!-- Context Status Panel (AI Knowledge Awareness) -->
                    <div id="contextStatusPanel" class="hidden px-4 py-2 bg-gray-900 border-b border-gray-800 flex items-center space-x-2 text-xs">
                        <span class="text-gray-500 font-semibold uppercase tracking-wider mr-2">Context:</span>
                        <!-- Badges populated by JS -->
                    </div>
                    
                    <div id="chatMessages" class="ts-chat-messages flex-grow overflow-y-auto min-h-0">
                        <!-- Messages go here - welcome shown by showWelcomeScreen -->
                        <div class="text-center text-slate-500 py-8 text-sm">Starting conversation...</div>
                    </div>
                    
                    <div class="ts-chat-input-container flex-shrink-0 z-10">
                        <form id="chatForm" onsubmit="sendMessage(event)" class="ts-chat-input-wrapper">
                            <textarea id="chatInput" class="ts-chat-input" placeholder="Ask AI about this alert, run commands, or troubleshoot..." autocomplete="off" rows="1"></textarea>
                            <button type="submit" class="ts-send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Pane 2: Terminal -->
                <div class="lg:col-span-7 flex flex-col alert-detail-card h-full overflow-hidden">
                    <div class="px-3 py-2 border-b border-slate-200 flex justify-between items-center bg-slate-800 flex-shrink-0">
                        <div class="flex items-center">
                            <h2 class="font-semibold text-xs mr-2"><i class="fas fa-terminal text-green-400 mr-1"></i>Terminal</h2>
                            <div class="flex space-x-0.5 mr-2">
                                <button onclick="adjustTermFont(-1)" class="text-gray-400 hover:text-white px-1" title="Font -"><i class="fas fa-minus text-[10px]"></i></button>
                                <button onclick="adjustTermFont(1)" class="text-gray-400 hover:text-white px-1" title="Font +"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="termStatus" class="text-[9px] text-gray-500" title="Connection Status">Disconnected</span>
                            <button onclick="openServerModal()" class="btn-secondary px-2 py-0.5 text-[10px] rounded" title="Connect to Server">
                                <i class="fas fa-plug mr-1"></i>Connect
                            </button>
                        </div>
                    </div>
                    <div class="flex-grow relative overflow-hidden h-full w-full bg-black">
                        <div id="terminal" class="absolute inset-0"></div>
                        
                        <!-- Inline Chat Overlay (Ctrl+I) -->
                        <div id="inlineChatOverlay" class="hidden absolute bottom-4 left-4 right-4 z-50">
                            <div class="bg-gray-900/95 border border-purple-500/50 rounded-lg shadow-2xl backdrop-blur-sm">
                                <div class="flex items-center px-3 py-2 border-b border-gray-700">
                                    <i class="fas fa-robot text-purple-400 mr-2"></i>
                                    <span class="text-xs text-gray-300">Ask AI about terminal</span>
                                    <span class="ml-auto text-[10px] text-gray-500">Esc to close</span>
                                </div>
                                <div class="p-2">
                                    <div class="flex space-x-2">
                                        <input type="text" id="inlineChatInput" 
                                            class="flex-grow bg-gray-800 border border-gray-600 text-white text-sm px-3 py-2 rounded focus:border-purple-500 focus:outline-none"
                                            placeholder="Ask about what you see in the terminal..."
                                            onkeydown="handleInlineChatKey(event)">
                                        <button onclick="sendInlineChat()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded text-sm">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                    <div class="mt-2 flex flex-wrap gap-1">
                                        <button onclick="sendQuickInlineChat('What does this error mean?')" class="text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded">What does this error mean?</button>
                                        <button onclick="sendQuickInlineChat('How do I fix this?')" class="text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded">How do I fix this?</button>
                                        <button onclick="sendQuickInlineChat('Explain the last command output')" class="text-[10px] bg-gray-700 hover:bg-gray-600 text-gray-300 px-2 py-1 rounded">Explain output</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Explain Selection Button (appears when text selected) -->
                        <div id="explainSelectionBtn" class="hidden absolute z-50">
                            <button onclick="explainSelectedText()" 
                                class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-3 py-1.5 rounded shadow-lg flex items-center space-x-1">
                                <i class="fas fa-magic"></i>
                                <span>Explain with AI</span>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Tab Content: Troubleshooting Analysis (compact, refined) -->
            <div id="tab-analysis" class="hidden flex-grow flex flex-col min-h-0">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-1.5 flex-grow overflow-hidden" style="height: calc(100vh - 105px);">
                    
                    <!-- Left: Correlation & RCA -->
                    <div class="lg:col-span-4 flex flex-col gap-2 overflow-y-auto min-h-0">
                        <div class="alert-analysis-card px-3 py-2.5 flex-shrink-0">
                            <h3 class="font-semibold text-xs text-purple-600 mb-2 flex items-center"><i class="fas fa-link mr-1.5"></i>Correlation Group</h3>
                            <div class="flex justify-between text-[11px] mb-1.5">
                                <span class="text-slate-500">Total Alerts</span>
                                <span id="corr-count" class="font-mono text-slate-800 font-medium">1</span>
                            </div>
                            <div class="flex justify-between text-[11px] mb-1.5">
                                <span class="text-slate-500">Duration</span>
                                <span id="corr-duration" class="font-mono text-slate-800 font-medium">0h</span>
                            </div>
                            <div class="border-t border-slate-200 my-2"></div>
                            <div id="correlated-alerts-list" class="space-y-1 max-h-36 overflow-y-auto text-xs">
                                <p class="text-slate-500 text-center py-2">Loading...</p>
                            </div>
                        </div>

                        <div class="alert-analysis-card px-3 py-2.5 flex-grow overflow-y-auto min-h-0">
                            <h3 class="font-semibold text-xs text-red-600 mb-2 flex items-center"><i class="fas fa-search mr-1.5"></i>Root Cause Analysis</h3>
                            <div id="rca-loading" class="text-center py-4 text-slate-500 text-xs">
                                <i class="fas fa-spinner fa-spin text-purple-500 mr-1.5"></i>Analyzing...
                            </div>
                            <div id="rca-content" class="hidden">
                                <div class="mb-2">
                                    <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Primary Cause</div>
                                    <div id="rca-title" class="font-semibold text-slate-800 text-sm"></div>
                                </div>
                                <div class="mb-2">
                                    <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Confidence</div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-grow bg-slate-200 h-1.5 rounded-full overflow-hidden">
                                            <div id="rca-confidence-bar" class="bg-red-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                        </div>
                                        <span id="rca-confidence" class="text-[11px] font-mono text-slate-600">0%</span>
                                    </div>
                                    <p id="rca-desc" class="text-[11px] text-slate-500 mt-0.5"></p>
                                </div>
                                <div>
                                    <div class="text-[10px] text-slate-500 uppercase tracking-wide mb-0.5">Reasoning</div>
                                    <ul id="rca-reasoning" class="list-disc list-inside text-[11px] text-slate-600 space-y-0.5 pl-0"></ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Investigation Path -->
                    <div class="lg:col-span-8 flex flex-col alert-detail-card h-full overflow-hidden">
                        <div class="px-3 py-2 border-b border-slate-200 bg-slate-50 flex-shrink-0">
                            <h3 class="font-semibold text-xs text-blue-600"><i class="fas fa-shoe-prints mr-1.5"></i>Investigation Path</h3>
                        </div>
                        <div class="flex-grow overflow-y-auto p-4 relative bg-white">
                            <div class="absolute left-4 top-4 bottom-4 w-px bg-slate-200"></div>
                            <div id="path-steps" class="ml-4">
                                <div class="text-center py-6 text-slate-500 text-xs">
                                    <i class="fas fa-circle-notch fa-spin mr-1.5"></i>Generating investigation steps...
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        `;
    }

    // --- Chat Logic ---

    async function initChatSession(alertId) {
        try {
            // Load available providers first
            await loadAvailableProviders();

            // Try to find existing session for this alert
            try {
                currentSession = await apiCall(`/api/alerts/chat/sessions/by-alert/${alertId}`);
                currentSessionId = currentSession.id;
                console.log('Reusing existing chat session:', currentSessionId);
            } catch (error) {
                // Ignore 404s, proceed to create new session
                if (!error.message.includes('404')) console.warn('Error checking existing session:', error);

                // Create new session only if none exists
                currentSession = await apiCall('/api/alerts/chat/sessions', 'POST', { alert_id: alertId });
                console.log('Created new chat session:', currentSession.id);
                currentSessionId = currentSession.id;
            }

            // Update model selector to show current model
            updateModelSelector();

            // Load message history (will have messages if reused session)
            await loadMessageHistory(currentSession.id);

            // Connect WebSocket
            connectChatWebSocket(currentSession.id);

            // Check Context Availability
            checkContextStatus(alertId);

        } catch (error) {
            console.error('Chat init failed:', error);
            showToast('Failed to initialize chat', 'error');
            updateChatStatusDot(false);
        }
    }

    async function checkContextStatus(alertId) {
        try {
            const status = await apiCall(`/api/alerts/chat/context-status/${alertId}`);
            if (status) {
                renderContextBadges(status);
            }
        } catch (e) {
            console.error("Failed to check context status", e);
        }
    }

    function renderContextBadges(status) {
        const panel = document.getElementById('contextStatusPanel');
        panel.innerHTML = '<span class="text-gray-500 font-semibold uppercase tracking-wider mr-2">Context:</span>';
        let hasContext = false;

        if (status.has_similar_incidents) {
            hasContext = true;
            panel.innerHTML += `
                <span class="bg-blue-900/50 text-blue-300 border border-blue-700/50 px-2 py-0.5 rounded flex items-center" title="AI is using ${status.similar_count} similar past incidents">
                    <i class="fas fa-history mr-1.5 opacity-70"></i>
                    Upcoming: ${status.similar_count} Similar
                </span>`;
        }

        if (status.has_feedback_history) {
            hasContext = true;
            panel.innerHTML += `
                <span class="bg-green-900/50 text-green-300 border border-green-700/50 px-2 py-0.5 rounded flex items-center" title="AI is learning from past user feedback">
                    <i class="fas fa-thumbs-up mr-1.5 opacity-70"></i>
                    Learning Active
                </span>`;
        }

        if (status.has_correlation) {
            hasContext = true;
            panel.innerHTML += `
                <span class="bg-purple-900/50 text-purple-300 border border-purple-700/50 px-2 py-0.5 rounded flex items-center" title="AI is analyzing related alerts in this group">
                    <i class="fas fa-layer-group mr-1.5 opacity-70"></i>
                    Correlated Group
                </span>`;
        }

        if (hasContext) {
            panel.classList.remove('hidden');
        } else {
            panel.classList.add('hidden');
        }
    }

    async function loadAvailableProviders() {
        try {
            availableProviders = await apiCall('/api/alerts/chat/providers');

            const list = document.getElementById('modelListContainer');
            const nameEl = document.getElementById('currentModelName');
            if (!availableProviders || availableProviders.length === 0) {
                if (list) list.innerHTML = '<div class="px-3 py-2 text-xs text-slate-500">No providers configured</div>';
                if (nameEl) nameEl.textContent = 'No providers';
                return;
            }

            populateAlertModelDropdown(availableProviders);
            updateModelSelectorDisplay();

        } catch (error) {
            console.error('Failed to load providers:', error);
            const nameEl = document.getElementById('currentModelName');
            if (nameEl) nameEl.textContent = 'Error loading';
        }
    }

    function populateAlertModelDropdown(providers) {
        const list = document.getElementById('modelListContainer');
        if (!list || !providers?.length) return;

        const selectedId = (currentSession && currentSession.llm_provider_id) || providers.find(p => p.is_default)?.id || '';

        const selectedProvider = providers.find(p => p.id === selectedId);
        if (selectedProvider) {
            const nameEl = document.getElementById('currentModelName');
            if (nameEl) nameEl.textContent = selectedProvider.name || selectedProvider.provider_name || 'Select Model';
        }

        list.innerHTML = providers.map(p => {
            const isSelected = p.id === selectedId;
            const name = p.name || p.provider_name || p.model_id || 'Unknown';
            return `<div class="ts-llm-option ${isSelected ? 'selected' : ''}" onclick="selectAlertModel('${p.id}'); toggleAlertModelDropdown();">
                <i data-feather="${p.is_enabled !== false ? 'check-circle' : 'x-circle'}" style="width: 14px; height: 14px; color: ${p.is_enabled !== false ? '#4ade80' : '#f87171'}"></i>
                <span class="ml-2">${escapeHtml(name)}${p.is_default ? ' ★' : ''}</span>
            </div>`;
        }).join('');

        if (typeof feather !== 'undefined') feather.replace();
    }

    function toggleAlertModelDropdown() {
        const list = document.getElementById('modelListContainer');
        const selector = document.getElementById('llmSelector');
        if (list && selector) {
            const isOpen = list.style.display === 'block';
            list.style.display = isOpen ? 'none' : 'block';
            selector.classList.toggle('open', !isOpen);
        }
    }

    function selectAlertModel(providerId) {
        switchModel(providerId);
    }

    document.addEventListener('click', function(e) {
        const llm = document.getElementById('llmSelector');
        const list = document.getElementById('modelListContainer');
        if (llm && list && !llm.contains(e.target)) {
            list.style.display = 'none';
            llm.classList.remove('open');
        }
    });

    function updateModelSelectorDisplay() {
        const nameEl = document.getElementById('currentModelName');
        if (!nameEl || !availableProviders?.length) return;
        const id = (currentSession && currentSession.llm_provider_id) || availableProviders.find(p => p.is_default)?.id;
        const p = availableProviders.find(x => x.id === id);
        nameEl.textContent = p ? (p.name || p.provider_name || p.model_id || 'Select Model') : 'Select Model';
    }

    function updateModelSelector() {
        if (currentSession && currentSession.llm_provider_id) {
            // Already set
        } else {
            const defaultProvider = availableProviders?.find(p => p.is_default);
            if (defaultProvider) {
                currentSession = currentSession || {};
                currentSession.llm_provider_id = defaultProvider.id;
            }
        }
        updateModelSelectorDisplay();
        populateAlertModelDropdown(availableProviders || []);
    }

    async function switchModel(providerId) {
        if (!currentSessionId || !providerId) return;

        const previousValue = currentSession?.llm_provider_id || '';

        try {
            const result = await apiCall(`/api/alerts/chat/sessions/${currentSessionId}/provider`, 'PATCH', { provider_id: providerId });

            showToast(`Switched to ${result.provider_name} - ${result.model_name}`, 'success');

            const container = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = 'text-center text-xs text-gray-500 my-2 italic';
            msg.innerHTML = `<i class="fas fa-sync-alt mr-1"></i>Now using: ${result.provider_name} - ${result.model_name}`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            currentSession.llm_provider_id = providerId;
            updateModelSelectorDisplay();
            populateAlertModelDropdown(availableProviders || []);

        } catch (error) {
            console.error('Failed to switch model:', error);
            showToast('Failed to switch model', 'error');
            if (previousValue) {
                currentSession.llm_provider_id = previousValue;
                updateModelSelectorDisplay();
                populateAlertModelDropdown(availableProviders || []);
            }
        }
    }

    async function loadMessageHistory(sessionId) {
        try {
            const messages = await apiCall(`/api/alerts/chat/sessions/${sessionId}/messages`);

            const container = document.getElementById('chatMessages');
            container.innerHTML = ''; // Clear loading message

            if (messages.length === 0) {
                // Show welcome screen with suggestions
                showWelcomeScreen();
                return;
            }

            // Render existing messages
            messages.forEach(msg => {
                if (msg.role === 'user') {
                    const wrapper = document.createElement('div');
                    // Check if content has code blocks or terminal/system output
                    const hasCodeBlock = msg.content.includes('```') || msg.content.includes('[TERMINAL') || msg.content.includes('[ERROR') || msg.content.includes('[SYSTEM');
                    // For code blocks use full width like AI messages, for regular messages align right
                    wrapper.className = hasCodeBlock ? 'flex justify-start w-full pr-2 mb-3' : 'flex justify-end mb-3';
                    wrapper.innerHTML = `
                        <div class="bg-gray-700/80 border border-purple-500/30 rounded-lg p-3 ${hasCodeBlock ? 'w-full' : 'max-w-xs lg:max-w-md'} text-sm text-white shadow-md" style="word-break: break-word;">
                            <div class="user-message-content ${hasCodeBlock ? 'overflow-x-auto max-h-80 overflow-y-auto' : ''}">
                                ${hasCodeBlock ? marked.parse(msg.content) : escapeHtml(msg.content)}
                            </div>
                        </div>
                    `;
                    container.appendChild(wrapper);
                    lastMessageRole = 'user';
                } else if (msg.role === 'assistant') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex justify-start w-full pr-2 mb-3';
                    wrapper.innerHTML = `
                        <div class="ai-message-wrapper w-full">
                            <div class="flex items-center mb-2">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-2">
                                    <i class="fas fa-robot text-white text-xs"></i>
                                </div>
                                <span class="text-xs text-gray-400">AI Assistant</span>
                            </div>
                            <div class="bg-gray-800/80 rounded-lg p-4 border border-purple-500/20 text-sm ai-message-content shadow-lg">
                                ${marked.parse(msg.content)}
                            </div>
                        </div>
                    `;
                    container.appendChild(wrapper);
                    addRunButtons(wrapper);
                    lastMessageRole = 'assistant';
                }
            });

            container.scrollTop = container.scrollHeight;

        } catch (error) {
            console.error('Failed to load chat history:', error);
            showWelcomeScreen();
        }
    }

    function showWelcomeScreen() {
        const container = document.getElementById('chatMessages');
        const suggestions = [
            { text: "Analyze this alert and tell me what might be wrong", icon: "fas fa-chart-line" },
            { text: "What commands should I run to troubleshoot this issue?", icon: "fas fa-terminal" },
            { text: "Show me where to find relevant logs for this alert", icon: "fas fa-file-alt" },
            { text: "Explain this error in simple terms", icon: "fas fa-question-circle" }
        ];
        container.innerHTML = `
            <div class="welcome-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 24px; text-align: center; margin: auto 0;">
                <div style="width: 56px; height: 56px; border-radius: 14px; background: linear-gradient(135deg, #8b5cf6, #6366f1); display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(99, 102, 241, 0.25);">
                    <i class="fas fa-robot text-white" style="font-size: 22px;"></i>
                </div>
                <h2 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 8px;">Alert Assistant</h2>
                <p style="color: #64748b; font-size: 13px; margin-bottom: 28px; max-width: 340px; line-height: 1.5;">Connect to a server and ask me to help troubleshoot this alert.</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 460px;">
                    ${suggestions.map(s => `
                        <button onclick="sendSuggestion(this.dataset.txt)" data-txt="${escapeHtml(s.text).replace(/"/g, '&quot;')}"
                                style="display: flex; align-items: flex-start; gap: 10px; padding: 14px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; text-align: left; font-size: 12px; color: #475569; cursor: pointer; transition: all 0.2s; line-height: 1.4; box-shadow: 0 1px 3px rgba(0,0,0,0.05);"
                                onmouseenter="this.style.borderColor='#93c5fd'; this.style.boxShadow='0 4px 14px rgba(59,130,246,0.12)'; this.style.transform='translateY(-2px)';"
                                onmouseleave="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';">
                            <i class="${s.icon}" style="font-size: 14px; color: #3b82f6; flex-shrink: 0;"></i>
                            <span style="font-weight: 500;">${escapeHtml(s.text)}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
    }

    function sendSuggestion(text) {
        const input = document.getElementById('chatInput');
        input.value = text;
        sendMessage(new Event('submit'));
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Streaming state variables
    let currentStreamController = null;
    let isStreaming = false;

    function updateChatStatusDot(connected) {
        const dot = document.getElementById('chatStatusDot');
        if (!dot) return;
        dot.style.background = connected ? '#22c55e' : '#ef4444';
        dot.title = connected ? 'Connected' : 'Disconnected';
    }

    function connectChatWebSocket(sessionId) {
        // Chat now uses REST/SSE streaming instead of WebSocket
        updateChatStatusDot(true);
        console.log('Chat ready using REST/SSE streaming for session:', sessionId);
    }

    let lastMessageRole = null;
    let currentMessageDiv = null;

    function appendAIMessage(text) {
        removeTypingIndicator(); // Remove typing indicator when AI starts responding

        const container = document.getElementById('chatMessages');

        // Check for CMD_CARD markers and extract them
        const cmdCardRegex = /\[CMD_CARD\](.*?)\[\/CMD_CARD\]/g;
        let match;
        let hasCards = false;
        let extractedCommands = [];
        let cardDataList = [];

        while ((match = cmdCardRegex.exec(text)) !== null) {
            hasCards = true;
            try {
                const cardData = JSON.parse(match[1]);
                extractedCommands.push(cardData.command);
                cardDataList.push(cardData);
            } catch (e) {
                console.error('Failed to parse CMD_CARD:', e);
            }
        }

        // Remove CMD_CARD markers from text for display
        let cleanText = text.replace(cmdCardRegex, '');

        // When CMD_CARD is present, clean up duplicate command text
        if (hasCards) {
            cleanText = cleanText.replace(/```[\s\S]*?```/g, '');
            cleanText = cleanText.replace(/`[^`]+`/g, '');
            for (const cmd of extractedCommands) {
                const escapedCmd = cmd.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                cleanText = cleanText.replace(new RegExp(escapedCmd, 'g'), '');
            }
        }

        // Render text first
        if (cleanText.trim() !== '') {
            if (lastMessageRole !== 'assistant' || !currentMessageDiv) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex justify-start w-full pr-2';
                wrapper.innerHTML = `
                    <div class="ai-message-wrapper w-full">
                        <div class="flex items-center mb-2">
                            <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-2">
                                <i class="fas fa-robot text-white text-xs"></i>
                            </div>
                            <span class="text-xs text-gray-400">AI Assistant</span>
                        </div>
                        <div class="bg-gray-800/80 rounded-lg p-4 border border-purple-500/20 text-sm ai-message-content shadow-lg" data-full-text=""></div>
                    </div>
                `;
                container.appendChild(wrapper);
                currentMessageDiv = wrapper.querySelector('.ai-message-content');
                lastMessageRole = 'assistant';
            }

            if (currentMessageDiv) {
                const currentText = currentMessageDiv.getAttribute('data-full-text') || '';
                const newText = currentText + cleanText;
                currentMessageDiv.setAttribute('data-full-text', newText);
                currentMessageDiv.innerHTML = marked.parse(newText);

                // Only add run buttons if no CMD_CARDs (avoid duplicates)
                if (!hasCards) {
                    addRunButtons(currentMessageDiv);
                }
            }
        }

        // Render command cards after text
        for (const cardData of cardDataList) {
            renderCmdCard(cardData.command, cardData.server, cardData.explanation);
        }

        container.scrollTop = container.scrollHeight;
    }

    // Render a structured command card from [CMD_CARD] data
    function renderCmdCard(command, server, explanation) {
        const container = document.getElementById('chatMessages');
        const cardId = 'cmd-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        const wrapper = document.createElement('div');
        wrapper.className = 'flex justify-start w-full pr-2 my-2';
        wrapper.id = cardId;
        wrapper.innerHTML = `
            <div class="w-full bg-gray-800 rounded-lg border border-gray-700 overflow-hidden shadow-lg">
                <div class="flex items-center justify-between px-4 py-2 bg-gray-900 border-b border-gray-700">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-terminal text-green-400"></i>
                        <span class="text-xs text-gray-400">Command Suggestion</span>
                    </div>
                    <span class="text-xs text-gray-500">${escapeHtml(server || '')}</span>
                </div>
                <div class="p-4">
                    <div class="bg-black rounded p-3 font-mono text-sm text-green-300 mb-3 overflow-x-auto">
                        ${escapeHtml(command)}
                    </div>
                    <div class="text-xs text-gray-400 mb-3">
                        <i class="fas fa-info-circle mr-1"></i>${escapeHtml(explanation || '')}
                    </div>
                    <div class="cmd-actions flex gap-2">
                        <button onclick="executeCommandWithOutput('${cardId}', '${escapeHtml(command).replace(/'/g, "\\'")}')" 
                                class="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm px-4 py-2 rounded font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i>Run in Terminal
                        </button>
                        <button onclick="dismissCommandCard('${cardId}')" 
                                class="bg-yellow-600 hover:bg-yellow-500 text-white text-sm px-3 py-2 rounded font-medium transition-colors"
                                title="Skip this command">
                            <i class="fas fa-forward"></i>
                        </button>
                        <button onclick="copyToClipboard('${escapeHtml(command).replace(/'/g, "\\'")}')" 
                                class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded font-medium transition-colors"
                                title="Copy command">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        lastMessageRole = 'assistant';
    }

    function appendUserMessage(text) {
        const container = document.getElementById('chatMessages');
        const wrapper = document.createElement('div');
        wrapper.className = 'flex justify-end';
        wrapper.innerHTML = `
            <div class="bg-gray-700/80 border border-purple-500/30 rounded-lg p-3 max-w-xs lg:max-w-md text-sm text-white shadow-md">
                ${text}
            </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        lastMessageRole = 'user';
    }

    async function loadTroubleshootingData() {
        try {
            // 1. Get Correlation Data
            try {
                const correlation = await apiCall(`/api/v1/alerts/${alertId}/correlation`);
                if (correlation) {
                    renderCorrelation(correlation);

                    // 2. Trigger RCA if active
                    if (correlation.status === 'active' && !correlation.root_cause_analysis) {
                        const rca = await apiCall(`/api/v1/alerts/${alertId}/analyze-root-cause`, 'POST');
                        if (rca) renderRCA(rca);
                    } else if (correlation.root_cause_analysis) {
                        // Parse stored string or object
                    }
                }
            } catch (e) { console.warn("Correlation data not available", e); }

            // 3. Get Investigation Path
            try {
                const path = await apiCall(`/api/v1/alerts/${alertId}/investigation-path`);
                if (path) renderInvestigationPath(path);
            } catch (e) { console.warn("Investigation path not available", e); }

        } catch (e) {
            console.error("Error loading troubleshooting data", e);
        }
    }

    function renderCorrelation(data) {
        document.getElementById('corr-count').innerText = data.alerts ? data.alerts.length : 1;
        // Calc duration
        const start = new Date(data.created_at);
        const now = new Date();
        const diffHrs = Math.round((now - start) / 1000 / 60 / 60);
        document.getElementById('corr-duration').innerText = diffHrs + "h";

        // Render List (light theme aligned with analysis section)
        const list = document.getElementById('correlated-alerts-list');
        list.innerHTML = (data.alerts || []).map(a => `
            <div class="bg-slate-50 px-2 py-1.5 rounded border border-slate-200 flex justify-between items-center hover:bg-slate-100 cursor-pointer transition-colors" onclick="window.location.href='/alerts/${a.id}'">
                <div class="min-w-0 flex-1">
                    <div class="font-medium text-slate-800 text-xs truncate">${a.alert_name}</div>
                    <div class="text-[10px] text-slate-500">${new Date(a.timestamp).toLocaleString()}</div>
                </div>
                <span class="badge-${a.severity} px-1.5 py-0.5 rounded text-[10px] flex-shrink-0 ml-2">${a.severity}</span>
            </div>
        `).join('');
    }

    function renderRCA(rca) {
        document.getElementById('rca-loading').classList.add('hidden');
        document.getElementById('rca-content').classList.remove('hidden');

        document.getElementById('rca-title').innerText = rca.root_cause;
        document.getElementById('rca-desc').innerText = "Identified with " + Math.round(rca.confidence * 100) + "% confidence.";
        document.getElementById('rca-confidence').innerText = (rca.confidence * 100) + "%";

        const reasons = document.getElementById('rca-reasoning');
        reasons.innerHTML = rca.reasoning.map(r => `<li>${r}</li>`).join('');
    }

    function renderInvestigationPath(path) {
        const container = document.getElementById('path-steps');
        container.innerHTML = path.steps.map(step => `
            <div class="relative mb-4 pl-8">
                <span class="absolute -left-[10px] top-0 w-5 h-5 rounded-full bg-purple-600 flex items-center justify-center text-[10px] font-bold text-white border-2 border-white shadow-sm">
                    ${step.step_number}
                </span>
                <div>
                    <h4 class="font-semibold text-purple-600 text-xs">${step.action}</h4>
                    <p class="text-slate-500 text-[11px] mb-1.5">${step.description}</p>
                    ${step.command_to_run ? `
                        <div class="bg-slate-100 rounded px-2 py-1.5 text-[11px] font-mono text-slate-700 flex justify-between items-center group border border-slate-200">
                            <code class="truncate">${escapeHtml(step.command_to_run)}</code>
                            <button class="flex-shrink-0 ml-2 text-slate-400 hover:text-slate-600" onclick="copyToClipboard(this.dataset.cmd)" data-cmd="${String(step.command_to_run).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
                                <i class="fas fa-copy text-[10px]"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
    }

    // --- End Troubleshooting Logic ---


    function getTerminalContent() {
        if (!term) return '';

        // Get all lines from the buffer
        const buffer = term.buffer.active;
        const lines = [];
        // Limit to last 100 lines to avoid token limits
        const start = Math.max(0, buffer.baseY + buffer.cursorY - 100);
        const end = buffer.baseY + buffer.cursorY + 1;

        for (let i = start; i < end; i++) {
            const line = buffer.getLine(i);
            if (line) {
                lines.push(line.translateToString(true));
            }
        }

        return lines.join('\n').trim();
    }

    async function sendMessage(e) {
        e.preventDefault();

        // Clear pending analysis button if user types manually
        if (analysisButton) {
            analysisButton.remove();
            analysisButton = null;
        }

        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text || !currentSessionId) return;

        appendUserMessage(text);
        input.value = '';
        showTypingIndicator();

        // Inject terminal context if available
        const termContent = getTerminalContent();
        let finalMessage = text;

        if (termContent) {
            finalMessage += `\n\n[SYSTEM: The user has the following active terminal output. Use it if relevant to the query.]\n\`\`\`\n${termContent}\n\`\`\``;
        }

        // Use SSE streaming endpoint
        await sendStreamingMessage(finalMessage);
    }

    // Send message using SSE streaming for real-time token display
    async function sendStreamingMessage(message) {
        currentStreamController = new AbortController();
        isStreaming = true;

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/troubleshoot/chat/stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    message: message,
                    session_id: currentSessionId
                }),
                signal: currentStreamController.signal
            });

            if (!response.ok) {
                removeTypingIndicator();
                appendAIMessage('Failed to get response from AI. Please try again.');
                return;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';
            let firstChunkReceived = false;

            // Keep typing indicator visible until first content chunk arrives

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));

                            if (data.type === 'session') {
                                currentSessionId = data.session_id;
                            } else if (data.type === 'chunk') {
                                // Remove typing indicator on first content chunk
                                if (!firstChunkReceived) {
                                    removeTypingIndicator();
                                    firstChunkReceived = true;
                                }
                                fullResponse += data.content;
                                appendStreamingChunk(data.content);
                            } else if (data.type === 'done') {
                                finalizeStreamingMessage(fullResponse);
                            } else if (data.type === 'error') {
                                appendAIMessage(`Error: ${data.content}`);
                            } else if (data.type === 'cancelled') {
                                appendAIMessage('*Response cancelled by user.*');
                            }
                        } catch (e) {
                            console.error('Failed to parse SSE data:', e);
                        }
                    }
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Stream aborted by user');
            } else {
                removeTypingIndicator();
                console.error('Streaming error:', error);
                appendAIMessage('Error communicating with AI service. Please try again.');
            }
        } finally {
            isStreaming = false;
            currentStreamController = null;
            removeTypingIndicator();
        }
    }

    // Append streaming chunk to current message
    function appendStreamingChunk(chunk) {
        const container = document.getElementById('chatMessages');

        if (lastMessageRole !== 'assistant' || !currentMessageDiv) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex justify-start w-full pr-2';
            wrapper.innerHTML = `
                <div class="ai-message-wrapper w-full">
                    <div class="flex items-center mb-2">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-2">
                            <i class="fas fa-robot text-white text-xs"></i>
                        </div>
                        <span class="text-xs text-gray-400">AI Assistant</span>
                    </div>
                    <div class="bg-gray-800/80 rounded-lg p-4 border border-purple-500/20 text-sm ai-message-content shadow-lg" data-full-text=""></div>
                </div>
            `;
            container.appendChild(wrapper);
            currentMessageDiv = wrapper.querySelector('.ai-message-content');
            lastMessageRole = 'assistant';
        }

        if (currentMessageDiv) {
            const currentText = currentMessageDiv.getAttribute('data-full-text') || '';
            const newText = currentText + chunk;
            currentMessageDiv.setAttribute('data-full-text', newText);

            // Clean CMD_CARD markers for display
            let displayText = newText.replace(/\[CMD_CARD\].*?\[\/CMD_CARD\]/gs, '');
            currentMessageDiv.innerHTML = marked.parse(displayText);
        }

        container.scrollTop = container.scrollHeight;
    }

    // Finalize streaming message
    function finalizeStreamingMessage(fullText) {
        if (currentMessageDiv) {
            const wrapper = currentMessageDiv.closest('.flex');
            if (wrapper) {
                wrapper.remove();
            }
            currentMessageDiv = null;
        }
        appendAIMessage(fullText);
    }

    // Cancel ongoing streaming request
    function cancelStreaming() {
        if (currentStreamController && isStreaming) {
            currentStreamController.abort();
            showToast('Response cancelled', 'info');
        }
    }

    function showTypingIndicator() {
        const container = document.getElementById('chatMessages');
        const indicator = document.createElement('div');
        indicator.id = 'typingIndicator';
        indicator.className = 'flex justify-start my-2';
        indicator.innerHTML = `
            <div class="bg-gray-700 rounded-lg px-4 py-3 flex items-center space-x-3">
                <div class="flex space-x-1">
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                    <div class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                </div>
                <span class="text-gray-400 text-xs">Analyzing alert...</span>
                <button onclick="cancelStreaming()" class="ml-2 text-red-400 hover:text-red-300 text-xs px-2 py-1 border border-red-400/50 rounded hover:bg-red-400/10 transition-colors" title="Stop generating">
                    <i class="fas fa-stop mr-1"></i>Stop
                </button>
            </div>
        `;
        container.appendChild(indicator);
        container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // Handle Enter key in textarea (Event Delegation)
    document.addEventListener('keydown', function (e) {
        if (e.target && e.target.id === 'chatInput') {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(e);
            }
        }
    });

    // Copy to clipboard with fallback for non-HTTPS
    function copyToClipboard(text) {
        // Try modern Clipboard API first (HTTPS/localhost only)
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
        } else {
            // Fallback for HTTP: use execCommand
            return new Promise((resolve, reject) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.top = '-9999px';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();

                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    if (successful) {
                        resolve();
                    } else {
                        reject(new Error('Copy command failed'));
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    reject(err);
                }
            });
        }
    }

    function addRunButtons(element) {
        // Find all pre code blocks that don't have buttons yet
        const blocks = element.querySelectorAll('pre code');
        blocks.forEach(block => {
            const pre = block.parentElement;
            if (pre.querySelector('.code-actions') || pre.closest('.command-card')) return; // Already processed

            // Detect language from class
            const lang = block.className.match(/language-(\w+)/)?.[1] || '';
            const content = block.innerText.trim();

            // Only treat as command if it's explicitly shell/bash OR if it looks like an actual command
            const isExplicitShell = ['shell', 'bash', 'sh', 'zsh', 'fish'].includes(lang);
            const isUnmarked = lang === '';

            if (isExplicitShell || (isUnmarked && isActualCommand(content))) {
                // Create approval card (Agent Mode style)
                createCommandCard(pre, content);
            } else {
                // Non-shell code: just add copy button
                addCopyButton(pre, block, lang || 'text');
            }
        });
    }

    function isActualCommand(content) {
        // Detect if content is actually a shell command vs prose/instructions

        // Skip if empty or too short
        if (!content || content.length < 2) return false;

        // Skip if it's a multi-line paragraph of prose (has many lines that don't start with $, #, sudo, etc.)
        const lines = content.split('\n').filter(l => l.trim());

        // If more than 5 lines and doesn't look like a script, probably not a command
        if (lines.length > 5) {
            // Check if it looks like a script (lines starting with commands)
            const commandLines = lines.filter(l => {
                const trimmed = l.trim();
                return trimmed.startsWith('$') ||
                    trimmed.startsWith('#') ||
                    trimmed.startsWith('sudo ') ||
                    /^[a-z_][a-z0-9_-]*\s/.test(trimmed) || // starts with command name
                    trimmed.startsWith('./') ||
                    trimmed.startsWith('|');
            });
            if (commandLines.length < lines.length * 0.5) return false; // Less than 50% command-like
        }

        // Skip if it contains question marks (probably a question, not a command)
        if (content.includes('?')) return false;

        // Skip if it starts with a number followed by period (numbered list item)
        if (/^\d+\.\s/.test(content)) return false;

        // Skip if it starts with asterisk/dash (bullet point)
        if (/^[\*\-]\s/.test(content)) return false;

        // Skip if it contains common prose patterns
        const prosePatterns = [
            /^please\s/i,
            /^let me know/i,
            /^if you/i,
            /^you can/i,
            /^you should/i,
            /^we need/i,
            /^we can/i,
            /^look for/i,
            /^check if/i,
            /^make sure/i,
            /^note:/i,
            /^warning:/i,
            /^important:/i,
            /^verification:/i,
            /^solution:/i,
            /^explanation:/i,
        ];
        for (const pattern of prosePatterns) {
            if (pattern.test(content)) return false;
        }

        // Check for common command starters
        const commandPatterns = [
            /^(sudo\s+)?[a-z_][a-z0-9_-]*\s/i,  // command with args
            /^\$\s/,                             // $ prompt
            /^#\s*[a-z]/,                        // # followed by command (not just a comment)
            /^\.\/[a-z]/,                        // ./script
            /^cd\s/,                             // cd command
            /^ls(\s|$)/,                         // ls command
            /^cat\s/,                            // cat command
            /^echo\s/,                           // echo command
            /^grep\s/,                           // grep command
            /^docker\s/,                         // docker command
            /^kubectl\s/,                        // kubectl command
            /^systemctl\s/,                      // systemctl command
            /^service\s/,                        // service command
            /^apt(-get)?\s/,                     // apt command
            /^yum\s/,                            // yum command
            /^pip\s/,                            // pip command
            /^npm\s/,                            // npm command
            /^git\s/,                            // git command
            /^curl\s/,                           // curl command
            /^wget\s/,                           // wget command
            /^ssh\s/,                            // ssh command
            /^scp\s/,                            // scp command
            /^rsync\s/,                          // rsync command
            /^tar\s/,                            // tar command
            /^chmod\s/,                          // chmod command
            /^chown\s/,                          // chown command
            /^mkdir\s/,                          // mkdir command
            /^rm\s/,                             // rm command
            /^cp\s/,                             // cp command
            /^mv\s/,                             // mv command
            /^find\s/,                           // find command
            /^awk\s/,                            // awk command
            /^sed\s/,                            // sed command
            /^journalctl\s/,                     // journalctl command
            /^tail\s/,                           // tail command
            /^head\s/,                           // head command
            /^ps\s/,                             // ps command
            /^kill\s/,                           // kill command
            /^top(\s|$)/,                        // top command
            /^htop(\s|$)/,                       // htop command
            /^df\s/,                             // df command
            /^du\s/,                             // du command
            /^free(\s|$)/,                       // free command
            /^mount\s/,                          // mount command
            /^umount\s/,                         // umount command
        ];

        for (const pattern of commandPatterns) {
            if (pattern.test(content)) return true;
        }

        // If it's a single short line without spaces that could be a command name
        if (!content.includes('\n') && content.length < 50 && /^[a-z_][a-z0-9_-]*$/i.test(content)) {
            return true;
        }

        // Default: not a command
        return false;
    }

    function createCommandCard(pre, command) {
        // Create wrapper that replaces the plain pre block
        const cardId = 'cmd-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        const card = document.createElement('div');
        card.id = cardId;
        card.className = 'command-card bg-gradient-to-r from-gray-800 to-gray-800/80 rounded-lg border border-purple-500/30 my-3 overflow-hidden';
        card.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-900/50 border-b border-gray-700">
                <div class="flex items-center text-xs text-gray-400">
                    <i class="fas fa-terminal text-green-400 mr-2"></i>
                    <span>Command</span>
                </div>
                <div class="flex space-x-1">
                    <button class="copy-cmd-btn bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded transition-colors" title="Copy">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="p-3">
                <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 whitespace-pre-wrap break-all">${escapeHtml(command)}</div>
            </div>
            <div class="cmd-actions flex space-x-2 px-3 pb-3">
                <button class="run-cmd-btn flex-1 bg-green-600 hover:bg-green-500 text-white text-sm px-4 py-2 rounded font-medium transition-colors flex items-center justify-center">
                    <i class="fas fa-play mr-2"></i>Run in Terminal
                </button>
                <button class="skip-cmd-btn bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded font-medium transition-colors" title="Skip this command">
                    <i class="fas fa-forward"></i>
                </button>
            </div>
            <div class="cmd-output hidden"></div>
        `;

        // Replace pre with card
        pre.parentNode.replaceChild(card, pre);

        // Add event listeners
        const copyBtn = card.querySelector('.copy-cmd-btn');
        const runBtn = card.querySelector('.run-cmd-btn');
        const skipBtn = card.querySelector('.skip-cmd-btn');

        copyBtn.onclick = () => {
            copyToClipboard(command).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        };

        runBtn.onclick = () => {
            executeCommandWithOutput(cardId, command);
        };

        skipBtn.onclick = () => {
            dismissCommandCard(cardId);
        };
    }

    function addCopyButton(pre, block, lang) {
        // Simple copy button for non-shell code
        const btnContainer = document.createElement('div');
        btnContainer.className = 'code-actions absolute top-1 right-1 flex space-x-1 z-10';

        const langBadge = document.createElement('span');
        langBadge.className = 'bg-gray-800 text-gray-400 text-[10px] px-1.5 py-0.5 rounded';
        langBadge.textContent = lang;
        btnContainer.appendChild(langBadge);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded transition-colors';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.title = 'Copy code';
        copyBtn.onclick = () => {
            copyToClipboard(block.innerText.trim()).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        };
        btnContainer.appendChild(copyBtn);

        pre.className += ' relative bg-gray-900 rounded-md p-3 my-2 border border-gray-700 whitespace-pre-wrap break-words overflow-x-auto';
        pre.appendChild(btnContainer);
    }

    async function executeCommandWithOutput(cardId, command) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Check if we have a server connection (via terminal or direct)
        if (!currentServerId) {
            showToast('No server connected. Connect to a server first.', 'error');
            return;
        }

        // Update card to "executing" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center justify-center text-blue-400 text-sm py-2">
                <i class="fas fa-spinner fa-spin mr-2"></i>Executing via SSH...
            </div>
        `;

        // Update header to show running state
        const headerBadge = card.querySelector('.text-green-400');
        if (headerBadge) {
            headerBadge.className = 'fas fa-cog fa-spin text-blue-400 mr-2';
        }

        try {
            // Execute command via SSH API (clean output, no terminal escape codes)
            const response = await apiCall(`/api/servers/${currentServerId}/execute`, {
                method: 'POST',
                body: JSON.stringify({ command: command, timeout: 60 })
            });

            // Parse JSON from response
            const result = await response.json();

            console.log('Command execution result:', result);

            // Also show in terminal for visual feedback (optional)
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                terminalSocket.send(command + '\r');
            }

            // Determine success - check exit_code first, then success flag
            // exit_code 0 = success, or explicit success=true
            const isSuccess = (result.exit_code === 0) || (result.success === true);

            // Use the clean output from SSH - prefer stdout, fallback to stderr
            const output = result.stdout || result.stderr ||
                (isSuccess ? 'Command completed successfully' : (result.error || 'Command failed'));

            showCommandOutputInCard(cardId, command, output, isSuccess, result.exit_code);

        } catch (error) {
            console.error('Command execution failed:', error);

            // Fallback to terminal-based execution if API fails
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                actionsDiv.innerHTML = `
                    <div class="flex-1 flex items-center justify-center text-yellow-400 text-sm py-2">
                        <i class="fas fa-terminal mr-2"></i>Running in terminal (fallback)...
                    </div>
                `;

                const beforeLineCount = term.buffer.active.baseY + term.buffer.active.cursorY;
                terminalSocket.send(command + '\r');
                term.focus();

                setTimeout(() => {
                    const output = getCommandOutput(beforeLineCount, command);
                    showCommandOutputInCard(cardId, command, output, true, null);
                }, 2500);
            } else {
                showToast('Command execution failed: ' + error.message, 'error');
                actionsDiv.innerHTML = `
                    <div class="flex-1 flex items-center text-red-400 text-sm py-2">
                        <i class="fas fa-times-circle mr-2"></i>Failed
                    </div>
                `;
            }
        }
    }

    function getCommandOutput(beforeLineCount, command) {
        // Get only the lines that were added after the command was executed
        const buffer = term.buffer.active;
        const currentLineCount = buffer.baseY + buffer.cursorY;

        const lines = [];
        // Start from where we were before executing, skip 1 line (the command itself)
        const startLine = Math.max(0, beforeLineCount + 1);
        const endLine = currentLineCount + 1;

        for (let i = startLine; i < endLine; i++) {
            const line = buffer.getLine(i);
            if (line) {
                const text = line.translateToString(true);
                // Skip empty lines and the command prompt line at the end
                if (text.trim() && !text.match(/^\s*\$\s*$/)) {
                    lines.push(text);
                }
            }
        }

        // Remove the last line if it's just a prompt
        const lastLine = lines[lines.length - 1];
        if (lastLine && (lastLine.includes('$') || lastLine.includes('#')) && lastLine.trim().endsWith('$')) {
            lines.pop();
        }

        return lines.join('\n').trim();
    }

    function showCommandOutputInCard(cardId, command, output, success = true, exitCode = null) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Determine status based on success flag
        const isSuccess = success && (exitCode === null || exitCode === 0);
        const statusText = isSuccess
            ? (exitCode !== null ? `Executed (exit code: ${exitCode})` : 'Executed successfully')
            : `Failed (exit code: ${exitCode !== null ? exitCode : 'unknown'})`;
        const statusColor = isSuccess ? 'text-green-400' : 'text-red-400';
        const statusIcon = isSuccess ? 'fa-check-circle' : 'fa-times-circle';

        // Update card to "executed" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center ${statusColor} text-sm py-2">
                <i class="fas ${statusIcon} mr-2"></i>${statusText}
            </div>
            <button class="toggle-output-btn text-gray-400 hover:text-white text-sm px-3 py-2 transition-colors" title="Toggle output">
                <i class="fas fa-chevron-down"></i>
            </button>
        `;

        // Update header icon
        const headerIcon = card.querySelector('.fa-cog, .fa-terminal');
        if (headerIcon) {
            headerIcon.className = `fas ${statusIcon} ${statusColor} mr-2`;
        }

        // Add output section
        const outputDiv = card.querySelector('.cmd-output');
        if (outputDiv && output) {
            // Truncate very long output
            let displayOutput = output;
            if (displayOutput.length > 3000) {
                displayOutput = displayOutput.substring(0, 1500) + '\n... [truncated] ...\n' + displayOutput.substring(displayOutput.length - 1500);
            }

            outputDiv.innerHTML = `
                <div class="border-t border-gray-700 p-3 bg-gray-900/50">
                    <div class="text-xs text-gray-400 mb-2 flex items-center">
                        <i class="fas fa-terminal mr-1"></i>Output
                    </div>
                    <pre class="bg-gray-950 rounded p-3 text-xs text-gray-300 overflow-x-auto max-h-60 overflow-y-auto whitespace-pre-wrap">${escapeHtml(displayOutput)}</pre>
                </div>
            `;
            outputDiv.classList.remove('hidden');
        }

        // Toggle output visibility
        const toggleBtn = card.querySelector('.toggle-output-btn');
        if (toggleBtn && outputDiv) {
            toggleBtn.onclick = () => {
                outputDiv.classList.toggle('hidden');
                const icon = toggleBtn.querySelector('i');
                icon.className = outputDiv.classList.contains('hidden') ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            };
        }

        // Add to command history
        addToCommandHistory(command, output, exitCode, isSuccess);

        // Trigger auto-analyze after showing output
        triggerAutoAnalyze(command, output);
    }

    function dismissCommandCard(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;

        // Update card to "skipped" state
        const actionsDiv = card.querySelector('.cmd-actions');
        actionsDiv.innerHTML = `
            <div class="flex-1 flex items-center text-gray-500 text-sm py-2">
                <i class="fas fa-forward mr-2"></i>Skipped
            </div>
        `;

        // Dim the card
        card.className = card.className.replace('border-purple-500/30', 'border-gray-700/50');
        card.style.opacity = '0.6';
    }

    function triggerAutoAnalyze(command, output) {
        // Only analyze if we have actual output and a valid session
        if (!output || !output.trim() || !currentSessionId) {
            return;
        }

        // Small delay then auto-analyze using SSE streaming
        setTimeout(async () => {
            // Include command history context for AI awareness
            const historyContext = getCommandHistoryContext();

            // Build the analysis request message
            const analysisRequest = `[SYSTEM: The user executed the following command:\n\`\`\`\n${command}\n\`\`\`\n\nHere is the output:\n\`\`\`\n${output}\n\`\`\`${historyContext}\n\nPlease analyze this output and suggest the next step. You can reference previous commands from the history if relevant.]`;

            // Show analyzing indicator
            const container = document.getElementById('chatMessages');
            const note = document.createElement('div');
            note.className = 'text-center text-xs text-gray-500 my-2 analyzing-note';
            note.innerHTML = '<i class="fas fa-magic mr-1"></i>Analyzing output...';
            container.appendChild(note);
            container.scrollTop = container.scrollHeight;

            showTypingIndicator();

            // Send via SSE streaming (same as sendMessage)
            await sendStreamingMessage(analysisRequest);

            // Remove the analyzing note after response
            const noteEl = container.querySelector('.analyzing-note');
            if (noteEl) noteEl.remove();
        }, 500);
    }

    function updateCommandHistoryPanel() {
        const panel = document.getElementById('commandHistoryPanel');
        if (!panel) return;

        const listEl = panel.querySelector('.history-list');
        if (!listEl) return;

        if (commandHistory.length === 0) {
            listEl.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No commands executed yet</p>';
            return;
        }

        listEl.innerHTML = commandHistory.slice(0, 20).map(entry => `
            <div class="history-item bg-gray-800 rounded p-2 mb-2 group hover:bg-gray-700 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <i class="fas ${entry.success ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'} mr-2 flex-shrink-0"></i>
                        <span class="font-mono text-xs text-gray-300 truncate">${escapeHtml(entry.command)}</span>
                    </div>
                    <div class="flex items-center space-x-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="rerunCommand('${escapeHtml(entry.command).replace(/'/g, "\\'")}')" 
                            class="text-blue-400 hover:text-blue-300 text-xs px-1" title="Re-run">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="copyToClipboard('${escapeHtml(entry.command).replace(/'/g, "\\'")}')" 
                            class="text-gray-400 hover:text-white text-xs px-1" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="text-[10px] text-gray-500 mt-1">${entry.displayTime} • exit ${entry.exitCode}</div>
            </div>
        `).join('');
    }

    function rerunCommand(command) {
        // Create a temporary card and run the command
        if (!currentServerId) {
            showToast('Connect to a server first', 'error');
            return;
        }

        showToast('Re-running: ' + command.substring(0, 30) + '...', 'success');

        // Create a pseudo card for the rerun
        const cardId = 'rerun-' + Date.now();
        const container = document.getElementById('chatMessages');

        const card = document.createElement('div');
        card.id = cardId;
        card.className = 'command-card bg-gradient-to-r from-gray-800 to-gray-800/80 rounded-lg border border-blue-500/30 my-3 overflow-hidden';
        card.innerHTML = `
            <div class="flex items-center justify-between px-3 py-2 bg-gray-900/50 border-b border-gray-700">
                <div class="flex items-center text-xs text-gray-400">
                    <i class="fas fa-redo text-blue-400 mr-2"></i>
                    <span>Re-run</span>
                </div>
            </div>
            <div class="p-3">
                <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 whitespace-pre-wrap break-all">${escapeHtml(command)}</div>
            </div>
            <div class="cmd-actions flex space-x-2 px-3 pb-3">
                <div class="flex-1 flex items-center justify-center text-blue-400 text-sm py-2">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Executing...
                </div>
            </div>
            <div class="cmd-output hidden"></div>
        `;
        container.appendChild(card);
        container.scrollTop = container.scrollHeight;

        // Execute the command
        executeRerunCommand(cardId, command);
    }

    async function executeRerunCommand(cardId, command) {
        try {
            const response = await apiCall(`/api/servers/${currentServerId}/execute`, {
                method: 'POST',
                body: JSON.stringify({ command: command, timeout: 60 })
            });
            const result = await response.json();

            const isSuccess = (result.exit_code === 0) || (result.success === true);
            const output = result.stdout || result.stderr ||
                (isSuccess ? 'Command completed successfully' : (result.error || 'Command failed'));

            showCommandOutputInCard(cardId, command, output, isSuccess, result.exit_code);
        } catch (error) {
            console.error('Re-run failed:', error);
            showToast('Re-run failed: ' + error.message, 'error');
        }
    }

    // --- Terminal Logic ---

    function initTerminal() {
        if (term) return;

        term = new Terminal({
            cursorBlink: true,
            theme: {
                background: '#000000',
                foreground: '#ffffff'
            },
            fontSize: 12,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace'
        });

        fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);

        term.open(document.getElementById('terminal'));
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        term.onData(data => {
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                terminalSocket.send(data);
            }
        });

        // Add keyboard shortcuts for Ctrl+I (inline chat)
        term.attachCustomKeyEventHandler((event) => {
            // Ctrl+I - Open inline chat
            if (event.ctrlKey && event.key === 'i' && event.type === 'keydown') {
                event.preventDefault();
                toggleInlineChat();
                return false;
            }
            return true;
        });

        // Listen for text selection in terminal
        term.onSelectionChange(() => {
            const selection = term.getSelection();
            if (selection && selection.trim().length > 0) {
                showExplainButton(selection);
            } else {
                hideExplainButton();
            }
        });
    }

    // --- Inline Chat (Ctrl+I) ---

    let inlineChatVisible = false;

    function toggleInlineChat() {
        const overlay = document.getElementById('inlineChatOverlay');
        if (!overlay) return;

        inlineChatVisible = !inlineChatVisible;
        overlay.classList.toggle('hidden', !inlineChatVisible);

        if (inlineChatVisible) {
            const input = document.getElementById('inlineChatInput');
            if (input) {
                input.focus();
                input.value = '';
            }
        } else {
            term.focus();
        }
    }

    function closeInlineChat() {
        const overlay = document.getElementById('inlineChatOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
            inlineChatVisible = false;
            term.focus();
        }
    }

    function handleInlineChatKey(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendInlineChat();
        } else if (event.key === 'Escape') {
            closeInlineChat();
        }
    }

    function getTerminalContext(numLines = 30) {
        // Get the last N lines of visible terminal content
        if (!term) return '';

        const buffer = term.buffer.active;
        const lines = [];
        const startRow = Math.max(0, buffer.baseY + buffer.cursorY - numLines);
        const endRow = buffer.baseY + buffer.cursorY;

        for (let i = startRow; i <= endRow; i++) {
            const line = buffer.getLine(i);
            if (line) {
                lines.push(line.translateToString(true));
            }
        }

        return lines.join('\n').trim();
    }

    function sendInlineChat() {
        const input = document.getElementById('inlineChatInput');
        if (!input || !input.value.trim()) return;

        const question = input.value.trim();
        const terminalContext = getTerminalContext();

        // Build message with terminal context
        const message = `[TERMINAL CONTEXT - Current terminal output]\n\`\`\`\n${terminalContext}\n\`\`\`\n\n[USER QUESTION]\n${question}`;

        // Send to main chat
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(message);

            // Add user message to chat display
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex justify-end mb-2';
            msgDiv.innerHTML = `
                <div class="bg-gradient-to-r from-blue-600 to-blue-500 rounded-2xl rounded-br-sm px-4 py-2 max-w-[75%] shadow-lg">
                    <p class="text-sm text-white whitespace-pre-wrap break-words">${escapeHtml(question)}</p>
                    <div class="text-[10px] text-blue-200 mt-1 opacity-70">
                        <i class="fas fa-terminal mr-1"></i>from terminal
                    </div>
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;

            showTypingIndicator();
        } else {
            showToast('Chat not connected', 'error');
        }

        closeInlineChat();
    }

    function sendQuickInlineChat(question) {
        document.getElementById('inlineChatInput').value = question;
        sendInlineChat();
    }

    // --- Explain Selection (Gap 4) ---

    let currentSelection = '';

    function showExplainButton(selectedText) {
        currentSelection = selectedText;
        const btn = document.getElementById('explainSelectionBtn');
        if (!btn) return;

        // Position button near the selection (top-right of terminal)
        btn.style.top = '8px';
        btn.style.right = '8px';
        btn.classList.remove('hidden');
    }

    function hideExplainButton() {
        const btn = document.getElementById('explainSelectionBtn');
        if (btn) {
            btn.classList.add('hidden');
        }
        currentSelection = '';
    }

    function explainSelectedText() {
        if (!currentSelection || !currentSelection.trim()) {
            showToast('No text selected', 'error');
            return;
        }

        const message = `[EXPLAIN TERMINAL OUTPUT]\nPlease explain the following terminal output:\n\n\`\`\`\n${currentSelection}\n\`\`\`\n\nWhat does this mean? Is there an error? What action should I take?`;

        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(message);

            // Add visual feedback in chat
            const container = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'flex justify-end mb-2';
            msgDiv.innerHTML = `
                <div class="bg-gradient-to-r from-purple-600 to-purple-500 rounded-2xl rounded-br-sm px-4 py-2 max-w-[75%] shadow-lg">
                    <div class="text-[10px] text-purple-200 mb-1 flex items-center">
                        <i class="fas fa-magic mr-1"></i>Explain Selection
                    </div>
                    <pre class="text-sm text-white whitespace-pre-wrap break-words bg-black/30 rounded p-2 max-h-32 overflow-y-auto">${escapeHtml(currentSelection.substring(0, 500))}${currentSelection.length > 500 ? '...' : ''}</pre>
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;

            showTypingIndicator();
            showToast('Asking AI to explain...', 'success');
        } else {
            showToast('Chat not connected', 'error');
        }

        hideExplainButton();
        term.clearSelection();
    }

    // --- Gap 6: Slash Commands ---

    const slashCommands = {
        '/explain': {
            description: 'Explain terminal output or error',
            handler: (arg) => {
                const context = arg || getTerminalContext();
                return `[EXPLAIN REQUEST]\nPlease explain the following:\n\n\`\`\`\n${context}\n\`\`\`\n\nWhat does this mean?`;
            }
        },
        '/fix': {
            description: 'How to fix an error',
            handler: (arg) => {
                const context = arg || getTerminalContext();
                return `[FIX REQUEST]\nHelp me fix this error:\n\n\`\`\`\n${context}\n\`\`\`\n\nWhat's wrong and how do I fix it?`;
            }
        },
        '/next': {
            description: 'What should I do next?',
            handler: () => {
                const context = getTerminalContext();
                const history = getCommandHistoryContext();
                return `[NEXT STEP REQUEST]\nBased on my terminal output and command history, what should I do next?\n\nTerminal:\n\`\`\`\n${context}\n\`\`\`${history}`;
            }
        },
        '/suggest': {
            description: 'Suggest commands for a task',
            handler: (arg) => {
                return `[SUGGEST COMMANDS]\nSuggest Linux/shell commands to: ${arg || 'accomplish the current troubleshooting task'}\n\nContext: ${getTerminalContext(20)}`;
            }
        },
        '/history': {
            description: 'Summarize command history',
            handler: () => {
                const history = getCommandHistoryContext();
                if (!history) return 'No command history yet.';
                return `[HISTORY SUMMARY]\nPlease summarize what I've done so far based on command history:${history}\n\nWhat have I accomplished?`;
            }
        },
        '/clear': {
            description: 'Clear chat display',
            handler: () => {
                clearChat();
                return null; // Don't send message
            }
        }
    };

    function processSlashCommand(text) {
        for (const [cmd, config] of Object.entries(slashCommands)) {
            if (text.startsWith(cmd)) {
                const arg = text.substring(cmd.length).trim();
                return config.handler(arg);
            }
        }
        return text;
    }

    function showSlashCommandAutocomplete(input, text) {
        let dropdown = document.getElementById('slashCommandDropdown');

        if (!text.startsWith('/') || text.includes(' ')) {
            if (dropdown) dropdown.classList.add('hidden');
            return;
        }

        const matchingCommands = Object.entries(slashCommands)
            .filter(([cmd]) => cmd.startsWith(text))
            .slice(0, 5);

        if (matchingCommands.length === 0) {
            if (dropdown) dropdown.classList.add('hidden');
            return;
        }

        if (!dropdown) {
            dropdown = document.createElement('div');
            dropdown.id = 'slashCommandDropdown';
            dropdown.className = 'absolute bottom-full left-0 right-0 mb-1 bg-gray-800 border border-gray-600 rounded-lg shadow-xl overflow-hidden z-50';
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(dropdown);
        }

        dropdown.innerHTML = matchingCommands.map(([cmd, config], i) => `
            <div class="slash-cmd-item px-3 py-2 hover:bg-gray-700 cursor-pointer flex items-center ${i === 0 ? 'bg-gray-700' : ''}"
                 onclick="insertSlashCommand('${cmd}')">
                <span class="text-purple-400 font-mono text-sm mr-2">${cmd}</span>
                <span class="text-gray-400 text-xs">${config.description}</span>
            </div>
        `).join('');

        dropdown.classList.remove('hidden');
    }

    function insertSlashCommand(cmd) {
        const input = document.getElementById('chatInput');
        if (input) {
            input.value = cmd + ' ';
            input.focus();
        }
        const dropdown = document.getElementById('slashCommandDropdown');
        if (dropdown) dropdown.classList.add('hidden');
    }

    // Add input listener for autocomplete
    document.addEventListener('DOMContentLoaded', () => {
        const chatInput = document.getElementById('chatInput');
        if (chatInput) {
            chatInput.addEventListener('input', (e) => {
                showSlashCommandAutocomplete(chatInput, e.target.value);
            });

            chatInput.addEventListener('keydown', (e) => {
                const dropdown = document.getElementById('slashCommandDropdown');
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    if (e.key === 'Tab' || e.key === 'Enter') {
                        const firstItem = dropdown.querySelector('.slash-cmd-item');
                        if (firstItem && chatInput.value.startsWith('/') && !chatInput.value.includes(' ')) {
                            e.preventDefault();
                            const cmd = firstItem.querySelector('.text-purple-400').textContent;
                            insertSlashCommand(cmd);
                        }
                    }
                    if (e.key === 'Escape') {
                        dropdown.classList.add('hidden');
                    }
                }
            });

            chatInput.addEventListener('blur', () => {
                setTimeout(() => {
                    const dropdown = document.getElementById('slashCommandDropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                }, 200);
            });
        }
    });

    // Global keyboard shortcut handler
    document.addEventListener('keydown', (event) => {
        // Ctrl+I when not in input - toggle inline chat
        if (event.ctrlKey && event.key === 'i' && !event.target.matches('input, textarea')) {
            event.preventDefault();
            toggleInlineChat();
        }

        // Escape - close inline chat
        if (event.key === 'Escape' && inlineChatVisible) {
            closeInlineChat();
        }
    });

    async function openServerModal() {
        const modal = document.getElementById('serverModal');
        const list = document.getElementById('serverList');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        try {
            const response = await apiCall('/api/servers');
            if (!response.ok) throw new Error('Failed to load servers');

            const servers = await response.json();

            if (servers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm p-2">No servers configured.</p>';
                return;
            }

            list.innerHTML = servers.map(server => `
                <div class="p-3 bg-gray-800 rounded cursor-pointer hover:bg-gray-700 transition-colors" onclick="connectTerminal('${server.id}')">
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-blue-400">${server.name}</div>
                        <span class="text-xs bg-gray-700 px-2 py-1 rounded">${server.environment}</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        <i class="fas fa-server mr-1"></i>${server.username}@${server.hostname}:${server.port}
                    </div>
                </div>
            `).join('');

        } catch (error) {
            list.innerHTML = `<p class="text-red-400 text-sm p-2">Error: ${error.message}</p>`;
        }
    }

    function closeServerModal() {
        const modal = document.getElementById('serverModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        // Reset to saved servers tab
        switchServerTab('saved');
    }

    function switchServerTab(tab) {
        const tabSaved = document.getElementById('tabSavedServers');
        const tabQuick = document.getElementById('tabQuickConnect');
        const paneSaved = document.getElementById('savedServersPane');
        const paneQuick = document.getElementById('quickConnectPane');

        if (tab === 'saved') {
            tabSaved.className = 'px-4 py-2 text-sm font-medium border-b-2 border-purple-500 text-purple-400';
            tabQuick.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300';
            paneSaved.classList.remove('hidden');
            paneQuick.classList.add('hidden');
        } else {
            tabSaved.className = 'px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-300';
            tabQuick.className = 'px-4 py-2 text-sm font-medium border-b-2 border-purple-500 text-purple-400';
            paneSaved.classList.add('hidden');
            paneQuick.classList.remove('hidden');
            setTimeout(() => document.getElementById('adhocHost')?.focus(), 100);
        }
    }

    function connectAdhoc() {
        const host = document.getElementById('adhocHost').value.trim();
        const port = parseInt(document.getElementById('adhocPort').value) || 22;
        const username = document.getElementById('adhocUsername').value.trim();
        const password = document.getElementById('adhocPassword').value;

        if (!host) {
            showToast('Please enter a hostname or IP address', 'error');
            return;
        }
        if (!username) {
            showToast('Please enter a username', 'error');
            return;
        }

        closeServerModal();
        initTerminal();

        currentServerId = null; // Mark as ad-hoc connection

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const token = localStorage.getItem('token');

        if (terminalSocket) terminalSocket.close();

        const wsUrl = `${protocol}//${window.location.host}/ws/terminal/adhoc?token=${encodeURIComponent(token)}&host=${encodeURIComponent(host)}&port=${port}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&cols=${term.cols}&rows=${term.rows}`;

        terminalSocket = new WebSocket(wsUrl);

        document.getElementById('termStatus').textContent = `Connecting to ${host}...`;
        document.getElementById('termStatus').className = 'text-xs text-yellow-400';

        terminalSocket.onopen = () => {
            document.getElementById('termStatus').textContent = `${username}@${host}`;
            document.getElementById('termStatus').className = 'text-xs text-green-400';
            term.reset();
            term.write(`\r\n\x1b[32mConnected to ${host}...\x1b[0m\r\n`);
            showToast(`Connected to ${host}`, 'success');
        };

        terminalSocket.onmessage = (event) => {
            const data = event.data;
            if (data.startsWith('{"type":')) {
                try {
                    const msg = JSON.parse(data);
                    if (msg.type === 'ping' || msg.type === 'pong') return;
                    if (msg.type === 'error') {
                        term.write(`\r\n\x1b[31mError: ${msg.message}\x1b[0m\r\n`);
                        return;
                    }
                    return;
                } catch (e) { }
            }
            term.write(data);
        };

        terminalSocket.onclose = () => {
            document.getElementById('termStatus').textContent = 'Disconnected';
            document.getElementById('termStatus').className = 'text-xs text-red-400';
            term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
        };

        terminalSocket.onerror = (error) => {
            console.error('Ad-hoc WebSocket error:', error);
            showToast(`Connection failed to ${host}`, 'error');
        };

        // Clear password for security
        document.getElementById('adhocPassword').value = '';
    }

    function connectTerminal(serverId) {
        closeServerModal();
        initTerminal();

        // Store server ID for Agent Mode
        currentServerId = serverId;

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const token = localStorage.getItem('token');

        if (terminalSocket) {
            terminalSocket.close();
        }

        terminalSocket = new WebSocket(`${protocol}//${window.location.host}/ws/terminal/${serverId}?token=${token}&cols=${term.cols}&rows=${term.rows}`);

        // Loading state
        document.getElementById('termStatus').textContent = 'Connecting...';
        document.getElementById('termStatus').className = 'text-xs text-yellow-400';

        terminalSocket.onopen = () => {
            document.getElementById('termStatus').textContent = 'Connected';
            document.getElementById('termStatus').className = 'text-xs text-green-400';
            term.reset();
            term.write('\r\n\x1b[32mConnected to server...\x1b[0m\r\n');
        };

        terminalSocket.onmessage = (event) => {
            const data = event.data;
            // Filter out control messages (ping, pong, resize confirmations, etc.)
            if (data.startsWith('{"type":')) {
                try {
                    const msg = JSON.parse(data);
                    // Handle control messages silently
                    if (msg.type === 'ping' || msg.type === 'pong') {
                        return; // Ignore ping/pong messages
                    }
                    if (msg.type === 'error') {
                        term.write(`\r\n\x1b[31mError: ${msg.message}\x1b[0m\r\n`);
                        return;
                    }
                    // Unknown control message, ignore
                    return;
                } catch (e) {
                    // Not valid JSON, treat as terminal data
                }
            }
            term.write(data);
        };

        terminalSocket.onclose = () => {
            document.getElementById('termStatus').textContent = 'Disconnected';
            document.getElementById('termStatus').className = 'text-xs text-red-400';
            term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
        };
    }

    let analysisButton = null;
    let autoAnalyzeTimer = null;

    function runCommand(cmd) {
        if (!terminalSocket || terminalSocket.readyState !== WebSocket.OPEN) {
            showToast('Terminal not connected. Connect to a server first.', 'error');
            return;
        }

        // Clear any pending auto-analyze
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }

        // Send command with newline to auto-execute
        terminalSocket.send(cmd + '\r');
        term.focus();

        // Show in chat
        const container = document.getElementById('chatMessages');
        const runMsg = document.createElement('div');
        runMsg.className = 'flex justify-end my-2';
        runMsg.innerHTML = `
            <div class="bg-gray-800 border border-green-600/50 rounded-lg px-3 py-2 text-xs text-green-300 font-mono whitespace-pre-wrap break-all max-w-full">
                <i class="fas fa-play text-green-400 mr-2"></i><span class="text-gray-400">Executing:</span> ${escapeHtml(cmd)}
            </div>`;

        // If button exists, remove it first so we can move it to bottom
        if (analysisButton) {
            analysisButton.remove();
        }

        container.appendChild(runMsg);

        // Add countdown/analyze button
        analysisButton = document.createElement('div');
        analysisButton.className = 'flex justify-center my-4 fade-in';
        analysisButton.id = 'analysisCountdown';

        let countdown = 3;
        const updateCountdown = () => {
            analysisButton.innerHTML = `
                <div class="flex flex-col items-center space-y-2">
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>Auto-analyzing in ${countdown}s...
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="triggerAnalysis()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-full shadow-lg flex items-center transition-all">
                            <i class="fas fa-magic mr-2"></i>Analyze Now
                        </button>
                        <button onclick="cancelAutoAnalyze()" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-3 py-2 rounded-full">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        };

        updateCountdown();
        container.appendChild(analysisButton);
        container.scrollTop = container.scrollHeight;

        // Auto-analyze countdown
        const tick = () => {
            countdown--;
            if (countdown <= 0) {
                triggerAnalysis();
            } else {
                updateCountdown();
                autoAnalyzeTimer = setTimeout(tick, 1000);
            }
        };
        autoAnalyzeTimer = setTimeout(tick, 1000);

        // Reset last message role to force new bubble for next AI response
        lastMessageRole = 'system';
    }

    function cancelAutoAnalyze() {
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }
        if (analysisButton) {
            analysisButton.innerHTML = `
                <button onclick="triggerAnalysis()" class="bg-gray-600 hover:bg-gray-500 text-white text-sm px-6 py-2 rounded-full shadow-lg flex items-center transition-all">
                    <i class="fas fa-magic mr-2"></i>Analyze Later
                </button>
            `;
        }
    }

    function triggerAnalysis() {
        // Clear auto-analyze timer if running
        if (autoAnalyzeTimer) {
            clearTimeout(autoAnalyzeTimer);
            autoAnalyzeTimer = null;
        }

        if (analysisButton) {
            analysisButton.remove();
            analysisButton = null;
        }

        const container = document.getElementById('chatMessages');
        const note = document.createElement('div');
        note.className = 'text-center text-xs text-gray-500 my-2';
        note.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Reading terminal & analyzing...';
        container.appendChild(note);
        container.scrollTop = container.scrollHeight;

        // Small delay to ensure terminal buffer is updated
        setTimeout(() => {
            const termContent = getTerminalContent();
            if (termContent && chatSocket) {
                const analysisRequest = `[SYSTEM: The user has run one or more commands. Here is the current terminal output:\n\`\`\`\n${termContent}\n\`\`\`\nPlease analyze this output and suggest the next step.]`;
                chatSocket.send(analysisRequest);
                note.innerHTML = '<i class="fas fa-magic mr-1"></i>Analyzing terminal output...';
            } else {
                note.remove();
            }
        }, 500);
    }

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
        // Ctrl+L - Clear chat
        if (e.ctrlKey && e.key === 'l') {
            e.preventDefault();
            clearChat();
        }

        // Ctrl+K - Focus chat input
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            const input = document.getElementById('chatInput');
            if (input) input.focus();
        }

        // Ctrl+` - Focus terminal
        if (e.ctrlKey && e.key === '`') {
            e.preventDefault();
            if (term) term.focus();
        }

        // Escape - Clear chat input
        if (e.key === 'Escape') {
            const input = document.getElementById('chatInput');
            if (input && document.activeElement === input) {
                input.value = '';
                input.blur();
            }
        }
    });

    function clearChat() {
        document.getElementById('clearChatModal').classList.remove('hidden');
    }

    function closeClearChatModal() {
        document.getElementById('clearChatModal').classList.add('hidden');
    }

    function confirmClearChat() {
        closeClearChatModal();
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        showWelcomeScreen();
        lastMessageRole = null;
        currentMessageDiv = null;

        showToast('Chat cleared', 'success');
    }

    // --- Init ---
    // Use window.load to wait for ALL resources (including marked.js from CDN)
    window.addEventListener('load', function () {
        // Double-check marked is loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js failed to load from CDN');
            showToast('Failed to load chat library', 'error');
            return;
        }
        console.log('All resources loaded, initializing chat...');
        loadAlert();
    });

    // Handle window resize for terminal
    window.addEventListener('resize', () => {
        if (fitAddon) fitAddon.fit();
    });

    // ============================================
    // AGENT MODE
    // ============================================

    let agentSocket = null;
    let currentAgentSession = null;
    let currentServerId = null;
    let isAgentMode = false;

    function openAgentModal() {
        // Check if terminal is connected
        if (!terminalSocket || terminalSocket.readyState !== WebSocket.OPEN) {
            showToast('Please connect to a server first', 'error');
            return;
        }

        const modal = document.getElementById('agentModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById('agentGoal').focus();
    }

    function closeAgentModal() {
        const modal = document.getElementById('agentModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('agentGoal').value = '';
        document.getElementById('autoApprove').checked = false;
    }

    async function startAgent() {
        const goal = document.getElementById('agentGoal').value.trim();
        const autoApprove = document.getElementById('autoApprove').checked;

        if (!goal) {
            showToast('Please enter a goal for the agent', 'error');
            return;
        }

        if (!currentServerId) {
            showToast('Please connect to a server first', 'error');
            return;
        }

        try {
            const response = await apiCall('/api/agent/start', {
                method: 'POST',
                body: JSON.stringify({
                    chat_session_id: currentSessionId,
                    server_id: currentServerId,
                    goal: goal,
                    auto_approve: autoApprove
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to start agent');
            }

            currentAgentSession = await response.json();
            closeAgentModal();
            enterAgentMode(goal);
            connectAgentWebSocket(currentAgentSession.id);

        } catch (error) {
            console.error('Failed to start agent:', error);
            showToast(error.message || 'Failed to start agent', 'error');
        }
    }

    function enterAgentMode(goal) {
        isAgentMode = true;

        // Update UI
        const container = document.getElementById('chatMessages');
        container.innerHTML = `
            <div id="agentHeader" class="bg-gradient-to-r from-purple-900/50 to-blue-900/50 rounded-lg p-4 mb-4 border border-purple-500/30">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center mr-3 animate-pulse">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="text-sm font-semibold text-white">Agent Mode Active</div>
                            <div class="text-xs text-gray-400 truncate max-w-xs" title="${escapeHtml(goal)}">${escapeHtml(goal)}</div>
                        </div>
                    </div>
                    <button id="agentStopBtn" onclick="stopAgent()" class="text-red-400 hover:text-red-300 text-xs px-3 py-1 border border-red-500/30 rounded hover:bg-red-500/10 transition-colors">
                        <i class="fas fa-stop mr-1"></i>Stop
                    </button>
                </div>
                <div class="mt-3 flex items-center text-xs">
                    <span id="agentStatusBadge" class="px-2 py-1 rounded bg-purple-600/50 text-purple-200 mr-2">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Starting...
                    </span>
                    <span class="text-gray-400">Step <span id="agentStepNum">0</span> of <span id="agentMaxSteps">20</span></span>
                </div>
            </div>
            <div id="agentSteps" class="space-y-4"></div>
            <div id="agentApprovalPanel" class="hidden"></div>
        `;

        // Hide normal chat input, show agent input
        document.getElementById('chatForm').style.display = 'none';

        // Update agent button
        const agentBtn = document.getElementById('agentModeBtn');
        if (agentBtn) {
            agentBtn.classList.remove('text-gray-400', 'hover:text-purple-400');
            agentBtn.classList.add('text-purple-400', 'animate-pulse');
        }
    }

    function exitAgentMode() {
        isAgentMode = false;
        currentAgentSession = null;

        if (agentSocket) {
            agentSocket.close();
            agentSocket = null;
        }

        // Restore normal chat
        document.getElementById('chatForm').style.display = 'flex';

        // Reset agent button
        const agentBtn = document.getElementById('agentModeBtn');
        if (agentBtn) {
            agentBtn.classList.remove('text-purple-400', 'animate-pulse');
            agentBtn.classList.add('text-gray-400', 'hover:text-purple-400');
        }

        // Reload chat history
        if (currentSessionId) {
            loadMessageHistory(currentSessionId);
        }
    }

    function connectAgentWebSocket(sessionId) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const token = localStorage.getItem('token');

        if (agentSocket) {
            agentSocket.close();
        }

        agentSocket = new WebSocket(`${protocol}//${window.location.host}/ws/agent/${sessionId}?token=${token}`);

        agentSocket.onopen = () => {
            console.log('Agent WebSocket connected to session:', sessionId);
            updateAgentStatus('thinking', 'Analyzing...');
        };

        agentSocket.onmessage = (event) => {
            try {
                console.log('Raw WebSocket message:', event.data);
                const data = JSON.parse(event.data);
                handleAgentMessage(data);
            } catch (e) {
                console.error('Failed to parse agent message:', e, 'Raw data:', event.data);
            }
        };

        agentSocket.onclose = (event) => {
            console.log('Agent WebSocket closed. Code:', event.code, 'Reason:', event.reason, 'Clean:', event.wasClean);
            if (!event.wasClean && isAgentMode) {
                showToast('Agent connection lost', 'warning');
            }
        };

        agentSocket.onerror = (error) => {
            console.error('Agent WebSocket error:', error);
            showToast('Agent connection error', 'error');
        };
    }

    function handleAgentMessage(data) {
        console.log('Agent message received:', data.type, JSON.stringify(data));

        switch (data.type) {
            case 'connected':
                updateAgentStatus('thinking', 'Analyzing goal...');
                break;

            case 'status_changed':
                console.log('Status changed to:', data.status);
                updateAgentStatusFromServer(data.status);
                break;

            case 'step_created':
                console.log('Creating step:', data.step, 'auto_approve:', data.auto_approve, 'execute_in_terminal:', data.execute_in_terminal);
                addAgentStep(data.step, data.auto_approve);
                // If this is a command that should be executed in terminal (auto-approve mode)
                if (data.step.step_type === 'command' && data.execute_in_terminal && data.auto_approve) {
                    console.log('Auto-executing command in terminal');
                    executeAgentCommandInTerminal(data.step);
                }
                break;

            case 'step_updated':
                console.log('Updating step:', data.step);
                updateAgentStep(data.step);
                break;

            case 'complete':
                handleAgentComplete(data);
                break;

            case 'error':
                showToast(data.message || 'Agent error', 'error');
                break;

            default:
                console.warn('Unknown agent message type:', data.type, data);
        }
    }

    // Execute agent command in terminal and send result back
    async function executeAgentCommandInTerminal(step) {
        console.log('Executing command in terminal:', step.content);

        if (!currentServerId) {
            console.error('No server connected');
            sendAgentCommandResult(step.id, 'No server connected', 1);
            return;
        }

        try {
            // Send command to terminal for visibility
            if (terminalSocket && terminalSocket.readyState === WebSocket.OPEN) {
                terminalSocket.send(step.content + '\r');
            }

            // Execute via SSH API for clean output capture
            const response = await apiCall(`/api/servers/${currentServerId}/execute`, {
                method: 'POST',
                body: JSON.stringify({ command: step.content, timeout: 120 })
            });

            const result = await response.json();
            console.log('Command result:', result);

            const output = result.stdout || result.stderr || result.error || '';
            const exitCode = result.exit_code !== undefined ? result.exit_code : (result.success ? 0 : 1);

            // Send result back to agent backend
            sendAgentCommandResult(step.id, output, exitCode);

        } catch (error) {
            console.error('Command execution failed:', error);
            sendAgentCommandResult(step.id, error.message || 'Execution failed', 1);
        }
    }

    function sendAgentCommandResult(stepId, output, exitCode) {
        if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
            agentSocket.send(JSON.stringify({
                type: 'command_result',
                step_id: stepId,
                output: output,
                exit_code: exitCode
            }));
        } else {
            console.error('Agent WebSocket not connected');
        }
    }

    function updateAgentStatus(status, text) {
        const badge = document.getElementById('agentStatusBadge');
        if (!badge) return;

        const statusMap = {
            'thinking': { icon: 'fa-brain', color: 'bg-purple-600/50 text-purple-200', text: text || 'Thinking...' },
            'awaiting_approval': { icon: 'fa-pause-circle', color: 'bg-yellow-600/50 text-yellow-200', text: 'Awaiting approval' },
            'awaiting_input': { icon: 'fa-question-circle', color: 'bg-yellow-600/50 text-yellow-200', text: 'Awaiting your answer' },
            'executing': { icon: 'fa-cog fa-spin', color: 'bg-blue-600/50 text-blue-200', text: 'Executing...' },
            'completed': { icon: 'fa-check-circle', color: 'bg-green-600/50 text-green-200', text: 'Completed' },
            'failed': { icon: 'fa-times-circle', color: 'bg-red-600/50 text-red-200', text: 'Failed' },
            'stopped': { icon: 'fa-stop-circle', color: 'bg-gray-600/50 text-gray-200', text: 'Stopped' }
        };

        const config = statusMap[status] || statusMap.thinking;
        badge.className = `px-2 py-1 rounded ${config.color} mr-2`;
        badge.innerHTML = `<i class="fas ${config.icon} mr-1"></i>${config.text}`;
    }

    function updateAgentStatusFromServer(status) {
        updateAgentStatus(status);

        if (status === 'completed' || status === 'failed' || status === 'stopped') {
            // Stop the pulsing
            const agentBtn = document.getElementById('agentModeBtn');
            if (agentBtn) {
                agentBtn.classList.remove('animate-pulse');
            }
        }
    }

    function addAgentStep(step, autoApprove = false) {
        console.log('addAgentStep called with:', step, 'autoApprove:', autoApprove);

        const container = document.getElementById('agentSteps');
        if (!container) {
            console.error('agentSteps container not found');
            return;
        }

        // Update step counter
        const stepNum = document.getElementById('agentStepNum');
        if (stepNum) stepNum.textContent = step.step_number;

        const stepEl = document.createElement('div');
        stepEl.id = `agent-step-${step.id}`;
        stepEl.className = 'bg-gray-800 rounded-lg p-4 border border-gray-700';

        console.log('Step type:', step.step_type);

        if (step.step_type === 'command') {
            // Check if command was blocked by security policy
            if (step.status === 'blocked') {
                stepEl.className = 'bg-red-900/30 rounded-lg p-4 border border-red-500/30';
                stepEl.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-6 h-6 rounded-full bg-red-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                            <i class="fas fa-shield-alt text-red-400 text-xs"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="text-xs text-red-400 mb-1 font-semibold">⚠️ Command Blocked - Security Policy</div>
                            <div class="bg-gray-900 rounded p-2 font-mono text-sm text-red-400 break-all line-through">${escapeHtml(step.content)}</div>
                            ${step.blocked_reason ? `<div class="text-xs text-red-300 mt-2 bg-red-900/50 rounded p-2"><i class="fas fa-exclamation-triangle mr-1"></i>${escapeHtml(step.blocked_reason)}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                stepEl.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-6 h-6 rounded-full bg-blue-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                            <i class="fas fa-terminal text-blue-400 text-xs"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="text-xs text-gray-400 mb-1">Step ${step.step_number} - Command</div>
                            <div class="bg-gray-900 rounded p-2 font-mono text-sm text-green-400 break-all">${escapeHtml(step.content)}</div>
                            ${step.reasoning ? `<div class="text-xs text-gray-500 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>${escapeHtml(step.reasoning)}</div>` : ''}
                            <div id="step-output-${step.id}" class="mt-2 hidden">
                                <div class="text-xs text-gray-400 mb-1">Output:</div>
                                <pre class="bg-gray-900 rounded p-2 text-xs text-gray-300 overflow-x-auto max-h-40 overflow-y-auto"></pre>
                            </div>
                            <div id="step-status-${step.id}" class="mt-2 flex items-center text-xs text-gray-400">
                                <i class="fas fa-spinner fa-spin mr-1"></i>${autoApprove ? 'Executing in terminal...' : 'Awaiting approval...'}
                            </div>
                        </div>
                    </div>
                `;

                // Show approval panel only if NOT auto-approve mode
                if (step.status === 'pending' && !autoApprove) {
                    showApprovalPanel(step);
                }
            }

        } else if (step.step_type === 'complete') {
            stepEl.className = 'agent-step-complete rounded-lg p-4';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full agent-step-complete-icon flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-check text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs mb-1 font-semibold agent-step-complete-title">Goal Achieved!</div>
                        <div class="text-sm agent-step-complete-body">${marked.parse(step.content)}</div>
                    </div>
                </div>
            `;

        } else if (step.step_type === 'failed') {
            stepEl.className = 'agent-step-failed rounded-lg p-4';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full agent-step-failed-icon flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-times text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs agent-step-failed-title mb-1 font-semibold">Agent Failed</div>
                        <div class="text-sm agent-step-failed-body">${escapeHtml(step.content)}</div>
                    </div>
                </div>
            `;

        } else if (step.step_type === 'question') {
            stepEl.className = 'bg-yellow-900/30 rounded-lg p-4 border border-yellow-500/30';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-yellow-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-question text-yellow-400 text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs text-yellow-400 mb-1">Question from Agent</div>
                        <div class="text-sm text-gray-300 mb-3">${escapeHtml(step.content)}</div>
                        <div class="flex space-x-2">
                            <input type="text" id="agent-answer-${step.id}" class="input-field flex-grow px-3 py-2 rounded text-sm" placeholder="Your answer...">
                            <button onclick="answerAgentQuestion('${step.id}')" class="btn-primary px-4 py-2 rounded text-sm">Send</button>
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Unknown step type - show as info
            console.warn('Unknown step type:', step.step_type);
            stepEl.className = 'bg-gray-700/50 rounded-lg p-4 border border-gray-600';
            stepEl.innerHTML = `
                <div class="flex items-start">
                    <div class="w-6 h-6 rounded-full bg-gray-600/30 flex items-center justify-center mr-3 mt-0.5 flex-shrink-0">
                        <i class="fas fa-info text-gray-400 text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="text-xs text-gray-400 mb-1">Step ${step.step_number} - ${step.step_type || 'Unknown'}</div>
                        <div class="text-sm text-gray-300">${escapeHtml(step.content || 'No content')}</div>
                    </div>
                </div>
            `;
        }

        container.appendChild(stepEl);
        container.scrollTop = container.scrollHeight;
    }

    function updateAgentStep(step) {
        const outputDiv = document.getElementById(`step-output-${step.id}`);
        const statusDiv = document.getElementById(`step-status-${step.id}`);

        if (step.output && outputDiv) {
            outputDiv.classList.remove('hidden');
            const pre = outputDiv.querySelector('pre');
            if (pre) {
                // Truncate very long output
                let output = step.output;
                if (output.length > 5000) {
                    output = output.substring(0, 2500) + '\n... [truncated] ...\n' + output.substring(output.length - 2500);
                }
                pre.textContent = output;
            }
        }

        if (statusDiv) {
            if (step.status === 'executed') {
                const exitCode = step.exit_code || 0;
                if (exitCode === 0) {
                    statusDiv.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-1"></i>Executed successfully';
                    statusDiv.className = 'mt-2 flex items-center text-xs text-green-400';
                } else {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-circle text-yellow-400 mr-1"></i>Exited with code ${exitCode}`;
                    statusDiv.className = 'mt-2 flex items-center text-xs text-yellow-400';
                }
            } else if (step.status === 'rejected') {
                statusDiv.innerHTML = '<i class="fas fa-ban text-gray-400 mr-1"></i>Skipped by user';
                statusDiv.className = 'mt-2 flex items-center text-xs text-gray-400';
            } else if (step.status === 'failed') {
                statusDiv.innerHTML = '<i class="fas fa-times-circle text-red-400 mr-1"></i>Failed';
                statusDiv.className = 'mt-2 flex items-center text-xs text-red-400';
            }
        }

        // Hide approval panel
        hideApprovalPanel();
    }

    function showApprovalPanel(step) {
        updateAgentStatus('awaiting_approval');

        const panel = document.getElementById('agentApprovalPanel');
        if (!panel) return;

        panel.className = 'bg-gradient-to-r from-yellow-900/30 to-orange-900/30 rounded-lg p-4 mt-4 border border-yellow-500/30';
        panel.innerHTML = `
            <div class="flex items-center mb-3">
                <i class="fas fa-shield-alt text-yellow-400 mr-2"></i>
                <span class="text-sm font-semibold text-yellow-200">Approval Required</span>
            </div>
            <div class="text-xs text-gray-400 mb-2">The agent wants to execute:</div>
            <div class="bg-gray-900 rounded p-3 font-mono text-sm text-green-400 mb-3 break-all">${escapeHtml(step.content)}</div>
            ${step.reasoning ? `<div class="text-xs text-gray-400 mb-3"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>${escapeHtml(step.reasoning)}</div>` : ''}
            <div class="flex space-x-2">
                <button onclick="approveAgentStep()" class="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded font-medium transition-colors">
                    <i class="fas fa-check mr-2"></i>Approve & Run
                </button>
                <button onclick="rejectAgentStep()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded font-medium transition-colors">
                    <i class="fas fa-forward mr-2"></i>Skip
                </button>
            </div>
        `;

        // Scroll to show panel
        const container = document.getElementById('chatMessages');
        if (container) container.scrollTop = container.scrollHeight;
    }

    function hideApprovalPanel() {
        const panel = document.getElementById('agentApprovalPanel');
        if (panel) {
            panel.className = 'hidden';
            panel.innerHTML = '';
        }
    }

    async function approveAgentStep() {
        if (!currentAgentSession) return;

        try {
            // Send via WebSocket for faster response
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'approve' }));
            } else {
                // Fallback to REST API
                await apiCall(`/api/agent/${currentAgentSession.id}/approve`, 'POST');
            }

            hideApprovalPanel();
            updateAgentStatus('executing', 'Running command...');

        } catch (error) {
            console.error('Failed to approve step:', error);
            showToast('Failed to approve step', 'error');
        }
    }

    async function rejectAgentStep() {
        if (!currentAgentSession) return;

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'reject' }));
            } else {
                await apiCall(`/api/agent/${currentAgentSession.id}/reject`, 'POST');
            }

            hideApprovalPanel();
            updateAgentStatus('thinking', 'Agent is reconsidering...');

        } catch (error) {
            console.error('Failed to reject step:', error);
            showToast('Failed to skip step', 'error');
        }
    }

    async function answerAgentQuestion(stepId) {
        const input = document.getElementById(`agent-answer-${stepId}`);
        if (!input || !input.value.trim()) return;

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'answer', answer: input.value.trim() }));
            } else {
                await apiCall(`/api/agent/${currentAgentSession.id}/answer`, 'POST', { answer: input.value.trim() });
            }

            input.disabled = true;
            input.parentElement.innerHTML = `<div class="text-sm text-gray-400"><i class="fas fa-check text-green-400 mr-1"></i>Answered: ${escapeHtml(input.value)}</div>`;

        } catch (error) {
            console.error('Failed to send answer:', error);
            showToast('Failed to send answer', 'error');
        }
    }

    async function stopAgent() {
        if (!currentAgentSession) {
            exitAgentMode();
            return;
        }

        try {
            if (agentSocket && agentSocket.readyState === WebSocket.OPEN) {
                agentSocket.send(JSON.stringify({ type: 'stop' }));
            }

            await apiCall(`/api/agent/${currentAgentSession.id}/stop`, 'POST');

            updateAgentStatus('stopped');
            showToast('Agent stopped', 'info');

            // Add a button to exit agent mode
            const container = document.getElementById('agentSteps');
            if (container) {
                const exitBtn = document.createElement('div');
                exitBtn.className = 'text-center mt-4';
                exitBtn.innerHTML = `
                    <button onclick="exitAgentMode()" class="btn-secondary px-4 py-2 rounded">
                        <i class="fas fa-arrow-left mr-2"></i>Return to Chat
                    </button>
                `;
                container.appendChild(exitBtn);
            }

        } catch (error) {
            console.error('Failed to stop agent:', error);
            showToast('Failed to stop agent', 'error');
        }
    }

    function handleAgentComplete(data) {
        updateAgentStatus(data.status, data.status === 'completed' ? 'Goal achieved!' : 'Failed');

        // Stop the pulsing animation
        const robotIcon = document.querySelector('#agentHeader .animate-pulse');
        if (robotIcon) {
            robotIcon.classList.remove('animate-pulse');
        }

        // Replace Stop button with Return to Chat button in header
        const stopBtn = document.getElementById('agentStopBtn');
        if (stopBtn) {
            stopBtn.id = 'agentReturnBtn'; // Change ID so we don't try to replace twice
            stopBtn.className = 'text-blue-400 hover:text-blue-300 text-xs px-3 py-1 border border-blue-500/30 rounded hover:bg-blue-500/10 transition-colors';
            stopBtn.onclick = exitAgentMode;
            stopBtn.innerHTML = '<i class="fas fa-arrow-left mr-1"></i>Return to Chat';
        }

        // Also add exit button at bottom for visibility
        const container = document.getElementById('agentSteps');
        if (container) {
            const exitBtn = document.createElement('div');
            exitBtn.className = 'text-center mt-4';
            exitBtn.innerHTML = `
                <button onclick="exitAgentMode()" class="btn-primary px-4 py-2 rounded">
                    <i class="fas fa-arrow-left mr-2"></i>Return to Chat
                </button>
            `;
            container.appendChild(exitBtn);
        }

        if (data.status === 'completed') {
            showToast('Agent completed the goal!', 'success');
        } else {
            showToast(data.message || 'Agent failed', 'error');
        }
    }

    // Add keyboard shortcut for Agent Mode
    document.addEventListener('keydown', (e) => {
        // Ctrl+Shift+A - Open Agent Mode
        if (e.ctrlKey && e.shiftKey && e.key === 'A') {
            e.preventDefault();
            if (!isAgentMode) {
                openAgentModal();
            } else {
                stopAgent();
            }
        }
    });


    // --- Troubleshooting Logic ---

    function switchMainTab(tab) {
        // Toggle Buttons (alert-detail-tab styling)
        const btnLive = document.getElementById('btn-tab-live');
        const btnAnalysis = document.getElementById('btn-tab-analysis');
        if (btnLive && btnAnalysis) {
            btnLive.className = tab === 'live' ? 'alert-detail-tab active' : 'alert-detail-tab';
            btnAnalysis.className = tab === 'analysis' ? 'alert-detail-tab active' : 'alert-detail-tab';
        }

        // Toggle Content
        const tabLive = document.getElementById('tab-live');
        const tabAnalysis = document.getElementById('tab-analysis');

        if (tabLive && tabAnalysis) {
            if (tab === 'live') {
                tabLive.classList.remove('hidden');
                tabAnalysis.classList.add('hidden');
                // Refresh terminal fit
                if (fitAddon) setTimeout(() => fitAddon.fit(), 100);
            } else {
                tabLive.classList.add('hidden');
                tabAnalysis.classList.remove('hidden');
                // Load analysis data
                loadTroubleshootingData();
            }
        }
    }

    async function loadTroubleshootingData() {
        // 1. Get Correlation Data
        try {
            const correlation = await apiCall(`/api/v1/alerts/${alertId}/correlation`);
            if (correlation) {
                renderCorrelation(correlation);

                // 2. Trigger RCA if active
                if (correlation.status === 'active' && !correlation.root_cause_analysis) {
                    const rca = await apiCall(`/api/v1/alerts/${alertId}/analyze-root-cause`, 'POST');
                    if (rca) renderRCA(rca);
                } else if (correlation.root_cause_analysis) {
                    // Parse stored string into RCA object format
                    try {
                        const rcaRaw = correlation.root_cause_analysis || '';
                        const rcaLines = rcaRaw.split('\n').filter(line => line.trim().length > 0);
                        const rcaObj = {
                            root_cause: rcaLines[0] ? rcaLines[0].replace(/^Likely Root Cause: /, '') : 'Unknown Cause',
                            confidence: correlation.confidence_score || 0.8,
                            reasoning: rcaLines
                        };
                        renderRCA(rcaObj);
                    } catch (err) {
                        console.error('RCA Render Error:', err);
                    }
                }
            }

            // 3. Get Investigation Path
            try {
                const path = await apiCall(`/api/v1/alerts/${alertId}/investigation-path`);
                if (path) renderInvestigationPath(path);
            } catch (e) {
                console.warn("Investigation path not available", e);
            }

        } catch (e) {
            console.error("Error loading troubleshooting data", e);
            showToast('Error loading data: ' + e.message, 'error');
        }
    }

    function renderCorrelation(data) {
        const countEl = document.getElementById('corr-count');
        if (countEl) countEl.innerText = data.alerts ? data.alerts.length : 1;

        // Calc duration
        const start = new Date(data.created_at);
        const now = new Date();
        const diffHrs = Math.round((now - start) / 1000 / 60 / 60);
        const durEl = document.getElementById('corr-duration');
        if (durEl) durEl.innerText = diffHrs + "h";

        // Render List
        const list = document.getElementById('correlated-alerts-list');
        if (list) {
            list.innerHTML = (data.alerts || []).map(a => `
                <div class="bg-gray-800 p-3 rounded border border-gray-700 flex justify-between items-center hover:bg-gray-700 cursor-pointer" onclick="window.location.href='/alerts/${a.id}'">
                    <div>
                        <div class="font-bold text-sm text-gray-200">${a.alert_name}</div>
                        <div class="text-xs text-gray-500">${new Date(a.timestamp).toLocaleString()}</div>
                    </div>
                    <span class="badge-${a.severity} px-2 py-1 rounded text-xs">${a.severity}</span>
                </div>
            `).join('');
        }
    }

    function renderRCA(rca) {
        const loading = document.getElementById('rca-loading');
        const content = document.getElementById('rca-content');
        if (loading) loading.classList.add('hidden');
        if (content) content.classList.remove('hidden');

        const title = document.getElementById('rca-title');
        if (title) title.innerText = rca.root_cause;

        const desc = document.getElementById('rca-desc');
        if (desc) desc.innerText = "Identified with " + Math.round(rca.confidence * 100) + "% confidence.";

        const conf = document.getElementById('rca-confidence');
        if (conf) conf.innerText = (rca.confidence * 100) + "%";

        const reasons = document.getElementById('rca-reasoning');
        if (reasons) reasons.innerHTML = rca.reasoning.map(r => `<li>${r}</li>`).join('');
    }

    function renderInvestigationPath(path) {
        const container = document.getElementById('path-steps');
        if (container) {
            container.innerHTML = path.steps.map(step => `
                <div class="relative mb-4 pl-8">
                    <span class="absolute -left-[10px] top-0 w-5 h-5 rounded-full bg-purple-600 flex items-center justify-center text-[10px] font-bold text-white border-2 border-white shadow-sm">
                        ${step.step_number}
                    </span>
                    <div>
                        <h4 class="font-semibold text-purple-600 text-xs">${step.action}</h4>
                        <p class="text-slate-500 text-[11px] mb-1.5">${step.description}</p>
                        ${step.command_to_run ? `
                            <div class="bg-slate-100 rounded px-2 py-1.5 text-[11px] font-mono text-slate-700 flex justify-between items-center group border border-slate-200">
                                <code class="truncate">${escapeHtml(step.command_to_run)}</code>
                                <button class="flex-shrink-0 ml-2 text-slate-400 hover:text-slate-600" onclick="copyToClipboard(this.dataset.cmd)" data-cmd="${String(step.command_to_run).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
                                    <i class="fas fa-copy text-[10px]"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
    }

</script>
{% endblock %}