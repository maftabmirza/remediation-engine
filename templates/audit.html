{% extends "base.html" %}
{% set active_page = 'audit' %}

{% block title %}Audit Logs - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Audit Logs</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-clipboard-list text-amber-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Audit Logs</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar -->
    <div class="card p-4">
        <p class="text-sm text-[#64748b]">System activity, terminal session recordings, and chat transcripts.</p>
    </div>

    <!-- Tabs -->
    <div class="card overflow-hidden">
        <div class="flex border-b border-[#e2e8f0] bg-[#f8fafc]">
            <button onclick="switchTab('logs')" id="tab-logs"
                class="audit-tab px-4 py-3 text-sm font-medium border-b-2 border-[#3b82f6] text-[#2563eb]">
                System Logs
            </button>
            <button onclick="switchTab('sessions')" id="tab-sessions"
                class="audit-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-[#64748b] hover:text-[#1e293b]">
                Terminal Sessions
            </button>
            <button onclick="switchTab('chats')" id="tab-chats"
                class="audit-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-[#64748b] hover:text-[#1e293b]">
                Chat Sessions
            </button>
        </div>

    <!-- System Logs Tab -->
    <div id="view-logs" class="space-y-4">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="bg-[#f8fafc] text-[#64748b] border-b border-[#e2e8f0]">
                        <th class="px-6 py-3 font-medium">Time</th>
                        <th class="px-6 py-3 font-medium">User</th>
                        <th class="px-6 py-3 font-medium">Action</th>
                        <th class="px-6 py-3 font-medium">Resource</th>
                        <th class="px-6 py-3 font-medium">Details</th>
                    </tr>
                </thead>
                <tbody id="logsTableBody" class="text-[#334155] divide-y divide-[#e2e8f0]">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <p class="text-[#64748b]">Loading...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </div>

    <!-- Terminal Sessions Tab -->
    <div id="view-sessions" class="hidden space-y-4">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="bg-[#f8fafc] text-[#64748b] border-b border-[#e2e8f0]">
                        <th class="px-6 py-3 font-medium">Started</th>
                        <th class="px-6 py-3 font-medium">User</th>
                        <th class="px-6 py-3 font-medium">Server</th>
                        <th class="px-6 py-3 font-medium">Duration</th>
                        <th class="px-6 py-3 font-medium">Recording</th>
                    </tr>
                </thead>
                <tbody id="sessionsTableBody" class="text-[#334155] divide-y divide-[#e2e8f0]">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <p class="text-[#64748b]">Loading...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
    </div>

    <!-- Chat Sessions Tab -->
    <div id="view-chats" class="hidden space-y-4">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="bg-[#f8fafc] text-[#64748b] border-b border-[#e2e8f0]">
                        <th class="px-6 py-3 font-medium">Created</th>
                        <th class="px-6 py-3 font-medium">User</th>
                        <th class="px-6 py-3 font-medium">Title</th>
                        <th class="px-6 py-3 font-medium">Messages</th>
                        <th class="px-6 py-3 font-medium">Transcript</th>
                    </tr>
                </thead>
                <tbody id="chatsTableBody" class="text-[#334155] divide-y divide-[#e2e8f0]">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <p class="text-[#64748b]">Loading...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination Controls -->
            <div id="chatPagination"
                class="px-6 py-4 border-t border-[#e2e8f0] flex items-center justify-between hidden bg-[#f8fafc]">
                <span class="text-sm text-[#64748b]" id="chatPaginationInfo">
                    Showing 1 to 10 of 20 results
                </span>
                <div class="flex gap-2">
                    <button onclick="changeChatPage(-1)" id="btnPrevChat"
                        class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] hover:bg-[#f8fafc] disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <button onclick="changeChatPage(1)" id="btnNextChat"
                        class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] hover:bg-[#f8fafc] disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Recording Modal -->
<div id="recordingModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
        onclick="closeRecordingModal()"></div>

    <!-- Modal Panel -->
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-[#1e1e2e] text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl border border-gray-700 flex flex-col h-[80vh]">

                <!-- Header -->
                <div
                    class="bg-[#282a36] px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-700 shrink-0">
                    <h3 class="text-lg font-semibold leading-6 text-white">Session Recording</h3>
                    <button type="button" class="rounded-md text-gray-400 hover:text-white focus:outline-none"
                        onclick="closeRecordingModal()">
                        <span class="sr-only">Close</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="p-0 flex-1 bg-black overflow-hidden relative" style="min-height: 500px;">
                    <div id="terminal-container" class="h-full w-full"></div>
                </div>

                <!-- Footer -->
                <div
                    class="bg-[#282a36] px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-700 shrink-0">
                    <button type="button"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-gray-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500 sm:mt-0 sm:w-auto"
                        onclick="closeRecordingModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transcript Modal -->
<div id="transcriptModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity" aria-hidden="true"
        onclick="closeTranscriptModal()"></div>

    <!-- Modal Panel -->
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-lg bg-[#1e1e2e] text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl border border-gray-700 flex flex-col max-h-[85vh]">

                <!-- Header -->
                <div
                    class="bg-[#282a36] px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-700 shrink-0">
                    <h3 class="text-lg font-semibold leading-6 text-white">Chat Transcript</h3>
                    <button type="button" class="rounded-md text-gray-400 hover:text-white focus:outline-none"
                        onclick="closeTranscriptModal()">
                        <span class="sr-only">Close</span>
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="px-4 py-4 sm:p-6 overflow-y-auto flex-1 bg-[#1e1e2e]">
                    <div id="transcript-container" class="space-y-4">
                        <!-- Messages injected here -->
                    </div>
                </div>

                <!-- Footer -->
                <div
                    class="bg-[#282a36] px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-gray-700 shrink-0">
                    <button type="button"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-gray-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500 sm:mt-0 sm:w-auto"
                        onclick="closeTranscriptModal()">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let currentTab = 'logs';
    let term = null;
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type) { alert(message); };
    }

    // Chat Pagination State
    let chatPage = 1;
    const chatLimit = 10;
    let chatTotal = 0;

    function switchTab(tab) {
        currentTab = tab;

        const activeClass = 'audit-tab px-4 py-3 text-sm font-medium border-b-2 border-[#3b82f6] text-[#2563eb]';
        const inactiveClass = 'audit-tab px-4 py-3 text-sm font-medium border-b-2 border-transparent text-[#64748b] hover:text-[#1e293b]';

        document.getElementById('tab-logs').className = tab === 'logs' ? activeClass : inactiveClass;
        document.getElementById('tab-sessions').className = tab === 'sessions' ? activeClass : inactiveClass;
        document.getElementById('tab-chats').className = tab === 'chats' ? activeClass : inactiveClass;

        document.getElementById('view-logs').classList.toggle('hidden', tab !== 'logs');
        document.getElementById('view-sessions').classList.toggle('hidden', tab !== 'sessions');
        document.getElementById('view-chats').classList.toggle('hidden', tab !== 'chats');

        // Load data if needed
        if (tab === 'logs') loadLogs();
        else if (tab === 'sessions') loadSessions();
        else if (tab === 'chats') loadChats();
    }

    async function loadLogs() {
        try {
            const logs = await apiCall('/api/audit/logs');
            renderLogs(Array.isArray(logs) ? logs : []);
        } catch (error) {
            console.error('Failed to load logs:', error);
            showToast('Failed to load audit logs', 'error');
            renderLogs([]);
        }
    }

    function renderLogs(logs) {
        const tbody = document.getElementById('logsTableBody');

        if (logs.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-[#64748b]">
                        <i class="fas fa-inbox text-4xl mb-3 text-[#94a3b8]"></i>
                        <p>No audit logs found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = logs.map(log => `
            <tr class="hover:bg-[#f8fafc] transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-[#64748b]">
                    ${new Date(log.created_at).toLocaleString()}
                </td>
                <td class="px-6 py-4 font-medium text-[#1e293b]">
                    ${(log.username || 'System').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4">
                    <span class="px-2 py-1 rounded text-xs font-mono bg-[#eff6ff] text-[#2563eb] border border-[#bfdbfe]">
                        ${(log.action||'').replace(/</g,'&lt;')}
                    </span>
                </td>
                <td class="px-6 py-4 text-[#475569]">
                    ${(log.resource_type||'-').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4 text-[#64748b] text-xs font-mono max-w-xs truncate">
                    ${log.details_json ? JSON.stringify(log.details_json).replace(/</g,'&lt;') : '-'}
                </td>
            </tr>
        `).join('');
    }

    async function loadSessions() {
        try {
            const sessions = await apiCall('/api/audit/terminal-sessions');
            renderSessions(Array.isArray(sessions) ? sessions : []);
        } catch (error) {
            console.error('Failed to load sessions:', error);
            showToast('Failed to load terminal sessions', 'error');
            renderSessions([]);
        }
    }

    function renderSessions(sessions) {
        const tbody = document.getElementById('sessionsTableBody');

        if (sessions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-[#64748b]">
                        <i class="fas fa-inbox text-4xl mb-3 text-[#94a3b8]"></i>
                        <p>No terminal sessions found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = sessions.map(session => {
            const start = new Date(session.started_at);
            const end = session.ended_at ? new Date(session.ended_at) : null;
            const duration = end ? Math.round((end - start) / 1000) + 's' : 'Active';

            return `
            <tr class="hover:bg-[#f8fafc] transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-[#64748b]">
                    ${start.toLocaleString()}
                </td>
                <td class="px-6 py-4 font-medium text-[#1e293b]">
                    ${(session.username||'').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4 text-green-600">
                    <i class="fas fa-server mr-2"></i>${(session.server_name||'').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4 text-[#475569]">
                    ${duration}
                </td>
                <td class="px-6 py-4">
                    ${session.has_recording ? `
                        <button onclick="playRecording('${session.id}')" class="px-3 py-1.5 rounded text-xs border border-[#e2e8f0] bg-white text-[#475569] hover:bg-[#f8fafc]">
                            <i class="fas fa-play mr-2"></i> Play
                        </button>
                    ` : '<span class="text-[#94a3b8] text-xs">No recording</span>'}
                </td>
            </tr>
            `;
        }).join('');
    }

    async function playRecording(sessionId) {
        try {
            const data = await apiCall(`/api/audit/terminal-sessions/${sessionId}/recording`);
            if (!data) return;

            const modal = document.getElementById('recordingModal');
            modal.classList.remove('hidden');

            const container = document.getElementById('terminal-container');
            container.innerHTML = '';

            // Force layout
            void modal.offsetWidth;

            // Wait for transition to complete
            setTimeout(() => {
                if (term) term.dispose();

                term = new Terminal({
                    cursorBlink: false,
                    disableStdin: true,
                    fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                    fontSize: 14,
                    theme: {
                        background: '#000000',
                        foreground: '#ffffff'
                    },
                    rows: 40,
                    cols: 120
                });

                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                term.open(container);

                // Write content
                if (data.content) {
                    const content = data.content.replace(/\r\n/g, '\n').replace(/\n/g, '\r\n');
                    term.write(content);
                } else {
                    term.write('\r\nNo content in recording file.');
                }

                // Try to fit after rendering
                setTimeout(() => {
                    try {
                        fitAddon.fit();
                        if (term.rows < 5) term.resize(120, 40);
                    } catch (e) {
                        console.warn('Fit failed', e);
                    }
                }, 50);

            }, 300);

        } catch (error) {
            console.error(error);
            showToast('Failed to load recording', 'error');
        }
    }

    function closeRecordingModal() {
        document.getElementById('recordingModal').classList.add('hidden');
        if (term) {
            term.dispose();
            term = null;
        }
    }

    async function viewTranscript(sessionId) {
        try {
            const messages = await apiCall(`/api/audit/chat-sessions/${sessionId}/transcript`);
            const list = Array.isArray(messages) ? messages : (messages?.items || messages?.messages || []);

            document.getElementById('transcriptModal').classList.remove('hidden');

            const container = document.getElementById('transcript-container');
            container.innerHTML = list.map(msg => {
                const role = (msg.role || '').replace(/</g,'&lt;');
                const content = (msg.content || '').replace(/</g,'&lt;').replace(/\n/g,'<br>');
                const isUser = role === 'user';
                return `
                <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
                    <div class="max-w-[80%] rounded-lg p-3 ${isUser ? 'bg-blue-600 text-white' : 'bg-[#f1f5f9] text-[#334155] border border-[#e2e8f0]'}">
                        <div class="text-xs opacity-75 mb-1 uppercase">${role}</div>
                        <div class="whitespace-pre-wrap font-mono text-sm">${content}</div>
                    </div>
                    <div class="text-xs text-[#64748b] mt-1">${new Date(msg.created_at).toLocaleString()}</div>
                </div>
            `;
            }).join('');

        } catch (error) {
            showToast('Failed to load transcript', 'error');
        }
    }

    function closeTranscriptModal() {
        document.getElementById('transcriptModal').classList.add('hidden');
    }

    async function loadChats() {
        try {
            const data = await apiCall(`/api/audit/chat-sessions?page=${chatPage}&limit=${chatLimit}`);
            chatTotal = (data && typeof data.total === 'number') ? data.total : 0;
            renderChats(Array.isArray(data?.items) ? data.items : []);
            updateChatPagination();
        } catch (error) {
            console.error('Failed to load chats:', error);
            showToast('Error loading chats', 'error');
            chatTotal = 0;
            renderChats([]);
            updateChatPagination();
        }
    }

    function renderChats(chats) {
        const tbody = document.getElementById('chatsTableBody');

        if (chats.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-[#64748b]">
                        <i class="fas fa-inbox text-4xl mb-3 text-[#94a3b8]"></i>
                        <p>No chat sessions found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = chats.map(chat => `
            <tr class="hover:bg-[#f8fafc] transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-[#64748b]">
                    ${new Date(chat.created_at).toLocaleString()}
                </td>
                <td class="px-6 py-4 font-medium text-[#1e293b]">
                    ${(chat.username||'').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4 text-blue-600">
                    ${(chat.title || 'Untitled Session').replace(/</g,'&lt;')}
                </td>
                <td class="px-6 py-4 text-[#475569]">
                    ${chat.message_count || 0} msgs
                </td>
                <td class="px-6 py-4">
                    <button onclick="viewTranscript('${chat.id}')" class="px-3 py-1.5 rounded text-xs border border-[#e2e8f0] bg-white text-[#475569] hover:bg-[#f8fafc]">
                        <i class="fas fa-eye mr-2"></i> View
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function updateChatPagination() {
        const pagination = document.getElementById('chatPagination');
        if (chatTotal === 0) {
            pagination.classList.add('hidden');
            return;
        }

        pagination.classList.remove('hidden');

        const start = (chatPage - 1) * chatLimit + 1;
        const end = Math.min(chatPage * chatLimit, chatTotal);

        document.getElementById('chatPaginationInfo').textContent =
            `Showing ${start} to ${end} of ${chatTotal} results`;

        document.getElementById('btnPrevChat').disabled = chatPage === 1;
        document.getElementById('btnNextChat').disabled = end >= chatTotal;
    }

    function changeChatPage(delta) {
        chatPage += delta;
        loadChats();
    }

    // Initial load
    loadLogs();

    // Move modals to body to avoid z-index/overflow issues
    document.addEventListener('DOMContentLoaded', () => {
        const modals = ['transcriptModal', 'recordingModal'];
        modals.forEach(id => {
            const modal = document.getElementById(id);
            if (modal && modal.parentElement !== document.body) {
                document.body.appendChild(modal);
            }
        });
    });
</script>
{% endblock %}