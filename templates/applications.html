{% extends "base.html" %}
{% set active_page = 'applications' %}

{% block title %}Application Registry - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Applications</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-layer-group text-blue-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Application Registry</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<style>
    /* Action Buttons - Same as Runbooks */
    .app-action-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        white-space: nowrap;
    }

    .app-action-primary {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }

    .app-action-primary:hover {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        box-shadow: 0 4px 14px rgba(59, 130, 246, 0.35);
        transform: translateY(-1px);
    }

    .app-action-primary:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
    }

    .app-action-secondary {
        background: #ffffff;
        color: #475569;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .app-action-secondary:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        background: #f8fafc;
        transform: translateY(-1px);
    }

    .app-action-secondary:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }

    .app-action-btn i {
        font-size: 12px;
    }

    /* Search Input Styling */
    .app-search-input {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 14px 8px 36px;
        font-size: 13px;
        color: #1e293b;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
    }

    .app-search-input::placeholder {
        color: #94a3b8;
    }

    .app-search-input:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .app-search-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .app-search-wrapper {
        position: relative;
    }

    .app-search-wrapper .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 13px;
        pointer-events: none;
    }

    /* Custom Dropdown Component - Same as Runbooks rb-dropdown */
    .app-dropdown {
        position: relative;
        min-width: 150px;
    }

    .app-dropdown-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 8px 12px 8px 14px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        outline: none;
        user-select: none;
        white-space: nowrap;
    }

    .app-dropdown-trigger:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .app-dropdown.open .app-dropdown-trigger {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .app-dropdown-trigger .app-dd-chevron {
        width: 14px;
        height: 14px;
        color: #94a3b8;
        transition: transform 0.2s ease;
        flex-shrink: 0;
    }

    .app-dropdown.open .app-dd-chevron {
        transform: rotate(180deg);
    }

    .app-dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 6px);
        left: 0;
        min-width: 100%;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
        z-index: 9999;
        padding: 5px;
        overflow: hidden;
    }

    .app-dropdown.open .app-dropdown-menu {
        display: block;
        animation: appDropIn 0.15s ease-out;
    }

    @keyframes appDropIn {
        from {
            opacity: 0;
            transform: translateY(-6px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .app-dropdown-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.12s ease;
        white-space: nowrap;
    }

    .app-dropdown-item:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .app-dropdown-item.selected {
        background: rgba(59, 130, 246, 0.08);
        color: #2563eb;
    }

    .app-dropdown-item .app-dd-check {
        width: 14px;
        font-size: 11px;
        color: #3b82f6;
        opacity: 0;
    }

    .app-dropdown-item.selected .app-dd-check {
        opacity: 1;
    }

    .app-dropdown select {
        display: none;
    }

    .app-dd-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        flex-shrink: 0;
    }

    /* Modern Badge Styles - Same as Runbooks */
    .badge {
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        letter-spacing: 0.03em;
    }

    .badge-critical {
        background-color: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }

    .badge-critical::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #dc2626;
        display: inline-block;
    }

    .badge-high {
        background-color: #fffbeb;
        color: #d97706;
        border: 1px solid #fde68a;
    }

    .badge-high::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #f59e0b;
        display: inline-block;
    }

    .badge-medium {
        background-color: #eff6ff;
        color: #2563eb;
        border: 1px solid #bfdbfe;
    }

    .badge-medium::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #3b82f6;
        display: inline-block;
    }

    .badge-low {
        background-color: #f1f5f9;
        color: #64748b;
        border: 1px solid #e2e8f0;
    }

    .badge-low::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #94a3b8;
        display: inline-block;
    }

    .app-modal-overlay {
        z-index: 2000;
    }

    @media (max-width: 640px) {
        .app-action-btn {
            padding: 8px 12px;
        }

        .app-dropdown {
            min-width: 120px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar with Filters and Actions -->
    <div class="card p-4" style="overflow: visible; position: relative; z-index: 200;">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <!-- Left: Filters -->
            <div class="flex flex-wrap gap-3 items-center flex-1">
                <div class="app-search-wrapper flex-1 min-w-[200px]">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search applications..."
                        onkeyup="filterApplications()" class="app-search-input w-full">
                </div>
                <!-- Criticality Dropdown -->
                <div class="app-dropdown" id="criticalityDropdown">
                    <select id="criticalityFilter">
                        <option value="">All Criticality</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <div class="app-dropdown-trigger" onclick="toggleAppDropdown('criticalityDropdown')">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-circle-dot" style="font-size: 11px; color: #94a3b8;"></i>
                            <span class="app-dd-label">All Criticality</span>
                        </div>
                        <svg class="app-dd-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div class="app-dropdown-menu">
                        <div class="app-dropdown-item selected" data-value=""
                            onclick="selectAppOption('criticalityDropdown','','All Criticality')">
                            <i class="fas fa-check app-dd-check"></i>
                            <span class="app-dd-dot"
                                style="background: linear-gradient(135deg, #ef4444, #f97316, #3b82f6);"></span>
                            All Criticality
                        </div>
                        <div class="app-dropdown-item" data-value="critical"
                            onclick="selectAppOption('criticalityDropdown','critical','Critical')">
                            <i class="fas fa-check app-dd-check"></i>
                            <span class="app-dd-dot" style="background: #ef4444;"></span>
                            Critical
                        </div>
                        <div class="app-dropdown-item" data-value="high"
                            onclick="selectAppOption('criticalityDropdown','high','High')">
                            <i class="fas fa-check app-dd-check"></i>
                            <span class="app-dd-dot" style="background: #f97316;"></span>
                            High
                        </div>
                        <div class="app-dropdown-item" data-value="medium"
                            onclick="selectAppOption('criticalityDropdown','medium','Medium')">
                            <i class="fas fa-check app-dd-check"></i>
                            <span class="app-dd-dot" style="background: #3b82f6;"></span>
                            Medium
                        </div>
                        <div class="app-dropdown-item" data-value="low"
                            onclick="selectAppOption('criticalityDropdown','low','Low')">
                            <i class="fas fa-check app-dd-check"></i>
                            <span class="app-dd-dot" style="background: #94a3b8;"></span>
                            Low
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Action Buttons -->
            <div class="flex items-center gap-2 flex-wrap" style="position: relative; z-index: 210;">
                <button onclick="openCreateModal()" class="app-action-btn app-action-primary"
                    title="Register New Application">
                    <i class="fas fa-plus"></i>
                    <span>Register App</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card p-4" style="border-left: 3px solid #3b82f6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                    <i class="fas fa-layer-group" style="color: #2563eb; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Total Apps</p>
                    <p class="text-2xl font-bold text-primary" id="statTotal" style="line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #ef4444;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                    <i class="fas fa-exclamation-triangle" style="color: #dc2626; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Critical</p>
                    <p class="text-2xl font-bold" id="statCritical" style="color: #dc2626; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
        <div class="card p-4" style="border-left: 3px solid #8b5cf6;">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                    style="background: linear-gradient(135deg, #f5f3ff, #ede9fe);">
                    <i class="fas fa-cubes" style="color: #7c3aed; font-size: 14px;"></i>
                </div>
                <div>
                    <p class="text-secondary text-xs"
                        style="font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">Components</p>
                    <p class="text-2xl font-bold" id="statComponents" style="color: #7c3aed; line-height: 1.2;">0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="card overflow-hidden" id="tableContainer">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-4 py-3 font-medium">Application</th>
                    <th class="px-4 py-3 font-medium">Criticality</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Team Owner</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Stack</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Updated</th>
                    <th class="px-4 py-3 font-medium text-right">Actions</th>
                </tr>
            </thead>
            <tbody id="appTableBody" class="text-[#334155]">
                <!-- Populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="pagination-container" class="flex items-center justify-between mt-4 text-sm hidden">
        <div class="text-[#64748b]">
            Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> of <span id="total-count">0</span>
            applications
        </div>
        <div class="flex items-center gap-2">
            <button onclick="goToPage(1)" id="first-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-left"></i>
            </button>
            <button onclick="goToPage(currentPage - 1)" id="prev-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-left"></i>
            </button>
            <span class="px-3 py-1.5 text-[#475569]">Page <span id="current-page">1</span> of <span
                    id="total-pages">1</span></span>
            <button onclick="goToPage(currentPage + 1)" id="next-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-right"></i>
            </button>
            <button onclick="goToPage(totalPages)" id="last-page-btn" disabled
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors">
                <i class="fas fa-angle-double-right"></i>
            </button>
            <select id="page-size" onchange="changePageSize(this.value)"
                class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] focus:outline-none focus:border-[#3b82f6]">
                <option value="10">10 per page</option>
                <option value="25" selected>25 per page</option>
                <option value="50">50 per page</option>
            </select>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="card p-12 text-center hidden">
        <i class="fas fa-layer-group text-4xl text-secondary mb-4"></i>
        <h3 class="text-lg font-medium text-primary mb-2">No Applications Found</h3>
        <p class="text-secondary mb-4">Register an application to start mapping services and dependencies.</p>
        <button onclick="openCreateModal()" class="btn-primary px-4 py-2 rounded-lg">
            <i class="fas fa-plus mr-2"></i>Register App
        </button>
    </div>
</div>

<!-- Create/Edit Application Modal -->
<div id="createModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden app-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-primary" id="modalTitle">Register New Application</h2>
            <button onclick="closeCreateModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <form id="appForm" onsubmit="saveApplication(event)">
            <div class="space-y-4">
                <div>
                    <label class="block text-secondary text-sm mb-1">Application Name (Slug)</label>
                    <input type="text" id="appName" required
                        class="input-field w-full px-3 py-2 rounded text-sm font-mono"
                        placeholder="e.g. payment-service">
                    <p class="text-xs text-secondary mt-1">Unique identifier, no spaces</p>
                </div>
                <div>
                    <label class="block text-secondary text-sm mb-1">Display Name</label>
                    <input type="text" id="appDisplayName" class="input-field w-full px-3 py-2 rounded text-sm"
                        placeholder="e.g. Payment Processing Service">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-secondary text-sm mb-1">Criticality</label>
                        <select id="appCriticality" class="input-field w-full px-3 py-2 rounded text-sm">
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium" selected>Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-secondary text-sm mb-1">Team Owner</label>
                        <input type="text" id="appOwner" class="input-field w-full px-3 py-2 rounded text-sm"
                            placeholder="e.g. Payments Team">
                    </div>
                </div>
                <div>
                    <label class="block text-secondary text-sm mb-1">Description</label>
                    <textarea id="appDescription" rows="3"
                        class="input-field w-full px-3 py-2 rounded text-sm resize-none"
                        placeholder="Brief description of the application..."></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeCreateModal()" class="btn-secondary px-4 py-2 rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="btn-primary px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>Register Application
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Delete Modal -->
<div id="confirmModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden app-modal-overlay flex items-center justify-center p-4">
    <div class="card p-6 w-full max-w-md">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-primary" id="confirmTitle">Confirm Action</h2>
            <button onclick="closeConfirmModal()" class="text-secondary hover:text-primary">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <p class="text-secondary mb-6" id="confirmMessage">Are you sure?</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeConfirmModal()" class="btn-secondary px-4 py-2 rounded-lg">Cancel</button>
            <button id="confirmBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========================================================================
    // Custom Dropdown Logic
    // ========================================================================
    function toggleAppDropdown(id) {
        const dd = document.getElementById(id);
        const wasOpen = dd.classList.contains('open');
        document.querySelectorAll('.app-dropdown.open').forEach(d => d.classList.remove('open'));
        if (!wasOpen) dd.classList.add('open');
    }

    function selectAppOption(dropdownId, value, label) {
        const dd = document.getElementById(dropdownId);
        const select = dd.querySelector('select');
        const trigger = dd.querySelector('.app-dd-label');
        select.value = value;
        trigger.textContent = label;
        dd.querySelectorAll('.app-dropdown-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.value === value);
        });
        dd.classList.remove('open');
        filterApplications();
    }

    document.addEventListener('click', function (e) {
        if (!e.target.closest('.app-dropdown')) {
            document.querySelectorAll('.app-dropdown.open').forEach(d => d.classList.remove('open'));
        }
    });

    // ========================================================================
    // Application Data & Logic
    // ========================================================================
    let currentPage = 1;
    let pageSize = 25;
    let totalPages = 1;
    let totalCount = 0;
    let debounceTimer;

    document.addEventListener('DOMContentLoaded', function () {
        loadApplications();
        loadStats();
    });

    async function loadStats() {
        try {
            const res = await fetch('/api/applications/stats');
            if (res.ok) {
                const stats = await res.json();
                document.getElementById('statTotal').textContent = stats.total || 0;
                document.getElementById('statCritical').textContent = stats.critical || 0;
                document.getElementById('statComponents').textContent = stats.total_components || 0;
            }
        } catch (e) {
            console.error('Error loading stats:', e);
        }
    }

    async function loadApplications() {
        const tbody = document.getElementById('appTableBody');
        const emptyState = document.getElementById('emptyState');
        const paginationContainer = document.getElementById('pagination-container');
        const tableContainer = document.getElementById('tableContainer');

        const searchTerm = document.getElementById('searchInput').value;
        const critFilter = document.getElementById('criticalityFilter').value;

        try {
            let url = `/api/applications?page=${currentPage}&page_size=${pageSize}`;
            if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
            if (critFilter) url += `&criticality=${encodeURIComponent(critFilter)}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to load applications');

            const data = await res.json();
            const items = data.items || [];
            totalCount = data.total || 0;
            totalPages = Math.ceil(totalCount / pageSize) || 1;
            if (currentPage > totalPages) currentPage = totalPages;

            if (items.length === 0) {
                tableContainer.classList.add('hidden');
                paginationContainer.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            tableContainer.classList.remove('hidden');
            paginationContainer.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + items.length, totalCount);

            // Update pagination info
            document.getElementById('showing-start').textContent = totalCount > 0 ? start + 1 : 0;
            document.getElementById('showing-end').textContent = end;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('total-pages').textContent = totalPages;

            document.getElementById('first-page-btn').disabled = currentPage <= 1;
            document.getElementById('prev-page-btn').disabled = currentPage <= 1;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
            document.getElementById('last-page-btn').disabled = currentPage >= totalPages;

            renderTable(items);

        } catch (error) {
            console.error('Error loading applications:', error);
            showToast('Error loading applications', 'error');
        }
    }

    function renderTable(items) {
        const tbody = document.getElementById('appTableBody');

        tbody.innerHTML = items.map(app => {
            const badgeClass = `badge-${app.criticality || 'medium'}`;
            const stackKeys = Object.keys(app.tech_stack || {}).slice(0, 3);
            const stackHtml = stackKeys.map(k =>
                `<span class="px-1.5 py-0.5 rounded text-[10px] bg-[#f1f5f9] text-[#475569] border border-[#e2e8f0]">${escapeHtml(k)}</span>`
            ).join('');

            return `
            <tr class="border-b border-[#f1f5f9] hover:bg-[#f8fafc] transition-colors">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center font-bold text-white text-xs"
                            style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            ${escapeHtml(app.name.substring(0, 2).toUpperCase())}
                        </div>
                        <div>
                            <div class="font-medium text-[#1e40af] cursor-pointer hover:text-blue-500 hover:underline" onclick="window.location.href='/applications/${app.id}'">
                                ${escapeHtml(app.display_name || app.name)}
                            </div>
                            <div class="text-xs text-[#94a3b8] font-mono">${escapeHtml(app.name)}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="badge ${badgeClass}">${(app.criticality || 'MEDIUM').toUpperCase()}</span>
                </td>
                <td class="px-4 py-3 text-[#475569] hidden md:table-cell">
                    ${escapeHtml(app.team_owner || '-')}
                </td>
                <td class="px-4 py-3 hidden md:table-cell">
                    <div class="flex flex-wrap gap-1">
                        ${stackHtml || '<span class="text-[#94a3b8] text-xs">-</span>'}
                    </div>
                </td>
                <td class="px-4 py-3 text-[#64748b] text-xs hidden lg:table-cell">
                    ${formatDate(app.updated_at)}
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        <a href="/applications/${app.id}"
                            class="p-1.5 hover:bg-[#f1f5f9] rounded transition-colors"
                            style="color: #3b82f6;"
                            title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button onclick='deleteApp(${JSON.stringify(app.id)})'
                            class="p-1.5 hover:bg-[#fef2f2] rounded transition-colors"
                            style="color: #dc2626;"
                            title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            `;
        }).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric'
        });
    }

    function filterApplications() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 1;
            loadApplications();
        }, 300);
    }

    function goToPage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        loadApplications();
    }

    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1;
        loadApplications();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========================================================================
    // Create Modal
    // ========================================================================
    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'Register New Application';
        document.getElementById('appForm').reset();
        document.getElementById('createModal').classList.remove('hidden');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
    }

    async function saveApplication(event) {
        if (event) event.preventDefault();

        const data = {
            name: document.getElementById('appName').value,
            display_name: document.getElementById('appDisplayName').value || null,
            owner: document.getElementById('appOwner').value || null,
            description: document.getElementById('appDescription').value || null,
            criticality: document.getElementById('appCriticality').value,
            tech_stack: {}
        };

        if (!data.name) {
            showToast('Application name is required', 'error');
            return;
        }

        try {
            const res = await fetch('/api/applications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.detail || 'Failed to create application');
            }

            showToast('Application registered successfully', 'success');
            closeCreateModal();
            loadApplications();
            loadStats();
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    // ========================================================================
    // Delete with Confirm Modal
    // ========================================================================
    let confirmCallback = null;

    function showConfirmModal(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        confirmCallback = callback;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        confirmCallback = null;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('confirmBtn').addEventListener('click', function () {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        });
    });

    function deleteApp(id) {
        showConfirmModal(
            'Delete Application',
            'Are you sure you want to delete this application? This action cannot be undone.',
            async () => {
                try {
                    const res = await fetch(`/api/applications/${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Failed to delete');
                    showToast('Application deleted successfully', 'success');
                    loadApplications();
                    loadStats();
                } catch (e) {
                    showToast('Error deleting application', 'error');
                }
            }
        );
    }

    // Only define showToast if not already defined by parent
    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-[10000] flex items-center gap-2 ${type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' : 'bg-blue-600'
                }`;
            toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            <span>${escapeHtml(message)}</span>
        `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    }
</script>
{{ super() }}
{% endblock %}