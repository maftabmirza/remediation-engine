{% extends "base.html" %}
{% set active_page = 'alerts' %}

{% block title %}Alerts - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Alerts</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-bell text-red-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Alerts Management</span>
{% endblock %}

{% block header_actions %}
<div class="flex items-center bg-gray-800 rounded-lg p-1 border border-gray-700">
    <button id="viewIndividual" onclick="switchView('individual')"
        class="px-3 py-1 text-[11px] rounded font-medium transition bg-gray-700 text-white flex items-center">
        <i class="fas fa-list mr-1.5 text-blue-300"></i> Individual
    </button>
    <button id="viewGrouped" onclick="switchView('grouped')"
        class="px-3 py-1 text-[11px] rounded font-medium transition text-gray-400 hover:text-white flex items-center">
        <i class="fas fa-layer-group mr-1.5"></i> Grouped
    </button>
    <div class="w-px h-4 bg-gray-600 mx-1"></div>
    <button onclick="refreshCurrentView()"
        class="toolbar-btn p-1 rounded hover:bg-gray-700 transition-colors text-gray-400 hover:text-white"
        title="Refresh Data">
        <i class="fas fa-sync-alt text-green-400 text-xs"></i>
    </button>
</div>
<!-- RE-VIVE Chat Button -->
<button class="revive-chat-btn" id="ai-helper-toggle" title="RE-VIVE AI Assistant">
    <i data-feather="message-circle" style="width: 18px;"></i>
</button>
<!-- Notifications -->
<button class="icon-btn" title="Notifications">
    <i data-feather="bell" style="width: 18px;"></i>
    <span class="notification-dot"></span>
</button>

<!-- User Profile Dropdown -->
<div class="relative ml-2 user-profile-container">
    class="flex items-center justify-center w-8 h-8 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2
    focus:ring-offset-[#0f0e47] focus:ring-blue-500 transition-all duration-200"
    id="user-menu-button" aria-expanded="false" aria-haspopup="true" onclick="toggleUserMenu()">
    <span class="sr-only">Open user menu</span>
    <div
        class="h-8 w-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium text-xs shadow-md hover:bg-blue-700 transition-colors border border-blue-400">
        {{ user.username[0].upper() if user and user.username else 'U' }}
    </div>
    </button>
    <div id="user-menu-dropdown"
        class="origin-top-right absolute right-0 mt-2 w-56 rounded-xl shadow-2xl py-2 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-50 transform transition-all duration-200 ease-out scale-95 opacity-0 border border-slate-100"
        role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
        <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 rounded-t-xl">
            <p class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Signed in as</p>
            <p class="text-sm font-bold text-slate-800 truncate mt-1">{{ user.username if user and user.username else
                'User' }}</p>
            <p class="text-xs text-slate-400 truncate">{{ user.role if user and user.role else 'Guest' }}</p>
        </div>

        <div class="py-1">
            <a href="/profile"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="user"
                    class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Profile
            </a>
            <a href="/settings"
                class="group flex items-center px-4 py-2 text-sm text-slate-700 hover:bg-blue-50 hover:text-blue-600 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="settings"
                    class="mr-3 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                Settings
            </a>
        </div>

        <div class="border-t border-slate-100 my-1"></div>

        <div class="py-1">
            <a href="#" onclick="logoutUser(event)"
                class="group flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors"
                role="menuitem" tabindex="-1">
                <i data-feather="log-out"
                    class="mr-3 h-4 w-4 text-red-400 group-hover:text-red-500 transition-colors"></i>
                Sign out
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    /* Grafana-aligned Table Styling */
    .badge {
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-critical {
        background-color: #ff5286;
        color: white;
    }

    .badge-warning {
        background-color: #eb7b18;
        color: white;
    }

    .badge-info {
        background-color: #3d71d9;
        color: white;
    }

    .badge-other {
        background-color: #6e9fff;
        color: #111217;
    }

    .badge-firing {
        background-color: #ff5286;
        color: white;
    }

    .badge-resolved {
        background-color: #1a7f4b;
        color: white;
    }

    .badge-acknowledged {
        background-color: #6e9fff;
        color: #111217;
    }

    .table-header {
        background-color: #181b1f;
        color: #8e8e8e;
        border-bottom: 1px solid rgba(204, 204, 220, 0.07);
    }

    .table-row {
        border-bottom: 1px solid rgba(204, 204, 220, 0.07);
        transition: background-color 0.15s;
    }

    .table-row:hover {
        background-color: rgba(204, 204, 220, 0.04);
    }

    .status-analyzed {
        color: #6ccf8e;
    }

    .status-pending {
        color: #eb7b18;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Filters -->
    <div class="card p-4 flex flex-wrap gap-4 items-center">
        <select id="filterSeverity"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
            onchange="loadAlerts()">
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="warning">Warning</option>
            <option value="info">Info</option>
        </select>
        <select id="filterStatus"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
            onchange="loadAlerts()">
            <option value="">All Statuses</option>
            <option value="firing">Firing</option>
            <option value="resolved">Resolved</option>
        </select>
        <select id="filterAnalyzed"
            class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
            onchange="loadAlerts()">
            <option value="">All Analysis</option>
            <option value="true">Analyzed</option>
            <option value="false">Pending</option>
        </select>
        <div class="flex-1">
            <input type="text" id="filterSearch"
                class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                placeholder="Search alert name, instance..." onkeyup="debounceSearch()">
        </div>
    </div>

    <!-- Individual View (Table) -->
    <div id="individualView" class="card overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="table-header text-left">
                    <th class="px-4 py-3 font-medium w-16">Sev</th>
                    <th class="px-4 py-3 font-medium w-24">Status</th>
                    <th class="px-4 py-3 font-medium">Alert Name</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Instance</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Job</th>
                    <th class="px-4 py-3 font-medium hidden sm:table-cell">Time</th>
                    <th class="px-4 py-3 font-medium w-24">AI Analysis</th>
                    <th class="px-4 py-3 font-medium text-right w-32">Actions</th>
                </tr>
            </thead>
            <tbody id="alertsList" class="text-[#ccccdc]">
                <tr class="table-row">
                    <td colspan="8" class="p-8 text-center">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p class="text-gray-400">Loading alerts...</p>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination"
            class="flex items-center justify-between p-4 border-t border-[rgba(204,204,204,0.12)] text-sm hidden">
            <div class="text-[#8e8e8e]">
                Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="totalAlerts">0</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="prevBtn"
                    class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 hover:bg-[#22252b]"
                    onclick="prevPage()" disabled>
                    <i class="fas fa-angle-left"></i>
                </button>
                <span id="pageInfo" class="px-3 py-1.5 text-[#ccccdc]">Page 1</span>
                <button id="nextBtn"
                    class="px-3 py-1.5 rounded border border-[rgba(204,204,220,0.12)] bg-[#181b1f] text-[#ccccdc] disabled:opacity-50 hover:bg-[#22252b]"
                    onclick="nextPage()">
                    <i class="fas fa-angle-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Grouped View -->
    <div id="groupedView" class="hidden space-y-4">
        <div class="card overflow-hidden">
            <table class="w-full text-sm">
                <thead>
                    <tr class="table-header text-left">
                        <th class="px-4 py-3 font-medium w-16">Sev</th>
                        <th class="px-4 py-3 font-medium w-24">Status</th>
                        <th class="px-4 py-3 font-medium">Cluster Key / Summary</th>
                        <th class="px-4 py-3 font-medium w-24">Count</th>
                        <th class="px-4 py-3 font-medium text-right w-40">Actions</th>
                    </tr>
                </thead>
                <tbody id="clustersList" class="text-[#ccccdc]">
                    <tr class="table-row">
                        <td colspan="5" class="p-8 text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-gray-400">Loading clusters...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="analyzeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">AI Analysis</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let searchTimeout = null;
    let currentView = 'individual';
    let expandedClusters = new Set();

    // Utility for safe HTML rendering
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function switchView(view) {
        currentView = view;
        const individualBtn = document.getElementById('viewIndividual');
        const groupedBtn = document.getElementById('viewGrouped');

        if (view === 'individual') {
            individualBtn.classList.add('bg-gray-700', 'text-white');
            individualBtn.classList.remove('text-gray-400');
            groupedBtn.classList.remove('bg-gray-700', 'text-white');
            groupedBtn.classList.add('text-gray-400');
            document.getElementById('individualView').classList.remove('hidden');
            document.getElementById('groupedView').classList.add('hidden');
            loadAlerts();
        } else {
            groupedBtn.classList.add('bg-gray-700', 'text-white');
            groupedBtn.classList.remove('text-gray-400');
            individualBtn.classList.remove('bg-gray-700', 'text-white');
            individualBtn.classList.add('text-gray-400');
            document.getElementById('individualView').classList.add('hidden');
            document.getElementById('groupedView').classList.remove('hidden');
            loadClusters();
        }
    }

    function refreshCurrentView() {
        if (currentView === 'individual') loadAlerts();
        else loadClusters();
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => refreshCurrentView(), 300);
    }

    async function loadAlerts() {
        const severity = document.getElementById('filterSeverity').value;
        const status = document.getElementById('filterStatus').value;
        const analyzed = document.getElementById('filterAnalyzed').value;
        const search = document.getElementById('filterSearch').value;

        let url = `/api/alerts?page=${currentPage}&page_size=20`;
        if (severity) url += `&severity=${severity}`;
        if (status) url += `&status=${status}`;
        if (analyzed) url += `&analyzed=${analyzed}`;
        if (search) url += `&alert_name=${encodeURIComponent(search)}`;

        try {
            const response = await apiCall(url);
            if (!response) return;
            const data = await response.json();
            renderAlerts(data);
        } catch (error) {
            console.error('Failed to load alerts:', error);
            document.getElementById('alertsList').innerHTML = `
                <tr class="table-row">
                    <td colspan="8" class="p-8 text-center text-red-400">
                         <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                         <p>Failed to load alerts</p>
                    </td>
                </tr>
            `;
        }
    }

    function renderAlerts(data) {
        const container = document.getElementById('alertsList');
        totalPages = data.total_pages;

        if (data.alerts.length === 0) {
            container.innerHTML = `
                <tr class="table-row">
                    <td colspan="8" class="p-8 text-center text-gray-400">
                         <i class="fas fa-inbox text-4xl mb-3"></i>
                         <p>No alerts found</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').classList.add('hidden');
            return;
        }

        container.innerHTML = data.alerts.map(alert => `
            <tr class="table-row">
                <td class="px-4 py-3">
                    <span class="badge badge-${alert.severity || 'info'} uppercase">${alert.severity || 'info'}</span>
                </td>
                <td class="px-4 py-3">
                     <span class="badge badge-${(alert.status || 'other').toLowerCase()} uppercase">${alert.status || 'Unknown'}</span>
                </td>
                <td class="px-4 py-3 font-medium text-white">
                    ${escapeHtml(alert.alert_name)}
                </td>
                <td class="px-4 py-3 text-xs text-gray-400 hidden md:table-cell whitespace-nowrap">
                    ${alert.instance ? `<div class="flex items-center"><i class="fas fa-server mr-2 opacity-70"></i>${escapeHtml(alert.instance)}</div>` : '<span class="text-gray-600">-</span>'}
                </td>
                <td class="px-4 py-3 text-xs text-gray-400 hidden lg:table-cell whitespace-nowrap">
                    ${alert.job ? `<div class="flex items-center"><i class="fas fa-briefcase mr-2 opacity-70"></i>${escapeHtml(alert.job)}</div>` : '<span class="text-gray-600">-</span>'}
                </td>
                <td class="px-4 py-3 text-xs text-gray-400 hidden sm:table-cell whitespace-nowrap">
                    ${new Date(alert.timestamp).toLocaleString()}
                </td>
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                    ${alert.analyzed
                ? '<div class="flex items-center status-analyzed"><i class="fas fa-check-circle mr-1.5"></i>Analyzed</div>'
                : '<div class="flex items-center status-pending"><i class="fas fa-robot mr-1.5"></i>Pending</div>'
            }
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        ${alert.analyzed ? `
                            <button onclick="viewAnalysis('${alert.id}')" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-blue-400" title="View Analysis">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="analyzeAlert('${alert.id}', true)" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-purple-400" title="Re-analyze">
                                <i class="fas fa-redo"></i>
                            </button>
                        ` : `
                            <button onclick="analyzeAlert('${alert.id}')" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-green-400" title="Analyze with AI">
                                <i class="fas fa-brain"></i>
                            </button>
                        `}
                        <a href="/alerts/${alert.id}" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-gray-400" title="Details">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </td>
            </tr>
        `).join('');

        // Update pagination
        document.getElementById('pagination').classList.remove('hidden');
        const from = (currentPage - 1) * 20 + 1;
        const to = Math.min(currentPage * 20, data.total);
        document.getElementById('showingFrom').textContent = from;
        document.getElementById('showingTo').textContent = to;
        document.getElementById('totalAlerts').textContent = data.total;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadAlerts();
        }
    }
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadAlerts();
        }
    }

    // Analysis Logic
    async function analyzeAlert(alertId, force = false) {
        const modal = document.getElementById('analyzeModal');
        const modalContent = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-400">Analyzing alert with AI...</p>
            </div>
        `;
        try {
            const response = await apiCall(`/api/alerts/${alertId}/analyze`, {
                method: 'POST',
                body: JSON.stringify({ force })
            });
            if (!response) return;
            if (!response.ok) throw new Error((await response.json()).detail || 'Analysis failed');
            const data = await response.json();
            showAnalysisResult(data);
            loadAlerts();
        } catch (error) {
            modalContent.innerHTML = `<div class="text-center text-red-400"><p>Analysis failed</p><p class="text-sm">${error.message}</p></div>`;
        }
    }

    async function viewAnalysis(alertId) {
        const modal = document.getElementById('analyzeModal');
        const modalContent = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modalContent.innerHTML = `<div class="text-center py-8"><div class="loading-spinner mx-auto"></div></div>`;
        try {
            const response = await apiCall(`/api/alerts/${alertId}`);
            if (!response) return;
            const alert = await response.json();
            if (!alert.ai_analysis) {
                modalContent.innerHTML = `<div class="text-center"><p>No analysis</p><button onclick="analyzeAlert('${alertId}')" class="btn-primary mt-2">Analyze</button></div>`;
                return;
            }
            showAnalysisResult({
                alert_id: alert.id,
                analysis: alert.ai_analysis,
                recommendations: alert.recommendations_json || [],
                analyzed_at: alert.analyzed_at,
                analysis_count: alert.analysis_count
            });
        } catch (error) {
            modalContent.innerHTML = `<div class="text-center text-red-400"><p>Failed to load</p></div>`;
        }
    }

    function showAnalysisResult(data) {
        const modalContent = document.getElementById('modalContent');
        let formatted = data.analysis
            .replace(/## (.*)/g, '<h3 class="text-lg font-semibold mt-4 mb-2 text-blue-400">$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/`(.*?)`/g, '<code class="bg-gray-800 px-1 rounded">$1</code>')
            .replace(/\\n/g, '<br>');

        modalContent.innerHTML = `
            <div class="space-y-4">
                <div class="text-sm text-gray-400 flex justify-between">
                    <span>${new Date(data.analyzed_at).toLocaleString()}</span>
                    <span>Count: ${data.analysis_count}</span>
                </div>
                <div class="prose prose-invert max-w-none">${formatted}</div>
                ${data.recommendations && data.recommendations.length ? `
                    <div class="bg-gray-800 p-4 rounded">
                        <h4 class="font-semibold text-yellow-400 mb-2">Recommendations</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">${data.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                    </div>` : ''}
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-700">
                    <button onclick="analyzeAlert('${data.alert_id}', true)" class="btn-secondary px-4 py-2 rounded">Re-analyze</button>
                    <button onclick="closeModal()" class="btn-primary px-4 py-2 rounded">Close</button>
                </div>
            </div>
        `;
    }

    function closeModal() {
        document.getElementById('analyzeModal').classList.add('hidden');
        document.getElementById('analyzeModal').classList.remove('flex');
    }

    // Clusters Logic 
    async function loadClusters() {
        const container = document.getElementById('clustersList');
        const severity = document.getElementById('filterSeverity').value;
        const status = document.getElementById('filterStatus').value;

        container.innerHTML = `
            <div class="card p-8 text-center">
                <div class="loading-spinner mx-auto mb-2"></div>
                <p class="text-gray-400">Loading clusters...</p>
            </div>
        `;

        try {
            let url = '/api/clusters?page_size=50';
            if (severity) url += `&severity=${severity}`;
            if (status === 'firing') url += `&is_active=true`;
            if (status === 'resolved') url += `&is_active=false`;

            const response = await apiCall(url);
            if (!response || !response.ok) throw new Error('Failed to load clusters');
            const clusters = await response.json();
            renderClusters(clusters);
        } catch (error) {
            console.error('Failed to load clusters:', error);
            container.innerHTML = `
                <div class="card p-8 text-center text-red-400">
                    <p>Failed to load clusters</p>
                </div>
            `;
        }
    }

    function renderClusters(clusters) {
        const container = document.getElementById('clustersList');
        if (clusters.length === 0) {
            container.innerHTML = `
                <tr class="table-row">
                    <td colspan="5" class="p-8 text-center text-gray-400">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>No alert clusters found</p>
                    </td>
                </tr>
            `;
            return;
        }

        container.innerHTML = clusters.map(cluster => `
            <tr class="table-row" id="row-${cluster.id}">
                <td class="px-4 py-3 align-top">
                    <span class="badge badge-${cluster.severity || 'info'} uppercase">${cluster.severity || 'info'}</span>
                </td>
                <td class="px-4 py-3 align-top">
                    <span class="badge badge-${cluster.is_active ? 'firing' : 'resolved'} uppercase">
                        ${cluster.is_active ? 'Active' : 'Closed'}
                    </span>
                </td>
                <td class="px-4 py-3 align-top">
                    <div class="font-medium text-white break-all">${cluster.cluster_key.replace(/_/g, ' ')}</div>
                    ${cluster.summary ? `<div class="text-xs text-gray-400 mt-1">${escapeHtml(cluster.summary)}</div>` : ''}
                </td>
                <td class="px-4 py-3 align-top text-purple-400 font-semibold">
                    ${cluster.alert_count}
                </td>
                <td class="px-4 py-3 align-top text-right whitespace-nowrap">
                    <div class="flex justify-end gap-2">
                        ${cluster.is_active ? `
                            <button onclick="closeCluster('${cluster.id}')" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-green-400" title="Resolve Cluster">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${!cluster.summary && cluster.alert_count >= 3 ? `
                            <button onclick="generateClusterSummary('${cluster.id}')" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-blue-400" title="AI Summary">
                                <i class="fas fa-magic"></i>
                            </button>
                        ` : ''}
                        <button onclick="toggleCluster('${cluster.id}')" class="p-1.5 hover:bg-[#22252b] rounded transition-colors text-gray-400" title="Expand">
                            <i class="fas fa-chevron-down transition-transform" id="icon-${cluster.id}"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function toggleCluster(clusterId) {
        const row = document.getElementById(`row-${clusterId}`);
        const icon = document.getElementById(`icon-${clusterId}`);
        const expandedRowId = `expanded-${clusterId}`;
        const existingRow = document.getElementById(expandedRowId);

        if (existingRow) {
            existingRow.remove();
            icon.style.transform = 'rotate(0deg)';
            expandedClusters.delete(clusterId);
        } else {
            const newRow = row.insertAdjacentElement('afterend', document.createElement('tr'));
            newRow.id = expandedRowId;
            newRow.className = 'bg-[#181b1f] border-b border-[rgba(204,204,220,0.07)]';
            newRow.innerHTML = `
                <td colspan="5" class="p-4">
                    <div id="content-${clusterId}" class="ml-12 border-l-2 border-gray-700 pl-4">
                        <div class="loading-spinner mb-2"></div>
                        <span class="text-sm text-gray-400">Loading alerts...</span>
                    </div>
                </td>
            `;
            icon.style.transform = 'rotate(180deg)';
            expandedClusters.add(clusterId);
            await loadClusterAlerts(clusterId);
        }
    }

    async function loadClusterAlerts(clusterId) {
        const contentDiv = document.getElementById(`content-${clusterId}`);
        try {
            const response = await apiCall(`/api/clusters/${clusterId}/alerts?page_size=100`);
            if (!response || !response.ok) throw new Error('Failed to load alerts');
            const alerts = await response.json();

            // Render cluster alerts as a dense table
            contentDiv.innerHTML = `
                <table class="w-full text-xs text-gray-300">
                    <thead>
                        <tr class="text-gray-500 border-b border-gray-700">
                            <th class="pb-2 text-left">Severity</th>
                            <th class="pb-2 text-left">Name</th>
                            <th class="pb-2 text-left">Instance</th>
                            <th class="pb-2 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        ${alerts.map(alert => `
                            <tr>
                                <td class="py-2 w-24">
                                     <span class="badge badge-${alert.severity || 'info'} scale-90 origin-left">${alert.severity || 'info'}</span>
                                </td>
                                <td class="py-2 font-medium text-white">${escapeHtml(alert.alert_name)}</td>
                                <td class="py-2 text-gray-400">${escapeHtml(alert.instance || '-')}</td>
                                <td class="py-2 text-right">
                                    <a href="/alerts/${alert.id}" class="text-blue-400 hover:text-blue-300"><i class="fas fa-external-link-alt"></i></a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            contentDiv.innerHTML = `<span class="text-red-400">Failed to load alerts</span>`;
        }
    }

    async function closeCluster(clusterId) {
        if (!confirm('Are you sure you want to close this cluster?')) return;
        try {
            const response = await apiCall(`/api/clusters/${clusterId}/close?reason=manual`, { method: 'POST' });
            if (response && response.ok) loadClusters();
        } catch (e) { alert(e.message); }
    }

    async function generateClusterSummary(clusterId) {
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        try {
            await apiCall(`/api/clusters/${clusterId}/regenerate-summary`, { method: 'POST' });
            loadClusters();
        } catch (e) {
            alert(e.message);
            btn.disabled = false; btn.innerHTML = originalContent;
        }
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    document.getElementById('analyzeModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });

    // Initial Load
    loadAlerts();

    // Check URL params
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('analyzed')) {
        document.getElementById('filterAnalyzed').value = urlParams.get('analyzed');
    }
</script>
{% endblock %}