{% extends "base.html" %}
{% set active_page = 'alerts' %}

{% block title %}Alerts - AIOps Platform{% endblock %}

{% block breadcrumbs %}
<span class="mx-2">/</span>
<span class="text-gray-200">Alerts</span>
{% endblock %}

{% block header_title %}
<i class="fas fa-bell text-red-400"></i>
<span class="text-sm font-semibold text-white tracking-tight">Alerts Management</span>
{% endblock %}

{% block header_actions %}
{{ super() }}
{% endblock %}

{% block head %}
<style>
    /* Grafana-aligned Table Styling */
    .badge {
        padding: 2px 8px;
        border-radius: 2px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .badge-critical {
        background-color: #ff5286;
        color: white;
    }

    .badge-warning {
        background-color: #eb7b18;
        color: white;
    }

    .badge-info {
        background-color: #3d71d9;
        color: white;
    }

    .badge-other {
        background-color: #6e9fff;
        color: #111217;
    }

    .badge-firing {
        background-color: #ff5286;
        color: white;
    }

    .badge-resolved {
        background-color: #1a7f4b;
        color: white;
    }

    .badge-acknowledged {
        background-color: #6e9fff;
        color: #111217;
    }

    .table-header {
        background-color: #181b1f;
        color: #8e8e8e;
        border-bottom: 1px solid rgba(204, 204, 220, 0.07);
    }

    .table-row {
        border-bottom: 1px solid rgba(204, 204, 220, 0.07);
        transition: background-color 0.15s;
    }

    .table-row:hover {
        background-color: rgba(204, 204, 220, 0.04);
    }

    .status-analyzed {
        color: #059669;
    }

    .status-pending {
        color: #d97706;
    }

    /* View Toggle (Individual / Grouped) */
    .view-toggle-btn {
        color: #64748b;
        background: transparent;
    }
    .view-toggle-btn:hover {
        color: #1e293b;
        background: #f1f5f9;
    }
    .view-toggle-btn.active {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Toolbar with Filters -->
    <div class="card p-4" style="overflow: visible;">
        <div class="flex flex-wrap gap-4 items-center">
            <!-- View Toggle -->
            <div class="flex items-center bg-white border border-[#e2e8f0] rounded-lg p-1 shadow-sm">
                <button id="viewIndividual" onclick="switchView('individual')"
                    class="view-toggle-btn active px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2">
                    <i class="fas fa-list text-xs"></i> Individual
                </button>
                <button id="viewGrouped" onclick="switchView('grouped')"
                    class="view-toggle-btn px-3 py-2 text-sm font-medium rounded-md transition-all flex items-center gap-2">
                    <i class="fas fa-layer-group text-xs"></i> Grouped
                </button>
                <div class="w-px h-5 bg-[#e2e8f0] mx-1"></div>
                <button onclick="refreshCurrentView()"
                    class="p-2 rounded-md hover:bg-[#f1f5f9] transition-colors text-[#64748b] hover:text-[#3b82f6]"
                    title="Refresh Data">
                    <i class="fas fa-sync-alt text-sm"></i>
                </button>
            </div>
            <div class="flex-1 min-w-[200px] relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-[#94a3b8] text-sm"></i>
                <input type="text" id="filterSearch"
                    class="w-full bg-white border border-[#e2e8f0] rounded-lg pl-9 pr-4 py-2 text-sm text-[#1e293b] focus:outline-none focus:border-[#3b82f6] focus:ring-2 focus:ring-[#3b82f6]/20"
                    placeholder="Search alert name, instance..." onkeyup="debounceSearch()">
            </div>
            <select id="filterSeverity"
                class="bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#475569] focus:outline-none focus:border-[#3b82f6] min-w-[140px]"
                onchange="loadAlerts()">
                <option value="">All Severities</option>
                <option value="critical">Critical</option>
                <option value="warning">Warning</option>
                <option value="info">Info</option>
            </select>
            <select id="filterStatus"
                class="bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#475569] focus:outline-none focus:border-[#3b82f6] min-w-[140px]"
                onchange="loadAlerts()">
                <option value="">All Statuses</option>
                <option value="firing">Firing</option>
                <option value="resolved">Resolved</option>
            </select>
            <select id="filterAnalyzed"
                class="bg-white border border-[#e2e8f0] rounded-lg px-3 py-2 text-sm text-[#475569] focus:outline-none focus:border-[#3b82f6] min-w-[140px]"
                onchange="loadAlerts()">
                <option value="">All Analysis</option>
                <option value="true">Analyzed</option>
                <option value="false">Pending</option>
            </select>
        </div>
    </div>

    <!-- Individual View (Table) -->
    <div id="individualView" class="card overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                    <th class="px-4 py-3 font-medium w-16">Sev</th>
                    <th class="px-4 py-3 font-medium w-24">Status</th>
                    <th class="px-4 py-3 font-medium">Alert Name</th>
                    <th class="px-4 py-3 font-medium hidden md:table-cell">Instance</th>
                    <th class="px-4 py-3 font-medium hidden lg:table-cell">Job</th>
                    <th class="px-4 py-3 font-medium hidden sm:table-cell">Time</th>
                    <th class="px-4 py-3 font-medium w-24">AI Analysis</th>
                    <th class="px-4 py-3 font-medium text-right w-32">Actions</th>
                </tr>
            </thead>
            <tbody id="alertsList" class="text-[#334155] divide-y divide-[#e2e8f0]">
                <tr>
                    <td colspan="8" class="p-8 text-center">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        <p class="text-[#64748b]">Loading alerts...</p>
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Pagination -->
        <div id="pagination"
            class="flex items-center justify-between p-4 border-t border-[#e2e8f0] text-sm hidden bg-[#f8fafc]">
            <div class="text-[#64748b]">
                Showing <span id="showingFrom">0</span>-<span id="showingTo">0</span> of <span id="totalAlerts">0</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="prevBtn"
                    class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors"
                    onclick="prevPage()" disabled>
                    <i class="fas fa-angle-left"></i>
                </button>
                <span id="pageInfo" class="px-3 py-1.5 text-[#475569]">Page 1</span>
                <button id="nextBtn"
                    class="px-3 py-1.5 rounded border border-[#e2e8f0] bg-white text-[#475569] disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#f8fafc] transition-colors"
                    onclick="nextPage()">
                    <i class="fas fa-angle-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Grouped View -->
    <div id="groupedView" class="hidden space-y-4">
        <div class="card overflow-hidden">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-[#f8fafc] text-left text-[#64748b]" style="border-bottom: 1px solid #e2e8f0;">
                        <th class="px-4 py-3 font-medium w-16">Sev</th>
                        <th class="px-4 py-3 font-medium w-24">Status</th>
                        <th class="px-4 py-3 font-medium">Cluster Key / Summary</th>
                        <th class="px-4 py-3 font-medium w-24">Count</th>
                        <th class="px-4 py-3 font-medium text-right w-40">Actions</th>
                    </tr>
                </thead>
                <tbody id="clustersList" class="text-[#334155] divide-y divide-[#e2e8f0]">
                    <tr>
                        <td colspan="5" class="p-8 text-center">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            <p class="text-[#64748b]">Loading clusters...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="analyzeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="card p-6 w-full max-w-2xl max-h-screen overflow-y-auto m-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">AI Analysis</h3>
            <button onclick="closeModal()" class="text-[#64748b] hover:text-[#1e293b]">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let searchTimeout = null;
    let currentView = 'individual';
    let expandedClusters = new Set();

    if (typeof showToast === 'undefined') {
        window.showToast = function (message, type) { alert(message); };
    }

    // Utility for safe HTML rendering
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function switchView(view) {
        currentView = view;
        const individualBtn = document.getElementById('viewIndividual');
        const groupedBtn = document.getElementById('viewGrouped');

        if (view === 'individual') {
            individualBtn.classList.add('active');
            groupedBtn.classList.remove('active');
            document.getElementById('individualView').classList.remove('hidden');
            document.getElementById('groupedView').classList.add('hidden');
            loadAlerts();
        } else {
            groupedBtn.classList.add('active');
            individualBtn.classList.remove('active');
            document.getElementById('individualView').classList.add('hidden');
            document.getElementById('groupedView').classList.remove('hidden');
            loadClusters();
        }
    }

    function refreshCurrentView() {
        if (currentView === 'individual') loadAlerts();
        else loadClusters();
    }

    function debounceSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => refreshCurrentView(), 300);
    }

    async function loadAlerts() {
        const severity = document.getElementById('filterSeverity').value;
        const status = document.getElementById('filterStatus').value;
        const analyzed = document.getElementById('filterAnalyzed').value;
        const search = document.getElementById('filterSearch').value;

        let url = `/api/alerts?page=${currentPage}&page_size=20`;
        if (severity) url += `&severity=${severity}`;
        if (status) url += `&status=${status}`;
        if (analyzed) url += `&analyzed=${analyzed}`;
        if (search) url += `&alert_name=${encodeURIComponent(search)}`;

        try {
            const data = await apiCall(url);
            if (!data) return;
            renderAlerts(data);
        } catch (error) {
            console.error('Failed to load alerts:', error);
            showToast('Failed to load alerts', 'error');
            document.getElementById('alertsList').innerHTML = `
                <tr>
                    <td colspan="8" class="p-8 text-center text-red-500">
                         <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                         <p>Failed to load alerts</p>
                    </td>
                </tr>
            `;
        }
    }

    function renderAlerts(data) {
        const container = document.getElementById('alertsList');
        totalPages = data.total_pages;

        if (data.alerts.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="8" class="p-8 text-center text-[#64748b]">
                         <i class="fas fa-inbox text-4xl mb-3 text-[#94a3b8]"></i>
                         <p>No alerts found</p>
                    </td>
                </tr>
            `;
            document.getElementById('pagination').classList.add('hidden');
            return;
        }

        container.innerHTML = data.alerts.map(alert => `
            <tr class="hover:bg-[#f8fafc] transition-colors">
                <td class="px-4 py-3">
                    <span class="badge badge-${alert.severity || 'info'} uppercase">${alert.severity || 'info'}</span>
                </td>
                <td class="px-4 py-3">
                     <span class="badge badge-${(alert.status || 'other').toLowerCase()} uppercase">${alert.status || 'Unknown'}</span>
                </td>
                <td class="px-4 py-3 font-medium text-[#1e293b]">
                    ${escapeHtml(alert.alert_name)}
                </td>
                <td class="px-4 py-3 text-xs text-[#64748b] hidden md:table-cell whitespace-nowrap">
                    ${alert.instance ? `<div class="flex items-center"><i class="fas fa-server mr-2 opacity-70"></i>${escapeHtml(alert.instance)}</div>` : '<span class="text-[#94a3b8]">-</span>'}
                </td>
                <td class="px-4 py-3 text-xs text-[#64748b] hidden lg:table-cell whitespace-nowrap">
                    ${alert.job ? `<div class="flex items-center"><i class="fas fa-briefcase mr-2 opacity-70"></i>${escapeHtml(alert.job)}</div>` : '<span class="text-[#94a3b8]">-</span>'}
                </td>
                <td class="px-4 py-3 text-xs text-[#64748b] hidden sm:table-cell whitespace-nowrap">
                    ${new Date(alert.timestamp).toLocaleString()}
                </td>
                <td class="px-4 py-3 text-sm whitespace-nowrap">
                    ${alert.analyzed
                ? '<div class="flex items-center status-analyzed"><i class="fas fa-check-circle mr-1.5"></i>Analyzed</div>'
                : '<div class="flex items-center status-pending"><i class="fas fa-robot mr-1.5"></i>Pending</div>'
            }
                </td>
                <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-1">
                        ${alert.analyzed ? `
                            <button onclick="viewAnalysis('${alert.id}')" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-blue-500" title="View Analysis">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="analyzeAlert('${alert.id}', true)" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-purple-500" title="Re-analyze">
                                <i class="fas fa-redo"></i>
                            </button>
                        ` : `
                            <button onclick="analyzeAlert('${alert.id}')" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-green-600" title="Analyze with AI">
                                <i class="fas fa-brain"></i>
                            </button>
                        `}
                        <a href="/alerts/${alert.id}" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-[#64748b]" title="Details">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </td>
            </tr>
        `).join('');

        // Update pagination
        document.getElementById('pagination').classList.remove('hidden');
        const from = (currentPage - 1) * 20 + 1;
        const to = Math.min(currentPage * 20, data.total);
        document.getElementById('showingFrom').textContent = from;
        document.getElementById('showingTo').textContent = to;
        document.getElementById('totalAlerts').textContent = data.total;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadAlerts();
        }
    }
    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadAlerts();
        }
    }

    // Analysis Logic
    async function analyzeAlert(alertId, force = false) {
        const modal = document.getElementById('analyzeModal');
        const modalContent = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-[#64748b]">Analyzing alert with AI...</p>
            </div>
        `;
        try {
            const data = await apiCall(`/api/alerts/${alertId}/analyze`, 'POST', { force });
            if (!data) return;
            showAnalysisResult(data);
            loadAlerts();
        } catch (error) {
            modalContent.innerHTML = `<div class="text-center text-red-500"><p>Analysis failed</p><p class="text-sm">${error.message}</p></div>`;
        }
    }

    async function viewAnalysis(alertId) {
        const modal = document.getElementById('analyzeModal');
        const modalContent = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modalContent.innerHTML = `<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="text-[#64748b] mt-2">Loading...</p></div>`;
        try {
            const alert = await apiCall(`/api/alerts/${alertId}`);
            if (!alert) return;
            if (!alert.ai_analysis) {
                modalContent.innerHTML = `<div class="text-center"><p>No analysis</p><button onclick="analyzeAlert('${alertId}')" class="btn-primary mt-2">Analyze</button></div>`;
                return;
            }
            showAnalysisResult({
                alert_id: alert.id,
                analysis: alert.ai_analysis,
                recommendations: alert.recommendations_json || [],
                analyzed_at: alert.analyzed_at,
                analysis_count: alert.analysis_count
            });
        } catch (error) {
            modalContent.innerHTML = `<div class="text-center text-red-500"><p>Failed to load</p></div>`;
        }
    }

    function showAnalysisResult(data) {
        const modalContent = document.getElementById('modalContent');
        let formatted = data.analysis
            .replace(/## (.*)/g, '<h3 class="text-lg font-semibold mt-4 mb-2 text-blue-400">$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/`(.*?)`/g, '<code class="bg-[#f1f5f9] border border-[#e2e8f0] px-1 rounded text-[#475569]">$1</code>')
            .replace(/\\n/g, '<br>');

        modalContent.innerHTML = `
            <div class="space-y-4">
                <div class="text-sm text-[#64748b] flex justify-between">
                    <span>${new Date(data.analyzed_at).toLocaleString()}</span>
                    <span>Count: ${data.analysis_count}</span>
                </div>
                <div class="prose prose-invert max-w-none">${formatted}</div>
                ${data.recommendations && data.recommendations.length ? `
                    <div class="bg-[#f8fafc] border border-[#e2e8f0] p-4 rounded-lg">
                        <h4 class="font-semibold text-amber-600 mb-2">Recommendations</h4>
                        <ul class="list-disc list-inside text-sm space-y-1">${data.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>
                    </div>` : ''}
                <div class="flex justify-end gap-2 pt-4 border-t border-[#e2e8f0]">
                    <button onclick="analyzeAlert('${data.alert_id}', true)" class="btn-secondary px-4 py-2 rounded">Re-analyze</button>
                    <button onclick="closeModal()" class="btn-primary px-4 py-2 rounded">Close</button>
                </div>
            </div>
        `;
    }

    function closeModal() {
        document.getElementById('analyzeModal').classList.add('hidden');
        document.getElementById('analyzeModal').classList.remove('flex');
    }

    // Clusters Logic 
    async function loadClusters() {
        const container = document.getElementById('clustersList');
        const severity = document.getElementById('filterSeverity').value;
        const status = document.getElementById('filterStatus').value;

        container.innerHTML = `
            <tr>
                <td colspan="5" class="p-8 text-center">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <p class="text-[#64748b]">Loading clusters...</p>
                </td>
            </tr>
        `;

        try {
            let url = '/api/clusters?page_size=50';
            if (severity) url += `&severity=${severity}`;
            if (status === 'firing') url += `&is_active=true`;
            if (status === 'resolved') url += `&is_active=false`;

            const clusters = await apiCall(url);
            if (!clusters) throw new Error('Failed to load clusters');
            renderClusters(clusters);
        } catch (error) {
            console.error('Failed to load clusters:', error);
            showToast('Failed to load clusters', 'error');
            container.innerHTML = `
                <tr>
                    <td colspan="5" class="p-8 text-center text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Failed to load clusters</p>
                    </td>
                </tr>
            `;
        }
    }

    function renderClusters(clusters) {
        const container = document.getElementById('clustersList');
        if (clusters.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="5" class="p-8 text-center text-[#64748b]">
                        <i class="fas fa-inbox text-4xl mb-3 text-[#94a3b8]"></i>
                        <p>No alert clusters found</p>
                    </td>
                </tr>
            `;
            return;
        }

        container.innerHTML = clusters.map(cluster => `
            <tr class="hover:bg-[#f8fafc] transition-colors" id="row-${cluster.id}">
                <td class="px-4 py-3 align-top">
                    <span class="badge badge-${cluster.severity || 'info'} uppercase">${cluster.severity || 'info'}</span>
                </td>
                <td class="px-4 py-3 align-top">
                    <span class="badge badge-${cluster.is_active ? 'firing' : 'resolved'} uppercase">
                        ${cluster.is_active ? 'Active' : 'Closed'}
                    </span>
                </td>
                <td class="px-4 py-3 align-top">
                    <div class="font-medium text-[#1e293b] break-all">${cluster.cluster_key.replace(/_/g, ' ')}</div>
                    ${cluster.summary ? `<div class="text-xs text-[#64748b] mt-1">${escapeHtml(cluster.summary)}</div>` : ''}
                </td>
                <td class="px-4 py-3 align-top text-purple-400 font-semibold">
                    ${cluster.alert_count}
                </td>
                <td class="px-4 py-3 align-top text-right whitespace-nowrap">
                    <div class="flex justify-end gap-2">
                        ${cluster.is_active ? `
                            <button onclick="closeCluster('${cluster.id}')" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-green-600" title="Resolve Cluster">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${!cluster.summary && cluster.alert_count >= 3 ? `
                            <button onclick="generateClusterSummary('${cluster.id}')" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-blue-500" title="AI Summary">
                                <i class="fas fa-magic"></i>
                            </button>
                        ` : ''}
                        <button onclick="toggleCluster('${cluster.id}')" class="p-1.5 hover:bg-[#e2e8f0] rounded transition-colors text-[#64748b]" title="Expand">
                            <i class="fas fa-chevron-down transition-transform" id="icon-${cluster.id}"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function toggleCluster(clusterId) {
        const row = document.getElementById(`row-${clusterId}`);
        const icon = document.getElementById(`icon-${clusterId}`);
        const expandedRowId = `expanded-${clusterId}`;
        const existingRow = document.getElementById(expandedRowId);

        if (existingRow) {
            existingRow.remove();
            icon.style.transform = 'rotate(0deg)';
            expandedClusters.delete(clusterId);
        } else {
            const newRow = row.insertAdjacentElement('afterend', document.createElement('tr'));
            newRow.id = expandedRowId;
            newRow.className = 'bg-[#f8fafc] border-b border-[#e2e8f0]';
            newRow.innerHTML = `
                <td colspan="5" class="p-4">
                    <div id="content-${clusterId}" class="ml-12 border-l-2 border-[#e2e8f0] pl-4">
                        <div class="loading-spinner mb-2"></div>
                        <span class="text-sm text-[#64748b]">Loading alerts...</span>
                    </div>
                </td>
            `;
            icon.style.transform = 'rotate(180deg)';
            expandedClusters.add(clusterId);
            await loadClusterAlerts(clusterId);
        }
    }

    async function loadClusterAlerts(clusterId) {
        const contentDiv = document.getElementById(`content-${clusterId}`);
        try {
            const alerts = await apiCall(`/api/clusters/${clusterId}/alerts?page_size=100`);
            if (!alerts) throw new Error('Failed to load alerts');

            // Render cluster alerts as a dense table
            contentDiv.innerHTML = `
                <table class="w-full text-xs text-[#475569]">
                    <thead>
                        <tr class="text-[#64748b] border-b border-[#e2e8f0]">
                            <th class="pb-2 text-left">Severity</th>
                            <th class="pb-2 text-left">Name</th>
                            <th class="pb-2 text-left">Instance</th>
                            <th class="pb-2 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[#e2e8f0]">
                        ${alerts.map(alert => `
                            <tr>
                                <td class="py-2 w-24">
                                     <span class="badge badge-${alert.severity || 'info'} scale-90 origin-left">${alert.severity || 'info'}</span>
                                </td>
                                <td class="py-2 font-medium text-[#1e293b]">${escapeHtml(alert.alert_name)}</td>
                                <td class="py-2 text-[#64748b]">${escapeHtml(alert.instance || '-')}</td>
                                <td class="py-2 text-right">
                                    <a href="/alerts/${alert.id}" class="text-blue-500 hover:text-blue-600"><i class="fas fa-external-link-alt"></i></a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            contentDiv.innerHTML = `<span class="text-red-400">Failed to load alerts</span>`;
        }
    }

    async function closeCluster(clusterId) {
        if (!confirm('Are you sure you want to close this cluster?')) return;
        try {
            await apiCall(`/api/clusters/${clusterId}/close?reason=manual`, 'POST');
            loadClusters();
            showToast('Cluster closed', 'success');
        } catch (e) { showToast(e.message, 'error'); }
    }

    async function generateClusterSummary(clusterId) {
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        try {
            await apiCall(`/api/clusters/${clusterId}/regenerate-summary`, 'POST');
            loadClusters();
            showToast('Summary generated', 'success');
        } catch (e) {
            showToast(e.message, 'error');
            btn.disabled = false; btn.innerHTML = originalContent;
        }
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
    document.getElementById('analyzeModal').addEventListener('click', (e) => { if (e.target === e.currentTarget) closeModal(); });

    // Initial Load
    loadAlerts();

    // Check URL params
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('analyzed')) {
        document.getElementById('filterAnalyzed').value = urlParams.get('analyzed');
    }
</script>
{% endblock %}