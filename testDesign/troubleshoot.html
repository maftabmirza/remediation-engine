{% extends "base.html" %}

{% set active_page = "ai_analyst" %}
{% set current_path = "/troubleshoot" %}

{% block header_title %}AI Troubleshooter{% endblock %}
{% block header_subtitle %}Session #4291{% endblock %}

{% block title %}AI Troubleshooter | Enterprise AIOps{% endblock %}

{% block header_extra %}
<button class="revive-btn">
    <i data-feather="zap" style="width: 14px; height: 14px;"></i>
    <span>RE-VIVE</span>
</button>
{% endblock %}

{% block content %}
<main class="troubleshoot-main">
    <!-- Left Panel - Chat -->
    <div class="ts-chat-panel">
        <!-- Session Header -->
        <div class="ts-session-header">
            <div class="ts-session-left">
                <button class="ts-new-session-btn">
                    <i data-feather="zap" style="width: 14px; height: 14px;"></i>
                    <span>New Session</span>
                </button>
                <div class="ts-llm-selector" id="llmSelector">
                    <div class="ts-llm-selected">
                        <span class="ts-model-dot"></span>
                        <span class="ts-llm-text">GPT-5</span>
                        <i data-feather="chevron-down" class="ts-dropdown-icon"></i>
                    </div>
                    <div class="ts-llm-options">
                        <div class="ts-llm-option selected" data-value="gpt-5">
                            <i data-feather="cpu" style="width: 14px; height: 14px;"></i>
                            <span>GPT-5</span>
                        </div>
                        <div class="ts-llm-option" data-value="claude-3">
                            <i data-feather="zap" style="width: 14px; height: 14px;"></i>
                            <span>Claude 3.5</span>
                        </div>
                        <div class="ts-llm-option" data-value="gemini-3">
                            <i data-feather="star" style="width: 14px; height: 14px;"></i>
                            <span>Gemini 3 Pro</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ts-session-actions">
                <button class="ts-icon-btn" title="Edit">
                    <i data-feather="edit-2" style="width: 14px; height: 14px;"></i>
                </button>
                <button class="ts-icon-btn" title="History">
                    <i data-feather="rotate-ccw" style="width: 14px; height: 14px;"></i>
                </button>
                <button class="ts-icon-btn" title="Minimize">
                    <i data-feather="minus" style="width: 14px; height: 14px;"></i>
                </button>
                <button class="ts-icon-btn" title="Add">
                    <i data-feather="plus" style="width: 14px; height: 14px;"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="ts-chat-messages">
            <!-- User Message -->
            <!-- User Message (Cleared) -->

            <!-- AI Response -->
            <div class="ts-message ts-message-ai">
                <div class="ts-ai-avatar">
                    <i data-feather="cpu"></i>
                </div>
                <div class="ts-message-content">
                    <span class="ts-ai-label">AI Assistant</span>
                    <div class="ts-message-bubble">
                        <p>Hello Aftab! I'm your AI Troubleshooting Assistant, ready to help you investigate and resolve
                            any production incidents or system issues.</p>
                        <p>How can I assist you today? Are you experiencing:</p>
                        <ul>
                            <li>An active alert that needs investigation?</li>
                            <li>Performance issues with a specific application or service?</li>
                            <li>Problems with a particular server?</li>
                            <li>Or do you have another system-related question?</li>
                        </ul>
                        <p>Please let me know what you'd like me to help troubleshoot!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="ts-chat-input-container">
            <div class="ts-chat-input-wrapper">
                <input type="text" class="ts-chat-input"
                    placeholder="Ask to run commands, check logs, or troubleshoot issues...">
                <button class="ts-send-btn">
                    <i data-feather="send" style="width: 18px; height: 18px;"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Resize Handle -->
    <div class="ts-resize-handle">
        <div class="ts-resize-line"></div>
    </div>

    <!-- Right Panel - Terminal/Tools -->
    <div class="ts-tools-panel">
        <!-- Tools Header with Tabs -->
        <div class="ts-tools-header">
            <div class="ts-tabs">
                <button class="ts-tab active">
                    <i data-feather="terminal" style="width: 14px; height: 14px;"></i>
                    <span>Terminal</span>
                </button>
                <button class="ts-tab">
                    <i data-feather="file" style="width: 14px; height: 14px;"></i>
                    <span>File</span>
                </button>
                <button class="ts-tab">
                    <i data-feather="git-merge" style="width: 14px; height: 14px;"></i>
                    <span>Diff</span>
                </button>
                <button class="ts-tab">
                    <i data-feather="database" style="width: 14px; height: 14px;"></i>
                    <span>HQ</span>
                </button>
                <div class="ts-tab-actions">
                    <button class="ts-icon-btn" title="Remove">
                        <i data-feather="minus" style="width: 14px; height: 14px;"></i>
                    </button>
                    <button class="ts-icon-btn" title="Add">
                        <i data-feather="plus" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
            </div>
            <div class="ts-connection-status-area">
                <span class="ts-disconnected-badge">Disconnected</span>
                <button class="ts-connect-btn">
                    <i data-feather="zap" style="width: 14px; height: 14px;"></i>
                    <span>Connect</span>
                </button>
            </div>
        </div>

        <!-- Terminal Content -->
        <div class="ts-terminal">
            <div class="ts-terminal-output">
                <div class="ts-terminal-line">
                    <span class="ts-output ts-success">Connected to server...</span>
                </div>
                <div class="ts-terminal-line">
                    <span class="ts-output ts-error">SSH Connection Error: Cannot connect to 15.204.233.209:22: [Errno
                        111] Connection refused</span>
                </div>
                <div class="ts-terminal-line">
                    <span class="ts-output ts-warning">Connection closed.</span>
                </div>
                <div class="ts-terminal-line ts-cursor">
                    <span class="ts-cursor-blink">â–Œ</span>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts_extra %}
<script>
    // Tab switching
    document.querySelectorAll('.ts-tab').forEach(tab => {
        tab.addEventListener('click', function () {
            document.querySelectorAll('.ts-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Custom LLM Dropdown
    const llmSelector = document.getElementById('llmSelector');
    const llmSelected = llmSelector?.querySelector('.ts-llm-selected');
    const llmText = llmSelector?.querySelector('.ts-llm-text');
    const llmOptions = llmSelector?.querySelectorAll('.ts-llm-option');

    llmSelected?.addEventListener('click', function (e) {
        e.stopPropagation();
        llmSelector.classList.toggle('open');
    });

    llmOptions?.forEach(option => {
        option.addEventListener('click', function () {
            llmOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            llmText.textContent = this.querySelector('span').textContent;
            llmSelector.classList.remove('open');
        });
    });

    document.addEventListener('click', function (e) {
        if (!llmSelector?.contains(e.target)) {
            llmSelector?.classList.remove('open');
        }
    });

    // Send button animation
    document.querySelector('.ts-send-btn').addEventListener('click', function () {
        this.style.transform = 'scale(0.9)';
        setTimeout(() => this.style.transform = 'scale(1)', 150);
    });

    // Connect button toggle
    document.querySelector('.ts-connect-btn')?.addEventListener('click', function () {
        const badge = document.querySelector('.ts-disconnected-badge');
        if (badge.classList.contains('connected')) {
            badge.textContent = 'Disconnected';
            badge.classList.remove('connected');
            this.innerHTML = '<i data-feather="zap" style="width: 14px; height: 14px;"></i><span>Connect</span>';
        } else {
            badge.textContent = 'Connected';
            badge.classList.add('connected');
            this.innerHTML = '<i data-feather="x" style="width: 14px; height: 14px;"></i><span>Disconnect</span>';
        }
        feather.replace();
    });

    // Resizable Panels
    const mainContainer = document.querySelector('.troubleshoot-main');
    const resizeHandle = document.querySelector('.ts-resize-handle');
    let isResizing = false;

    if (resizeHandle && mainContainer) {
        resizeHandle.addEventListener('mousedown', function (e) {
            isResizing = true;
            mainContainer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
        });

        document.addEventListener('mousemove', function (e) {
            if (!isResizing) return;

            const containerRect = mainContainer.getBoundingClientRect();
            const mouseX = e.clientX - containerRect.left;
            const containerWidth = containerRect.width;

            // Calculate percentage (min 300px, max container width - 300px)
            const minWidth = 300;
            const maxWidth = containerWidth - 300;

            let newWidthInfo = mouseX;
            if (newWidthInfo < minWidth) newWidthInfo = minWidth;
            if (newWidthInfo > maxWidth) newWidthInfo = maxWidth;

            const leftPercentage = (newWidthInfo / containerWidth) * 100;
            const rightPercentage = 100 - leftPercentage;

            // Updated grid template: Left Width | Handle (auto) | Right Width (fr or logic)
            // Actually simpler: set left column percentage, Handle is auto/fixed width, Right is 1fr
            // But we need to account for Handle width. 
            // Let's use pixels for precision during resize or calc().

            // Layout: [Left %] [Handle 16px] [Right 1fr]
            // We need to adjust the grid-template-columns.

            mainContainer.style.gridTemplateColumns = `${leftPercentage}% auto 1fr`;
        });

        document.addEventListener('mouseup', function () {
            if (isResizing) {
                isResizing = false;
                mainContainer.classList.remove('resizing');
                document.body.style.cursor = 'default';
            }
        });
    }
</script>
{% endblock %}