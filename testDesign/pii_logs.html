{% extends "base.html" %}

{% set active_page = "settings" %}
{% set current_path = "/pii-logs" %}

{% block header_title %}Settings{% endblock %}
{% block header_subtitle %}Settings / PII Logs{% endblock %}

{% block title %}PII Detection Logs | Enterprise AIOps{% endblock %}

{% block content %}
<main class="runbooks-main settings-page">

    <!-- Section Dropdown + Title -->
    <div class="settings-header-bar">
        <div class="settings-title-group">
            <div class="section-selector">
                <button class="section-dropdown-btn" id="sectionDropdownBtn">
                    <i data-feather="file-text"></i>
                    <span id="currentSection">PII Logs</span>
                    <i data-feather="chevron-down" class="dropdown-arrow"></i>
                </button>
                {% include "partials/settings_nav_menu.html" %}
            </div>
            <p class="section-desc">View detection history and redaction events</p>
        </div>
        <div class="header-actions">
            <button class="primary-btn">
                <i data-feather="download"></i> Export Logs
            </button>
        </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-value" id="statTotal">247</span>
            <span class="stat-label">Total Detections</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="statToday">12</span>
            <span class="stat-label">Today</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="statTopType">EMAIL</span>
            <span class="stat-label">Top Type</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="statRedacted">94%</span>
            <span class="stat-label">Redacted</span>
        </div>
    </div>

    <!-- Filter Panel -->
    <div class="users-card filter-panel">
        <div class="filter-header">
            <h3 class="card-title"><i data-feather="filter"></i> Filters</h3>
            <div class="filter-actions">
                <button class="secondary-btn small" onclick="applyFilters()">Apply</button>
                <button class="secondary-btn small outline" onclick="clearFilters()">Clear</button>
            </div>
        </div>
        <div class="filter-grid">
            <div class="form-group">
                <label>Search</label>
                <div class="search-input-wrapper">
                    <i data-feather="search"></i>
                    <input type="text" class="form-input" placeholder="Search logs...">
                </div>
            </div>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" class="form-input">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" class="form-input">
            </div>
            <div class="form-group">
                <label>Entity Type</label>
                <div class="custom-select-wrapper">
                    <select class="form-select">
                        <option value="">All Types</option>
                        <option value="EMAIL">Email</option>
                        <option value="API_KEY">API Key</option>
                        <option value="PASSWORD">Password</option>
                        <option value="PHONE_NUMBER">Phone</option>
                        <option value="AWS_KEY">AWS Key</option>
                    </select>
                    <i data-feather="chevron-down" class="select-arrow"></i>
                </div>
            </div>
            <div class="form-group">
                <label>Engine</label>
                <div class="custom-select-wrapper">
                    <select class="form-select">
                        <option value="">All Engines</option>
                        <option value="presidio">Presidio</option>
                        <option value="detect_secrets">detect-secrets</option>
                    </select>
                    <i data-feather="chevron-down" class="select-arrow"></i>
                </div>
            </div>
            <div class="form-group">
                <label>Source</label>
                <div class="custom-select-wrapper">
                    <select class="form-select">
                        <option value="">All Sources</option>
                        <option value="runbook_output">Runbook Output</option>
                        <option value="llm_response">LLM Response</option>
                        <option value="alert_data">Alert Data</option>
                    </select>
                    <i data-feather="chevron-down" class="select-arrow"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Table -->
    <div class="users-card no-padding">
        <div class="table-meta-bar">
            <span class="showing-text">Showing <strong>1-10</strong> of <strong>247</strong> detections</span>
        </div>
        <div class="users-table-wrapper">
            <table class="users-table">
                <thead>
                    <tr>
                        <th width="18%">TIMESTAMP</th>
                        <th width="15%">TYPE</th>
                        <th width="12%">ENGINE</th>
                        <th width="12%">CONFIDENCE</th>
                        <th width="20%">SOURCE</th>
                        <th width="10%">STATUS</th>
                        <th width="13%" class="text-right">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-secondary">2026-02-06 21:35:12</td>
                        <td><span class="entity-badge email">EMAIL</span></td>
                        <td><span class="engine-label">Presidio</span></td>
                        <td>
                            <div class="confidence-display">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 92%;"></div>
                                </div>
                                <span>0.92</span>
                            </div>
                        </td>
                        <td>LLM Response</td>
                        <td><span class="badge badge-success">Redacted</span></td>
                        <td class="text-right">
                            <button class="icon-btn" title="View Details" onclick="openModal()"><i
                                    data-feather="eye"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-secondary">2026-02-06 21:32:08</td>
                        <td><span class="entity-badge api_key">API_KEY</span></td>
                        <td><span class="engine-label ds">detect-secrets</span></td>
                        <td>
                            <div class="confidence-display">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 88%;"></div>
                                </div>
                                <span>0.88</span>
                            </div>
                        </td>
                        <td>Runbook Output</td>
                        <td><span class="badge badge-success">Redacted</span></td>
                        <td class="text-right">
                            <button class="icon-btn" title="View Details" onclick="openModal()"><i
                                    data-feather="eye"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-secondary">2026-02-06 21:28:45</td>
                        <td><span class="entity-badge password">PASSWORD</span></td>
                        <td><span class="engine-label ds">detect-secrets</span></td>
                        <td>
                            <div class="confidence-display">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 95%;"></div>
                                </div>
                                <span>0.95</span>
                            </div>
                        </td>
                        <td>Alert Data</td>
                        <td><span class="badge badge-success">Redacted</span></td>
                        <td class="text-right">
                            <button class="icon-btn" title="View Details" onclick="openModal()"><i
                                    data-feather="eye"></i></button>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-secondary">2026-02-06 20:15:33</td>
                        <td><span class="entity-badge phone">PHONE</span></td>
                        <td><span class="engine-label">Presidio</span></td>
                        <td>
                            <div class="confidence-display">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: 78%;"></div>
                                </div>
                                <span>0.78</span>
                            </div>
                        </td>
                        <td>LLM Response</td>
                        <td><span class="badge badge-warning">Logged</span></td>
                        <td class="text-right">
                            <button class="icon-btn" title="View Details" onclick="openModal()"><i
                                    data-feather="eye"></i></button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="table-pagination">
            <span class="page-info">Page 1 of 25</span>
            <div class="pagination-buttons">
                <button class="secondary-btn small" disabled>← Previous</button>
                <button class="secondary-btn small">Next →</button>
            </div>
        </div>
    </div>

</main>

<!-- Detail Modal -->
<div id="detailModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h2>Detection Details</h2>
            <button class="modal-close-btn" onclick="closeModal()"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body">
            <div class="detail-row">
                <span class="detail-label">Timestamp</span>
                <span class="detail-value">2026-02-06 21:35:12</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Entity Type</span>
                <span class="detail-value"><span class="entity-badge email">EMAIL</span></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Engine</span>
                <span class="detail-value">Presidio (Microsoft)</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Confidence Score</span>
                <span class="detail-value">0.92</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Source</span>
                <span class="detail-value">LLM Response - Troubleshoot Session #4291</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Context</span>
                <div class="context-box">
                    ...user mentioned their email is <mark>****@****.***</mark> for contact...
                </div>
            </div>
            <div class="detail-row">
                <span class="detail-label">Action Taken</span>
                <span class="detail-value"><span class="badge badge-success">Redacted</span> with Mask (*)</span>
            </div>
        </div>
    </div>
</div>

<style>
    /* Page Layout */
    .settings-page {
        height: 100%;
        width: 100%;
        overflow-y: auto;
        gap: 24px;
        display: flex;
        flex-direction: column;
        padding: 32px;
        background-color: #f4f6f8;
    }

    /* Header Bar */
    .settings-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .settings-title-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .section-selector {
        position: relative;
    }

    .section-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 18px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        color: #0f172a;
        cursor: pointer;
        transition: all 0.15s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .section-dropdown-btn:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .section-dropdown-btn svg {
        width: 20px;
        height: 20px;
        color: #06b6d4;
    }

    .section-dropdown-btn .dropdown-arrow {
        width: 14px;
        height: 14px;
        color: #94a3b8;
    }

    .section-desc {
        font-size: 13px;
        color: #64748b;
        margin: 0 0 0 4px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    /* Dropdown Menu */
    .section-dropdown-menu {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        width: 260px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        z-index: 100;
        padding: 8px;
        max-height: 400px;
        overflow-y: auto;
    }

    .section-dropdown-menu.open {
        display: block;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.12s;
    }

    .dropdown-item svg {
        width: 16px;
        height: 16px;
    }

    .dropdown-item:hover {
        background: #f1f5f9;
        color: #1e293b;
    }

    .dropdown-item.active {
        background: #eff6ff;
        color: #2563eb;
    }

    .dropdown-item.active svg {
        color: #3b82f6;
    }

    /* Stats Row */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    .stat-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px 24px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        text-align: center;
    }

    .stat-card .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #3b82f6;
    }

    .stat-card .stat-label {
        font-size: 12px;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 500;
    }

    /* Filter Panel */
    .filter-panel {
        padding: 20px 24px;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .card-title {
        font-size: 15px;
        font-weight: 600;
        color: #0f172a;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-title svg {
        width: 16px;
        height: 16px;
        color: #64748b;
    }

    .filter-actions {
        display: flex;
        gap: 8px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
        gap: 16px;
    }

    .search-input-wrapper {
        position: relative;
    }

    .search-input-wrapper i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: #94a3b8;
    }

    .search-input-wrapper .form-input {
        padding-left: 36px;
    }

    /* Form Elements */
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group label {
        font-size: 13px;
        font-weight: 600;
        color: #64748b;
    }

    .form-select,
    .form-input {
        padding: 10px 14px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        color: #0f172a;
        background: white;
        font-weight: 500;
        appearance: none;
        width: 100%;
    }

    .form-select {
        padding-right: 36px;
    }

    .custom-select-wrapper {
        position: relative;
    }

    .select-arrow {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 14px;
        height: 14px;
        color: #64748b;
        pointer-events: none;
    }

    .primary-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .primary-btn:hover {
        background: #2563eb;
    }

    .secondary-btn {
        background: white;
        border: 1px solid #e2e8f0;
        color: #475569;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
    }

    .secondary-btn:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .secondary-btn.small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .secondary-btn.outline {
        background: transparent;
        border-color: #cbd5e1;
    }

    .secondary-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .icon-btn {
        background: none;
        border: none;
        padding: 6px;
        border-radius: 6px;
        color: #64748b;
        cursor: pointer;
        transition: all 0.15s;
    }

    .icon-btn:hover {
        background: #f1f5f9;
        color: #3b82f6;
    }

    .icon-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Table Card */
    .users-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .users-card.no-padding {
        padding: 0;
        overflow: hidden;
    }

    .table-meta-bar {
        padding: 12px 24px;
        border-bottom: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .showing-text {
        font-size: 13px;
        color: #64748b;
    }

    .users-table-wrapper {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 14px;
    }

    .users-table th {
        text-align: left;
        padding: 12px 16px;
        border-bottom: 1px solid #e2e8f0;
        color: #0f172a;
        font-weight: 600;
        background: #f8fafc;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .users-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        vertical-align: middle;
    }

    .users-table tr:hover td {
        background: #f8fafc;
    }

    .users-table tr:last-child td {
        border-bottom: none;
    }

    .text-secondary {
        color: #64748b;
        font-size: 13px;
    }

    .text-right {
        text-align: right;
    }

    /* Badges */
    .badge {
        display: inline-flex;
        padding: 3px 10px;
        border-radius: 99px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge-success {
        background: #dcfce7;
        color: #15803d;
    }

    .badge-warning {
        background: #fef9c3;
        color: #a16207;
    }

    .entity-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .entity-badge.email {
        background: #eff6ff;
        color: #2563eb;
    }

    .entity-badge.api_key {
        background: #fff7ed;
        color: #ea580c;
    }

    .entity-badge.password {
        background: #fdf2f8;
        color: #db2777;
    }

    .entity-badge.phone {
        background: #faf5ff;
        color: #9333ea;
    }

    .engine-label {
        font-size: 12px;
        padding: 3px 8px;
        border-radius: 4px;
        background: #f1f5f9;
        color: #475569;
        font-weight: 500;
    }

    .engine-label.ds {
        background: #fef3c7;
        color: #b45309;
    }

    /* Confidence Bar */
    .confidence-display {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .confidence-bar {
        width: 50px;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #22c55e 0%, #eab308 60%, #ef4444 100%);
        border-radius: 3px;
    }

    .confidence-display span {
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
    }

    /* Pagination */
    .table-pagination {
        padding: 12px 24px;
        border-top: 1px solid #f1f5f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f8fafc;
    }

    .page-info {
        font-size: 13px;
        color: #64748b;
    }

    .pagination-buttons {
        display: flex;
        gap: 8px;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 23, 42, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 560px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-header h2 {
        font-size: 18px;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
    }

    .modal-close-btn {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 8px;
        color: #64748b;
        cursor: pointer;
    }

    .modal-close-btn:hover {
        background: #f1f5f9;
        color: #0f172a;
    }

    .modal-close-btn svg {
        width: 20px;
        height: 20px;
    }

    .modal-body {
        padding: 24px;
    }

    .detail-row {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f1f5f9;
    }

    .detail-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .detail-label {
        font-size: 11px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
        display: block;
    }

    .detail-value {
        font-size: 14px;
        color: #0f172a;
        font-weight: 500;
    }

    .context-box {
        background: #f8fafc;
        border-left: 3px solid #3b82f6;
        padding: 12px 16px;
        border-radius: 0 8px 8px 0;
        font-family: 'Space Mono', monospace;
        font-size: 13px;
        color: #334155;
        line-height: 1.5;
    }

    .context-box mark {
        background: #fef08a;
        color: #854d0e;
        padding: 1px 4px;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block scripts_extra %}
<script>
    feather.replace();

    // Dropdown Logic
    const dropdownBtn = document.getElementById('sectionDropdownBtn');
    const dropdownMenu = document.getElementById('sectionDropdownMenu');

    dropdownBtn.addEventListener('click', function (e) {
        e.stopPropagation();
        dropdownMenu.classList.toggle('open');
    });

    document.addEventListener('click', function () {
        dropdownMenu.classList.remove('open');
    });

    // Modal Logic
    function openModal() {
        document.getElementById('detailModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('detailModal').classList.remove('active');
    }

    // Close modal on background click
    document.getElementById('detailModal').addEventListener('click', function (e) {
        if (e.target === this) closeModal();
    });

    // Placeholder filter functions
    function applyFilters() {
        console.log('Applying filters...');
    }

    function clearFilters() {
        console.log('Clearing filters...');
    }
</script>
{% endblock %}