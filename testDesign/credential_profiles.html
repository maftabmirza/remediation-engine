{% extends "base.html" %}

{% set active_page = "settings" %}
{% set current_path = "/credential-profiles" %}

{% block header_title %}Settings{% endblock %}
{% block header_subtitle %}Home / Settings / Secrets{% endblock %}

{% block title %}Credential Profiles | Enterprise AIOps{% endblock %}

{% block content %}
<main class="runbooks-main settings-page">

    <!-- Section Dropdown + Title + Admin Badge -->
    <div class="settings-header-bar">
        <div class="settings-title-group">
            <div class="section-selector">
                <button class="section-dropdown-btn" id="sectionDropdownBtn">
                    <i data-feather="unlock"></i>
                    <span id="currentSection">Credential Profiles</span>
                    <i data-feather="chevron-down" class="dropdown-arrow"></i>
                </button>
                {% include "partials/settings_nav_menu.html" %}
            </div>
            <p class="section-desc">Manage stored secrets and vaults</p>
        </div>
        <button class="add-user-btn">
            <i data-feather="plus"></i>
            <span>New Profile</span>
        </button>
    </div>

    <!-- Content Card -->
    <div class="users-card">

        <!-- Filters Bar -->
        <div class="table-filters-bar">
            <div class="search-wrapper">
                <i data-feather="search"></i>
                <input type="text" placeholder="Search credential or backend">
            </div>

            <div class="filter-group">
                <div class="filter-dropdown">
                    <span>Any backend</span>
                    <i data-feather="chevron-down"></i>
                </div>
                <div class="filter-dropdown">
                    <span>All groups</span>
                    <i data-feather="chevron-down"></i>
                </div>
            </div>

        </div>
        <div class="filter-info-row">
            <span class="help-text">Attach profiles to server groups or pick them per host; choose "Inline secret"
                inside a server form for one-off credentials.</span>
        </div>

        <!-- Data Table (Empty State) -->
        <div class="users-table-wrapper">
            <table class="users-table">
                <tbody>
                    <tr class="empty-state-row">
                        <td colspan="6">
                            <div class="empty-state-content">
                                <i data-feather="key" class="empty-icon"></i>
                                <p class="empty-title">No credential profiles configured</p>
                                <p class="empty-subtitle">Create your first profile</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </div>

</main>

{% block extra_css %}
<style>
    /* Shared Settings Layout */
    .settings-page {
        gap: 24px;
        display: flex;
        flex-direction: column;
        padding-bottom: 40px;
    }

    /* Header Bar */
    .settings-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .settings-title-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .section-selector {
        position: relative;
    }

    .section-dropdown-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 18px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        color: #0f172a;
        cursor: pointer;
        transition: all 0.15s;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .section-dropdown-btn:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .section-desc {
        font-size: 13px;
        color: #64748b;
        margin: 0 0 0 4px;
    }

    .add-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }

    .add-btn:hover {
        background: #2563eb;
        transform: translateY(-1px);
    }

    /* Filter Bar */
    .filter-bar {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .search-input {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        background: #f8fafc;
        font-size: 14px;
        color: #1e293b;
        outline: none;
        transition: all 0.2s;
    }

    .search-input:focus {
        background: white;
        border-color: #3b82f6;
    }

    /* Card Grid */
    .profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 16px;
    }

    .profile-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        gap: 16px;
        position: relative;
    }

    .profile-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .card-title {
        font-size: 15px;
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 4px;
    }

    .card-desc {
        font-size: 13px;
        color: #64748b;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .status-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 99px;
        text-transform: uppercase;
    }

    .status-badge.enabled {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.disabled {
        background: #f1f5f9;
        color: #64748b;
    }

    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        font-size: 12px;
    }

    .info-label {
        color: #94a3b8;
        display: block;
        margin-bottom: 2px;
    }

    .info-value {
        color: #334155;
        font-weight: 500;
        font-family: monospace;
    }

    .card-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: auto;
        padding-top: 16px;
        border-top: 1px solid #f1f5f9;
    }

    .icon-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        color: #64748b;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
    }

    .icon-btn:hover {
        background: #f1f5f9;
        color: #0f172a;
    }

    .icon-btn.delete:hover {
        background: #fef2f2;
        color: #ef4444;
    }

    /* Modal Styles (Consistent with other pages) */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-container {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 85vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 20px 24px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: #f8fafc;
        border-radius: 0 0 16px 16px;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: #475569;
        margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 14px;
        color: #0f172a;
        background: #ffffff;
    }

    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .helper-text {
        font-size: 12px;
        color: #94a3b8;
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<main class="runbooks-main settings-page">

    <!-- Header -->
    <div class="settings-header-bar">
        <div class="settings-title-group">
            <div class="section-selector">
                <button class="section-dropdown-btn" id="sectionDropdownBtn">
                    <i data-feather="unlock"></i>
                    <span id="currentSection">Credential Profiles</span>
                    <i data-feather="chevron-down" class="dropdown-arrow"></i>
                </button>
                {% include "partials/settings_nav_menu.html" %}
            </div>
            <p class="section-desc">Manage API credentials and authentication profiles</p>
        </div>
        <button class="add-btn" onclick="openProfileModal()">
            <i data-feather="plus" style="width: 16px; height: 16px;"></i>
            <span>New Profile</span>
        </button>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
        <input type="text" class="search-input" placeholder="Search profiles...">

        <div class="custom-dropdown rb-filter" style="width: 160px;">
            <div class="dropdown-trigger">
                <span class="dropdown-text">All Auth Types</span>
                <i data-feather="chevron-down" class="dropdown-icon"></i>
            </div>
            <!-- Mock Dropdown -->
        </div>
    </div>

    <!-- Empty State (Hidden Pattern) -->
    <div id="emptyState" class="empty-state-container" style="display: none;">
        <div class="empty-state-icon">
            <i data-feather="key" width="48" height="48"></i>
        </div>
        <h3 class="empty-state-title">No Profiles Found</h3>
        <p class="empty-state-desc">Create your first credential profile to connect to external APIs.</p>
    </div>

    <!-- Profiles Grid -->
    <div id="profilesGrid" class="profiles-grid">
        <!-- Example Card 1 -->
        <div class="profile-card">
            <div class="card-header">
                <div>
                    <h3 class="card-title">Production AWX</h3>
                    <p class="card-desc">Main Ansible Tower instance for prod env</p>
                </div>
                <span class="status-badge enabled">Enabled</span>
            </div>

            <div class="info-grid">
                <div>
                    <span class="info-label">Base URL</span>
                    <span class="info-value">https://awx.prod.local</span>
                </div>
                <div>
                    <span class="info-label">Auth Type</span>
                    <span class="info-value">Bearer Token</span>
                </div>
                <div>
                    <span class="info-label">Verify SSL</span>
                    <span class="info-value">True</span>
                </div>
                <div>
                    <span class="info-label">Updated</span>
                    <span class="info-value">2 days ago</span>
                </div>
            </div>

            <div class="card-actions">
                <button class="icon-btn" title="Test Connection"><i data-feather="wifi"></i></button>
                <button class="icon-btn" title="Edit" onclick="openProfileModal(1)"><i
                        data-feather="edit-2"></i></button>
                <button class="icon-btn delete" title="Delete" onclick="showDeleteConfirm('Production AWX')"><i
                        data-feather="trash-2"></i></button>
            </div>
        </div>

        <!-- Example Card 2 -->
        <div class="profile-card">
            <div class="card-header">
                <div>
                    <h3 class="card-title">Legacy Jenkins</h3>
                    <p class="card-desc">Jenkins server for legacy build pipelines</p>
                </div>
                <span class="status-badge disabled">Disabled</span>
            </div>

            <div class="info-grid">
                <div>
                    <span class="info-label">Base URL</span>
                    <span class="info-value">http://jenkins.legacy:8080</span>
                </div>
                <div>
                    <span class="info-label">Auth Type</span>
                    <span class="info-value">Basic Auth</span>
                </div>
                <div>
                    <span class="info-label">Verify SSL</span>
                    <span class="info-value">False</span>
                </div>
                <div>
                    <span class="info-label">Updated</span>
                    <span class="info-value">1 month ago</span>
                </div>
            </div>

            <div class="card-actions">
                <button class="icon-btn" title="Test Connection"><i data-feather="wifi"></i></button>
                <button class="icon-btn" title="Edit" onclick="openProfileModal(2)"><i
                        data-feather="edit-2"></i></button>
                <button class="icon-btn delete" title="Delete" onclick="showDeleteConfirm('Legacy Jenkins')"><i
                        data-feather="trash-2"></i></button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Create Profile</h3>
                <button class="modal-close-btn" onclick="closeProfileModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Profile Name</label>
                        <input type="text" class="form-input" placeholder="e.g., Jira Cloud" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" placeholder="Optional description..."
                            style="min-height: 60px;"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Base URL</label>
                        <input type="url" class="form-input" placeholder="https://api.example.com" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Authentication Type</label>
                        <select id="authTypeSelect" class="form-select" onchange="toggleAuthFields()">
                            <option value="none">No Auth</option>
                            <option value="api_key">API Key</option>
                            <option value="bearer">Bearer Token</option>
                            <option value="basic">Basic Auth</option>
                            <option value="oauth">OAuth 2.0</option>
                        </select>
                    </div>

                    <!-- Dynamic Auth Fields -->
                    <div id="apiKeyFields" class="auth-section hidden" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Header Name</label>
                            <input type="text" class="form-input" value="Authorization">
                        </div>
                        <div class="form-group">
                            <label class="form-label">API Key</label>
                            <input type="password" class="form-input" placeholder="Enter API Key">
                        </div>
                    </div>

                    <div id="bearerFields" class="auth-section hidden" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Token</label>
                            <input type="password" class="form-input" placeholder="Enter Bearer Token">
                        </div>
                    </div>

                    <div id="basicFields" class="auth-section hidden" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-input" placeholder="Username">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-input" placeholder="Password">
                            </div>
                        </div>
                    </div>

                    <div id="oauthFields" class="auth-section hidden" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Token URL</label>
                            <input type="url" class="form-input" placeholder="https://auth.example.com/token">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label class="form-label">Client ID</label>
                                <input type="text" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Secret</label>
                                <input type="password" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="verifySSL" checked>
                            <label for="verifySSL" style="font-size: 14px; color: #334155;">Verify SSL
                                Certificates</label>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeProfileModal()"
                    style="padding: 8px 16px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancel</button>
                <button class="add-btn" onclick="saveProfile()">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-container small" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #ef4444;">Delete Profile</h3>
                <button class="modal-close-btn" onclick="closeDeleteModal()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body">
                <p style="color: #64748b; margin: 0;">Are you sure you want to delete <strong id="delProfileName"
                        style="color: #0f172a;"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteModal()"
                    style="padding: 8px 16px; border: 1px solid #cbd5e1; background: white; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancel</button>
                <button class="add-btn" style="background: #ef4444;" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

</main>
{% endblock %}

{% block scripts_extra %}
<script>
    feather.replace();

    // Dropdown Logic (for section selector)
    const dropdownBtn = document.getElementById('sectionDropdownBtn');
    if (dropdownBtn) {
        // ... (standard dropdown logic if needed, usually handled by shared js or unique)
        // Re-using the logic from other pages just in case
        const menu = document.querySelector('.section-dropdown-menu');
        if (menu) {
            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.classList.toggle('open');
            });
            document.addEventListener('click', () => menu.classList.remove('open'));
        }
    }

    // Modal Logic
    function openProfileModal(id = null) {
        document.getElementById('modalTitle').textContent = id ? 'Edit Profile' : 'Create Profile';
        if (!id) {
            document.getElementById('profileForm').reset();
            toggleAuthFields();
        }
        document.getElementById('profileModal').classList.add('active');
        feather.replace();
    }

    function closeProfileModal() {
        document.getElementById('profileModal').classList.remove('active');
    }

    function saveProfile() {
        closeProfileModal();
        alert('Profile saved successfully!');
    }

    function showDeleteConfirm(name) {
        document.getElementById('delProfileName').textContent = name;
        document.getElementById('deleteModal').classList.add('active');
        feather.replace();
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.remove('active');
    }

    function confirmDelete() {
        closeDeleteModal();
        alert('Profile deleted.');
    }

    function toggleAuthFields() {
        const type = document.getElementById('authTypeSelect').value;
        document.querySelectorAll('.auth-section').forEach(el => el.style.display = 'none');

        if (type === 'api_key') document.getElementById('apiKeyFields').style.display = 'block';
        if (type === 'bearer') document.getElementById('bearerFields').style.display = 'block';
        if (type === 'basic') document.getElementById('basicFields').style.display = 'block';
        if (type === 'oauth') document.getElementById('oauthFields').style.display = 'block';
    }
</script>
{% endblock %}